#!/usr/bin/env python3
"""
============================================================================
–ï–ñ–ï–ù–ï–î–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –¢–ò–ü–û–í –¢–†–ê–ù–ó–ê–ö–¶–ò–ô –î–õ–Ø CRON
============================================================================

–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ö–∞–∂–¥—É—é —Å—Ä–µ–¥—É –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–∏–ø—ã –æ–ø–µ—Ä–∞—Ü–∏–π –∏ —É—Å–ª—É–≥ –∏–∑ Ozon Transaction API.
–°–≤–µ—Ä—è–µ—Ç —Å —Ä–µ–µ—Å—Ç—Ä–æ–º –≤ –ë–î, —É–≤–µ–¥–æ–º–ª—è–µ—Ç –∞–¥–º–∏–Ω–æ–≤ –≤ Telegram –æ –Ω–æ–≤—ã—Ö/–∏—Å—á–µ–∑–Ω—É–≤—à–∏—Ö —Ç–∏–ø–∞—Ö.

–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö: POST /v3/finance/transaction/list (–≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π
–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π –º–µ—Å—è—Ü).

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è gunicorn/Flask
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –∑–∞—Ö–æ–¥–∞ –Ω–∞ –≤–∫–ª–∞–¥–∫—É ¬´–†–µ–∞–ª–∏–∑–∞—Ü–∏—è¬ª
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    python3 check_types_weekly.py

Cron (–∫–∞–∂–¥—É—é —Å—Ä–µ–¥—É –≤ 10:00 MSK):
    0 10 * * 3 /root/OZON/venv/bin/python3 /root/OZON/check_types_weekly.py >> /var/log/ozon-tracker/check-types.log 2>&1

@version 1.0.0
@lastUpdated 2026-02-15
"""

import sys
import os
import fcntl
from datetime import datetime

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

# –§–∞–π–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤
LOCK_FILE = "/tmp/ozon_check_types.lock"


def log(message: str):
    """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π."""
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    print(f"[{timestamp}] {message}")


def main():
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–∞–π–ª–æ–≤—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤.
    –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç check_transaction_types_weekly() –∏–∑ ozon_app –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –µ—ë.
    """
    log("üîç –ó–∞–ø—É—Å–∫ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π...")

    # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
    lock_file = open(LOCK_FILE, 'w')
    try:
        fcntl.flock(lock_file, fcntl.LOCK_EX | fcntl.LOCK_NB)
    except IOError:
        log("‚ö†Ô∏è  –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ). –ü—Ä–æ–ø—É—Å–∫–∞–µ–º.")
        sys.exit(0)

    try:
        # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        from ozon_app import check_transaction_types_weekly

        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
        result = check_transaction_types_weekly()

        if result.get('success'):
            new_count = len(result.get('new_types', []))
            missing_count = len(result.get('missing_types', []))
            log(f"‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ü–µ—Ä–∏–æ–¥: {result['period']}")
            log(f"   –û–ø–µ—Ä–∞—Ü–∏–π: {result['operations_count']} | –£—Å–ª—É–≥: {result['services_count']}")
            if new_count or missing_count:
                log(f"   üÜï –ù–æ–≤—ã—Ö: {new_count} | ‚ùå –ò—Å—á–µ–∑–Ω—É–≤—à–∏—Ö: {missing_count}")
            else:
                log("   –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç")
            sys.exit(0)
        else:
            log(f"‚ùå –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π: {result.get('error', 'unknown')}")
            sys.exit(1)

    except Exception as e:
        log(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)

    finally:
        # –°–Ω–∏–º–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
        fcntl.flock(lock_file, fcntl.LOCK_UN)
        lock_file.close()


if __name__ == "__main__":
    main()
