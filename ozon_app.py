#!/usr/bin/env python3
"""
üåê OZON –¢–û–í–ê–†–´ - –í–µ–± –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤ FBO
–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è: —á–∏—Å—Ç—ã–π –∑–∞–ø—Ä–æ—Å, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π SQL, debug –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
"""

import sqlite3
import requests
import json
import os
import sys
import re
import time
from datetime import datetime, timedelta, timezone
from functools import wraps
from flask import Flask, render_template_string, jsonify, request, send_file, Response
from bs4 import BeautifulSoup
from werkzeug.security import generate_password_hash, check_password_hash
from werkzeug.utils import secure_filename
import jwt
import uuid

# ‚úÖ TIMEZONE FIX - –ë–µ–ª–≥—Ä–∞–¥ (Serbia/Balkans)
try:
    from zoneinfo import ZoneInfo
    TZ = ZoneInfo("Europe/Belgrade")
except Exception:
    TZ = None

def get_snapshot_date():
    """–ü–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—É —Å–Ω–∏–º–∫–∞ –ø–æ –ª–æ–∫–∞–ª—å–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ –ë–µ–ª–≥—Ä–∞–¥–∞"""
    if TZ:
        return datetime.now(TZ).date().isoformat()
    return datetime.now().date().isoformat()

def get_snapshot_time():
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Ä–µ–º—è —Å–Ω–∏–º–∫–∞ –ø–æ –ª–æ–∫–∞–ª—å–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ –ë–µ–ª–≥—Ä–∞–¥–∞"""
    if TZ:
        return datetime.now(TZ).isoformat()
    return datetime.now().isoformat()

# ============================================================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
# ============================================================================

# ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
def load_env_variables():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç .env —Ñ–∞–π–ª —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–∞–∑–Ω—ã—Ö –∫–æ–¥–∏—Ä–æ–≤–æ–∫ –∏ BOM"""
    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º dotenv
    try:
        from dotenv import load_dotenv
        if load_dotenv():
            return
    except ImportError:
        pass
    
    # –ï—Å–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ, —á–∏—Ç–∞–µ–º –≤—Ä—É—á–Ω—É—é
    env_path = ".env"
    if os.path.exists(env_path):
        try:
            # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏
            for encoding in ["utf-8-sig", "utf-8", "cp1252", "latin-1"]:
                try:
                    with open(env_path, "r", encoding=encoding) as f:
                        content = f.read()
                    
                    # –ü–∞—Ä—Å–∏–º –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
                    for line in content.split('\n'):
                        # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ BOM —Å–∏–º–≤–æ–ª—ã
                        line = line.strip().lstrip('\ufeff')
                        
                        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                        if not line or line.startswith("#"):
                            continue
                        
                        # –ò—â–µ–º –∑–Ω–∞–∫ =
                        if "=" not in line:
                            continue
                        
                        # –ü–∞—Ä—Å–∏–º –∫–ª—é—á –∏ –∑–Ω–∞—á–µ–Ω–∏–µ
                        parts = line.split("=", 1)
                        if len(parts) != 2:
                            continue
                        
                        key = parts[0].strip()
                        value = parts[1].strip()
                        
                        # –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏
                        for quote in ['"', "'"]:
                            if value.startswith(quote) and value.endswith(quote):
                                value = value[1:-1]
                                break
                        
                        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ os.environ
                        if key and value:
                            os.environ[key] = value
                    
                    break
                except (UnicodeDecodeError, UnicodeError) as e:
                    continue
                except Exception as e:
                    print(f"‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ .env ({encoding}): {e}")
        except Exception as e:
            print(f"‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ .env: {e}")

load_env_variables()

OZON_CLIENT_ID = os.environ.get("OZON_CLIENT_ID")
OZON_API_KEY = os.environ.get("OZON_API_KEY")

# ‚úÖ –ö–ª—é—á–∏ –¥–ª—è Ozon Performance API (—Ä–µ–∫–ª–∞–º–∞)
OZON_PERFORMANCE_CLIENT_ID = os.environ.get("OZON_PERFORMANCE_CLIENT_ID")
OZON_PERFORMANCE_API_KEY = os.environ.get("OZON_PERFORMANCE_API_KEY")

# ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–ª—é—á–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
if not OZON_CLIENT_ID or not OZON_API_KEY:
    import os.path
    print("\n‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è!")
    print(f"   üìÇ –¢–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞: {os.getcwd()}")
    print(f"   üìã .env —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {os.path.exists('.env')}")
    print(f"   üìã OZON_CLIENT_ID: {OZON_CLIENT_ID}")
    print(f"   üìã OZON_API_KEY: {OZON_API_KEY}")
    print("\nüîß –°–ø–æ—Å–æ–± 1 - PowerShell (–≤ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ):")
    print("   $env:OZON_CLIENT_ID='—Ç–≤–æ–π_client_id'; $env:OZON_API_KEY='—Ç–≤–æ–π_api_key'; python ozon_app.py")
    print("\nüîß –°–ø–æ—Å–æ–± 2 - –°–æ–∑–¥–∞—Ç—å .env —Ñ–∞–π–ª –≤ –ø–∞–ø–∫–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):")
    print("   –°–æ–¥–µ—Ä–∂–∏–º–æ–µ .env:")
    print("   OZON_CLIENT_ID=—Ç–≤–æ–π_client_id")
    print("   OZON_API_KEY=—Ç–≤–æ–π_api_key")
    print("\nüì¢ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è Performance API (—Ä–µ–∫–ª–∞–º–∞):")
    print("   OZON_PERFORMANCE_CLIENT_ID=—Ç–≤–æ–π_performance_client_id")
    print("   OZON_PERFORMANCE_API_KEY=—Ç–≤–æ–π_performance_api_key")
    sys.exit(1)

OZON_HOST = "https://api-seller.ozon.ru"
DB_PATH = "ozon_data.db"

# –í–µ—Ä—Å–∏—è –∫—ç—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏/—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π. –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª–æ–≥–∏–∫–∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏,
# —á—Ç–æ–±—ã —Å—Ç–∞—Ä—ã–π –∫—ç—à —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —á–∏—Å–ª–∞–º–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–ª—Å—è –ø—Ä–∏ –¥–µ–ø–ª–æ–µ.
REALIZATION_CACHE_VERSION = 7  # v7: –¥–æ–±–∞–≤–ª–µ–Ω–æ buyout.commission + buyout.seller_price_total –≤ –∫—ç—à

# ‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –í–≠–î
UPLOAD_FOLDER = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'uploads', 'ved_containers')
ALLOWED_EXTENSIONS = {'pdf', 'png', 'jpg', 'jpeg', 'gif', 'doc', 'docx', 'xls', 'xlsx', 'txt', 'zip', 'rar'}
MAX_FILE_SIZE = 16 * 1024 * 1024  # 16 MB

# –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∑–∞–≥—Ä—É–∑–æ–∫ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
os.makedirs(UPLOAD_FOLDER, exist_ok=True)

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π
FINANCE_UPLOAD_FOLDER = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'uploads', 'finance')
os.makedirs(FINANCE_UPLOAD_FOLDER, exist_ok=True)

# ‚úÖ –í—ã–±–æ—Ä –ø–æ–ª—è –¥–ª—è —Å—á–∏—Ç—ã–≤–∞–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤
# –í–∞—Ä–∏–∞–Ω—Ç—ã: "free_to_sell_amount" | "available" | "present"
STOCK_FIELD = os.environ.get("OZON_STOCK_FIELD", "free_to_sell_amount")
print(f"\nüìä –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–ª–µ –æ—Å—Ç–∞—Ç–∫–∞: {STOCK_FIELD}\n")

# ============================================================================
# –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –ò –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
# ============================================================================

# JWT –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
# –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ–∫—Ä–µ—Ç - –ù–ï –º–µ–Ω—è—Ç—å, –∏–Ω–∞—á–µ –≤—Å–µ —Å–µ—Å—Å–∏–∏ —Å—Ç–∞–Ω—É—Ç –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º–∏
JWT_SECRET = os.environ.get("JWT_SECRET", "ozon-tracker-permanent-secret-2024-do-not-change")
AUTH_ENABLED = os.environ.get("AUTH_ENABLED", "true").lower() == "true"
# –¢–æ–∫–µ–Ω—ã –±–µ—Å—Å—Ä–æ—á–Ω—ã–µ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –≤—Ä—É—á–Ω—É—é

print(f"üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: {'–í–ö–õ–Æ–ß–ï–ù–ê' if AUTH_ENABLED else '–û–¢–ö–õ–Æ–ß–ï–ù–ê'}")


def require_auth(allowed_roles=None):
    """
    –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
        @require_auth()  # –õ—é–±–æ–π –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        @require_auth(['admin'])  # –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        401 - –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        403 - –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –Ω—É–∂–Ω–æ–π —Ä–æ–ª–∏
    """
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            # –ï—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
            if not AUTH_ENABLED:
                return f(*args, **kwargs)

            # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ Authorization –∏–ª–∏ query –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
            auth_header = request.headers.get('Authorization', '')
            token = auth_header.replace('Bearer ', '') if auth_header.startswith('Bearer ') else ''

            # –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º query –ø–∞—Ä–∞–º–µ—Ç—Ä token (–¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤)
            if not token:
                token = request.args.get('token', '')

            if not token:
                return jsonify({'success': False, 'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'}), 401

            try:
                # –î–µ–∫–æ–¥–∏—Ä—É–µ–º JWT —Ç–æ–∫–µ–Ω
                payload = jwt.decode(token, JWT_SECRET, algorithms=['HS256'])
                user_role = payload.get('role', 'viewer')
                user_id = payload.get('user_id')
                username = payload.get('username')

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã allowed_roles
                if allowed_roles and user_role not in allowed_roles:
                    return jsonify({'success': False, 'error': '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤'}), 403

                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ request –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–µ
                request.current_user = {
                    'user_id': user_id,
                    'username': username,
                    'role': user_role
                }

            except jwt.InvalidTokenError:
                return jsonify({'success': False, 'error': '–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω'}), 401

            return f(*args, **kwargs)
        return decorated_function
    return decorator


def create_jwt_token(user_id, username, role):
    """
    –°–æ–∑–¥–∞—ë—Ç JWT —Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    –¢–æ–∫–µ–Ω –ë–ï–°–°–†–û–ß–ù–´–ô - –Ω–µ –∏—Å—Ç–µ–∫–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–í—ã–π—Ç–∏".

    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
        username: –õ–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        role: –†–æ–ª—å (admin/viewer)

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        str: JWT —Ç–æ–∫–µ–Ω
    """
    payload = {
        'user_id': user_id,
        'username': username,
        'role': role,
        'iat': datetime.utcnow()
        # –ù–ï–¢ 'exp' - —Ç–æ–∫–µ–Ω –±–µ—Å—Å—Ä–æ—á–Ω—ã–π
    }
    return jwt.encode(payload, JWT_SECRET, algorithm='HS256')


def get_user_display_name(user_id):
    """
    –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID.

    –ï—Å–ª–∏ display_name –∑–∞–¥–∞–Ω - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ.
    –ò–Ω–∞—á–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç username.

    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        str: –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –∏–ª–∏ username
    """
    if not user_id:
        return ''
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute('SELECT username, display_name FROM users WHERE id = ?', (user_id,))
        row = cursor.fetchone()
        conn.close()
        if row:
            username, display_name = row
            return display_name if display_name else username
        return ''
    except Exception:
        return ''


# ============================================================================
# –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –î–ê–ù–ù–´–•
# ============================================================================

def ensure_column(cursor, table, column, ddl):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Å—Ç–æ–ª–±—Ü–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç"""
    cols = {r[1] for r in cursor.execute(f"PRAGMA table_info({table})")}
    if column not in cols:
        cursor.execute(ddl)
        return True
    return False


def init_database():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # WAL-—Ä–µ–∂–∏–º: —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å (–Ω—É–∂–µ–Ω –¥–ª—è gunicorn —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ workers)
    # –í —Ä–µ–∂–∏–º–µ DELETE –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π reader –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è writer-–æ–º ‚Üí –∫—ç—à –Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è
    cursor.execute('PRAGMA journal_mode=WAL')
    cursor.execute('PRAGMA busy_timeout=5000')
    
    # ‚úÖ –¢–µ–∫—É—â–∏–µ –æ—Å—Ç–∞—Ç–∫–∏ (—Å–∞–º—ã–π —Å–≤–µ–∂–∏–π —Å–Ω–∏–º–æ–∫)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS products (
            sku INTEGER PRIMARY KEY,
            name TEXT,
            fbo_stock INTEGER DEFAULT 0,
            orders_qty INTEGER DEFAULT 0,
            updated_at TIMESTAMP
        )
    ''')
    
    # ‚úÖ –¢–ê–ë–õ–ò–¶–ê –ò–°–¢–û–†–ò–ò - –¥–ª—è –≤—Å–µ—Ö —Å–Ω–∏–º–∫–æ–≤ –ø–æ –¥–∞—Ç–∞–º
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS products_history (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            sku INTEGER NOT NULL,
            name TEXT,
            fbo_stock INTEGER DEFAULT 0,
            orders_qty INTEGER DEFAULT 0,
            avg_position REAL DEFAULT 0,
            impressions INTEGER DEFAULT 0,
            snapshot_date DATE NOT NULL,
            snapshot_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            notes TEXT DEFAULT '',
            UNIQUE(sku, snapshot_date)
        )
    ''')
    
    # –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ SKU –∏ –¥–∞—Ç–µ
    cursor.execute('''
        CREATE INDEX IF NOT EXISTS idx_history_sku_date 
        ON products_history(sku, snapshot_date)
    ''')
    
    # ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–æ–ª–±–µ—Ü impressions –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç (–º–∏–≥—Ä–∞—Ü–∏—è)
    if ensure_column(cursor, "products_history", "impressions",
                     "ALTER TABLE products_history ADD COLUMN impressions INTEGER DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü impressions –¥–æ–±–∞–≤–ª–µ–Ω –≤ products_history")
    
    # ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–æ–ª–±–µ—Ü ctr –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç (–º–∏–≥—Ä–∞—Ü–∏—è)
    if ensure_column(cursor, "products_history", "ctr",
                     "ALTER TABLE products_history ADD COLUMN ctr REAL DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü ctr –¥–æ–±–∞–≤–ª–µ–Ω –≤ products_history")
    
    # ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–æ–ª–±—Ü—ã –¥–ª—è –ø–æ–∫–∞–∑–æ–≤ –∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
    if ensure_column(cursor, "products_history", "hits_view_search",
                     "ALTER TABLE products_history ADD COLUMN hits_view_search INTEGER DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü hits_view_search –¥–æ–±–∞–≤–ª–µ–Ω –≤ products_history")
    
    if ensure_column(cursor, "products_history", "hits_view_search_pdp",
                     "ALTER TABLE products_history ADD COLUMN hits_view_search_pdp INTEGER DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü hits_view_search_pdp –¥–æ–±–∞–≤–ª–µ–Ω –≤ products_history")
    
    if ensure_column(cursor, "products_history", "search_ctr",
                     "ALTER TABLE products_history ADD COLUMN search_ctr REAL DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü search_ctr –¥–æ–±–∞–≤–ª–µ–Ω –≤ products_history")
    
    # ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏ –≤ products —Ç–∞–±–ª–∏—Ü—É
    if ensure_column(cursor, "products", "hits_view_search",
                     "ALTER TABLE products ADD COLUMN hits_view_search INTEGER DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü hits_view_search –¥–æ–±–∞–≤–ª–µ–Ω –≤ products")
    
    if ensure_column(cursor, "products", "hits_view_search_pdp",
                     "ALTER TABLE products ADD COLUMN hits_view_search_pdp INTEGER DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü hits_view_search_pdp –¥–æ–±–∞–≤–ª–µ–Ω –≤ products")
    
    if ensure_column(cursor, "products", "search_ctr",
                     "ALTER TABLE products ADD COLUMN search_ctr REAL DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü search_ctr –¥–æ–±–∞–≤–ª–µ–Ω –≤ products")
    
    # ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è "–í –∫–æ—Ä–∑–∏–Ω—É" –∏ CR1
    if ensure_column(cursor, "products_history", "hits_add_to_cart",
                     "ALTER TABLE products_history ADD COLUMN hits_add_to_cart INTEGER DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü hits_add_to_cart –¥–æ–±–∞–≤–ª–µ–Ω –≤ products_history")
    
    if ensure_column(cursor, "products_history", "cr1",
                     "ALTER TABLE products_history ADD COLUMN cr1 REAL DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü cr1 –¥–æ–±–∞–≤–ª–µ–Ω –≤ products_history")
    
    if ensure_column(cursor, "products", "hits_add_to_cart",
                     "ALTER TABLE products ADD COLUMN hits_add_to_cart INTEGER DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü hits_add_to_cart –¥–æ–±–∞–≤–ª–µ–Ω –≤ products")
    
    if ensure_column(cursor, "products", "cr1",
                     "ALTER TABLE products ADD COLUMN cr1 REAL DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü cr1 –¥–æ–±–∞–≤–ª–µ–Ω –≤ products")
    
    # ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –¥–ª—è CR2
    if ensure_column(cursor, "products_history", "cr2",
                     "ALTER TABLE products_history ADD COLUMN cr2 REAL DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü cr2 –¥–æ–±–∞–≤–ª–µ–Ω –≤ products_history")
    
    if ensure_column(cursor, "products", "cr2",
                     "ALTER TABLE products ADD COLUMN cr2 REAL DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü cr2 –¥–æ–±–∞–≤–ª–µ–Ω –≤ products")
    
    # ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –¥–ª—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ —Ä–µ–∫–ª–∞–º—É
    if ensure_column(cursor, "products_history", "adv_spend",
                     "ALTER TABLE products_history ADD COLUMN adv_spend REAL DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü adv_spend –¥–æ–±–∞–≤–ª–µ–Ω –≤ products_history")
    
    if ensure_column(cursor, "products", "adv_spend",
                     "ALTER TABLE products ADD COLUMN adv_spend REAL DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü adv_spend –¥–æ–±–∞–≤–ª–µ–Ω –≤ products")

    # ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è —Ü–µ–Ω —Ç–æ–≤–∞—Ä–æ–≤
    if ensure_column(cursor, "products_history", "price",
                     "ALTER TABLE products_history ADD COLUMN price REAL DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü price –¥–æ–±–∞–≤–ª–µ–Ω –≤ products_history")

    if ensure_column(cursor, "products", "price",
                     "ALTER TABLE products ADD COLUMN price REAL DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü price –¥–æ–±–∞–≤–ª–µ–Ω –≤ products")

    # ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –¥–ª—è –∞—Ä—Ç–∏–∫—É–ª–∞ —Ç–æ–≤–∞—Ä–∞ (offer_id)
    if ensure_column(cursor, "products", "offer_id",
                     "ALTER TABLE products ADD COLUMN offer_id TEXT DEFAULT NULL"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü offer_id –¥–æ–±–∞–≤–ª–µ–Ω –≤ products")

    if ensure_column(cursor, "products_history", "offer_id",
                     "ALTER TABLE products_history ADD COLUMN offer_id TEXT DEFAULT NULL"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü offer_id –¥–æ–±–∞–≤–ª–µ–Ω –≤ products_history")

    # ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –¥–ª—è –ø–ª–∞–Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ (orders_plan)
    if ensure_column(cursor, "products_history", "orders_plan",
                     "ALTER TABLE products_history ADD COLUMN orders_plan INTEGER DEFAULT NULL"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü orders_plan –¥–æ–±–∞–≤–ª–µ–Ω –≤ products_history")

    # ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –¥–ª—è –ø–ª–∞–Ω–æ–≤–æ–≥–æ CPO (cpo_plan)
    if ensure_column(cursor, "products_history", "cpo_plan",
                     "ALTER TABLE products_history ADD COLUMN cpo_plan INTEGER DEFAULT NULL"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü cpo_plan –¥–æ–±–∞–≤–ª–µ–Ω –≤ products_history")

    # ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –¥–ª—è –ø–ª–∞–Ω–æ–≤–æ–π —Ü–µ–Ω—ã (price_plan)
    if ensure_column(cursor, "products_history", "price_plan",
                     "ALTER TABLE products_history ADD COLUMN price_plan INTEGER DEFAULT NULL"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü price_plan –¥–æ–±–∞–≤–ª–µ–Ω –≤ products_history")

    # ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–∞ —Ç–æ–≤–∞—Ä–∞
    if ensure_column(cursor, "products_history", "rating",
                     "ALTER TABLE products_history ADD COLUMN rating REAL DEFAULT NULL"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü rating –¥–æ–±–∞–≤–ª–µ–Ω –≤ products_history")

    # ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç–∑—ã–≤–æ–≤
    if ensure_column(cursor, "products_history", "review_count",
                     "ALTER TABLE products_history ADD COLUMN review_count INTEGER DEFAULT NULL"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü review_count –¥–æ–±–∞–≤–ª–µ–Ω –≤ products_history")

    if ensure_column(cursor, "products_history", "marketing_price",
                     "ALTER TABLE products_history ADD COLUMN marketing_price REAL DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü marketing_price –¥–æ–±–∞–≤–ª–µ–Ω –≤ products_history")

    if ensure_column(cursor, "products", "marketing_price",
                     "ALTER TABLE products ADD COLUMN marketing_price REAL DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü marketing_price –¥–æ–±–∞–≤–ª–µ–Ω –≤ products")

    # ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –ø–æ—Å—Ç–∞–≤–æ–∫ FBO
    if ensure_column(cursor, "products_history", "in_transit",
                     "ALTER TABLE products_history ADD COLUMN in_transit INTEGER DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü in_transit –¥–æ–±–∞–≤–ª–µ–Ω –≤ products_history")

    if ensure_column(cursor, "products", "in_transit",
                     "ALTER TABLE products ADD COLUMN in_transit INTEGER DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü in_transit –¥–æ–±–∞–≤–ª–µ–Ω –≤ products")

    if ensure_column(cursor, "products_history", "in_draft",
                     "ALTER TABLE products_history ADD COLUMN in_draft INTEGER DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü in_draft –¥–æ–±–∞–≤–ª–µ–Ω –≤ products_history")

    if ensure_column(cursor, "products", "in_draft",
                     "ALTER TABLE products ADD COLUMN in_draft INTEGER DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü in_draft –¥–æ–±–∞–≤–ª–µ–Ω –≤ products")

    # ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞ —Ü–µ–Ω—ã (price_index)
    if ensure_column(cursor, "products_history", "price_index",
                     "ALTER TABLE products_history ADD COLUMN price_index TEXT DEFAULT NULL"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü price_index –¥–æ–±–∞–≤–ª–µ–Ω –≤ products_history")

    if ensure_column(cursor, "products", "price_index",
                     "ALTER TABLE products ADD COLUMN price_index TEXT DEFAULT NULL"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü price_index –¥–æ–±–∞–≤–ª–µ–Ω –≤ products")

    # ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –¥–ª—è —Ç–µ–≥–æ–≤ —Å—Ç—Ä–æ–∫–∏ (tags)
    # –•—Ä–∞–Ω–∏—Ç JSON –º–∞—Å—Å–∏–≤ —Ç–µ–≥–æ–≤: ["–°–∞–º–æ–≤—ã–∫—É–ø", "–†–µ–∫–ª–∞–º–∞"]
    if ensure_column(cursor, "products_history", "tags",
                     "ALTER TABLE products_history ADD COLUMN tags TEXT DEFAULT NULL"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü tags –¥–æ–±–∞–≤–ª–µ–Ω –≤ products_history")

    # ‚úÖ –¢–∞–±–ª–∏—Ü–∞ fbo_warehouse_stock ‚Äî –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ —Å–∫–ª–∞–¥–∞–º/–∫–ª–∞—Å—Ç–µ—Ä–∞–º
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS fbo_warehouse_stock (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            sku INTEGER NOT NULL,
            warehouse_name TEXT,
            stock INTEGER DEFAULT 0,
            snapshot_date DATE NOT NULL
        )
    ''')

    # ‚úÖ –¢–∞–±–ª–∏—Ü–∞ fbo_analytics ‚Äî –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º (ADS, IDC)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS fbo_analytics (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            sku INTEGER NOT NULL,
            cluster_name TEXT,
            ads REAL DEFAULT 0,
            idc REAL DEFAULT 0,
            days_without_sales INTEGER DEFAULT 0,
            liquidity_status TEXT DEFAULT '',
            stock INTEGER DEFAULT 0,
            snapshot_date DATE NOT NULL
        )
    ''')

    # ============================================================================
    # –¢–ê–ë–õ–ò–¶–ê –ü–û–°–¢–ê–í–û–ö ‚Äî –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–ü–û–°–¢–ê–í–ö–ò"
    # ============================================================================
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS supplies (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            sku INTEGER NOT NULL,
            product_name TEXT,
            exit_plan_date TEXT,
            order_qty_plan INTEGER DEFAULT 0,
            exit_factory_date TEXT,
            exit_factory_qty INTEGER DEFAULT 0,
            arrival_warehouse_date TEXT,
            arrival_warehouse_qty INTEGER DEFAULT 0,
            logistics_cost_per_unit REAL DEFAULT 0,
            price_cny REAL DEFAULT 0,
            cost_plus_6 REAL DEFAULT 0,
            add_to_marketing INTEGER DEFAULT 0,
            add_to_debts INTEGER DEFAULT 0,
            plan_fbo INTEGER DEFAULT 0,
            is_locked INTEGER DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º —Å–≤—è–∑—å —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º –í–≠–î
    for column in ['container_doc_id INTEGER', 'container_item_id INTEGER']:
        try:
            cursor.execute(f'ALTER TABLE supplies ADD COLUMN {column}')
        except sqlite3.OperationalError:
            pass  # –ö–æ–ª–æ–Ω–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

    # ============================================================================
    # –¢–ê–ë–õ–ò–¶–ê –ö–£–†–°–û–í –í–ê–õ–Æ–¢ ‚Äî –∫—ç—à –∫—É—Ä—Å–æ–≤ –¶–ë –†–§
    # ============================================================================
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS currency_rates (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            currency_code TEXT NOT NULL,
            rate REAL NOT NULL,
            fetch_date DATE NOT NULL,
            UNIQUE(currency_code, fetch_date)
        )
    ''')

    # ============================================================================
    # –¢–ê–ë–õ–ò–¶–´ –°–ö–õ–ê–î–ê ‚Äî –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–≥—Ä—É–∑–∫–∏
    # ============================================================================

    # –î–æ–∫—É–º–µ–Ω—Ç—ã –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏—è (—à–∞–ø–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞: –¥–∞—Ç–∞/–≤—Ä–µ–º—è, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –∞–≤—Ç–æ—Ä)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS warehouse_receipt_docs (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            receipt_datetime TEXT NOT NULL,
            comment TEXT DEFAULT '',
            created_by TEXT DEFAULT '',
            updated_by TEXT DEFAULT '',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')

    # –ü–æ–∑–∏—Ü–∏–∏ –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏—è (—Å—Ç—Ä–æ–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞: —Ç–æ–≤–∞—Ä, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —Ü–µ–Ω–∞)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS warehouse_receipts (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            doc_id INTEGER,
            sku INTEGER NOT NULL,
            receipt_date DATE NOT NULL,
            quantity INTEGER DEFAULT 0,
            purchase_price REAL DEFAULT 0,
            comment TEXT DEFAULT '',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (doc_id) REFERENCES warehouse_receipt_docs(id)
        )
    ''')

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É doc_id –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç (–¥–ª—è —Å—Ç–∞—Ä—ã—Ö –ë–î)
    try:
        cursor.execute('ALTER TABLE warehouse_receipts ADD COLUMN doc_id INTEGER')
    except sqlite3.OperationalError:
        pass  # –ö–æ–ª–æ–Ω–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–≤—Ç–æ—Ä–æ–≤ –≤ warehouse_receipt_docs
    for column in ['created_by TEXT DEFAULT ""', 'updated_by TEXT DEFAULT ""', 'updated_at TIMESTAMP']:
        try:
            cursor.execute(f'ALTER TABLE warehouse_receipt_docs ADD COLUMN {column}')
        except sqlite3.OperationalError:
            pass  # –ö–æ–ª–æ–Ω–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É receiver_name –¥–ª—è –∏–º–µ–Ω–∏ –ø—Ä–∏—ë–º—â–∏–∫–∞
    try:
        cursor.execute('ALTER TABLE warehouse_receipt_docs ADD COLUMN receiver_name TEXT DEFAULT ""')
    except sqlite3.OperationalError:
        pass  # –ö–æ–ª–æ–Ω–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

    # ============================================================================
    # –¢–ê–ë–õ–ò–¶–ê –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –ü–†–ò–•–û–î–û–í –ü–û –ü–û–°–¢–ê–í–ö–ê–ú
    # ============================================================================
    # –°–≤—è–∑—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏—è —Å —Å—Ç—Ä–æ–∫–∞–º–∏ –ø–æ—Å—Ç–∞–≤–æ–∫
    # –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è: –∫–∞–∫–æ–µ –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–µ –∑–∞–ø–æ–ª–Ω–∏–ª–æ –∫–∞–∫—É—é —Å—Ç—Ä–æ–∫—É –ø–æ—Å—Ç–∞–≤–∫–∏
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS supply_receipt_distributions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            supply_id INTEGER NOT NULL,
            receipt_item_id INTEGER NOT NULL,
            receipt_doc_id INTEGER,
            quantity INTEGER NOT NULL,
            cost_plus_6 REAL DEFAULT 0,
            receipt_date TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (supply_id) REFERENCES supplies(id),
            FOREIGN KEY (receipt_item_id) REFERENCES warehouse_receipts(id)
        )
    ''')

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É calculated_cost –≤ warehouse_receipts –¥–ª—è —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–æ–π —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏
    try:
        cursor.execute('ALTER TABLE warehouse_receipts ADD COLUMN calculated_cost REAL DEFAULT 0')
    except sqlite3.OperationalError:
        pass  # –ö–æ–ª–æ–Ω–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

    # ============================================================================
    # –¢–ê–ë–õ–ò–¶–´ –î–õ–Ø –í–≠–î (–ö–û–ù–¢–ï–ô–ù–ï–†–´)
    # ============================================================================

    # –î–æ–∫—É–º–µ–Ω—Ç—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –í–≠–î (—à–∞–ø–∫–∞: –¥–∞—Ç–∞, –ø–æ—Å—Ç–∞–≤—â–∏–∫, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –∫—É—Ä—Å, –ø—Ä–æ—Ü–µ–Ω—Ç)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS ved_container_docs (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            container_date TEXT NOT NULL,
            supplier TEXT DEFAULT '',
            comment TEXT DEFAULT '',
            cny_rate REAL DEFAULT 0,
            cny_percent REAL DEFAULT 0,
            created_by TEXT DEFAULT '',
            updated_by TEXT DEFAULT '',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')

    # –ü–æ–∑–∏—Ü–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –í–≠–î (—Ç–æ–≤–∞—Ä—ã —Å —Ü–µ–Ω–∞–º–∏ –∏ –ª–æ–≥–∏—Å—Ç–∏–∫–æ–π)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS ved_container_items (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            doc_id INTEGER NOT NULL,
            sku INTEGER NOT NULL,
            quantity INTEGER DEFAULT 0,
            price_cny REAL DEFAULT 0,
            logistics_rf REAL DEFAULT 0,
            logistics_cn REAL DEFAULT 0,
            terminal REAL DEFAULT 0,
            customs REAL DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (doc_id) REFERENCES ved_container_docs(id)
        )
    ''')

    # –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –í–≠–î
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS ved_suppliers (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT UNIQUE NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')

    # ============================================================================
    # –°–û–û–ë–©–ï–ù–ò–Ø –ö–û–ù–¢–ï–ô–ù–ï–†–û–í –í–≠–î (—á–∞—Ç —Å –≤—ã–±–æ—Ä–æ–º –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π)
    # ============================================================================
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS container_messages (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            container_id INTEGER NOT NULL,
            message TEXT NOT NULL,
            sender_id INTEGER NOT NULL,
            sender_name TEXT DEFAULT '',
            recipient_ids TEXT DEFAULT '',
            sender_type TEXT NOT NULL DEFAULT 'web',
            telegram_message_ids TEXT DEFAULT '',
            is_read INTEGER DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (container_id) REFERENCES ved_container_docs(id),
            FOREIGN KEY (sender_id) REFERENCES users(id)
        )
    ''')

    # –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤, –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö –∫ —Å–æ–æ–±—â–µ–Ω–∏—è–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    # –§–∞–π–ª—ã –ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é (–Ω–µ –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É) –∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è inline –≤ —á–∞—Ç–µ
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS container_message_files (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            message_id INTEGER NOT NULL,
            filename TEXT NOT NULL,
            stored_filename TEXT NOT NULL,
            file_type TEXT DEFAULT '',
            file_size INTEGER DEFAULT 0,
            uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (message_id) REFERENCES container_messages(id) ON DELETE CASCADE
        )
    ''')

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É reminder_sent –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
    # 0 = –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –µ—â—ë –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, 1 = –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ 24—á
    try:
        cursor.execute('ALTER TABLE container_messages ADD COLUMN reminder_sent INTEGER DEFAULT 0')
    except sqlite3.OperationalError:
        pass  # –ö–æ–ª–æ–Ω–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É is_completed –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –í–≠–î
    try:
        cursor.execute('ALTER TABLE ved_container_docs ADD COLUMN is_completed INTEGER DEFAULT 0')
    except sqlite3.OperationalError:
        pass  # –ö–æ–ª–æ–Ω–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É important (–≤–∞–∂–Ω–æ) –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –í–≠–î
    try:
        cursor.execute('ALTER TABLE ved_container_docs ADD COLUMN important TEXT DEFAULT ""')
    except sqlite3.OperationalError:
        pass  # –ö–æ–ª–æ–Ω–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

    # –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –í–≠–î
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS ved_container_files (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            doc_id INTEGER NOT NULL,
            filename TEXT NOT NULL,
            stored_filename TEXT NOT NULL,
            file_type TEXT DEFAULT '',
            file_size INTEGER DEFAULT 0,
            uploaded_by TEXT DEFAULT '',
            uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (doc_id) REFERENCES ved_container_docs(id) ON DELETE CASCADE
        )
    ''')

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º display_name –¥–ª—è —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    # display_name - –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    try:
        cursor.execute('ALTER TABLE ved_container_files ADD COLUMN display_name TEXT DEFAULT ""')
    except sqlite3.OperationalError:
        pass

    # ============================================================================
    # –ú–ò–ì–†–ê–¶–ò–ò –î–õ–Ø TELEGRAM –ò–ù–¢–ï–ì–†–ê–¶–ò–ò
    # ============================================================================

    # source: –æ—Ç–∫—É–¥–∞ —Å–æ–∑–¥–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç ('web' –∏–ª–∏ 'telegram')
    try:
        cursor.execute('ALTER TABLE warehouse_receipt_docs ADD COLUMN source TEXT DEFAULT "web"')
    except sqlite3.OperationalError:
        pass

    # is_processed: —É—Å—Ç–∞—Ä–µ–≤—à–µ–µ –ø–æ–ª–µ, –æ—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å—Ç–∞—Ä—ã—Ö –ë–î
    try:
        cursor.execute('ALTER TABLE warehouse_receipt_docs ADD COLUMN is_processed INTEGER DEFAULT 1')
    except sqlite3.OperationalError:
        pass

    # telegram_chat_id: ID —á–∞—Ç–∞ Telegram –æ—Ç–∫—É–¥–∞ —Å–æ–∑–¥–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç
    try:
        cursor.execute('ALTER TABLE warehouse_receipt_docs ADD COLUMN telegram_chat_id INTEGER')
    except sqlite3.OperationalError:
        pass

    # ============================================================================
    # –¢–ê–ë–õ–ò–¶–ê TELEGRAM –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
    # ============================================================================
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS telegram_users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            chat_id INTEGER UNIQUE NOT NULL,
            username TEXT DEFAULT '',
            first_name TEXT DEFAULT '',
            last_name TEXT DEFAULT '',
            is_authorized INTEGER DEFAULT 0,
            auth_code TEXT,
            auth_code_expires TIMESTAMP,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            last_activity TIMESTAMP
        )
    ''')

    # –°–æ–æ–±—â–µ–Ω–∏—è –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º (—á–∞—Ç –º–µ–∂–¥—É —Å–∞–π—Ç–æ–º –∏ Telegram)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS document_messages (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            doc_type TEXT NOT NULL,
            doc_id INTEGER NOT NULL,
            message TEXT NOT NULL,
            sender_type TEXT NOT NULL,
            sender_name TEXT DEFAULT '',
            telegram_chat_id INTEGER,
            telegram_message_id INTEGER,
            is_read INTEGER DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    # doc_type: 'receipt' (–æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–µ), 'shipment' (–æ—Ç–≥—Ä—É–∑–∫–∞)
    # sender_type: 'web' (—Å —Å–∞–π—Ç–∞), 'telegram' (–∏–∑ Telegram)

    # –î–æ–∫—É–º–µ–Ω—Ç—ã –æ—Ç–≥—Ä—É–∑–æ–∫ (—à–∞–ø–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞: –¥–∞—Ç–∞/–≤—Ä–µ–º—è, –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –∞–≤—Ç–æ—Ä)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS warehouse_shipment_docs (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            shipment_datetime TEXT NOT NULL,
            destination TEXT DEFAULT '',
            comment TEXT DEFAULT '',
            created_by TEXT DEFAULT '',
            updated_by TEXT DEFAULT '',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')

    # –ü–æ–∑–∏—Ü–∏–∏ –æ—Ç–≥—Ä—É–∑–æ–∫ (—Å—Ç—Ä–æ–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞: —Ç–æ–≤–∞—Ä, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS warehouse_shipments (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            doc_id INTEGER,
            sku INTEGER NOT NULL,
            shipment_date DATE NOT NULL,
            quantity INTEGER DEFAULT 0,
            destination TEXT DEFAULT '',
            comment TEXT DEFAULT '',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (doc_id) REFERENCES warehouse_shipment_docs(id)
        )
    ''')

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É doc_id –≤ warehouse_shipments –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    try:
        cursor.execute('ALTER TABLE warehouse_shipments ADD COLUMN doc_id INTEGER')
    except sqlite3.OperationalError:
        pass  # –ö–æ–ª–æ–Ω–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É is_completed –≤ warehouse_shipment_docs
    # is_completed = 1: –æ—Ç–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ (–≤—ã—á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ –æ—Å—Ç–∞—Ç–∫–æ–≤)
    # is_completed = 0: –æ—Ç–≥—Ä—É–∑–∫–∞ –Ω–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ (—Ç–æ–≤–∞—Ä –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω)
    if ensure_column(cursor, "warehouse_shipment_docs", "is_completed",
                     "ALTER TABLE warehouse_shipment_docs ADD COLUMN is_completed INTEGER DEFAULT 1"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü is_completed –¥–æ–±–∞–≤–ª–µ–Ω –≤ warehouse_shipment_docs")

    # –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π –æ—Ç–≥—Ä—É–∑–æ–∫ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS shipment_destinations (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT UNIQUE NOT NULL,
            is_default INTEGER DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')

    # –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞—è
    cursor.execute('SELECT COUNT(*) FROM shipment_destinations')
    if cursor.fetchone()[0] == 0:
        default_destinations = [
            ('FBO (Ozon)', 1),
            ('FBS (—Å–≤–æ–π —Å–∫–ª–∞–¥)', 1),
            ('–í–æ–∑–≤—Ä–∞—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫—É', 1),
            ('–î—Ä—É–≥–æ–µ', 1)
        ]
        cursor.executemany('INSERT INTO shipment_destinations (name, is_default) VALUES (?, ?)', default_destinations)

    # ============================================================================
    # –¢–ê–ë–õ–ò–¶–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ‚Äî –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ —Ä–æ–ª–µ–π
    # ============================================================================
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            password_hash TEXT NOT NULL,
            role TEXT NOT NULL DEFAULT 'viewer',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ telegram_chat_id –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫ Telegram –∞–∫–∫–∞—É–Ω—Ç—É
    try:
        cursor.execute('ALTER TABLE users ADD COLUMN telegram_chat_id INTEGER')
    except sqlite3.OperationalError:
        pass  # –ü–æ–ª–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ display_name –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    # –≠—Ç–æ –∏–º—è –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è –≤ —Å—Ç–æ–ª–±—Ü–∞—Ö "–ò–∑–º–µ–Ω–µ–Ω–æ", "–°–æ–∑–¥–∞–Ω–æ" –≤–º–µ—Å—Ç–æ –ª–æ–≥–∏–Ω–∞
    try:
        cursor.execute("ALTER TABLE users ADD COLUMN display_name TEXT DEFAULT ''")
    except sqlite3.OperationalError:
        pass  # –ü–æ–ª–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ telegram_username –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è @username Telegram
    try:
        cursor.execute("ALTER TABLE users ADD COLUMN telegram_username TEXT DEFAULT ''")
    except sqlite3.OperationalError:
        pass  # –ü–æ–ª–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –∑–∞–ø–æ–ª–Ω—è–µ–º telegram_username –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    cursor.execute('''
        UPDATE users
        SET telegram_username = (
            SELECT sender_name FROM document_messages
            WHERE sender_type = 'telegram' AND telegram_chat_id = users.telegram_chat_id
            LIMIT 1
        )
        WHERE telegram_chat_id IS NOT NULL
        AND (telegram_username IS NULL OR telegram_username = '')
    ''')

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º display_name = username
    # –µ—Å–ª–∏ display_name –ø—É—Å—Ç–æ–π (—á—Ç–æ–±—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è –ª–æ–≥–∏–Ω)
    cursor.execute("UPDATE users SET display_name = username WHERE display_name IS NULL OR display_name = ''")

    # ‚úÖ –°–æ–∑–¥–∞—ë–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞—è
    cursor.execute('SELECT COUNT(*) FROM users')
    if cursor.fetchone()[0] == 0:
        # –°–æ–∑–¥–∞—ë–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (admin/admin123 - –°–ú–ï–ù–ò–¢–¨ –ü–û–°–õ–ï –£–°–¢–ê–ù–û–í–ö–ò!)
        admin_hash = generate_password_hash('admin123')
        cursor.execute('''
            INSERT INTO users (username, password_hash, role, display_name)
            VALUES (?, ?, ?, ?)
        ''', ('admin', admin_hash, 'admin', 'admin'))

        # –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (viewer/viewer123)
        viewer_hash = generate_password_hash('viewer123')
        cursor.execute('''
            INSERT INTO users (username, password_hash, role, display_name)
            VALUES (?, ?, ?, ?)
        ''', ('viewer', viewer_hash, 'viewer', 'viewer'))

        print("‚úÖ –°–æ–∑–¥–∞–Ω—ã –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: admin/admin123, viewer/viewer123")
        print("‚ö†Ô∏è  –í–ê–ñ–ù–û: –°–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞!")

    # ============================================================================
    # –§–ò–ù–ê–ù–°–´: —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å—á–µ—Ç–æ–≤/–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
    # ============================================================================
    # –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Å—á–µ—Ç–æ–≤/–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å—Ä–µ–¥—Å—Ç–≤
    # (–û–û–û, –ù–∞–ª–∏—á–Ω—ã–µ, –ö–∞—Ä—Ç–∞ Tinkoff –∏ —Ç.–¥.)
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ —á–µ—Ä–µ–∑ dropdown –≤ UI –∏–ª–∏ –æ–Ω–∏ –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω—ã.
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS finance_accounts (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT UNIQUE NOT NULL,
            is_default INTEGER DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')

    # –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö —Å—á–µ—Ç–æ–≤ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
    cursor.execute('SELECT COUNT(*) FROM finance_accounts')
    if cursor.fetchone()[0] == 0:
        default_accounts = [
            ('–û–û–û', 1),
            ('–ù–∞–ª–∏—á–Ω—ã–µ', 1),
            ('–ö–∞—Ä—Ç–∞ Tinkoff', 1),
            ('–ö–∞—Ä—Ç–∞ –°–±–µ—Ä–±–∞–Ω–∫', 1),
        ]
        cursor.executemany(
            'INSERT INTO finance_accounts (name, is_default) VALUES (?, ?)',
            default_accounts
        )
        print("‚úÖ –°–æ–∑–¥–∞–Ω—ã –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å—á–µ—Ç–∞: –û–û–û, –ù–∞–ª–∏—á–Ω—ã–µ, –ö–∞—Ä—Ç–∞ Tinkoff, –ö–∞—Ä—Ç–∞ –°–±–µ—Ä–±–∞–Ω–∫")

    # ============================================================================
    # –§–ò–ù–ê–ù–°–´: –∑–∞–ø–∏—Å–∏ –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤
    # ============================================================================
    # –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.
    # record_type: 'income' (–¥–æ—Ö–æ–¥) –∏–ª–∏ 'expense' (—Ä–∞—Å—Ö–æ–¥)
    # account_name —Ö—Ä–∞–Ω–∏—Ç—Å—è –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ, —á—Ç–æ–±—ã –ø—Ä–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏ —Å—á—ë—Ç–∞
    # –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –∑–∞–ø–∏—Å–∏ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ.
    # source: 'web' (–∏–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞) –∏–ª–∏ 'telegram' (–∏–∑ Telegram-–±–æ—Ç–∞)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS finance_records (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            record_type TEXT NOT NULL CHECK(record_type IN ('income', 'expense')),
            amount REAL NOT NULL,
            account_id INTEGER NOT NULL,
            account_name TEXT NOT NULL,
            description TEXT DEFAULT '',
            created_by TEXT DEFAULT '',
            source TEXT NOT NULL DEFAULT 'web' CHECK(source IN ('web', 'telegram')),
            telegram_chat_id INTEGER,
            telegram_username TEXT DEFAULT '',
            record_date DATE NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (account_id) REFERENCES finance_accounts(id)
        )
    ''')

    # –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_finance_records_date ON finance_records(record_date)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_finance_records_type ON finance_records(record_type)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_finance_records_account ON finance_records(account_id)')

    # ============================================================================
    # –§–ò–ù–ê–ù–°–´: —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    # ============================================================================
    # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤/–¥–æ—Ö–æ–¥–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–õ–æ–≥–∏—Å—Ç–∏–∫–∞", "–ó–∞–∫—É–ø–∫–∞ —Ç–æ–≤–∞—Ä–∞", "–ü—Ä–æ–¥–∞–∂–∏").
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—ë—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–∞–º —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS finance_categories (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            record_type TEXT NOT NULL DEFAULT 'expense',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            UNIQUE(name, record_type)
        )
    ''')

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É record_type –≤ finance_categories
    if ensure_column(cursor, 'finance_categories', 'record_type',
                     "ALTER TABLE finance_categories ADD COLUMN record_type TEXT NOT NULL DEFAULT 'expense'"):
        print("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ record_type –≤ finance_categories")
        # –°–æ–∑–¥–∞—ë–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞ –ø–∞—Ä—É (name, record_type)
        cursor.execute('CREATE UNIQUE INDEX IF NOT EXISTS idx_finance_categories_name_type ON finance_categories(LOWER(name), record_type)')

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏ category_id –∏ category_name –≤ finance_records
    if ensure_column(cursor, 'finance_records', 'category_id',
                     "ALTER TABLE finance_records ADD COLUMN category_id INTEGER DEFAULT NULL"):
        print("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ category_id –≤ finance_records")

    if ensure_column(cursor, 'finance_records', 'category_name',
                     "ALTER TABLE finance_records ADD COLUMN category_name TEXT DEFAULT ''"):
        print("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ category_name –≤ finance_records")

    cursor.execute('CREATE INDEX IF NOT EXISTS idx_finance_records_category ON finance_records(category_id)')

    # ============================================================================
    # –¢–ê–ë–õ–ò–¶–ê: finance_container_distributions
    # ============================================================================
    # –°–≤—è–∑—å –º–µ–∂–¥—É —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ —Ä–∞—Å—Ö–æ–¥–∞–º–∏ –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ –í–≠–î.
    # –ö–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å = —á–∞—Å—Ç—å —Å—É–º–º—ã —Ä–∞—Å—Ö–æ–¥–∞, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä
    # –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –ø–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–º—É —Ç–∏–ø—É –∑–∞—Ç—Ä–∞—Ç.
    # –ü—Ä–∏–≤—è–∑–∫–∞ –ø–æ sku (–Ω–µ –ø–æ container_item_id), –ø–æ—Ç–æ–º—É —á—Ç–æ –ø—Ä–∏ –ø–µ—Ä–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
    # –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏ —É–¥–∞–ª—è—é—Ç—Å—è –∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∑–∞–Ω–æ–≤–æ ‚Äî ID –º–µ–Ω—è—é—Ç—Å—è, SKU —Å—Ç–∞–±–∏–ª—å–Ω—ã.
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS finance_container_distributions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            finance_record_id INTEGER NOT NULL,
            container_doc_id INTEGER NOT NULL,
            sku TEXT NOT NULL,
            cost_type TEXT NOT NULL CHECK(cost_type IN ('logistics_rf', 'logistics_cn', 'terminal', 'customs')),
            amount REAL NOT NULL DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (finance_record_id) REFERENCES finance_records(id) ON DELETE CASCADE,
            FOREIGN KEY (container_doc_id) REFERENCES ved_container_docs(id)
        )
    ''')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_fcd_finance_record ON finance_container_distributions(finance_record_id)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_fcd_container_doc ON finance_container_distributions(container_doc_id)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_fcd_sku ON finance_container_distributions(sku)')

    # -----------------------------------------------------------------------
    # –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π –ø–æ —Å—Ç—Ä–æ–∫–∞–º –ø–ª–∞–Ω–∞ –∑–∞–∫—É–ø–æ–∫.
    # –ö–æ–≥–¥–∞ —Ä–∞—Å—Ö–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–ø–ª–∞—Ç–∞ –∏–Ω–≤–æ–π—Å–∞) —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º
    # —Å—Ç—Ä–æ–∫–∞–º –ø–ª–∞–Ω–∞, –∑–¥–µ—Å—å —Ö—Ä–∞–Ω–∏—Ç—Å—è —Å–∫–æ–ª—å–∫–æ —é–∞–Ω–µ–π –∏ —Ä—É–±–ª–µ–π —É—à–ª–æ –Ω–∞ –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É.
    # target_type: 'invoice' ‚Üí paid_invoice_yuan/rub, 'delta' ‚Üí paid_delta_yuan/rub.
    # -----------------------------------------------------------------------
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS finance_plan_distributions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            finance_record_id INTEGER NOT NULL,
            plan_item_id INTEGER NOT NULL,
            target_type TEXT NOT NULL CHECK(target_type IN ('invoice', 'delta')),
            yuan_amount REAL NOT NULL DEFAULT 0,
            rub_amount REAL NOT NULL DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (finance_record_id) REFERENCES finance_records(id) ON DELETE CASCADE,
            FOREIGN KEY (plan_item_id) REFERENCES plan_items(id) ON DELETE CASCADE
        )
    ''')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_fpd_finance_record ON finance_plan_distributions(finance_record_id)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_fpd_plan_item ON finance_plan_distributions(plan_item_id)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_fpd_target_type ON finance_plan_distributions(target_type)')

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É is_container_linked –≤ finance_categories
    # –§–ª–∞–≥ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç
    # –ø—Ä–∏–≤—è–∑–∞—Ç—å —Ä–∞—Å—Ö–æ–¥ –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º –í–≠–î –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ —Ç–æ–≤–∞—Ä–∞–º.
    if ensure_column(cursor, 'finance_categories', 'is_container_linked',
                     "ALTER TABLE finance_categories ADD COLUMN is_container_linked INTEGER DEFAULT 0"):
        print("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ is_container_linked –≤ finance_categories")

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É requires_yuan –≤ finance_categories
    # –§–ª–∞–≥ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω—É–∂–Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑–∞—Ç—å —Å—É–º–º—É –≤ —é–∞–Ω—è—Ö.
    # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ç–∏–ø–∞ ¬´–ò–Ω–≤–æ–π—Å¬ª, ¬´–ò–Ω–≤–æ–π—Å –î–µ–ª—å—Ç–∞ –ë–∞–Ω–∫¬ª –∏ —Ç.–ø.
    if ensure_column(cursor, 'finance_categories', 'requires_yuan',
                     "ALTER TABLE finance_categories ADD COLUMN requires_yuan INTEGER DEFAULT 0"):
        print("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ requires_yuan –≤ finance_categories")

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É yuan_amount –≤ finance_records
    # –°—É–º–º–∞ –≤ —é–∞–Ω—è—Ö ‚Äî –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å —Ñ–ª–∞–≥–æ–º requires_yuan.
    if ensure_column(cursor, 'finance_records', 'yuan_amount',
                     "ALTER TABLE finance_records ADD COLUMN yuan_amount REAL DEFAULT NULL"):
        print("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ yuan_amount –≤ finance_records")

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É requires_description –≤ finance_categories
    # –§–ª–∞–≥ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω—É–∂–Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ.
    # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ç–∏–ø–∞ ¬´–ò–Ω–≤–æ–π—Å¬ª, ¬´–ò–Ω–≤–æ–π—Å-–î–µ–ª—å—Ç–∞¬ª –∏ —Ç.–ø.
    if ensure_column(cursor, 'finance_categories', 'requires_description',
                     "ALTER TABLE finance_categories ADD COLUMN requires_description INTEGER DEFAULT 0"):
        print("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ requires_description –≤ finance_categories")

    # –ú–∏–≥—Ä–∞—Ü–∏—è: —Ç–µ–∫—Å—Ç-–ø–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è (–ø—Ä–∏–º–µ—Ä –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).
    # –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –≤–µ–±–µ (placeholder/alert) –∏ –≤ Telegram-–±–æ—Ç–µ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –æ–ø–∏—Å–∞–Ω–∏—è.
    if ensure_column(cursor, 'finance_categories', 'description_hint',
                     "ALTER TABLE finance_categories ADD COLUMN description_hint TEXT DEFAULT ''"):
        print("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ description_hint –≤ finance_categories")

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É is_plan_linked –≤ finance_categories.
    # –§–ª–∞–≥ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —ç—Ç–æ–π —Ä–∞—Å—Ö–æ–¥–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç
    # —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—É–º–º—É –≤ —é–∞–Ω—è—Ö –ø–æ —Å—Ç—Ä–æ–∫–∞–º –≤–∫–ª–∞–¥–∫–∏ ¬´–ü–ª–∞–Ω¬ª (–æ–ø–ª–∞—Ç–∞ –∏–Ω–≤–æ–π—Å–æ–≤/–¥–µ–ª—å—Ç).
    if ensure_column(cursor, 'finance_categories', 'is_plan_linked',
                     "ALTER TABLE finance_categories ADD COLUMN is_plan_linked INTEGER DEFAULT 0"):
        print("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ is_plan_linked –≤ finance_categories")

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É requires_official –≤ finance_accounts.
    # –§–ª–∞–≥ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–∞—Å—Ö–æ–¥–∞ —Å —ç—Ç–æ–≥–æ —Å—á—ë—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω
    # —É–∫–∞–∑–∞—Ç—å ‚Äî –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —ç—Ç–æ —Ä–∞—Å—Ö–æ–¥ –∏–ª–∏ –Ω–µ—Ç (–î–∞/–ù–µ—Ç).
    # –ï—Å–ª–∏ ¬´–ù–µ—Ç¬ª ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É –≤ Telegram.
    if ensure_column(cursor, 'finance_accounts', 'requires_official',
                     "ALTER TABLE finance_accounts ADD COLUMN requires_official INTEGER DEFAULT 0"):
        print("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ requires_official –≤ finance_accounts")

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É is_official –≤ finance_records.
    # –ü–æ–º–µ—Ç–∫–∞: NULL = –≤–æ–ø—Ä–æ—Å –Ω–µ –∑–∞–¥–∞–≤–∞–ª—Å—è (–∫–∞—Ç–µ–≥–æ—Ä–∏—è –±–µ–∑ —Ñ–ª–∞–≥–∞), 0 = –Ω–µ—Ç, 1 = –¥–∞.
    if ensure_column(cursor, 'finance_records', 'is_official',
                     "ALTER TABLE finance_records ADD COLUMN is_official INTEGER DEFAULT NULL"):
        print("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ is_official –≤ finance_records")

    # –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤, –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö –∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º –∑–∞–ø–∏—Å—è–º.
    # –§–∞–π–ª—ã –ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ/–¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏.
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS finance_record_files (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            finance_record_id INTEGER NOT NULL,
            filename TEXT NOT NULL,
            stored_filename TEXT NOT NULL,
            file_type TEXT DEFAULT '',
            file_size INTEGER DEFAULT 0,
            uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (finance_record_id) REFERENCES finance_records(id) ON DELETE CASCADE
        )
    ''')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_finance_record_files_record ON finance_record_files(finance_record_id)')

    # ============================================================================
    # –¢–ê–ë–õ–ò–¶–ê: –ü–õ–ê–ù –ó–ê–ö–£–ü–û–ö (plan_items)
    # ============================================================================
    # –•—Ä–∞–Ω–∏—Ç –ø–ª–∞–Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –∑–∞–∫—É–ø–∫–∞–º —Ç–æ–≤–∞—Ä–æ–≤: –¥–∞—Ç—ã, –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞, —Ü–µ–Ω—ã –≤ —é–∞–Ω—è—Ö,
    # —Å—É–º–º—ã –æ–ø–ª–∞—Ç –ø–æ –∏–Ω–≤–æ–π—Å–∞–º –∏ –¥–µ–ª—å—Ç–∞-–∏–Ω–≤–æ–π—Å–∞–º.
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS plan_items (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            product_name TEXT NOT NULL,
            planned_release_date TEXT,
            estimated_arrival_date TEXT,
            planned_qty INTEGER DEFAULT 0,
            price_yuan_invoice REAL DEFAULT 0,
            price_yuan_delta_invoice REAL DEFAULT 0,
            total_yuan REAL DEFAULT 0,
            qty_in_transit INTEGER DEFAULT 0,
            qty_arrived INTEGER DEFAULT 0,
            paid_invoice_yuan REAL DEFAULT 0,
            paid_invoice_rub REAL DEFAULT 0,
            paid_delta_yuan REAL DEFAULT 0,
            paid_delta_rub REAL DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')

    # ‚îÄ‚îÄ –†–µ–µ—Å—Ç—Ä —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π Ozon (–¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –Ω–æ–≤—ã—Ö/–∏—Å—á–µ–∑–Ω—É–≤—à–∏—Ö —Ç–∏–ø–æ–≤) ‚îÄ‚îÄ
    # –•—Ä–∞–Ω–∏—Ç –≤—Å–µ operation_type –∏ service_name, –≤—Å—Ç—Ä–µ—á–µ–Ω–Ω—ã–µ –≤ /v3/finance/transaction/list.
    # –ü—Ä–∏ –∫–∞–∂–¥–æ–π –∑–∞–≥—Ä—É–∑–∫–µ —Å–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–µ —Ç–∏–ø—ã —Å —Ä–µ–µ—Å—Ç—Ä–æ–º –∏ –æ–ø–æ–≤–µ—â–∞–µ–º –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö.
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS transaction_type_registry (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            type_key TEXT NOT NULL,
            type_category TEXT NOT NULL,
            display_name TEXT DEFAULT '',
            first_seen_date TEXT NOT NULL,
            last_seen_date TEXT NOT NULL,
            UNIQUE(type_key, type_category)
        )
    ''')

    # –ö–µ—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ Transaction API (—á—Ç–æ–±—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å 5 —Å—Ç—Ä–∞–Ω–∏—Ü –∫–∞–∂–¥—ã–π —Ä–∞–∑)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS transaction_breakdown_cache (
            period_key TEXT PRIMARY KEY,
            response_json TEXT NOT NULL,
            cached_at TEXT NOT NULL
        )
    ''')

    # –ö–µ—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ Realization API (–∞–∫—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–∞ –º–µ—Å—è—Ü/–∫–≤–∞—Ä—Ç–∞–ª)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS realization_cache (
            period_key TEXT PRIMARY KEY,
            response_json TEXT NOT NULL,
            cached_at TEXT NOT NULL
        )
    ''')

    # –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—ç—à–∞: –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª–æ–≥–∏–∫–∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ —Å—Ç–∞—Ä—ã–π –∫—ç—à –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS cache_meta (
            key TEXT PRIMARY KEY,
            value TEXT NOT NULL
        )
    ''')
    row = cursor.execute("SELECT value FROM cache_meta WHERE key = 'realization_cache_version'").fetchone()
    stored_version = int(row[0]) if row else 0
    if stored_version < REALIZATION_CACHE_VERSION:
        cursor.execute('DELETE FROM realization_cache')
        cursor.execute('DELETE FROM transaction_breakdown_cache')
        cursor.execute(
            "INSERT OR REPLACE INTO cache_meta (key, value) VALUES ('realization_cache_version', ?)",
            (str(REALIZATION_CACHE_VERSION),)
        )
        print(f"üóëÔ∏è –ö—ç—à —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–±—Ä–æ—à–µ–Ω: v{stored_version} ‚Üí v{REALIZATION_CACHE_VERSION}")

    # ============================================================================
    # –¢–ê–ë–õ–ò–¶–ê: –ù–ê–°–¢–†–û–ô–ö–ò –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (app_settings)
    # ============================================================================
    # –ü—Ä–æ—Å—Ç–æ–µ key-value —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–ù–î–° —Å—Ç–∞–≤–∫–∏ –∏ —Ç.–¥.)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS app_settings (
            key TEXT PRIMARY KEY,
            value TEXT NOT NULL
        )
    ''')

    # ============================================================================
    # –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –û–ß–ò–°–¢–ö–ê: —É–¥–∞–ª–µ–Ω–∏–µ —Å–∏—Ä–æ—Ç—Å–∫–∏—Ö –æ—Ç–≥—Ä—É–∑–æ–∫
    # ============================================================================
    # –°–∏—Ä–æ—Ç—Å–∫–∏–µ –æ—Ç–≥—Ä—É–∑–∫–∏ ‚Äî –∑–∞–ø–∏—Å–∏ –≤ warehouse_shipments –±–µ–∑ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    # (doc_id IS NULL). –û–Ω–∏ –º–æ–≥–ª–∏ –ø–æ—è–≤–∏—Ç—å—Å—è –¥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã.
    # –£–¥–∞–ª—è–µ–º –∏—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    try:
        cursor.execute('SELECT COUNT(*) FROM warehouse_shipments WHERE doc_id IS NULL')
        orphan_count = cursor.fetchone()[0]
        if orphan_count > 0:
            cursor.execute('DELETE FROM warehouse_shipments WHERE doc_id IS NULL')
            print(f"üßπ –£–¥–∞–ª–µ–Ω–æ {orphan_count} —Å–∏—Ä–æ—Ç—Å–∫–∏—Ö –æ—Ç–≥—Ä—É–∑–æ–∫ (–±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞)")
    except sqlite3.OperationalError:
        pass  # –¢–∞–±–ª–∏—Ü–∞ –µ—â—ë –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º sender_id –≤ document_messages –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä—Å—Ç–≤–∞
    if ensure_column(cursor, "document_messages", "sender_id",
                     "ALTER TABLE document_messages ADD COLUMN sender_id INTEGER DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü sender_id –¥–æ–±–∞–≤–ª–µ–Ω –≤ document_messages")

    # –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º reminder_sent –≤ document_messages –¥–ª—è 24—á –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
    if ensure_column(cursor, "document_messages", "reminder_sent",
                     "ALTER TABLE document_messages ADD COLUMN reminder_sent INTEGER DEFAULT 0"):
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü reminder_sent –¥–æ–±–∞–≤–ª–µ–Ω –≤ document_messages")

    conn.commit()
    conn.close()


# ============================================================================
# –ö–£–†–°–´ –í–ê–õ–Æ–¢ –¶–ë –†–§
# ============================================================================

# –ö—ç—à –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ä–∞–∑ –≤ –¥–µ–Ω—å)
_currency_cache = {
    'rates': {},
    'date': None
}

def fetch_cbr_rates():
    """
    –ü–æ–ª—É—á–∏—Ç—å –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç —Å —Å–∞–π—Ç–∞ –¶–ë –†–§ (XML API).

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å –∫—É—Ä—Å–∞–º–∏: {'CNY': 12.34, 'USD': 89.56, 'EUR': 97.12}
    –ö—ç—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å.
    """
    today = get_snapshot_date()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à –≤ –ø–∞–º—è—Ç–∏
    if _currency_cache['date'] == today and _currency_cache['rates']:
        return _currency_cache['rates']

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute('''
            SELECT currency_code, rate FROM currency_rates
            WHERE fetch_date = ?
        ''', (today,))
        rows = cursor.fetchall()
        conn.close()

        if rows:
            rates = {row[0]: row[1] for row in rows}
            if 'CNY' in rates and 'USD' in rates and 'EUR' in rates:
                _currency_cache['rates'] = rates
                _currency_cache['date'] = today
                return rates
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫—ç—à–∞ –∫—É—Ä—Å–æ–≤: {e}")

    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å –¶–ë –†–§
    try:
        url = "https://www.cbr.ru/scripts/XML_daily.asp"
        response = requests.get(url, timeout=10)
        response.encoding = 'windows-1251'

        soup = BeautifulSoup(response.text, 'html.parser')

        # –ö–æ–¥—ã –≤–∞–ª—é—Ç –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–º –Ω—É–∂–Ω—ã
        target_codes = {'CNY': None, 'USD': None, 'EUR': None}

        for valute in soup.find_all('valute'):
            char_code = valute.find('charcode').text
            if char_code in target_codes:
                # –¶–ë –†–§ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫—É—Ä—Å —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏ —Å –Ω–æ–º–∏–Ω–∞–ª–æ–º
                nominal = int(valute.find('nominal').text)
                value_str = valute.find('value').text.replace(',', '.')
                rate = float(value_str) / nominal
                target_codes[char_code] = round(rate, 4)

        rates = {k: v for k, v in target_codes.items() if v is not None}

        if rates:
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É
            try:
                conn = sqlite3.connect(DB_PATH)
                cursor = conn.cursor()
                for code, rate in rates.items():
                    cursor.execute('''
                        INSERT OR REPLACE INTO currency_rates (currency_code, rate, fetch_date)
                        VALUES (?, ?, ?)
                    ''', (code, rate, today))
                conn.commit()
                conn.close()
            except Exception as e:
                print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤: {e}")

            _currency_cache['rates'] = rates
            _currency_cache['date'] = today
            print(f"‚úÖ –ö—É—Ä—Å—ã –¶–ë –†–§ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: CNY={rates.get('CNY')}, USD={rates.get('USD')}, EUR={rates.get('EUR')}")
            return rates

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–æ–≤ –¶–ë –†–§: {e}")

    # –§–æ–ª–ª–±—ç–∫ ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∫—É—Ä—Å—ã –∏–∑ –±–∞–∑—ã
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute('''
            SELECT currency_code, rate FROM currency_rates
            WHERE fetch_date = (SELECT MAX(fetch_date) FROM currency_rates)
        ''')
        rows = cursor.fetchall()
        conn.close()
        if rows:
            rates = {row[0]: row[1] for row in rows}
            _currency_cache['rates'] = rates
            _currency_cache['date'] = today
            return rates
    except Exception:
        pass

    return {'CNY': 0, 'USD': 0, 'EUR': 0}


def get_ozon_headers():
    """–ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Ozon Seller API"""
    return {
        "Client-Id": OZON_CLIENT_ID,
        "Api-Key": OZON_API_KEY,
        "Content-Type": "application/json"
    }


# –ö—ç—à –¥–ª—è Performance API —Ç–æ–∫–µ–Ω–∞
_performance_token_cache = {
    "access_token": None,
    "expires_at": 0
}

def get_performance_access_token():
    """–ü–æ–ª—É—á–∏—Ç—å access_token –¥–ª—è Ozon Performance API (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)"""
    import time

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à (–æ—Å—Ç–∞–≤–ª—è–µ–º 60 —Å–µ–∫ –∑–∞–ø–∞—Å–∞ –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è)
    if _performance_token_cache["access_token"] and time.time() < (_performance_token_cache["expires_at"] - 60):
        return _performance_token_cache["access_token"]

    # –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
    try:
        token_url = "https://api-performance.ozon.ru/api/client/token"
        payload = {
            "client_id": OZON_PERFORMANCE_CLIENT_ID,
            "client_secret": OZON_PERFORMANCE_API_KEY,
            "grant_type": "client_credentials"
        }

        response = requests.post(token_url, json=payload, timeout=15)

        if response.status_code != 200:
            print(f"  ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ (status={response.status_code}): {response.text[:200]}")
            return None

        data = response.json()
        access_token = data.get("access_token")
        expires_in = data.get("expires_in", 1800)  # default 30 –º–∏–Ω—É—Ç

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
        _performance_token_cache["access_token"] = access_token
        _performance_token_cache["expires_at"] = time.time() + expires_in

        print(f"  ‚úÖ –ü–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π access_token (–¥–µ–π—Å—Ç–≤—É–µ—Ç {expires_in} —Å–µ–∫)")
        return access_token

    except Exception as e:
        print(f"  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ access_token: {e}")
        return None

def get_ozon_performance_headers():
    """–ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Ozon Performance API (—Ä–µ–∫–ª–∞–º–∞)"""
    access_token = get_performance_access_token()
    if not access_token:
        return None

    return {
        "Authorization": f"Bearer {access_token}",
        "Content-Type": "application/json"
    }


def get_async_report(uuid, headers, max_attempts=30, sleep_seconds=2):
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ Performance API –ø–æ UUID.

    –ü—Ä–æ—Ü–µ—Å—Å:
    1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á—ë—Ç–∞ (polling)
    2. –ñ–¥—ë–º –ø–æ–∫–∞ state != OK
    3. –°–∫–∞—á–∏–≤–∞–µ–º –≥–æ—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç

    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        uuid: UUID –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞
        headers: HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
        max_attempts: –º–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
        sleep_seconds: —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: CSV —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç—á—ë—Ç–∞ –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
    """
    import time

    # –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á—ë—Ç–∞ (polling)
    for attempt in range(max_attempts):
        status_r = requests.get(
            f"https://api-performance.ozon.ru/api/client/statistics/{uuid}",
            headers=headers,
            timeout=15
        )

        if status_r.status_code != 200:
            print(f"     ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ UUID (status={status_r.status_code})")
            return None

        status_data = status_r.json()
        state = status_data.get("state")

        if state == "OK":
            # –û—Ç—á—ë—Ç –≥–æ—Ç–æ–≤!
            break
        elif state == "ERROR":
            error_msg = status_data.get("error", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞")
            print(f"     ‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á—ë—Ç–∞: {error_msg}")
            return None
        elif state in ["NOT_STARTED", "IN_PROGRESS"]:
            # –ñ–¥—ë–º –∏ –ø–æ–≤—Ç–æ—Ä—è–µ–º
            if attempt < max_attempts - 1:  # –ù–µ —Å–ø–∏–º –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–ø—ã—Ç–∫–µ
                time.sleep(sleep_seconds)
        else:
            print(f"     ‚ö†Ô∏è  –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å: {state}")
            return None

    if state != "OK":
        print(f"     ‚è±Ô∏è  –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (state={state})")
        return None

    # –®–∞–≥ 2: –°–∫–∞—á–∏–≤–∞–µ–º –≥–æ—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç
    report_r = requests.get(
        f"https://api-performance.ozon.ru/api/client/statistics/report?UUID={uuid}",
        headers=headers,
        timeout=30
    )

    if report_r.status_code != 200:
        print(f"     ‚ö†Ô∏è  –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –æ—Ç—á—ë—Ç–∞ (status={report_r.status_code})")
        return None

    return report_r.text


def load_search_promo_products_async(date_from, date_to, headers):
    """
    –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ —Å —Ä–∞—Å—Ö–æ–¥–∞–º–∏ –¥–ª—è –∫–∞–º–ø–∞–Ω–∏–π SEARCH_PROMO —á–µ—Ä–µ–∑ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π API.

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–≥–¥–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–≤–∞—Ä—ã
    (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π –∏–ª–∏ –∫–∞–º–ø–∞–Ω–∏–π —Ç–∏–ø–∞ "–≤—Å–µ —Ç–æ–≤–∞—Ä—ã").

    API: POST /api/client/statistic/orders/generate (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π)

    ‚ö†Ô∏è –í–ê–ñ–ù–û: –î–ª—è SEARCH_PROMO –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç—á—ë—Ç –ø–æ –ó–ê–ö–ê–ó–ê–ú, –∞ –Ω–µ –ø–æ —Ç–æ–≤–∞—Ä–∞–º!
    –†–∞—Å—Ö–æ–¥—ã –≤ "–û–ø–ª–∞—Ç–∞ –∑–∞ –∑–∞–∫–∞–∑" –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –∑–∞–∫–∞–∑–∞–º, –∞ –Ω–µ –∫ —Å–ø–∏—Å–∫—É —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–∞–º–ø–∞–Ω–∏–∏.

    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        date_from: –Ω–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞ (–ì–ì–ì–ì-–ú–ú-–î–î)
        date_to: –∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞ (–ì–ì–ì–ì-–ú–ú-–î–î)
        headers: HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {date: {sku: spend}} - —Å–ª–æ–≤–∞—Ä—å —Å —Ä–∞—Å—Ö–æ–¥–∞–º–∏ –ø–æ –¥–∞—Ç–∞–º –∏ SKU
    """
    import csv
    import io
    from datetime import datetime

    print(f"     üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—á—ë—Ç –ø–æ –∑–∞–∫–∞–∑–∞–º (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π API)...")

    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã –≤ RFC 3339 —Ñ–æ—Ä–º–∞—Ç –¥–ª—è API
    try:
        dt_from = datetime.strptime(date_from, '%Y-%m-%d')
        dt_to = datetime.strptime(date_to, '%Y-%m-%d')
        rfc_from = dt_from.strftime('%Y-%m-%dT00:00:00Z')
        rfc_to = dt_to.strftime('%Y-%m-%dT23:59:59Z')
    except Exception as e:
        print(f"     ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –¥–∞—Ç: {e}")
        return {}

    # –®–∞–≥ 1: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á—ë—Ç–∞ –ø–æ –ó–ê–ö–ê–ó–ê–ú
    # ‚ö†Ô∏è –í–ê–ñ–ù–û: –í –ø—É—Ç–∏ /statistic/ –±–µ–∑ "s" (–æ–ø–µ—á–∞—Ç–∫–∞ –≤ API!)
    r = requests.post(
        "https://api-performance.ozon.ru/api/client/statistic/orders/generate",
        headers=headers,
        json={
            "from": rfc_from,
            "to": rfc_to
        },
        timeout=15
    )

    if r.status_code != 200:
        print(f"     ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç—á—ë—Ç–∞ (status={r.status_code})")
        return {}

    response_data = r.json()
    uuid = response_data.get("UUID")

    if not uuid:
        print(f"     ‚ö†Ô∏è  UUID –Ω–µ –ø–æ–ª—É—á–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ")
        return {}

    print(f"     üìã UUID: {uuid}, –æ–∂–∏–¥–∞–Ω–∏–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á—ë—Ç–∞...")

    # –®–∞–≥ 2-3: –ü–æ–ª—É—á–∞–µ–º –≥–æ—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç (polling + download)
    csv_content = get_async_report(uuid, headers)

    if not csv_content:
        return {}

    print(f"     ‚úÖ –û—Ç—á—ë—Ç –ø–æ–ª—É—á–µ–Ω ({len(csv_content)} –±–∞–π—Ç)")

    # –®–∞–≥ 4: –ü–∞—Ä—Å–∏–º CSV –æ—Ç—á—ë—Ç–∞ –ø–æ –∑–∞–∫–∞–∑–∞–º
    # –§–æ—Ä–º–∞—Ç CSV:
    #   –°—Ç—Ä–æ–∫–∞ 0: –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—á—ë—Ç–∞ (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º)
    #   –°—Ç—Ä–æ–∫–∞ 1: –î–∞—Ç–∞;ID –∑–∞–∫–∞–∑–∞;–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞;SKU;...;–†–∞—Å—Ö–æ–¥, ‚ÇΩ
    #   –°—Ç—Ä–æ–∫–∞ 2+: –î–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–æ–≤
    spend_by_date_sku = {}  # {date: {sku: spend}}

    try:
        # ‚ö†Ô∏è –í–ê–ñ–ù–û: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É (–∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—á—ë—Ç–∞)
        csv_lines = csv_content.split('\n')
        if len(csv_lines) < 2:
            print(f"     ‚ÑπÔ∏è  CSV –ø—É—Å—Ç–æ–π –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π")
            return {}

        # –£–¥–∞–ª—è–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É –∏ —Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
        csv_without_header = '\n'.join(csv_lines[1:])

        csv_reader = csv.DictReader(io.StringIO(csv_without_header), delimiter=';')

        for row in csv_reader:
            # –î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ (—Ñ–æ—Ä–º–∞—Ç: –î–î.–ú–ú.–ì–ì–ì–ì)
            date_str = row.get('–î–∞—Ç–∞', '').strip()
            if not date_str:
                continue

            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –∏–∑ –î–î.–ú–ú.–ì–ì–ì–ì –≤ –ì–ì–ì–ì-–ú–ú-–î–î
            try:
                dt = datetime.strptime(date_str, '%d.%m.%Y')
                date = dt.strftime('%Y-%m-%d')
            except (ValueError, TypeError):
                continue

            # SKU —Ç–æ–≤–∞—Ä–∞
            sku_str = row.get('SKU', '').strip()
            if not sku_str:
                continue

            try:
                sku = int(sku_str)
            except (ValueError, TypeError):
                continue

            # –†–∞—Å—Ö–æ–¥ –≤ —Ä—É–±–ª—è—Ö (–∫–æ–ª–æ–Ω–∫–∞ "–†–∞—Å—Ö–æ–¥, ‚ÇΩ")
            spend_str = row.get('–†–∞—Å—Ö–æ–¥, ‚ÇΩ', '0').strip().replace(',', '.')
            try:
                spend = float(spend_str)
            except (ValueError, TypeError):
                spend = 0.0

            if spend <= 0:
                continue

            # –ê–∫–∫—É–º—É–ª–∏—Ä—É–µ–º —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –¥–∞—Ç–∞–º –∏ SKU
            if date not in spend_by_date_sku:
                spend_by_date_sku[date] = {}

            spend_by_date_sku[date][sku] = spend_by_date_sku[date].get(sku, 0) + spend

        if spend_by_date_sku:
            total_skus = sum(len(skus) for skus in spend_by_date_sku.values())
            total_spend = sum(sum(skus.values()) for skus in spend_by_date_sku.values())
            print(f"     ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–æ: {len(spend_by_date_sku)} –¥–∞—Ç, {total_skus} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö SKU")
            print(f"     üí∞ –û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥: {total_spend:.2f}‚ÇΩ")
        else:
            print(f"     ‚ÑπÔ∏è  –ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ —Å —Ä–∞—Å—Ö–æ–¥–∞–º–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥")

    except Exception as e:
        print(f"     ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ CSV: {e}")
        return {}

    return spend_by_date_sku


def load_adv_spend_by_sku(date_from, date_to):
    """
    –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ —Ä–µ–∫–ª–∞–º—É –ø–æ SKU —á–µ—Ä–µ–∑ Performance API.

    –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
    1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –í–°–ï–• –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π (SKU, SEARCH_PROMO, BANNER)
    2. –î–ª—è –∫–∞–∂–¥–æ–π –∫–∞–º–ø–∞–Ω–∏–∏ –ø–æ–ª—É—á–∞–µ–º —Ä–∞—Å—Ö–æ–¥ —á–µ—Ä–µ–∑ GET /api/client/statistics/expense –∑–∞ –ø–µ—Ä–∏–æ–¥
    3. –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ –í–°–ï –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã –≤ CSV (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏!)
    4. –ü–æ–ª—É—á–∞–µ–º —Ç–æ–≤–∞—Ä—ã –≤ –∫–∞–º–ø–∞–Ω–∏–∏ —á–µ—Ä–µ–∑ GET /api/client/campaign/{id}/v2/products
    5. –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞—Å—Ö–æ–¥ –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –º–µ–∂–¥—É —Ç–æ–≤–∞—Ä–∞–º–∏

    –¢–∏–ø—ã –∫–∞–º–ø–∞–Ω–∏–π:
    - SKU: –û–ø–ª–∞—Ç–∞ –∑–∞ –∫–ª–∏–∫ (Performance)
    - SEARCH_PROMO: –û–ø–ª–∞—Ç–∞ –∑–∞ –∑–∞–∫–∞–∑
    - BANNER: –ë–∞–Ω–Ω–µ—Ä–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞

    ‚ö†Ô∏è API –°–¢–ê–¢–£–°:
    - –¢–µ–∫—É—â–∏–π —ç–Ω–¥–ø–æ–∏–Ω—Ç: GET /api/client/statistics/expense (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π, ‚úÖ —Ä–∞–±–æ—Ç–∞–µ—Ç)
    - –°—Ç–∞—Ç—É—Å: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ—Ç 20.01.2026
    - –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: POST /api/client/statistics (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π, –±–æ–ª—å—à–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π)

    üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏: .claude/ozon-api-docs/performance-api-changes-2026-01-20.md

    TODO (–±—É–¥—É—â–∞—è –º–∏–≥—Ä–∞—Ü–∏—è):
    –î–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π API:
    1. POST /api/client/statistics ‚Üí –ø–æ–ª—É—á–∏—Ç—å UUID
    2. GET /api/client/statistics/{UUID} ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å (polling)
    3. GET /api/client/statistics/report?UUID={UUID} ‚Üí —Å–∫–∞—á–∞—Ç—å CSV/ZIP
    –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞: –±–æ–ª—å—à–µ –º–µ—Ç—Ä–∏–∫, –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö, –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∫–∞–º–ø–∞–Ω–∏–π

    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        date_from: –Ω–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞ –∑–∞–ø—Ä–æ—Å–∞
        date_to: –∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞ –∑–∞–ø—Ä–æ—Å–∞

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {date: {sku: adv_spend}} - —Å–ª–æ–≤–∞—Ä—å —Å —Ä–∞—Å—Ö–æ–¥–∞–º–∏ –ø–æ –¥–∞—Ç–∞–º –∏ SKU
    """
    print(f"\nüìä –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ —Ä–µ–∫–ª–∞–º—É ({date_from} - {date_to})...")

    if not OZON_PERFORMANCE_API_KEY or not OZON_PERFORMANCE_CLIENT_ID:
        print("  ‚ö†Ô∏è  Performance API –∫–ª—é—á–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã - –ø—Ä–æ–ø—É—Å–∫–∞—é —Ä–µ–∫–ª–∞–º–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã")
        return {}

    try:
        import csv
        import io

        headers = get_ozon_performance_headers()
        if not headers:
            print("  ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å access_token –¥–ª—è Performance API")
            return {}

        # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –í–°–ï–• –∫–∞–º–ø–∞–Ω–∏–π (SKU, SEARCH_PROMO, BANNER)
        # ‚ö†Ô∏è –í–ê–ñ–ù–û: –ó–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï –∫–∞–º–ø–∞–Ω–∏–∏, –Ω–µ —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ!
        # –ü—Ä–∏—á–∏–Ω–∞: –ï—Å–ª–∏ –∫–∞–º–ø–∞–Ω–∏—è –±—ã–ª–∞ –∞–∫—Ç–∏–≤–Ω–∞ –≤—á–µ—Ä–∞, –Ω–æ —Å–µ–≥–æ–¥–Ω—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞,
        # —É –Ω–µ—ë –≤—Å—ë —Ä–∞–≤–Ω–æ –µ—Å—Ç—å —Ä–∞—Å—Ö–æ–¥—ã –∑–∞ –≤—á–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å.
        print("  üìã –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –∫–∞–º–ø–∞–Ω–∏–π (–≤–∫–ª—é—á–∞—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ)...")

        campaigns_url = "https://api-performance.ozon.ru/api/client/campaign"
        # –ù–ï —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ state - –∑–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï –∫–∞–º–ø–∞–Ω–∏–∏
        params = {}

        r = requests.get(campaigns_url, headers=headers, params=params, timeout=15)

        if r.status_code != 200:
            print(f"  ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–º–ø–∞–Ω–∏–π (status={r.status_code})")
            return {}

        campaigns_data = r.json()
        campaigns = campaigns_data.get("list", [])

        if not campaigns:
            print("  ‚ö†Ô∏è  –ù–µ—Ç —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π –≤ –∞–∫–∫–∞—É–Ω—Ç–µ")
            return {}

        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–∞–º–ø–∞–Ω–∏–∏ –ø–æ —Ç–∏–ø–∞–º –∏ —Å—Ç–∞—Ç—É—Å–∞–º –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        by_type = {}
        by_state = {}
        for camp in campaigns:
            camp_type = camp.get("advObjectType", "Unknown")
            camp_state = camp.get("state", "Unknown")
            by_type[camp_type] = by_type.get(camp_type, 0) + 1
            by_state[camp_state] = by_state.get(camp_state, 0) + 1

        print(f"  ‚úÖ –ù–∞–π–¥–µ–Ω–æ –∫–∞–º–ø–∞–Ω–∏–π: {len(campaigns)}")
        for camp_type, count in by_type.items():
            type_name = {
                "SKU": "–û–ø–ª–∞—Ç–∞ –∑–∞ –∫–ª–∏–∫",
                "SEARCH_PROMO": "–û–ø–ª–∞—Ç–∞ –∑–∞ –∑–∞–∫–∞–∑",
                "BANNER": "–ë–∞–Ω–Ω–µ—Ä–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞"
            }.get(camp_type, camp_type)
            print(f"     ‚Ä¢ {type_name}: {count}")

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã
        if len(by_state) > 1 or "CAMPAIGN_STATE_RUNNING" not in by_state:
            print(f"  üìä –°—Ç–∞—Ç—É—Å—ã –∫–∞–º–ø–∞–Ω–∏–π:")
            for state, count in by_state.items():
                state_name = {
                    "CAMPAIGN_STATE_RUNNING": "–ê–∫—Ç–∏–≤–Ω—ã–µ",
                    "CAMPAIGN_STATE_PAUSED": "–ù–∞ –ø–∞—É–∑–µ",
                    "CAMPAIGN_STATE_STOPPED": "–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã",
                    "CAMPAIGN_STATE_FINISHED": "–ó–∞–≤–µ—Ä—à–µ–Ω—ã"
                }.get(state, state)
                print(f"     ‚Ä¢ {state_name}: {count}")

        # –®–∞–≥ 2: –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞–∂–¥–æ–π –∫–∞–º–ø–∞–Ω–∏–∏
        spend_by_date = {}  # {date: {sku: spend}}

        for campaign in campaigns:
            campaign_id = campaign.get("id")
            campaign_title = campaign.get("title", "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è")
            campaign_type = campaign.get("advObjectType", "Unknown")
            campaign_state = campaign.get("state", "Unknown")

            # –≠–º–æ–¥–∑–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
            state_emoji = {
                "CAMPAIGN_STATE_RUNNING": "üü¢",
                "CAMPAIGN_STATE_PAUSED": "‚è∏Ô∏è",
                "CAMPAIGN_STATE_STOPPED": "üî¥",
                "CAMPAIGN_STATE_FINISHED": "‚úÖ"
            }.get(campaign_state, "‚ö™")

            print(f"\n  üìä {state_emoji} –ö–∞–º–ø–∞–Ω–∏—è: {campaign_title} (ID: {campaign_id}, –¢–∏–ø: {campaign_type})")

            # 2.1. –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å—Ö–æ–¥ –ø–æ –∫–∞–º–ø–∞–Ω–∏–∏
            # ‚úÖ –°–ò–ù–•–†–û–ù–ù–´–ô API: GET /api/client/statistics/expense
            # –í—Å—ë –µ—â—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ—Ç 20.01.2026 (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
            # –î–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π POST /api/client/statistics
            expense_url = "https://api-performance.ozon.ru/api/client/statistics/expense"
            params = {
                "campaignIds": campaign_id,
                "dateFrom": date_from,
                "dateTo": date_to
            }

            r = requests.get(expense_url, headers=headers, params=params, timeout=15)

            if r.status_code != 200:
                print(f"     ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤ (status={r.status_code})")
                continue

            # –ü–∞—Ä—Å–∏–º CSV —Å —Ä–∞—Å—Ö–æ–¥–∞–º–∏
            # üîÑ –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –°–æ–±–∏—Ä–∞–µ–º —Ä–∞—Å—Ö–æ–¥—ã –∑–∞ –í–°–ï –¥–∞—Ç—ã –∏–∑ CSV, –Ω–µ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ date_to
            csv_content = r.text
            csv_reader = csv.DictReader(io.StringIO(csv_content), delimiter=';')

            # –°–ª–æ–≤–∞—Ä—å –¥–ª—è –∞–∫–∫—É–º—É–ª—è—Ü–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∫–∞–º–ø–∞–Ω–∏–∏ –ø–æ –¥–∞—Ç–∞–º
            campaign_spend_by_date = {}  # {date: total_spend}

            for row in csv_reader:
                # –ö–æ–ª–æ–Ω–∫–∞ "–î–∞—Ç–∞" —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î
                row_date = row.get('–î–∞—Ç–∞', '').strip()

                if not row_date:
                    continue

                # –ü–∞—Ä—Å–∏–º —Ä–∞—Å—Ö–æ–¥ –∑–∞ —ç—Ç—É –¥–∞—Ç—É
                spend_str = row.get('–†–∞—Å—Ö–æ–¥', '0').strip().replace(',', '.')
                try:
                    day_spend = float(spend_str)
                    campaign_spend_by_date[row_date] = campaign_spend_by_date.get(row_date, 0.0) + day_spend
                except (ValueError, TypeError):
                    pass

            if not campaign_spend_by_date:
                print(f"     ‚ÑπÔ∏è  –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö –≤ CSV")
                continue

            print(f"     üí∞ –ù–∞–π–¥–µ–Ω–æ –¥–∞—Ç —Å —Ä–∞—Å—Ö–æ–¥–∞–º–∏: {len(campaign_spend_by_date)}")
            for date, spend in sorted(campaign_spend_by_date.items()):
                print(f"        {date}: {spend:.2f}‚ÇΩ")

            # 2.2. –ü–æ–ª—É—á–∞–µ–º —Ç–æ–≤–∞—Ä—ã –≤ –∫–∞–º–ø–∞–Ω–∏–∏
            # ‚ö†Ô∏è –í–ê–ñ–ù–û: –†–∞–∑–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–∞–º–ø–∞–Ω–∏–π!
            # - SKU, BANNER: GET /api/client/campaign/{id}/v2/products
            # - SEARCH_PROMO: POST /api/client/campaign/search_promo/v2/products

            products = []
            search_promo_spend_by_date_sku = {}  # {date: {sku: spend}}

            if campaign_type == "SEARCH_PROMO":
                # –î–ª—è "–û–ø–ª–∞—Ç–∞ –∑–∞ –∑–∞–∫–∞–∑" –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –∏–∑ –æ—Ç—á—ë—Ç–∞ –ø–æ –ó–ê–ö–ê–ó–ê–ú
                # ‚ö†Ô∏è –í–ê–ñ–ù–û: –†–∞—Å—Ö–æ–¥—ã SEARCH_PROMO –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –∑–∞–∫–∞–∑–∞–º, –∞ –Ω–µ –∫ —Å–ø–∏—Å–∫—É —Ç–æ–≤–∞—Ä–æ–≤ –∫–∞–º–ø–∞–Ω–∏–∏
                search_promo_spend_by_date_sku = load_search_promo_products_async(date_from, date_to, headers)

                # –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ç—á—ë—Ç–∞ –ø–æ –∑–∞–∫–∞–∑–∞–º, –∏–∑–≤–ª–µ–∫–∞–µ–º —Å–ø–∏—Å–æ–∫ SKU
                if search_promo_spend_by_date_sku:
                    # –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ SKU –∏–∑ –≤—Å–µ—Ö –¥–∞—Ç
                    all_skus = set()
                    for date_skus in search_promo_spend_by_date_sku.values():
                        all_skus.update(date_skus.keys())

                    # –°–æ–∑–¥–∞—ë–º products —Å–ø–∏—Å–æ–∫ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º –∫–æ–¥–æ–º
                    products = [{"sku": sku} for sku in all_skus]
                    print(f"     ‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(products)} —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –æ—Ç—á—ë—Ç–∞ –ø–æ –∑–∞–∫–∞–∑–∞–º")

            else:
                # –î–ª—è SKU –∏ BANNER –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
                products_url = f"https://api-performance.ozon.ru/api/client/campaign/{campaign_id}/v2/products"

                r = requests.get(products_url, headers=headers, timeout=15)

                if r.status_code != 200:
                    print(f"     ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ (status={r.status_code})")
                    continue

                products_data = r.json()
                products = products_data.get("products", [])

            if not products:
                # –ï—Å–ª–∏ —É –∫–∞–º–ø–∞–Ω–∏–∏ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤, –Ω–æ –µ—Å—Ç—å —Ä–∞—Å—Ö–æ–¥—ã
                if campaign_spend_by_date:
                    print(f"     ‚ö†Ô∏è  –í –∫–∞–º–ø–∞–Ω–∏–∏ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤, –Ω–æ –µ—Å—Ç—å —Ä–∞—Å—Ö–æ–¥—ã")
                    print(f"     üí° –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞—Å—Ö–æ–¥—ã –º–µ–∂–¥—É –≤—Å–µ–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏ –º–∞–≥–∞–∑–∏–Ω–∞")

                    # –ó–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï —Ç–æ–≤–∞—Ä—ã –º–∞–≥–∞–∑–∏–Ω–∞ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
                    # –≠—Ç–æ —Ç–æ–≤–∞—Ä—ã –∏–∑ —Ç–µ–∫—É—â–µ–π –ë–î (—É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã sync_products)
                    # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã - –æ—Ç–ª–æ–∂–∏–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, —Å–æ—Ö—Ä–∞–Ω–∏–º –∫–∞–∫ –æ–±—â–∏–π —Ä–∞—Å—Ö–æ–¥ –∫–∞–º–ø–∞–Ω–∏–∏
                    # TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ–∂–¥—É —Ç–æ–≤–∞—Ä–∞–º–∏ –∏–∑ –ë–î
                    print(f"     ‚ÑπÔ∏è  –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ - —Ä–∞—Å—Ö–æ–¥—ã –±—É–¥—É—Ç —É—á—Ç–µ–Ω—ã –ø–æ–∑–∂–µ")
                else:
                    print(f"     ‚ö†Ô∏è  –í –∫–∞–º–ø–∞–Ω–∏–∏ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –∏ –Ω–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")

                continue

            print(f"     üì¶ –¢–æ–≤–∞—Ä–æ–≤ –≤ –∫–∞–º–ø–∞–Ω–∏–∏: {len(products)}")

            # 2.3. –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞—Å—Ö–æ–¥ –º–µ–∂–¥—É —Ç–æ–≤–∞—Ä–∞–º–∏ –¥–ª—è –ö–ê–ñ–î–û–ô –¥–∞—Ç—ã

            if campaign_type == "SEARCH_PROMO" and search_promo_spend_by_date_sku:
                # –î–ª—è SEARCH_PROMO –∏—Å–ø–æ–ª—å–∑—É–µ–º –¢–û–ß–ù–´–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ç—á—ë—Ç–∞ –ø–æ –∑–∞–∫–∞–∑–∞–º
                # –£ –Ω–∞—Å –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞–∂–¥–æ–º—É SKU, –Ω–µ –Ω—É–∂–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å –ø–æ—Ä–æ–≤–Ω—É
                print(f"     üí° –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ç—á—ë—Ç–∞ –ø–æ –∑–∞–∫–∞–∑–∞–º")

                for date, sku_spends in search_promo_spend_by_date_sku.items():
                    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–æ–≤–∞—Ä—å –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã, –µ—Å–ª–∏ –µ–≥–æ –µ—â—ë –Ω–µ—Ç
                    if date not in spend_by_date:
                        spend_by_date[date] = {}

                    for sku, spend in sku_spends.items():
                        spend_by_date[date][sku] = spend_by_date[date].get(sku, 0) + spend

                print(f"     ‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ—á–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤: {len(search_promo_spend_by_date_sku)} –¥–∞—Ç")

            else:
                # –î–ª—è SKU –∏ BANNER —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Ä–æ–≤–Ω—É –º–µ–∂–¥—É —Ç–æ–≤–∞—Ä–∞–º–∏
                # (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∫–ª–∏–∫–∞–º)
                for date, total_spend in campaign_spend_by_date.items():
                    spend_per_product = total_spend / len(products)

                    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–æ–≤–∞—Ä—å –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã, –µ—Å–ª–∏ –µ–≥–æ –µ—â—ë –Ω–µ—Ç
                    if date not in spend_by_date:
                        spend_by_date[date] = {}

                    for product in products:
                        sku_str = product.get("sku", "")
                        try:
                            sku = int(sku_str)
                            spend_by_date[date][sku] = spend_by_date[date].get(sku, 0) + spend_per_product
                        except (ValueError, TypeError):
                            continue

                print(f"     ‚úÖ –†–∞—Å—Ö–æ–¥ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω –ø–æ {len(campaign_spend_by_date)} –¥–∞—Ç–∞–º")

        if spend_by_date:
            total_dates = len(spend_by_date)
            total_skus = sum(len(skus) for skus in spend_by_date.values())
            print(f"\n  ‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ä–∞—Å—Ö–æ–¥–æ–≤: {total_dates} –¥–∞—Ç, {total_skus} —Ç–æ–≤–∞—Ä–æ–≤ (—É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö SKU)")

            # –ü—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö
            for date in sorted(spend_by_date.keys())[:3]:
                skus = spend_by_date[date]
                examples = list(skus.items())[:2]
                print(f"     {date}: {len(skus)} —Ç–æ–≤–∞—Ä–æ–≤, –ø—Ä–∏–º–µ—Ä—ã: {[(sku, f'{spend:.2f}‚ÇΩ') for sku, spend in examples]}")
        else:
            print(f"\n  ‚ö†Ô∏è  –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö")

        return spend_by_date

    except Exception as e:
        print(f"  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞—Å—Ö–æ–¥–æ–≤ —Ä–µ–∫–ª–∞–º—ã: {e}")
        import traceback
        traceback.print_exc()
        return {}



def load_avg_positions():
    """–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ä–µ–¥–Ω–µ–π –ø–æ–∑–∏—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ /v1/analytics/data"""
    print("\nüìä –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∑–∏—Ü–∏–π —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...")
    
    try:
        snapshot_date = get_snapshot_date()
        d0 = datetime.fromisoformat(snapshot_date).date()
        d1 = d0 + timedelta(days=1)
        
        data = {
            "date_from": d0.isoformat(),
            "date_to": d1.isoformat(),
            "metrics": ["position_category"],  # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞ –¥–ª—è –ø–æ–∑–∏—Ü–∏–π
            "dimension": ["sku"],
            "limit": 1000,
            "offset": 0
        }
        
        print(f"  üìÖ –î–∏–∞–ø–∞–∑–æ–Ω: {d0.isoformat()} ‚Üí {d1.isoformat()}")
        
        r = requests.post(
            f"{OZON_HOST}/v1/analytics/data",
            json=data,
            headers=get_ozon_headers(),
            timeout=15
        )
        
        print(f"  üì• /v1/analytics/data position_category status={r.status_code}")
        
        if r.status_code != 200:
            j = r.json()
            msg = j.get("message") or j.get("error") or str(j)
            print(f"  ‚ö†Ô∏è –û—à–∏–±–∫–∞: {msg}")
            return {}
        
        j = r.json()
        result = j.get("result") or {}
        rows = result.get("data") or []
        
        # DEBUG
        totals = result.get("totals")
        print(f"  üîé totals={totals}, data_len={len(rows)}")
        
        if not rows:
            print(f"  ‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–∑–∏—Ü–∏—è—Ö")
            return {}
        
        if rows:
            print(f"  üîç DEBUG –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: {json.dumps(rows[0], ensure_ascii=False)[:800]}")
        
        avg_positions = {}
        for row in rows:
            dims = row.get("dimensions") or []
            mets = row.get("metrics") or []
            
            if not mets:
                continue
            
            # –ò—â–µ–º SKU (—á–∏—Å–ª–æ)
            sku = None
            for d in (dims or []):
                _id = (d or {}).get("id")
                if _id is None:
                    continue
                try:
                    sku = int(_id)
                    break
                except (TypeError, ValueError):
                    continue
            
            if sku is None:
                continue
            
            try:
                position = float(mets[0] or 0)
                avg_positions[sku] = position
            except (TypeError, ValueError):
                continue
        
        if avg_positions:
            print(f"  ‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ–∑–∏—Ü–∏–π: {len(avg_positions)} sku")
            examples = list(avg_positions.items())[:3]
            print(f"     –ü—Ä–∏–º–µ—Ä—ã: {examples}")
        else:
            print(f"  ‚ö†Ô∏è –ü–æ–∑–∏—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –æ—Ç–≤–µ—Ç–µ")
        
        return avg_positions
        
    except Exception as e:
        print(f"  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–∑–∏—Ü–∏–π: {e}")
        import traceback
        traceback.print_exc()
        return {}


def load_conversion():
    """–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ (CTR) - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –æ–±–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ —Å—á–∏—Ç–∞–µ–º CTR –≤—Ä—É—á–Ω—É—é"""
    print("\nüìä –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ CTR (–ø–æ–∏—Å–∫‚Üí–∫–∞—Ä—Ç–æ—á–∫–∞)...")
    
    try:
        snapshot_date = get_snapshot_date()
        d0 = datetime.fromisoformat(snapshot_date).date()
        d1 = d0 + timedelta(days=1)
        
        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –û–ë–ï –º–µ—Ç—Ä–∏–∫–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
        data = {
            "date_from": d0.isoformat(),
            "date_to": d1.isoformat(),
            "metrics": ["hits_view_search", "hits_view_search_pdp"],  # –ü–æ–∫–∞–∑—ã –∏ –ø–µ—Ä–µ—Ö–æ–¥—ã –≤ –∫–∞—Ä—Ç–æ—á–∫—É
            "dimension": ["sku"],
            "limit": 1000,
            "offset": 0
        }
        
        print(f"  üìÖ –ü–µ—Ä–∏–æ–¥: {d0.isoformat()} ‚Üí {d1.isoformat()}")
        
        r = requests.post(
            f"{OZON_HOST}/v1/analytics/data",
            json=data,
            headers=get_ozon_headers(),
            timeout=15
        )
        
        print(f"  üì• /v1/analytics/data CTR status={r.status_code}")
        
        if r.status_code != 200:
            j = r.json()
            msg = j.get("message") or j.get("error") or str(j)
            print(f"  ‚ö†Ô∏è –û—à–∏–±–∫–∞: {msg}")
            return {}
        
        j = r.json()
        result = j.get("result") or {}
        rows = result.get("data") or []
        
        # DEBUG
        totals = result.get("totals")
        print(f"  üîé totals={totals} (2 –º–µ—Ç—Ä–∏–∫–∏), data_len={len(rows)}")
        if rows:
            print(f"  üîç DEBUG: metrics –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ = {rows[0].get('metrics', [])}")
        
        if not rows:
            print(f"  ‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏")
            return {}
        
        ctr_by_sku = {}
        
        for row in rows:
            dims = row.get("dimensions") or []
            mets = row.get("metrics") or []
            
            # –ù—É–∂–Ω—ã –û–ë–ê –∑–Ω–∞—á–µ–Ω–∏—è: hits_view_search –∏ hits_view_search_pdp
            if len(mets) < 2:
                continue
            
            # –ò—â–µ–º SKU (—á–∏—Å–ª–æ)
            sku = None
            for d in (dims or []):
                _id = (d or {}).get("id")
                if _id is None:
                    continue
                try:
                    sku = int(_id)
                    break
                except (TypeError, ValueError):
                    continue
            
            if sku is None:
                continue
            
            try:
                views = float(mets[0] or 0)        # hits_view_search (–ø–æ–∫–∞–∑—ã –≤ –ø–æ–∏—Å–∫–µ)
                clicks = float(mets[1] or 0)       # hits_view_search_pdp (–ø–µ—Ä–µ—Ö–æ–¥—ã –≤ –∫–∞—Ä—Ç–æ—á–∫—É)
                
                # CTR = (–ü–µ—Ä–µ—Ö–æ–¥—ã / –ü–æ–∫–∞–∑—ã) * 100
                if views > 0:
                    ctr = round((clicks / views) * 100, 2)
                else:
                    ctr = 0.0
                
                ctr_by_sku[sku] = ctr
            except (TypeError, ValueError):
                continue
        
        if ctr_by_sku:
            print(f"  ‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ CTR: {len(ctr_by_sku)} sku")
            examples = list(ctr_by_sku.items())[:3]
            print(f"     –ü—Ä–∏–º–µ—Ä—ã: {examples}")
        else:
            print(f"  ‚ö†Ô∏è CTR –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ")
        
        return ctr_by_sku
        
    except Exception as e:
        print(f"  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ CTR: {e}")
        import traceback
        traceback.print_exc()
        return {}


def load_hits_view_search():
    """–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∫–∞–∑–æ–≤ –≤ –ø–æ–∏—Å–∫–µ –∏ –∫–∞—Ç–∞–ª–æ–≥–µ"""
    print("\nüìä –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∫–∞–∑–æ–≤ (–ø–æ–∏—Å–∫+–∫–∞—Ç–µ–≥–æ—Ä–∏—è)...")
    
    try:
        snapshot_date = get_snapshot_date()
        d0 = datetime.fromisoformat(snapshot_date).date()
        d1 = d0 + timedelta(days=1)
        
        impressions_by_sku = {}
        offset = 0
        total_loaded = 0

        while True:
            payload = {
                "date_from": d0.isoformat(),
                "date_to": d1.isoformat(),
                "metrics": ["hits_view_search"],
                "dimension": ["sku"],
                "limit": 1000,
                "offset": offset
            }

            r = requests.post(
                f"{OZON_HOST}/v1/analytics/data",
                json=payload,
                headers=get_ozon_headers(),
                timeout=25
            )

            print(f"  üì• /v1/analytics/data {d0.isoformat()}‚Üí{d1.isoformat()} offset={offset} status={r.status_code}")

            if r.status_code != 200:
                j = r.json()
                if j.get("message"):
                    print(f"  üìã {j.get('message')}")
                return {}

            j = r.json()
            result = j.get("result") or {}
            rows = result.get("data") or []
            
            if offset == 0:
                totals = result.get("totals")
                print(f"  üîé totals={totals}, data_len={len(rows)}")

            if not rows:
                break

            for row in rows:
                dims = row.get("dimensions") or []
                mets = row.get("metrics") or []
                if not mets:
                    continue

                sku = None
                for d in (dims or []):
                    _id = (d or {}).get("id")
                    if _id is None:
                        continue
                    try:
                        sku = int(_id)
                        break
                    except (TypeError, ValueError):
                        continue

                if sku is None:
                    continue

                try:
                    impressions_by_sku[sku] = impressions_by_sku.get(sku, 0) + int(mets[0] or 0)
                except (TypeError, ValueError):
                    pass

            total_loaded += len(rows)
            offset += 1000

        print(f"  ‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ {total_loaded} —Å—Ç—Ä–æ–∫")
        if impressions_by_sku:
            print(f"  ‚úÖ –ü–æ–∫–∞–∑—ã: {len(impressions_by_sku)} sku")
        return impressions_by_sku
        
    except Exception as e:
        print(f"  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–∫–∞–∑–æ–≤: {e}")
        return {}


def load_hits_view_search_pdp():
    """–ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –≤ –∫–∞—Ä—Ç–æ—á–∫—É (–ø–æ—Å–µ—â–µ–Ω–∏—è PDP)"""
    print("\nüìä –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞ (PDP)...")
    
    try:
        snapshot_date = get_snapshot_date()
        d0 = datetime.fromisoformat(snapshot_date).date()
        d1 = d0 + timedelta(days=1)
        
        pdp_by_sku = {}
        offset = 0

        # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞ –¥–ª—è –ø–æ—Å–µ—â–µ–Ω–∏–π –∫–∞—Ä—Ç–æ—á–∫–∏
        payload = {
            "date_from": d0.isoformat(),
            "date_to": d1.isoformat(),
            "metrics": ["session_view_pdp"],  # ‚úÖ session_view_pdp - –ø–æ—Å–µ—â–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
            "dimension": ["sku"],
            "limit": 1000,
            "offset": offset
        }
        
        print(f"  üìù –ú–µ—Ç—Ä–∏–∫–∞: {payload.get('metrics')}")

        while True:
            payload["offset"] = offset  # –û–±–Ω–æ–≤–ª—è–µ–º offset –≤ payload –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
            r = requests.post(
                f"{OZON_HOST}/v1/analytics/data",
                json=payload,
                headers=get_ozon_headers(),
                timeout=25
            )

            print(f"  üì• /v1/analytics/data session_view_pdp offset={offset} status={r.status_code}")

            if r.status_code != 200:
                j = r.json()
                if j.get("message"):
                    print(f"  ‚ö†Ô∏è {j.get('message')}")
                # –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —á—Ç–æ —É—Å–ø–µ–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å
                if pdp_by_sku:
                    break
                return {}

            j = r.json()
            result = j.get("result") or {}
            rows = result.get("data") or []

            # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
            if not rows:
                print(f"  ‚úì –ö–æ–Ω–µ—Ü –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ offset={offset}")
                break
            
            if len(rows) < 1000:
                print(f"  ‚úì –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ({len(rows)} —Å—Ç—Ä–æ–∫)")


            for row in rows:
                dims = row.get("dimensions") or []
                mets = row.get("metrics") or []
                if not mets:
                    continue

                sku = None
                for d in (dims or []):
                    _id = (d or {}).get("id")
                    try:
                        sku = int(_id)
                        break
                    except (TypeError, ValueError):
                        continue

                if sku is None:
                    continue

                try:
                    pdp_by_sku[sku] = pdp_by_sku.get(sku, 0) + int(mets[0] or 0)
                except (TypeError, ValueError):
                    pass

            offset += 1000

        if pdp_by_sku:
            print(f"  ‚úÖ –ü–µ—Ä–µ—Ö–æ–¥—ã –≤ –∫–∞—Ä—Ç–æ—á–∫—É: {len(pdp_by_sku)} sku")
        else:
            print(f"  ‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–µ—Ä–µ—Ö–æ–¥–∞–º –≤ –∫–∞—Ä—Ç–æ—á–∫—É")
        return pdp_by_sku
        
    except Exception as e:
        print(f"  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ PDP: {e}")
        import traceback
        traceback.print_exc()
        return {}


def load_hits_add_to_cart():
    """–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–π –≤ –∫–æ—Ä–∑–∏–Ω—É (hits_tocart_pdp)"""
    print("\nüìä –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–π –≤ –∫–æ—Ä–∑–∏–Ω—É (hits_tocart_pdp)...")
    
    try:
        snapshot_date = get_snapshot_date()
        d0 = datetime.fromisoformat(snapshot_date).date()
        d1 = d0 + timedelta(days=1)
        
        # üß™ –¢–ï–°–¢–û–í–´–ô –ó–ê–ü–†–û–° - –±–µ–∑ —Ü–∏–∫–ª–æ–≤, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç—Ä–∏–∫—É
        payload = {
            "date_from": d0.isoformat(),
            "date_to": d1.isoformat(),
            "metrics": ["hits_tocart_pdp"],  # ‚úÖ –ù–æ–≤–∞—è –º–µ—Ç—Ä–∏–∫–∞
            "dimension": ["sku"],
            "limit": 1000,
            "offset": 0
        }

        print(f"  üßæ TEST payload: {json.dumps(payload, ensure_ascii=False)}")
        print(f"  üßæ metrics: {payload['metrics']}")

        r = requests.post(
            f"{OZON_HOST}/v1/analytics/data",
            json=payload,
            headers=get_ozon_headers(),
            timeout=25
        )

        print(f"  üì• /v1/analytics/data hits_tocart_pdp status={r.status_code}")

        if r.status_code != 200:
            j = r.json()
            print(f"  ‚ùå API Error: {json.dumps(j, ensure_ascii=False)[:800]}")
            return {}

        j = r.json()
        result = j.get("result") or {}
        rows = result.get("data") or []
        
        print(f"  üìä –ü–æ–ª—É—á–µ–Ω–æ {len(rows)} —Å—Ç—Ä–æ–∫")
        if rows:
            print(f"  üîç –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: {json.dumps(rows[0], ensure_ascii=False)[:300]}")
            mets = rows[0].get("metrics", [])
            print(f"  üîç metrics –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ: {mets}, type: {type(mets)}")
        
        cart_by_sku = {}
        
        for row in rows:
            dims = row.get("dimensions") or []
            mets = row.get("metrics") or []
            if not mets:
                continue

            sku = None
            for d in (dims or []):
                _id = (d or {}).get("id")
                try:
                    sku = int(_id)
                    break
                except (TypeError, ValueError):
                    continue

            if sku is None:
                continue

            try:
                cart_by_sku[sku] = cart_by_sku.get(sku, 0) + int(mets[0] or 0)
            except (TypeError, ValueError):
                pass

        if cart_by_sku:
            print(f"  ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–π –≤ –∫–æ—Ä–∑–∏–Ω—É: {len(cart_by_sku)} sku")
            examples = list(cart_by_sku.items())[:3]
            print(f"     –ü—Ä–∏–º–µ—Ä—ã: {examples}")
        else:
            print(f"  ‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è–º –≤ –∫–æ—Ä–∑–∏–Ω—É")
        return cart_by_sku
        
    except Exception as e:
        print(f"  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ hits_tocart_pdp: {e}")
        import traceback
        traceback.print_exc()
        return {}
    """–ü–æ–∫–∞–∑—ã –∏–∑ /v1/analytics/data - —Ç—Ä–µ–±—É–µ—Ç Premium Plus –ø–æ–¥–ø–∏—Å–∫—É"""
    print("\nüìä –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∫–∞–∑–æ–≤ (–ø–æ–∏—Å–∫+–∫–∞—Ç–µ–≥–æ—Ä–∏—è)...")
    
    try:
        from zoneinfo import ZoneInfo
        MSK = ZoneInfo("Europe/Moscow")
        today_msk = datetime.now(MSK).date()
    except Exception:
        today_msk = datetime.now().date()

    def fetch_range(date_from: str, date_to: str):
        impressions_by_sku = {}
        offset = 0
        total_loaded = 0

        while True:
            payload = {
                "date_from": date_from,
                "date_to": date_to,
                "metrics": ["hits_view_search"],  # ‚úÖ –ü–æ–∫–∞–∑—ã –≤ –ø–æ–∏—Å–∫–µ + –∫–∞—Ç–∞–ª–æ–≥–µ
                "dimension": ["sku"],
                "limit": 1000,
                "offset": offset
            }

            r = requests.post(
                f"{OZON_HOST}/v1/analytics/data",
                json=payload,
                headers=get_ozon_headers(),
                timeout=25
            )

            print(f"  üì• /v1/analytics/data {date_from}‚Üí{date_to} offset={offset} status={r.status_code}")

            if r.status_code != 200:
                j = r.json()
                if j.get("message"):
                    print(f"  üìã {j.get('message')}")
                return {}, False

            j = r.json()
            result = j.get("result") or {}
            rows = result.get("data") or []
            
            # DEBUG –Ω–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            if offset == 0:
                totals = result.get("totals")
                print(f"  üîé totals={totals} (—Å—É–º–º–∞ –ø–æ –≤—Å–µ–º SKU –∑–∞ –ø–µ—Ä–∏–æ–¥)")
                print(f"  üîé data_len={len(rows)} (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ SKU —Å –¥–∞–Ω–Ω—ã–º–∏)")
                if rows:
                    first_metrics = rows[0].get("metrics", [])
                    print(f"  üîç DEBUG: –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –º–µ—Ç—Ä–∏–∫–∞={first_metrics[0] if first_metrics else '–Ω–µ—Ç'}")
                    print(f"  üîç DEBUG: –ø–æ–ª–Ω–∞—è –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: {json.dumps(rows[0], ensure_ascii=False)[:1200]}")

            if not rows:
                break

            for row in rows:
                dims = row.get("dimensions") or []
                mets = row.get("metrics") or []
                if not mets:
                    continue

                # –ò—â–µ–º SKU (—á–∏—Å–ª–æ)
                sku = None
                for d in (dims or []):
                    _id = (d or {}).get("id")
                    if _id is None:
                        continue
                    try:
                        sku = int(_id)
                        break
                    except (TypeError, ValueError):
                        continue

                if sku is None:
                    continue

                try:
                    impressions_by_sku[sku] = impressions_by_sku.get(sku, 0) + int(mets[0] or 0)
                except (TypeError, ValueError):
                    pass

            total_loaded += len(rows)
            offset += 1000

        print(f"  ‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ {total_loaded} —Å—Ç—Ä–æ–∫, {len(impressions_by_sku)} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö SKU")
        if impressions_by_sku:
            sum_impressions = sum(impressions_by_sku.values())
            print(f"  üìä –°–£–ú–ú–ê –ø–æ–∫–∞–∑–æ–≤ –ø–æ –≤—Å–µ–º SKU: {sum_impressions}")
        return impressions_by_sku, True

    # –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞ –°–ï–ì–û–î–ù–Ø (—Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å)
    d0 = today_msk  # –°–µ–≥–æ–¥–Ω—è (–Ω–∞—á–∞–ª–æ –¥–Ω—è)
    d1 = today_msk + timedelta(days=1)  # –ó–∞–≤—Ç—Ä–∞ (–Ω–∞—á–∞–ª–æ)
    print(f"  üìÖ –ü–µ—Ä–∏–æ–¥: {d0.isoformat()} (–≤–∫–ª—é—á–∞—è) ‚Üí {d1.isoformat()} (–Ω–µ –≤–∫–ª—é—á–∞—è)")
    imp, ok = fetch_range(d0.isoformat(), d1.isoformat())
    if ok and imp:
        print(f"  ‚úÖ –ü–æ–∫–∞–∑—ã (—Å–µ–≥–æ–¥–Ω—è): {len(imp)} sku")
        examples = list(imp.items())[:3]
        print(f"     –ü—Ä–∏–º–µ—Ä—ã: {examples}")
        return imp
    
    # Fallback: –µ—Å–ª–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º –≤—á–µ—Ä–∞
    print(f"  ‚ö†Ô∏è –ó–∞ —Å–µ–≥–æ–¥–Ω—è –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–æ–±—É—é –≤—á–µ—Ä–∞...")
    y0 = today_msk - timedelta(days=1)
    y1 = today_msk
    print(f"  üìÖ –ü–µ—Ä–∏–æ–¥: {y0.isoformat()} (–≤–∫–ª—é—á–∞—è) ‚Üí {y1.isoformat()} (–Ω–µ –≤–∫–ª—é—á–∞—è)")
    imp, ok = fetch_range(y0.isoformat(), y1.isoformat())
    if ok and imp:
        print(f"  ‚úÖ –ü–æ–∫–∞–∑—ã (–≤—á–µ—Ä–∞): {len(imp)} sku")
        examples = list(imp.items())[:3]
        print(f"     –ü—Ä–∏–º–µ—Ä—ã: {examples}")
        return imp

    print("  ‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞–∑–æ–≤")
    return {}


def load_fbo_orders():
    """–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö FBO –∑–∞–∫–∞–∑–æ–≤ –∑–∞ –¢–ï–ö–£–©–ò–ô –î–ï–ù–¨: SKU -> qty"""
    print("\nüì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ FBO –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å...")

    orders_by_sku = {}

    # –°—Ç–∞—Ç—É—Å—ã –¥–ª—è FBO (—Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã):
    # awaiting_packaging - –æ–∂–∏–¥–∞—é—Ç —Å–±–æ—Ä–∫–∏
    # awaiting_deliver - –æ–∂–∏–¥–∞—é—Ç –æ—Ç–≥—Ä—É–∑–∫–∏ (—ç—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –≤ API, –Ω–µ awaiting_approve!)
    # delivering - –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è
    statuses = ["awaiting_packaging", "awaiting_deliver", "delivering"]

    from datetime import datetime, timedelta, timezone
    
    # ‚úÖ –¢–ï–ö–£–©–ò–ô –î–ï–ù–¨ (–ø–æ –ú–°–ö)
    try:
        from zoneinfo import ZoneInfo
        MSK = ZoneInfo("Europe/Moscow")
        today_msk = datetime.now(MSK).date()
    except Exception:
        today_msk = datetime.now().date()
    
    # –ù–∞—á–∞–ª–æ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è –≤ UTC
    day_start_msk = datetime.combine(today_msk, datetime.min.time())
    day_start_utc = day_start_msk.astimezone(timezone.utc)
    
    # –ö–æ–Ω–µ—Ü —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è –≤ UTC
    day_end_msk = datetime.combine(today_msk + timedelta(days=1), datetime.min.time())
    day_end_utc = day_end_msk.astimezone(timezone.utc)
    
    from_dt = day_start_utc
    to_dt = day_end_utc
    since_str = from_dt.isoformat().replace("+00:00", "Z")
    to_str = to_dt.isoformat().replace("+00:00", "Z")
    
    print(f"  üìÖ –ü–µ—Ä–∏–æ–¥: {today_msk.isoformat()} (—Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å –ø–æ –ú–°–ö)")
    print(f"  ‚è∞ UTC: {since_str} ‚Üí {to_str}")

    def post_json(path, payload, timeout=20):
        r = requests.post(
            f"{OZON_HOST}{path}",
            json=payload,
            headers=get_ozon_headers(),
            timeout=timeout
        )
        return r

    # ‚úÖ –®–ê–ì 1: –°–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π (posting_number)
    posting_numbers = []
    status_counter = {}  # ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤
    
    for status in statuses:
        print(f"  üîç –°—Ç–∞—Ç—É—Å: {status}")
        offset = 0

        while True:
            data = {
                "filter": {
                    "status": status,
                    "since": since_str,
                    "to": to_str
                },
                "limit": 50,
                "offset": offset
            }

            r = post_json("/v2/posting/fbo/list", data)

            if offset == 0:
                print(f"    üì• /v2/posting/fbo/list —Å—Ç–∞—Ç—É—Å={r.status_code}")
                if r.status_code != 200:
                    print(f"    üìã –û—à–∏–±–∫–∞: {r.text[:500]}")
                    break

            if r.status_code != 200:
                break

            j = r.json()
            
            # ‚úÖ DEBUG: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
            if offset == 0:
                print(f"    üîç –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:")
                print(f"       –¢–∏–ø result: {type(j.get('result'))}")
                print(f"       –ü–µ—Ä–≤—ã–µ 300 —Å–∏–º–≤–æ–ª–æ–≤: {str(j)[:300]}")
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
            result = j.get("result", {})
            if isinstance(result, list):
                postings = result
            else:
                postings = result.get("postings", [])

            
            if not postings:
                if offset == 0:
                    print(f"    ‚ÑπÔ∏è  –ù–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º {status}")
                break

            print(f"    ‚úì –ü–æ–ª—É—á–µ–Ω–æ {len(postings)} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π")

            # –í—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º posting_number –∏ –ª–æ–≥–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å—ã
            for p in postings:
                pn = p.get("posting_number")
                if pn:
                    posting_numbers.append(pn)
                
                # ‚úÖ –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
                st = p.get("status")
                if st:
                    status_counter[st] = status_counter.get(st, 0) + 1

            offset += 50

    # ‚úÖ –í—ã–≤–æ–¥–∏–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã
    if status_counter:
        print(f"\n  üìå –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –≤ –æ—Ç–≤–µ—Ç–∞—Ö: {status_counter}\n")

    # –£–Ω–∏–∫–∞–ª–∏–∑–∏—Ä—É–µ–º
    posting_numbers = list(dict.fromkeys(posting_numbers))
    print(f"  ‚úÖ –í—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π: {len(posting_numbers)}")

    if not posting_numbers:
        print(f"  ‚ö†Ô∏è  –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π FBO")
        return orders_by_sku

    # ‚úÖ –®–ê–ì 2: –î–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∂–¥–æ–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ /v2/posting/fbo/get
    print(f"  üìä –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π...")
    successful = 0
    for i, posting_number in enumerate(posting_numbers, 1):
        if i % 10 == 0:
            print(f"    ‚úì –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {i}/{len(posting_numbers)}")
        
        data = {"posting_number": posting_number}
        r = post_json("/v2/posting/fbo/get", data, timeout=25)

        if r.status_code != 200:
            continue

        j = r.json()
        
        # ‚úÖ DEBUG –ø–µ—Ä–≤–æ–≥–æ posting
        if i == 1:
            print(f"\n  üîç DEBUG fbo/get –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ posting:")
            print(f"     result keys: {list(j.get('result', {}).keys())}")
            print(f"     sample: {json.dumps(j.get('result', {}), ensure_ascii=False)[:1500]}\n")
        
        posting = j.get("result", {})
        products = posting.get("products", []) or []

        # –°—É–º–º–∏—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã
        for pr in products:
            sku = pr.get("sku")
            qty = pr.get("quantity", 0)
            
            if sku:
                try:
                    qty = int(qty)
                except (TypeError, ValueError):
                    qty = 0
                
                orders_by_sku[sku] = orders_by_sku.get(sku, 0) + qty
                successful += 1

    print(f"  ‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π: {i}")
    print(f"  ‚úÖ –í—Å–µ–≥–æ SKU —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∑–∞–∫–∞–∑–∞–º–∏: {len(orders_by_sku)}")
    if orders_by_sku:
        examples = list(orders_by_sku.items())[:5]
        print(f"     –ü—Ä–∏–º–µ—Ä—ã: {examples}")
    
    return orders_by_sku


def load_fbo_supply_orders():
    """
    –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫—É FBO –∏–∑ Ozon API.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–≤–∞ —Å–ª–æ–≤–∞—Ä—è:
    - in_transit: {sku: qty} - —Ç–æ–≤–∞—Ä—ã "–≤ –ø—É—Ç–∏" (—Å—Ç–∞—Ç—É—Å—ã ACCEPTED, IN_PROCESS)
    - in_draft: {sku: qty} - —Ç–æ–≤–∞—Ä—ã "–≤ –∑–∞—è–≤–∫–∞—Ö" (—Å—Ç–∞—Ç—É—Å—ã NEW, FILLING_DELIVERY_DETAILS)
    """
    print("\nüì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫—É FBO...")

    in_transit = {}  # –¢–æ–≤–∞—Ä—ã –≤ –ø—É—Ç–∏
    in_draft = {}    # –¢–æ–≤–∞—Ä—ã –≤ –∑–∞—è–≤–∫–∞—Ö/—á–µ—Ä–Ω–æ–≤–∏–∫–∞—Ö

    try:
        # –ó–∞–ø—Ä–æ—Å —Å–ø–∏—Å–∫–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫—É
        # API: /v3/supply-order/list
        data = {
            "limit": 100,
            "offset": 0,
            "sort_by": 1,  # 1 = —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è
            "filter": {
                "states": [
                    "NEW",
                    "FILLING_DELIVERY_DETAILS",
                    "READY_TO_SUPPLY",
                    "ACCEPTED",
                    "IN_PROCESS",
                    "COURIER_ASSIGNED",
                    "COURIER_PICKED_UP",
                    "IN_TRANSIT_TO_STORAGE_WAREHOUSE",
                    "ACCEPTANCE_AT_STORAGE_WAREHOUSE"
                ]
            }
        }

        all_orders = []
        offset = 0
        max_pages = 10  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

        while offset < max_pages * 100:
            data["offset"] = offset

            response = requests.post(
                f"{OZON_HOST}/v3/supply-order/list",
                json=data,
                headers=get_ozon_headers(),
                timeout=30
            )

            if response.status_code != 200:
                if offset == 0:
                    print(f"  ‚ö†Ô∏è  –û—à–∏–±–∫–∞ API /v3/supply-order/list: {response.status_code}")
                    print(f"     {response.text[:300]}")
                break

            result = response.json()
            orders = result.get("result", [])

            if not orders:
                break

            all_orders.extend(orders)

            if len(orders) < 100:
                break

            offset += 100

        if not all_orders:
            print("  ‚ÑπÔ∏è  –ù–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫—É")
            return in_transit, in_draft

        print(f"  üìä –ù–∞–π–¥–µ–Ω–æ –∑–∞—è–≤–æ–∫: {len(all_orders)}")

        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –∑–∞—è–≤–∫—É
        for order in all_orders:
            supply_order_id = order.get("supply_order_id")
            state = order.get("state", "")

            if not supply_order_id:
                continue

            # –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏ —á–µ—Ä–µ–∑ /v3/supply-order/get
            detail_data = {"supply_order_id": supply_order_id}

            detail_response = requests.post(
                f"{OZON_HOST}/v3/supply-order/get",
                json=detail_data,
                headers=get_ozon_headers(),
                timeout=30
            )

            if detail_response.status_code != 200:
                continue

            detail_result = detail_response.json()
            order_detail = detail_result.get("result", {})
            products = order_detail.get("products", [])

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫—É–¥–∞ –∑–∞–ø–∏—Å–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
            # –°—Ç–∞—Ç—É—Å—ã "–≤ –ø—É—Ç–∏": ACCEPTED, IN_PROCESS
            # –°—Ç–∞—Ç—É—Å—ã "–≤ –∑–∞—è–≤–∫–∞—Ö": NEW, FILLING_DELIVERY_DETAILS, COURIER_ASSIGNED

            target_dict = None
            if state in ["ACCEPTED", "IN_PROCESS", "COURIER_PICKED_UP", "IN_TRANSIT_TO_STORAGE_WAREHOUSE"]:
                target_dict = in_transit
            elif state in ["NEW", "FILLING_DELIVERY_DETAILS", "COURIER_ASSIGNED", "READY_TO_SUPPLY"]:
                target_dict = in_draft

            if target_dict is not None:
                for product in products:
                    sku = product.get("sku")
                    quantity = product.get("quantity", 0)

                    if sku:
                        try:
                            quantity = int(quantity)
                        except (TypeError, ValueError):
                            quantity = 0

                        target_dict[sku] = target_dict.get(sku, 0) + quantity

        print(f"  ‚úÖ –¢–æ–≤–∞—Ä–æ–≤ '–≤ –ø—É—Ç–∏': {len(in_transit)} SKU")
        print(f"  ‚úÖ –¢–æ–≤–∞—Ä–æ–≤ '–≤ –∑–∞—è–≤–∫–∞—Ö': {len(in_draft)} SKU")

        if in_transit:
            examples = list(in_transit.items())[:3]
            print(f"     –ü—Ä–∏–º–µ—Ä—ã (–≤ –ø—É—Ç–∏): {examples}")

        if in_draft:
            examples = list(in_draft.items())[:3]
            print(f"     –ü—Ä–∏–º–µ—Ä—ã (–≤ –∑–∞—è–≤–∫–∞—Ö): {examples}")

    except Exception as e:
        print(f"  ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫—É: {e}")
        import traceback
        traceback.print_exc()

    return in_transit, in_draft


def load_product_prices(products_data=None):
    """
    –ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–Ω —Ç–æ–≤–∞—Ä–æ–≤ —á–µ—Ä–µ–∑ Seller API.

    API: POST /v4/product/info

    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        products_data - —Å–ª–æ–≤–∞—Ä—å {sku: {...}} —Å –¥–∞–Ω–Ω—ã–º–∏ —Ç–æ–≤–∞—Ä–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω - –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏–∑ –ë–î)

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {sku: {"price": —Ü–µ–Ω–∞_–≤_–ª–∫, "marketing_price": —Ü–µ–Ω–∞_–Ω–∞_—Å–∞–π—Ç–µ}}

    price - —Ü–µ–Ω–∞ –∫–æ—Ç–æ—Ä—É—é —Å—Ç–∞–≤–∏—Ç–µ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ (–¥–æ —Å–∫–∏–¥–∫–∏)
    marketing_price - —Ü–µ–Ω–∞ –∫–æ—Ç–æ—Ä—É—é –≤–∏–¥–∏—Ç –∫–ª–∏–µ–Ω—Ç –Ω–∞ —Å–∞–π—Ç–µ (—Å —É—á—ë—Ç–æ–º —Å–∫–∏–¥–∫–∏)
    """
    print("\nüí∞ –ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–Ω —Ç–æ–≤–∞—Ä–æ–≤...")

    prices_by_sku = {}  # {sku: {"price": X, "marketing_price": Y}}

    try:
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö SKU
        if products_data:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å —Ç–æ–≤–∞—Ä–æ–≤
            all_skus = list(products_data.keys())
        else:
            # –ü–æ–ª—É—á–∞–µ–º –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–¥–ª—è —Å–ª—É—á–∞—è –∫–æ–≥–¥–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ)
            conn = sqlite3.connect(DB_PATH)
            cursor = conn.cursor()
            cursor.execute('SELECT DISTINCT sku FROM products WHERE sku IS NOT NULL')
            all_skus = [row[0] for row in cursor.fetchall()]
            conn.close()

        if not all_skus:
            print("  ‚ö†Ô∏è  –ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–µ–Ω")
            return prices_by_sku

        print(f"  üìä –ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–Ω –¥–ª—è {len(all_skus)} —Ç–æ–≤–∞—Ä–æ–≤...")

        # –®–ê–ì 1: –ü–æ–ª—É—á–∞–µ–º mapping SKU ‚Üí offer_id —á–µ—Ä–µ–∑ /v3/product/info/list
        sku_to_offer_id = {}
        batch_size = 1000

        for i in range(0, len(all_skus), batch_size):
            batch_skus = all_skus[i:i + batch_size]

            response = requests.post(
                f"{OZON_HOST}/v3/product/info/list",
                json={"sku": batch_skus},
                headers=get_ozon_headers(),
                timeout=30
            )

            if response.status_code == 200:
                items = response.json().get("items", [])

                # DEBUG: –≤—ã–≤–æ–¥–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–µ—Ä–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª–µ–π
                if i == 0 and items and len(items) > 0:
                    print(f"  üîç DEBUG —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ /v3/product/info/list:")
                    print(f"     –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è: {items[0].keys()}")
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ä–µ–π—Ç–∏–Ω–≥ –∏ –æ—Ç–∑—ã–≤—ã
                    if 'rating' in items[0]:
                        print(f"     ‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª–µ rating: {items[0].get('rating')}")
                    if 'rating_count' in items[0]:
                        print(f"     ‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª–µ rating_count: {items[0].get('rating_count')}")

                for item in items:
                    sku = item.get("sku")
                    offer_id = item.get("offer_id")

                    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤ –µ—Å–ª–∏ –µ—Å—Ç—å
                    rating = item.get("rating", None)
                    review_count = item.get("rating_count", None)

                    if sku and offer_id:
                        sku_to_offer_id[sku] = {
                            "offer_id": offer_id,
                            "rating": rating,
                            "review_count": review_count
                        }

        print(f"  ‚úì –ü–æ–ª—É—á–µ–Ω–æ {len(sku_to_offer_id)} offer_id (—Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º –∏ –æ—Ç–∑—ã–≤–∞–º–∏)")

        # –®–ê–ì 2: –ü–æ–ª—É—á–∞–µ–º —Ç–æ—á–Ω—ã–µ —Ü–µ–Ω—ã —á–µ—Ä–µ–∑ /v5/product/info/prices
        all_offer_ids = [info["offer_id"] for info in sku_to_offer_id.values()]

        for i in range(0, len(all_offer_ids), batch_size):
            batch_offer_ids = all_offer_ids[i:i + batch_size]

            # /v5/product/info/prices —Å–æ–¥–µ—Ä–∂–∏—Ç marketing_seller_price - —Ç–æ—á–Ω—É—é "–í–∞—à—É —Ü–µ–Ω—É"
            data = {
                "filter": {
                    "offer_id": batch_offer_ids,
                    "product_id": [],
                    "visibility": "ALL"
                },
                "limit": 1000
            }

            response = requests.post(
                f"{OZON_HOST}/v5/product/info/prices",
                json=data,
                headers=get_ozon_headers(),
                timeout=30
            )

            if response.status_code != 200:
                print(f"  ‚ö†Ô∏è  –û—à–∏–±–∫–∞ API /v5/product/info/prices (batch {i // batch_size + 1}): {response.status_code}")
                print(f"     {response.text[:200]}")
                continue

            result = response.json()
            items = result.get("items", [])

            for item in items:
                offer_id = item.get("offer_id")
                if not offer_id:
                    continue

                # –ù–∞—Ö–æ–¥–∏–º SKU –ø–æ offer_id
                sku = None
                sku_info = None
                for s, info in sku_to_offer_id.items():
                    if info["offer_id"] == offer_id:
                        sku = s
                        sku_info = info
                        break

                if not sku:
                    continue

                # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ü–µ–Ω—ã –∏–∑ price –æ–±—ä–µ–∫—Ç–∞
                price_obj = item.get("price", {})
                price_indexes = item.get("price_indexes", {})

                # "–í–∞—à–∞ —Ü–µ–Ω–∞" –≤ –õ–ö (—Å —É—á–µ—Ç–æ–º –∞–∫—Ü–∏–π/–±—É—Å—Ç–∏–Ω–≥–∞) = marketing_seller_price
                marketing_seller_price = price_obj.get("marketing_seller_price", 0)

                # –¶–µ–Ω–∞ –Ω–∞ —Å–∞–π—Ç–µ (—Å Ozon –∫–∞—Ä—Ç–æ–π) = –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –∏–∑ –∏–Ω–¥–µ–∫—Å–∞
                external_index = price_indexes.get("external_index_data", {})
                website_price = external_index.get("min_price", 0)

                # –ò–Ω–¥–µ–∫—Å —Ü–µ–Ω—ã (color_index) ‚Äî —Ü–≤–µ—Ç–æ–≤–æ–π –∏–Ω–¥–µ–∫—Å —Ü–µ–Ω—ã
                # –í–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: "SUPER", "GOOD", "AVG", "BAD", "WITHOUT_INDEX"
                price_index_value = price_indexes.get("color_index", None)

                # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ float
                try:
                    seller_price = float(marketing_seller_price) if marketing_seller_price else 0
                    site_price = float(website_price) if website_price else 0
                except (ValueError, TypeError):
                    seller_price = 0
                    site_price = 0

                prices_by_sku[sku] = {
                    "price": seller_price,  # –¶–µ–Ω–∞ –≤ –õ–ö (–í–∞—à–∞ —Ü–µ–Ω–∞ —Å –±—É—Å—Ç–∏–Ω–≥–æ–º) - 19,492‚ÇΩ
                    "marketing_price": site_price,  # –¶–µ–Ω–∞ –Ω–∞ —Å–∞–π—Ç–µ (—Å Ozon –∫–∞—Ä—Ç–æ–π) - 11,658‚ÇΩ
                    "rating": sku_info["rating"],  # –†–µ–π—Ç–∏–Ω–≥ —Ç–æ–≤–∞—Ä–∞
                    "review_count": sku_info["review_count"],  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤
                    "offer_id": offer_id,  # –ê—Ä—Ç–∏–∫—É–ª —Ç–æ–≤–∞—Ä–∞ (—Ç–µ–∫—Å—Ç–æ–≤—ã–π, –Ω–∞–ø—Ä–∏–º–µ—Ä "ABC-123")
                    "price_index": price_index_value  # –ò–Ω–¥–µ–∫—Å —Ü–µ–Ω—ã (WITHOUT_INDEX, PROFIT, AVG_PROFIT –∏ —Ç.–¥.)
                }

            print(f"  ‚úì –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {len(items)} —Ç–æ–≤–∞—Ä–æ–≤ (batch {i // batch_size + 1})")

        print(f"  ‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ü–µ–Ω –¥–ª—è {len(prices_by_sku)} —Ç–æ–≤–∞—Ä–æ–≤")

    except Exception as e:
        print(f"  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ü–µ–Ω: {e}")
        import traceback
        traceback.print_exc()

    return prices_by_sku


def parse_product_card(sku):
    """
    ============================================================================
    –ü–ê–†–°–ò–ù–ì –ö–ê–†–¢–û–ß–ö–ò –¢–û–í–ê–†–ê OZON
    ============================================================================

    –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤ —Å –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∞–π—Ç–µ Ozon

    Args:
        sku (int): SKU —Ç–æ–≤–∞—Ä–∞

    Returns:
        dict: {'rating': float, 'review_count': int} –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
    """
    try:
        url = f"https://www.ozon.ru/product/-{sku}/"

        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
            'Accept-Language': 'ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7',
        }

        response = requests.get(url, headers=headers, timeout=10)

        if response.status_code != 200:
            print(f"  ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É SKU {sku}: —Å—Ç–∞—Ç—É—Å {response.status_code}")
            return None

        soup = BeautifulSoup(response.text, 'html.parser')

        # –ò—â–µ–º JSON –¥–∞–Ω–Ω—ã–µ –≤ script —Ç–µ–≥–∞—Ö
        rating = None
        review_count = None

        # –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–æ–∏—Å–∫ –≤ JSON –¥–∞–Ω–Ω—ã—Ö –≤–Ω—É—Ç—Ä–∏ script —Ç–µ–≥–æ–≤
        for script in soup.find_all('script', type='application/ld+json'):
            try:
                data = json.loads(script.string)
                if isinstance(data, dict) and 'aggregateRating' in data:
                    rating = float(data['aggregateRating'].get('ratingValue', 0))
                    review_count = int(data['aggregateRating'].get('reviewCount', 0))
                    break
            except:
                continue

        # –í–∞—Ä–∏–∞–Ω—Ç 2: –ü–æ–∏—Å–∫ —á–µ—Ä–µ–∑ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –≤ HTML
        if rating is None or review_count is None:
            # –ü–æ–∏—Å–∫ —Ä–µ–π—Ç–∏–Ω–≥–∞: –æ–±—ã—á–Ω–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "4.5" –∏–ª–∏ "4,5"
            rating_match = re.search(r'"ratingValue["\s:]+([0-9]+[.,][0-9]+)', response.text)
            if rating_match:
                rating = float(rating_match.group(1).replace(',', '.'))

            # –ü–æ–∏—Å–∫ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç–∑—ã–≤–æ–≤
            review_match = re.search(r'"reviewCount["\s:]+(\d+)', response.text)
            if review_match:
                review_count = int(review_match.group(1))

        if rating is not None and review_count is not None:
            print(f"  ‚úÖ SKU {sku}: —Ä–µ–π—Ç–∏–Ω–≥={rating}, –æ—Ç–∑—ã–≤–æ–≤={review_count}")
            return {'rating': rating, 'review_count': review_count}
        else:
            print(f"  ‚ö†Ô∏è  SKU {sku}: –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ä–µ–π—Ç–∏–Ω–≥ –∏–ª–∏ –æ—Ç–∑—ã–≤—ã")
            return None

    except Exception as e:
        print(f"  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –∫–∞—Ä—Ç–æ—á–∫–∏ SKU {sku}: {e}")
        return None


def load_all_account_skus():
    """
    ============================================================================
    –ü–û–õ–£–ß–ï–ù–ò–ï –í–°–ï–• SKU –ê–ö–ö–ê–£–ù–¢–ê
    ============================================================================

    –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç /v3/product/list (–≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã), –∑–∞—Ç–µ–º —á–µ—Ä–µ–∑
    /v3/product/info/list –ø–æ–ª—É—á–∞–µ—Ç FBO SKU –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        list[int]: –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö SKU (–≤–∫–ª—é—á–∞—è —Ç–æ–≤–∞—Ä—ã –±–µ–∑ FBO –æ—Å—Ç–∞—Ç–∫–æ–≤)
    """
    try:
        # –®–∞–≥ 1: –ø–æ–ª—É—á–∞–µ–º –≤—Å–µ product_id –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
        resp = requests.post(
            f"{OZON_HOST}/v3/product/list",
            json={"filter": {"visibility": "ALL"}, "limit": 1000},
            headers=get_ozon_headers(),
            timeout=15
        )
        if resp.status_code != 200:
            print(f"  ‚ö†Ô∏è  –û—à–∏–±–∫–∞ /v3/product/list: {resp.status_code}")
            return [], {}

        items = resp.json().get("result", {}).get("items", [])
        if not items:
            return [], {}

        # –®–∞–≥ 2: –ø–æ–ª—É—á–∞–µ–º SKU –∏ –∏–º–µ–Ω–∞ —á–µ—Ä–µ–∑ /v3/product/info/list –ø–æ product_id
        product_ids = [it["product_id"] for it in items]
        all_skus = []
        sku_names = {}  # {sku: name} ‚Äî –∏–º–µ–Ω–∞ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è products_data

        for i in range(0, len(product_ids), 100):
            batch = product_ids[i:i + 100]
            resp2 = requests.post(
                f"{OZON_HOST}/v3/product/info/list",
                json={"product_id": batch},
                headers=get_ozon_headers(),
                timeout=30
            )
            if resp2.status_code == 200:
                info_items = resp2.json().get("items", [])
                for it in info_items:
                    sku = it.get("sku")
                    if sku:
                        all_skus.append(sku)
                        sku_names[sku] = it.get("name", "")

        print(f"  üì¶ –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∞–∫–∫–∞—É–Ω—Ç–µ: {len(all_skus)} SKU")
        return all_skus, sku_names

    except Exception as e:
        print(f"  ‚ùå –û—à–∏–±–∫–∞ load_all_account_skus: {e}")
        return [], {}


def load_fbo_analytics(cursor, conn, snapshot_date, sku_list=None):
    """
    ============================================================================
    –ó–ê–ì–†–£–ó–ö–ê –ê–ù–ê–õ–ò–¢–ò–ö–ò FBO –ü–û –ö–õ–ê–°–¢–ï–†–ê–ú
    ============================================================================

    –í—ã–∑—ã–≤–∞–µ—Ç /v1/analytics/stocks –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è:
    - ADS (—Å—Ä–µ–¥–Ω–µ—Å—É—Ç–æ—á–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏) ‚Äî –æ–±—â–∏–π –ø–æ —Ç–æ–≤–∞—Ä—É –∏ –ø–æ –∫–ª–∞—Å—Ç–µ—Ä—É
    - IDC (–¥–Ω–µ–π –¥–æ –∫–æ–Ω—Ü–∞ –æ—Å—Ç–∞—Ç–∫–∞ –ø–æ –∫–ª–∞—Å—Ç–µ—Ä—É)
    - –î–Ω–µ–π –±–µ–∑ –ø—Ä–æ–¥–∞–∂ (–ø–æ –∫–ª–∞—Å—Ç–µ—Ä—É)
    - –°—Ç–∞—Ç—É—Å –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç–∏ (turnover_grade_cluster)
    - –û—Å—Ç–∞—Ç–∫–∏ –ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º (available_stock_count)

    API —Ç—Ä–µ–±—É–µ—Ç —Å–ø–∏—Å–æ–∫ SKU. –ï—Å–ª–∏ sku_list –ø–µ—Ä–µ–¥–∞–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ,
    –∏–Ω–∞—á–µ –±–µ—Ä—ë–º –∏–∑ —Ç–∞–±–ª–∏—Ü—ã products.
    –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ –æ—Ç–≤–µ—Ç–µ ‚Äî –æ–¥–∏–Ω –∫–ª–∞—Å—Ç–µ—Ä –¥–ª—è –æ–¥–Ω–æ–≥–æ SKU.
    –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É fbo_analytics.
    """
    print("\nüìä –ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ FBO –ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º...")

    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ SKU –∏–ª–∏ –±–µ—Ä—ë–º –∏–∑ –ë–î
        if sku_list:
            all_skus = list(sku_list)
        else:
            cursor.execute('SELECT sku FROM products')
            all_skus = [row[0] for row in cursor.fetchall()]

        if not all_skus:
            print("  ‚ö†Ô∏è  –ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –≤ –ë–î ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∞–Ω–∞–ª–∏—Ç–∏–∫–∏")
            return

        print(f"  üì¶ SKU –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞: {len(all_skus)}")

        # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
        cursor.execute('DELETE FROM fbo_analytics WHERE snapshot_date = ?', (snapshot_date,))

        # –°–ª–æ–≤–∞—Ä—å –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –ø–æ (sku, cluster_name)
        # API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ —Å—Ç—Ä–æ–∫–µ –Ω–∞ –ö–ê–ñ–î–´–ô –°–ö–õ–ê–î –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞.
        # –ù—É–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å: —Å—É–º–º–∏—Ä–æ–≤–∞—Ç—å stock, –∞ –º–µ—Ç—Ä–∏–∫–∏ (ADS, IDC –∏ —Ç.–¥.)
        # –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –¥–ª—è –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ ‚Äî –±–µ—Ä—ë–º –æ–¥–∏–Ω —Ä–∞–∑.
        cluster_agg = {}  # –∫–ª—é—á: (sku, cluster_name) -> {ads, idc, days, liq, stock}

        # API –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–æ 100 SKU –∑–∞ —Ä–∞–∑
        for batch_start in range(0, len(all_skus), 100):
            batch_skus = all_skus[batch_start:batch_start + 100]
            offset = 0

            while True:
                response = requests.post(
                    f"{OZON_HOST}/v1/analytics/stocks",
                    json={
                        "limit": 100,
                        "offset": offset,
                        "warehouse_type": "FBO",
                        "skus": batch_skus
                    },
                    headers=get_ozon_headers(),
                    timeout=30
                )

                if response.status_code != 200:
                    print(f"  ‚ö†Ô∏è  –û—à–∏–±–∫–∞ API /v1/analytics/stocks: {response.status_code}")
                    if offset == 0:
                        print(f"     {response.text[:300]}")
                    break

                result = response.json()
                # –û—Ç–≤–µ—Ç: {"items": [...]} ‚Äî –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç = –æ–¥–∏–Ω –°–ö–õ–ê–î –¥–ª—è –æ–¥–Ω–æ–≥–æ SKU
                items = result.get("items", [])

                if not items:
                    break

                for item in items:
                    sku = item.get("sku")
                    if not sku:
                        continue

                    cluster_name = item.get("cluster_name", "")
                    key = (sku, cluster_name)

                    # available_stock_count ‚Äî –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –ö–û–ù–ö–†–ï–¢–ù–û–ú —Å–∫–ª–∞–¥–µ
                    stock = int(item.get("available_stock_count", 0) or 0)

                    if key not in cluster_agg:
                        # –ü–µ—Ä–≤—ã–π —Å–∫–ª–∞–¥ –≤ —ç—Ç–æ–º –∫–ª–∞—Å—Ç–µ—Ä–µ ‚Äî –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏
                        # ads_cluster, idc_cluster, days_without_sales_cluster,
                        # turnover_grade_cluster ‚Äî –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –¥–ª—è –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤ –∫–ª–∞—Å—Ç–µ—Ä–∞
                        cluster_agg[key] = {
                            'ads': float(item.get("ads_cluster", 0) or 0),
                            'idc': float(item.get("idc_cluster", 0) or 0),
                            'days_no_sales': int(item.get("days_without_sales_cluster", 0) or 0),
                            'liquidity': item.get("turnover_grade_cluster", ""),
                            'stock': stock
                        }
                    else:
                        # –ï—â—ë –æ–¥–∏–Ω —Å–∫–ª–∞–¥ –≤ —Ç–æ–º –∂–µ –∫–ª–∞—Å—Ç–µ—Ä–µ ‚Äî —Å—É–º–º–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ stock
                        cluster_agg[key]['stock'] += stock

                if len(items) < 100:
                    break

                offset += 100

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î ‚Äî –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –Ω–∞ –∫–ª–∞—Å—Ç–µ—Ä
        total_rows = 0
        for (sku, cluster_name), data in cluster_agg.items():
            cursor.execute('''
                INSERT INTO fbo_analytics
                (sku, cluster_name, ads, idc, days_without_sales, liquidity_status, stock, snapshot_date)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            ''', (sku, cluster_name, data['ads'], data['idc'],
                  data['days_no_sales'], data['liquidity'], data['stock'], snapshot_date))
            total_rows += 1

        conn.commit()
        print(f"  ‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {total_rows} –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ (–∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–æ –∏–∑ {sum(1 for _ in cluster_agg)} —É–Ω–∏–∫. –ø–∞—Ä)")

    except Exception as e:
        print(f"  ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ FBO: {e}")
        import traceback
        traceback.print_exc()


def sync_products():
    """
    ============================================================================
    –¶–ï–ù–¢–†–ê–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò –í–°–ï–• –î–ê–ù–ù–´–•
    ============================================================================

    ‚ö†Ô∏è  –í–ê–ñ–ù–û: –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ —á–µ—Ä–µ–∑ cron!

    –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ù–û–í–´–• —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö (–Ω–æ–≤—ã–µ API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã, –Ω–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏):
    1. –°–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é load_–Ω–æ–≤—ã–µ_–¥–∞–Ω–Ω—ã–µ()
    2. –í—ã–∑–æ–≤–∏ –µ—ë –ó–î–ï–°–¨ –≤ sync_products()
    3. –î–æ–±–∞–≤—å –¥–∞–Ω–Ω—ã–µ –≤ INSERT –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è products –∏ products_history
    4. –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤

    –¢–µ–∫—É—â–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:
    - –û—Å—Ç–∞—Ç–∫–∏ FBO (/v2/analytics/stock_on_warehouses)
    - –ó–∞–∫–∞–∑—ã (load_fbo_orders)
    - –°—Ä–µ–¥–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ (load_avg_positions)
    - –ü–æ–∫–∞–∑—ã –≤ –ø–æ–∏—Å–∫–µ (load_hits_view_search)
    - –ü–µ—Ä–µ—Ö–æ–¥—ã –≤ –∫–∞—Ä—Ç–æ—á–∫—É (load_hits_view_search_pdp)
    - –î–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É (load_hits_add_to_cart)
    - –†–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ä–µ–∫–ª–∞–º—É (load_adv_spend_by_sku) —Å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∏—Å—Ç–æ—Ä–∏–∏
    - –†–∞—Å—á–µ—Ç–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏: CTR, CR1, CR2

    ============================================================================
    """
    print("\nüì• –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ FBO –∏–∑ Ozon...")
    
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        # ‚ö†Ô∏è –ù–ï —É–¥–∞–ª—è–µ–º products –∑–¥–µ—Å—å ‚Äî —É–¥–∞–ª–∏–º –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é, –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –ø–æ–ª—É—á–µ–Ω—ã
        # –≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç —Å–∏—Ç—É–∞—Ü–∏–∏ –∫–æ–≥–¥–∞ API –≤—Ä–µ–º–µ–Ω–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç

        print("\nüìä –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤...")
        
        products_data = {}  # sku -> {name, fbo_stock}
        warehouse_rows = []  # –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ —Å–∫–ª–∞–¥–∞–º

        offset = 0
        while True:
            # ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ô –∑–∞–ø—Ä–æ—Å - –ë–ï–ó filter, —Ç–æ–ª—å–∫–æ warehouse_type!
            stocks_data = {
                "warehouse_type": "FBO",
                "limit": 1000,
                "offset": offset
            }
            
            print(f"  üì§ –ó–∞–ø—Ä–æ—Å: offset={offset}")
            
            stocks_response = requests.post(
                f"{OZON_HOST}/v2/analytics/stock_on_warehouses",
                json=stocks_data,
                headers=get_ozon_headers(),
                timeout=15
            )
            
            if stocks_response.status_code != 200:
                print(f"  ‚ùå –û—à–∏–±–∫–∞ API: {stocks_response.status_code}")
                print(f"  üìã –û—Ç–≤–µ—Ç: {stocks_response.text}")
                conn.close()
                return False  # ‚úÖ –ù–µ –ø–∏—à–µ–º —á–∞—Å—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            
            stocks_result = stocks_response.json()
            rows = stocks_result.get("result", {}).get("rows", [])

            # ‚úÖ DEBUG: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏
            if offset == 0 and rows:
                print(f"\n  üîç –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏:")
                print(f"     {json.dumps(rows[0], ensure_ascii=False, indent=6)}\n")

            if not rows:
                print(f"  ‚úì –ö–æ–Ω–µ—Ü –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ offset={offset}")
                break
            
            print(f"  ‚úì –ü–æ–ª—É—á–µ–Ω–æ {len(rows)} —Å—Ç—Ä–æ–∫")
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ - —Å—É–º–º–∏—Ä—É–µ–º –ø–æ SKU
            for row in rows:
                sku = row.get("sku")
                item_name = row.get("item_name", "")
                
                # ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º STOCK_FIELD –∏–∑ .env, —Å fallback
                # –ò–Ω–∞—á–µ 0 —Å—á–∏—Ç–∞–µ—Ç—Å—è False –∏ –º—ã –±–µ—Ä—ë–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—è
                free_amount = row.get(STOCK_FIELD)  # ‚Üê –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ, —á—Ç–æ –≤—ã–±—Ä–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                
                # fallback –µ—Å–ª–∏ STOCK_FIELD –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç/None
                if free_amount is None:
                    free_amount = row.get("free_to_sell_amount")
                if free_amount is None:
                    free_amount = row.get("available")
                if free_amount is None:
                    free_amount = row.get("present")
                if free_amount is None:
                    free_amount = 0
                
                # ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ int (–∏–Ω–æ–≥–¥–∞ API –æ—Ç–¥–∞—ë—Ç —á–∏—Å–ª–∞ –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏)
                try:
                    free_amount = int(free_amount)
                except (TypeError, ValueError):
                    free_amount = 0
                
                if not sku:
                    continue
                
                # –°—É–º–º–∏—Ä—É–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ –≤—Å–µ–º FBO —Å–∫–ª–∞–¥–∞–º –¥–ª—è –æ–¥–Ω–æ–≥–æ SKU
                if sku not in products_data:
                    products_data[sku] = {
                        "name": item_name,
                        "fbo_stock": 0
                    }
                
                products_data[sku]["fbo_stock"] += free_amount

                # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã fbo_warehouse_stock
                wh_name = row.get("warehouse_name", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–∫–ª–∞–¥")
                warehouse_rows.append((sku, wh_name, free_amount))
            
            offset += 1000
        
        print(f"\n  ‚úÖ –í—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤: {len(products_data)}")

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ —Å–∫–ª–∞–¥–∞–º –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
        snapshot_date = get_snapshot_date()
        cursor.execute('DELETE FROM fbo_warehouse_stock WHERE snapshot_date = ?', (snapshot_date,))
        for wh_sku, wh_name, wh_stock in warehouse_rows:
            cursor.execute('''
                INSERT INTO fbo_warehouse_stock (sku, warehouse_name, stock, snapshot_date)
                VALUES (?, ?, ?, ?)
            ''', (wh_sku, wh_name, wh_stock, snapshot_date))
        conn.commit()
        print(f"  ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ {len(warehouse_rows)} —Å—Ç—Ä–æ–∫ –ø–æ —Å–∫–ª–∞–¥–∞–º")

        # ============================================================================
        # –ó–ê–ì–†–£–ó–ö–ê –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–• –î–ê–ù–ù–´–•
        # ============================================================================
        # ‚ö†Ô∏è  –ü–†–ò –î–û–ë–ê–í–õ–ï–ù–ò–ò –ù–û–í–´–• –î–ê–ù–ù–´–•: –¥–æ–±–∞–≤–ª—è–π –≤—ã–∑–æ–≤—ã load_–Ω–æ–≤—ã–µ_–¥–∞–Ω–Ω—ã–µ() –°–Æ–î–ê

        # ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã
        orders_by_sku = load_fbo_orders()

        # ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫—É (–í –ü–£–¢–ò –∏ –í –ó–ê–Ø–í–ö–ê–•)
        in_transit_by_sku, in_draft_by_sku = load_fbo_supply_orders()

        # ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É FBO (ADS, IDC, –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º)
        # –ü–æ–ª—É—á–∞–µ–º –í–°–ï SKU –∞–∫–∫–∞—É–Ω—Ç–∞ (–Ω–µ —Ç–æ–ª—å–∫–æ —Ç–µ —á—Ç–æ –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö FBO),
        # —á—Ç–æ–±—ã –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ FBO" –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
        all_account_skus, sku_names = load_all_account_skus()

        # ‚úÖ –ï—Å–ª–∏ stock_on_warehouses –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –∑–∞–ø–æ–ª–Ω—è–µ–º products_data
        # –∏–∑ all_account_skus, —á—Ç–æ–±—ã —Ç–æ–≤–∞—Ä—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å –≤ –ë–î —Å fbo_stock=0
        if not products_data and all_account_skus:
            print(f"\n  ‚ö†Ô∏è  –û—Å—Ç–∞—Ç–∫–∏ FBO –ø—É—Å—Ç—ã–µ, –Ω–æ –Ω–∞–π–¥–µ–Ω–æ {len(all_account_skus)} SKU –≤ –∞–∫–∫–∞—É–Ω—Ç–µ")
            print(f"  üì¶ –°–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å–∏ —Ç–æ–≤–∞—Ä–æ–≤ —Å fbo_stock=0")
            for sku in all_account_skus:
                products_data[sku] = {
                    "name": sku_names.get(sku, ""),
                    "fbo_stock": 0
                }
        elif all_account_skus:
            # –î–æ–±–∞–≤–ª—è–µ–º SKU, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ –∞–∫–∫–∞—É–Ω—Ç–µ, –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ stock_on_warehouses
            missing_count = 0
            for sku in all_account_skus:
                if sku not in products_data:
                    products_data[sku] = {
                        "name": sku_names.get(sku, ""),
                        "fbo_stock": 0
                    }
                    missing_count += 1
            if missing_count > 0:
                print(f"  üì¶ –î–æ–±–∞–≤–ª–µ–Ω–æ {missing_count} SKU –±–µ–∑ FBO –æ—Å—Ç–∞—Ç–∫–æ–≤")

        # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å SKU –∏–∑ stock_on_warehouses (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –∫–∞–∫–æ–π-—Ç–æ SKU –Ω–µ –≤ product/list)
        combined_skus = list(set(list(products_data.keys()) + all_account_skus))
        load_fbo_analytics(cursor, conn, snapshot_date, sku_list=combined_skus)

        # ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–æ–≤
        prices_by_sku = load_product_prices(products_data)

        # ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ä–µ–¥–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏
        avg_positions = load_avg_positions()
        
        # ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–∫–∞–∑—ã –≤ –ø–æ–∏—Å–∫–µ –∏ –∫–∞—Ç–∞–ª–æ–≥–µ
        hits_view_search_data = load_hits_view_search()
        
        # ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥—ã –≤ –∫–∞—Ä—Ç–æ—á–∫—É
        hits_view_search_pdp_data = load_hits_view_search_pdp()
        
        # ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É
        hits_tocart_pdp_data = load_hits_add_to_cart()



        # ‚úÖ –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É —Å–Ω–∏–º–∫–∞ –ø–æ –ë–µ–ª–≥—Ä–∞–¥—É (YYYY-MM-DD) - –ü–ï–†–ï–î –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º!
        snapshot_date = get_snapshot_date()
        snapshot_time = get_snapshot_time()

        # ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ä–µ–∫–ª–∞–º—É –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π (–¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
        date_to = snapshot_date
        date_from = (datetime.fromisoformat(snapshot_date) - timedelta(days=7)).date().isoformat()
        adv_spend_data = load_adv_spend_by_sku(date_from, date_to)

        # ‚úÖ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ä–µ–∫–ª–∞–º—É –¥–ª—è –≤—Å–µ—Ö –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞—Ç
        # –§–æ—Ä–º–∞—Ç adv_spend_data: {date: {sku: spend}}
        if adv_spend_data:
            print(f"\nüìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ —Ä–µ–∫–ª–∞–º—É...")
            updated_count = 0
            for date, skus_spend in adv_spend_data.items():
                for sku, spend in skus_spend.items():
                    # –û–±–Ω–æ–≤–ª—è–µ–º –¢–û–õ–¨–ö–û –∫–æ–ª–æ–Ω–∫—É adv_spend –≤ products_history
                    cursor.execute('''
                        UPDATE products_history
                        SET adv_spend = ?
                        WHERE sku = ? AND snapshot_date = ?
                    ''', (spend, sku, date))
                    if cursor.rowcount > 0:
                        updated_count += 1

            conn.commit()
            print(f"  ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: {updated_count}")

        # ‚úÖ –û—á–∏—â–∞–µ–º products –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏
        if products_data:
            cursor.execute('DELETE FROM products')
            conn.commit()
        else:
            print("  ‚ö†Ô∏è  –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–ø–∏—Å–∏ ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ products –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π")

        # ‚úÖ –ü–∏—à–µ–º –≤ –æ–±–µ —Ç–∞–±–ª–∏—Ü—ã
        for sku, data in products_data.items():
            orders_qty = orders_by_sku.get(sku, 0)
            avg_pos = avg_positions.get(sku, 0)

            # –ü–æ–∫–∞–∑—ã –∏ –º–µ—Ç—Ä–∏–∫–∏
            views = int(hits_view_search_data.get(sku, 0) or 0)
            pdp = int(hits_view_search_pdp_data.get(sku, 0) or 0)
            cart = int(hits_tocart_pdp_data.get(sku, 0) or 0)
            adv_spend = float(adv_spend_data.get(snapshot_date, {}).get(sku, 0) or 0)

            # –ü–æ—Å—Ç–∞–≤–∫–∏ FBO
            in_transit = int(in_transit_by_sku.get(sku, 0))
            in_draft = int(in_draft_by_sku.get(sku, 0))

            # CTR = (–ø–æ—Å–µ—â–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ / –ø–æ–∫–∞–∑—ã) * 100
            search_ctr = round((pdp / views * 100), 2) if views > 0 else 0.0
            
            # CR1 = (–≤ –∫–æ—Ä–∑–∏–Ω—É / –ø–æ—Å–µ—â–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏) * 100
            cr1 = round((cart / pdp * 100), 2) if pdp > 0 else 0.0
            
            # CR2 = (–∑–∞–∫–∞–∑—ã / –≤ –∫–æ—Ä–∑–∏–Ω—É) * 100
            cr2 = round((orders_qty / cart * 100), 2) if cart > 0 else 0.0

            # –¶–µ–Ω—ã –∏ –∞—Ä—Ç–∏–∫—É–ª —Ç–æ–≤–∞—Ä–∞
            price_data = prices_by_sku.get(sku, {})
            price = price_data.get("price", 0)
            marketing_price = price_data.get("marketing_price", 0)
            offer_id = price_data.get("offer_id", None)
            price_index = price_data.get("price_index", None)

            # –†–µ–π—Ç–∏–Ω–≥ –∏ –æ—Ç–∑—ã–≤—ã ‚Äî –±–µ—Ä—ë–º –∏–∑ –¥–∞–Ω–Ω—ã—Ö API (load_product_prices)
            rating = price_data.get("rating", None)
            review_count = price_data.get("review_count", None)

            # 1Ô∏è‚É£ –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –æ—Å—Ç–∞—Ç–∫–∏
            cursor.execute('''
                INSERT INTO products (sku, name, offer_id, fbo_stock, orders_qty, price, marketing_price, price_index, hits_view_search, hits_view_search_pdp, search_ctr, hits_add_to_cart, cr1, cr2, adv_spend, in_transit, in_draft, updated_at)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                ON CONFLICT(sku) DO UPDATE SET
                    name=excluded.name,
                    offer_id=COALESCE(excluded.offer_id, products.offer_id),
                    fbo_stock=excluded.fbo_stock,
                    orders_qty=excluded.orders_qty,
                    price=excluded.price,
                    marketing_price=excluded.marketing_price,
                    price_index=COALESCE(excluded.price_index, products.price_index),
                    hits_view_search=excluded.hits_view_search,
                    hits_view_search_pdp=excluded.hits_view_search_pdp,
                    search_ctr=excluded.search_ctr,
                    hits_add_to_cart=excluded.hits_add_to_cart,
                    cr1=excluded.cr1,
                    cr2=excluded.cr2,
                    adv_spend=excluded.adv_spend,
                    in_transit=excluded.in_transit,
                    in_draft=excluded.in_draft,
                    updated_at=excluded.updated_at
            ''', (
                sku,
                data.get("name", ""),
                offer_id,
                data.get("fbo_stock", 0),
                orders_qty,
                price,
                marketing_price,
                price_index,
                views,
                pdp,
                search_ctr,
                cart,
                cr1,
                cr2,
                adv_spend,
                in_transit,
                in_draft,
                get_snapshot_time()
            ))
            
            # 2Ô∏è‚É£ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é (–æ–¥–∏–Ω —Ä–∞–∑ –≤ –¥–µ–Ω—å –Ω–∞ SKU)
            cursor.execute('''
                INSERT INTO products_history (sku, name, offer_id, fbo_stock, orders_qty, rating, review_count, price, marketing_price, price_index, avg_position, hits_view_search, hits_view_search_pdp, search_ctr, hits_add_to_cart, cr1, cr2, adv_spend, in_transit, in_draft, snapshot_date, snapshot_time)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                ON CONFLICT(sku, snapshot_date) DO UPDATE SET
                    name=excluded.name,
                    offer_id=COALESCE(excluded.offer_id, products_history.offer_id),
                    fbo_stock=excluded.fbo_stock,
                    orders_qty=excluded.orders_qty,
                    rating=COALESCE(excluded.rating, products_history.rating),
                    review_count=COALESCE(excluded.review_count, products_history.review_count),
                    price=excluded.price,
                    marketing_price=excluded.marketing_price,
                    price_index=COALESCE(excluded.price_index, products_history.price_index),
                    avg_position=excluded.avg_position,
                    hits_view_search=excluded.hits_view_search,
                    hits_view_search_pdp=excluded.hits_view_search_pdp,
                    search_ctr=excluded.search_ctr,
                    hits_add_to_cart=excluded.hits_add_to_cart,
                    cr1=excluded.cr1,
                    cr2=excluded.cr2,
                    adv_spend=excluded.adv_spend,
                    in_transit=excluded.in_transit,
                    in_draft=excluded.in_draft,
                    snapshot_time=excluded.snapshot_time
            ''', (
                sku,
                data.get("name", ""),
                offer_id,
                data.get("fbo_stock", 0),
                orders_qty,
                rating,
                review_count,
                price,
                marketing_price,
                price_index,
                avg_pos,
                views,
                pdp,
                search_ctr,
                cart,
                cr1,
                cr2,
                adv_spend,
                in_transit,
                in_draft,
                snapshot_date,
                snapshot_time
            ))
        
        conn.commit()
        conn.close()
        
        print(f"\n‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
        print(f"   üì¶ –¢–æ–≤–∞—Ä–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: {len(products_data)}")
        print(f"   üìÖ –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –Ω–∞ –¥–∞—Ç—É: {snapshot_date}")
        return True
        
    except requests.exceptions.RequestException as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}")
        try:
            conn.close()
        except:
            pass
        return False
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()
        try:
            conn.close()
        except:
            pass
        return False


# ============================================================================
# FLASK –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
# ============================================================================

app = Flask(__name__)

# ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (–Ω—É–∂–Ω–æ –¥–ª—è gunicorn, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç __main__)
init_database()

HTML_TEMPLATE = '''
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ozon –¢–æ–≤–∞—Ä—ã FBO</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%237D256F'/%3E%3Cstop offset='100%25' stop-color='%23CB11AB'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='14' fill='url(%23g)'/%3E%3Ctext x='32' y='43' text-anchor='middle' font-family='Arial,Helvetica,sans-serif' font-weight='900' font-size='28' fill='white' letter-spacing='-1'%3EMS%3C/text%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        .container {
            width: 100%;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 12px 50px;
            border-radius: 0;
            margin-bottom: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }

        .header h1 {
            color: #333;
            margin: 0;
            font-size: 24px;
        }

        .header p {
            color: #666;
            font-size: 14px;
            margin: 0;
        }

        .table-container {
            background: white;
            border-radius: 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .table-header {
            background: #f8f9fa;
            padding: 8px 30px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h2 {
            color: #333;
            font-size: 18px;
        }

        .search-box input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            width: 250px;
            font-size: 14px;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            padding: 15px 30px;
            text-align: left;
            font-weight: 600;
            color: #333;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        td {
            padding: 15px 30px;
            border-bottom: 1px solid #e9ecef;
            color: #333;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        .sku {
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
        }

        .stock {
            font-weight: 600;
            color: #667eea;
            font-size: 16px;
        }

        .stock.low {
            color: #ff6b6b;
        }

        .position {
            font-weight: 600;
            color: #ff6f00;
            font-size: 14px;
            background: #fff3e0;
            padding: 3px 6px;
            border-radius: 3px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 20px 30px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .empty-state {
            text-align: center;
            padding: 60px 30px;
            color: #999;
        }

        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #e9ecef;
            margin: 0;
        }

        .tab-button {
            padding: 8px 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-button:hover {
            color: #667eea;
        }

        /* Badge –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤–æ –≤–∫–ª–∞–¥–∫–∞—Ö */
        .tab-badge {
            background: #f44336;
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            min-width: 18px;
            text-align: center;
            display: inline-block;
            animation: pulse-badge 2s infinite;
        }

        @keyframes pulse-badge {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .tab-content {
            display: none;
            padding: 20px 30px;
        }

        .tab-content.active {
            display: block;
        }

        /* –ü–æ–¥-–≤–∫–ª–∞–¥–∫–∏ –≤–Ω—É—Ç—Ä–∏ OZON */
        .sub-tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
            padding: 0;
        }

        .sub-tab-button {
            padding: 10px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #888;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .sub-tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .sub-tab-button:hover {
            color: #667eea;
        }

        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
        }

        .history-select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
            max-width: 400px;
        }

        .history-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .note-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
            transition: border-color 0.2s;
            display: none;
            min-height: 60px;
            resize: vertical;
        }

        .note-input.editing {
            display: block;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .note-display {
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 4px;
            min-height: 60px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            white-space: pre-wrap;
            font-size: 13px;
            line-height: 1.5;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            text-align: left;
        }

        .note-display:hover {
            background: #e9ecef;
        }

        .note-content {
            flex: 1;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .note-empty {
            color: #bbb;
            font-style: italic;
        }

        .edit-icon {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-left: 10px;
            flex-shrink: 0;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .edit-icon:hover {
            opacity: 1;
        }

        /* ============================================================ */
        /* –¢–ï–ì–ò –°–¢–†–û–ö (–°–∞–º–æ–≤—ã–∫—É–ø, –ú–µ–¥–∏–∞–Ω–∞, –†–µ–∫–ª–∞–º–∞, –¶–µ–Ω–∞, –ê–∫—Ü–∏–∏, –¢–µ—Å—Ç) */
        /* ============================================================ */

        .tag-cell {
            width: 120px;
            min-width: 120px;
            max-width: 120px;
            padding: 4px !important;
        }

        .tag-select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            background: #fff;
            transition: all 0.2s;
        }

        .tag-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .tag-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }

        .tag-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
        }

        .tag-badge .tag-remove {
            margin-left: 4px;
            font-size: 14px;
            line-height: 1;
            opacity: 0.7;
        }

        .tag-badge .tag-remove:hover {
            opacity: 1;
        }

        /* –¶–≤–µ—Ç–∞ —Ç–µ–≥–æ–≤ */
        .tag-samovykup { background: #ede9fe; color: #7c3aed; }
        .tag-mediana { background: #ffedd5; color: #ea580c; }
        .tag-reklama { background: #fee2e2; color: #dc2626; }
        .tag-cena { background: #dcfce7; color: #16a34a; }
        .tag-akcii { background: #fef9c3; color: #ca8a04; }
        .tag-test { background: #f3f4f6; color: #6b7280; }

        /* –û–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫ –ø–æ —Ç–µ–≥–∞–º */
        .row-samovykup td:not(.plan-cell) { background: #faf5ff !important; }
        .row-mediana td:not(.plan-cell) { background: #fff7ed !important; }
        .row-reklama td:not(.plan-cell) { background: #fef2f2 !important; }
        .row-cena td:not(.plan-cell) { background: #f0fdf4 !important; }
        .row-akcii td:not(.plan-cell) { background: #fefce8 !important; }
        .row-test td:not(.plan-cell) { background: #f9fafb !important; }

        /* –Ø—á–µ–π–∫–∏ —Å –ø–ª–∞–Ω–∞–º–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç —Å–≤–æ–∏ —Ü–≤–µ—Ç–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è */
        .plan-cell-green { background: #e5ffe5 !important; }
        .plan-cell-red { background: #ffe5e5 !important; }
        .plan-cell-neutral { background: #f5f5f5 !important; }

        .note-cell {
            width: 200px;
            min-width: 200px;
            max-width: 200px;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
            text-align: left;
        }

        .note-display {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 4px;
            min-height: 80px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            white-space: pre-wrap;
            font-size: 13px;
            line-height: 1.5;
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            transition: background 0.2s;
            border: 1px solid #e9ecef;
            text-align: left;
        }

        .note-display:hover {
            background: #e9ecef;
        }

        .note-edit-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 6px;
            opacity: 0.6;
            transition: opacity 0.2s;
            border-radius: 3px;
        }

        .note-edit-btn:hover {
            opacity: 1;
            background: rgba(102, 126, 234, 0.1);
        }

        .note-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px 12px;
            border: 2px solid #667eea;
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
            box-sizing: border-box;
        }

        .note-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .note-save-btn, .note-cancel-btn {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .note-save-btn {
            background: #667eea;
            color: white;
        }

        .note-save-btn:hover {
            background: #5568d3;
        }

        .note-cancel-btn {
            background: #e9ecef;
            color: #333;
        }

        .note-cancel-btn:hover {
            background: #dde1e6;
        }

        .note-cell {
            display: flex;
            gap: 8px;
            align-items: flex-start;
            width: 200px;
            min-width: 200px;
            max-width: 200px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            text-align: left;
        }

        .note-display {
            flex: 1;
            padding: 10px 12px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.5;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            white-space: pre-wrap;
            min-height: 60px;
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: left;
        }

        .note-display:hover {
            background: #f0f1f3;
        }

        .note-textarea {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #667eea;
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
            line-height: 1.5;
            min-height: 60px;
            resize: none;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
            overflow: hidden;
        }

        .note-textarea:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .note-edit-btn {
            padding: 6px 8px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #999;
            transition: color 0.2s;
            margin-top: 2px;
        }

        .note-edit-btn:hover {
            color: #667eea;
        }

        .note-save-btn {
            padding: 6px 8px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
            margin-top: 2px;
        }

        .note-save-btn:hover {
            background: #5568d3;
        }

        .note-cancel-btn {
            padding: 6px 8px;
            background: #ddd;
            color: #333;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 2px;
        }

        .note-cancel-btn:hover {
            background: #ccc;
        }

        .refresh-btn {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .refresh-btn:hover {
            background: rgba(102, 126, 234, 0.3);
        }

        /* ============================================================================
           –§–û–†–ú–ê –ö–û–ù–¢–ï–ô–ù–ï–†–ê –í–≠–î ‚Äî –í–ï–†–•–ù–Ø–Ø –°–¢–†–û–ö–ê (–∫—É—Ä—Å, %, –¥–∞—Ç–∞, –ø–æ—Å—Ç–∞–≤—â–∏–∫)
           ============================================================================ */
        .ved-form-top-row {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .ved-form-field-rate {
            flex: 0 0 140px;
        }

        .ved-form-field-percent {
            flex: 0 0 120px;
        }

        .ved-form-field-date {
            flex: 0 0 160px;
        }

        .ved-form-field-supplier {
            flex: 1 1 220px;
            min-width: 180px;
        }

        .ved-form-field-rate label,
        .ved-form-field-percent label,
        .ved-form-field-date label,
        .ved-form-field-supplier label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 13px;
            color: #555;
        }

        /* –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏ –í–∞–∂–Ω–æ ‚Äî –≤—ã—Ä–æ–≤–Ω–µ–Ω—ã –ø–æ–¥ –î–∞—Ç–∞/–ü–æ—Å—Ç–∞–≤—â–∏–∫ */
        .ved-form-bottom-fields {
            margin-left: calc(140px + 12px + 120px + 12px);
            margin-top: 12px;
        }

        /* ============================================================================
           –§–û–†–ú–ê –ö–û–ù–¢–ï–ô–ù–ï–†–ê –í–≠–î ‚Äî –°–ï–ö–¶–ò–Ø –§–ê–ô–õ–û–í
           ============================================================================ */
        .container-files-section {
            margin-top: 20px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .container-files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* ============================================================================
           –§–û–†–ú–ê –ö–û–ù–¢–ï–ô–ù–ï–†–ê –í–≠–î ‚Äî –°–ï–ö–¶–ò–Ø –°–û–û–ë–©–ï–ù–ò–ô
           ============================================================================ */
        .container-messages-section {
            margin-top: 20px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .container-message-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .container-msg-layout {
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }

        .container-msg-recipients {
            flex: 0 0 auto;
            min-width: 160px;
        }

        .container-msg-input {
            flex: 1;
            min-width: 0;
        }

        .container-msg-textarea {
            width: 100%;
            min-height: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
            font-size: 14px;
        }

        .container-msg-send {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
        }

        .container-msg-send-btn {
            padding: 8px 20px;
        }

        /* ============================================================================
           –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø ‚Äî –ü–õ–ê–ù–®–ï–¢–´ (–¥–æ 1024px)
           ============================================================================ */
        @media (max-width: 1024px) {
            .header {
                padding: 10px 20px;
            }

            .tab-content {
                padding: 16px 20px;
            }

            .table-header {
                padding: 8px 16px;
            }

            .tab-button {
                padding: 8px 16px;
                font-size: 14px;
            }
        }

        /* ============================================================================
           –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø ‚Äî –¢–ï–õ–ï–§–û–ù–´ (–¥–æ 768px)
           ============================================================================ */
        @media (max-width: 768px) {
            /* --- –•–µ–¥–µ—Ä --- */
            .header {
                padding: 8px 12px;
            }

            .header > div {
                flex-wrap: wrap;
                gap: 8px;
            }

            .refresh-btn {
                padding: 6px 12px;
                font-size: 13px;
            }

            .user-panel {
                margin-left: 0;
                gap: 8px;
            }

            .user-info {
                font-size: 13px;
            }

            .user-info .role-badge {
                font-size: 10px;
                padding: 2px 6px;
            }

            .logout-btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            /* --- –í–∫–ª–∞–¥–∫–∏: –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª --- */
            .tabs {
                overflow-x: auto;
                overflow-y: hidden;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
                white-space: nowrap;
                flex-wrap: nowrap;
            }

            .tabs::-webkit-scrollbar {
                display: none;
            }

            .tab-button {
                padding: 8px 14px;
                font-size: 13px;
                flex-shrink: 0;
                white-space: nowrap;
            }

            /* --- –ü–æ–¥–≤–∫–ª–∞–¥–∫–∏ --- */
            .sub-tabs,
            .ved-subtabs,
            .warehouse-subtabs,
            .finance-subtabs {
                overflow-x: auto;
                overflow-y: hidden;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
                flex-wrap: nowrap;
                padding: 0 12px;
            }

            .sub-tabs::-webkit-scrollbar,
            .ved-subtabs::-webkit-scrollbar,
            .warehouse-subtabs::-webkit-scrollbar,
            .finance-subtabs::-webkit-scrollbar {
                display: none;
            }

            .sub-tab-button,
            .ved-subtab-button,
            .subtab-button,
            .finance-subtab-btn {
                padding: 10px 14px;
                font-size: 13px;
                flex-shrink: 0;
                white-space: nowrap;
            }

            /* --- –ü–µ–Ω–¥–µ–ª—å –º–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è --- */
            .pendel-filters { padding: 12px; gap: 8px; }
            .pendel-filters input[type="date"] { flex: 1; min-width: 120px; }
            .pendel-summary-cards { gap: 10px; }
            .pendel-summary-card { min-width: 120px; padding: 12px 14px; }
            .pendel-summary-card .value { font-size: 18px; }
            .pendel-category-row td { padding: 10px 12px; font-size: 13px; }
            .pendel-accordion-content { padding: 10px 12px; }
            .pendel-accordion-table { font-size: 12px; }
            .pendel-accordion-table thead th,
            .pendel-accordion-table tbody td { padding: 8px 8px; }

            /* --- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ --- */
            .tab-content {
                padding: 12px;
            }

            .ved-subtab-content,
            .warehouse-subtab-content {
                padding: 12px;
            }

            /* --- –•–µ–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ã, —Ñ–∏–ª—å—Ç—Ä—ã --- */
            .table-header {
                flex-direction: column;
                gap: 10px;
                padding: 8px 12px;
            }

            .search-box input {
                width: 100%;
            }

            /* --- –§–∏–ª—å—Ç—Ä—ã –ø–æ –¥–∞—Ç–µ --- */
            .date-filters-inline {
                flex-wrap: wrap;
                gap: 6px;
                width: 100%;
            }

            .date-filter-input {
                padding: 6px 8px;
                font-size: 13px;
                min-width: 0;
                flex: 1;
            }

            .date-filter-reset {
                padding: 6px 10px;
                font-size: 13px;
            }

            /* --- –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–∏–æ–¥–æ–≤ --- */
            .table-controls {
                gap: 4px;
                padding: 8px 0;
            }

            .period-btn {
                padding: 5px 8px;
                font-size: 12px;
            }

            .toggle-col-btn {
                padding: 5px 8px;
                font-size: 11px;
            }

            /* --- –¢–∞–±–ª–∏—Ü—ã: –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª --- */
            .table-wrapper,
            .wh-table-wrapper,
            .supplies-table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px 6px;
                font-size: 12px;
            }

            /* --- FBO –∞–∫–∫–æ—Ä–¥–µ–æ–Ω --- */
            .fbo-header th {
                padding: 8px 6px;
                font-size: 12px;
            }

            .fbo-row td {
                padding: 8px 6px;
                font-size: 13px;
            }

            .cluster-row td {
                padding: 6px 6px 6px 24px;
                font-size: 12px;
            }

            .cluster-row td:first-child {
                padding-left: 24px;
            }

            /* --- –°–∫–ª–∞–¥ —Ç–∞–±–ª–∏—Ü–∞ --- */
            .wh-table thead th {
                padding: 8px 6px;
                font-size: 12px;
            }

            .wh-table tbody td {
                padding: 8px 6px;
                font-size: 13px;
            }

            .wh-table tfoot td {
                padding: 8px 6px;
            }

            /* --- –§–æ—Ä–º–∞ –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏—è --- */
            .receipt-form {
                padding: 12px;
                border-radius: 8px;
            }

            .receipt-form-row {
                flex-direction: column;
                gap: 10px;
            }

            .receipt-form-field {
                flex: 1 1 100% !important;
            }

            .receipt-form-actions {
                flex-wrap: wrap;
            }

            .wh-save-receipt-btn {
                padding: 12px 20px;
                font-size: 14px;
                width: 100%;
                justify-content: center;
            }

            .wh-clear-btn {
                padding: 12px 16px;
                font-size: 13px;
                width: 100%;
                text-align: center;
            }

            .wh-add-btn {
                padding: 8px 14px;
                font-size: 13px;
            }

            .wh-toolbar {
                flex-wrap: wrap;
                gap: 8px;
            }

            /* --- –ü–æ—Å—Ç–∞–≤–∫–∏ —Ç–∞–±–ª–∏—Ü–∞ --- */
            .supplies-table {
                font-size: 12px;
            }

            .supplies-table thead th {
                padding: 6px 4px;
                font-size: 11px;
            }

            .supplies-table tbody td {
                padding: 4px;
            }

            .supply-input {
                font-size: 12px;
                padding: 3px 4px;
            }

            .supply-select {
                font-size: 12px;
                min-width: 120px;
                padding: 3px 4px;
            }

            .supplies-filter-bar {
                flex-wrap: wrap;
                gap: 6px;
            }

            /* --- –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç --- */
            .currency-rates-panel {
                padding: 12px;
            }

            .currency-rates-row {
                flex-wrap: wrap;
                gap: 8px;
            }

            .currency-rate-card {
                flex: 1 1 calc(50% - 4px);
                min-width: 0;
                width: auto;
            }

            /* --- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ --- */
            .modal-box {
                width: calc(100% - 32px);
                max-width: 400px;
                padding: 20px;
            }

            .login-box {
                width: calc(100% - 32px);
                max-width: 360px;
                padding: 24px;
            }

            .login-box h2 {
                font-size: 20px;
            }

            .login-box input {
                padding: 12px;
                font-size: 14px;
            }

            .login-box button {
                padding: 12px;
                font-size: 15px;
            }

            .supply-edit-confirm-box {
                max-width: calc(100% - 32px);
                padding: 20px;
            }

            .reply-modal-content {
                width: calc(100% - 24px);
                padding: 16px;
            }

            /* --- –§–∏–Ω–∞–Ω—Å—ã (–º–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è) --- */
            .finance-summary {
                flex-direction: column;
                gap: 10px;
            }
            .finance-summary-card {
                min-width: auto;
                padding: 14px 16px;
            }
            .finance-summary-card .value {
                font-size: 20px;
            }
            .finance-filters {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
                padding: 12px 14px;
            }
            .finance-filters select,
            .finance-filters input[type="date"] {
                width: 100%;
            }
            .finance-filter-sep {
                display: none;
            }
            .finance-form-row {
                flex-direction: column;
                gap: 12px;
            }
            .finance-form-field {
                min-width: auto;
                width: 100%;
            }
            /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã–µ –±–ª–æ–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è */
            #finance-container-section { padding: 12px; }
            .finance-container-block-header {
                flex-direction: column;
                gap: 8px;
            }
            .finance-container-block-header select {
                max-width: 100%;
                width: 100%;
            }
            .finance-dist-table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .finance-dist-table input[type="number"] {
                width: 65px;
                font-size: 12px;
            }
            .finance-dist-accordion-content { padding: 10px 12px; }
            .finance-dist-accordion-table { font-size: 12px; }
            .finance-dist-accordion-table thead th,
            .finance-dist-accordion-table tbody td { padding: 8px 8px; }

            /* --- –°–æ–æ–±—â–µ–Ω–∏—è --- */
            .messages-tab {
                padding: 12px;
            }

            .messages-header {
                gap: 10px;
            }

            .messages-header h3 {
                font-size: 17px;
            }

            .messages-filters {
                width: 100%;
                flex-wrap: wrap;
                gap: 10px;
            }

            .message-card {
                padding: 12px;
            }

            .message-card-header {
                flex-direction: column;
                gap: 4px;
            }

            .message-card-actions {
                flex-wrap: wrap;
            }

            /* --- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: –∫–∞—Ä—Ç–æ—á–Ω—ã–π layout --- */
            .users-tab {
                padding: 12px;
            }

            .users-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .users-header h3 {
                font-size: 17px;
            }

            .add-user-btn {
                width: 100%;
                text-align: center;
                padding: 12px 20px;
                font-size: 15px;
            }

            /* –°–∫—Ä—ã—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã */
            .users-table thead {
                display: none;
            }

            .users-table {
                border-collapse: separate;
                border-spacing: 0 10px;
            }

            /* –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ = –∫–∞—Ä—Ç–æ—á–∫–∞ */
            .users-table tbody tr {
                display: block;
                background: white;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.07);
                padding: 14px 16px;
                margin-bottom: 10px;
                border: 1px solid #e9ecef;
            }

            /* –°–∫—Ä—ã—Ç—å –∫–æ–ª–æ–Ω–∫—É ID –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .users-table tbody td[data-label="ID"] {
                display: none;
            }

            /* –ö–∞–∂–¥–∞—è —è—á–µ–π–∫–∞ = —Å—Ç—Ä–æ–∫–∞ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ */
            .users-table tbody td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 6px 0;
                border-bottom: 1px solid #f0f0f0;
                font-size: 14px;
                text-align: right;
            }

            .users-table tbody td:last-child {
                border-bottom: none;
                padding-top: 10px;
            }

            /* –ü–æ–¥–ø–∏—Å–∏ —Å–ª–µ–≤–∞ —á–µ—Ä–µ–∑ data-label */
            .users-table tbody td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #555;
                font-size: 13px;
                text-align: left;
                flex-shrink: 0;
                margin-right: 12px;
            }

            /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π ‚Äî –∫—Ä—É–ø–Ω—ã–µ, touch-friendly */
            .users-table tbody td.actions {
                display: flex;
                flex-wrap: wrap;
                justify-content: flex-start;
                gap: 8px;
                padding-top: 10px;
            }

            .users-table tbody td.actions::before {
                display: none;
            }

            .users-table .action-btn {
                padding: 8px 14px;
                font-size: 14px;
                min-height: 40px;
                min-width: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 8px;
                background: #f0f4ff;
            }

            .users-table .change-pwd-btn {
                background: #e3f2fd;
            }

            .users-table .delete-btn {
                background: #ffebee;
            }

            /* --- –ß–∞—Ç –≤ –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–∏ --- */
            .receipt-chat-section {
                margin: 12px -12px -12px -12px;
                padding: 12px;
            }

            .receipt-chat-input {
                flex-direction: column;
                align-items: stretch;
            }

            .receipt-chat-input input[type="text"] {
                min-width: 0;
                width: 100%;
            }

            /* --- –ê–∫–∫–æ—Ä–¥–µ–æ–Ω —Å–∫–ª–∞–¥–∞ --- */
            .wh-accordion-content {
                padding: 10px;
            }

            .wh-accordion-table thead th {
                padding: 6px 4px;
                font-size: 11px;
            }

            .wh-accordion-table tbody td {
                padding: 6px 4px;
                font-size: 12px;
            }

            .wh-accordion-table tfoot td {
                padding: 6px 4px;
                font-size: 12px;
            }

            /* --- –ê–∫–∫–æ—Ä–¥–µ–æ–Ω —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –ø—Ä–∏—Ö–æ–¥–æ–≤ (–º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è) --- */
            .wh-receipt-accordion-content {
                padding: 8px 10px;
            }

            .wh-dist-product-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
                font-size: 12px;
            }

            .wh-receipt-accordion .wh-accordion-table {
                font-size: 11px;
            }

            .wh-receipt-accordion .wh-accordion-table thead th,
            .wh-receipt-accordion .wh-accordion-table tbody td {
                padding: 4px 6px;
            }

            /* --- –î—Ä–æ–ø–¥–∞—É–Ω –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π --- */
            .destination-dropdown-wrapper {
                flex-direction: row;
                align-items: center;
            }

            .destination-dropdown {
                right: 0;
            }

            /* --- –§–æ—Ä–º–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –í–≠–î --- */
            .ved-form-top-row {
                flex-direction: column;
                gap: 10px;
            }

            .ved-form-field-rate,
            .ved-form-field-percent,
            .ved-form-field-date,
            .ved-form-field-supplier {
                flex: 1 1 100%;
                min-width: 0;
            }

            /* –ö—É—Ä—Å –∏ –ø—Ä–æ—Ü–µ–Ω—Ç ‚Äî –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –Ω–∞ –º–æ–±–∏–ª–∫–µ */
            .ved-form-top-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .ved-form-bottom-fields {
                margin-left: 0;
            }

            .ved-form-field-date {
                grid-column: 1 / 2;
            }

            .ved-form-field-supplier {
                grid-column: 1 / -1;
            }

            /* --- –°–µ–∫—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ --- */
            .container-files-section {
                padding: 12px;
                margin-top: 12px;
            }

            .container-files-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            /* --- –°–µ–∫—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ --- */
            .container-messages-section {
                padding: 12px;
                margin-top: 12px;
            }

            .container-msg-layout {
                flex-direction: column;
                gap: 12px;
            }

            .container-msg-recipients {
                min-width: 0;
                width: 100%;
            }

            .container-msg-recipients > div {
                flex-direction: row !important;
                flex-wrap: wrap;
                gap: 8px !important;
            }

            .container-msg-input {
                width: 100%;
            }

            .container-msg-textarea {
                min-height: 60px;
            }

            .container-msg-send {
                justify-content: stretch;
            }

            .container-msg-send-btn {
                width: 100%;
                text-align: center;
                justify-content: center;
                padding: 10px 16px;
                font-size: 14px;
            }

            /* --- –ü—É—Å—Ç—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è --- */
            .empty-state {
                padding: 30px 16px;
            }

            .wh-empty-state {
                padding: 30px 16px;
            }

            /* --- –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ --- */
            .history-select {
                max-width: 100%;
            }

            /* --- –°–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è —Ç–∞–±–ª–∏—Ü: —Ç–æ–Ω–∫–∏–π –≤–∏–¥–∏–º—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞ –º–æ–±–∏–ª–∫–µ --- */
            .table-wrapper::-webkit-scrollbar,
            .wh-table-wrapper::-webkit-scrollbar,
            .supplies-table-wrapper::-webkit-scrollbar {
                height: 4px;
            }

            .table-wrapper::-webkit-scrollbar-thumb,
            .wh-table-wrapper::-webkit-scrollbar-thumb,
            .supplies-table-wrapper::-webkit-scrollbar-thumb {
                background: rgba(0,0,0,0.2);
                border-radius: 4px;
            }
        }

        /* ============================================================================
           –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø ‚Äî –ú–ê–õ–ï–ù–¨–ö–ò–ï –¢–ï–õ–ï–§–û–ù–´ (–¥–æ 480px)
           ============================================================================ */
        @media (max-width: 480px) {
            .header {
                padding: 6px 8px;
            }

            .header > div {
                gap: 6px;
            }

            .refresh-btn {
                padding: 5px 10px;
                font-size: 12px;
            }

            .user-info .username {
                font-size: 12px;
            }

            .user-info .role-badge {
                font-size: 9px;
                padding: 1px 5px;
            }

            .logout-btn {
                padding: 5px 8px;
                font-size: 11px;
            }

            .tab-button {
                padding: 7px 10px;
                font-size: 12px;
            }

            .sub-tab-button,
            .ved-subtab-button,
            .subtab-button {
                padding: 8px 10px;
                font-size: 12px;
            }

            .tab-content {
                padding: 8px;
            }

            .ved-subtab-content,
            .warehouse-subtab-content {
                padding: 8px;
            }

            th, td {
                padding: 6px 4px;
                font-size: 11px;
            }

            .period-btn {
                padding: 4px 6px;
                font-size: 11px;
            }

            .modal-box {
                width: calc(100% - 16px);
                padding: 16px;
            }

            .login-box {
                width: calc(100% - 16px);
                padding: 20px;
            }

            .receipt-form {
                padding: 8px;
            }

            .receipt-form-actions {
                flex-direction: column;
            }

            .currency-rate-card {
                flex: 1 1 100%;
            }

            .message-card {
                padding: 10px;
            }

            .message-btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            .wh-add-btn {
                width: 100%;
                text-align: center;
                justify-content: center;
            }

            .add-user-btn {
                width: 100%;
                text-align: center;
            }

            /* --- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: –º–µ–ª–∫–∏–µ —ç–∫—Ä–∞–Ω—ã --- */
            .users-tab {
                padding: 8px;
            }

            .users-table tbody tr {
                padding: 12px;
            }

            .users-table tbody td {
                font-size: 13px;
            }

            .users-table tbody td::before {
                font-size: 12px;
            }

            .users-table .action-btn {
                padding: 7px 12px;
                font-size: 13px;
            }

            /* --- –§–æ—Ä–º–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: –≤—Å–µ –ø–æ–ª—è –≤ –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É --- */
            .ved-form-top-row {
                grid-template-columns: 1fr;
            }

            .ved-form-field-date,
            .ved-form-field-supplier {
                grid-column: 1;
            }

            .container-files-section,
            .container-messages-section {
                padding: 8px;
                margin-top: 8px;
            }

            /* –î–∞—Ç–∞-–ø–∏–∫–µ—Ä ‚Äî –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –±–µ–∑ –ø–µ—Ä–µ–Ω–æ—Å–∞ */
            .date-filters-inline {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .date-filter-input {
                flex: 0 0 auto;
                width: auto;
                min-width: 110px;
            }

            .date-separator {
                flex: 0 0 auto;
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Å–æ —Å–∫—Ä–æ–ª–ª–æ–º */
        #history-content {
            position: relative;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ –¥–∞—Ç–µ (–≤ —Ö–µ–¥–µ—Ä–µ) */
        .date-filters-inline {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .date-filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: #fff;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .date-filter-input:hover {
            border-color: #0066ff;
        }

        .date-filter-input:focus {
            outline: none;
            border-color: #0066ff;
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
        }

        .date-separator {
            color: #999;
            font-size: 16px;
            padding: 0 4px;
        }

        /* –ê–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–≥-—Ñ–∏–ª—å—Ç—Ä –≤ –ª–µ–≥–µ–Ω–¥–µ */
        .tag-badge.active-filter {
            box-shadow: 0 0 0 2px #333;
            transform: scale(1.05);
        }

        .tag-badge-filter {
            cursor: pointer;
            transition: all 0.2s;
        }

        .tag-badge-filter:hover {
            transform: scale(1.05);
            box-shadow: 0 0 0 2px rgba(0,0,0,0.2);
        }

        .date-filter-reset {
            padding: 8px 16px;
            margin-left: 4px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }

        .date-filter-reset:hover {
            background: #f5f5f5;
            border-color: #ccc;
            color: #333;
        }

        .date-filter-reset.active {
            color: #000;
            border-color: #333;
            font-weight: 500;
        }

        .table-controls {
            margin-bottom: 12px;
            padding: 16px 0;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .toggle-col-btn {
            padding: 6px 12px;
            font-size: 12px;
            background: #f0f2f5;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-col-btn:hover {
            background: #e4e6eb;
        }

        .toggle-col-btn.hidden {
            opacity: 0.6;
            background: #fff3cd;
        }

        /* –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞ */
        .period-btn {
            padding: 6px 12px;
            font-size: 13px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .period-btn:hover {
            background: #e4e6eb;
            border-color: #bbb;
        }

        .period-btn.active {
            background: #0066cc;
            color: white;
            border-color: #0066cc;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            min-width: 1200px;
            user-select: none;
        }

        th {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            border-bottom: 2px solid #ddd;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 30px;
            max-width: 300px;
            text-align: center;
            padding: 10px 8px;
        }

        th.resizable {
            position: relative;
            cursor: col-resize;
        }

        .resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: transparent;
            cursor: col-resize;
            user-select: none;
        }

        .resize-handle:hover {
            background: #667eea;
        }

        td {
            border-bottom: 1px solid #eee;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 30px;
            max-width: 300px;
            text-align: center;
            padding: 10px 8px;
        }

        td.col-hidden {
            display: none;
        }

        th.col-hidden {
            display: none;
        }

        /* ============================================================ */
        /* –ê–ù–ê–õ–ò–¢–ò–ö–ê FBO ‚Äî –ê–ö–ö–û–†–î–ï–û–ù                                    */
        /* ============================================================ */

        .fbo-table {
            width: 100%;
            border-collapse: collapse;
        }

        .fbo-header {
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }

        .fbo-header th {
            padding: 12px 10px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #555;
            white-space: nowrap;
        }

        .fbo-row {
            cursor: pointer;
            transition: background 0.15s;
            border-bottom: 1px solid #eee;
        }

        .fbo-row:hover {
            background: #f0f4ff;
        }

        .fbo-row td {
            padding: 12px 10px;
            font-size: 14px;
            white-space: nowrap;
        }

        .fbo-row .fbo-arrow {
            display: inline-block;
            transition: transform 0.2s;
            margin-right: 6px;
            font-size: 12px;
            color: #999;
        }

        .fbo-row.expanded .fbo-arrow {
            transform: rotate(90deg);
        }

        .fbo-clusters {
            display: none;
        }

        .fbo-clusters.visible {
            display: table-row-group;
        }

        .cluster-row td {
            padding: 8px 10px 8px 38px;
            font-size: 13px;
            color: #555;
            background: #fafbfc;
            border-bottom: 1px solid #f0f0f0;
        }

        .cluster-row td:first-child {
            padding-left: 38px;
        }

        /* –ë–µ–π–¥–∂–∏ —Å—Ç–∞—Ç—É—Å–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ */
        .liq-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .liq-DEFICIT { background: #fee2e2; color: #dc2626; }
        .liq-NO_SALES { background: #f3f4f6; color: #6b7280; }
        .liq-ACTUAL { background: #dbeafe; color: #2563eb; }
        .liq-POPULAR { background: #dcfce7; color: #16a34a; }
        .liq-SURPLUS { background: #fef9c3; color: #ca8a04; }

        .fbo-loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .warehouse-loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .fbo-stock-val {
            font-weight: 600;
        }

        .fbo-stock-zero {
            color: #ccc;
        }

        /* ============================================================ */
        /* –ê–ö–ö–û–†–î–ï–û–ù –î–õ–Ø –û–°–¢–ê–¢–ö–û–í –°–ö–õ–ê–î–ê                                */
        /* ============================================================ */

        .wh-stock-row {
            cursor: pointer;
            transition: background 0.15s;
        }

        .wh-stock-row:hover {
            background: #f0f4ff;
        }

        .wh-stock-row .wh-stock-arrow {
            display: inline-block;
            transition: transform 0.2s;
            margin-right: 6px;
            font-size: 12px;
            color: #999;
        }

        .wh-stock-row.expanded {
            background: #e8f0fe;
        }

        .wh-stock-row.expanded .wh-stock-arrow {
            transform: rotate(90deg);
        }

        .wh-stock-accordion {
            display: none;
        }

        .wh-stock-accordion.visible {
            display: table-row;
        }

        .wh-accordion-cell {
            padding: 0 !important;
            background: #fafbfc;
            border-bottom: 2px solid #667eea;
        }

        .wh-accordion-content {
            padding: 10px 14px;
        }

        .wh-accordion-header {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wh-accordion-header .avg-cost {
            font-size: 13px;
            color: #667eea;
            font-weight: 600;
        }

        .wh-accordion-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .wh-accordion-table thead th {
            background: #667eea;
            color: #fff;
            padding: 10px 8px;
            font-weight: 500;
            text-align: center;
            font-size: 12px;
        }

        .wh-accordion-table tbody td {
            padding: 8px;
            border: 1px solid #e9ecef;
            text-align: center;
        }

        .wh-accordion-table tbody tr:hover {
            background: #f8f9fa;
        }

        .wh-accordion-table tfoot td {
            padding: 10px 8px;
            background: #f1f3f5;
            font-weight: 600;
            border: 1px solid #e9ecef;
            text-align: center;
        }

        .wh-accordion-loading {
            text-align: center;
            padding: 20px;
            color: #888;
            font-size: 13px;
        }

        .wh-accordion-empty {
            text-align: center;
            padding: 20px;
            color: #999;
            font-size: 13px;
            font-style: italic;
        }

        .wh-accordion-more-btn {
            display: block;
            margin: 12px auto 0;
            padding: 8px 20px;
            background: #667eea;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .wh-accordion-more-btn:hover {
            background: #5a6fd6;
        }

        .wh-accordion-more-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* ============================================================ */
        /* –ê–ö–ö–û–†–î–ï–û–ù –î–õ–Ø –ò–°–¢–û–†–ò–ò –ü–†–ò–•–û–î–û–í (–†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –ü–û –ü–û–°–¢–ê–í–ö–ê–ú) */
        /* ============================================================ */

        .wh-receipt-row {
            cursor: pointer;
            transition: background 0.15s;
        }

        .wh-receipt-row:hover {
            background: #f0f4ff;
        }

        .wh-receipt-row .wh-receipt-arrow {
            display: inline-block;
            transition: transform 0.2s;
            margin-right: 6px;
            font-size: 12px;
            color: #999;
        }

        .wh-receipt-row.expanded {
            background: #e8f0fe;
        }

        .wh-receipt-row.expanded .wh-receipt-arrow {
            transform: rotate(90deg);
        }

        /* –ë–ª–µ–¥–Ω–æ-–∫—Ä–∞—Å–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –¥–ª—è —Å—Ç—Ä–æ–∫ —Å –Ω–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏ */
        .wh-receipt-row.has-undistributed {
            background: #fff5f5;
        }

        .wh-receipt-row.has-undistributed:hover {
            background: #fee2e2;
        }

        .wh-receipt-row.has-undistributed.expanded {
            background: #fecaca;
        }

        .wh-receipt-accordion {
            display: none;
        }

        .wh-receipt-accordion.visible {
            display: table-row;
        }

        .wh-receipt-accordion-cell {
            padding: 0 !important;
            background: #fafbfc;
            border-bottom: 2px solid #667eea;
        }

        .wh-receipt-accordion-content {
            padding: 16px 20px;
        }

        /* –ë–ª–æ–∫ –æ–¥–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π */
        .wh-dist-product-block {
            margin-bottom: 16px;
        }

        .wh-dist-product-block:last-child {
            margin-bottom: 0;
        }

        .wh-dist-product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }

        /* –ë–µ–π–¥–∂ ¬´–ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ¬ª (–∑–µ–ª—ë–Ω—ã–π) */
        .wh-dist-badge-full {
            background: #dcfce7;
            color: #16a34a;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        /* –ë–µ–π–¥–∂ ¬´—á–∞—Å—Ç–∏—á–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ¬ª (–∫—Ä–∞—Å–Ω—ã–π) */
        .wh-dist-badge-partial {
            background: #fee2e2;
            color: #dc2626;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        /* ============================================================ */
        /* –í–ö–õ–ê–î–ö–ê –ü–û–°–¢–ê–í–ö–ò                                             */
        /* ============================================================ */

        .currency-rates-panel {
            background: #f8f9fb;
            border-radius: 12px;
            padding: 16px 24px;
            margin-bottom: 20px;
        }

        .currency-rates-title {
            font-size: 13px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .currency-rates-row {
            display: flex;
            gap: 10px;
        }

        .currency-rate-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 8px 10px;
            width: 150px;
            flex: 0 0 150px;
        }

        /* –ü–æ—Å—Ç–∞–≤–∫–∏: –≤—Å–µ 9 –∫–∞—Ä—Ç–æ—á–µ–∫ —Å–≤–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –æ–¥–Ω—É –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é –ª–∏–Ω–∏—é */
        .supplies-stats-row .currency-rate-card {
            flex: 1 1 0;
            width: auto;
            min-width: 90px;
            padding: 6px 8px;
        }

        .supplies-stats-row .currency-value {
            font-size: 14px;
        }

        .supplies-stats-row .currency-label {
            font-size: 10px;
            min-height: 22px;
            margin-bottom: 2px;
        }

        .currency-label {
            font-size: 11px;
            color: #555;
            font-weight: 500;
            line-height: 1.2;
            display: block;
            margin-bottom: 4px;
            min-height: 26px;
        }

        .currency-value {
            font-size: 16px;
            font-weight: 700;
            color: #333;
        }

        .currency-rub {
            font-size: 12px;
            color: #999;
            margin-left: 3px;
        }

        /* ============================================================================
           –°–¢–ò–õ–ò –í–ö–õ–ê–î–ö–ò –í–≠–î (–ø–æ–¥–≤–∫–ª–∞–¥–∫–∏)
           ============================================================================ */

        .ved-subtabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #e9ecef;
            padding: 0 20px;
            background: #f8f9fa;
        }

        .ved-subtab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .ved-subtab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #fff;
        }

        .ved-subtab-button:hover:not(.active) {
            color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .ved-subtab-content {
            display: none;
            padding: 20px;
        }

        .ved-subtab-content.active {
            display: block;
        }

        .supplies-table-wrapper {
            position: relative;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .supplies-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .supplies-table thead th {
            background: #f1f3f5;
            padding: 10px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            color: #444;
            border: 1px solid #dee2e6;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 2;
        }

        .supplies-table tbody td {
            padding: 6px 8px;
            border: 1px solid #dee2e6;
            text-align: center;
            vertical-align: middle;
        }

        .supplies-table tbody tr:hover {
            background: #f8f9fa;
        }

        .supply-input {
            width: 100%;
            border: 1px solid transparent;
            background: transparent;
            padding: 4px 6px;
            font-size: 13px;
            text-align: center;
            border-radius: 4px;
            outline: none;
            transition: border-color 0.2s;
        }

        .supply-input:hover:not([disabled]) {
            border-color: #dee2e6;
        }

        .supply-input:focus:not([disabled]) {
            border-color: #667eea;
            background: #fff;
        }

        .supply-input[disabled] {
            color: #666;
            cursor: not-allowed;
        }

        .supply-select {
            width: 100%;
            min-width: 180px;
            border: 1px solid transparent;
            background: transparent;
            padding: 4px 6px;
            font-size: 13px;
            border-radius: 4px;
            outline: none;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .supply-select:hover:not([disabled]) {
            border-color: #dee2e6;
        }

        .supply-select:focus:not([disabled]) {
            border-color: #667eea;
            background: #fff;
        }

        .supply-select[disabled] {
            color: #666;
            cursor: not-allowed;
        }

        .supply-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .supply-checkbox[disabled] {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .supply-cost-auto {
            font-weight: 600;
            color: #333;
            background: #f0f7ff;
            padding: 4px 6px;
            border-radius: 4px;
        }

        .supplies-add-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            border: 2px dashed #dee2e6;
            background: transparent;
            color: #667eea;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .supplies-add-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
        .supplies-filter-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .sortable-date {
            cursor: pointer;
            user-select: none;
        }

        .sortable-date:hover {
            background: #e2e6ea;
        }

        .sort-arrow {
            font-size: 10px;
            color: #999;
        }

        .supply-cell-empty {
            background: #fff5f5 !important;
        }

        /* –°–∫—Ä—ã–≤–∞–µ–º –≥–æ–¥ –≤ date-input */
        .supply-date-input {
            font-family: inherit;
        }
        .supply-date-input::-webkit-datetime-edit-year-field {
            display: none;
        }
        .supply-date-input::-webkit-datetime-edit-text:first-of-type {
            /* –£–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å (—Ç–æ—á–∫–∞/—Ç–∏—Ä–µ –ø–µ—Ä–µ–¥ –≥–æ–¥–æ–º –∏–ª–∏ –ø–æ—Å–ª–µ) */
        }

        .supply-delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            padding: 4px;
            color: #ccc;
            transition: color 0.2s;
        }

        .supply-delete-btn:hover {
            color: #ef4444;
        }

        .supplies-totals-row td {
            padding: 8px;
            font-weight: 700;
            font-size: 13px;
            background: #f1f3f5;
            border: 1px solid #dee2e6;
            text-align: center;
            color: #333;
        }

        .supplies-totals-row td {
            position: sticky;
            top: 36px;
            z-index: 2;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏) */
        .supply-edit-confirm {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .supply-edit-confirm-box {
            background: #fff;
            border-radius: 12px;
            padding: 24px 32px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            max-width: 400px;
            text-align: center;
        }

        .supply-edit-confirm-box h3 {
            margin-bottom: 12px;
            color: #333;
        }

        .supply-edit-confirm-box p {
            margin-bottom: 20px;
            color: #666;
            font-size: 14px;
        }

        .supply-edit-confirm-box button {
            padding: 8px 24px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin: 0 6px;
        }

        .supply-confirm-yes {
            background: #667eea;
            color: #fff;
        }

        .supply-confirm-no {
            background: #f1f3f5;
            color: #333;
        }

        /* ============================================================================
           –°–¢–ò–õ–ò –í–ö–õ–ê–î–ö–ò –°–ö–õ–ê–î (–ø–æ–¥–≤–∫–ª–∞–¥–∫–∏)
           ============================================================================ */

        .warehouse-subtabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #e9ecef;
            padding: 0 20px;
            background: #f8f9fa;
        }

        .subtab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .subtab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #fff;
        }

        .subtab-button:hover:not(.active) {
            color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .warehouse-subtab-content {
            display: none;
            padding: 20px;
        }

        .warehouse-subtab-content.active {
            display: block;
        }

        /* ============================================================================
           –°–¢–ò–õ–ò –ü–û–î–í–ö–õ–ê–î–û–ö –§–ò–ù–ê–ù–°–´
           ============================================================================ */
        .finance-subtabs { display: flex; gap: 0; border-bottom: 2px solid #e9ecef; padding: 0 20px; background: #f8f9fa; }
        .finance-subtab-btn { padding: 12px 24px; background: none; border: none; cursor: pointer; font-size: 14px; font-weight: 500; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; margin-bottom: -2px; }
        .finance-subtab-btn.active { color: #667eea; border-bottom-color: #667eea; background: #fff; }
        .finance-subtab-btn:hover:not(.active) { color: #667eea; background: rgba(102, 126, 234, 0.05); }
        .finance-subtab-content { display: none; padding: 20px; }
        .finance-subtab-content.active { display: block; }
        /* --- –ü–µ–Ω–¥–µ–ª—å: —Ñ–∏–ª—å—Ç—Ä—ã --- */
        .pendel-filters { display: flex; align-items: center; gap: 12px; padding: 16px 20px; background: #f8f9fa; border-radius: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .pendel-filters label { font-size: 13px; font-weight: 500; color: #555; }
        .pendel-filters input[type="date"] { padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 13px; background: #fff; }
        .pendel-filter-btn { padding: 8px 18px; border: none; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .pendel-filter-btn.apply { background: #667eea; color: #fff; }
        .pendel-filter-btn.apply:hover { background: #5a6fd6; }
        .pendel-filter-btn.reset { background: #e9ecef; color: #666; }
        .pendel-filter-btn.reset:hover { background: #dee2e6; }
        /* --- –ü–µ–Ω–¥–µ–ª—å: –∫–∞—Ä—Ç–æ—á–∫–∏ –∏—Ç–æ–≥–æ–≤ --- */
        .pendel-summary-cards { display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; }
        .pendel-summary-card { flex: 1; min-width: 160px; padding: 16px 20px; border-radius: 12px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .pendel-summary-card .label { font-size: 12px; color: #888; margin-bottom: 4px; }
        .pendel-summary-card .value { font-size: 22px; font-weight: 700; }
        .pendel-summary-card.total-expense .value { color: #e53e3e; }
        .pendel-summary-card.cat-count .value { color: #667eea; }
        /* --- –ü–µ–Ω–¥–µ–ª—å: —Ç–∞–±–ª–∏—Ü–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π --- */
        .pendel-table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .pendel-table thead th { background: #667eea; color: #fff; padding: 12px 16px; font-size: 13px; font-weight: 500; text-align: left; }
        .pendel-table thead th:last-child { text-align: center; width: 60px; }
        .pendel-category-row { cursor: pointer; transition: background 0.15s; }
        .pendel-category-row:hover { background: #f0f4ff; }
        .pendel-category-row.expanded { background: #e8f0fe; }
        .pendel-category-row td { padding: 14px 16px; border-bottom: 1px solid #e9ecef; font-size: 14px; }
        .pendel-category-row .cat-name { font-weight: 600; color: #333; }
        .pendel-category-row .cat-amount { font-weight: 700; color: #e53e3e; }
        .pendel-category-row .cat-count { color: #888; font-size: 13px; }
        .pendel-category-arrow { display: inline-block; transition: transform 0.2s; font-size: 12px; color: #999; text-align: center; }
        .pendel-category-row.expanded .pendel-category-arrow { transform: rotate(90deg); }
        .pendel-accordion { display: none; }
        .pendel-accordion.visible { display: table-row; }
        .pendel-accordion-cell { padding: 0 !important; background: #fafbfc; border-bottom: 2px solid #667eea; }
        .pendel-accordion-content { padding: 16px 20px; }
        .pendel-accordion-table { width: 100%; border-collapse: collapse; font-size: 13px; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .pendel-accordion-table thead th { background: #f1f3f5; color: #555; padding: 10px 12px; font-weight: 500; font-size: 12px; text-align: left; }
        .pendel-accordion-table tbody td { padding: 10px 12px; border-bottom: 1px solid #f0f0f0; }
        .pendel-accordion-table tbody tr:hover { background: #f8f9fa; }
        .pendel-accordion-table tbody tr:last-child td { border-bottom: none; }
        .pendel-accordion-loading { text-align: center; padding: 20px; color: #888; font-size: 13px; }
        .pendel-empty { text-align: center; padding: 40px 20px; color: #999; font-size: 14px; }

        /* ============================================================================
           –°–¢–ò–õ–ò –ü–û–î–í–ö–õ–ê–î–ö–ò ¬´–†–ï–ê–õ–ò–ó–ê–¶–ò–Ø¬ª (Ozon Finance API ‚Äî –∫–∞—Å—Å–æ–≤—ã–π –º–µ—Ç–æ–¥)
           ============================================================================ */
        /* --- –§–∏–ª—å—Ç—Ä—ã (–º–µ—Å—è—Ü + –∫–Ω–æ–ø–∫–∞) --- */
        .real-filters {
            display: flex; align-items: center; gap: 12px; padding: 16px 20px;
            background: #f8f9fa; border-radius: 12px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .real-filter-group { display: flex; align-items: center; gap: 8px; }
        .real-filter-label { font-size: 13px; font-weight: 500; color: #555; white-space: nowrap; }
        .real-month-select {
            padding: 8px 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;
            background: #fff; cursor: pointer; min-width: 180px; height: 38px;
            appearance: auto;
        }
        .real-period-type {
            padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;
            background: #fff; cursor: pointer; min-width: 120px; height: 38px; appearance: auto;
        }
        .real-period-type:focus { border-color: #667eea; outline: none; box-shadow: 0 0 0 2px rgba(102,126,234,0.2); }
        .real-month-select:focus { border-color: #667eea; outline: none; box-shadow: 0 0 0 2px rgba(102,126,234,0.2); }

        /* --- –°–≤–æ–¥–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ --- */
        .real-summary {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;
        }
        .real-card {
            padding: 16px 18px; border-radius: 12px; background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-left: 4px solid #ddd;
        }
        .real-card-label { font-size: 12px; color: #888; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.3px; }
        .real-card-value { font-size: 20px; font-weight: 700; }
        .real-card-hint { font-size: 11px; color: #aaa; margin-top: 4px; }
        .real-card-profit {
            border-left-color: #2d6a4f; background: linear-gradient(135deg, #f0fdf4, #fff);
            grid-column: 1 / -1;
        }
        .real-card-profit .real-card-value { color: #2d6a4f; font-size: 26px; }
        /* –ó–µ–ª—ë–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (–¥–æ—Ö–æ–¥) ‚Äî –±–ª–µ–¥–Ω–æ-–∑–µ–ª—ë–Ω—ã–π —Ñ–æ–Ω –∫–∞–∫ —É —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª–∏ */
        .real-card-realization { border-left-color: #2d6a4f; background: linear-gradient(135deg, #f0fdf4, #fff); }
        .real-card-realization .real-card-value { color: #2d6a4f; font-size: 22px; }
        .real-card-sales { border-left-color: #2d6a4f; background: linear-gradient(135deg, #f0fdf4, #fff); }
        .real-card-sales .real-card-value { color: #2d6a4f; }
        .real-card-compensations { border-left-color: #2d6a4f; cursor: pointer; background: linear-gradient(135deg, #f0fdf4, #fff); }
        .real-card-compensations .real-card-value { color: #2d6a4f; }
        .real-card-compensations .real-detail-value { color: #2d6a4f; }
        /* –ö—Ä–∞—Å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (—Ä–∞—Å—Ö–æ–¥) ‚Äî –±–ª–µ–¥–Ω–æ-—Ä–æ–∑–æ–≤—ã–π —Ñ–æ–Ω */
        .real-card-returns { border-left-color: #c0392b; background: linear-gradient(135deg, #fef2f2, #fff); }
        .real-card-returns .real-card-value { color: #c0392b; }
        .real-card-commission { border-left-color: #c0392b; cursor: pointer; background: linear-gradient(135deg, #fef2f2, #fff); }
        .real-card-commission .real-card-value { color: #c0392b; }
        .real-card-commission .real-detail-value { color: #c0392b; }
        .real-card-bonus { border-left-color: #c0392b; background: linear-gradient(135deg, #fef2f2, #fff); }
        .real-card-bonus .real-card-value { color: #c0392b; }
        .real-card-fee { border-left-color: #c0392b; background: linear-gradient(135deg, #fef2f2, #fff); }
        .real-card-fee .real-card-value { color: #c0392b; }
        .real-card-stars { border-left-color: #c0392b; background: linear-gradient(135deg, #fef2f2, #fff); }
        .real-card-stars .real-card-value { color: #c0392b; }
        .real-card-logistics { border-left-color: #c0392b; cursor: pointer; background: linear-gradient(135deg, #fef2f2, #fff); }
        .real-card-logistics .real-card-value { color: #c0392b; }
        .real-card-logistics .real-detail-value { color: #c0392b; }
        .real-card-other-deductions { border-left-color: #c0392b; cursor: pointer; background: linear-gradient(135deg, #fef2f2, #fff); }
        .real-card-other-deductions .real-card-value { color: #c0392b; }
        .real-card-other-deductions .real-detail-value { color: #c0392b; }
        .real-card-advertising { border-left-color: #c0392b; cursor: pointer; background: linear-gradient(135deg, #fef2f2, #fff); }
        .real-card-advertising .real-card-value { color: #c0392b; }
        .real-card-advertising .real-detail-value { color: #c0392b; }
        .real-card-storage { border-left-color: #c0392b; cursor: pointer; background: linear-gradient(135deg, #fef2f2, #fff); }
        .real-card-storage .real-card-value { color: #c0392b; }
        .real-card-storage .real-detail-value { color: #c0392b; }
        .real-card-cogs { border-left-color: #c0392b; background: linear-gradient(135deg, #fef2f2, #fff); }
        .real-card-cogs .real-card-value { color: #c0392b; }
        .real-card-opex { border-left-color: #c0392b; background: linear-gradient(135deg, #fef2f2, #fff); }
        .real-card-opex .real-card-value { color: #c0392b; }
        .real-card-opex .real-detail-value { color: #c0392b; }
        .real-card-tax { border-left-color: #c0392b; cursor: pointer; background: linear-gradient(135deg, #fef2f2, #fff); }
        .real-card-tax .real-card-value { color: #c0392b; }
        .real-card-tax .real-detail-value { color: #c0392b; }

        /* --- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –±–µ–π–¥–∂–µ–º (–∫–∞–∫ –≤ Ozon) --- */
        .real-card-header { display: flex; align-items: center; justify-content: space-between; }
        .real-card-badge {
            display: none; padding: 2px 8px; border-radius: 6px;
            background: #f0f0f0; font-size: 11px; font-weight: 600; color: #666;
        }
        .real-card-badge.visible { display: inline-block; }

        /* --- –î–µ—Ç–∞–ª–∏ –ø–æ –∫–ª–∏–∫—É (–∫–∞–∫ –≤ Ozon) --- */
        .real-card-details {
            display: none; margin-top: 10px; padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .real-card-details.open { display: block; }
        .real-detail-row {
            display: flex; justify-content: space-between; gap: 12px;
            padding: 4px 0; font-size: 13px;
        }
        .real-detail-label { color: #555; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .real-detail-value { font-weight: 600; white-space: nowrap; }
        .real-card-logistics .real-detail-value { color: #3182ce; }
        .real-card-other-deductions .real-detail-value { color: #805ad5; }
        .real-card-compensations .real-detail-value { color: #38a169; }
        .real-card-advertising .real-detail-value { color: #d53f8c; }
        .real-card-storage .real-detail-value { color: #c05621; }
        .real-card-opex .real-detail-value { color: #c0392b; }

        /* --- –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å–µ–∫—Ü–∏–π --- */
        .real-section-title { font-size: 16px; font-weight: 600; color: #333; margin: 24px 0 12px; }
        .real-section-hint { font-size: 12px; color: #999; font-weight: 400; }

        /* --- –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ --- */
        .real-types-table {
            width: 100%; border-collapse: collapse; background: #fff; border-radius: 12px;
            overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .real-types-table thead th {
            background: #667eea; color: #fff; padding: 10px 12px; font-size: 11px;
            font-weight: 500; text-align: left; line-height: 1.3;
        }
        .real-types-table tbody td {
            padding: 12px 16px; border-bottom: 1px solid #e9ecef; font-size: 14px;
        }
        .real-types-table tbody td:first-child {
            text-align: left;
        }
        .real-types-table tbody tr:hover { background: #f8f9fa; }
        .real-types-table tbody tr:last-child td { border-bottom: none; }
        .real-types-table #real-products-summary td {
            padding: 10px 16px; font-size: 13px; font-weight: 700;
            background: #f0f4ff; border-bottom: 2px solid #a0b4e8;
        }
        .real-amount-positive { color: #38a169; font-weight: 600; }
        .real-amount-negative { color: #e53e3e; font-weight: 600; }
        .real-amount-right { text-align: right; font-variant-numeric: tabular-nums; }
        .real-product-name { max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* --- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ --- */
        .real-empty { text-align: center; padding: 60px 20px; color: #999; font-size: 15px; }
        .real-loading { text-align: center; padding: 60px 20px; color: #888; }
        .real-spinner {
            display: inline-block; width: 36px; height: 36px; border: 3px solid #e9ecef;
            border-top-color: #667eea; border-radius: 50%; animation: realSpin 0.8s linear infinite;
            margin-bottom: 12px;
        }
        @keyframes realSpin { to { transform: rotate(360deg); } }
        .real-error { text-align: center; padding: 40px 20px; color: #e53e3e; font-size: 14px; }

        /* --- Mobile responsive --- */
        @media (max-width: 1024px) {
            .real-summary { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .real-filters { padding: 12px 14px; gap: 10px; }
            .real-month-select { min-width: 140px; font-size: 13px; }
            .real-summary { grid-template-columns: 1fr 1fr; gap: 8px; }
            .real-card { padding: 12px 14px; }
            .real-card-value { font-size: 17px; }
            .real-types-table thead th,
            .real-types-table tbody td { padding: 10px 12px; font-size: 13px; }
            .real-section-title { font-size: 15px; }
        }
        @media (max-width: 480px) {
            .real-summary { grid-template-columns: 1fr; gap: 8px; }
            .real-card { padding: 10px 12px; }
            .real-card-label { font-size: 11px; }
            .real-card-value { font-size: 16px; }
            .real-filters { flex-direction: column; align-items: stretch; }
            .real-filter-group { width: 100%; }
            .real-month-select { width: 100%; min-width: 0; }
            .real-product-name { max-width: 150px; }
        }

        /* ====== –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º ====== */
        #finance-container-section {
            margin-top: 16px;
            padding: 16px;
            background: #f8f9ff;
            border: 1px solid #e0e5f5;
            border-radius: 12px;
        }
        .finance-container-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .finance-container-section-header h4 {
            margin: 0;
            font-size: 15px;
            color: #333;
            font-weight: 600;
        }
        .finance-dist-remaining {
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 12px;
            background: #e3f2fd;
            color: #1565c0;
            font-weight: 500;
        }
        .finance-dist-remaining.error {
            background: #ffebee;
            color: #c62828;
        }
        .finance-dist-remaining.ok {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .finance-container-block {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
            position: relative;
        }
        .finance-container-block-header {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 10px;
        }
        .finance-container-block-header select {
            flex: 1;
            max-width: 400px;
        }
        .finance-container-block-remove {
            background: none;
            border: none;
            color: #e53935;
            cursor: pointer;
            font-size: 18px;
            padding: 4px 8px;
            border-radius: 6px;
        }
        .finance-container-block-remove:hover {
            background: #ffebee;
        }
        .finance-dist-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .finance-dist-table thead th {
            background: #f5f5f5;
            padding: 8px 10px;
            font-weight: 500;
            font-size: 12px;
            text-align: center;
            white-space: nowrap;
            color: #555;
        }
        .finance-dist-table thead th:first-child {
            text-align: left;
        }
        .finance-dist-table tbody td {
            padding: 6px 8px;
            border-bottom: 1px solid #f0f0f0;
            text-align: center;
        }
        .finance-dist-table tbody td:first-child {
            text-align: left;
            font-weight: 500;
            white-space: nowrap;
        }
        .finance-dist-table tfoot td {
            padding: 8px 10px;
            font-weight: 600;
            border-top: 2px solid #e0e0e0;
            text-align: center;
            font-size: 13px;
        }
        .finance-dist-table tfoot td:first-child {
            text-align: left;
        }
        .finance-dist-table input[type="number"] {
            width: 85px;
            padding: 4px 6px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }
        .finance-dist-table input[type="number"]:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.15);
        }
        .finance-add-container-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: #667eea;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            font-weight: 500;
        }
        .finance-add-container-btn:hover {
            background: #5a6fd6;
        }

        /* –ê–∫–∫–æ—Ä–¥–µ–æ–Ω —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ –∑–∞–ø–∏—Å–µ–π */
        .finance-dist-accordion { display: none; }
        .finance-dist-accordion.visible { display: table-row; }
        .finance-dist-accordion-cell { padding: 0 !important; background: #f0f4ff; border-bottom: 2px solid #667eea; }
        .finance-dist-accordion-content { padding: 16px 20px; }
        .finance-dist-accordion-table { width: 100%; border-collapse: collapse; font-size: 13px; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .finance-dist-accordion-table thead th { background: #f1f3f5; color: #555; padding: 10px 12px; font-weight: 500; font-size: 12px; text-align: left; }
        .finance-dist-accordion-table tbody td { padding: 10px 12px; border-bottom: 1px solid #f0f0f0; text-align: left; }
        .finance-dist-accordion-table tbody tr:hover { background: #f8f9fa; }
        .finance-dist-accordion-loading { text-align: center; padding: 20px; color: #888; font-size: 13px; }
        .finance-record-dist-indicator {
            display: inline-block;
            margin-left: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .finance-record-row-clickable { cursor: pointer; }
        .finance-record-row-clickable:hover { background: #f8f9ff; }

        /* Read-only –ø–æ–ª—è –ª–æ–≥–∏—Å—Ç–∏–∫–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ */
        .ved-container-cost-readonly {
            background: #f3f4f6;
            color: #666;
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 13px;
            text-align: center;
            cursor: default;
            min-width: 70px;
            display: inline-block;
        }
        .ved-container-cost-finance-badge {
            display: block;
            font-size: 10px;
            color: #667eea;
            margin-top: 2px;
        }

        /* –ß–µ–∫–±–æ–∫—Å –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º –≤ –ø–∞–Ω–µ–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
        .finance-category-container-link {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        .finance-category-container-link input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .wh-section-header {
            margin-bottom: 20px;
        }

        .wh-section-header h3 {
            font-size: 18px;
            color: #333;
            margin-bottom: 6px;
        }

        .wh-section-header p {
            font-size: 13px;
            color: #888;
        }

        .wh-toolbar {
            margin-bottom: 16px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .wh-add-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .wh-add-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .wh-refresh-btn {
            padding: 10px 20px;
            background: #f8f9fa;
            color: #333;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wh-refresh-btn:hover {
            background: #e9ecef;
            border-color: #ced4da;
        }

        .wh-table-wrapper {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .wh-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .wh-table thead th {
            background: #f8f9fa;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
        }

        .wh-table tbody td {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }

        .wh-table tbody tr:hover {
            background: #f8f9fa;
        }

        .wh-table tbody tr:last-child td {
            border-bottom: none;
        }

        .wh-table tfoot td {
            padding: 12px 16px;
            background: #f8f9fa;
            font-weight: 600;
            border-top: 2px solid #e9ecef;
        }

        .wh-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .wh-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .wh-input:disabled {
            background: #f8f9fa;
            color: #666;
        }

        /* –°–∫—Ä—ã—Ç—å —Å—Ç—Ä–µ–ª–∫–∏ —É —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        .wh-select {
            width: 100%;
            min-width: 180px;
            padding: 8px 12px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .wh-select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* –ö–∞—Å—Ç–æ–º–Ω—ã–π dropdown –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π */
        .destination-dropdown-wrapper {
            position: relative;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .destination-dropdown-wrapper input {
            flex: 1;
        }
        .destination-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 40px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 4px;
        }
        .destination-dropdown.show {
            display: block;
        }
        .destination-dropdown-item {
            padding: 10px 14px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.15s;
        }
        .destination-dropdown-item:last-child {
            border-bottom: none;
        }
        .destination-dropdown-item:hover {
            background: #f0f4ff;
        }
        .destination-dropdown-item.selected {
            background: #667eea;
            color: white;
        }

        /* ============================================ */
        /* –§–ò–ù–ê–ù–°–´ ‚Äî —Å—Ç–∏–ª–∏ –º–æ–¥—É–ª—è –¥–æ—Ö–æ–¥–æ–≤/—Ä–∞—Å—Ö–æ–¥–æ–≤      */
        /* ============================================ */

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å–≤–æ–¥–∫–∏ (–¥–æ—Ö–æ–¥, —Ä–∞—Å—Ö–æ–¥, –±–∞–ª–∞–Ω—Å) */
        .finance-summary {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .finance-summary-card {
            flex: 1;
            min-width: 200px;
            padding: 20px 24px;
            border-radius: 12px;
            background: #f8f9fb;
            border: 1px solid #e9ecef;
            transition: box-shadow 0.2s;
        }
        .finance-summary-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .finance-summary-card.income {
            border-left: 4px solid #22c55e;
        }
        .finance-summary-card.expense {
            border-left: 4px solid #ef4444;
        }
        .finance-summary-card.balance {
            border-left: 4px solid #667eea;
        }
        .finance-summary-card .label {
            font-size: 13px;
            color: #888;
            margin-bottom: 4px;
            font-weight: 500;
        }
        .finance-summary-card .value {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        .finance-summary-card.income .value { color: #22c55e; }
        .finance-summary-card.expense .value { color: #ef4444; }
        .finance-summary-card.balance .value { color: #333; }
        .finance-summary-card.yuan { border-left: 4px solid #f59e0b; }
        .finance-summary-card.yuan .value { color: #d97706; }

        /* –ë–µ–π–¥–∂–∏ —Ç–∏–ø–∞ –∑–∞–ø–∏—Å–∏ (–¥–æ—Ö–æ–¥/—Ä–∞—Å—Ö–æ–¥) */
        .finance-type-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }
        .finance-type-badge.income {
            background: #dcfce7;
            color: #16a34a;
        }
        .finance-type-badge.expense {
            background: #fee2e2;
            color: #dc2626;
        }

        /* –ë–µ–π–¥–∂ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–≤–µ–±/—Ç–µ–ª–µ–≥—Ä–∞–º) */
        .finance-source-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
        }
        .finance-source-badge.web {
            background: #e0e7ff;
            color: #4338ca;
        }
        .finance-source-badge.telegram {
            background: #dbeafe;
            color: #1d4ed8;
        }

        /* –§–∏–ª—å—Ç—Ä—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤ */
        .finance-filters {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 16px 20px;
            background: #f8f9fb;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .finance-filters label {
            font-size: 13px;
            color: #666;
            font-weight: 500;
            white-space: nowrap;
        }
        .finance-filters select,
        .finance-filters input[type="date"] {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            background: white;
            cursor: pointer;
        }
        .finance-filters select:focus,
        .finance-filters input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        .finance-filter-sep {
            color: #e0e0e0;
            margin: 0 2px;
            user-select: none;
        }

        /* –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ */
        .finance-form {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px 24px;
            margin-bottom: 20px;
        }
        .finance-form-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .finance-form-field {
            min-width: 140px;
        }
        .finance-form-field label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 13px;
            color: #555;
        }
        .finance-form-actions {
            display: flex;
            gap: 10px;
            margin-top: 4px;
        }

        .wh-delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #ccc;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .wh-delete-btn:hover {
            color: #ef4444;
            background: #fef2f2;
        }

        .wh-edit-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #ccc;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.2s;
            margin-right: 4px;
        }

        .wh-edit-btn:hover {
            color: #667eea;
            background: #f0f1ff;
        }

        .wh-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .wh-empty-state p {
            margin-bottom: 16px;
            font-size: 15px;
        }

        .wh-stock-positive {
            color: #22c55e;
            font-weight: 600;
        }

        .wh-stock-zero {
            color: #888;
        }

        .wh-stock-negative {
            color: #ef4444;
            font-weight: 600;
        }

        .wh-sum-cell {
            font-weight: 600;
            color: #333;
        }

        /* –§–æ—Ä–º–∞ –ø—Ä–∏—Ö–æ–¥–∞ */
        .receipt-form {
            background: #f8f9fb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .receipt-form-header {
            margin-bottom: 20px;
        }

        .receipt-form-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
        }

        .receipt-form-field {
            flex: 1;
        }

        .receipt-form-field label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 13px;
            color: #555;
        }

        /* –ß–µ–∫–±–æ–∫—Å "–ü—Ä–æ–≤–µ–¥–µ–Ω–æ" –¥–ª—è –æ—Ç–≥—Ä—É–∑–∫–∏ */
        .shipment-completed-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .shipment-completed-checkbox:hover {
            border-color: #667eea;
        }

        .shipment-completed-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #22c55e;
        }

        .shipment-completed-checkbox .checkbox-label {
            font-size: 13px;
            color: #333;
            font-weight: 400;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏–∏ */
        .shipment-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .shipment-status-badge.completed {
            background: #dcfce7;
            color: #16a34a;
        }

        .shipment-status-badge.pending {
            background: #fef3c7;
            color: #d97706;
        }

        .shipment-status-badge:hover {
            opacity: 0.8;
        }

        .receipt-items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .receipt-items-header h4 {
            font-size: 15px;
            color: #333;
            margin: 0;
        }

        .wh-add-btn-small {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wh-add-btn-small:hover {
            background: #5568d3;
        }

        .receipt-form-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        /* === –°–µ–∫—Ü–∏—è —á–∞—Ç–∞ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ === */
        .receipt-chat-section {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 2px solid #e0e7ff;
            background: #f8fafc;
            border-radius: 0 0 12px 12px;
            margin: 20px -24px -24px -24px;
            padding: 20px 24px 24px 24px;
        }

        .receipt-chat-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .receipt-chat-header h4 {
            margin: 0;
            font-size: 15px;
            color: #374151;
        }

        .chat-badge {
            background: #ef4444;
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .receipt-chat-messages {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .chat-empty {
            text-align: center;
            color: #9ca3af;
            font-size: 13px;
            padding: 20px;
        }

        .chat-message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 85%;
        }

        .chat-message.web {
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .chat-message.telegram {
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        .chat-message-header {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 6px;
        }

        .chat-message-text {
            font-size: 14px;
            color: #1f2937;
            line-height: 1.4;
        }

        .receipt-chat-input {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .receipt-chat-input input[type="text"] {
            flex: 1;
            min-width: 200px;
        }

        .chat-telegram-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #6b7280;
            cursor: pointer;
            white-space: nowrap;
        }

        .chat-telegram-checkbox input {
            cursor: pointer;
        }

        /* === –í–∫–ª–∞–¥–∫–∞ –°–æ–æ–±—â–µ–Ω–∏—è === */
        .messages-tab {
            padding: 20px;
        }

        .messages-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .messages-header h3 {
            margin: 0;
            font-size: 20px;
            color: #1f2937;
        }

        .messages-filters {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #6b7280;
            cursor: pointer;
        }

        .filter-checkbox input {
            cursor: pointer;
        }

        .messages-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px 20px;
            transition: box-shadow 0.2s;
        }

        .message-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .message-card.unread {
            background: #fef2f2;
            box-shadow: inset 0 0 0 2px #ef4444;
        }

        .message-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 15px;
        }

        .message-card-info {
            flex: 1;
        }

        .message-card-doc {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 4px;
        }

        .message-card-sender {
            font-size: 13px;
            color: #6b7280;
        }

        .message-card-time {
            font-size: 12px;
            color: #9ca3af;
            white-space: nowrap;
        }

        .message-card-text {
            font-size: 14px;
            color: #1f2937;
            line-height: 1.5;
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .message-card-actions {
            display: flex;
            gap: 10px;
        }

        .message-btn {
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 6px;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .message-btn-reply {
            background: #667eea;
            color: white;
        }

        .message-btn-reply:hover {
            background: #5a67d8;
        }

        .message-btn-read {
            background: #e5e7eb;
            color: #4b5563;
        }

        .message-btn-read:hover {
            background: #d1d5db;
        }

        .message-btn-open {
            background: #d1fae5;
            color: #065f46;
        }

        .message-btn-open:hover {
            background: #a7f3d0;
        }

        .messages-empty {
            text-align: center;
            color: #9ca3af;
            padding: 40px;
            font-size: 14px;
        }

        /* ============================================================================
           –ö–ù–û–ü–ö–ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø/–£–î–ê–õ–ï–ù–ò–Ø –°–û–û–ë–©–ï–ù–ò–ô
           ============================================================================ */

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–Ω–æ–ø–æ–∫ ‚Äî —Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        .msg-actions {
            display: none;
            gap: 4px;
            align-items: center;
        }

        .container-msg-bubble:hover .msg-actions,
        .chat-message:hover .msg-actions,
        .message-card:hover .msg-actions {
            display: inline-flex;
        }

        /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–∫–∏ –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω—ã (–Ω–µ—Ç hover) */
        @media (max-width: 768px) {
            .msg-actions {
                display: inline-flex;
            }
        }

        .msg-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 13px;
            opacity: 0.5;
            transition: opacity 0.2s, background 0.2s;
            line-height: 1;
        }

        .msg-action-btn:hover {
            opacity: 1;
            background: rgba(0, 0, 0, 0.06);
        }

        .msg-action-btn.msg-delete-btn:hover {
            background: rgba(198, 40, 40, 0.1);
        }

        /* –ò–Ω–ª–∞–π–Ω-—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .msg-edit-textarea {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid #2196f3;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
            box-sizing: border-box;
            outline: none;
        }

        .msg-edit-textarea:focus {
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.15);
        }

        .msg-edit-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 8px;
        }

        .msg-edit-save {
            padding: 6px 18px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .msg-edit-save:hover {
            background: #1976d2;
        }

        .msg-edit-cancel {
            padding: 6px 18px;
            background: #e9ecef;
            color: #333;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

        .msg-edit-cancel:hover {
            background: #dee2e6;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–≤–µ—Ç–∞ */
        .reply-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .reply-modal.active {
            display: flex;
        }

        .reply-modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .reply-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .reply-modal-header h4 {
            margin: 0;
            font-size: 16px;
        }

        .reply-modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #6b7280;
        }

        .reply-modal-original {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
            color: #4b5563;
        }

        .reply-modal-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 16px;
        }

        .reply-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .wh-save-receipt-btn {
            padding: 14px 32px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wh-save-receipt-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .wh-clear-btn {
            padding: 14px 24px;
            background: #f1f3f5;
            color: #666;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wh-clear-btn:hover {
            background: #e9ecef;
            color: #333;
        }

        .receipt-history {
            margin-top: 32px;
        }

        .receipt-history-header {
            margin-bottom: 12px;
        }

        .receipt-history-header h4 {
            font-size: 16px;
            color: #333;
            margin: 0;
        }

        .receipt-row-num {
            color: #888;
            font-weight: 500;
        }

        .receipt-view-btn {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-right: 4px;
        }

        .receipt-view-btn:hover {
            background: #5568d3;
        }

        .receipt-delete-history-btn {
            padding: 6px 12px;
            background: #fee2e2;
            color: #dc2626;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .receipt-delete-history-btn:hover {
            background: #fecaca;
        }

        /* ============================================================================
           –°–¢–ò–õ–ò –§–û–†–ú–´ –õ–û–ì–ò–ù–ê
           ============================================================================ */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .login-overlay.hidden {
            display: none;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 360px;
            text-align: center;
        }

        .login-box h2 {
            color: #333;
            margin-bottom: 8px;
            font-size: 24px;
        }

        .login-box .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .login-box input {
            width: 100%;
            padding: 14px 16px;
            margin-bottom: 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.2s;
        }

        .login-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-box button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .login-box button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* –ü–∞–Ω–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ö–µ–¥–µ—Ä–µ */
        .user-panel {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: 20px;
        }

        .user-info {
            font-size: 14px;
            color: #666;
        }

        .user-info .username {
            font-weight: 600;
            color: #333;
        }

        .user-info .role-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 6px;
        }

        .role-badge.admin {
            background: #667eea;
            color: white;
        }

        .role-badge.viewer {
            background: #e9ecef;
            color: #666;
        }

        .logout-btn {
            padding: 6px 12px;
            background: #f1f3f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #666;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: #e9ecef;
        }

        /* –°–∫—Ä—ã—Ç–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è viewer */
        .admin-only {
            /* –ë—É–¥–µ—Ç —Å–∫—Ä—ã–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ JS –¥–ª—è viewer */
        }

        body.viewer-mode .admin-only {
            display: none !important;
        }

        /* ============================================================================
           –°–¢–ò–õ–ò –í–ö–õ–ê–î–ö–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò (–ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨)
           ============================================================================ */
        .users-tab {
            padding: 20px 30px;
        }

        .users-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .users-header h3 {
            font-size: 18px;
            color: #333;
        }

        .add-user-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th,
        .users-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .users-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .users-table .actions {
            display: flex;
            gap: 8px;
        }

        .users-table .action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .users-table .change-pwd-btn {
            background: #e3f2fd;
            color: #1976d2;
        }

        .users-table .delete-btn {
            background: #ffebee;
            color: #c62828;
        }

        /* –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 400px;
        }

        .modal-box h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal-box .form-group {
            margin-bottom: 16px;
        }

        .modal-box label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .modal-box input,
        .modal-box select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }

        .modal-box input:focus,
        .modal-box select:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .modal-buttons .save-btn {
            background: #667eea;
            color: white;
        }

        .modal-buttons .cancel-btn {
            background: #f1f3f5;
            color: #333;
        }

        /* ============================================================================
           –ü–õ–ê–ù –ó–ê–ö–£–ü–û–ö ‚Äî —Å—Ç–∏–ª–∏ —Ç–∞–±–ª–∏—Ü—ã –∏ —Ñ–æ—Ä–º—ã
           ============================================================================ */
        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .plan-header h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }

        .plan-add-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .plan-add-btn:hover {
            background: #5a6fd6;
        }

        .plan-group { background: white; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); margin-bottom: 12px; overflow: hidden; }
        .plan-group-header { display: flex; align-items: center; padding: 14px 20px; cursor: pointer; user-select: none; transition: background 0.15s; gap: 16px; flex-wrap: wrap; }
        .plan-group-header:hover { background: #f0f4ff; }
        .plan-group-arrow { font-size: 12px; color: #999; transition: transform 0.2s; flex-shrink: 0; }
        .plan-group.open .plan-group-arrow { transform: rotate(90deg); }
        .plan-group-name { font-size: 15px; font-weight: 700; color: #333; min-width: 140px; }
        .plan-group-stats { display: flex; gap: 16px; flex-wrap: wrap; font-size: 12px; color: #777; }
        .plan-group-stats span { white-space: nowrap; }
        .plan-group-stats .yuan { color: #e67e22; font-weight: 600; }
        .plan-group-stats .rub { color: #27ae60; font-weight: 600; }
        .plan-group-body { border-top: 1px solid #eee; }
        .plan-group .plan-group-table tbody { display: none; }
        .plan-group.open .plan-group-table tbody { display: table-row-group; }
        .plan-group .plan-add-wrap { display: none; }
        .plan-group.open .plan-add-wrap { display: block; }
        .plan-group-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .plan-group-table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 1350px; }
        .plan-group-table thead th { background: #f8f9fa; padding: 8px 10px; text-align: center; font-weight: 600; color: #555; border-bottom: 2px solid #e9ecef; white-space: nowrap; font-size: 11px; }
        .plan-totals-row td { padding: 8px 10px; text-align: center; font-weight: 700; font-size: 15px; color: #222; background: #eef2ff; border-bottom: 2px solid #c5cfe0; }
        .plan-group-table tbody td { padding: 8px 10px; border-bottom: 1px solid #f0f0f0; text-align: center; vertical-align: middle; }
        .plan-group-table tbody tr:hover { background: #f8f9ff; }
        .plan-group-table .yuan-cell { color: #e67e22; font-weight: 500; }
        .plan-group-table .rub-cell { color: #27ae60; font-weight: 500; }
        .plan-group-table .number-cell { font-variant-numeric: tabular-nums; color: #444; }
        .plan-delete-btn { padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; background: #fce4ec; color: #c62828; transition: background 0.2s; }
        .plan-delete-btn:hover { background: #ffcdd2; }
        .plan-add-row-wrap { padding: 10px 20px 14px; }
        .plan-add-row-btn { padding: 6px 16px; background: #e8eaf6; color: #667eea; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .plan-add-row-btn:hover { background: #c5cae9; }
        .plan-empty { text-align: center; padding: 60px 20px; color: #999; font-size: 15px; }
        .plan-empty p:first-child { font-size: 40px; margin-bottom: 12px; }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ –ø–ª–∞–Ω–∞ */
        .plan-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 16px;
            overflow-y: auto;
        }

        .plan-modal-overlay.active {
            display: flex;
        }

        .plan-modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 700px;
            padding: 32px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }

        .plan-modal h3 {
            margin: 0 0 24px 0;
            font-size: 20px;
            color: #333;
        }

        .plan-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .plan-form-grid .full-width {
            grid-column: 1 / -1;
        }

        .plan-form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .plan-form-group label {
            font-size: 13px;
            font-weight: 600;
            color: #555;
        }

        .plan-form-group input {
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .plan-form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .plan-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }

        .plan-modal-actions button {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .plan-save-btn {
            background: #667eea;
            color: white;
        }

        .plan-save-btn:hover {
            background: #5a6fd6;
        }

        .plan-cancel-btn {
            background: #f1f3f5;
            color: #333;
        }

        .plan-cancel-btn:hover {
            background: #e9ecef;
        }

        /* –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã */
        .plan-table tfoot td {
            padding: 12px;
            font-weight: 700;
            background: #f8f9fa;
            border-top: 2px solid #e9ecef;
            font-size: 13px;
        }

        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–ª–∞–Ω–∞ */
        @media (max-width: 768px) {
            .plan-header {
                flex-direction: column;
                align-items: stretch;
            }

            .plan-add-btn {
                width: 100%;
                text-align: center;
            }

            .plan-group-header { padding: 12px 14px; gap: 8px; }
            .plan-group-name { font-size: 14px; min-width: unset; }
            .plan-group-stats { gap: 8px; font-size: 11px; }

            .plan-modal {
                padding: 20px 16px;
                border-radius: 12px;
            }

            .plan-modal-overlay {
                padding: 20px 8px;
            }

            .plan-form-grid {
                grid-template-columns: 1fr;
            }

            .plan-modal h3 {
                font-size: 18px;
            }

            .plan-modal-actions {
                flex-direction: column;
            }

            .plan-modal-actions button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- ============================================================================
         –§–û–†–ú–ê –í–•–û–î–ê (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –µ—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω)
         ============================================================================ -->
    <div id="login-overlay" class="login-overlay hidden" style="display:none;">
        <div class="login-box">
            <h2>Moscow Seller</h2>
            <div id="login-error" class="login-error"></div>
            <input type="text" id="login-username" placeholder="–õ–æ–≥–∏–Ω" autocomplete="username">
            <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
            <button id="login-submit" onclick="doLogin()">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <!-- ============================================================================
         –ú–û–î–ê–õ–ö–ê: –°–û–ó–î–ê–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
         ============================================================================ -->
    <div id="create-user-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <h3>–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
            <div class="form-group">
                <label>–õ–æ–≥–∏–Ω</label>
                <input type="text" id="new-user-username" placeholder="–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞">
            </div>
            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="new-user-password" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤">
            </div>
            <div class="form-group">
                <label>–†–æ–ª—å</label>
                <select id="new-user-role">
                    <option value="viewer">Viewer (—Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä)</option>
                    <option value="admin">Admin (–ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø)</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeCreateUserModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="save-btn" onclick="createUser()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- ============================================================================
         –ú–û–î–ê–õ–ö–ê: –°–ú–ï–ù–ê –ü–ê–†–û–õ–Ø
         ============================================================================ -->
    <div id="change-pwd-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <h3>–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</h3>
            <p style="color: #666; margin-bottom: 16px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong id="change-pwd-username"></strong></p>
            <div class="form-group">
                <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                <input type="password" id="change-pwd-input" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤">
            </div>
            <input type="hidden" id="change-pwd-user-id">
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeChangePwdModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="save-btn" onclick="changePassword()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- ============================================================================
         –ú–û–î–ê–õ–ö–ê: –ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
         ============================================================================ -->
    <div id="rename-user-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <h3>–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <p style="color: #666; margin-bottom: 16px;">–¢–µ–∫—É—â–µ–µ –∏–º—è: <strong id="rename-user-old-name"></strong></p>
            <div class="form-group">
                <label>–ù–æ–≤–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                <input type="text" id="rename-user-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è">
            </div>
            <input type="hidden" id="rename-user-id">
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeRenameUserModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="save-btn" onclick="renameUser()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- ============================================================================
         –ú–û–î–ê–õ–ö–ê: –£–°–¢–ê–ù–û–í–ö–ê –û–¢–û–ë–†–ê–ñ–ê–ï–ú–û–ì–û –ò–ú–ï–ù–ò
         ============================================================================ -->
    <div id="set-display-name-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <h3>–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</h3>
            <p style="color: #666; margin-bottom: 16px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong id="display-name-username"></strong></p>
            <p style="color: #888; font-size: 13px; margin-bottom: 12px;">–≠—Ç–æ –∏–º—è –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è –≤ —Å—Ç–æ–ª–±—Ü–∞—Ö "–ò–∑–º–µ–Ω–µ–Ω–æ" –∏ "–°–æ–∑–¥–∞–Ω–æ" –≤–º–µ—Å—Ç–æ –ª–æ–≥–∏–Ω–∞.</p>
            <div class="form-group">
                <label>–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</label>
                <input type="text" id="display-name-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
            </div>
            <input type="hidden" id="display-name-user-id">
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeSetDisplayNameModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="save-btn" onclick="setDisplayName()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- ============================================================================
         –ú–û–î–ê–õ–ö–ê: –ü–†–ò–í–Ø–ó–ö–ê TELEGRAM –ê–ö–ö–ê–£–ù–¢–ê
         ============================================================================ -->
    <div id="link-telegram-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <h3>üì± –ü—Ä–∏–≤—è–∑–∫–∞ Telegram</h3>
            <p style="color: #666; margin-bottom: 16px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong id="link-tg-username"></strong></p>
            <div class="form-group">
                <label>Telegram username</label>
                <input type="text" id="link-tg-input" placeholder="@username" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                <small style="color: #888; display: block; margin-top: 4px;">–í–≤–µ–¥–∏—Ç–µ @username –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –æ—Ç–≤—è–∑–∫–∏</small>
            </div>
            <input type="hidden" id="link-tg-user-id">
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeLinkTelegramModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="save-btn" onclick="linkTelegramAccount()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è (–Ω—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ "—É–¥–∞–ª–∏—Ç—å") -->
    <div id="confirm-delete-modal" class="modal-overlay hidden">
        <div class="modal-box" style="max-width: 420px;">
            <h3 style="color: #c62828;">‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
            <p id="confirm-delete-message" style="color: #666; margin-bottom: 16px;"></p>
            <div class="form-group">
                <label>–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ <strong style="color: #c62828;">—É–¥–∞–ª–∏—Ç—å</strong></label>
                <input type="text" id="confirm-delete-input" placeholder="–í–≤–µ–¥–∏—Ç–µ: —É–¥–∞–ª–∏—Ç—å" autocomplete="off"
                    style="width: 100%; padding: 10px 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;">
                <small id="confirm-delete-error" style="color: #c62828; display: none; margin-top: 4px;">–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ ¬´—É–¥–∞–ª–∏—Ç—å¬ª –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</small>
            </div>
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeDeleteConfirmModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="save-btn" id="confirm-delete-btn" style="background: #c62828;" onclick="executeDeleteConfirm()">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="container" id="main-container" style="display: none;">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div style="display: flex; gap: 8px;">
                    <button class="refresh-btn admin-only" onclick="syncData()" id="sync-btn">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                </div>
                <div class="user-panel">
                    <div class="user-info">
                        <span class="username" id="current-username"></span>
                        <span class="role-badge" id="current-role-badge"></span>
                    </div>
                    <button class="logout-btn" onclick="doLogout()">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab(event, 'history')">OZON</button>
                <button class="tab-button" onclick="switchTab(event, 'plan')">–ü–õ–ê–ù</button>
                <button class="tab-button" onclick="switchTab(event, 'warehouse')" id="warehouse-tab-btn">–°–ö–õ–ê–î</button>
                <button class="tab-button" onclick="switchTab(event, 'ved')">–í–≠–î</button>
                <button class="tab-button" onclick="switchTab(event, 'finance')">–§–ò–ù–ê–ù–°–´</button>
                <button class="tab-button" onclick="switchTab(event, 'messages')" id="messages-tab-btn">–°–æ–æ–±—â–µ–Ω–∏—è <span id="messages-badge" class="tab-badge" style="display:none;"></span></button>
                <button class="tab-button admin-only" onclick="switchTab(event, 'users')" id="users-tab-btn">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
            </div>

            <!-- –¢–ê–ë: OZON (—Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ –≤–∫–ª–∞–¥–∫–∞–º–∏) -->
            <div id="history" class="tab-content active">
                <!-- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∏ -->
                <div class="sub-tabs">
                    <button class="sub-tab-button active" onclick="switchSubTab(event, 'summary')">–°–≤–æ–¥–Ω–∞—è</button>
                    <button class="sub-tab-button" onclick="switchSubTab(event, 'product-analysis')">–ê–Ω–∞–ª–∏–∑ —Ç–æ–≤–∞—Ä–∞</button>
                    <button class="sub-tab-button" onclick="switchSubTab(event, 'fbo')">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ FBO</button>
                    <button class="sub-tab-button" onclick="switchSubTab(event, 'unit-economics')">–Æ–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–∞</button>
                </div>

                <!-- –ü–æ–¥-–≤–∫–ª–∞–¥–∫–∞: –ê–Ω–∞–ª–∏–∑ —Ç–æ–≤–∞—Ä–∞ -->
                <div id="product-analysis" class="sub-tab-content">
                    <div class="table-header">
                        <div class="date-filters-inline">
                            <input type="date" id="date-from" class="date-filter-input" onclick="this.showPicker()" onchange="applyDateFilter()">
                            <span class="date-separator">‚Äî</span>
                            <input type="date" id="date-to" class="date-filter-input" onclick="this.showPicker()" onchange="applyDateFilter()">
                            <button id="date-filter-reset-btn" class="date-filter-reset" onclick="resetDateFilter()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                        </div>
                        <div>
                            <label for="product-select" style="margin-right: 10px; font-weight: 500;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä:</label>
                            <select
                                id="product-select"
                                class="history-select"
                                onchange="loadHistoryForProduct()"
                            >
                            </select>
                        </div>
                    </div>
                    <div id="history-content">
                        <div class="loading">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –∏–∑ —Å–ø–∏—Å–∫–∞</div>
                    </div>
                </div>

                <!-- –ü–æ–¥-–≤–∫–ª–∞–¥–∫–∞: –°–≤–æ–¥–Ω–∞—è -->
                <div id="summary" class="sub-tab-content active">
                    <div class="table-header" style="flex-wrap: wrap; gap: 12px;">
                        <div class="date-filters-inline" style="flex-wrap: wrap; gap: 8px; align-items: center;">
                            <!-- –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞ -->
                            <div style="display: flex; gap: 4px; margin-right: 12px;">
                                <button class="period-btn active" onclick="setSummaryPeriod('today')" id="period-today">–°–µ–≥–æ–¥–Ω—è</button>
                                <button class="period-btn" onclick="setSummaryPeriod('yesterday')" id="period-yesterday">–í—á–µ—Ä–∞</button>
                                <button class="period-btn" onclick="setSummaryPeriod('7days')" id="period-7days">7 –¥–Ω–µ–π</button>
                                <button class="period-btn" onclick="setSummaryPeriod('14days')" id="period-14days">14 –¥–Ω–µ–π</button>
                                <button class="period-btn" onclick="setSummaryPeriod('30days')" id="period-30days">30 –¥–Ω–µ–π</button>
                            </div>
                            <!-- –ü–æ–ª—è –≤—ã–±–æ—Ä–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç -->
                            <label style="font-weight: 500;">—Å:</label>
                            <input type="date" id="summary-date-from" class="date-filter-input" onclick="this.showPicker()" onchange="loadSummary()">
                            <label style="font-weight: 500; margin-left: 8px;">–ø–æ:</label>
                            <input type="date" id="summary-date-to" class="date-filter-input" onclick="this.showPicker()" onchange="loadSummary()">
                        </div>
                        <div style="font-size: 14px; color: #666;">
                            –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤: <strong id="summary-count">0</strong>
                            <span id="summary-period-info" style="margin-left: 12px; color: #888;"></span>
                        </div>
                    </div>
                    <div id="summary-content">
                        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                    </div>
                </div>

                <!-- –ü–æ–¥-–≤–∫–ª–∞–¥–∫–∞: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ FBO -->
                <div id="fbo" class="sub-tab-content">
                    <div id="fbo-content">
                        <div class="fbo-loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                    </div>
                </div>

                <!-- –ü–æ–¥-–≤–∫–ª–∞–¥–∫–∞: –Æ–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–∞ -->
                <div id="unit-economics" class="sub-tab-content">
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 300px; color: #6c757d;">
                        <div style="text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
                            <h3 style="margin: 0 0 8px 0; color: #495057;">–Æ–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–∞</h3>
                            <p style="margin: 0; font-size: 14px;">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –¢–ê–ë: –°–∫–ª–∞–¥ -->
            <div id="warehouse" class="tab-content">
                <!-- –ü–æ–¥–≤–∫–ª–∞–¥–∫–∏ —Å–∫–ª–∞–¥–∞ -->
                <div class="warehouse-subtabs">
                    <button class="subtab-button active" onclick="switchWarehouseSubtab(event, 'wh-receipt')">–û–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–µ</button>
                    <button class="subtab-button" onclick="switchWarehouseSubtab(event, 'wh-shipments')">–û—Ç–≥—Ä—É–∑–∫–∏</button>
                    <button class="subtab-button" onclick="switchWarehouseSubtab(event, 'wh-stock')">–û—Å—Ç–∞—Ç–∫–∏</button>
                </div>

                <!-- –ü–æ–¥–≤–∫–ª–∞–¥–∫–∞: –û–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–µ -->
                <div id="wh-receipt" class="warehouse-subtab-content active">
                    <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–∏—Ö–æ–¥–∞ -->
                    <div id="receipt-create-btn-wrapper" style="margin-bottom: 20px;">
                        <button class="wh-save-receipt-btn" onclick="showReceiptForm()" style="display: flex; align-items: center; gap: 8px; padding: 12px 24px; font-size: 15px;">
                            <span style="font-size: 18px;">+</span> –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–∏—Ö–æ–¥
                        </button>
                    </div>

                    <!-- –§–æ—Ä–º–∞ –Ω–æ–≤–æ–≥–æ –ø—Ä–∏—Ö–æ–¥–∞ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                    <div class="receipt-form" id="receipt-form" style="display: none;">
                        <div class="receipt-form-header">
                            <div class="receipt-form-row">
                                <div class="receipt-form-field" style="flex: 0 0 160px;">
                                    <label>–î–∞—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∞</label>
                                    <input type="date" id="receipt-date" class="wh-input" style="cursor: pointer;">
                                </div>
                                <div class="receipt-form-field" style="flex: 0 0 180px;">
                                    <label>–ò–º—è –ø—Ä–∏—ë–º—â–∏–∫–∞</label>
                                    <input type="text" id="receipt-receiver" class="wh-input" placeholder="–ö—Ç–æ –ø—Ä–∏–Ω—è–ª —Ç–æ–≤–∞—Ä">
                                </div>
                                <div class="receipt-form-field" style="flex: 1;">
                                    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø—Ä–∏—Ö–æ–¥—É</label>
                                    <input type="text" id="receipt-comment" class="wh-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–æ—Å—Ç–∞–≤–∫–∞ –æ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ X">
                                </div>
                            </div>
                        </div>

                        <div class="receipt-items-header">
                            <h4>–¢–æ–≤–∞—Ä—ã –≤ –ø—Ä–∏—Ö–æ–¥–µ</h4>
                            <button class="wh-add-btn-small" onclick="addReceiptItemRow()">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
                        </div>

                        <div class="wh-table-wrapper">
                            <table class="wh-table" id="wh-receipt-items-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">‚Ññ</th>
                                        <th>–¢–æ–≤–∞—Ä</th>
                                        <th style="width: 120px;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                        <th style="width: 140px;">–¶–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏, ‚ÇΩ</th>
                                        <th style="width: 140px;">–°—É–º–º–∞, ‚ÇΩ</th>
                                        <th style="width: 40px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="wh-receipt-items-tbody">
                                </tbody>
                                <tfoot id="wh-receipt-items-tfoot">
                                    <tr>
                                        <td colspan="2" style="text-align: right; font-weight: 600;">–ò—Ç–æ–≥–æ:</td>
                                        <td style="text-align: center; font-weight: 600;" id="receipt-total-qty">0</td>
                                        <td></td>
                                        <td style="text-align: right; font-weight: 600;" id="receipt-total-sum">0 ‚ÇΩ</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="receipt-form-actions">
                            <button class="wh-save-receipt-btn" onclick="saveReceipt()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏—Ö–æ–¥</button>
                            <button class="wh-clear-btn" onclick="cancelReceipt()">–û—Ç–º–µ–Ω–∞</button>
                        </div>

                        <!-- –°–µ–∫—Ü–∏—è —á–∞—Ç–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–∑ Telegram) -->
                        <div class="receipt-chat-section" id="receipt-chat-section" style="display: none;">
                            <div class="receipt-chat-header">
                                <h4>üí¨ –°–æ–æ–±—â–µ–Ω–∏—è</h4>
                                <span class="chat-badge" id="receipt-chat-badge" style="display: none;">0</span>
                            </div>
                            <div class="receipt-chat-messages" id="receipt-chat-messages">
                                <div class="chat-empty">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                            </div>
                            <div class="receipt-chat-input">
                                <input type="text" id="receipt-chat-message" class="wh-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter')sendDocumentMessage()">
                                <label class="chat-telegram-checkbox">
                                    <input type="checkbox" id="receipt-chat-send-telegram" checked>
                                    <span>üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</span>
                                </label>
                                <button class="wh-add-btn" onclick="sendDocumentMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>

                    <!-- –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–∏—Ö–æ–¥–æ–≤ -->
                    <div class="receipt-history">
                        <div class="receipt-history-header">
                            <h4>üìã –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–∏—Ö–æ–¥–æ–≤</h4>
                            <!-- –§–∏–ª—å—Ç—Ä—ã -->
                            <div class="receipt-date-filter" style="display: flex; gap: 10px; align-items: center; margin-top: 12px; flex-wrap: wrap;">
                                <label style="font-size: 13px; color: #666;">‚Ññ –ø—Ä–∏—Ö–æ–¥–∞:</label>
                                <input type="text" id="receipt-filter-docnum" class="wh-input" style="width: 80px; text-align: center;" placeholder="123" oninput="this.value = this.value.replace(/[^0-9]/g, ''); filterReceiptHistory()">
                                <span style="color: #ddd; margin: 0 4px;">|</span>
                                <label style="font-size: 13px; color: #666;">–ü–µ—Ä–∏–æ–¥ –ø—Ä–∏—Ö–æ–¥–∞:</label>
                                <input type="date" id="receipt-date-from" class="wh-input" style="width: 140px; cursor: pointer;" onclick="this.showPicker()" onchange="filterReceiptHistory()">
                                <span style="color: #999;">‚Äî</span>
                                <input type="date" id="receipt-date-to" class="wh-input" style="width: 140px; cursor: pointer;" onclick="this.showPicker()" onchange="filterReceiptHistory()">
                                <span style="color: #ddd; margin: 0 4px;">|</span>
                                <label style="font-size: 13px; color: #666;">–ê—Ä—Ç–∏–∫—É–ª:</label>
                                <select id="receipt-filter-product" class="wh-input" style="width: 200px; cursor: pointer;" onchange="filterReceiptHistory()">
                                    <option value="">–í—Å–µ –∞—Ä—Ç–∏–∫—É–ª—ã</option>
                                </select>
                                <button class="wh-clear-btn" onclick="resetReceiptDateFilter()" style="padding: 6px 12px; font-size: 12px;">–°–±—Ä–æ—Å–∏—Ç—å</button>
                            </div>
                        </div>
                        <div class="wh-table-wrapper" id="receipt-history-wrapper" style="display: none;">
                            <table class="wh-table" id="wh-receipt-history-table">
                                <thead>
                                    <tr>
                                        <th style="width: 60px;">‚Ññ</th>
                                        <th>–î–∞—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∞</th>
                                        <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                                        <th>–ü—Ä–∏—ë–º—â–∏–∫</th>
                                        <th>–¢–æ–≤–∞—Ä–æ–≤</th>
                                        <th>–û–±—â–µ–µ –∫–æ–ª-–≤–æ</th>
                                        <th title="–†–∞—Å—Å—á–∏—Ç–∞–Ω–æ –∏–∑ –ø–æ—Å—Ç–∞–≤–æ–∫">–°—É–º–º–∞ –ø–æ<br>–ø–æ—Å—Ç–∞–≤–∫–∞–º</th>
                                        <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                                        <th>–ò–∑–º–µ–Ω–µ–Ω–æ</th>
                                        <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                                        <th style="width: 100px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="wh-receipt-history-tbody">
                                </tbody>
                            </table>
                        </div>
                        <div class="wh-empty-state" id="wh-receipt-history-empty">
                            <p>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–∏—Ö–æ–¥–æ–≤</p>
                        </div>
                    </div>
                </div>

                <!-- –ü–æ–¥–≤–∫–ª–∞–¥–∫–∞: –û—Ç–≥—Ä—É–∑–∫–∏ -->
                <div id="wh-shipments" class="warehouse-subtab-content">
                    <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –æ—Ç–≥—Ä—É–∑–∫–∏ -->
                    <div id="shipment-create-btn-wrapper" style="margin-bottom: 20px;">
                        <button class="wh-save-receipt-btn" onclick="showShipmentForm()" style="display: flex; align-items: center; gap: 8px; padding: 12px 24px; font-size: 15px;">
                            <span style="font-size: 18px;">+</span> –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –æ—Ç–≥—Ä—É–∑–∫—É
                        </button>
                    </div>

                    <!-- –§–æ—Ä–º–∞ –Ω–æ–≤–æ–π –æ—Ç–≥—Ä—É–∑–∫–∏ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                    <div class="receipt-form" id="shipment-form" style="display: none;">
                        <div class="receipt-form-header">
                            <div class="receipt-form-row">
                                <div class="receipt-form-field">
                                    <label>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</label>
                                    <div class="destination-dropdown-wrapper">
                                        <input type="text" id="shipment-destination" class="wh-input" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ" autocomplete="off" onclick="toggleDestinationDropdown()" oninput="filterDestinations()">
                                        <div class="destination-dropdown" id="destination-dropdown"></div>
                                        <button type="button" class="wh-add-btn-small" onclick="addNewDestination()" title="–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫">+</button>
                                    </div>
                                </div>
                                <div class="receipt-form-field" style="flex: 2;">
                                    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –æ—Ç–≥—Ä—É–∑–∫–µ</label>
                                    <input type="text" id="shipment-comment" class="wh-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Ç–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–∫–ª–∞–¥ Ozon">
                                </div>
                                <div class="receipt-form-field" style="flex: 0; min-width: 140px;">
                                    <label style="display: block; margin-bottom: 8px;">–ü—Ä–æ–≤–µ–¥–µ–Ω–æ</label>
                                    <label class="shipment-completed-checkbox">
                                        <input type="checkbox" id="shipment-completed" checked>
                                        <span class="checkbox-label">–°–ø–∏—Å–∞—Ç—å —Å–æ —Å–∫–ª–∞–¥–∞</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="receipt-items-header">
                            <h4>–¢–æ–≤–∞—Ä—ã –≤ –æ—Ç–≥—Ä—É–∑–∫–µ</h4>
                            <button class="wh-add-btn-small" onclick="addShipmentItemRow()">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
                        </div>

                        <div class="wh-table-wrapper">
                            <table class="wh-table" id="wh-shipment-items-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">‚Ññ</th>
                                        <th>–¢–æ–≤–∞—Ä</th>
                                        <th style="width: 150px;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                        <th style="width: 40px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="wh-shipment-items-tbody">
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="2" style="text-align: right; font-weight: 600;">–ò—Ç–æ–≥–æ:</td>
                                        <td style="text-align: center; font-weight: 600;" id="shipment-total-qty">0</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="receipt-form-actions">
                            <button class="wh-save-receipt-btn wh-save-shipment-btn" onclick="saveShipment()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≥—Ä—É–∑–∫—É</button>
                            <button class="wh-clear-btn" onclick="cancelShipment()">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </div>

                    <!-- –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–≥—Ä—É–∑–æ–∫ -->
                    <div class="receipt-history">
                        <div class="receipt-history-header">
                            <h4>–ò—Å—Ç–æ—Ä–∏—è –æ—Ç–≥—Ä—É–∑–æ–∫</h4>
                            <!-- –§–∏–ª—å—Ç—Ä—ã -->
                            <div class="receipt-date-filter" style="display: flex; gap: 10px; align-items: center; margin-top: 12px; flex-wrap: wrap;">
                                <label style="font-size: 13px; color: #666;">‚Ññ –æ—Ç–≥—Ä—É–∑–∫–∏:</label>
                                <input type="text" id="shipment-filter-docnum" class="wh-input" style="width: 80px; text-align: center;" placeholder="123" oninput="this.value = this.value.replace(/[^0-9]/g, ''); filterShipmentHistory()">
                                <span style="color: #ddd; margin: 0 4px;">|</span>
                                <label style="font-size: 13px; color: #666;">–ü–µ—Ä–∏–æ–¥:</label>
                                <input type="date" id="shipment-date-from" class="wh-input" style="width: 140px; cursor: pointer;" onclick="this.showPicker()" onchange="filterShipmentHistory()">
                                <span style="color: #999;">‚Äî</span>
                                <input type="date" id="shipment-date-to" class="wh-input" style="width: 140px; cursor: pointer;" onclick="this.showPicker()" onchange="filterShipmentHistory()">
                                <button class="wh-clear-btn" onclick="resetShipmentDateFilter()" style="padding: 6px 12px; font-size: 12px;">–°–±—Ä–æ—Å–∏—Ç—å</button>
                            </div>
                        </div>
                        <div class="wh-table-wrapper" id="shipment-history-wrapper" style="display: none;">
                            <table class="wh-table" id="wh-shipment-history-table">
                                <thead>
                                    <tr>
                                        <th style="width: 60px;">‚Ññ</th>
                                        <th>–î–∞—Ç–∞/–≤—Ä–µ–º—è</th>
                                        <th>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</th>
                                        <th>–ü—Ä–æ–≤–µ–¥–µ–Ω–æ</th>
                                        <th>–¢–æ–≤–∞—Ä–æ–≤</th>
                                        <th>–û–±—â–µ–µ –∫–æ–ª-–≤–æ</th>
                                        <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                                        <th>–°–æ–∑–¥–∞–ª</th>
                                        <th>–ò–∑–º–µ–Ω–µ–Ω–æ</th>
                                        <th style="width: 80px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="wh-shipment-history-tbody">
                                </tbody>
                            </table>
                        </div>
                        <div class="wh-empty-state" id="wh-shipment-history-empty">
                            <p>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –æ—Ç–≥—Ä—É–∑–æ–∫</p>
                        </div>
                    </div>
                </div>

                <!-- –ü–æ–¥–≤–∫–ª–∞–¥–∫–∞: –û—Å—Ç–∞—Ç–∫–∏ -->
                <div id="wh-stock" class="warehouse-subtab-content">
                    <div class="wh-section-header">
                        <h3>–û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ</h3>
                        <p>–¢–µ–∫—É—â–∏–µ –æ—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ —Å —É—á—ë—Ç–æ–º –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–π –∏ –æ—Ç–≥—Ä—É–∑–æ–∫</p>
                    </div>
                    <div class="wh-toolbar">
                        <button class="wh-refresh-btn" onclick="loadWarehouseStock()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                    </div>
                    <div class="wh-table-wrapper">
                        <table class="wh-table" id="wh-stock-table">
                            <thead>
                                <tr>
                                    <th>–ê—Ä—Ç–∏–∫—É–ª</th>
                                    <th>–û–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–æ</th>
                                    <th>–û—Ç–≥—Ä—É–∂–µ–Ω–æ</th>
                                    <th>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ</th>
                                    <th>–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ</th>
                                    <th>–û—Å—Ç–∞—Ç–æ–∫ ‚àí –±—Ä–æ–Ω—å</th>
                                    <th>–°—Ä. —Ü–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏, ‚ÇΩ</th>
                                    <th>–°—Ç–æ–∏–º–æ—Å—Ç—å –æ—Å—Ç–∞—Ç–∫–∞, ‚ÇΩ</th>
                                </tr>
                            </thead>
                            <tbody id="wh-stock-tbody">
                            </tbody>
                            <tfoot id="wh-stock-tfoot">
                            </tfoot>
                        </table>
                    </div>
                    <div class="wh-empty-state" id="wh-stock-empty">
                        <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Å—Ç–∞—Ç–∫–∞—Ö</p>
                        <p style="font-size: 13px; color: #888;">–î–æ–±–∞–≤—å—Ç–µ –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤</p>
                    </div>
                </div>
            </div>

            <!-- –¢–ê–ë: –í–≠–î (–≤–Ω–µ—à–Ω–µ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å) -->
            <div id="ved" class="tab-content">
                <!-- –ü–æ–¥–≤–∫–ª–∞–¥–∫–∏ –í–≠–î -->
                <div class="ved-subtabs">
                    <button class="ved-subtab-button active" onclick="switchVedSubtab(event, 'ved-containers')">–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã</button>
                    <button class="ved-subtab-button" onclick="switchVedSubtab(event, 'ved-receipts')">–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</button>
                    <button class="ved-subtab-button" onclick="switchVedSubtab(event, 'ved-supplies')">–ü–æ—Å—Ç–∞–≤–∫–∏</button>
                </div>

                <!-- –ü–æ–¥–≤–∫–ª–∞–¥–∫–∞: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã -->
                <div id="ved-containers" class="ved-subtab-content active">
                    <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->
                    <div id="ved-container-create-btn-wrapper" style="margin-bottom: 20px;">
                        <button class="wh-save-receipt-btn" onclick="showVedContainerForm()" style="display: flex; align-items: center; gap: 8px; padding: 12px 24px; font-size: 15px;">
                            <span style="font-size: 18px;">+</span> –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                        </button>
                    </div>

                    <!-- –§–æ—Ä–º–∞ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                    <div class="receipt-form" id="ved-container-form" style="display: none;">
                        <div class="receipt-form-header">
                            <!-- –ö—É—Ä—Å —é–∞–Ω—è –∏ –ø—Ä–æ—Ü–µ–Ω—Ç –∫ –ø–µ—Ä–µ–≤–æ–¥—É -->
                            <div class="ved-form-top-row">
                                <div class="ved-form-field-rate">
                                    <label>¬• –ö—É—Ä—Å —é–∞–Ω—è</label>
                                    <div class="wh-input" style="background: #f8f9fa; display: flex; align-items: center; justify-content: center; gap: 4px;">
                                        <span id="ved-rate-cny" style="font-weight: 600; font-size: 16px;">‚Äî</span>
                                        <span style="color: #666;">‚ÇΩ</span>
                                    </div>
                                </div>
                                <div class="ved-form-field-percent">
                                    <label>% –∫ –ø–µ—Ä–µ–≤–æ–¥—É <span style="color: #e74c3c;">*</span></label>
                                    <input type="number" id="ved-cny-percent" class="wh-input" style="text-align: center; font-weight: 600;" value="" step="0.1" min="0.1" placeholder="0.0" onchange="updateVedContainerTotals()">
                                </div>
                                <div class="ved-form-field-date">
                                    <label>–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞ <span style="color: #e74c3c;">*</span></label>
                                    <input type="date" id="ved-container-date" class="wh-input" style="cursor: pointer;" required>
                                </div>
                                <div class="ved-form-field-supplier">
                                    <label>–ü–æ—Å—Ç–∞–≤—â–∏–∫ <span style="color: #e74c3c;">*</span></label>
                                    <div class="destination-dropdown-wrapper">
                                        <input type="text" id="ved-container-supplier" class="wh-input" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ" autocomplete="off" onclick="toggleVedSupplierDropdown()" oninput="filterVedSuppliers()" required>
                                        <div class="destination-dropdown" id="ved-supplier-dropdown"></div>
                                        <button type="button" class="wh-add-btn-small" onclick="addNewVedSupplier()" title="–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫">+</button>
                                    </div>
                                </div>
                            </div>
                            <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏ –í–∞–∂–Ω–æ ‚Äî –≤—ã—Ä–æ–≤–Ω–µ–Ω—ã –ø–æ–¥ –î–∞—Ç–∞/–ü–æ—Å—Ç–∞–≤—â–∏–∫ -->
                            <div class="ved-form-bottom-fields">
                                <div style="margin-bottom: 10px;">
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500; font-size: 13px; color: #555;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                                    <input type="text" id="ved-container-comment" class="wh-input" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500; font-size: 13px; color: #555;">–í–∞–∂–Ω–æ <span style="color: #dc3545; font-size: 11px;">(–±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ)</span></label>
                                    <input type="text" id="ved-container-important" class="wh-input" placeholder="–í–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏, –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ" style="border-color: #ffc107;">
                                </div>
                            </div>
                        </div>

                        <div class="receipt-items-header">
                            <h4>–¢–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑–µ</h4>
                            <button class="wh-add-btn-small" onclick="addVedContainerItemRow()">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
                        </div>

                        <div class="wh-table-wrapper" style="overflow-x: auto;">
                            <table class="wh-table" id="ved-container-items-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">‚Ññ</th>
                                        <th style="min-width: 180px;">–¢–æ–≤–∞—Ä</th>
                                        <th style="min-width: 100px;">–ö–æ–ª-–≤–æ</th>
                                        <th style="min-width: 120px;">–¶–µ–Ω–∞ —à—Ç., ¬•</th>
                                        <th style="min-width: 140px;">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å, ¬•</th>
                                        <th style="min-width: 140px;">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å<br>—Ä—É–±, ‚ÇΩ</th>
                                        <th style="min-width: 110px;">–õ–æ–≥–∏—Å—Ç–∏–∫–∞<br>–†–§, ‚ÇΩ</th>
                                        <th style="min-width: 110px;">–õ–æ–≥–∏—Å—Ç–∏–∫–∞<br>–ö–ù–†, ‚ÇΩ</th>
                                        <th style="min-width: 130px;">–¢–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–µ<br>—Ä–∞—Å—Ö–æ–¥—ã, ‚ÇΩ</th>
                                        <th style="min-width: 120px;">–ü–æ—à–ª–∏–Ω–∞<br>–∏ –ù–î–°, ‚ÇΩ</th>
                                        <th style="min-width: 130px;">–í—Å—è<br>–ª–æ–≥–∏—Å—Ç–∏–∫–∞, ‚ÇΩ</th>
                                        <th style="width: 35px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="ved-container-items-tbody">
                                </tbody>
                                <tfoot id="ved-container-items-tfoot">
                                    <tr>
                                        <td colspan="2" style="text-align: right; font-weight: 600;">–ò—Ç–æ–≥–æ:</td>
                                        <td style="text-align: center; font-weight: 600;" id="ved-container-total-qty">0</td>
                                        <td></td>
                                        <td style="text-align: center; font-weight: 600;" id="ved-container-total-supplier">0 ¬•</td>
                                        <td style="text-align: center; font-weight: 600;" id="ved-container-total-cost">0 ‚ÇΩ</td>
                                        <td style="text-align: center; font-weight: 600;" id="ved-container-total-logrf">0 ‚ÇΩ</td>
                                        <td style="text-align: center; font-weight: 600;" id="ved-container-total-logcn">0 ‚ÇΩ</td>
                                        <td style="text-align: center; font-weight: 600;" id="ved-container-total-terminal">0 ‚ÇΩ</td>
                                        <td style="text-align: center; font-weight: 600;" id="ved-container-total-customs">0 ‚ÇΩ</td>
                                        <td style="text-align: center; font-weight: 600;" id="ved-container-total-alllog">0 ‚ÇΩ</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <!-- ========================================
                             –ë–õ–û–ö –ü–†–ò–ö–†–ï–ü–õ–ï–ù–ù–´–• –§–ê–ô–õ–û–í
                             ======================================== -->
                        <div id="ved-container-files-section" class="container-files-section">
                            <div class="container-files-header">
                                <h4 style="margin: 0; color: #333;">üìé –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</h4>
                                <label class="wh-add-btn-small" style="cursor: pointer; margin: 0;">
                                    + –î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª
                                    <input type="file" id="ved-container-file-input" style="display: none;" onchange="uploadVedContainerFile()" multiple>
                                </label>
                            </div>
                            <div id="ved-container-files-list" style="display: flex; flex-wrap: wrap; gap: 10px;">
                                <p id="ved-container-files-empty" style="color: #999; font-size: 13px; margin: 0;">–ù–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</p>
                            </div>
                        </div>

                        <!-- ========================================
                             –ë–õ–û–ö –°–û–û–ë–©–ï–ù–ò–ô –ö–û–ù–¢–ï–ô–ù–ï–†–ê
                             ======================================== -->
                        <div id="ved-container-messages-section" class="container-messages-section">
                            <h4 style="margin: 0 0 12px 0; color: #333;">üí¨ –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É</h4>

                            <!-- –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π (—Å–∫—Ä—ã—Ç–∞ –ø–æ–∫–∞ –Ω–µ—Ç ID) -->
                            <div id="ved-container-messages-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 16px; padding: 8px; background: #fff; border-radius: 4px; border: 1px solid #ddd; display: none;">
                            </div>

                            <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                            <div class="container-message-form">
                                <div class="container-msg-layout">
                                    <!-- –ß–µ–∫–±–æ–∫—Å—ã –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π -->
                                    <div class="container-msg-recipients">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 13px;">–ü–æ–ª—É—á–∞—Ç–µ–ª–∏:</label>
                                        <div id="ved-container-msg-recipients" style="display: flex; flex-direction: column; gap: 6px;">
                                            <span style="color: #999; font-size: 12px;">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                        </div>
                                    </div>
                                    <!-- –ü–æ–ª–µ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                                    <div class="container-msg-input">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 13px;">–°–æ–æ–±—â–µ–Ω–∏–µ:</label>
                                        <textarea id="ved-container-msg-text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="container-msg-textarea"></textarea>
                                        <!-- –ü—Ä–µ–≤—å—é –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
                                        <div id="ved-container-msg-files-preview" style="display: none; margin-top: 8px; flex-wrap: wrap; gap: 6px;"></div>
                                        <input type="file" id="ved-container-msg-file-input" style="display: none;" multiple
                                               accept=".pdf,.png,.jpg,.jpeg,.gif,.doc,.docx,.xls,.xlsx,.txt,.zip,.rar">
                                        <div class="container-msg-send" style="display: flex; gap: 8px; align-items: center;">
                                            <button type="button" onclick="document.getElementById('ved-container-msg-file-input').click()"
                                                    style="padding: 8px 12px; border: 1px solid #ddd; background: #f5f5f5; border-radius: 4px; cursor: pointer; font-size: 13px; white-space: nowrap;"
                                                    title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
                                                üìé –§–∞–π–ª
                                            </button>
                                            <button onclick="sendContainerMessage()" class="wh-save-receipt-btn container-msg-send-btn" style="flex: 1;">
                                                üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="receipt-form-actions">
                            <button class="wh-save-receipt-btn" onclick="saveVedContainer()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä</button>
                            <button class="wh-clear-btn" onclick="cancelVedContainer()">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </div>

                    <!-- –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ -->
                    <div class="receipt-history">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                            <label style="font-weight: 500; white-space: nowrap;">–§–∏–ª—å—Ç—Ä –ø–æ —Ç–æ–≤–∞—Ä—É:</label>
                            <select id="ved-containers-product-filter" class="wh-input" style="width: 250px;" onchange="loadVedContainersHistory()">
                                <option value="">–í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã</option>
                            </select>
                        </div>
                        <div class="wh-table-wrapper" id="ved-containers-history-wrapper" style="display: none; overflow-x: auto;">
                            <table class="wh-table" id="ved-containers-history-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">‚Ññ</th>
                                        <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                                        <th>–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞</th>
                                        <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                                        <th>–ö–æ–ª-–≤–æ</th>
                                        <th>–°–µ–±–µ—Å—Ç., ¬•</th>
                                        <th>–°–µ–±–µ—Å—Ç., ‚ÇΩ</th>
                                        <th>–õ–æ–≥. –†–§</th>
                                        <th>–õ–æ–≥. –ö–ù–†</th>
                                        <th>–¢–µ—Ä–º–∏–Ω–∞–ª</th>
                                        <th>–ü–æ—à–ª–∏–Ω–∞</th>
                                        <th>–í—Å—è –ª–æ–≥.</th>
                                        <th style="min-width: 300px; text-align: left;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                                        <th style="min-width: 250px; text-align: left;">–í–∞–∂–Ω–æ</th>
                                        <th>–ò–∑–º–µ–Ω–µ–Ω–æ</th>
                                        <th style="width: 70px;">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</th>
                                        <th style="width: 80px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="ved-containers-history-tbody">
                                </tbody>
                            </table>
                        </div>
                        <div class="wh-empty-state" id="ved-containers-history-empty">
                            <p>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤</p>
                        </div>
                    </div>
                </div>

                <!-- –ü–æ–¥–≤–∫–ª–∞–¥–∫–∞: –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è -->
                <div id="ved-receipts" class="ved-subtab-content">
                    <!-- –§–∏–ª—å—Ç—Ä—ã -->
                    <div class="ved-receipts-filter" style="margin-bottom: 15px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-weight: 500;">–ê—Ä—Ç–∏–∫—É–ª:</label>
                            <select id="ved-receipts-article-filter" class="wh-input" style="width: 200px;" onchange="filterVedReceipts()">
                                <option value="">–í—Å–µ –∞—Ä—Ç–∏–∫—É–ª—ã</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-weight: 500;">—Å:</label>
                            <input type="date" id="ved-receipts-date-from" class="wh-input" style="width: 140px; cursor: pointer;" onclick="this.showPicker()" onchange="filterVedReceipts()">
                            <label style="font-weight: 500;">–ø–æ:</label>
                            <input type="date" id="ved-receipts-date-to" class="wh-input" style="width: 140px; cursor: pointer;" onclick="this.showPicker()" onchange="filterVedReceipts()">
                            <button class="wh-clear-btn" onclick="resetVedReceiptsDateFilter()" style="padding: 6px 12px; font-size: 12px;">–°–±—Ä–æ—Å–∏—Ç—å</button>
                        </div>
                    </div>
                    <div class="wh-table-wrapper" id="ved-receipts-wrapper" style="display: none; overflow-x: auto;">
                        <table class="wh-table" id="ved-receipts-table">
                            <thead>
                                <tr id="ved-receipts-summary" style="background-color: #e8f4fd; font-weight: 600;">
                                    <th style="text-align: center;">‚Äî</th>
                                    <th style="text-align: center;">‚Äî</th>
                                    <th style="text-align: center;">–ò—Ç–æ–≥–æ:</th>
                                    <th id="ved-receipts-total-qty" style="text-align: center;">-</th>
                                    <th id="ved-receipts-avg-price" style="text-align: center;">-</th>
                                    <th id="ved-receipts-avg-cost" style="text-align: center;">-</th>
                                    <th id="ved-receipts-avg-log" style="text-align: center;">-</th>
                                </tr>
                                <tr>
                                    <th style="text-align: center; width: 50px;">‚Ññ</th>
                                    <th style="cursor: pointer; text-align: center;" onclick="sortVedReceiptsByDate()">–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞ <span id="ved-receipts-sort-icon">‚Üë</span></th>
                                    <th style="text-align: center;">–ê—Ä—Ç–∏–∫—É–ª</th>
                                    <th style="text-align: center;">–ö–æ–ª-–≤–æ</th>
                                    <th style="text-align: center;">–¶–µ–Ω–∞/—à—Ç., ¬•</th>
                                    <th style="text-align: center;">–°–µ–±–µ—Å—Ç./—à—Ç., ‚ÇΩ</th>
                                    <th style="text-align: center;">–õ–æ–≥./—à—Ç., ‚ÇΩ</th>
                                </tr>
                            </thead>
                            <tbody id="ved-receipts-tbody">
                            </tbody>
                        </table>
                    </div>
                    <div class="wh-empty-state" id="ved-receipts-empty">
                        <p>–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤</p>
                    </div>
                </div>
            
                <!-- –ü–æ–¥–≤–∫–ª–∞–¥–∫–∞: –ü–æ—Å—Ç–∞–≤–∫–∏ -->
                <div id="ved-supplies" class="ved-subtab-content">
                    <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è —Å–≤–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö -->
                <div style="margin-bottom: 10px;">
                    <button type="button" id="toggle-supplies-stats" onclick="toggleSuppliesStats()"
                            style="background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; padding: 8px 16px; cursor: pointer; font-size: 13px; color: #374151; display: flex; align-items: center; gap: 6px;">
                        <span id="supplies-stats-arrow" style="transition: transform 0.2s;">‚ñº</span>
                        <span id="supplies-stats-label">–°–∫—Ä—ã—Ç—å —Å–≤–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</span>
                    </button>
                </div>
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å—Ç–∞–≤–æ–∫ (—Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–∞—è) -->
                <div class="currency-rates-panel" id="supplies-stats-panel">
                    <!-- –í—Å–µ 9 –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –æ–¥–Ω—É –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é –ª–∏–Ω–∏—é -->
                    <div class="currency-rates-row supplies-stats-row" style="flex-wrap: wrap; gap: 6px;">
                        <div class="currency-rate-card" style="background:#fffbeb; border-color:#f59e0b;">
                            <span class="currency-label">–¢–æ–≤–∞—Ä –≤ –ø—É—Ç–∏</span>
                            <div><span class="currency-value" id="goods-in-transit-qty" style="color:#d97706;">‚Äî</span><span class="currency-rub" style="color:#92400e;">—à—Ç.</span></div>
                        </div>
                        <div class="currency-rate-card" style="background:#fffbeb; border-color:#f59e0b;">
                            <span class="currency-label">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ –ø—É—Ç–∏</span>
                            <div><span class="currency-value" id="goods-in-transit-cost" style="color:#d97706;">‚Äî</span><span class="currency-rub" style="color:#92400e;">‚ÇΩ</span></div>
                            <div style="font-size:11px;color:#92400e;margin-top:4px;border-top:1px solid #f59e0b;padding-top:3px;" id="goods-in-transit-cost-no6">–±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏ +6%: ‚Äî</div>
                        </div>
                        <div class="currency-rate-card" style="background:#fffbeb; border-color:#f59e0b;">
                            <span class="currency-label">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ –ø—É—Ç–∏ –±–µ–∑ –ª–æ–≥–∏—Å—Ç–∏–∫–∏</span>
                            <div><span class="currency-value" id="goods-in-transit-cost-no-log" style="color:#d97706;">‚Äî</span><span class="currency-rub" style="color:#92400e;">‚ÇΩ</span></div>
                            <div style="font-size:11px;color:#92400e;margin-top:4px;border-top:1px solid #f59e0b;padding-top:3px;" id="goods-in-transit-cost-no-log-no6">–±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏ +6%: ‚Äî</div>
                        </div>
                        <div class="currency-rate-card" style="background:#fffbeb; border-color:#f59e0b;">
                            <span class="currency-label">–õ–æ–≥–∏—Å—Ç–∏–∫–∞ –≤ –ø—É—Ç–∏</span>
                            <div><span class="currency-value" id="logistics-in-transit" style="color:#d97706;">‚Äî</span><span class="currency-rub" style="color:#92400e;">‚ÇΩ</span></div>
                            <div style="font-size:11px;color:#92400e;margin-top:4px;border-top:1px solid #f59e0b;padding-top:3px;" id="logistics-in-transit-no6">–±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏ +6%: ‚Äî</div>
                        </div>
                        <div class="currency-rate-card" style="background:#eff6ff; border-color:#3b82f6;">
                            <span class="currency-label">–ü–ª–∞–Ω –Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω</span>
                            <div><span class="currency-value" id="plan-not-delivered-qty" style="color:#2563eb;">‚Äî</span><span class="currency-rub" style="color:#1e40af;">—à—Ç.</span></div>
                        </div>
                        <div class="currency-rate-card" style="background:#eff6ff; border-color:#3b82f6;">
                            <span class="currency-label">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–ª–∞–Ω–∞</span>
                            <div><span class="currency-value" id="plan-not-delivered-cost" style="color:#2563eb;">‚Äî</span><span class="currency-rub" style="color:#1e40af;">‚ÇΩ</span></div>
                            <div style="font-size:11px;color:#1e40af;margin-top:4px;border-top:1px solid #3b82f6;padding-top:3px;" id="plan-cost-no6">–±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏ +6%: ‚Äî</div>
                        </div>
                        <div class="currency-rate-card" style="background:#eff6ff; border-color:#3b82f6;">
                            <span class="currency-label">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–ª–∞–Ω–∞ –±–µ–∑ –ª–æ–≥–∏—Å—Ç–∏–∫–∏</span>
                            <div><span class="currency-value" id="plan-not-delivered-cost-no-log" style="color:#2563eb;">‚Äî</span><span class="currency-rub" style="color:#1e40af;">‚ÇΩ</span></div>
                            <div style="font-size:11px;color:#1e40af;margin-top:4px;border-top:1px solid #3b82f6;padding-top:3px;" id="plan-cost-no-log-no6">–±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏ +6%: ‚Äî</div>
                        </div>
                        <div class="currency-rate-card" style="background:#eff6ff; border-color:#3b82f6;">
                            <span class="currency-label">–õ–æ–≥–∏—Å—Ç–∏–∫–∞ –ø–ª–∞–Ω</span>
                            <div><span class="currency-value" id="logistics-plan" style="color:#2563eb;">‚Äî</span><span class="currency-rub" style="color:#1e40af;">‚ÇΩ</span></div>
                            <div style="font-size:11px;color:#1e40af;margin-top:4px;border-top:1px solid #3b82f6;padding-top:3px;" id="logistics-plan-no6">–±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏ +6%: ‚Äî</div>
                        </div>
                        <div class="currency-rate-card" style="background:#f0fdf4; border-color:#22c55e;">
                            <span class="currency-label">–£–∂–µ –æ–ø–ª–∞—á–µ–Ω–Ω–∞—è –ª–æ–≥–∏—Å—Ç–∏–∫–∞</span>
                            <div><span class="currency-value" id="paid-logistics-total" style="color:#16a34a;">‚Äî</span><span class="currency-rub" style="color:#15803d;">‚ÇΩ</span></div>
                        </div>
                    </div>
                </div>

                <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Ç–æ–≤–∞—Ä—É -->
                <div class="supplies-filter-bar">
                    <label style="font-weight:500; font-size:13px; color:#555;">–§–∏–ª—å—Ç—Ä –ø–æ —Ç–æ–≤–∞—Ä—É:</label>
                    <select id="supplies-product-filter" class="supply-select" style="min-width:220px; border:1px solid #dee2e6;" onchange="filterSuppliesTable()">
                        <option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
                    </select>
                </div>

                <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ—Å—Ç–∞–≤–æ–∫ -->
                <div class="supplies-table-wrapper">
                    <div style="overflow-x: auto;">
                        <table class="supplies-table" id="supplies-table">
                            <thead>
                                <tr>
                                    <th>–¢–æ–≤–∞—Ä</th>
                                    <th class="sortable-date" data-col="1" onclick="sortSuppliesByDate(1)">–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞<br>—Å —Ñ–∞–±—Ä–∏–∫–∏ <span class="sort-arrow"></span></th>
                                    <th>–ö–æ–ª-–≤–æ –≤—ã—Ö–æ–¥–∞<br>—Å —Ñ–∞–±—Ä–∏–∫–∏</th>
                                    <th>–ö–æ–ª-–≤–æ –ø—Ä–∏—Ö–æ–¥–∞<br>–Ω–∞ —Å–∫–ª–∞–¥</th>
                                    <th title="–°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–∑ –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤. –ü–æ–¥ —á–µ—Ä—Ç–æ–π —É–∫–∞–∑–∞–Ω–∞ —Å—É–º–º–∞ –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç" style="cursor: help;">–õ–æ–≥–∏—Å—Ç–∏–∫–∞<br>–∑–∞ –µ–¥., ‚ÇΩ</th>
                                    <th title="–°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–∑ –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤. –ü–æ–¥ —á–µ—Ä—Ç–æ–π —É–∫–∞–∑–∞–Ω–∞ —Å—É–º–º–∞ –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç" style="cursor: help;">–¶–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞<br>–µ–¥–∏–Ω–∏—Ü–∞, ‚ÇΩ</th>
                                    <th>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å<br>—Ç–æ–≤–∞—Ä–∞ +6%, ‚ÇΩ</th>
                                </tr>
                                <tr class="supplies-totals-row" id="supplies-tfoot-row"></tr>
                            </thead>
                            <tbody id="supplies-tbody">
                            </tbody>
                        </table>
                    </div>
                    <!-- –°—Ç—Ä–æ–∫–∏ –ø–æ—Å—Ç–∞–≤–æ–∫ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –í–≠–î -->
                </div>
                </div>
            </div>

            <!-- –¢–ê–ë: –§–∏–Ω–∞–Ω—Å—ã ‚Äî —É—á—ë—Ç –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ -->
            <div id="finance" class="tab-content">

                <!-- –ü–æ–¥–≤–∫–ª–∞–¥–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤ -->
                <div class="finance-subtabs">
                    <button class="finance-subtab-btn active" onclick="switchFinanceSubtab(event, 'finance-records')">–î–î–°</button>
                    <button class="finance-subtab-btn" onclick="switchFinanceSubtab(event, 'finance-pendel')">P&amp;L</button>
                    <button class="finance-subtab-btn" onclick="switchFinanceSubtab(event, 'finance-realization')">–†–µ–∞–ª–∏–∑–∞—Ü–∏—è</button>
                    <button class="finance-subtab-btn" onclick="switchFinanceSubtab(event, 'finance-nds')">–ö–æ–Ω—Ç—Ä–æ–ª—å –ù–î–°</button>
                </div>

                <!-- –ü–æ–¥–≤–∫–ª–∞–¥–∫–∞: –ó–∞–ø–∏—Å–∏ (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç) -->
                <div id="finance-records" class="finance-subtab-content active">

                <!-- –°–≤–æ–¥–∫–∞: –¥–æ—Ö–æ–¥, —Ä–∞—Å—Ö–æ–¥, –±–∞–ª–∞–Ω—Å, –æ–ø–ª–∞—á–µ–Ω–æ —é–∞–Ω–µ–π -->
                <div class="finance-summary">
                    <div class="finance-summary-card income">
                        <div class="label">–î–æ—Ö–æ–¥</div>
                        <div class="value" id="finance-total-income">0 ‚ÇΩ</div>
                    </div>
                    <div class="finance-summary-card expense">
                        <div class="label">–†–∞—Å—Ö–æ–¥</div>
                        <div class="value" id="finance-total-expense">0 ‚ÇΩ</div>
                    </div>
                    <div class="finance-summary-card balance">
                        <div class="label">–ë–∞–ª–∞–Ω—Å</div>
                        <div class="value" id="finance-balance">0 ‚ÇΩ</div>
                    </div>
                    <div class="finance-summary-card yuan">
                        <div class="label">–û–ø–ª–∞—á–µ–Ω–æ —é–∞–Ω–µ–π</div>
                        <div class="value" id="finance-total-yuan">0 ¬•</div>
                        <div style="font-size: 13px; color: #888; margin-top: 4px;" id="finance-yuan-rubles-info"></div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏: –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å + —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞–º–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è admin) -->
                <div style="margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="wh-save-receipt-btn admin-only" onclick="showFinanceForm()"
                            style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; font-size: 15px;">
                        <span style="font-size: 18px;">+</span> –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
                    </button>
                    <button class="wh-clear-btn admin-only" onclick="toggleFinanceAccountsManager()"
                            style="display: inline-flex; align-items: center; gap: 6px; padding: 10px 18px; font-size: 14px;">
                        üè¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞–º–∏
                    </button>
                    <button class="wh-clear-btn admin-only" onclick="toggleFinanceCategoriesManager()"
                            style="display: inline-flex; align-items: center; gap: 6px; padding: 10px 18px; font-size: 14px;">
                        üè∑ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
                    </button>
                </div>

                <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–∞–º–∏ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                <div class="finance-form" id="finance-accounts-manager" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="margin: 0; color: #333;">üè¶ –°—á–µ—Ç–∞ / –ò—Å—Ç–æ—á–Ω–∏–∫–∏</h4>
                        <button class="wh-clear-btn" onclick="toggleFinanceAccountsManager()" style="padding: 4px 10px; font-size: 12px;">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                    <div id="finance-accounts-list" style="margin-bottom: 12px;"></div>
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="finance-new-account-name" class="wh-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å—á—ë—Ç–∞" style="flex: 1; max-width: 300px;">
                        <label class="finance-category-container-link">
                            <input type="checkbox" id="finance-new-account-requires-official">
                            –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥
                        </label>
                        <button class="wh-save-receipt-btn" onclick="addFinanceAccountFromManager()" style="padding: 8px 16px; font-size: 13px;">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </div>

                <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                <div class="finance-form" id="finance-categories-manager" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="margin: 0; color: #333;">üè∑ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h4>
                        <button class="wh-clear-btn" onclick="toggleFinanceCategoriesManager()" style="padding: 4px 10px; font-size: 12px;">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                    <div id="finance-categories-list" style="margin-bottom: 12px;"></div>
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="finance-new-category-name" class="wh-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" style="flex: 1; max-width: 300px;">
                        <select id="finance-new-category-type" class="wh-input" style="width: 140px; cursor: pointer;">
                            <option value="expense">üìâ –†–∞—Å—Ö–æ–¥</option>
                            <option value="income">üìà –î–æ—Ö–æ–¥</option>
                        </select>
                        <label class="finance-category-container-link">
                            <input type="checkbox" id="finance-new-category-container-linked">
                            –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º
                        </label>
                        <label class="finance-category-container-link">
                            <input type="checkbox" id="finance-new-category-requires-yuan">
                            –°—É–º–º–∞ –≤ —é–∞–Ω—è—Ö
                        </label>
                        <label class="finance-category-container-link">
                            <input type="checkbox" id="finance-new-category-requires-description">
                            –û–ø–∏—Å–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç.
                        </label>
                        <label class="finance-category-container-link">
                            <input type="checkbox" id="finance-new-category-plan-linked">
                            –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –ø–ª–∞–Ω—É
                        </label>
                        <input type="text" id="finance-new-category-description-hint" class="wh-input"
                               placeholder="–¢–µ–∫—Å—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è" style="padding: 6px 8px; font-size: 12px; width: 200px;">
                        <button class="wh-save-receipt-btn" onclick="addFinanceCategoryFromManager()" style="padding: 8px 16px; font-size: 13px;">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </div>

                <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                <div class="finance-form" id="finance-form" style="display: none;">
                    <div class="finance-form-row">
                        <div class="finance-form-field" style="flex: 0 0 160px;">
                            <label>–¢–∏–ø</label>
                            <select id="finance-type" class="wh-input" style="cursor: pointer;" onchange="onFinanceTypeChange()">
                                <option value="expense">üìâ –†–∞—Å—Ö–æ–¥</option>
                                <option value="income">üìà –î–æ—Ö–æ–¥</option>
                            </select>
                        </div>
                        <div class="finance-form-field" style="flex: 0 0 160px;">
                            <label>–°—É–º–º–∞, ‚ÇΩ</label>
                            <input type="number" id="finance-amount" class="wh-input" placeholder="0" min="0" step="0.01" oninput="updateFinanceDistributionTotals()">
                        </div>
                        <div class="finance-form-field" style="flex: 0 0 240px;">
                            <label>–°—á—ë—Ç / –ò—Å—Ç–æ—á–Ω–∏–∫</label>
                            <div class="destination-dropdown-wrapper">
                                <input type="text" id="finance-account-input" class="wh-input"
                                       placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ" autocomplete="off"
                                       onclick="toggleFinanceAccountDropdown()"
                                       oninput="filterFinanceAccounts()">
                                <div class="destination-dropdown" id="finance-account-dropdown"></div>
                            </div>
                        </div>
                        <div class="finance-form-field" style="flex: 0 0 220px;">
                            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                            <div class="destination-dropdown-wrapper">
                                <input type="text" id="finance-category-input" class="wh-input"
                                       placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ" autocomplete="off"
                                       onclick="toggleFinanceCategoryDropdown()"
                                       oninput="filterFinanceCategories()">
                                <div class="destination-dropdown" id="finance-category-dropdown"></div>
                            </div>
                        </div>
                        <div class="finance-form-field" style="flex: 0 0 160px;">
                            <label>–î–∞—Ç–∞</label>
                            <input type="date" id="finance-date" class="wh-input" style="cursor: pointer;" max="">
                        </div>
                        <div class="finance-form-field" id="finance-yuan-field" style="flex: 0 0 160px; display: none;">
                            <label>–°—É–º–º–∞, ¬•</label>
                            <input type="number" id="finance-yuan-amount" class="wh-input" placeholder="0" min="0" step="0.01" style="border-color: #f59e0b;">
                        </div>
                        <div class="finance-form-field" style="flex: 1; min-width: 200px;">
                            <label id="finance-description-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                            <input type="text" id="finance-description" class="wh-input"
                                   placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞–∫—É–ø–∫–∞ —É–ø–∞–∫–æ–≤–∫–∏">
                        </div>
                        <div class="finance-form-field" id="finance-official-field" style="flex: 0 0 220px; display: none;">
                            <label>–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥?</label>
                            <div style="display: flex; gap: 16px; padding-top: 6px;">
                                <label style="cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 14px;">
                                    <input type="radio" name="finance-is-official" value="1" style="cursor: pointer;"> –î–∞
                                </label>
                                <label style="cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 14px;">
                                    <input type="radio" name="finance-is-official" value="0" style="cursor: pointer;"> –ù–µ—Ç
                                </label>
                            </div>
                        </div>
                        <div class="finance-form-field" style="flex: 0 0 200px;">
                            <label>–§–∞–π–ª—ã</label>
                            <input type="file" id="finance-files" class="wh-input" multiple
                                   accept=".pdf,.png,.jpg,.jpeg,.gif,.doc,.docx,.xls,.xlsx,.txt,.zip,.rar"
                                   style="padding: 6px; font-size: 12px;">
                        </div>
                    </div>
                    <div id="finance-existing-files" style="display: none; margin: 8px 0; padding: 8px 12px; background: #f8f9fa; border-radius: 8px;">
                        <label style="font-size: 13px; color: #666; margin-bottom: 6px; display: block;">–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:</label>
                        <div id="finance-existing-files-list"></div>
                    </div>
                    <!-- –°–µ–∫—Ü–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º (–≤–∏–¥–Ω–∞ –ø—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö) -->
                    <div id="finance-container-section" style="display: none;">
                        <div class="finance-container-section-header">
                            <h4>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º</h4>
                            <button type="button" class="finance-add-container-btn" onclick="addFinanceContainerBlock()">+ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä</button>
                        </div>
                        <div id="finance-dist-remaining" class="finance-dist-remaining" style="display: none;">
                            –û—Å—Ç–∞–ª–æ—Å—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å: <strong id="finance-dist-remaining-amount">0 ‚ÇΩ</strong>
                        </div>
                        <div id="finance-container-blocks"></div>
                    </div>

                    <!-- –°–µ–∫—Ü–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –ø–ª–∞–Ω—É –∑–∞–∫—É–ø–æ–∫ (–≤–∏–¥–Ω–∞ –ø—Ä–∏ –ø–ª–∞–Ω-–ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö) -->
                    <div id="finance-plan-section" style="display: none;">
                        <div class="finance-container-section-header">
                            <h4>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø–ª–∞–Ω—É –∑–∞–∫—É–ø–æ–∫</h4>
                        </div>
                        <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 10px; flex-wrap: wrap;">
                            <select id="finance-plan-product" class="wh-input" onchange="onFinancePlanProductSelect()" style="max-width: 300px;">
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä --</option>
                            </select>
                            <select id="finance-plan-target" class="wh-input" onchange="onFinancePlanTargetChange()" style="width: 200px;">
                                <option value="invoice">–û–ø–ª–∞—á–µ–Ω–æ –∏–Ω–≤–æ–π—Å</option>
                                <option value="delta">–û–ø–ª–∞—á–µ–Ω–æ –¥–µ–ª—å—Ç–∞</option>
                            </select>
                            <button type="button" class="finance-add-container-btn" onclick="autoDistributeFinancePlan()">–ê–≤—Ç–æ-—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å</button>
                        </div>
                        <div id="finance-plan-dist-remaining" class="finance-dist-remaining" style="display: none;">
                            –û—Å—Ç–∞–ª–æ—Å—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å: <strong id="finance-plan-dist-remaining-amount">0 ¬•</strong>
                        </div>
                        <div id="finance-plan-rows"></div>
                    </div>

                    <div class="finance-form-actions">
                        <button class="wh-save-receipt-btn" id="finance-save-btn" onclick="saveFinanceRecord()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button class="wh-clear-btn" onclick="cancelFinanceForm()">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>

                <!-- –§–∏–ª—å—Ç—Ä—ã -->
                <div class="finance-filters">
                    <label>–¢–∏–ø:</label>
                    <select id="finance-filter-type" style="width: 140px;" onchange="onFinanceFilterTypeChange()">
                        <option value="">–í—Å–µ</option>
                        <option value="income">üìà –î–æ—Ö–æ–¥</option>
                        <option value="expense">üìâ –†–∞—Å—Ö–æ–¥</option>
                    </select>
                    <span class="finance-filter-sep">|</span>

                    <label>–°—á—ë—Ç:</label>
                    <select id="finance-filter-account" style="width: 180px;" onchange="loadFinanceRecords()">
                        <option value="">–í—Å–µ —Å—á–µ—Ç–∞</option>
                    </select>
                    <span class="finance-filter-sep">|</span>

                    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                    <select id="finance-filter-category" style="width: 180px;" onchange="loadFinanceRecords()">
                        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    </select>
                    <span class="finance-filter-sep">|</span>

                    <label>–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π:</label>
                    <select id="finance-filter-official" style="width: 140px;" onchange="loadFinanceRecords()">
                        <option value="">–í—Å–µ</option>
                        <option value="1">‚úÖ –î–∞</option>
                        <option value="0">‚ùå –ù–µ—Ç</option>
                    </select>
                    <span class="finance-filter-sep">|</span>

                    <label>–ü–µ—Ä–∏–æ–¥:</label>
                    <select id="finance-period" style="width: 180px;" onchange="applyFinancePeriod(); loadFinanceRecords()">
                        <option value="month">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</option>
                        <option value="prev_month">–ü—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü</option>
                        <option value="q1">1 –∫–≤–∞—Ä—Ç–∞–ª</option>
                        <option value="q2">2 –∫–≤–∞—Ä—Ç–∞–ª</option>
                        <option value="q3">3 –∫–≤–∞—Ä—Ç–∞–ª</option>
                        <option value="q4">4 –∫–≤–∞—Ä—Ç–∞–ª</option>
                        <option value="year">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥</option>
                        <option value="all">–í—Å—è –∏—Å—Ç–æ—Ä–∏—è</option>
                        <option value="custom">–°–≤–æ–π –ø–µ—Ä–∏–æ–¥...</option>
                    </select>
                    <input type="date" id="finance-date-from" style="width: 140px; display: none;" onchange="loadFinanceRecords()">
                    <span id="finance-date-sep" style="color: #999; display: none;">‚Äî</span>
                    <input type="date" id="finance-date-to" style="width: 140px; display: none;" onchange="loadFinanceRecords()">


                    <button class="wh-clear-btn" onclick="resetFinanceFilters()" style="padding: 6px 14px; font-size: 12px;">–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>

                <!-- –¢–∞–±–ª–∏—Ü–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π -->
                <div class="wh-table-wrapper" id="finance-table-wrapper" style="display: none;">
                    <table class="wh-table" id="finance-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">‚Ññ</th>
                                <th style="width: 110px;">–î–∞—Ç–∞</th>
                                <th style="width: 100px;">–¢–∏–ø</th>
                                <th style="width: 90px;">–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π</th>
                                <th style="width: 120px;">–°—É–º–º–∞</th>
                                <th style="width: 100px;">–Æ–∞–Ω–∏</th>
                                <th style="width: 140px; text-align: left;">–°—á—ë—Ç / –ò—Å—Ç–æ—á–Ω–∏–∫</th>
                                <th style="width: 140px; text-align: left;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                <th style="text-align: left;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                                <th style="width: 50px;">–§–∞–π–ª—ã</th>
                                <th style="width: 120px;">–°–æ–∑–¥–∞–ª</th>
                                <th style="width: 100px;">–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                                <th style="width: 80px;" class="admin-only"></th>
                            </tr>
                        </thead>
                        <tbody id="finance-tbody"></tbody>
                    </table>
                </div>

                <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
                <div class="wh-empty-state" id="finance-empty">
                    <p>–ù–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π</p>
                    <p style="font-size: 13px; color: #bbb; margin-top: 8px;">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å –∫–Ω–æ–ø–∫–æ–π –≤—ã—à–µ –∏–ª–∏ —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞</p>
                </div>

                </div><!-- /finance-records -->

                <!-- –ü–æ–¥–≤–∫–ª–∞–¥–∫–∞: –ü–µ–Ω–¥–µ–ª—å ‚Äî —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
                <div id="finance-pendel" class="finance-subtab-content">
                    <!-- –§–∏–ª—å—Ç—Ä—ã –ø–æ –¥–∞—Ç–µ -->
                    <div class="pendel-filters">
                        <input type="date" id="pendel-date-from" class="date-filter-input" onclick="this.showPicker()" onchange="loadPendelData()">
                        <span class="date-separator">‚Äî</span>
                        <input type="date" id="pendel-date-to" class="date-filter-input" onclick="this.showPicker()" onchange="loadPendelData()">
                        <button class="pendel-filter-btn reset" onclick="resetPendelFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                    </div>
                    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –∏—Ç–æ–≥–æ–≤ -->
                    <div class="pendel-summary-cards">
                        <div class="pendel-summary-card total-expense">
                            <div class="label">–û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥</div>
                            <div class="value" id="pendel-total-expense">0 ‚ÇΩ</div>
                        </div>
                        <div class="pendel-summary-card cat-count">
                            <div class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏–π</div>
                            <div class="value" id="pendel-cat-count">0</div>
                        </div>
                    </div>
                    <!-- –¢–∞–±–ª–∏—Ü–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–æ–º -->
                    <div id="pendel-table-wrapper" style="display: none;">
                        <table class="pendel-table">
                            <thead>
                                <tr>
                                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                    <th style="width: 160px;">–°—É–º–º–∞</th>
                                    <th style="width: 100px;">–ó–∞–ø–∏—Å–µ–π</th>
                                    <th style="width: 60px;"></th>
                                </tr>
                            </thead>
                            <tbody id="pendel-tbody"></tbody>
                        </table>
                    </div>
                    <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
                    <div class="pendel-empty" id="pendel-empty" style="display: none;">
                        <p>–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>
                    </div>
                </div><!-- /finance-pendel -->

                <!-- –ü–æ–¥–≤–∫–ª–∞–¥–∫–∞: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî –∞–∫—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–∑ Ozon /v2/finance/realization -->
                <div id="finance-realization" class="finance-subtab-content">

                    <!-- –§–∏–ª—å—Ç—Ä: –≤—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ (–¥–Ω–∏ / –º–µ—Å—è—Ü / –∫–≤–∞—Ä—Ç–∞–ª) -->
                    <div class="real-filters">
                        <div class="real-filter-group">
                            <label class="real-filter-label">–ü–µ—Ä–∏–æ–¥:</label>
                            <select id="real-period-type" class="real-period-type" onchange="toggleRealPeriodType()">
                                <option value="days">–î–Ω–∏</option>
                                <option value="month">–ú–µ—Å—è—Ü</option>
                                <option value="quarter">–ö–≤–∞—Ä—Ç–∞–ª</option>
                            </select>
                        </div>
                        <div class="real-filter-group" id="real-days-group">
                            <label class="real-filter-label">—Å:</label>
                            <input type="date" id="real-date-from" class="date-filter-input" onclick="this.showPicker()" onchange="loadRealizationData()">
                            <label class="real-filter-label">–ø–æ:</label>
                            <input type="date" id="real-date-to" class="date-filter-input" onclick="this.showPicker()" onchange="loadRealizationData()">
                        </div>
                        <div class="real-filter-group" id="real-month-group" style="display: none;">
                            <select id="real-month-select" class="real-month-select" onchange="loadRealizationData()"></select>
                        </div>
                        <div class="real-filter-group" id="real-quarter-group" style="display: none;">
                            <select id="real-quarter-select" class="real-month-select" onchange="loadRealizationData()"></select>
                        </div>
                    </div>

                    <!-- –°–≤–æ–¥–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
                    <div class="real-summary" id="real-summary" style="display: none;">
                        <div class="real-card real-card-profit" id="real-profit-card" style="display:none;">
                            <div class="real-card-label">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å / –ü—Ä–∏–±—ã–ª—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É <span onclick="event.stopPropagation();alert('–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å / –ü—Ä–∏–±—ã–ª—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É –ø—Ä–æ–¥–∞–∂\\n(–±–µ–∑ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤)\\n\\n–ü—Ä–æ–¥–∞–∂–∏ –¥–æ –°–ü–ü ‚àí –†–µ–∫–ª–∞–º–∞ ‚àí –ù–∞–ª–æ–≥–∏ ‚àí –õ–æ–≥–∏—Å—Ç–∏–∫–∞ ‚àí –ö–æ–º–∏—Å—Å–∏—è ‚àí –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å ‚àí –ò–Ω—ã–µ —É–¥–µ—Ä–∂–∞–Ω–∏—è ‚àí –•—Ä–∞–Ω–µ–Ω–∏–µ + –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ ‚àí –ë–∞–ª–ª—ã –∑–∞ –æ—Ç–∑—ã–≤—ã\\n\\n–ü—Ä–∏–±—ã–ª—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É = –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å / –ö–æ–ª-–≤–æ –ø—Ä–æ–¥–∞–∂')" style="display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;background:#e0e0e0;color:#666;font-size:11px;cursor:pointer;margin-left:4px;font-weight:700;" title="–ü–æ–¥—Ä–æ–±–Ω–µ–µ">?</span></div>
                            <div class="real-card-value" id="real-profit-total">0 ‚ÇΩ</div>
                            <div class="real-card-hint" id="real-profit-hint"></div>
                        </div>
                        <div class="real-card real-card-realization">
                            <div class="real-card-label">–ü—Ä–æ–¥–∞–∂–∏ –ø–æ—Å–ª–µ –°–ü–ü <span onclick="alert('–°—É–º–º–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ –∞–∫—Ç—É —Å –º–µ—Ö–∞–Ω–∏–∫–æ–π –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ + —Å—É–º–º–∞ –ø—Ä–æ–¥–∞–∂ –°–ù–ì - –≤–æ–∑–≤—Ä–∞—Ç—ã —Å –º–µ—Ö–∞–Ω–∏–∫–æ–π –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏')" style="display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;background:#e0e0e0;color:#666;font-size:11px;cursor:pointer;margin-left:4px;font-weight:700;" title="–ü–æ–¥—Ä–æ–±–Ω–µ–µ">?</span></div>
                            <div class="real-card-value" id="real-realization">0 ‚ÇΩ</div>
                            <div class="real-card-hint" id="real-realization-hint"></div>
                        </div>
                        <div class="real-card real-card-sales">
                            <div class="real-card-label">–†–µ–∞–ª–∏–∑–∞—Ü–∏—è <span onclick="alert('–ò—Ç–æ–≥–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø–æ –∞–∫—Ç—É (seller_price √ó –∫–æ–ª-–≤–æ) + –ø—Ä–æ–¥–∞–∂–∏ –°–ù–ì - –≤–æ–∑–≤—Ä–∞—Ç—ã (seller_price √ó –∫–æ–ª-–≤–æ)')" style="display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;background:#e0e0e0;color:#666;font-size:11px;cursor:pointer;margin-left:4px;font-weight:700;" title="–ü–æ–¥—Ä–æ–±–Ω–µ–µ">?</span></div>
                            <div class="real-card-value" id="real-gross-sales">0 ‚ÇΩ</div>
                            <div class="real-card-hint" id="real-gross-hint"></div>
                        </div>
                        <div class="real-card real-card-compensations" id="real-compensations-card" style="display:none;" onclick="toggleCardDetails(this)">
                            <div class="real-card-header">
                                <div class="real-card-label">–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏</div>
                                <span class="real-card-badge" id="real-compensations-badge"></span>
                            </div>
                            <div class="real-card-value" id="real-compensations-total">0 ‚ÇΩ</div>
                            <div class="real-card-details" id="real-compensations-details"></div>
                        </div>
                        <div class="real-card real-card-returns">
                            <div class="real-card-label">–í–æ–∑–≤—Ä–∞—Ç—ã</div>
                            <div class="real-card-value" id="real-returns">0 ‚ÇΩ</div>
                            <div class="real-card-hint" id="real-returns-hint"></div>
                        </div>
                        <div class="real-card real-card-commission" onclick="toggleCardDetails(this)">
                            <div class="real-card-header">
                                <div class="real-card-label">–ö–æ–º–∏—Å—Å–∏—è –ú–ü <span onclick="event.stopPropagation();alert('–ë–∞–∑–æ–≤–æ–µ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ - –≤–æ–∑–≤—Ä–∞—Ç—ã –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è + –∫–æ–º–∏—Å—Å–∏—è –°–ù–ì + —ç–∫–≤–∞–π—Ä–∏–Ω–≥')" style="display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;background:#e0e0e0;color:#666;font-size:11px;cursor:pointer;margin-left:4px;font-weight:700;" title="–ü–æ–¥—Ä–æ–±–Ω–µ–µ">?</span></div>
                                <span class="real-card-badge" id="real-commission-badge"></span>
                            </div>
                            <div class="real-card-value" id="real-commission">0 ‚ÇΩ</div>
                            <div class="real-card-hint" id="real-commission-hint"></div>
                            <div class="real-card-details" id="real-commission-details"></div>
                        </div>
                        <div class="real-card real-card-logistics" id="real-logistics-card" style="display:none;" onclick="toggleCardDetails(this)">
                            <div class="real-card-header">
                                <div class="real-card-label">–õ–æ–≥–∏—Å—Ç–∏–∫–∞</div>
                                <span class="real-card-badge" id="real-logistics-badge"></span>
                            </div>
                            <div class="real-card-value" id="real-logistics-total">0 ‚ÇΩ</div>
                            <div class="real-card-details" id="real-logistics-details"></div>
                        </div>
                        <div class="real-card real-card-other-deductions" id="real-other-deductions-card" style="display:none;" onclick="toggleCardDetails(this)">
                            <div class="real-card-header">
                                <div class="real-card-label">–ò–Ω—ã–µ —É–¥–µ—Ä–∂–∞–Ω–∏—è</div>
                                <span class="real-card-badge" id="real-other-deductions-badge"></span>
                            </div>
                            <div class="real-card-value" id="real-other-deductions-total">0 ‚ÇΩ</div>
                            <div class="real-card-details" id="real-other-deductions-details"></div>
                        </div>
                        <div class="real-card real-card-advertising" id="real-advertising-card" style="display:none;" onclick="toggleCardDetails(this)">
                            <div class="real-card-header">
                                <div class="real-card-label">–†–µ–∫–ª–∞–º–∞</div>
                                <span class="real-card-badge" id="real-advertising-badge"></span>
                            </div>
                            <div class="real-card-value" id="real-advertising-total">0 ‚ÇΩ</div>
                            <div class="real-card-details" id="real-advertising-details"></div>
                        </div>
                        <div class="real-card real-card-storage" id="real-storage-card" style="display:none;" onclick="toggleCardDetails(this)">
                            <div class="real-card-header">
                                <div class="real-card-label">–•—Ä–∞–Ω–µ–Ω–∏–µ</div>
                                <span class="real-card-badge" id="real-storage-badge"></span>
                            </div>
                            <div class="real-card-value" id="real-storage-total">0 ‚ÇΩ</div>
                            <div class="real-card-details" id="real-storage-details"></div>
                        </div>
                        <div class="real-card real-card-cogs" id="real-cogs-card" style="display:none;">
                            <div class="real-card-label">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å <span onclick="alert('–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ –º–µ—Ç–æ–¥—É FIFO (–ø–µ—Ä–≤—ã–π –ø—Ä–∏—à—ë–ª ‚Äî –ø–µ—Ä–≤—ã–π —É—à—ë–ª) –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–∏—Ö–æ–¥–∞—Ö –Ω–∞ —Å–∫–ª–∞–¥. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ü–µ–Ω—ã: —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–∑ –ø–æ—Å—Ç–∞–≤–æ–∫ (+6%) ‚Üí —Ä—É—á–Ω–∞—è —Ü–µ–Ω–∞ –ø—Ä–∏—Ö–æ–¥–∞. –ü—Ä–æ–¥–∞–∂–∏ –ø—Ä–æ—à–ª—ã—Ö –º–µ—Å—è—Ü–µ–≤ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è, —Ç–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø–æ —Å–∞–º—ã–º —Å—Ç–∞—Ä—ã–º –ø—Ä–∏—Ö–æ–¥–∞–º.')" style="display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;background:#e0e0e0;color:#666;font-size:11px;cursor:pointer;margin-left:4px;font-weight:700;" title="–ü–æ–¥—Ä–æ–±–Ω–µ–µ">?</span></div>
                            <div class="real-card-value" id="real-cogs-total">0 ‚ÇΩ</div>
                            <div class="real-card-hint" id="real-cogs-hint"></div>
                        </div>
                        <div class="real-card real-card-opex" id="real-opex-card" style="display:none;cursor:pointer;" onclick="toggleCardDetails(this)">
                            <div class="real-card-header">
                                <div class="real-card-label">–†–∞—Å—Ö–æ–¥—ã –∫ –≤—ã—á–µ—Ç—É <span onclick="event.stopPropagation();alert('–°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏–∑ –≤–∫–ª–∞–¥–∫–∏ –î–î–° —Å –æ—Ç–º–µ—Ç–∫–æ–π ¬´–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥¬ª (–∑–µ–ª—ë–Ω—ã–π —á–µ–∫–±–æ–∫—Å) –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.')" style="display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;background:#e0e0e0;color:#666;font-size:11px;cursor:pointer;margin-left:4px;font-weight:700;" title="–ü–æ–¥—Ä–æ–±–Ω–µ–µ">?</span></div>
                                <span class="real-card-badge" id="real-opex-badge"></span>
                            </div>
                            <div class="real-card-value" id="real-opex-total">0 ‚ÇΩ</div>
                            <div class="real-card-hint" id="real-opex-hint"></div>
                            <div class="real-card-details" id="real-opex-details"></div>
                        </div>
                        <div class="real-card real-card-tax" id="real-tax-card" style="display:none;" onclick="toggleCardDetails(this)">
                            <div class="real-card-header">
                                <div class="real-card-label">–ù–∞–ª–æ–≥–∏ <span id="real-tax-question" onclick="event.stopPropagation();" style="display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;background:#e0e0e0;color:#666;font-size:11px;cursor:pointer;margin-left:4px;font-weight:700;" title="–ü–æ–¥—Ä–æ–±–Ω–µ–µ">?</span></div>
                                <span class="real-card-badge" id="real-tax-badge"></span>
                            </div>
                            <div class="real-card-value" id="real-tax-total">0 ‚ÇΩ</div>
                            <div class="real-card-hint" id="real-tax-hint"></div>
                            <div class="real-card-details" id="real-tax-details"></div>
                        </div>
                    </div>

                    <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ —Ç–æ–≤–∞—Ä–∞–º (SKU) -->
                    <div class="real-products-wrapper" id="real-products-wrapper" style="display: none;">
                        <div style="overflow-x: auto;">
                            <table class="real-types-table">
                                <thead>
                                    <tr>
                                        <th style="text-align:left">–ê—Ä—Ç–∏–∫—É–ª</th>
                                        <th style="text-align:right">–¶–µ–Ω–∞<br>–≤ –õ–ö</th>
                                        <th style="text-align:right">–†–µ–∞–ª–∏–∑–∞—Ü–∏—è</th>
                                        <th style="text-align:right">–°–ü–ü /<br>—Å–æ–∏–Ω–≤–µ—Å—Ç</th>
                                        <th style="text-align:right">–†–µ–∫–ª–∞–º–∞</th>
                                        <th style="text-align:right">–ù–∞–ª–æ–≥–∏</th>
                                        <th style="text-align:right">–õ–æ–≥–∏—Å—Ç–∏–∫–∞</th>
                                        <th style="text-align:right">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</th>
                                        <th style="text-align:right">–†–∞—Å—Ö–æ–¥—ã<br>–∫ –≤—ã—á–µ—Ç—É</th>
                                        <th style="text-align:right">–ò–Ω—ã–µ<br>—É–¥–µ—Ä–∂–∞–Ω–∏—è</th>
                                        <th style="text-align:right">–ö–æ–º–∏—Å—Å–∏—è<br>+ —ç–∫–≤–∞–π—Ä–∏–Ω–≥ %</th>
                                        <th style="text-align:right">–ü—Ä–æ–¥–∞–∂–∏</th>
                                        <th style="text-align:right">–í–æ–∑–≤—Ä–∞—Ç—ã</th>
                                        <th style="text-align:right">–ö–æ–º–∏—Å—Å–∏—è<br>+ —ç–∫–≤–∞–π—Ä–∏–Ω–≥</th>
                                        <th style="text-align:right">–ë–∞–ª–ª—ã<br>–∑–∞ —Å–∫–∏–¥–∫–∏</th>
                                        <th style="text-align:right">–ß–∏—Å—Ç–∞—è<br>–ø—Ä–∏–±—ã–ª—å</th>
                                    </tr>
                                    <tr id="real-products-summary" style="display:none;"></tr>
                                </thead>
                                <tbody id="real-products-tbody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- –°–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Ä—Ç–æ—á–∫–æ–π –õ–æ–≥–∏—Å—Ç–∏–∫–∞) -->
                    <div id="real-transactions-wrapper" style="display: none;"></div>

                    <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
                    <div class="real-empty" id="real-empty" style="display: none;">
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏</p>
                        <p style="font-size: 13px; color: #bbb; margin-top: 8px;">–ê–∫—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ ‚Äî –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ù–∞—á–∏—Å–ª–µ–Ω–∏—è¬ª –∫–∞–±–∏–Ω–µ—Ç–∞ Ozon</p>
                    </div>

                    <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ -->
                    <div class="real-loading" id="real-loading" style="display: none;">
                        <div class="real-spinner"></div>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–∑ Ozon...</p>
                        <p style="font-size: 12px; color: #999;">–û–±—ã—á–Ω–æ –∑–∞–Ω–∏–º–∞–µ—Ç 3-5 —Å–µ–∫—É–Ω–¥</p>
                    </div>

                    <!-- –û—à–∏–±–∫–∞ -->
                    <div class="real-error" id="real-error" style="display: none;">
                        <p id="real-error-text">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>
                    </div>

                </div><!-- /finance-realization -->

                <div id="finance-nds" class="finance-subtab-content">
                    <div style="max-width:700px;padding:20px;">
                        <div id="nds-row-1" style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                            <span style="min-width:50px;font-weight:600;font-size:14px;color:#333;">–ù–î–°</span>
                            <div style="display:flex;align-items:center;gap:4px;">
                                <input type="number" id="nds-row1-percent" class="date-filter-input" style="width:80px;" placeholder="0" step="any" disabled>
                                <span style="color:#888;font-size:14px;">%</span>
                            </div>
                            <span style="color:#888;font-size:14px;">–¥–æ</span>
                            <div style="display:flex;align-items:center;gap:4px;">
                                <input type="text" id="nds-row1-amount" class="date-filter-input" style="width:140px;" placeholder="0" disabled oninput="ndsFormatAmount(this)">
                                <span style="color:#888;font-size:14px;">‚ÇΩ</span>
                            </div>
                            <span id="nds-pen-1" onclick="ndsStartEdit(1)" style="cursor:pointer;font-size:16px;color:#888;margin-left:4px;" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">&#9998;</span>
                            <span id="nds-actions-1" style="display:none;margin-left:4px;display:none;gap:6px;">
                                <button onclick="ndsSave(1)" style="padding:4px 12px;font-size:13px;background:#667eea;color:#fff;border:none;border-radius:6px;cursor:pointer;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                <button onclick="ndsCancel(1)" style="padding:4px 12px;font-size:13px;background:#e9ecef;color:#333;border:none;border-radius:6px;cursor:pointer;">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                            </span>
                        </div>
                        <div id="nds-row-2" style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                            <span style="min-width:50px;font-weight:600;font-size:14px;color:#333;">–ù–î–°</span>
                            <div style="display:flex;align-items:center;gap:4px;">
                                <input type="number" id="nds-row2-percent" class="date-filter-input" style="width:80px;" placeholder="0" step="any" disabled>
                                <span style="color:#888;font-size:14px;">%</span>
                            </div>
                            <span style="color:#888;font-size:14px;">–¥–æ</span>
                            <div style="display:flex;align-items:center;gap:4px;">
                                <input type="text" id="nds-row2-amount" class="date-filter-input" style="width:140px;" placeholder="0" disabled oninput="ndsFormatAmount(this)">
                                <span style="color:#888;font-size:14px;">‚ÇΩ</span>
                            </div>
                            <span id="nds-pen-2" onclick="ndsStartEdit(2)" style="cursor:pointer;font-size:16px;color:#888;margin-left:4px;" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">&#9998;</span>
                            <span id="nds-actions-2" style="display:none;margin-left:4px;display:none;gap:6px;">
                                <button onclick="ndsSave(2)" style="padding:4px 12px;font-size:13px;background:#667eea;color:#fff;border:none;border-radius:6px;cursor:pointer;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                <button onclick="ndsCancel(2)" style="padding:4px 12px;font-size:13px;background:#e9ecef;color:#333;border:none;border-radius:6px;cursor:pointer;">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                            </span>
                        </div>

                        <!-- –ò—Ç–æ–≥–æ —Å 1 —è–Ω–≤–∞—Ä—è (–∞–≤—Ç–æ-–∑–∞–≥—Ä—É–∑–∫–∞) -->
                        <div style="border-top:1px solid #e9ecef;margin:20px 0 16px;"></div>
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <span style="font-weight:700;font-size:15px;color:#333;">–û–±–æ—Ä–æ—Ç —Å 1 —è–Ω–≤–∞—Ä—è</span>
                            <span id="nds-ytd-loading" style="color:#888;font-size:13px;">–∑–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <div id="nds-ytd-result" style="display:none;padding:0 0 4px;">
                            <div style="display:flex;justify-content:space-between;font-size:15px;">
                                <span style="color:#555;">–ò—Ç–æ–≥–æ</span>
                                <span style="font-weight:700;color:#333;" id="nds-ytd-total">0 ‚ÇΩ</span>
                            </div>
                        </div>

                        <!-- –û–±—â–∏–π –æ–±–æ—Ä–æ—Ç —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –¥–∞—Ç -->
                        <div style="border-top:1px solid #e9ecef;margin:16px 0 16px;"></div>
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap;">
                            <span style="font-weight:600;font-size:14px;color:#333;">–û–±—â–∏–π –æ–±–æ—Ä–æ—Ç</span>
                            <span style="color:#888;font-size:13px;">—Å</span>
                            <input type="date" id="nds-turnover-date-from" class="date-filter-input" style="width:150px;" onclick="this.showPicker()" onchange="ndsLoadTurnover()">
                            <span style="color:#888;font-size:13px;">–ø–æ</span>
                            <input type="date" id="nds-turnover-date-to" class="date-filter-input" style="width:150px;" onclick="this.showPicker()" onchange="ndsLoadTurnover()">
                        </div>
                        <div id="nds-turnover-loading" style="display:none;color:#888;font-size:13px;padding:8px 0;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        <div id="nds-turnover-result" style="display:none;padding:8px 0;">
                            <div style="display:flex;flex-direction:column;gap:8px;">
                                <div>
                                    <div onclick="document.getElementById('nds-turnover-dds-details').classList.toggle('open')" style="display:flex;justify-content:space-between;font-size:14px;cursor:pointer;">
                                        <span style="color:#555;">–ü—Ä–∏—Ö–æ–¥—ã (–î–î–°) <span style="font-size:11px;color:#aaa;">&#9660;</span></span>
                                        <span style="font-weight:600;color:#27ae60;" id="nds-turnover-dds">0 ‚ÇΩ</span>
                                    </div>
                                    <div id="nds-turnover-dds-details" class="real-card-details" style="margin-top:6px;padding-top:6px;"></div>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-size:14px;">
                                    <span style="color:#555;">–ü—Ä–æ–¥–∞–∂–∏ –ø–æ—Å–ª–µ –°–ü–ü (–†–µ–∞–ª–∏–∑–∞—Ü–∏—è)</span>
                                    <span style="font-weight:600;color:#667eea;" id="nds-turnover-real">0 ‚ÇΩ</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-size:15px;border-top:1px solid #e9ecef;padding-top:8px;margin-top:4px;">
                                    <span style="font-weight:700;color:#333;">–ò—Ç–æ–≥–æ</span>
                                    <span style="font-weight:700;color:#333;" id="nds-turnover-total">0 ‚ÇΩ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- /finance-nds -->

            </div>

            <!-- –¢–ê–ë: –ü–õ–ê–ù –ó–ê–ö–£–ü–û–ö -->
            <div id="plan" class="tab-content">
                <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
                <div class="plan-header">
                    <button class="plan-add-btn admin-only" onclick="openPlanModal()">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</button>
                </div>

                <!-- –ê–∫–∫–æ—Ä–¥–µ–æ–Ω-—Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è JS) -->
                <div id="plan-groups-container" style="display: none;"></div>

                <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
                <div class="plan-empty" id="plan-empty">
                    <p>üìã</p>
                    <p>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –≤ –ø–ª–∞–Ω–µ –∑–∞–∫—É–ø–æ–∫</p>
                    <p style="font-size: 13px; color: #bbb; margin-top: 8px;">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –ø–æ–∑–∏—Ü–∏—é –∫–Ω–æ–ø–∫–æ–π –≤—ã—à–µ</p>
                </div>
            </div>

            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ –ø–ª–∞–Ω–∞ -->
            <div class="plan-modal-overlay" id="plan-modal-overlay" onclick="if(event.target===this)closePlanModal()">
                <div class="plan-modal">
                    <h3 id="plan-modal-title">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</h3>
                    <input type="hidden" id="plan-edit-id" value="">
                    <div class="plan-form-grid">
                        <div class="plan-form-group full-width">
                            <label>–ê—Ä—Ç–∏–∫—É–ª</label>
                            <select id="plan-product-name" style="padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª...</option>
                            </select>
                        </div>
                        <div class="plan-form-group">
                            <label>–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞ –ø–ª–∞–Ω</label>
                            <input type="date" id="plan-release-date" onclick="this.showPicker()" required>
                        </div>
                        <div class="plan-form-group">
                            <label>–ü—Ä–∏–º–µ—Ä–Ω—ã–π –ø—Ä–∏—Ö–æ–¥ –¥–∞—Ç–∞</label>
                            <input type="date" id="plan-arrival-date" onclick="this.showPicker()" required>
                        </div>
                        <div class="plan-form-group">
                            <label>–ö–æ–ª-–≤–æ –ø–ª–∞–Ω</label>
                            <input type="number" id="plan-qty" placeholder="0" min="1" required>
                        </div>
                        <div class="plan-form-group">
                            <label>–¶–µ–Ω–∞ —é–∞–Ω—å –∏–Ω–≤–æ–π—Å, —à—Ç ¬•</label>
                            <input type="number" id="plan-price-invoice" placeholder="0" step="1" min="0" required>
                        </div>
                        <div class="plan-form-group">
                            <label>–¶–µ–Ω–∞ —é–∞–Ω—å –¥–µ–ª—å—Ç–∞ –∏–Ω–≤–æ–π—Å, —à—Ç ¬•</label>
                            <input type="number" id="plan-price-delta" placeholder="0" step="1" min="0" required>
                        </div>
                        <div class="plan-form-group">
                            <label>–û–ø–ª–∞—á–µ–Ω–æ –∏–Ω–≤–æ–π—Å + –¥–µ–ª—å—Ç–∞ ¬•</label>
                            <input type="number" id="plan-paid-inv-yuan" placeholder="0" step="1" min="0">
                        </div>
                        <div class="plan-form-group">
                            <label>–û–ø–ª–∞—á–µ–Ω–æ –∏–Ω–≤–æ–π—Å + –¥–µ–ª—å—Ç–∞ ‚ÇΩ</label>
                            <input type="number" id="plan-paid-inv-rub" placeholder="0" step="1" min="0">
                        </div>
                    </div>
                    <div class="plan-modal-actions">
                        <button class="plan-cancel-btn" onclick="closePlanModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="plan-save-btn" onclick="savePlanItem()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </div>
            </div>

            <!-- –¢–ê–ë: –°–æ–æ–±—â–µ–Ω–∏—è (—á–∞—Ç —Å Telegram) -->
            <div id="messages" class="tab-content">
                <div class="messages-tab">
                    <div class="messages-header">
                        <h3>üí¨ –°–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Telegram</h3>
                        <div class="messages-filters">
                            <label class="filter-checkbox">
                                <input type="checkbox" id="messages-filter-unread" onchange="loadAllMessages()">
                                <span>–¢–æ–ª—å–∫–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ</span>
                            </label>
                        </div>
                    </div>
                    <div class="messages-list" id="messages-list">
                        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
                    </div>
                </div>
            </div>

            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
            <div class="reply-modal" id="reply-modal" onclick="if(event.target===this)closeReplyModal()">
                <div class="reply-modal-content">
                    <div class="reply-modal-header">
                        <h4>üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ</h4>
                        <button class="reply-modal-close" onclick="closeReplyModal()">&times;</button>
                    </div>
                    <div class="reply-modal-original" id="reply-original-text"></div>
                    <textarea class="reply-modal-input" id="reply-textarea" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç..."></textarea>
                    <div class="reply-modal-actions">
                        <button class="message-btn message-btn-read" onclick="closeReplyModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="message-btn message-btn-reply" onclick="sendReplyFromModal()">üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</button>
                    </div>
                </div>
            </div>

            <!-- –¢–ê–ë: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è admin) -->
            <div id="users" class="tab-content">
                <div class="users-tab">
                    <div class="users-header">
                        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
                        <button class="add-user-btn" onclick="openCreateUserModal()">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                    </div>
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–õ–æ–≥–∏–Ω</th>
                                <th>–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</th>
                                <th>–†–æ–ª—å</th>
                                <th>Telegram</th>
                                <th>–°–æ–∑–¥–∞–Ω</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody">
                            <tr><td colspan="7" style="text-align:center;color:#999;padding:40px;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // –°–ò–°–¢–ï–ú–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò
        // ============================================================================

        let authToken = localStorage.getItem('authToken') || '';
        let currentUser = null;  // {user_id, username, role}

        /**
         * –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
         * –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –µ—Å—Ç—å - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –µ–≥–æ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ /api/me.
         * –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç –∏–ª–∏ –æ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É –ª–æ–≥–∏–Ω–∞.
         */
        async function checkAuth() {
            if (!authToken) {
                showLoginForm();
                return;
            }

            try {
                const resp = await fetch('/api/me', {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                const data = await resp.json();

                if (data.success) {
                    currentUser = {
                        user_id: data.user_id,
                        username: data.username,
                        display_name: data.display_name || '',
                        role: data.role,
                        telegram_username: data.telegram_username
                    };
                    hideLoginForm();
                    applyRoleRestrictions();
                    initApp();
                } else {
                    // –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π
                    localStorage.removeItem('authToken');
                    authToken = '';
                    showLoginForm();
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', err);
                showLoginForm();
            }
        }

        /**
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞, —Å–∫—Ä—ã–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç.
         */
        function showLoginForm() {
            const overlay = document.getElementById('login-overlay');
            overlay.classList.remove('hidden');
            overlay.style.display = 'flex';
            document.getElementById('main-container').style.display = 'none';
            document.getElementById('login-username').focus();
        }

        /**
         * –°–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç.
         */
        function hideLoginForm() {
            const overlay = document.getElementById('login-overlay');
            overlay.classList.add('hidden');
            overlay.style.display = 'none';
            document.getElementById('main-container').style.display = 'block';

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏–Ω)
            document.getElementById('current-username').textContent = currentUser.username;
            const badge = document.getElementById('current-role-badge');
            badge.textContent = currentUser.role;
            badge.className = 'role-badge ' + currentUser.role;
        }

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥–∞ - –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ –Ω–∞–∂–∞—Ç–∏—é –∫–Ω–æ–ø–∫–∏ "–í–æ–π—Ç–∏".
         */
        async function doLogin() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            const btn = document.getElementById('login-submit');

            if (!username || !password) {
                errorDiv.textContent = '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å';
                errorDiv.classList.add('show');
                return;
            }

            btn.disabled = true;
            btn.textContent = '–í—Ö–æ–¥...';
            errorDiv.classList.remove('show');

            try {
                const resp = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await resp.json();

                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    currentUser = {
                        user_id: data.user_id,
                        username: data.username,
                        display_name: data.display_name || '',
                        role: data.role,
                        telegram_username: data.telegram_username
                    };
                    hideLoginForm();
                    applyRoleRestrictions();
                    initApp();
                } else {
                    errorDiv.textContent = data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
                    errorDiv.classList.add('show');
                }
            } catch (err) {
                errorDiv.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
                errorDiv.classList.add('show');
            } finally {
                btn.disabled = false;
                btn.textContent = '–í–æ–π—Ç–∏';
            }
        }

        /**
         * –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã - –æ—á–∏—â–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É –ª–æ–≥–∏–Ω–∞.
         */
        function doLogout() {
            localStorage.removeItem('authToken');
            authToken = '';
            currentUser = null;
            document.body.classList.remove('viewer-mode');
            showLoginForm();
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('login-error').classList.remove('show');
        }

        /**
         * –ü—Ä–∏–º–µ–Ω—è–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è UI –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏.
         * –î–ª—è viewer - —Å–∫—Ä—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
         */
        function applyRoleRestrictions() {
            if (currentUser.role === 'viewer') {
                document.body.classList.add('viewer-mode');
            } else {
                document.body.classList.remove('viewer-mode');
            }
        }

        /**
         * –û–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ fetch() —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
         * –ü—Ä–∏ 401 –æ—à–∏–±–∫–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É –ª–æ–≥–∏–Ω–∞.
         */
        async function authFetch(url, options = {}) {
            options.headers = options.headers || {};
            if (authToken) {
                options.headers['Authorization'] = 'Bearer ' + authToken;
            }

            const resp = await fetch(url, options);

            // –ï—Å–ª–∏ 401 - —Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫, –≤—ã—Ö–æ–¥–∏–º
            if (resp.status === 401) {
                doLogout();
                throw new Error('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
            }

            // –ï—Å–ª–∏ 403 - –Ω–µ—Ç –ø—Ä–∞–≤
            if (resp.status === 403) {
                const data = await resp.json();
                alert(data.error || '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤');
                throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤');
            }

            return resp;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ —Ñ–æ—Ä–º–µ –ª–æ–≥–∏–Ω–∞
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const overlay = document.getElementById('login-overlay');
                if (!overlay.classList.contains('hidden')) {
                    doLogin();
                }
            }
        });

        let allProducts = [];
        let currentHistoryData = null;  // –•—Ä–∞–Ω–∏—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        let activeTagFilter = null;     // –ê–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥—É (–∫–ª–∏–∫ –ø–æ –±–µ–π–¥–∂—É –≤ –ª–µ–≥–µ–Ω–¥–µ)

        document.addEventListener('DOMContentLoaded', function() {
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            checkAuth();
        });

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
         */
        function initApp() {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–± –∏–∑ URL hash –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            // –§–æ—Ä–º–∞—Ç hash: "tab" –∏–ª–∏ "tab:subtab" –∏–ª–∏ "tab:subtab:doc_id" (–Ω–∞–ø—Ä–∏–º–µ—Ä "warehouse:wh-receipt:12")
            let hashValue = location.hash.replace('#', '');
            // Backward-compatibility: —Å—Ç–∞—Ä—ã–π hash #supplies ‚Üí –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ ved:ved-supplies
            if (hashValue === 'supplies') {
                hashValue = 'ved:ved-supplies';
                location.hash = hashValue;
            }
            const [savedTab, savedSubtab, savedDocId] = hashValue.split(':');
            const validTabs = ['history', 'warehouse', 'ved', 'finance', 'plan', 'messages', 'users'];
            const validWarehouseSubtabs = ['wh-receipt', 'wh-shipments', 'wh-stock'];
            const validVedSubtabs = ['ved-containers', 'ved-receipts', 'ved-supplies'];
            const validFinanceSubtabs = ['finance-records', 'finance-pendel', 'finance-realization', 'finance-nds'];

            if (savedTab && validTabs.includes(savedTab)) {
                // –î–ª—è users —Ç–∞–±–∞ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å
                if (savedTab === 'users' && currentUser.role !== 'admin') {
                    loadProductsList();
                    return;
                }

                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ç–∞–±
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

                document.getElementById(savedTab).classList.add('active');
                // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É —Ç–∞–±–∞ –ø–æ onclick –∞—Ç—Ä–∏–±—É—Ç—É
                document.querySelectorAll('.tab-button').forEach(btn => {
                    if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes("'" + savedTab + "'")) {
                        btn.classList.add('active');
                    }
                });

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–∞–±–∞
                if (savedTab === 'history') {
                    loadProductsList();
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥-–≤–∫–ª–∞–¥–∫—É OZON
                    setTimeout(() => {
                        restoreActiveSubTab();
                    }, 50);
                } else if (savedTab === 'warehouse') {
                    loadProductsList();
                    loadWarehouse();
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥–≤–∫–ª–∞–¥–∫—É —Å–∫–ª–∞–¥–∞ –µ—Å–ª–∏ –æ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
                    if (savedSubtab && validWarehouseSubtabs.includes(savedSubtab)) {
                        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã DOM —É—Å–ø–µ–ª –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å—Å—è
                        setTimeout(() => {
                            activateWarehouseSubtab(savedSubtab);
                            // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω ID –¥–æ–∫—É–º–µ–Ω—Ç–∞ - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                            if (savedDocId && savedSubtab === 'wh-receipt') {
                                setTimeout(() => {
                                    editReceiptDoc(parseInt(savedDocId));
                                }, 200);
                            }
                        }, 50);
                    }
                } else if (savedTab === 'ved') {
                    loadProductsList();
                    loadVed();
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥–≤–∫–ª–∞–¥–∫—É –í–≠–î –µ—Å–ª–∏ –æ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
                    if (savedSubtab && validVedSubtabs.includes(savedSubtab)) {
                        setTimeout(() => {
                            activateVedSubtab(savedSubtab);
                            // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                            if (savedDocId && savedSubtab === 'ved-containers') {
                                setTimeout(() => {
                                    editVedContainer(parseInt(savedDocId));
                                }, 300);
                            }
                        }, 50);
                    }
                } else if (savedTab === 'finance') {
                    loadFinance();
                    if (savedSubtab && validFinanceSubtabs.includes(savedSubtab)) {
                        setTimeout(() => {
                            activateFinanceSubtab(savedSubtab);
                        }, 50);
                    }
                } else if (savedTab === 'plan') {
                    loadPlanData();
                } else if (savedTab === 'messages') {
                    loadAllMessages();
                } else if (savedTab === 'users') {
                    loadUsers();
                }
            } else {
                // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –ø–µ—Ä–≤—ã–π —Ç–∞–± (OZON)
                loadProductsList();
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥-–≤–∫–ª–∞–¥–∫—É OZON
                setTimeout(() => {
                    restoreActiveSubTab();
                }, 50);
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º badge —Å–æ–æ–±—â–µ–Ω–∏–π
            updateMessagesBadge();

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è —á–∞—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            initContainerMsgFileInput();
        }

        // ‚úÖ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –î–ê–ù–ù–´–• –° OZON

        async function syncData() {
            const btn = document.getElementById('sync-btn');
            const originalText = btn.innerHTML;

            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                btn.disabled = true;
                btn.innerHTML = '‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
                btn.style.opacity = '0.7';

                const response = await authFetch('/api/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    btn.innerHTML = '‚úÖ –ì–æ—Ç–æ–≤–æ!';
                    btn.style.backgroundColor = '#4CAF50';

                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    btn.innerHTML = '‚ùå –û—à–∏–±–∫–∞';
                    btn.style.backgroundColor = '#f44336';
                    alert('–û—à–∏–±–∫–∞: ' + data.message);

                    // –í–µ—Ä–Ω–µ–º –∫–Ω–æ–ø–∫—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.backgroundColor = '';
                        btn.style.opacity = '1';
                        btn.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
                btn.innerHTML = '‚ùå –û—à–∏–±–∫–∞';
                btn.style.backgroundColor = '#f44336';
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');

                // –í–µ—Ä–Ω–µ–º –∫–Ω–æ–ø–∫—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.backgroundColor = '';
                    btn.style.opacity = '1';
                    btn.disabled = false;
                }, 2000);
            }
        }

        // ‚úÖ –§–£–ù–ö–¶–ò–ò –î–õ–Ø –¢–ê–ë–û–í –ò –ò–°–¢–û–†–ò–ò

        function switchTab(e, tab) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ç–∞–±—ã
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —Ç–∞–±
            document.getElementById(tab).classList.add('active');
            e.target.classList.add('active');

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–± –≤ URL hash, —á—Ç–æ–±—ã –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –Ω–∞ –º–µ—Å—Ç–µ
            location.hash = tab;

            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ –∏—Å—Ç–æ—Ä–∏—é - –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
            if (tab === 'history') {
                loadProductsList();
            }
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ —Å–∫–ª–∞–¥ - –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            if (tab === 'warehouse') {
                loadWarehouse();
            }
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ –í–≠–î - –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            if (tab === 'ved') {
                loadVed();
            }
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ —Ñ–∏–Ω–∞–Ω—Å—ã ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            if (tab === 'finance') {
                loadFinance();
            }
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ –ø–ª–∞–Ω - –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            if (tab === 'plan') {
                loadPlanData();
            }
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è - –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
            if (tab === 'messages') {
                loadAllMessages();
            }
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
            if (tab === 'users') {
                loadUsers();
            }
        }

        // ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥-–≤–∫–ª–∞–¥–æ–∫ –≤–Ω—É—Ç—Ä–∏ OZON
        function switchSubTab(e, subTab) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–¥-–≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.sub-tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.sub-tab-button').forEach(el => el.classList.remove('active'));

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –ø–æ–¥-–≤–∫–ª–∞–¥–∫—É
            document.getElementById(subTab).classList.add('active');
            if (e && e.target) {
                e.target.classList.add('active');
            } else {
                // –ï—Å–ª–∏ –≤—ã–∑–≤–∞–Ω–æ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ - –Ω–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –ø–æ subTab
                const subTabLabels = {'summary': '–°–≤–æ–¥–Ω–∞—è', 'product-analysis': '–ê–Ω–∞–ª–∏–∑ —Ç–æ–≤–∞—Ä–∞', 'fbo': '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ FBO'};
                const label = subTabLabels[subTab] || '';
                document.querySelectorAll('.sub-tab-button').forEach(btn => {
                    if (label && btn.textContent.trim() === label) {
                        btn.classList.add('active');
                    }
                });
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–æ–¥-–≤–∫–ª–∞–¥–∫—É –≤ localStorage
            localStorage.setItem('ozon_active_subtab', subTab);

            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ —Å–≤–æ–¥–Ω—É—é - –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            if (subTab === 'summary') {
                loadSummary();
            }
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫—É FBO - –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            if (subTab === 'fbo') {
                loadFboAnalytics();
            }
        }

        // ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥-–≤–∫–ª–∞–¥–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function restoreActiveSubTab() {
            const savedSubTab = localStorage.getItem('ozon_active_subtab');
            const validOzonSubtabs = ['summary', 'product-analysis', 'fbo', 'unit-economics'];
            if (savedSubTab && validOzonSubtabs.includes(savedSubTab)) {
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–¥-–≤–∫–ª–∞–¥–∫–∏
                document.querySelectorAll('.sub-tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.sub-tab-button').forEach(el => el.classList.remove('active'));

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é –ø–æ–¥-–≤–∫–ª–∞–¥–∫—É
                document.getElementById(savedSubTab).classList.add('active');

                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É
                const subTabLabels = {'summary': '–°–≤–æ–¥–Ω–∞—è', 'product-analysis': '–ê–Ω–∞–ª–∏–∑ —Ç–æ–≤–∞—Ä–∞', 'fbo': '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ FBO'};
                const label = subTabLabels[savedSubTab] || '';
                document.querySelectorAll('.sub-tab-button').forEach(btn => {
                    if (label && btn.textContent.trim() === label) {
                        btn.classList.add('active');
                    }
                });

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
                if (savedSubTab === 'summary') {
                    loadSummary();
                } else if (savedSubTab === 'fbo') {
                    loadFboAnalytics();
                }
            } else {
                // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–æ–¥–Ω—É—é
                loadSummary();
            }
        }

        // ============================================================
        // –°–í–û–î–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê ‚Äî –í–°–ï –¢–û–í–ê–†–´ –ó–ê –í–´–ë–†–ê–ù–ù–´–ô –ü–ï–†–ò–û–î
        // ============================================================

        let summaryDataLoaded = false;
        let currentPeriod = 'today';  // –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥

        /**
         * –ü–æ–ª—É—á–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
         */
        function getTodayDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        /**
         * –ü–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—É N –¥–Ω–µ–π –Ω–∞–∑–∞–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
         */
        function getDateDaysAgo(days) {
            const date = new Date();
            date.setDate(date.getDate() - days);
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        /**
         * –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–∏–æ–¥ –∏ –æ–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏
         */
        function setSummaryPeriod(period) {
            currentPeriod = period;
            const dateFrom = document.getElementById('summary-date-from');
            const dateTo = document.getElementById('summary-date-to');
            const today = getTodayDate();

            // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–µ—Ä–∏–æ–¥–∞
            switch(period) {
                case 'today':
                    dateFrom.value = today;
                    dateTo.value = today;
                    document.getElementById('period-today').classList.add('active');
                    break;
                case 'yesterday':
                    const yesterday = getDateDaysAgo(1);
                    dateFrom.value = yesterday;
                    dateTo.value = yesterday;
                    document.getElementById('period-yesterday').classList.add('active');
                    break;
                case '7days':
                    dateFrom.value = getDateDaysAgo(6);
                    dateTo.value = today;
                    document.getElementById('period-7days').classList.add('active');
                    break;
                case '14days':
                    dateFrom.value = getDateDaysAgo(13);
                    dateTo.value = today;
                    document.getElementById('period-14days').classList.add('active');
                    break;
                case '30days':
                    dateFrom.value = getDateDaysAgo(29);
                    dateTo.value = today;
                    document.getElementById('period-30days').classList.add('active');
                    break;
            }

            loadSummary();
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—Å–µ–º —Ç–æ–≤–∞—Ä–∞–º –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.
         * –ï—Å–ª–∏ –¥–∞—Ç—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å.
         */
        function loadSummary() {
            const dateFromInput = document.getElementById('summary-date-from');
            const dateToInput = document.getElementById('summary-date-to');
            const summaryContent = document.getElementById('summary-content');

            // –ï—Å–ª–∏ –¥–∞—Ç—ã –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è
            if (!dateFromInput.value) {
                dateFromInput.value = getTodayDate();
            }
            if (!dateToInput.value) {
                dateToInput.value = getTodayDate();
            }

            summaryContent.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>';

            const dateFrom = dateFromInput.value;
            const dateTo = dateToInput.value;

            authFetch(`/api/summary?date_from=${dateFrom}&date_to=${dateTo}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('summary-count').textContent = data.count || 0;

                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä–∏–æ–¥–µ
                        const periodInfo = document.getElementById('summary-period-info');
                        if (data.period_days > 1) {
                            periodInfo.textContent = `(${data.period_days} –¥–Ω. | —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å ${data.prev_date_from} ‚Äî ${data.prev_date_to})`;
                        } else {
                            periodInfo.textContent = `(—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å ${data.prev_date_from})`;
                        }

                        renderSummary(data);
                        summaryDataLoaded = true;
                    } else {
                        summaryContent.innerHTML = '<div class="error">' + (data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏') + '</div>';
                    }
                })
                .catch(error => {
                    summaryContent.innerHTML = '<div class="error">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: ' + error + '</div>';
                });
        }

        /**
         * –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–≤–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ –≤—Å–µ–º —Ç–æ–≤–∞—Ä–∞–º.
         * –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞ renderHistory, –Ω–æ –±–µ–∑ —Å—Ç–æ–ª–±—Ü–æ–≤ –¢–µ–≥ –∏ –ó–∞–º–µ—Ç–∫–∏,
         * –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ —Ç–æ–≤–∞—Ä—ã, –∞ –Ω–µ –∏—Å—Ç–æ—Ä–∏—é –æ–¥–Ω–æ–≥–æ.
         */
        // –¢–µ–∫—É—â–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–ª—è —Å–≤–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
        let summarySortField = 'orders_qty';  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∑–∞–∫–∞–∑–∞–º
        let summarySortAsc = false;  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É
        let summaryData = null;  // –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–µ—Ä–µ—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏

        function renderSummary(data) {
            const summaryContent = document.getElementById('summary-content');

            if (!data.products || data.products.length === 0) {
                summaryContent.innerHTML = '<div class="empty-state">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É</div>';
                return;
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            summaryData = data;

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –¥–µ–Ω—å (–æ–±—ä–µ–∫—Ç —Å –∫–ª—é—á–∞–º–∏ –ø–æ SKU)
            const prevProducts = data.prev_products || {};

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            const sortedProducts = [...data.products].sort((a, b) => {
                let valA = a[summarySortField] || 0;
                let valB = b[summarySortField] || 0;
                if (summarySortAsc) {
                    return valA - valB;
                } else {
                    return valB - valA;
                }
            });

            // ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Å–µ–ª —Å –ø—Ä–æ–±–µ–ª–∞–º–∏
            function formatNumber(num) {
                if (num === null || num === undefined || num === 0) return '0';
                return String(Math.round(num)).replace(/\\B(?=(\d{3})+(?!\\d))/g, ' ');
            }

            // ============================================================
            // –†–ê–°–ß–Å–¢ –°–£–ú–ú –ü–û –°–¢–û–õ–ë–¶–ê–ú (—Ç–µ–∫—É—â–∏–π –∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –¥–µ–Ω—å)
            // ============================================================
            let totalOrders = 0, totalViews = 0, totalPdp = 0, totalCart = 0, totalSpend = 0;
            let prevTotalOrders = 0, prevTotalViews = 0, prevTotalPdp = 0, prevTotalCart = 0, prevTotalSpend = 0;

            // –°—É–º–º–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å
            data.products.forEach(item => {
                totalOrders += item.orders_qty || 0;
                totalViews += item.hits_view_search || 0;
                totalPdp += item.hits_view_search_pdp || 0;
                totalCart += item.hits_add_to_cart || 0;
                totalSpend += item.adv_spend || 0;
            });

            // –°—É–º–º–∏—Ä—É–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –¥–µ–Ω—å
            Object.values(prevProducts).forEach(item => {
                prevTotalOrders += item.orders_qty || 0;
                prevTotalViews += item.hits_view_search || 0;
                prevTotalPdp += item.hits_view_search_pdp || 0;
                prevTotalCart += item.hits_add_to_cart || 0;
                prevTotalSpend += item.adv_spend || 0;
            });

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —è—á–µ–π–∫–∏ –∏—Ç–æ–≥–∞ —Å —Ä–∞–∑–Ω–∏—Ü–µ–π (–¥–ª—è —Å—Ç—Ä–æ–∫–∏ –Ω–∞–¥ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏)
            function createTotalTh(current, previous, suffix = '', lessIsBetter = false) {
                const diff = current - previous;
                let bgColor = '#f0f0f0';  // –ë–∞–∑–æ–≤—ã–π —Å–µ—Ä—ã–π —Ñ–æ–Ω
                let diffHtml = '';

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ (–¥–∞–∂–µ –µ—Å–ª–∏ –≤—á–µ—Ä–∞ –±—ã–ª–æ 0)
                if (diff !== 0) {
                    const isPositive = lessIsBetter ? (diff < 0) : (diff > 0);
                    bgColor = isPositive ? '#d4edda' : '#f8d7da';  // –ë–æ–ª–µ–µ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
                    const textColor = isPositive ? '#155724' : '#721c24';
                    const diffSign = diff > 0 ? '+' : '';
                    diffHtml = `<br><span style="font-size: 11px; color: ${textColor}; font-weight: 500;">${diffSign}${formatNumber(Math.round(diff))}${suffix}</span>`;
                }

                return `<th style="background-color: ${bgColor}; text-align: center; padding: 8px 4px; border-bottom: 2px solid #dee2e6;">
                    <strong style="font-size: 16px;">${formatNumber(Math.round(current))}${suffix}</strong>${diffHtml}
                </th>`;
            }

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç—Ä–µ–ª–∫—É —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            const ordersSortArrow = summarySortField === 'orders_qty' ? (summarySortAsc ? ' ‚ñ≤' : ' ‚ñº') : '';
            const spendSortArrow = summarySortField === 'adv_spend' ? (summarySortAsc ? ' ‚ñ≤' : ' ‚ñº') : '';

            let html = '<table id="summary-table"><thead>';

            // –°—Ç—Ä–æ–∫–∞ —Å —Å—É–º–º–∞–º–∏ (–Ω–∞–¥ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ —Å—Ç–æ–ª–±—Ü–æ–≤)
            // –°—Ç–æ–ª–±—Ü—ã: –ê—Ä—Ç–∏–∫—É–ª(0), –†–µ–π—Ç–∏–Ω–≥(1), –û—Ç–∑—ã–≤—ã(2), –ò–Ω–¥–µ–∫—Å(3), FBO(4), –ó–∞–∫–∞–∑—ã(5), –¶–µ–Ω–∞ –õ–ö(6), –°–æ–∏–Ω–≤–µ—Å—Ç(7), –¶–µ–Ω–∞ —Å–∞–π—Ç(8), –ü–æ–∑–∏—Ü–∏—è(9), –ü–æ–∫–∞–∑—ã(10), –ü–æ—Å–µ—â–µ–Ω–∏—è(11), CTR(12), –ö–æ—Ä–∑–∏–Ω–∞(13), CR1(14), CR2(15), –†–∞—Å—Ö–æ–¥—ã(16), CPO(17), –î–†–†(18)
            html += '<tr class="totals-row" style="background-color: #f8f9fa;">';
            html += '<th style="background-color: #f8f9fa; border-bottom: none;"></th>';  // –ê—Ä—Ç–∏–∫—É–ª
            html += '<th style="background-color: #f8f9fa; border-bottom: none;"></th>';  // –†–µ–π—Ç–∏–Ω–≥
            html += '<th style="background-color: #f8f9fa; border-bottom: none;"></th>';  // –û—Ç–∑—ã–≤—ã
            html += '<th style="background-color: #f8f9fa; border-bottom: none;"></th>';  // –ò–Ω–¥–µ–∫—Å —Ü–µ–Ω
            html += '<th style="background-color: #f8f9fa; border-bottom: none;"></th>';  // FBO –æ—Å—Ç–∞—Ç–æ–∫
            html += createTotalTh(totalOrders, prevTotalOrders);  // –ó–∞–∫–∞–∑—ã
            html += '<th style="background-color: #f8f9fa; border-bottom: none;"></th>';  // –¶–µ–Ω–∞ –≤ –õ–ö
            html += '<th style="background-color: #f8f9fa; border-bottom: none;"></th>';  // –°–æ–∏–Ω–≤–µ—Å—Ç
            html += '<th style="background-color: #f8f9fa; border-bottom: none;"></th>';  // –¶–µ–Ω–∞ –Ω–∞ —Å–∞–π—Ç–µ
            html += '<th style="background-color: #f8f9fa; border-bottom: none;"></th>';  // –°—Ä. –ø–æ–∑–∏—Ü–∏—è
            html += createTotalTh(totalViews, prevTotalViews);  // –ü–æ–∫–∞–∑—ã
            html += createTotalTh(totalPdp, prevTotalPdp);  // –ü–æ—Å–µ—â–µ–Ω–∏—è
            html += '<th style="background-color: #f8f9fa; border-bottom: none;"></th>';  // CTR
            html += createTotalTh(totalCart, prevTotalCart);  // –ö–æ—Ä–∑–∏–Ω–∞
            html += '<th style="background-color: #f8f9fa; border-bottom: none;"></th>';  // CR1
            html += '<th style="background-color: #f8f9fa; border-bottom: none;"></th>';  // CR2
            html += createTotalTh(totalSpend, prevTotalSpend, ' ‚ÇΩ', true);  // –†–∞—Å—Ö–æ–¥—ã
            html += '<th style="background-color: #f8f9fa; border-bottom: none;"></th>';  // CPO
            html += '<th style="background-color: #f8f9fa; border-bottom: none;"></th>';  // –î–†–†
            html += '</tr>';

            // –°—Ç—Ä–æ–∫–∞ —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ —Å—Ç–æ–ª–±—Ü–æ–≤
            html += '<tr>';
            html += '<th>–ê—Ä—Ç–∏–∫—É–ª</th>';
            html += '<th>–†–µ–π—Ç–∏–Ω–≥</th>';
            html += '<th>–û—Ç–∑—ã–≤—ã</th>';
            html += '<th>–ò–Ω–¥–µ–∫—Å —Ü–µ–Ω</th>';
            html += '<th>FBO –æ—Å—Ç–∞—Ç–æ–∫</th>';
            html += `<th class="sortable-header" onclick="sortSummaryTable('orders_qty')" style="cursor: pointer;">–ó–∞–∫–∞–∑—ã${ordersSortArrow}</th>`;
            html += '<th>–¶–µ–Ω–∞ –≤ –õ–ö</th>';
            html += '<th>–°–æ–∏–Ω–≤–µ—Å—Ç</th>';
            html += '<th>–¶–µ–Ω–∞ –Ω–∞ —Å–∞–π—Ç–µ</th>';
            html += '<th>–°—Ä. –ø–æ–∑–∏—Ü–∏—è</th>';
            html += '<th>–ü–æ–∫–∞–∑—ã</th>';
            html += '<th>–ü–æ—Å–µ—â–µ–Ω–∏—è</th>';
            html += '<th>CTR (%)</th>';
            html += '<th>–ö–æ—Ä–∑–∏–Ω–∞</th>';
            html += '<th>CR1 (%)</th>';
            html += '<th>CR2 (%)</th>';
            html += `<th class="sortable-header" onclick="sortSummaryTable('adv_spend')" style="cursor: pointer;">–†–∞—Å—Ö–æ–¥—ã${spendSortArrow}</th>`;
            html += '<th>CPO</th>';
            html += '<th>–î–†–† (%)</th>';
            html += '</tr></thead><tbody>';

            sortedProducts.forEach((item) => {
                const stockClass = item.fbo_stock < 5 ? 'stock low' : 'stock';

                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –¥–µ–Ω—å –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
                const prevItem = prevProducts[item.sku] || null;

                html += '<tr>';

                // –ê—Ä—Ç–∏–∫—É–ª (offer_id) - –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–∞ Ozon
                html += `<td><strong><span onclick="openProductOnOzon('${item.sku}')" style="cursor: pointer; color: #0066cc; text-decoration: underline;" title="–û—Ç–∫—Ä—ã—Ç—å —Ç–æ–≤–∞—Ä –Ω–∞ Ozon">${item.offer_id || '‚Äî'}</span></strong></td>`;

                // –†–µ–π—Ç–∏–Ω–≥ (—Å —Ä–∞–∑–Ω–∏—Ü–µ–π, –±–æ–ª—å—à–µ = –ª—É—á—à–µ)
                const rating = item.rating !== null && item.rating !== undefined ? item.rating : null;
                const prevRating = prevItem?.rating || null;
                if (rating !== null) {
                    const ratingDiff = (prevRating !== null) ? rating - prevRating : null;
                    if (ratingDiff !== null && ratingDiff !== 0) {
                        const isPositive = ratingDiff > 0;
                        const bgColor = isPositive ? '#e5ffe5' : '#ffe5e5';
                        const textColor = isPositive ? '#22c55e' : '#ef4444';
                        const diffSign = ratingDiff > 0 ? '+' : '';
                        html += `<td style="background-color: ${bgColor};"><strong>${rating.toFixed(1)}</strong><br><span style="font-size: 11px; color: ${textColor}; font-weight: 400;">${diffSign}${ratingDiff.toFixed(1)}</span></td>`;
                    } else {
                        html += `<td><strong>${rating.toFixed(1)}</strong></td>`;
                    }
                } else {
                    html += `<td><strong>‚Äî</strong></td>`;
                }

                // –û—Ç–∑—ã–≤—ã (—Å —Ä–∞–∑–Ω–∏—Ü–µ–π, –±–æ–ª—å—à–µ = –ª—É—á—à–µ)
                const reviewCount = item.review_count !== null && item.review_count !== undefined ? item.review_count : null;
                const prevReviews = prevItem?.review_count || null;
                if (reviewCount !== null) {
                    const reviewDiff = (prevReviews !== null) ? reviewCount - prevReviews : null;
                    if (reviewDiff !== null && reviewDiff !== 0) {
                        const isPositive = reviewDiff > 0;
                        const bgColor = isPositive ? '#e5ffe5' : '#ffe5e5';
                        const textColor = isPositive ? '#22c55e' : '#ef4444';
                        const diffSign = reviewDiff > 0 ? '+' : '';
                        html += `<td style="background-color: ${bgColor};"><strong>${formatNumber(reviewCount)}</strong><br><span style="font-size: 11px; color: ${textColor}; font-weight: 400;">${diffSign}${formatNumber(reviewDiff)}</span></td>`;
                    } else {
                        html += `<td><strong>${formatNumber(reviewCount)}</strong></td>`;
                    }
                } else {
                    html += `<td><strong>‚Äî</strong></td>`;
                }

                // –ò–Ω–¥–µ–∫—Å —Ü–µ–Ω—ã (–±–µ–∑ —Ä–∞–∑–Ω–∏—Ü—ã)
                const priceIndexMap = {
                    'SUPER': { text: '–°—É–ø–µ—Ä', color: '#22c55e' },
                    'GREEN': { text: '–í—ã–≥–æ–¥–Ω–∞—è', color: '#22c55e' },
                    'GOOD': { text: '–•–æ—Ä–æ—à–∞—è', color: '#84cc16' },
                    'YELLOW': { text: '–£–º–µ—Ä–µ–Ω–Ω–∞—è', color: '#f59e0b' },
                    'AVG': { text: '–°—Ä–µ–¥–Ω—è—è', color: '#f59e0b' },
                    'RED': { text: '–ù–µ–≤—ã–≥–æ–¥–Ω–∞—è', color: '#ef4444' },
                    'BAD': { text: '–ü–ª–æ—Ö–∞—è', color: '#ef4444' },
                    'WITHOUT_INDEX': { text: '–ë–µ–∑ –∏–Ω–¥–µ–∫—Å–∞', color: '#6b7280' }
                };
                const priceIndexValue = item.price_index || null;
                const priceIndexDisplay = priceIndexValue && priceIndexMap[priceIndexValue]
                    ? `<span style="color: ${priceIndexMap[priceIndexValue].color}; font-weight: 500;">${priceIndexMap[priceIndexValue].text}</span>`
                    : '‚Äî';
                html += `<td>${priceIndexDisplay}</td>`;

                // FBO –æ—Å—Ç–∞—Ç–æ–∫ (—Å —Ä–∞–∑–Ω–∏—Ü–µ–π, –±–æ–ª—å—à–µ = –ª—É—á—à–µ)
                const fboStock = item.fbo_stock || 0;
                const prevFboStock = prevItem?.fbo_stock;
                if (prevFboStock !== null && prevFboStock !== undefined) {
                    const fboDiff = fboStock - prevFboStock;
                    if (fboDiff !== 0) {
                        const isPositive = fboDiff > 0;
                        const bgColor = isPositive ? '#e5ffe5' : '#ffe5e5';
                        const textColor = isPositive ? '#22c55e' : '#ef4444';
                        const diffSign = fboDiff > 0 ? '+' : '';
                        html += `<td style="background-color: ${bgColor};"><span class="${stockClass}">${formatNumber(fboStock)}</span><br><span style="font-size: 11px; color: ${textColor}; font-weight: 400;">${diffSign}${formatNumber(fboDiff)}</span></td>`;
                    } else {
                        html += `<td><span class="${stockClass}">${formatNumber(fboStock)}</span></td>`;
                    }
                } else {
                    html += `<td><span class="${stockClass}">${formatNumber(fboStock)}</span></td>`;
                }

                // –ó–∞–∫–∞–∑—ã (—Å —Ä–∞–∑–Ω–∏—Ü–µ–π, –±–æ–ª—å—à–µ = –ª—É—á—à–µ)
                const ordersQty = item.orders_qty || 0;
                const prevOrders = prevItem?.orders_qty;
                if (prevOrders !== null && prevOrders !== undefined) {
                    const ordersDiff = ordersQty - prevOrders;
                    if (ordersDiff !== 0) {
                        const isPositive = ordersDiff > 0;
                        const bgColor = isPositive ? '#e5ffe5' : '#ffe5e5';
                        const textColor = isPositive ? '#22c55e' : '#ef4444';
                        const diffSign = ordersDiff > 0 ? '+' : '';
                        html += `<td style="background-color: ${bgColor};"><span class="stock">${formatNumber(ordersQty)}</span><br><span style="font-size: 11px; color: ${textColor}; font-weight: 400;">${diffSign}${formatNumber(ordersDiff)}</span></td>`;
                    } else {
                        html += `<td><span class="stock">${formatNumber(ordersQty)}</span></td>`;
                    }
                } else {
                    html += `<td><span class="stock">${formatNumber(ordersQty)}</span></td>`;
                }

                // –¶–µ–Ω–∞ –≤ –õ–ö (—Å —Ä–∞–∑–Ω–∏—Ü–µ–π, –º–µ–Ω—å—à–µ = –ª—É—á—à–µ)
                const price = (item.price !== null && item.price !== undefined && item.price > 0) ? item.price : null;
                const prevPrice = prevItem?.price || null;
                if (price !== null) {
                    if (prevPrice !== null && prevPrice > 0) {
                        const priceDiff = price - prevPrice;
                        if (priceDiff !== 0) {
                            const isPositive = priceDiff < 0;  // –ú–µ–Ω—å—à–µ = –ª—É—á—à–µ
                            const bgColor = isPositive ? '#e5ffe5' : '#ffe5e5';
                            const textColor = isPositive ? '#22c55e' : '#ef4444';
                            const diffSign = priceDiff > 0 ? '+' : '';
                            html += `<td style="background-color: ${bgColor};"><strong>${formatNumber(Math.round(price))} ‚ÇΩ</strong><br><span style="font-size: 11px; color: ${textColor}; font-weight: 400;">${diffSign}${formatNumber(Math.round(priceDiff))} ‚ÇΩ</span></td>`;
                        } else {
                            html += `<td><strong>${formatNumber(Math.round(price))} ‚ÇΩ</strong></td>`;
                        }
                    } else {
                        html += `<td><strong>${formatNumber(Math.round(price))} ‚ÇΩ</strong></td>`;
                    }
                } else {
                    html += `<td><strong>‚Äî</strong></td>`;
                }

                // –°–æ–∏–Ω–≤–µ—Å—Ç (—Å —Ä–∞–∑–Ω–∏—Ü–µ–π, –±–æ–ª—å—à–µ = –ª—É—á—à–µ)
                let coinvest = '‚Äî';
                let coinvestValue = null;
                let prevCoinvestValue = null;
                if (item.price !== null && item.price !== undefined && item.price > 0 &&
                    item.marketing_price !== null && item.marketing_price !== undefined && item.marketing_price > 0) {
                    coinvestValue = ((item.price - item.marketing_price) / item.price) * 100;
                    coinvest = coinvestValue.toFixed(1) + '%';
                }
                if (prevItem && prevItem.price > 0 && prevItem.marketing_price > 0) {
                    prevCoinvestValue = ((prevItem.price - prevItem.marketing_price) / prevItem.price) * 100;
                }
                if (coinvestValue !== null && prevCoinvestValue !== null) {
                    const coinvestDiff = coinvestValue - prevCoinvestValue;
                    if (Math.abs(coinvestDiff) > 0.01) {
                        const isPositive = coinvestDiff > 0;  // –ë–æ–ª—å—à–µ —Å–æ–∏–Ω–≤–µ—Å—Ç = –ª—É—á—à–µ
                        const bgColor = isPositive ? '#e5ffe5' : '#ffe5e5';
                        const textColor = isPositive ? '#22c55e' : '#ef4444';
                        const diffSign = coinvestDiff > 0 ? '+' : '';
                        html += `<td style="background-color: ${bgColor};"><strong>${coinvest}</strong><br><span style="font-size: 11px; color: ${textColor}; font-weight: 400;">${diffSign}${coinvestDiff.toFixed(1)}%</span></td>`;
                    } else {
                        html += `<td><strong>${coinvest}</strong></td>`;
                    }
                } else {
                    html += `<td><strong>${coinvest}</strong></td>`;
                }

                // –¶–µ–Ω–∞ –Ω–∞ —Å–∞–π—Ç–µ (—Å —Ä–∞–∑–Ω–∏—Ü–µ–π, –º–µ–Ω—å—à–µ = –ª—É—á—à–µ)
                const marketingPrice = (item.marketing_price !== null && item.marketing_price !== undefined && item.marketing_price > 0) ? item.marketing_price : null;
                const prevMarketingPrice = prevItem?.marketing_price || null;
                if (marketingPrice !== null) {
                    if (prevMarketingPrice !== null && prevMarketingPrice > 0) {
                        const mpDiff = marketingPrice - prevMarketingPrice;
                        if (mpDiff !== 0) {
                            const isPositive = mpDiff < 0;  // –ú–µ–Ω—å—à–µ = –ª—É—á—à–µ
                            const bgColor = isPositive ? '#e5ffe5' : '#ffe5e5';
                            const textColor = isPositive ? '#22c55e' : '#ef4444';
                            const diffSign = mpDiff > 0 ? '+' : '';
                            html += `<td style="background-color: ${bgColor};"><strong>${formatNumber(Math.round(marketingPrice))} ‚ÇΩ</strong><br><span style="font-size: 11px; color: ${textColor}; font-weight: 400;">${diffSign}${formatNumber(Math.round(mpDiff))} ‚ÇΩ</span></td>`;
                        } else {
                            html += `<td><strong>${formatNumber(Math.round(marketingPrice))} ‚ÇΩ</strong></td>`;
                        }
                    } else {
                        html += `<td><strong>${formatNumber(Math.round(marketingPrice))} ‚ÇΩ</strong></td>`;
                    }
                } else {
                    html += `<td><strong>‚Äî</strong></td>`;
                }

                // –°—Ä. –ø–æ–∑–∏—Ü–∏—è (—Å —Ä–∞–∑–Ω–∏—Ü–µ–π, –º–µ–Ω—å—à–µ = –ª—É—á—à–µ)
                const avgPosition = (item.avg_position !== null && item.avg_position !== undefined) ? item.avg_position : null;
                const prevPosition = prevItem?.avg_position || null;
                if (avgPosition !== null) {
                    if (prevPosition !== null) {
                        const posDiff = avgPosition - prevPosition;
                        if (Math.abs(posDiff) > 0.01) {
                            const isPositive = posDiff < 0;  // –ú–µ–Ω—å—à–µ –ø–æ–∑–∏—Ü–∏—è = –ª—É—á—à–µ
                            const bgColor = isPositive ? '#e5ffe5' : '#ffe5e5';
                            const textColor = isPositive ? '#22c55e' : '#ef4444';
                            const diffSign = posDiff > 0 ? '+' : '';
                            html += `<td style="background-color: ${bgColor};"><span class="position">${avgPosition.toFixed(1)}</span><br><span style="font-size: 11px; color: ${textColor}; font-weight: 400;">${diffSign}${posDiff.toFixed(1)}</span></td>`;
                        } else {
                            html += `<td><span class="position">${avgPosition.toFixed(1)}</span></td>`;
                        }
                    } else {
                        html += `<td><span class="position">${avgPosition.toFixed(1)}</span></td>`;
                    }
                } else {
                    html += `<td><span class="position">‚Äî</span></td>`;
                }

                // –ü–æ–∫–∞–∑—ã (—Å —Ä–∞–∑–Ω–∏—Ü–µ–π, –±–æ–ª—å—à–µ = –ª—É—á—à–µ)
                const views = item.hits_view_search || 0;
                const prevViews = prevItem?.hits_view_search;
                if (prevViews !== null && prevViews !== undefined) {
                    const viewsDiff = views - prevViews;
                    if (viewsDiff !== 0) {
                        const isPositive = viewsDiff > 0;
                        const bgColor = isPositive ? '#e5ffe5' : '#ffe5e5';
                        const textColor = isPositive ? '#22c55e' : '#ef4444';
                        const diffSign = viewsDiff > 0 ? '+' : '';
                        html += `<td style="background-color: ${bgColor};"><strong>${formatNumber(views)}</strong><br><span style="font-size: 11px; color: ${textColor}; font-weight: 400;">${diffSign}${formatNumber(viewsDiff)}</span></td>`;
                    } else {
                        html += `<td><strong>${formatNumber(views)}</strong></td>`;
                    }
                } else {
                    html += `<td><strong>${formatNumber(views)}</strong></td>`;
                }

                // –ü–æ—Å–µ—â–µ–Ω–∏—è (—Å —Ä–∞–∑–Ω–∏—Ü–µ–π, –±–æ–ª—å—à–µ = –ª—É—á—à–µ)
                const pdp = item.hits_view_search_pdp || 0;
                const prevPdp = prevItem?.hits_view_search_pdp;
                if (prevPdp !== null && prevPdp !== undefined) {
                    const pdpDiff = pdp - prevPdp;
                    if (pdpDiff !== 0) {
                        const isPositive = pdpDiff > 0;
                        const bgColor = isPositive ? '#e5ffe5' : '#ffe5e5';
                        const textColor = isPositive ? '#22c55e' : '#ef4444';
                        const diffSign = pdpDiff > 0 ? '+' : '';
                        html += `<td style="background-color: ${bgColor};"><strong>${formatNumber(pdp)}</strong><br><span style="font-size: 11px; color: ${textColor}; font-weight: 400;">${diffSign}${formatNumber(pdpDiff)}</span></td>`;
                    } else {
                        html += `<td><strong>${formatNumber(pdp)}</strong></td>`;
                    }
                } else {
                    html += `<td><strong>${formatNumber(pdp)}</strong></td>`;
                }

                // CTR (—Å —Ä–∞–∑–Ω–∏—Ü–µ–π, –±–æ–ª—å—à–µ = –ª—É—á—à–µ)
                const ctr = (item.search_ctr !== null && item.search_ctr !== undefined) ? item.search_ctr : null;
                const prevCtr = prevItem?.search_ctr || null;
                if (ctr !== null) {
                    if (prevCtr !== null) {
                        const ctrDiff = ctr - prevCtr;
                        if (Math.abs(ctrDiff) > 0.001) {
                            const isPositive = ctrDiff > 0;
                            const bgColor = isPositive ? '#e5ffe5' : '#ffe5e5';
                            const textColor = isPositive ? '#22c55e' : '#ef4444';
                            const diffSign = ctrDiff > 0 ? '+' : '';
                            html += `<td style="background-color: ${bgColor};"><strong>${ctr.toFixed(2)}%</strong><br><span style="font-size: 11px; color: ${textColor}; font-weight: 400;">${diffSign}${ctrDiff.toFixed(2)}%</span></td>`;
                        } else {
                            html += `<td><strong>${ctr.toFixed(2)}%</strong></td>`;
                        }
                    } else {
                        html += `<td><strong>${ctr.toFixed(2)}%</strong></td>`;
                    }
                } else {
                    html += `<td><strong>‚Äî</strong></td>`;
                }

                // –ö–æ—Ä–∑–∏–Ω–∞ (—Å —Ä–∞–∑–Ω–∏—Ü–µ–π, –±–æ–ª—å—à–µ = –ª—É—á—à–µ)
                const cart = item.hits_add_to_cart || 0;
                const prevCart = prevItem?.hits_add_to_cart;
                if (prevCart !== null && prevCart !== undefined) {
                    const cartDiff = cart - prevCart;
                    if (cartDiff !== 0) {
                        const isPositive = cartDiff > 0;
                        const bgColor = isPositive ? '#e5ffe5' : '#ffe5e5';
                        const textColor = isPositive ? '#22c55e' : '#ef4444';
                        const diffSign = cartDiff > 0 ? '+' : '';
                        html += `<td style="background-color: ${bgColor};"><strong>${formatNumber(cart)}</strong><br><span style="font-size: 11px; color: ${textColor}; font-weight: 400;">${diffSign}${formatNumber(cartDiff)}</span></td>`;
                    } else {
                        html += `<td><strong>${formatNumber(cart)}</strong></td>`;
                    }
                } else {
                    html += `<td><strong>${formatNumber(cart)}</strong></td>`;
                }

                // CR1 (—Å —Ä–∞–∑–Ω–∏—Ü–µ–π, –±–æ–ª—å—à–µ = –ª—É—á—à–µ)
                const cr1 = (item.cr1 !== null && item.cr1 !== undefined) ? item.cr1 : null;
                const prevCr1 = prevItem?.cr1 || null;
                if (cr1 !== null) {
                    if (prevCr1 !== null) {
                        const cr1Diff = cr1 - prevCr1;
                        if (Math.abs(cr1Diff) > 0.001) {
                            const isPositive = cr1Diff > 0;
                            const bgColor = isPositive ? '#e5ffe5' : '#ffe5e5';
                            const textColor = isPositive ? '#22c55e' : '#ef4444';
                            const diffSign = cr1Diff > 0 ? '+' : '';
                            html += `<td style="background-color: ${bgColor};"><strong>${cr1.toFixed(2)}%</strong><br><span style="font-size: 11px; color: ${textColor}; font-weight: 400;">${diffSign}${cr1Diff.toFixed(2)}%</span></td>`;
                        } else {
                            html += `<td><strong>${cr1.toFixed(2)}%</strong></td>`;
                        }
                    } else {
                        html += `<td><strong>${cr1.toFixed(2)}%</strong></td>`;
                    }
                } else {
                    html += `<td><strong>‚Äî</strong></td>`;
                }

                // CR2 (—Å —Ä–∞–∑–Ω–∏—Ü–µ–π, –±–æ–ª—å—à–µ = –ª—É—á—à–µ)
                const cr2 = (item.cr2 !== null && item.cr2 !== undefined) ? item.cr2 : null;
                const prevCr2 = prevItem?.cr2 || null;
                if (cr2 !== null) {
                    if (prevCr2 !== null) {
                        const cr2Diff = cr2 - prevCr2;
                        if (Math.abs(cr2Diff) > 0.001) {
                            const isPositive = cr2Diff > 0;
                            const bgColor = isPositive ? '#e5ffe5' : '#ffe5e5';
                            const textColor = isPositive ? '#22c55e' : '#ef4444';
                            const diffSign = cr2Diff > 0 ? '+' : '';
                            html += `<td style="background-color: ${bgColor};"><strong>${cr2.toFixed(2)}%</strong><br><span style="font-size: 11px; color: ${textColor}; font-weight: 400;">${diffSign}${cr2Diff.toFixed(2)}%</span></td>`;
                        } else {
                            html += `<td><strong>${cr2.toFixed(2)}%</strong></td>`;
                        }
                    } else {
                        html += `<td><strong>${cr2.toFixed(2)}%</strong></td>`;
                    }
                } else {
                    html += `<td><strong>‚Äî</strong></td>`;
                }

                // –†–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ä–µ–∫–ª–∞–º—É (—Å —Ä–∞–∑–Ω–∏—Ü–µ–π, –º–µ–Ω—å—à–µ = –ª—É—á—à–µ)
                const advSpend = (item.adv_spend !== null && item.adv_spend !== undefined && item.adv_spend > 0) ? item.adv_spend : null;
                const prevSpend = prevItem?.adv_spend;
                if (advSpend !== null) {
                    if (prevSpend !== null && prevSpend !== undefined && prevSpend > 0) {
                        const spendDiff = advSpend - prevSpend;
                        if (spendDiff !== 0) {
                            const isPositive = spendDiff < 0;  // –ú–µ–Ω—å—à–µ —Ä–∞—Å—Ö–æ–¥—ã = –ª—É—á—à–µ
                            const bgColor = isPositive ? '#e5ffe5' : '#ffe5e5';
                            const textColor = isPositive ? '#22c55e' : '#ef4444';
                            const diffSign = spendDiff > 0 ? '+' : '';
                            html += `<td style="background-color: ${bgColor};"><strong>${formatNumber(Math.round(advSpend))} ‚ÇΩ</strong><br><span style="font-size: 11px; color: ${textColor}; font-weight: 400;">${diffSign}${formatNumber(Math.round(spendDiff))} ‚ÇΩ</span></td>`;
                        } else {
                            html += `<td><strong>${formatNumber(Math.round(advSpend))} ‚ÇΩ</strong></td>`;
                        }
                    } else {
                        html += `<td><strong>${formatNumber(Math.round(advSpend))} ‚ÇΩ</strong></td>`;
                    }
                } else {
                    html += `<td><strong>‚Äî</strong></td>`;
                }

                // CPO (Cost Per Order) - –±–µ–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –≤—ã—á–∏—Å–ª—è–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                const cpo = (item.adv_spend !== null && item.adv_spend !== undefined && item.orders_qty > 0)
                    ? Math.round(item.adv_spend / item.orders_qty)
                    : null;
                html += `<td><strong>${cpo !== null ? cpo + ' ‚ÇΩ' : '‚Äî'}</strong></td>`;

                // –î–†–† (%) - –±–µ–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –≤—ã—á–∏—Å–ª—è–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                let drr = '‚Äî';
                if (item.adv_spend !== null && item.adv_spend !== undefined && item.adv_spend > 0 &&
                    item.orders_qty > 0 && item.marketing_price !== null && item.marketing_price !== undefined && item.marketing_price > 0) {
                    const revenue = item.orders_qty * item.marketing_price;
                    const drrValue = (item.adv_spend / revenue) * 100;
                    drr = drrValue.toFixed(1) + '%';
                }
                html += `<td><strong>${drr}</strong></td>`;

                html += '</tr>';
            });

            html += '</tbody></table>';

            // –û–±–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç–æ–ª–±—Ü–æ–≤
            const fullHtml = `
                <div class="table-controls">
                    <span style="font-weight: 600; margin-right: 8px;">–í–∏–¥–∏–º—ã–µ —Å—Ç–æ–ª–±—Ü—ã:</span>
                    <button class="toggle-col-btn" onclick="toggleSummaryColumn(0)">–ê—Ä—Ç–∏–∫—É–ª</button>
                    <button class="toggle-col-btn" onclick="toggleSummaryColumn(1)">–†–µ–π—Ç–∏–Ω–≥</button>
                    <button class="toggle-col-btn" onclick="toggleSummaryColumn(2)">–û—Ç–∑—ã–≤—ã</button>
                    <button class="toggle-col-btn" onclick="toggleSummaryColumn(3)">–ò–Ω–¥–µ–∫—Å —Ü–µ–Ω</button>
                    <button class="toggle-col-btn" onclick="toggleSummaryColumn(4)">FBO</button>
                    <button class="toggle-col-btn" onclick="toggleSummaryColumn(5)">–ó–∞–∫–∞–∑—ã</button>
                    <button class="toggle-col-btn" onclick="toggleSummaryColumn(6)">–¶–µ–Ω–∞ –≤ –õ–ö</button>
                    <button class="toggle-col-btn" onclick="toggleSummaryColumn(7)">–°–æ–∏–Ω–≤–µ—Å—Ç</button>
                    <button class="toggle-col-btn" onclick="toggleSummaryColumn(8)">–¶–µ–Ω–∞ –Ω–∞ —Å–∞–π—Ç–µ</button>
                    <button class="toggle-col-btn" onclick="toggleSummaryColumn(9)">–°—Ä. –ø–æ–∑–∏—Ü–∏—è</button>
                    <button class="toggle-col-btn" onclick="toggleSummaryColumn(10)">–ü–æ–∫–∞–∑—ã</button>
                    <button class="toggle-col-btn" onclick="toggleSummaryColumn(11)">–ü–æ—Å–µ—â–µ–Ω–∏—è</button>
                    <button class="toggle-col-btn" onclick="toggleSummaryColumn(12)">CTR</button>
                    <button class="toggle-col-btn" onclick="toggleSummaryColumn(13)">–ö–æ—Ä–∑–∏–Ω–∞</button>
                    <button class="toggle-col-btn" onclick="toggleSummaryColumn(14)">CR1</button>
                    <button class="toggle-col-btn" onclick="toggleSummaryColumn(15)">CR2</button>
                    <button class="toggle-col-btn" onclick="toggleSummaryColumn(16)">–†–∞—Å—Ö–æ–¥—ã</button>
                    <button class="toggle-col-btn" onclick="toggleSummaryColumn(17)">CPO</button>
                    <button class="toggle-col-btn" onclick="toggleSummaryColumn(18)">–î–†–†</button>
                </div>
                <div class="table-wrapper">
                    ${html}
                </div>
            `;

            summaryContent.innerHTML = fullHtml;

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤
            initSummaryColumnResize();
        }

        /**
         * –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã —Å–≤–æ–¥–Ω–æ–π –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –ø–æ–ª—é
         */
        function sortSummaryTable(field) {
            if (summarySortField === field) {
                // –ï—Å–ª–∏ —É–∂–µ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —ç—Ç–æ–º—É –ø–æ–ª—é - –º–µ–Ω—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                summarySortAsc = !summarySortAsc;
            } else {
                // –ù–æ–≤–æ–µ –ø–æ–ª–µ - —Å–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É
                summarySortField = field;
                summarySortAsc = false;
            }
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            if (summaryData) {
                renderSummary(summaryData);
            }
        }

        /**
         * –°–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–æ–ª–±–µ—Ü –≤ —Å–≤–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
         */
        function toggleSummaryColumn(colIndex) {
            const table = document.querySelector('#summary-content table');
            if (!table) return;

            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('th, td');
                if (cells[colIndex]) {
                    cells[colIndex].classList.toggle('col-hidden');
                }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
            const buttons = document.querySelectorAll('#summary-content .toggle-col-btn');
            if (buttons[colIndex]) {
                buttons[colIndex].classList.toggle('hidden');
            }
        }

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è —Å–≤–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
         */
        function initSummaryColumnResize() {
            const table = document.querySelector('#summary-content table');
            if (!table) return;

            const headers = table.querySelectorAll('th');

            headers.forEach((header, index) => {
                // –î–æ–±–∞–≤–ª—è–µ–º handle –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —à–∏—Ä–∏–Ω—ã
                const handle = document.createElement('div');
                handle.className = 'resize-handle';
                header.appendChild(handle);
                header.classList.add('resizable');

                header.style.width = 'auto';

                let isResizing = false;
                let startX = 0;
                let startWidth = 0;

                handle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    startX = e.clientX;
                    startWidth = header.offsetWidth;
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;

                    const delta = e.clientX - startX;
                    const newWidth = Math.max(30, startWidth + delta);

                    header.style.width = newWidth + 'px';
                    header.style.minWidth = newWidth + 'px';

                    const cells = table.querySelectorAll(`tbody tr td:nth-child(${index + 1})`);
                    cells.forEach(cell => {
                        cell.style.width = newWidth + 'px';
                        cell.style.minWidth = newWidth + 'px';
                    });
                });

                document.addEventListener('mouseup', () => {
                    isResizing = false;
                });
            });
        }

        // ============================================================
        // –°–ö–õ–ê–î ‚Äî –í–ö–õ–ê–î–ö–ê –° –ü–û–î–í–ö–õ–ê–î–ö–ê–ú–ò
        // ============================================================

        let warehouseDataLoaded = false;
        let warehouseProducts = [];
        let suppliesCostBySku = {};  // –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å +6% –ø–æ SKU –∏–∑ –≤–∫–ª–∞–¥–∫–∏ –ü–æ—Å—Ç–∞–≤–∫–∏

        function loadWarehouse() {
            if (warehouseDataLoaded) return;

            authFetch('/api/products/list')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        warehouseProducts = data.products;
                        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–æ—Ä–º—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
                        initReceiptForm();
                        initShipmentForm();
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –∞—Ä—Ç–∏–∫—É–ª–æ–≤ (–µ—Å–ª–∏ –ø—Ä–∏—Ö–æ–¥—ã —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã)
                        populateReceiptProductFilter();
                    }
                })
                .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', err));

            loadReceiptHistory();
            loadShipmentHistory();
            loadWarehouseStock();
            loadSuppliesCostData();  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å +6% –∏–∑ –ø–æ—Å—Ç–∞–≤–æ–∫
            warehouseDataLoaded = true;
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ +6% –∏–∑ –≤–∫–ª–∞–¥–∫–∏ –ü–æ—Å—Ç–∞–≤–∫–∏.
         * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã –∑–∞–∫—É–ø–∫–∏ –≤ —Ñ–æ—Ä–º–µ –ø—Ä–∏—Ö–æ–¥–∞.
         * –î–ª—è –∫–∞–∂–¥–æ–≥–æ SKU –±–µ—Ä—ë—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω—è—è (–ø–æ –¥–∞—Ç–µ) —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–∑ –ø–æ—Å—Ç–∞–≤–æ–∫.
         */
        function loadSuppliesCostData() {
            authFetch('/api/supplies')
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.supplies) {
                        suppliesCostBySku = {};
                        // –î–ª—è –∫–∞–∂–¥–æ–≥–æ SKU –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω—é—é (—Å–∞–º—É—é —Å–≤–µ–∂—É—é) –∑–∞–ø–∏—Å—å —Å cost_plus_6
                        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ—Å—Ç–∞–≤–∫–∏ –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (DESC)
                        const sortedSupplies = data.supplies.sort((a, b) => {
                            const dateA = new Date(a.created_at || 0);
                            const dateB = new Date(b.created_at || 0);
                            return dateB - dateA;  // DESC
                        });
                        sortedSupplies.forEach(supply => {
                            const sku = supply.sku;
                            // –ï—Å–ª–∏ –¥–ª—è —ç—Ç–æ–≥–æ SKU –µ—â—ë –Ω–µ—Ç –∑–∞–ø–∏—Å–∏, –±–µ—Ä—ë–º –ø–µ—Ä–≤—É—é –≤—Å—Ç—Ä–µ—á–µ–Ω–Ω—É—é (–æ–Ω–∞ —Å–∞–º–∞—è —Å–≤–µ–∂–∞—è)
                            if (sku && !suppliesCostBySku[sku] && supply.cost_plus_6 && supply.cost_plus_6 > 0) {
                                suppliesCostBySku[sku] = Math.round(supply.cost_plus_6);
                            }
                        });
                        console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏–∑ –ø–æ—Å—Ç–∞–≤–æ–∫:', Object.keys(suppliesCostBySku).length, 'SKU');
                    }
                })
                .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏–∑ –ø–æ—Å—Ç–∞–≤–æ–∫:', err));
        }

        function switchWarehouseSubtab(e, subtab) {
            document.querySelectorAll('.warehouse-subtab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.subtab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(subtab).classList.add('active');
            e.target.classList.add('active');

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–¥–≤–∫–ª–∞–¥–∫—É –≤ URL hash (—Ñ–æ—Ä–º–∞—Ç: warehouse:subtab)
            location.hash = 'warehouse:' + subtab;
        }

        /**
         * –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–≤–∫–ª–∞–¥–∫—É —Å–∫–ª–∞–¥–∞ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ (–±–µ–∑ —Å–æ–±—ã—Ç–∏—è –∫–ª–∏–∫–∞)
         */
        function activateWarehouseSubtab(subtab) {
            document.querySelectorAll('.warehouse-subtab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.subtab-button').forEach(el => el.classList.remove('active'));

            const subtabContent = document.getElementById(subtab);
            if (subtabContent) {
                subtabContent.classList.add('active');
            }

            // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –ø–æ–¥–≤–∫–ª–∞–¥–∫–∏ –ø–æ onclick –∞—Ç—Ä–∏–±—É—Ç—É
            document.querySelectorAll('.subtab-button').forEach(btn => {
                if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes("'" + subtab + "'")) {
                    btn.classList.add('active');
                }
            });
        }

        // ============================================================
        // –û–ü–†–ò–•–û–î–û–í–ê–ù–ò–ï ‚Äî –î–û–ö–£–ú–ï–ù–¢-–§–û–†–ú–ê–¢
        // ============================================================

        let receiptItemCounter = 0;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –ø—Ä–∏—Ö–æ–¥–∞
        function initReceiptForm() {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
            setReceiptDateToToday();
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É —Ç–æ–≤–∞—Ä–∞
            addReceiptItemRow();
        }

        // –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É —Ç–æ–≤–∞—Ä–∞ –≤ —Ñ–æ—Ä–º—É –ø—Ä–∏—Ö–æ–¥–∞
        function addReceiptItemRow() {
            const tbody = document.getElementById('wh-receipt-items-tbody');
            receiptItemCounter++;

            const row = document.createElement('tr');
            row.dataset.itemId = 'item_' + receiptItemCounter;

            // ‚Ññ –ø/–ø
            const tdNum = document.createElement('td');
            tdNum.style.textAlign = 'center';
            tdNum.textContent = tbody.children.length + 1;
            row.appendChild(tdNum);

            // –¢–æ–≤–∞—Ä (–≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫)
            const tdProduct = document.createElement('td');
            const selectProduct = document.createElement('select');
            selectProduct.className = 'wh-select';
            selectProduct.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä ‚Äî</option>';
            warehouseProducts.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.sku;
                opt.textContent = p.offer_id || p.sku;
                selectProduct.appendChild(opt);
            });
            tdProduct.appendChild(selectProduct);
            row.appendChild(tdProduct);

            // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
            const tdQty = document.createElement('td');
            const inputQty = document.createElement('input');
            inputQty.type = 'text';
            inputQty.className = 'wh-input';
            inputQty.style.cssText = 'width:100%;text-align:center;';
            inputQty.placeholder = '0';
            inputQty.oninput = function() {
                this.value = this.value.replace(/[^0-9]/g, '');
                updateReceiptItemSum(row);
                updateReceiptTotals();
            };
            tdQty.appendChild(inputQty);
            row.appendChild(tdQty);

            // –¶–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏ (–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ –ü–æ—Å—Ç–∞–≤–æ–∫ - –ø–æ–ª–µ "–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å +6%")
            const tdPrice = document.createElement('td');
            const inputPrice = document.createElement('input');
            inputPrice.type = 'text';
            inputPrice.className = 'wh-input';
            inputPrice.style.cssText = 'width:100%;text-align:right;background:#f5f5f5;color:#666;';
            inputPrice.placeholder = '–ê–≤—Ç–æ';
            inputPrice.disabled = true;  // –ü–æ–ª–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            inputPrice.title = '–¶–µ–Ω–∞ –±–µ—Ä—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –ü–æ—Å—Ç–∞–≤–æ–∫ (–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å +6%)';
            tdPrice.appendChild(inputPrice);
            row.appendChild(tdPrice);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–∞ - –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –∏–∑ –ø–æ—Å—Ç–∞–≤–æ–∫
            selectProduct.onchange = function() {
                const selectedSku = this.value;
                if (selectedSku && suppliesCostBySku[selectedSku]) {
                    inputPrice.value = formatNumberWithSpaces(suppliesCostBySku[selectedSku]);
                } else {
                    inputPrice.value = '';
                }
                updateReceiptItemSum(row);
                updateReceiptTotals();
            };

            // –°—É–º–º–∞ (—Ä–∞—Å—á—ë—Ç–Ω–æ–µ –ø–æ–ª–µ)
            const tdSum = document.createElement('td');
            tdSum.className = 'wh-sum-cell';
            tdSum.style.textAlign = 'right';
            tdSum.textContent = '‚Äî';
            row.appendChild(tdSum);

            // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
            const tdDel = document.createElement('td');
            const delBtn = document.createElement('button');
            delBtn.className = 'wh-delete-btn';
            delBtn.textContent = '‚úï';
            delBtn.onclick = () => removeReceiptItemRow(row);
            tdDel.appendChild(delBtn);
            row.appendChild(tdDel);

            tbody.appendChild(row);
            updateRowNumbers();
        }

        // –£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É —Ç–æ–≤–∞—Ä–∞
        function removeReceiptItemRow(row) {
            const tbody = document.getElementById('wh-receipt-items-tbody');
            if (tbody.children.length <= 1) {
                alert('–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Ç–æ–≤–∞—Ä–∞');
                return;
            }
            row.remove();
            updateRowNumbers();
            updateReceiptTotals();
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–æ–∫ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
        function updateRowNumbers() {
            const rows = document.querySelectorAll('#wh-receipt-items-tbody tr');
            rows.forEach((row, idx) => {
                row.cells[0].textContent = idx + 1;
            });
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Å—É–º–º—É —Å—Ç—Ä–æ–∫–∏
        function updateReceiptItemSum(row) {
            const inputs = row.querySelectorAll('input[type="text"]');
            const qty = parseInt((inputs[0]?.value || '').replace(/\s/g, '')) || 0;
            const price = parseInt((inputs[1]?.value || '').replace(/\s/g, '')) || 0;
            const sumCell = row.querySelector('.wh-sum-cell');
            if (sumCell) {
                const sum = qty * price;
                sumCell.textContent = sum > 0 ? formatNumberWithSpaces(sum) + ' ‚ÇΩ' : '‚Äî';
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –∏—Ç–æ–≥–∏ (–æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Å—É–º–º–∞)
        function updateReceiptTotals() {
            const rows = document.querySelectorAll('#wh-receipt-items-tbody tr');
            let totalQty = 0;
            let totalSum = 0;

            rows.forEach(row => {
                const inputs = row.querySelectorAll('input[type="text"]');
                const qty = parseInt((inputs[0]?.value || '').replace(/\s/g, '')) || 0;
                const price = parseInt((inputs[1]?.value || '').replace(/\s/g, '')) || 0;
                totalQty += qty;
                totalSum += qty * price;
            });

            document.getElementById('receipt-total-qty').textContent = totalQty;
            document.getElementById('receipt-total-sum').textContent = totalSum > 0 ? formatNumberWithSpaces(totalSum) + ' ‚ÇΩ' : '0 ‚ÇΩ';
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–∏—Ö–æ–¥–∞
        function saveReceipt() {
            const receiptDate = document.getElementById('receipt-date').value;
            const receiverName = document.getElementById('receipt-receiver').value;
            const comment = document.getElementById('receipt-comment').value;

            if (!receiptDate) {
                alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –ø—Ä–∏—Ö–æ–¥–∞');
                return;
            }

            const rows = document.querySelectorAll('#wh-receipt-items-tbody tr');
            const items = [];

            rows.forEach(row => {
                const select = row.querySelector('select');
                const inputs = row.querySelectorAll('input[type="text"]');
                const sku = parseInt(select?.value) || 0;
                const qty = parseInt((inputs[0]?.value || '').replace(/\s/g, '')) || 0;
                const price = parseInt((inputs[1]?.value || '').replace(/\s/g, '')) || 0;

                if (sku > 0 && qty > 0) {
                    items.push({ sku, quantity: qty, purchase_price: price });
                }
            });

            if (items.length === 0) {
                alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º');
                return;
            }

            // –ü–µ—Ä–µ–¥–∞—ë–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –ø—Ä–∏—Ö–æ–¥–∞ –∏ –∏–º—è –ø—Ä–∏—ë–º—â–∏–∫–∞
            const data = {
                doc_id: editingDocId,  // null –¥–ª—è –Ω–æ–≤–æ–≥–æ, —á–∏—Å–ª–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                receipt_date: receiptDate,
                receiver_name: receiverName,
                comment: comment,
                items: items
            };

            const isEdit = !!editingDocId;

            authFetch('/api/warehouse/receipts/save-doc', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    alert(isEdit ? '–ü—Ä–∏—Ö–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!' : '–ü—Ä–∏—Ö–æ–¥ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
                    clearReceiptForm();
                    hideReceiptForm();
                    loadReceiptHistory();
                    loadWarehouseStock();
                } else {
                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥–∞:', err);
            });
        }

        // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É –ø—Ä–∏—Ö–æ–¥–∞
        function clearReceiptForm() {
            // –°–±—Ä–æ—Å–∏—Ç—å —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            editingDocId = null;

            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
            setReceiptDateToToday();

            // –û—á–∏—Å—Ç–∏—Ç—å –∏–º—è –ø—Ä–∏—ë–º—â–∏–∫–∞ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            document.getElementById('receipt-receiver').value = '';
            document.getElementById('receipt-comment').value = '';

            // –û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É —Ç–æ–≤–∞—Ä–æ–≤
            const tbody = document.getElementById('wh-receipt-items-tbody');
            tbody.innerHTML = '';
            receiptItemCounter = 0;

            // –î–æ–±–∞–≤–∏—Ç—å –æ–¥–Ω—É –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
            addReceiptItemRow();

            // –°–±—Ä–æ—Å–∏—Ç—å –∏—Ç–æ–≥–∏
            updateReceiptTotals();

            // –°–∫—Ä—ã—Ç—å —Å–µ–∫—Ü–∏—é —á–∞—Ç–∞
            showChatSection(false);

            // –í–µ—Ä–Ω—É—Ç—å —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
            document.querySelector('#receipt-form .wh-save-receipt-btn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏—Ö–æ–¥';
        }

        /**
         * –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏—Ö–æ–¥–∞
         */
        function showReceiptForm() {
            document.getElementById('receipt-form').style.display = 'block';
            document.getElementById('receipt-create-btn-wrapper').style.display = 'none';
            document.getElementById('receipt-form').scrollIntoView({ behavior: 'smooth' });
        }

        /**
         * –°–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏—Ö–æ–¥–∞
         */
        function hideReceiptForm() {
            document.getElementById('receipt-form').style.display = 'none';
            document.getElementById('receipt-create-btn-wrapper').style.display = 'block';
        }

        /**
         * –û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥–∞ (—Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
         */
        function cancelReceipt() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å? –í—Å–µ –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
                return;
            }
            clearReceiptForm();
            hideReceiptForm();
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –≤ –ø–æ–ª–µ –ø—Ä–∏—Ö–æ–¥–∞
        function setReceiptDateToToday() {
            const now = new Date();
            // –§–æ—Ä–º–∞—Ç –¥–ª—è date: YYYY-MM-DD
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const today = `${year}-${month}-${day}`;
            const dateInput = document.getElementById('receipt-date');
            dateInput.value = today;
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã–±–æ—Ä –¥–∞—Ç—ã ‚Äî –Ω–µ –ø–æ–∑–∂–µ —Å–µ–≥–æ–¥–Ω—è
            dateInput.max = today;
        }

        // ============================================================================
        // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ß–ê–¢–ê –í –ö–ê–†–¢–û–ß–ö–ï –î–û–ö–£–ú–ï–ù–¢–ê
        // ============================================================================

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
        function loadDocumentMessages(docType, docId) {
            const section = document.getElementById('receipt-chat-section');
            const messagesDiv = document.getElementById('receipt-chat-messages');

            authFetch(`/api/document-messages/${docType}/${docId}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        if (data.messages.length === 0) {
                            messagesDiv.innerHTML = '<div class="chat-empty">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                        } else {
                            messagesDiv.innerHTML = data.messages.map(msg => {
                                const date = new Date(msg.created_at);
                                const timeStr = date.toLocaleString('ru-RU', {
                                    day: '2-digit', month: '2-digit',
                                    hour: '2-digit', minute: '2-digit'
                                });
                                const typeClass = msg.sender_type === 'telegram' ? 'telegram' : 'web';
                                const icon = msg.sender_type === 'telegram' ? 'üì±' : 'üíª';
                                // –¶–≤–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∏–º–µ–Ω–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
                                const uColor = getUserColor(msg.sender_name);

                                // –ö–Ω–æ–ø–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                                const isOwnMsg = currentUser && msg.sender_id === currentUser.user_id;
                                const actionsHtml = isOwnMsg ? `
                                    <span class="msg-actions">
                                        <button class="msg-action-btn" onclick="editMessage('document', ${msg.id}, this.closest('.chat-message'))" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                                        <button class="msg-action-btn msg-delete-btn" onclick="deleteMessage('document', ${msg.id})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                                    </span>
                                ` : '';

                                return `
                                    <div class="chat-message ${typeClass}" style="background: ${uColor.bg}; border-left: 3px solid ${uColor.border};" data-message-id="${msg.id}" data-message-text="${escapeHtml(msg.message).replace(/"/g, '&quot;')}">
                                        <div class="chat-message-header">
                                            <span>${icon} ${msg.sender_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                ${actionsHtml}
                                                <span>${timeStr}</span>
                                            </div>
                                        </div>
                                        <div class="chat-message-text">${escapeHtml(msg.message)}</div>
                                    </div>
                                `;
                            }).join('');
                            // –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –≤–Ω–∏–∑
                            messagesDiv.scrollTop = messagesDiv.scrollHeight;
                        }

                        // –ü–æ–∫–∞–∑–∞—Ç—å badge –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
                        const unread = data.messages.filter(m => m.sender_type === 'telegram' && !m.is_read).length;
                        const badge = document.getElementById('receipt-chat-badge');
                        if (unread > 0) {
                            badge.textContent = unread;
                            badge.style.display = 'inline-block';
                        } else {
                            badge.style.display = 'none';
                        }
                        // –°–æ–æ–±—â–µ–Ω–∏—è –ù–ï –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                        // –¢–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ" –∏–ª–∏ –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞
                    }
                })
                .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', err));
        }

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É
        function sendDocumentMessage() {
            if (!editingDocId) {
                alert('–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }

            const input = document.getElementById('receipt-chat-message');
            const message = input.value.trim();
            const sendTelegram = document.getElementById('receipt-chat-send-telegram').checked;

            if (!message) {
                input.focus();
                return;
            }

            // –ü–æ–ª—É—á–∏—Ç—å –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const senderName = currentUser ? currentUser.username : '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';

            authFetch('/api/document-messages/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    doc_type: 'receipt',
                    doc_id: editingDocId,
                    message: message,
                    send_telegram: sendTelegram,
                    sender_name: senderName
                })
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    input.value = '';
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
                    loadDocumentMessages('receipt', editingDocId);
                    // –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ (–æ—Ç–≤–µ—Ç = –ø—Ä–æ—á–∏—Ç–∞–Ω–æ)
                    authFetch('/api/document-messages/mark-read', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ doc_type: 'receipt', doc_id: editingDocId })
                    }).then(() => {
                        // –û–±–Ω–æ–≤–∏—Ç—å badge –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –°–æ–æ–±—â–µ–Ω–∏—è
                        updateMessagesBadge();
                    });
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', err);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
            });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Å–µ–∫—Ü–∏—é —á–∞—Ç–∞
        function showChatSection(show, docId = null) {
            const section = document.getElementById('receipt-chat-section');
            if (show && docId) {
                section.style.display = 'block';
                loadDocumentMessages('receipt', docId);
            } else {
                section.style.display = 'none';
            }
        }

        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================================================
        // –¶–í–ï–¢–ê –°–û–û–ë–©–ï–ù–ò–ô –ü–û –ò–ú–ï–ù–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
        // ============================================================================
        // –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–π
        // —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ö—ç—à–∞ –µ–≥–æ –∏–º–µ–Ω–∏. –¶–≤–µ—Ç —Å—Ç–∞–±–∏–ª–µ–Ω ‚Äî –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ
        // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ü–≤–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞
        // (Telegram / Web).
        // ============================================================================

        const _userColorPalette = [
            { bg: '#e0e7ff', border: '#818cf8' },  // –ò–Ω–¥–∏–≥–æ
            { bg: '#d1fae5', border: '#34d399' },  // –ó–µ–ª—ë–Ω—ã–π
            { bg: '#fef3c7', border: '#fbbf24' },  // –ñ—ë–ª—Ç—ã–π
            { bg: '#fce7f3', border: '#f472b6' },  // –†–æ–∑–æ–≤—ã–π
            { bg: '#e0f2fe', border: '#38bdf8' },  // –ì–æ–ª—É–±–æ–π
            { bg: '#f3e8ff', border: '#a78bfa' },  // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
            { bg: '#ffedd5', border: '#fb923c' },  // –û—Ä–∞–Ω–∂–µ–≤—ã–π
            { bg: '#dcfce7', border: '#4ade80' },  // –õ–∞–π–º–æ–≤—ã–π
            { bg: '#ccfbf1', border: '#2dd4bf' },  // –ë–∏—Ä—é–∑–æ–≤—ã–π
            { bg: '#ffe4e6', border: '#fb7185' },  // –ö–æ—Ä–∞–ª–ª–æ–≤—ã–π
            { bg: '#fef9c3', border: '#facc15' },  // –ó–æ–ª–æ—Ç–æ–π
            { bg: '#e8d5f5', border: '#9b59b6' },  // –°–∏—Ä–µ–Ω–µ–≤—ã–π
        ];

        const _userColorCache = {};

        /**
         * –ü–æ–ª—É—á–∏—Ç—å —Ü–≤–µ—Ç (—Ñ–æ–Ω + —Ä–∞–º–∫–∞) –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
         * –•—ç—à —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∏–∑ –∏–º–µ–Ω–∏, –ø–æ—ç—Ç–æ–º—É –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –æ–¥–∏–Ω —Ü–≤–µ—Ç.
         */
        function getUserColor(senderName) {
            if (!senderName) return { bg: '#f3f4f6', border: '#9ca3af' };
            if (_userColorCache[senderName]) return _userColorCache[senderName];

            let hash = 0;
            for (let i = 0; i < senderName.length; i++) {
                hash = senderName.charCodeAt(i) + ((hash << 5) - hash);
                hash = hash & hash;
            }
            const index = Math.abs(hash) % _userColorPalette.length;
            _userColorCache[senderName] = _userColorPalette[index];
            return _userColorPalette[index];
        }

        // ============================================================================
        // –§–ò–ù–ê–ù–°–´ ‚Äî –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–ü–ò–°–Ø–ú–ò –î–û–•–û–î–û–í –ò –†–ê–°–•–û–î–û–í
        // ============================================================================
        // –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏: –∑–∞–≥—Ä—É–∑–∫–∞, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ,
        // —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞–º–∏.
        // ============================================================================

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –º–æ–¥—É–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤
        let financeDataLoaded = false;       // –§–ª–∞–≥ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
        let financeAccounts = [];            // –ú–∞—Å—Å–∏–≤ —Å—á–µ—Ç–æ–≤ [{id, name, is_default}, ...]
        let financeCategories = [];          // –ú–∞—Å—Å–∏–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π [{id, name}, ...]
        let financeRecordsData = [];         // –ú–∞—Å—Å–∏–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
        let currentFinanceEditId = null;     // ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–π –∑–∞–ø–∏—Å–∏ (null = –Ω–æ–≤–∞—è)
        let selectedFinanceAccountId = null; // ID –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—á—ë—Ç–∞ –≤ —Ñ–æ—Ä–º–µ
        let selectedFinanceCategoryId = null; // ID –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ —Ñ–æ—Ä–º–µ

        /**
         * –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞: –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤.
         * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–§–∏–Ω–∞–Ω—Å—ã"
         * –∏–ª–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ö–µ—à–∞ #finance.
         */
        function loadFinance() {
            if (!financeDataLoaded) {
                loadFinanceAccounts();
                loadFinanceCategories();
                // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: –≤—Å—è –∏—Å—Ç–æ—Ä–∏—è (–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ –¥–∞—Ç–∞–º)
                document.getElementById('finance-period').value = 'all';
                applyFinancePeriod();
                financeDataLoaded = true;
            }
            loadFinanceRecords();
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Å—á–µ—Ç–æ–≤/–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.
         * –ó–∞–ø–æ–ª–Ω—è–µ—Ç –º–∞—Å—Å–∏–≤ financeAccounts –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä-—Å–µ–ª–µ–∫—Ç.
         */
        async function loadFinanceAccounts() {
            try {
                const resp = await authFetch('/api/finance/accounts');
                const data = await resp.json();
                if (data.success) {
                    financeAccounts = data.accounts;
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö
                    const filterSelect = document.getElementById('finance-filter-account');
                    if (filterSelect) {
                        const currentVal = filterSelect.value;
                        filterSelect.innerHTML = '<option value="">–í—Å–µ —Å—á–µ—Ç–∞</option>';
                        financeAccounts.forEach(acc => {
                            const opt = document.createElement('option');
                            opt.value = acc.id;
                            opt.textContent = acc.name;
                            filterSelect.appendChild(opt);
                        });
                        filterSelect.value = currentVal;
                    }
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—á–µ—Ç–æ–≤:', e);
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π.
         * –ó–∞–ø–æ–ª–Ω—è–µ—Ç –º–∞—Å—Å–∏–≤ financeCategories –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä-—Å–µ–ª–µ–∫—Ç.
         */
        async function loadFinanceCategories() {
            try {
                const resp = await authFetch('/api/finance/categories');
                const data = await resp.json();
                if (data.success) {
                    financeCategories = data.categories;
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å —É—á—ë—Ç–æ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
                    updateFinanceCategoryFilter();
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', e);
            }
        }

        /**
         * –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö.
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–∏–ø—É (—Ä–∞—Å—Ö–æ–¥/–¥–æ—Ö–æ–¥).
         * –ï—Å–ª–∏ —Ç–∏–ø –Ω–µ –≤—ã–±—Ä–∞–Ω (–í—Å–µ) ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
         */
        function updateFinanceCategoryFilter() {
            const filterSelect = document.getElementById('finance-filter-category');
            if (!filterSelect) return;

            const selectedType = document.getElementById('finance-filter-type')?.value || '';
            const currentVal = filterSelect.value;

            filterSelect.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';

            // –§–∏–ª—å—Ç—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–∏–ø—É
            const filtered = selectedType
                ? financeCategories.filter(cat => cat.record_type === selectedType)
                : financeCategories;

            filtered.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.id;
                const typeIcon = cat.record_type === 'income' ? 'üìà' : 'üìâ';
                opt.textContent = typeIcon + ' ' + cat.name;
                filterSelect.appendChild(opt);
            });

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –æ—Å—Ç–∞–ª–∞—Å—å –≤ —Å–ø–∏—Å–∫–µ
            const stillExists = filtered.some(cat => String(cat.id) === String(currentVal));
            filterSelect.value = stillExists ? currentVal : '';
        }

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã —Ç–∏–ø–∞ –≤ —Ñ–∏–ª—å—Ç—Ä–µ.
         * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞–ø–∏—Å–∏.
         */
        function onFinanceFilterTypeChange() {
            updateFinanceCategoryFilter();
            loadFinanceRecords();
        }

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ –∑–∞–ø–∏—Å–∏ (—Ä–∞—Å—Ö–æ–¥/–¥–æ—Ö–æ–¥).
         * –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç dropdown.
         */
        function onFinanceTypeChange() {
            selectedFinanceCategoryId = null;
            const catInput = document.getElementById('finance-category-input');
            if (catInput) catInput.value = '';
            renderFinanceCategoryDropdown('');
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—É—é –∏ –ø–ª–∞–Ω-—Å–µ–∫—Ü–∏—é –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∏–ø–∞
            resetFinanceContainerSection();
            resetFinancePlanSection();
            // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ —é–∞–Ω–µ–π –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∏–ø–∞
            checkFinanceYuanField();
            checkFinanceDescriptionField();
            checkFinanceOfficialField();
        }

        /**
         * –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∏–∑ dropdown –∫ —Å–∫—Ä—ã—Ç—ã–º –ø–æ–ª—è–º –¥–∞—Ç.
         * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ dropdown "–ü–µ—Ä–∏–æ–¥" (finance-period).
         * –ü—Ä–∏ –≤—ã–±–æ—Ä–µ "custom" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª—è –≤–≤–æ–¥–∞ –¥–∞—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞.
         */
        function applyFinancePeriod() {
            const period = document.getElementById('finance-period')?.value || 'month';
            const fromInput = document.getElementById('finance-date-from');
            const toInput = document.getElementById('finance-date-to');
            const dateSep = document.getElementById('finance-date-sep');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞ –¥–∞—Ç
            const isCustom = (period === 'custom');
            if (fromInput) fromInput.style.display = isCustom ? '' : 'none';
            if (toInput) toInput.style.display = isCustom ? '' : 'none';
            if (dateSep) dateSep.style.display = isCustom ? '' : 'none';

            if (isCustom) return; // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–¥—ë—Ç –¥–∞—Ç—ã –≤—Ä—É—á–Ω—É—é

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø–µ—Ä–∏–æ–¥—É
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayStr = yyyy + '-' + mm + '-' + dd;

            let fromStr = '';
            let toStr = todayStr;
            if (period === 'month') {
                fromStr = yyyy + '-' + mm + '-01';
            } else if (period === 'prev_month') {
                const prev = new Date(yyyy, today.getMonth() - 1, 1);
                const lastDay = new Date(prev.getFullYear(), prev.getMonth() + 1, 0);
                fromStr = prev.getFullYear() + '-' + String(prev.getMonth() + 1).padStart(2, '0') + '-01';
                toStr = lastDay.getFullYear() + '-' + String(lastDay.getMonth() + 1).padStart(2, '0') + '-' + String(lastDay.getDate()).padStart(2, '0');
            } else if (period === 'q1') {
                fromStr = yyyy + '-01-01';
                toStr = yyyy + '-03-31';
            } else if (period === 'q2') {
                fromStr = yyyy + '-04-01';
                toStr = yyyy + '-06-30';
            } else if (period === 'q3') {
                fromStr = yyyy + '-07-01';
                toStr = yyyy + '-09-30';
            } else if (period === 'q4') {
                fromStr = yyyy + '-10-01';
                toStr = yyyy + '-12-31';
            } else if (period === 'year') {
                fromStr = yyyy + '-01-01';
            } else if (period === 'all') {
                fromStr = ''; // –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
            }

            if (fromInput) fromInput.value = fromStr;
            if (toInput) toInput.value = (period === 'all') ? '' : toStr;
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π —Å —É—á—ë—Ç–æ–º —Ç–µ–∫—É—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤.
         * –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–∞–±–ª–∏—Ü—É –∏ —Å–≤–æ–¥–∫—É (–¥–æ—Ö–æ–¥, —Ä–∞—Å—Ö–æ–¥, –±–∞–ª–∞–Ω—Å).
         */
        async function loadFinanceRecords() {
            try {
                // –°–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                const recordType = document.getElementById('finance-filter-type')?.value || '';
                const accountId = document.getElementById('finance-filter-account')?.value || '';
                const categoryId = document.getElementById('finance-filter-category')?.value || '';
                const isOfficial = document.getElementById('finance-filter-official')?.value || '';
                const dateFrom = document.getElementById('finance-date-from')?.value || '';
                const dateTo = document.getElementById('finance-date-to')?.value || '';

                const params = new URLSearchParams();
                if (recordType) params.append('type', recordType);
                if (accountId) params.append('account_id', accountId);
                if (categoryId) params.append('category_id', categoryId);
                if (isOfficial !== '') params.append('is_official', isOfficial);
                if (dateFrom) params.append('date_from', dateFrom);
                if (dateTo) params.append('date_to', dateTo);
                params.append('sort_by', 'date');
                params.append('sort_dir', 'desc');

                const resp = await authFetch('/api/finance/records?' + params.toString());
                const data = await resp.json();

                if (!data.success) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π:', data.error);
                    return;
                }

                financeRecordsData = data.records;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É
                updateFinanceSummary(data.summary);

                // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É
                renderFinanceTable(data.records);
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π:', e);
            }
        }

        /**
         * –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–≤–æ–¥–∫–∏ (–¥–æ—Ö–æ–¥, —Ä–∞—Å—Ö–æ–¥, –±–∞–ª–∞–Ω—Å).
         * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—É–º–º—ã —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –º–µ–∂–¥—É —Ç—ã—Å—è—á–∞–º–∏.
         */
        function updateFinanceSummary(summary) {
            const fmt = (num) => {
                if (num === 0) return '0 ‚ÇΩ';
                const abs = Math.abs(num);
                const formatted = abs % 1 === 0
                    ? abs.toLocaleString('ru-RU')
                    : abs.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                return (num < 0 ? '-' : '') + formatted + ' ‚ÇΩ';
            };

            const fmtYuan = (num) => {
                if (num === 0) return '0 ¬•';
                const abs = Math.abs(num);
                const formatted = abs % 1 === 0
                    ? abs.toLocaleString('ru-RU')
                    : abs.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                return (num < 0 ? '-' : '') + formatted + ' ¬•';
            };

            const incomeEl = document.getElementById('finance-total-income');
            const expenseEl = document.getElementById('finance-total-expense');
            const balanceEl = document.getElementById('finance-balance');
            const yuanEl = document.getElementById('finance-total-yuan');

            if (incomeEl) incomeEl.textContent = fmt(summary.total_income);
            if (expenseEl) expenseEl.textContent = fmt(summary.total_expense);
            if (balanceEl) {
                balanceEl.textContent = fmt(summary.balance);
                // –¶–≤–µ—Ç –±–∞–ª–∞–Ω—Å–∞: –∑–µ–ª—ë–Ω—ã–π –µ—Å–ª–∏ > 0, –∫—Ä–∞—Å–Ω—ã–π –µ—Å–ª–∏ < 0
                const card = balanceEl.closest('.finance-summary-card');
                if (card) {
                    if (summary.balance > 0) {
                        balanceEl.style.color = '#22c55e';
                    } else if (summary.balance < 0) {
                        balanceEl.style.color = '#ef4444';
                    } else {
                        balanceEl.style.color = '#333';
                    }
                }
            }
            if (yuanEl) yuanEl.textContent = fmtYuan(summary.total_yuan || 0);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—É–º–º—É –≤ —Ä—É–±–ª—è—Ö –∏ –∫—É—Ä—Å —é–∞–Ω—è
            const yuanInfoEl = document.getElementById('finance-yuan-rubles-info');
            if (yuanInfoEl) {
                const totalYuan = summary.total_yuan || 0;
                const totalYuanRubles = summary.total_yuan_rubles || 0;
                if (totalYuan > 0 && totalYuanRubles > 0) {
                    const rate = totalYuanRubles / totalYuan;
                    const rubFmt = totalYuanRubles.toLocaleString('ru-RU', {maximumFractionDigits: 0});
                    const rateFmt = rate.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    yuanInfoEl.textContent = rubFmt + ' ‚ÇΩ ¬∑ –∫—É—Ä—Å ' + rateFmt + ' ‚ÇΩ/¬•';
                } else {
                    yuanInfoEl.textContent = '';
                }
            }
        }

        /**
         * –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π.
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç/—Å–∫—Ä—ã–≤–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É –∏ –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
         */
        function renderFinanceTable(records) {
            const tbody = document.getElementById('finance-tbody');
            const wrapper = document.getElementById('finance-table-wrapper');
            const empty = document.getElementById('finance-empty');

            if (!records || records.length === 0) {
                if (wrapper) wrapper.style.display = 'none';
                if (empty) empty.style.display = 'block';
                return;
            }

            if (wrapper) wrapper.style.display = 'block';
            if (empty) empty.style.display = 'none';

            tbody.innerHTML = '';

            records.forEach((rec, idx) => {
                const tr = document.createElement('tr');

                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏ –±–ª–µ–¥–Ω–æ-–∫—Ä–∞—Å–Ω—ã–º, –µ—Å–ª–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, –Ω–æ –Ω–µ —Å–¥–µ–ª–∞–Ω–æ
                const needsContainerDist = rec.record_type === 'expense' && rec.is_container_linked && !rec.has_distributions;
                const needsPlanDist = rec.record_type === 'expense' && rec.is_plan_linked && rec.yuan_amount > 0 && !rec.has_plan_distributions;
                if (needsContainerDist || needsPlanDist) {
                    tr.style.backgroundColor = '#fff0f0';
                }

                // ‚Ññ (–ø–æ—Ä—è–¥–∫–æ–≤—ã–π)
                const tdNum = document.createElement('td');
                tdNum.textContent = idx + 1;
                tdNum.style.color = '#999';
                tr.appendChild(tdNum);

                // –î–∞—Ç–∞
                const tdDate = document.createElement('td');
                if (rec.record_date) {
                    const parts = rec.record_date.split('-');
                    tdDate.textContent = parts.length === 3
                        ? parts[2] + '.' + parts[1] + '.' + parts[0]
                        : rec.record_date;
                } else {
                    tdDate.textContent = '‚Äî';
                }
                tr.appendChild(tdDate);

                // –¢–∏–ø (–±–µ–π–¥–∂)
                const tdType = document.createElement('td');
                const badge = document.createElement('span');
                badge.className = 'finance-type-badge ' + rec.record_type;
                badge.textContent = rec.record_type === 'income' ? 'üìà –î–æ—Ö–æ–¥' : 'üìâ –†–∞—Å—Ö–æ–¥';
                tdType.appendChild(badge);
                tr.appendChild(tdType);

                // –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥
                const tdOfficial = document.createElement('td');
                tdOfficial.style.textAlign = 'center';
                const acc = financeAccounts.find(a => a.id === rec.account_id);
                if (rec.record_type === 'expense' && acc && acc.requires_official) {
                    if (rec.is_official === 1) {
                        tdOfficial.innerHTML = '<span style="color: #16a34a; font-size: 16px;" title="–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π">‚úÖ</span>';
                    } else {
                        tdOfficial.innerHTML = '<span style="color: #dc2626; font-size: 16px;" title="–ù–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π">‚ùå</span>';
                    }
                }
                tr.appendChild(tdOfficial);

                // –°—É–º–º–∞
                const tdAmount = document.createElement('td');
                const amount = parseFloat(rec.amount) || 0;
                const amountFormatted = amount % 1 === 0
                    ? amount.toLocaleString('ru-RU')
                    : amount.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                tdAmount.innerHTML = amountFormatted + ' ‚ÇΩ';
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
                if (rec.has_distributions) {
                    const distIcon = document.createElement('span');
                    distIcon.className = 'finance-record-dist-indicator';
                    distIcon.textContent = ' üì¶';
                    distIcon.title = '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–æ–∫—É)';
                    tdAmount.appendChild(distIcon);
                }
                if (rec.has_plan_distributions) {
                    const planIcon = document.createElement('span');
                    planIcon.className = 'finance-record-dist-indicator';
                    planIcon.textContent = ' üìã';
                    planIcon.title = '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –ø–æ –ø–ª–∞–Ω—É (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–æ–∫—É)';
                    tdAmount.appendChild(planIcon);
                }
                tdAmount.style.fontWeight = '600';
                tdAmount.style.whiteSpace = 'nowrap';
                if (rec.record_type === 'income') {
                    tdAmount.style.color = '#16a34a';
                } else {
                    tdAmount.style.color = '#dc2626';
                }
                tr.appendChild(tdAmount);

                // –Æ–∞–Ω–∏
                const tdYuan = document.createElement('td');
                if (rec.yuan_amount && rec.yuan_amount > 0) {
                    const yuanVal = parseFloat(rec.yuan_amount);
                    const yuanFormatted = yuanVal % 1 === 0
                        ? yuanVal.toLocaleString('ru-RU')
                        : yuanVal.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    tdYuan.textContent = yuanFormatted + ' ¬•';
                    tdYuan.style.fontWeight = '600';
                    tdYuan.style.color = '#d97706';
                    tdYuan.style.whiteSpace = 'nowrap';
                } else {
                    tdYuan.textContent = '‚Äî';
                    tdYuan.style.color = '#ccc';
                }
                tr.appendChild(tdYuan);

                // –°—á—ë—Ç / –ò—Å—Ç–æ—á–Ω–∏–∫
                const tdAccount = document.createElement('td');
                tdAccount.textContent = rec.account_name || '‚Äî';
                tdAccount.style.textAlign = 'left';
                tr.appendChild(tdAccount);

                // –ö–∞—Ç–µ–≥–æ—Ä–∏—è
                const tdCategory = document.createElement('td');
                tdCategory.textContent = rec.category_name || '‚Äî';
                tdCategory.style.textAlign = 'left';
                tr.appendChild(tdCategory);

                // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                const tdDesc = document.createElement('td');
                tdDesc.textContent = rec.description || '‚Äî';
                tdDesc.style.textAlign = 'left';
                tdDesc.style.maxWidth = '300px';
                tdDesc.style.overflow = 'hidden';
                tdDesc.style.textOverflow = 'ellipsis';
                tdDesc.style.whiteSpace = 'nowrap';
                tdDesc.title = rec.description || '';
                tr.appendChild(tdDesc);

                // –§–∞–π–ª—ã
                const tdFiles = document.createElement('td');
                tdFiles.style.textAlign = 'center';
                if (rec.file_count > 0) {
                    const fileLink = document.createElement('a');
                    fileLink.href = '#';
                    fileLink.textContent = rec.file_count;
                    fileLink.title = '–§–∞–π–ª—ã: ' + rec.file_count;
                    fileLink.style.cssText = 'color: #3b82f6; text-decoration: none; font-weight: 600;';
                    fileLink.onclick = (e) => { e.preventDefault(); e.stopPropagation(); toggleFinanceFilesRow(rec.id, tr); };
                    tdFiles.appendChild(fileLink);
                } else {
                    tdFiles.textContent = '';
                    tdFiles.style.color = '#ccc';
                }
                tr.appendChild(tdFiles);

                // –°–æ–∑–¥–∞–ª
                const tdCreated = document.createElement('td');
                tdCreated.textContent = rec.created_by || '‚Äî';
                tdCreated.style.fontSize = '13px';
                tdCreated.style.color = '#666';
                tr.appendChild(tdCreated);

                // –ò—Å—Ç–æ—á–Ω–∏–∫ (–≤–µ–±/—Ç–µ–ª–µ–≥—Ä–∞–º)
                const tdSource = document.createElement('td');
                const srcBadge = document.createElement('span');
                srcBadge.className = 'finance-source-badge ' + rec.source;
                srcBadge.textContent = rec.source === 'telegram' ? 'üì± Telegram' : 'üåê –í–µ–±';
                tdSource.appendChild(srcBadge);
                tr.appendChild(tdSource);

                // –î–µ–π—Å—Ç–≤–∏—è (admin-only)
                const tdActions = document.createElement('td');
                tdActions.className = 'admin-only';
                tdActions.style.whiteSpace = 'nowrap';

                const editBtn = document.createElement('button');
                editBtn.className = 'action-btn';
                editBtn.textContent = '‚úèÔ∏è';
                editBtn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
                editBtn.style.background = 'none';
                editBtn.style.border = 'none';
                editBtn.style.cursor = 'pointer';
                editBtn.style.fontSize = '16px';
                editBtn.style.padding = '4px';
                editBtn.onclick = () => editFinanceRecord(rec.id);
                tdActions.appendChild(editBtn);

                const delBtn = document.createElement('button');
                delBtn.className = 'action-btn delete-btn';
                delBtn.textContent = 'üóë';
                delBtn.title = '–£–¥–∞–ª–∏—Ç—å';
                delBtn.style.background = 'none';
                delBtn.style.border = 'none';
                delBtn.style.cursor = 'pointer';
                delBtn.style.fontSize = '16px';
                delBtn.style.padding = '4px';
                delBtn.onclick = () => deleteFinanceRecord(rec.id);
                tdActions.appendChild(delBtn);

                tr.appendChild(tdActions);

                // –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è ‚Äî –¥–µ–ª–∞–µ–º —Å—Ç—Ä–æ–∫—É –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–π
                if (rec.has_distributions || rec.has_plan_distributions) {
                    tr.className = 'finance-record-row-clickable';
                    tr.onclick = (e) => {
                        // –ù–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∞–∫–∫–æ—Ä–¥–µ–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫–∏
                        if (e.target.closest('.action-btn') || e.target.closest('button')) return;
                        toggleFinanceDistAccordion(rec.id);
                    };
                }

                tbody.appendChild(tr);

                // –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—É—é —Å—Ç—Ä–æ–∫—É –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π
                if (rec.has_distributions || rec.has_plan_distributions) {
                    const accordionTr = document.createElement('tr');
                    accordionTr.className = 'finance-dist-accordion';
                    accordionTr.id = `finance-dist-accordion-${rec.id}`;
                    const accordionTd = document.createElement('td');
                    accordionTd.colSpan = 13;
                    accordionTd.className = 'finance-dist-accordion-cell';
                    const accordionContent = document.createElement('div');
                    accordionContent.className = 'finance-dist-accordion-content';
                    accordionContent.id = `finance-dist-accordion-content-${rec.id}`;
                    accordionContent.innerHTML = '<div class="finance-dist-accordion-loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                    accordionTd.appendChild(accordionContent);
                    accordionTr.appendChild(accordionTd);
                    tbody.appendChild(accordionTr);
                }
            });

            // –û—á–∏—â–∞–µ–º –∫—ç—à –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–µ
            financeDistAccordionCache = {};
        }

        /**
         * –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏.
         * –ï—Å–ª–∏ editId –ø–µ—Ä–µ–¥–∞–Ω ‚Äî –∑–∞–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª—è –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–ø–∏—Å–∏.
         */
        function showFinanceForm(editId) {
            // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–∞–º–∏ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
            const accPanel = document.getElementById('finance-accounts-manager');
            const catPanel = document.getElementById('finance-categories-manager');
            if (accPanel) accPanel.style.display = 'none';
            if (catPanel) catPanel.style.display = 'none';

            const form = document.getElementById('finance-form');
            form.style.display = 'block';

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —Å–µ–≥–æ–¥–Ω—è, –º–∞–∫—Å–∏–º—É–º ‚Äî —Å–µ–≥–æ–¥–Ω—è
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('finance-date').value = today;
            document.getElementById('finance-date').max = today;
            document.getElementById('finance-type').value = 'expense';
            document.getElementById('finance-amount').value = '';
            document.getElementById('finance-account-input').value = '';
            document.getElementById('finance-category-input').value = '';
            document.getElementById('finance-description').value = '';
            document.getElementById('finance-yuan-amount').value = '';
            selectedFinanceAccountId = null;
            selectedFinanceCategoryId = null;
            currentFinanceEditId = null;

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, –ø–ª–∞–Ω–∞, –ø–æ–ª–µ —é–∞–Ω–µ–π –∏ ¬´–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥¬ª
            resetFinanceContainerSection();
            resetFinancePlanSection();
            checkFinanceYuanField();
            checkFinanceDescriptionField();
            checkFinanceOfficialField();

            if (editId) {
                // –ù–∞—Ö–æ–¥–∏–º –∑–∞–ø–∏—Å—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const rec = financeRecordsData.find(r => r.id === editId);
                if (rec) {
                    currentFinanceEditId = editId;
                    document.getElementById('finance-type').value = rec.record_type;
                    document.getElementById('finance-amount').value = rec.amount;
                    document.getElementById('finance-account-input').value = rec.account_name || '';
                    selectedFinanceAccountId = rec.account_id;
                    document.getElementById('finance-category-input').value = rec.category_name || '';
                    selectedFinanceCategoryId = rec.category_id || null;
                    document.getElementById('finance-date').value = rec.record_date || today;
                    document.getElementById('finance-description').value = rec.description || '';

                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å—É–º–º—É –≤ —é–∞–Ω—è—Ö –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
                    if (rec.yuan_amount) {
                        document.getElementById('finance-yuan-amount').value = rec.yuan_amount;
                    }

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—É—é —Å–µ–∫—Ü–∏—é –∏ –ø–ª–∞–Ω-—Å–µ–∫—Ü–∏—é
                    checkFinanceContainerSection();
                    checkFinancePlanSection();
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ —é–∞–Ω–µ–π
                    checkFinanceYuanField();
                    checkFinanceDescriptionField();
                    checkFinanceOfficialField();
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ ¬´–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥¬ª –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
                    if (rec.is_official !== null && rec.is_official !== undefined) {
                        const radio = document.querySelector('input[name="finance-is-official"][value="' + rec.is_official + '"]');
                        if (radio) radio.checked = true;
                    }

                    // –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö
                    if (rec.has_distributions) {
                        loadFinanceDistributionsForEdit(editId);
                    }
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–ª–∞–Ω-—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
                    loadFinancePlanDistributionsForEdit(editId);
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    loadFinanceEditFiles(editId);
                }
                document.getElementById('finance-save-btn').textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
            } else {
                document.getElementById('finance-save-btn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            }

            // –ü–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª –∫ —Ñ–æ—Ä–º–µ
            form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            document.getElementById('finance-amount').focus();
        }

        /**
         * –°–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –∏ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ø–æ–ª—è.
         */
        function cancelFinanceForm() {
            document.getElementById('finance-form').style.display = 'none';
            document.getElementById('finance-yuan-amount').value = '';
            document.getElementById('finance-yuan-field').style.display = 'none';
            const fileInput = document.getElementById('finance-files');
            if (fileInput) fileInput.value = '';
            const existFiles = document.getElementById('finance-existing-files');
            if (existFiles) existFiles.style.display = 'none';
            const descInput = document.getElementById('finance-description');
            if (descInput) { descInput.style.borderColor = ''; descInput.placeholder = '–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'; }
            const descLabel = document.getElementById('finance-description-label');
            if (descLabel) descLabel.textContent = '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π';
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª–µ ¬´–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥¬ª
            const officialField = document.getElementById('finance-official-field');
            if (officialField) officialField.style.display = 'none';
            document.querySelectorAll('input[name="finance-is-official"]').forEach(r => r.checked = false);
            currentFinanceEditId = null;
            selectedFinanceAccountId = null;
            selectedFinanceCategoryId = null;
            resetFinanceContainerSection();
            resetFinancePlanSection();
        }

        /**
         * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –∑–∞–ø–∏—Å—å (–Ω–æ–≤—É—é –∏–ª–∏ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—É—é).
         * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø–æ–ª—è, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ API, –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–∞–±–ª–∏—Ü—É.
         */
        async function saveFinanceRecord() {
            const recordType = document.getElementById('finance-type').value;
            const amountStr = document.getElementById('finance-amount').value;
            const accountInput = document.getElementById('finance-account-input').value.trim();
            const categoryInput = document.getElementById('finance-category-input').value.trim();
            const recordDate = document.getElementById('finance-date').value;
            const description = document.getElementById('finance-description').value.trim();

            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            const amount = parseFloat(amountStr);
            if (!amount || amount <= 0) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –±–æ–ª—å—à–µ 0');
                document.getElementById('finance-amount').focus();
                return;
            }

            if (!selectedFinanceAccountId) {
                // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Å—á—ë—Ç –ø–æ –≤–≤–µ–¥—ë–Ω–Ω–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é
                const found = financeAccounts.find(a => a.name.toLowerCase() === accountInput.toLowerCase());
                if (found) {
                    selectedFinanceAccountId = found.id;
                } else {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å—á—ë—Ç –∏–∑ —Å–ø–∏—Å–∫–∞. –ù–æ–≤—ã–µ —Å—á–µ—Ç–∞ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞–º–∏¬ª');
                    document.getElementById('finance-account-input').focus();
                    return;
                }
            }

            if (!selectedFinanceCategoryId) {
                // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ –≤–≤–µ–¥—ë–Ω–Ω–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é
                const foundCat = financeCategories.find(c => c.name.toLowerCase() === categoryInput.toLowerCase());
                if (foundCat) {
                    selectedFinanceCategoryId = foundCat.id;
                } else {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ —Å–ø–∏—Å–∫–∞. –ù–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏¬ª');
                    document.getElementById('finance-category-input').focus();
                    return;
                }
            }

            // –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è "–î—Ä—É–≥–æ–µ" –∏–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–∞—è ‚Äî –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
            const selectedCat = financeCategories.find(c => c.id === selectedFinanceCategoryId);
            const selectedCatName = selectedCat?.name || categoryInput;
            if (selectedCatName.toLowerCase() === '–¥—Ä—É–≥–æ–µ' && !description) {
                alert('–ü—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–î—Ä—É–≥–æ–µ" –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
                document.getElementById('finance-description').focus();
                return;
            }
            if (selectedCat?.requires_description && !description) {
                const hint = selectedCat.description_hint || '–û–ø–∏—Å–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –¥–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
                alert(hint);
                document.getElementById('finance-description').focus();
                return;
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º—ã –≤ —é–∞–Ω—è—Ö (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å requires_yuan)
            const yuanAmountStr = document.getElementById('finance-yuan-amount').value;
            const yuanAmount = parseFloat(yuanAmountStr) || 0;
            if (selectedCat?.requires_yuan && yuanAmount <= 0) {
                alert('–î–ª—è –¥–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Å—É–º–º—É –≤ —é–∞–Ω—è—Ö');
                document.getElementById('finance-yuan-amount').focus();
                return;
            }

            if (!recordDate) {
                alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É');
                document.getElementById('finance-date').focus();
                return;
            }

            const todayStr = new Date().toISOString().split('T')[0];
            if (recordDate > todayStr) {
                alert('–î–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π');
                document.getElementById('finance-date').focus();
                return;
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è ¬´–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥¬ª ‚Äî –µ—Å–ª–∏ —Å—á—ë—Ç —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–≤–µ—Ç
            let isOfficialValue = null;
            const selectedAcc = financeAccounts.find(a => a.id === selectedFinanceAccountId);
            if (selectedAcc?.requires_official && recordType === 'expense') {
                const officialRadio = document.querySelector('input[name="finance-is-official"]:checked');
                if (!officialRadio) {
                    alert('–£–∫–∞–∂–∏—Ç–µ, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ä–∞—Å—Ö–æ–¥ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º (–î–∞ / –ù–µ—Ç)');
                    return;
                }
                isOfficialValue = parseInt(officialRadio.value);
            }

            const payload = {
                record_type: recordType,
                amount: amount,
                account_id: selectedFinanceAccountId,
                category_id: selectedFinanceCategoryId,
                description: description,
                record_date: recordDate
            };

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–º–µ—Ç–∫—É ¬´–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥¬ª –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ
            if (isOfficialValue !== null) {
                payload.is_official = isOfficialValue;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º —Å—É–º–º—É –≤ —é–∞–Ω—è—Ö –µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞
            if (yuanAmount > 0) {
                payload.yuan_amount = yuanAmount;
            }

            // –°–æ–±–∏—Ä–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º (–µ—Å–ª–∏ —Å–µ–∫—Ü–∏—è –≤–∏–¥–Ω–∞ –∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
            const containerSection = document.getElementById('finance-container-section');
            if (containerSection && containerSection.style.display !== 'none') {
                const distributions = collectFinanceDistributions();
                if (distributions.length > 0) {
                    // –í–∞–ª–∏–¥–∞—Ü–∏—è: —Å—É–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π == —Å—É–º–º–µ –∑–∞–ø–∏—Å–∏
                    const distTotal = distributions.reduce((sum, d) => sum + d.amount, 0);
                    if (Math.abs(distTotal - amount) > 0.01) {
                        alert(`–°—É–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π (${distTotal.toLocaleString('ru-RU')} ‚ÇΩ) –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Å—É–º–º–æ–π –∑–∞–ø–∏—Å–∏ (${amount.toLocaleString('ru-RU')} ‚ÇΩ)`);
                        return;
                    }
                    payload.distributions = distributions;
                }
            }

            // –°–æ–±–∏—Ä–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –ø–ª–∞–Ω—É (–µ—Å–ª–∏ —Å–µ–∫—Ü–∏—è –≤–∏–¥–Ω–∞ –∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
            const planSection = document.getElementById('finance-plan-section');
            if (planSection && planSection.style.display !== 'none') {
                const planDists = collectFinancePlanDistributions();
                if (planDists.length > 0) {
                    // –í–∞–ª–∏–¥–∞—Ü–∏—è: —Å—É–º–º–∞ —é–∞–Ω–µ–π —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π == —Å—É–º–º–µ —é–∞–Ω–µ–π –∑–∞–ø–∏—Å–∏
                    const planDistTotal = planDists.reduce((sum, d) => sum + d.yuan_amount, 0);
                    if (Math.abs(planDistTotal - yuanAmount) > 0.01) {
                        alert('–°—É–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –ø–æ –ø–ª–∞–Ω—É (' + planDistTotal.toLocaleString('ru-RU') + ' ¬•) –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Å—É–º–º–æ–π –≤ —é–∞–Ω—è—Ö (' + yuanAmount.toLocaleString('ru-RU') + ' ¬•)');
                        return;
                    }
                    payload.plan_distributions = planDists;
                }
            }

            try {
                let url = '/api/finance/records/add';
                if (currentFinanceEditId) {
                    url = '/api/finance/records/update';
                    payload.id = currentFinanceEditId;
                }

                const fileInput = document.getElementById('finance-files');
                const files = fileInput ? fileInput.files : [];
                let resp;

                if (files.length > 0) {
                    const formData = new FormData();
                    for (const [key, value] of Object.entries(payload)) {
                        if (key === 'distributions' || key === 'plan_distributions') {
                            formData.append(key, JSON.stringify(value));
                        } else {
                            formData.append(key, value);
                        }
                    }
                    for (const file of files) {
                        formData.append('files', file);
                    }
                    resp = await authFetch(url, {
                        method: 'POST',
                        body: formData
                    });
                } else {
                    resp = await authFetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }
                const data = await resp.json();

                if (data.success) {
                    cancelFinanceForm();
                    loadFinanceRecords();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏');
            }
        }

        /**
         * –ù–∞—á–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É —Å –¥–∞–Ω–Ω—ã–º–∏).
         */
        function editFinanceRecord(id) {
            showFinanceForm(id);
        }

        /**
         * –£–¥–∞–ª–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –∑–∞–ø–∏—Å—å (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º).
         */
        async function deleteFinanceRecord(id) {
            const input = prompt('–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ  —É–¥–∞–ª–∏—Ç—å');
            if (!input || input.trim().toLowerCase() !== '—É–¥–∞–ª–∏—Ç—å') return;

            try {
                const resp = await authFetch('/api/finance/records/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id })
                });
                const data = await resp.json();

                if (data.success) {
                    loadFinanceRecords();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', e);
            }
        }

        /**
         * –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤ –≤ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
         */
        function resetFinanceFilters() {
            document.getElementById('finance-filter-type').value = '';
            document.getElementById('finance-filter-account').value = '';
            document.getElementById('finance-filter-category').value = '';
            document.getElementById('finance-filter-official').value = '';
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–µ—Ä–∏–æ–¥ ‚Äî –≤—Å—è –∏—Å—Ç–æ—Ä–∏—è
            document.getElementById('finance-period').value = 'all';
            applyFinancePeriod();
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ, —Ç.–∫. —Ç–∏–ø —Å–±—Ä–æ—à–µ–Ω)
            updateFinanceCategoryFilter();
            loadFinanceRecords();
        }

        // ============================================
        // Dropdown —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–∞–º–∏/–∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
        // ============================================
        // –ü–æ–≤—Ç–æ—Ä—è–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω destination-dropdown –∏–∑ –º–æ–¥—É–ª—è –æ—Ç–≥—Ä—É–∑–æ–∫.

        /**
         * –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Å—á–µ—Ç–æ–≤.
         * –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ –≤–≤–µ–¥—ë–Ω–Ω–æ–º—É —Ç–µ–∫—Å—Ç—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∫—É –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π.
         */
        function renderFinanceAccountDropdown(filter) {
            const dropdown = document.getElementById('finance-account-dropdown');
            if (!dropdown) return;

            const filterLower = (filter || '').toLowerCase();
            const filtered = filterLower
                ? financeAccounts.filter(a => a.name.toLowerCase().includes(filterLower))
                : financeAccounts;

            dropdown.innerHTML = '';

            filtered.forEach(acc => {
                const item = document.createElement('div');
                item.className = 'destination-dropdown-item';
                if (selectedFinanceAccountId === acc.id) {
                    item.className += ' selected';
                }
                item.textContent = acc.name;
                item.onclick = () => selectFinanceAccount(acc.name, acc.id);
                dropdown.appendChild(item);
            });

            if (filtered.length === 0 && filter) {
                const item = document.createElement('div');
                item.className = 'destination-dropdown-item';
                item.style.color = '#999';
                item.style.fontSize = '13px';
                item.textContent = '–ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å "' + filter + '"';
                dropdown.appendChild(item);
            }
        }

        /**
         * –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å dropdown —Å—á–µ—Ç–æ–≤.
         */
        function toggleFinanceAccountDropdown() {
            const dropdown = document.getElementById('finance-account-dropdown');
            const input = document.getElementById('finance-account-input');
            if (!dropdown) return;

            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
            } else {
                renderFinanceAccountDropdown(input.value);
                dropdown.classList.add('show');
            }
        }

        /**
         * –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å dropdown –ø—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞.
         */
        function filterFinanceAccounts() {
            const dropdown = document.getElementById('finance-account-dropdown');
            const input = document.getElementById('finance-account-input');
            if (!dropdown) return;

            selectedFinanceAccountId = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –ø—Ä–∏ —Ä—É—á–Ω–æ–º –≤–≤–æ–¥–µ
            renderFinanceAccountDropdown(input.value);
            dropdown.classList.add('show');
        }

        /**
         * –í—ã–±—Ä–∞—Ç—å —Å—á—ë—Ç –∏–∑ dropdown.
         */
        function selectFinanceAccount(name, id) {
            const input = document.getElementById('finance-account-input');
            const dropdown = document.getElementById('finance-account-dropdown');
            input.value = name;
            selectedFinanceAccountId = id;
            dropdown.classList.remove('show');
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ ¬´–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥?¬ª
            checkFinanceOfficialField();
        }

        // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –∑–∞–∫—Ä—ã—Ç–∏–µ dropdown —Å—á–µ—Ç–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ–±—â–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º
        // –≤ —Å–µ–∫—Ü–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–∑–∞–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ dropdown –≤ #finance-form)

        // ============================================
        // –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–∞–º–∏ (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ)
        // ============================================

        /**
         * –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–∞–º–∏.
         */
        function toggleFinanceAccountsManager() {
            const panel = document.getElementById('finance-accounts-manager');
            const otherPanel = document.getElementById('finance-categories-manager');
            if (panel.style.display === 'none') {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞
                if (otherPanel) otherPanel.style.display = 'none';
                panel.style.display = 'block';
                renderFinanceAccountsList();
                panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                panel.style.display = 'none';
            }
        }

        /**
         * –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Å—á–µ—Ç–æ–≤ —Å –∫–Ω–æ–ø–∫–∞–º–∏ —É–¥–∞–ª–µ–Ω–∏—è.
         */
        function renderFinanceAccountsList() {
            const container = document.getElementById('finance-accounts-list');
            if (!container) return;

            if (financeAccounts.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 13px;">–ù–µ—Ç —Å—á–µ—Ç–æ–≤</p>';
                return;
            }

            container.innerHTML = '';
            financeAccounts.forEach(acc => {
                const row = document.createElement('div');
                row.style.cssText = 'display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-bottom: 1px solid #f0f0f0;';

                const name = document.createElement('span');
                name.textContent = acc.name;
                name.style.cssText = 'flex: 1; font-size: 14px;';
                row.appendChild(name);

                // –ß–µ–∫–±–æ–∫—Å ¬´–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π¬ª ‚Äî –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–∞—Å—Ö–æ–¥–∞ —Å —ç—Ç–æ–≥–æ —Å—á—ë—Ç–∞ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –î–∞/–ù–µ—Ç
                const officialLabel = document.createElement('label');
                officialLabel.className = 'finance-category-container-link';
                const officialCb = document.createElement('input');
                officialCb.type = 'checkbox';
                officialCb.checked = !!acc.requires_official;
                officialCb.onchange = async () => {
                    try {
                        const resp = await authFetch('/api/finance/accounts/update', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ id: acc.id, requires_official: officialCb.checked })
                        });
                        const result = await resp.json();
                        if (result.success) {
                            acc.requires_official = officialCb.checked ? 1 : 0;
                            await loadFinanceAccounts();
                        }
                    } catch(e) { console.error(e); }
                };
                officialLabel.appendChild(officialCb);
                officialLabel.appendChild(document.createTextNode(' –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π'));
                row.appendChild(officialLabel);

                const editBtn = document.createElement('button');
                editBtn.textContent = '‚úé';
                editBtn.title = '–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Å—á—ë—Ç';
                editBtn.style.cssText = 'background: none; border: 1px solid #e0e0e0; border-radius: 4px; color: #999; cursor: pointer; padding: 4px 8px; font-size: 13px; transition: all 0.2s;';
                editBtn.onmouseenter = () => { editBtn.style.color = '#3b82f6'; editBtn.style.borderColor = '#3b82f6'; };
                editBtn.onmouseleave = () => { editBtn.style.color = '#999'; editBtn.style.borderColor = '#e0e0e0'; };
                editBtn.onclick = () => renameFinanceAccount(acc.id, acc.name);
                row.appendChild(editBtn);

                const delBtn = document.createElement('button');
                delBtn.textContent = '‚úï';
                delBtn.title = '–£–¥–∞–ª–∏—Ç—å —Å—á—ë—Ç';
                delBtn.style.cssText = 'background: none; border: 1px solid #e0e0e0; border-radius: 4px; color: #999; cursor: pointer; padding: 4px 8px; font-size: 13px; transition: all 0.2s;';
                delBtn.onmouseenter = () => { delBtn.style.color = '#ef4444'; delBtn.style.borderColor = '#ef4444'; };
                delBtn.onmouseleave = () => { delBtn.style.color = '#999'; delBtn.style.borderColor = '#e0e0e0'; };
                delBtn.onclick = () => deleteFinanceAccount(acc.id, acc.name);
                row.appendChild(delBtn);

                container.appendChild(row);
            });
        }

        /**
         * –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å—á—ë—Ç.
         * –û–±–Ω–æ–≤–ª—è–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ –∏ –≤–æ –≤—Å–µ—Ö –∑–∞–ø–∏—Å—è—Ö –∏—Å—Ç–æ—Ä–∏–∏.
         */
        async function renameFinanceAccount(id, currentName) {
            const newName = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —Å—á—ë—Ç–∞ ¬´' + currentName + '¬ª:', currentName);
            if (!newName || newName.trim() === '' || newName.trim() === currentName) return;

            try {
                const resp = await authFetch('/api/finance/accounts/rename', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, new_name: newName.trim() })
                });
                const data = await resp.json();

                if (data.success) {
                    await loadFinanceAccounts();
                    renderFinanceAccountsList();
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –∑–∞–ø–∏—Å–µ–π, —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
                    if (typeof loadFinanceRecords === 'function') loadFinanceRecords();
                    alert(data.message);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —Å—á—ë—Ç–∞:', e);
            }
        }

        /**
         * –£–¥–∞–ª–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å—á—ë—Ç.
         */
        async function deleteFinanceAccount(id, name) {
            const input = prompt('–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å—á—ë—Ç–∞ "' + name + '" –≤–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ  —É–¥–∞–ª–∏—Ç—å');
            if (!input || input.trim().toLowerCase() !== '—É–¥–∞–ª–∏—Ç—å') return;

            try {
                const resp = await authFetch('/api/finance/accounts/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id })
                });
                const data = await resp.json();

                if (data.success) {
                    await loadFinanceAccounts();
                    renderFinanceAccountsList();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—á—ë—Ç–∞:', e);
            }
        }

        /**
         * –î–æ–±–∞–≤–∏—Ç—å —Å—á—ë—Ç –∏–∑ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.
         */
        async function addFinanceAccountFromManager() {
            const input = document.getElementById('finance-new-account-name');
            const name = (input.value || '').trim();

            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—á—ë—Ç–∞');
                input.focus();
                return;
            }

            try {
                const resp = await authFetch('/api/finance/accounts/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        requires_official: document.getElementById('finance-new-account-requires-official')?.checked ? true : false
                    })
                });
                const data = await resp.json();

                if (data.success) {
                    input.value = '';
                    const offCb = document.getElementById('finance-new-account-requires-official');
                    if (offCb) offCb.checked = false;
                    await loadFinanceAccounts();
                    renderFinanceAccountsList();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—á—ë—Ç–∞:', e);
            }
        }


        // ============================================
        // Dropdown —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ (–≤ —Ñ–æ—Ä–º–µ)
        // ============================================
        // –ü–æ–≤—Ç–æ—Ä—è–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω destination-dropdown –∏–∑ —Å—á–µ—Ç–æ–≤.

        /**
         * –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π.
         * –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ –≤–≤–µ–¥—ë–Ω–Ω–æ–º—É —Ç–µ–∫—Å—Ç—É.
         */
        function renderFinanceCategoryDropdown(filter) {
            const dropdown = document.getElementById('finance-category-dropdown');
            if (!dropdown) return;

            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ç–µ–∫—É—â–µ–º—É —Ç–∏–ø—É –∑–∞–ø–∏—Å–∏ (—Ä–∞—Å—Ö–æ–¥/–¥–æ—Ö–æ–¥)
            const currentType = document.getElementById('finance-type')?.value || 'expense';
            const byType = financeCategories.filter(c => c.record_type === currentType);

            const filterLower = (filter || '').toLowerCase();
            const filtered = filterLower
                ? byType.filter(c => c.name.toLowerCase().includes(filterLower))
                : byType;

            dropdown.innerHTML = '';

            filtered.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'destination-dropdown-item';
                if (selectedFinanceCategoryId === cat.id) {
                    item.className += ' selected';
                }
                item.textContent = cat.name;
                item.onclick = () => selectFinanceCategory(cat.name, cat.id);
                dropdown.appendChild(item);
            });

            if (filtered.length === 0 && filter) {
                const item = document.createElement('div');
                item.className = 'destination-dropdown-item';
                item.style.color = '#999';
                item.style.fontSize = '13px';
                item.textContent = '–ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å "' + filter + '"';
                dropdown.appendChild(item);
            }
        }

        /**
         * –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å dropdown –∫–∞—Ç–µ–≥–æ—Ä–∏–π.
         */
        function toggleFinanceCategoryDropdown() {
            const dropdown = document.getElementById('finance-category-dropdown');
            const input = document.getElementById('finance-category-input');
            if (!dropdown) return;

            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
            } else {
                renderFinanceCategoryDropdown(input.value);
                dropdown.classList.add('show');
            }
        }

        /**
         * –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å dropdown –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞.
         */
        function filterFinanceCategories() {
            const dropdown = document.getElementById('finance-category-dropdown');
            const input = document.getElementById('finance-category-input');
            if (!dropdown) return;

            selectedFinanceCategoryId = null;
            renderFinanceCategoryDropdown(input.value);
            dropdown.classList.add('show');
        }

        /**
         * –í—ã–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ dropdown.
         */
        function selectFinanceCategory(name, id) {
            const input = document.getElementById('finance-category-input');
            const dropdown = document.getElementById('finance-category-dropdown');
            input.value = name;
            selectedFinanceCategoryId = id;
            dropdown.classList.remove('show');
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å —Å–µ–∫—Ü–∏—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –ø–ª–∞–Ω–∞
            checkFinanceContainerSection();
            checkFinancePlanSection();
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ —Å—É–º–º—ã –≤ —é–∞–Ω—è—Ö
            checkFinanceYuanField();
            checkFinanceDescriptionField();
        }

        /**
         * –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é —á–µ—Ä–µ–∑ API (–∏–∑ —Ñ–æ—Ä–º—ã).
         * –í–≤–µ–¥—ë–Ω–Ω–æ–µ –≤ input –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫.
         */
        // –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', function(e) {
            const wrappers = document.querySelectorAll('#finance-form .destination-dropdown-wrapper');
            wrappers.forEach(function(wrapper) {
                const dropdown = wrapper.querySelector('.destination-dropdown');
                if (dropdown && !wrapper.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
        });

        // ============================================
        // –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ)
        // ============================================

        /**
         * –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏.
         */
        function toggleFinanceCategoriesManager() {
            const panel = document.getElementById('finance-categories-manager');
            const otherPanel = document.getElementById('finance-accounts-manager');
            if (panel.style.display === 'none') {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Å—á–µ—Ç–æ–≤, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞
                if (otherPanel) otherPanel.style.display = 'none';
                panel.style.display = 'block';
                renderFinanceCategoriesList();
                panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                panel.style.display = 'none';
            }
        }

        /**
         * –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å –∫–Ω–æ–ø–∫–∞–º–∏ —É–¥–∞–ª–µ–Ω–∏—è.
         */
        function renderFinanceCategoriesList() {
            const container = document.getElementById('finance-categories-list');
            if (!container) return;

            if (financeCategories.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 13px;">–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π</p>';
                return;
            }

            container.innerHTML = '';
            financeCategories.forEach(cat => {
                const row = document.createElement('div');
                row.style.cssText = 'display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-bottom: 1px solid #f0f0f0;';

                const name = document.createElement('span');
                name.style.cssText = 'flex: 1; font-size: 14px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;';
                const nameText = document.createElement('span');
                nameText.textContent = cat.name;
                nameText.style.cursor = 'pointer';
                nameText.title = '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è';
                nameText.onclick = () => renameFinanceCategory(cat.id, cat.name);
                name.appendChild(nameText);
                const badge = document.createElement('span');
                badge.textContent = cat.record_type === 'income' ? 'üìà –î–æ—Ö–æ–¥' : 'üìâ –†–∞—Å—Ö–æ–¥';
                badge.style.cssText = 'font-size: 11px; padding: 2px 6px; border-radius: 4px; ' +
                    (cat.record_type === 'income' ? 'background: #dcfce7; color: #16a34a;' : 'background: #fee2e2; color: #dc2626;');
                name.appendChild(badge);
                // –§–ª–∞–≥ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö)
                if (cat.record_type === 'expense') {
                    const linkLabel = document.createElement('label');
                    linkLabel.className = 'finance-category-container-link';
                    const linkCb = document.createElement('input');
                    linkCb.type = 'checkbox';
                    linkCb.checked = !!cat.is_container_linked;
                    linkCb.onchange = async () => {
                        try {
                            const resp = await authFetch('/api/finance/categories/update', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ id: cat.id, is_container_linked: linkCb.checked })
                            });
                            const result = await resp.json();
                            if (result.success) {
                                cat.is_container_linked = linkCb.checked ? 1 : 0;
                                await loadFinanceCategories();
                            }
                        } catch(e) { console.error(e); }
                    };
                    linkLabel.appendChild(linkCb);
                    linkLabel.appendChild(document.createTextNode(' –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã'));
                    name.appendChild(linkLabel);

                    // –ß–µ–∫–±–æ–∫—Å ¬´–Æ–∞–Ω–∏¬ª ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –≤–≤–æ–¥ —Å—É–º–º—ã –≤ —é–∞–Ω—è—Ö
                    const yuanLabel = document.createElement('label');
                    yuanLabel.className = 'finance-category-container-link';
                    const yuanCb = document.createElement('input');
                    yuanCb.type = 'checkbox';
                    yuanCb.checked = !!cat.requires_yuan;
                    yuanCb.onchange = async () => {
                        try {
                            const resp = await authFetch('/api/finance/categories/update', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ id: cat.id, requires_yuan: yuanCb.checked })
                            });
                            const result = await resp.json();
                            if (result.success) {
                                cat.requires_yuan = yuanCb.checked ? 1 : 0;
                                await loadFinanceCategories();
                            }
                        } catch(e) { console.error(e); }
                    };
                    yuanLabel.appendChild(yuanCb);
                    yuanLabel.appendChild(document.createTextNode(' –Æ–∞–Ω–∏'));
                    name.appendChild(yuanLabel);

                    // –ß–µ–∫–±–æ–∫—Å ¬´–û–ø–∏—Å–∞–Ω–∏–µ¬ª ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                    const descLabel = document.createElement('label');
                    descLabel.className = 'finance-category-container-link';
                    const descCb = document.createElement('input');
                    descCb.type = 'checkbox';
                    descCb.checked = !!cat.requires_description;
                    descCb.onchange = async () => {
                        try {
                            const resp = await authFetch('/api/finance/categories/update', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ id: cat.id, requires_description: descCb.checked })
                            });
                            const result = await resp.json();
                            if (result.success) {
                                cat.requires_description = descCb.checked ? 1 : 0;
                                await loadFinanceCategories();
                            }
                        } catch(e) { console.error(e); }
                    };
                    descLabel.appendChild(descCb);
                    descLabel.appendChild(document.createTextNode(' –û–ø–∏—Å–∞–Ω–∏–µ'));
                    name.appendChild(descLabel);

                    // –ß–µ–∫–±–æ–∫—Å ¬´–ü–ª–∞–Ω¬ª ‚Äî –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –ø–ª–∞–Ω—É –∑–∞–∫—É–ø–æ–∫
                    const planLabel = document.createElement('label');
                    planLabel.className = 'finance-category-container-link';
                    const planCb = document.createElement('input');
                    planCb.type = 'checkbox';
                    planCb.checked = !!cat.is_plan_linked;
                    planCb.onchange = async () => {
                        try {
                            const resp = await authFetch('/api/finance/categories/update', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ id: cat.id, is_plan_linked: planCb.checked })
                            });
                            const result = await resp.json();
                            if (result.success) {
                                cat.is_plan_linked = planCb.checked ? 1 : 0;
                                await loadFinanceCategories();
                            }
                        } catch(e) { console.error(e); }
                    };
                    planLabel.appendChild(planCb);
                    planLabel.appendChild(document.createTextNode(' –ü–ª–∞–Ω'));
                    name.appendChild(planLabel);

                    // –ü–æ–ª–µ ¬´–ü–æ–¥—Å–∫–∞–∑–∫–∞¬ª ‚Äî —Ç–µ–∫—Å—Ç-–ø—Ä–∏–º–µ—Ä –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è (–≤–∏–¥–µ–Ω –≤—Å–µ–≥–¥–∞ –¥–ª—è —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö)
                    const hintWrap = document.createElement('div');
                    hintWrap.style.cssText = 'width: 100%; margin-top: 4px;';
                    const hintInput = document.createElement('input');
                    hintInput.type = 'text';
                    hintInput.className = 'wh-input';
                    hintInput.value = cat.description_hint || '';
                    hintInput.placeholder = '–¢–µ–∫—Å—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è';
                    hintInput.style.cssText = 'width: 100%; font-size: 12px; padding: 4px 8px;';
                    let hintTimeout = null;
                    hintInput.oninput = () => {
                        clearTimeout(hintTimeout);
                        hintTimeout = setTimeout(async () => {
                            try {
                                const resp = await authFetch('/api/finance/categories/update', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ id: cat.id, description_hint: hintInput.value })
                                });
                                const result = await resp.json();
                                if (result.success) cat.description_hint = hintInput.value;
                            } catch(e) { console.error(e); }
                        }, 800);
                    };
                    hintWrap.appendChild(hintInput);
                    name.appendChild(hintWrap);
                }
                row.appendChild(name);

                const renBtn = document.createElement('button');
                renBtn.innerHTML = '&#9998;';
                renBtn.title = '–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
                renBtn.style.cssText = 'background: none; border: 1px solid #e0e0e0; border-radius: 4px; color: #999; cursor: pointer; padding: 4px 8px; font-size: 13px; transition: all 0.2s;';
                renBtn.onmouseenter = () => { renBtn.style.borderColor = '#3b82f6'; };
                renBtn.onmouseleave = () => { renBtn.style.borderColor = '#e0e0e0'; };
                renBtn.onclick = () => renameFinanceCategory(cat.id, cat.name);
                row.appendChild(renBtn);

                const delBtn = document.createElement('button');
                delBtn.textContent = '‚úï';
                delBtn.title = '–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
                delBtn.style.cssText = 'background: none; border: 1px solid #e0e0e0; border-radius: 4px; color: #999; cursor: pointer; padding: 4px 8px; font-size: 13px; transition: all 0.2s;';
                delBtn.onmouseenter = () => { delBtn.style.color = '#ef4444'; delBtn.style.borderColor = '#ef4444'; };
                delBtn.onmouseleave = () => { delBtn.style.color = '#999'; delBtn.style.borderColor = '#e0e0e0'; };
                delBtn.onclick = () => deleteFinanceCategory(cat.id, cat.name);
                row.appendChild(delBtn);

                container.appendChild(row);
            });
        }

        /**
         * –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º).
         */
        async function renameFinanceCategory(id, currentName) {
            const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "' + currentName + '":', currentName);
            if (!newName || newName.trim() === '' || newName.trim() === currentName) return;

            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é ¬´' + currentName + '¬ª –≤ ¬´' + newName.trim() + '¬ª?\\n\\n–ù–∞–∑–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è –≤–æ –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å—è—Ö.')) return;

            try {
                const resp = await authFetch('/api/finance/categories/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, name: newName.trim() })
                });
                const data = await resp.json();

                if (data.success) {
                    await loadFinanceCategories();
                    renderFinanceCategoriesList();
                    loadFinanceRecords();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', e);
            }
        }

        /**
         * –£–¥–∞–ª–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –≤–≤–æ–¥–∞ —Å–ª–æ–≤–∞ "—É–¥–∞–ª–∏—Ç—å").
         */
        async function deleteFinanceCategory(id, name) {
            const input = prompt('–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "' + name + '" –≤–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ  —É–¥–∞–ª–∏—Ç—å');
            if (!input || input.trim().toLowerCase() !== '—É–¥–∞–ª–∏—Ç—å') return;

            try {
                const resp = await authFetch('/api/finance/categories/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id })
                });
                const data = await resp.json();

                if (data.success) {
                    await loadFinanceCategories();
                    renderFinanceCategoriesList();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', e);
            }
        }

        /**
         * –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.
         */
        async function addFinanceCategoryFromManager() {
            const input = document.getElementById('finance-new-category-name');
            const name = (input.value || '').trim();
            const catType = document.getElementById('finance-new-category-type')?.value || 'expense';

            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
                input.focus();
                return;
            }

            try {
                const resp = await authFetch('/api/finance/categories/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        record_type: catType,
                        is_container_linked: document.getElementById('finance-new-category-container-linked')?.checked ? true : false,
                        requires_yuan: document.getElementById('finance-new-category-requires-yuan')?.checked ? true : false,
                        requires_description: document.getElementById('finance-new-category-requires-description')?.checked ? true : false,
                        description_hint: document.getElementById('finance-new-category-description-hint')?.value || '',
                        is_plan_linked: document.getElementById('finance-new-category-plan-linked')?.checked ? true : false
                    })
                });
                const data = await resp.json();

                if (data.success) {
                    input.value = '';
                    const cb = document.getElementById('finance-new-category-container-linked');
                    if (cb) cb.checked = false;
                    const yuanCb = document.getElementById('finance-new-category-requires-yuan');
                    if (yuanCb) yuanCb.checked = false;
                    const descCb = document.getElementById('finance-new-category-requires-description');
                    if (descCb) descCb.checked = false;
                    const hintInput = document.getElementById('finance-new-category-description-hint');
                    if (hintInput) hintInput.value = '';
                    const planCb = document.getElementById('finance-new-category-plan-linked');
                    if (planCb) planCb.checked = false;
                    await loadFinanceCategories();
                    renderFinanceCategoriesList();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', e);
            }
        }


        // ============================================================================
        // –ü–û–î–í–ö–õ–ê–î–ö–ò –§–ò–ù–ê–ù–°–û–í + –ü–ï–ù–î–ï–õ–¨
        // ============================================================================

        let pendelDataLoaded = false;
        let pendelCache = {};
        let realizationInitialized = false;  // –§–ª–∞–≥: date-–ø–∏–∫–µ—Ä—ã —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã

        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥–≤–∫–ª–∞–¥–æ–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤ (–ó–∞–ø–∏—Å–∏ / –ü–µ–Ω–¥–µ–ª—å / –†–µ–∞–ª–∏–∑–∞—Ü–∏—è).
         */
        function switchFinanceSubtab(e, subtab) {
            document.querySelectorAll('.finance-subtab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.finance-subtab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(subtab).classList.add('active');
            e.target.classList.add('active');
            location.hash = 'finance:' + subtab;

            if (subtab === 'finance-pendel' && !pendelDataLoaded) {
                loadPendelData();
            }
            if (subtab === 'finance-realization' && !realizationInitialized) {
                initRealizationMonthSelect();
            }
            if (subtab === 'finance-nds') {
                ndsLoadSettings();
                ndsLoadYtd();
            }
        }

        /**
         * –ü—Ä–æ–≥—Ä–∞–º–º–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–≤–∫–ª–∞–¥–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤ (–¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ hash).
         */
        function activateFinanceSubtab(subtab) {
            document.querySelectorAll('.finance-subtab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.finance-subtab-btn').forEach(el => el.classList.remove('active'));

            const subtabContent = document.getElementById(subtab);
            if (subtabContent) {
                subtabContent.classList.add('active');
            }

            document.querySelectorAll('.finance-subtab-btn').forEach(btn => {
                if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes("'" + subtab + "'")) {
                    btn.classList.add('active');
                }
            });

            if (subtab === 'finance-pendel' && !pendelDataLoaded) {
                loadPendelData();
            }
            if (subtab === 'finance-realization' && !realizationInitialized) {
                initRealizationMonthSelect();
            }
            if (subtab === 'finance-nds') {
                ndsLoadSettings();
                ndsLoadYtd();
            }
        }

        // ============================================================================
        // –ö–û–ù–¢–†–û–õ–¨ –ù–î–° ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
        // ============================================================================

        const _ndsOriginal = {1: {percent: '', amount: ''}, 2: {percent: '', amount: ''}};
        let _ndsSettingsLoaded = false;

        /** –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ù–î–°-—Å—Ç–∞–≤–∫–∏ –∏–∑ –ë–î –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏ */
        async function ndsLoadSettings() {
            if (_ndsSettingsLoaded) return;
            _ndsSettingsLoaded = true;
            try {
                const resp = await authFetch('/api/settings?key=nds_rows');
                const data = await resp.json();
                if (data.success && data.value) {
                    const rows = JSON.parse(data.value);
                    if (rows[1]) {
                        document.getElementById('nds-row1-percent').value = rows[1].percent || '';
                        const amt1 = document.getElementById('nds-row1-amount');
                        amt1.value = rows[1].amount || '';
                        if (amt1.value) ndsFormatAmount(amt1);
                    }
                    if (rows[2]) {
                        document.getElementById('nds-row2-percent').value = rows[2].percent || '';
                        const amt2 = document.getElementById('nds-row2-amount');
                        amt2.value = rows[2].amount || '';
                        if (amt2.value) ndsFormatAmount(amt2);
                    }
                }
            } catch (e) {
                console.error('[NDS] load settings error:', e);
            }
        }

        /** –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —á–∏—Å–ª–æ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á (–ø—Ä–æ–±–µ–ª–∞–º–∏) */
        function ndsFormatAmount(input) {
            const pos = input.selectionStart;
            const oldLen = input.value.length;
            // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã, —Ç–æ—á–∫—É/–∑–∞–ø—è—Ç—É—é –∏ –º–∏–Ω—É—Å
            let raw = input.value.replace(/[^\d.,-]/g, '').replace(',', '.');
            // –†–∞–∑–¥–µ–ª—è–µ–º —Ü–µ–ª—É—é –∏ –¥—Ä–æ–±–Ω—É—é —á–∞—Å—Ç–∏
            const parts = raw.split('.');
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ü–µ–ª—É—é —á–∞—Å—Ç—å —Å –ø—Ä–æ–±–µ–ª–∞–º–∏
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            input.value = parts.length > 1 ? parts[0] + '.' + parts[1] : parts[0];
            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞
            const newLen = input.value.length;
            input.setSelectionRange(pos + (newLen - oldLen), pos + (newLen - oldLen));
        }

        /** –ö–ª–∏–∫ –ø–æ –∫–∞—Ä–∞–Ω–¥–∞—à—É ‚Äî –≤–∫–ª—é—á–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏ */
        function ndsStartEdit(row) {
            const pct = document.getElementById('nds-row' + row + '-percent');
            const amt = document.getElementById('nds-row' + row + '-amount');
            if (!pct || !amt) return;

            _ndsOriginal[row] = {percent: pct.value, amount: amt.value};
            pct.disabled = false;
            amt.disabled = false;
            pct.focus();

            document.getElementById('nds-pen-' + row).style.display = 'none';
            const actions = document.getElementById('nds-actions-' + row);
            actions.style.display = 'inline-flex';
        }

        /** –ö–Ω–æ–ø–∫–∞ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª–µ–π */
        async function ndsSave(row) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è?')) return;

            const pct = document.getElementById('nds-row' + row + '-percent');
            const amt = document.getElementById('nds-row' + row + '-amount');

            // –°–æ–±–∏—Ä–∞–µ–º –æ–±–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–¥–Ω–∏–º –∫–ª—é—á–æ–º
            const rows = {
                1: {
                    percent: document.getElementById('nds-row1-percent').value,
                    amount: document.getElementById('nds-row1-amount').value
                },
                2: {
                    percent: document.getElementById('nds-row2-percent').value,
                    amount: document.getElementById('nds-row2-amount').value
                }
            };

            try {
                await authFetch('/api/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({key: 'nds_rows', value: JSON.stringify(rows)})
                });
            } catch (e) {
                console.error('[NDS] save error:', e);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                return;
            }

            pct.disabled = true;
            amt.disabled = true;
            _ndsOriginal[row] = {percent: pct.value, amount: amt.value};

            document.getElementById('nds-actions-' + row).style.display = 'none';
            document.getElementById('nds-pen-' + row).style.display = '';
        }

        /** –ö–Ω–æ–ø–∫–∞ ¬´–û—Ç–º–µ–Ω–∏—Ç—å¬ª ‚Äî –æ—Ç–∫–∞—Ç –µ—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º) */
        function ndsCancel(row) {
            const pct = document.getElementById('nds-row' + row + '-percent');
            const amt = document.getElementById('nds-row' + row + '-amount');
            const changed = pct.value !== _ndsOriginal[row].percent ||
                            amt.value !== _ndsOriginal[row].amount;

            if (changed) {
                if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ –Ω–µ —Ö–æ—Ç–∏—Ç–µ –≤–Ω–µ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è?')) return;
            }

            pct.value = _ndsOriginal[row].percent;
            amt.value = _ndsOriginal[row].amount;
            pct.disabled = true;
            amt.disabled = true;

            document.getElementById('nds-actions-' + row).style.display = 'none';
            document.getElementById('nds-pen-' + row).style.display = '';
        }

        let _ndsYtdLoaded = false;

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–æ—Ä–æ—Ç —Å 1 —è–Ω–≤–∞—Ä—è —Ç–µ–∫—É—â–µ–≥–æ –≥–æ–¥–∞ (–∞–≤—Ç–æ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏).
         */
        async function ndsLoadYtd() {
            if (_ndsYtdLoaded) return;
            _ndsYtdLoaded = true;

            const year = new Date().getFullYear();
            const dateFrom = year + '-01-01';
            const today = new Date();
            const dateTo = today.getFullYear() + '-' +
                String(today.getMonth() + 1).padStart(2, '0') + '-' +
                String(today.getDate()).padStart(2, '0');

            try {
                const [ddsResp, realResp] = await Promise.all([
                    authFetch('/api/finance/records?' + new URLSearchParams({
                        type: 'income', is_official: '1', date_from: dateFrom, date_to: dateTo
                    })),
                    authFetch('/api/finance/realization?date_from=' +
                        encodeURIComponent(dateFrom) + '&date_to=' + encodeURIComponent(dateTo))
                ]);
                const ddsData = await ddsResp.json();
                const realData = await realResp.json();

                const ddsIncome = ddsData.success && ddsData.summary ? ddsData.summary.total_income : 0;
                let salesAfterSpp = 0;
                if (realData.success && realData.summary) {
                    salesAfterSpp = realData.summary.sales_after_spp || 0;
                    if (realData.buyout) salesAfterSpp += realData.buyout.seller_price_total || 0;
                }

                document.getElementById('nds-ytd-total').textContent = fmtRealMoney(ddsIncome + salesAfterSpp);
                document.getElementById('nds-ytd-loading').style.display = 'none';
                document.getElementById('nds-ytd-result').style.display = '';
            } catch (e) {
                console.error('[NDS YTD] error:', e);
                document.getElementById('nds-ytd-loading').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—â–∏–π –æ–±–æ—Ä–æ—Ç: –ø—Ä–∏—Ö–æ–¥—ã –∏–∑ –î–î–° + –ø—Ä–æ–¥–∞–∂–∏ –ø–æ—Å–ª–µ –°–ü–ü –∏–∑ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.
         * –û–±–∞ –∑–∞–ø—Ä–æ—Å–∞ –∏–¥—É—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ. –ü—Ä–∏—Ö–æ–¥—ã –î–î–° —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.
         */
        async function ndsLoadTurnover() {
            const dateFrom = document.getElementById('nds-turnover-date-from').value;
            const dateTo = document.getElementById('nds-turnover-date-to').value;
            const resultEl = document.getElementById('nds-turnover-result');
            const loadingEl = document.getElementById('nds-turnover-loading');
            if (!dateFrom || !dateTo) { resultEl.style.display = 'none'; return; }

            loadingEl.style.display = 'block';
            resultEl.style.display = 'none';

            try {
                const [ddsResp, realResp] = await Promise.all([
                    authFetch('/api/finance/records?' + new URLSearchParams({
                        type: 'income', is_official: '1', date_from: dateFrom, date_to: dateTo
                    })),
                    authFetch('/api/finance/realization?date_from=' +
                        encodeURIComponent(dateFrom) + '&date_to=' + encodeURIComponent(dateTo))
                ]);
                const ddsData = await ddsResp.json();
                const realData = await realResp.json();

                const ddsIncome = ddsData.success && ddsData.summary ? ddsData.summary.total_income : 0;

                // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏—Ö–æ–¥–æ–≤ –î–î–° –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                const catMap = {};
                if (ddsData.success && ddsData.records) {
                    ddsData.records.forEach(r => {
                        const cat = r.category_name || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
                        if (!catMap[cat]) catMap[cat] = 0;
                        catMap[cat] += parseFloat(r.amount) || 0;
                    });
                }
                const categories = Object.entries(catMap).sort((a, b) => b[1] - a[1]);
                let detailsHtml = '';
                categories.forEach(([cat, sum]) => {
                    detailsHtml += '<div class="real-detail-row">' +
                        '<span class="real-detail-label">' + escapeHtml(cat) + '</span>' +
                        '<span class="real-detail-value" style="color:#27ae60;">' + fmtRealMoney(sum) + '</span>' +
                        '</div>';
                });
                document.getElementById('nds-turnover-dds-details').innerHTML = detailsHtml;

                let salesAfterSpp = 0;
                if (realData.success && realData.summary) {
                    salesAfterSpp = realData.summary.sales_after_spp || 0;
                    if (realData.buyout) salesAfterSpp += realData.buyout.seller_price_total || 0;
                }

                const total = ddsIncome + salesAfterSpp;

                document.getElementById('nds-turnover-dds').textContent = fmtRealMoney(ddsIncome);
                document.getElementById('nds-turnover-real').textContent = fmtRealMoney(salesAfterSpp);
                document.getElementById('nds-turnover-total').textContent = fmtRealMoney(total);

                loadingEl.style.display = 'none';
                resultEl.style.display = '';
            } catch (e) {
                console.error('[NDS turnover] error:', e);
                loadingEl.style.display = 'none';
            }
        }

        // ============================================================================
        // –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø ‚Äî –∞–∫—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–∑ Ozon /v2/finance/realization
        // ============================================================================
        // –ü–æ–¥–≤–∫–ª–∞–¥–∫–∞ ¬´–†–µ–∞–ª–∏–∑–∞—Ü–∏—è¬ª –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∞–∫—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–∑ Ozon Seller API
        // /v2/finance/realization –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥—Ä–æ—Å—Å-–ø—Ä–æ–¥–∞–∂–∏,
        // –∫–æ–º–∏—Å—Å–∏–∏, –≤–æ–∑–≤—Ä–∞—Ç—ã ‚Äî —á–∏—Å–ª–∞ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å —Ä–∞–∑–¥–µ–ª–æ–º ¬´–ù–∞—á–∏—Å–ª–µ–Ω–∏—è¬ª Ozon.
        // ============================================================================

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å select –º–µ—Å—è—Ü–∞: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –º–µ—Å—è—Ü–µ–≤, —Ç–µ–∫—É—â–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
         */
        function initRealizationMonthSelect() {
            const sel = document.getElementById('real-month-select');
            if (!sel) return;

            const now = new Date();
            const months = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                            '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];

            sel.innerHTML = '';
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 24 –º–µ—Å—è—Ü–∞: –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤–Ω–∏–∑
            for (let i = 0; i < 24; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const val = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
                const label = months[d.getMonth()] + ' ' + d.getFullYear();
                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = label;
                sel.appendChild(opt);
            }

            realizationInitialized = true;

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –∏ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É
            restoreRealizationState();
        }

        /**
         * –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–∑ localStorage –∏ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.
         */
        function restoreRealizationState() {
            try {
                const savedType = localStorage.getItem('real_period_type');
                const periodSel = document.getElementById('real-period-type');

                if (savedType === 'quarter') {
                    periodSel.value = 'quarter';
                    toggleRealPeriodType(false);
                    const savedQ = localStorage.getItem('real_quarter');
                    if (savedQ) {
                        const qsel = document.getElementById('real-quarter-select');
                        if (qsel) qsel.value = savedQ;
                    }
                } else if (savedType === 'month') {
                    periodSel.value = 'month';
                    toggleRealPeriodType(false);
                    const savedMonth = localStorage.getItem('real_month');
                    if (savedMonth) {
                        const msel = document.getElementById('real-month-select');
                        if (msel) msel.value = savedMonth;
                    }
                } else if (savedType === 'days') {
                    periodSel.value = 'days';
                    toggleRealPeriodType(false);
                    const savedFrom = localStorage.getItem('real_date_from');
                    const savedTo = localStorage.getItem('real_date_to');
                    if (savedFrom) document.getElementById('real-date-from').value = savedFrom;
                    if (savedTo) document.getElementById('real-date-to').value = savedTo;
                } else {
                    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –¥–Ω–∏ (—Å–µ–≥–æ–¥–Ω—è)
                    periodSel.value = 'days';
                    toggleRealPeriodType(false);
                }

                // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                loadRealizationData();
            } catch(e) {}
        }

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å select –∫–≤–∞—Ä—Ç–∞–ª–æ–≤: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 8 –∫–≤–∞—Ä—Ç–∞–ª–æ–≤.
         */
        function initRealizationQuarterSelect() {
            const sel = document.getElementById('real-quarter-select');
            if (!sel || sel.options.length > 0) return;

            const now = new Date();
            const currentQ = Math.floor(now.getMonth() / 3) + 1;
            const currentYear = now.getFullYear();

            const qMonths = {1: '–Ø–Ω–≤ ‚Äî –ú–∞—Ä', 2: '–ê–ø—Ä ‚Äî –ò—é–Ω', 3: '–ò—é–ª ‚Äî –°–µ–Ω', 4: '–û–∫—Ç ‚Äî –î–µ–∫'};

            // –ù–∞—á–∏–Ω–∞–µ–º —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–≥–æ –∫–≤–∞—Ä—Ç–∞–ª–∞ (—Ç–µ–∫—É—â–∏–π –µ—â—ë –Ω–µ –∑–∞–∫—Ä—ã—Ç)
            let y = currentYear;
            let q = currentQ - 1;
            if (q === 0) { q = 4; y--; }

            for (let i = 0; i < 8; i++) {
                const val = y + '-Q' + q;
                const label = q + ' –∫–≤–∞—Ä—Ç–∞–ª ' + y + ' (' + qMonths[q] + ')';
                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = label;
                sel.appendChild(opt);

                q--;
                if (q === 0) { q = 4; y--; }
            }
        }

        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø–µ—Ä–∏–æ–¥–∞ (–î–Ω–∏ / –ú–µ—Å—è—Ü / –ö–≤–∞—Ä—Ç–∞–ª) –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.
         */
        function toggleRealPeriodType(autoLoad) {
            const type = document.getElementById('real-period-type').value;
            const daysGroup = document.getElementById('real-days-group');
            const monthGroup = document.getElementById('real-month-group');
            const quarterGroup = document.getElementById('real-quarter-group');

            daysGroup.style.display = 'none';
            monthGroup.style.display = 'none';
            quarterGroup.style.display = 'none';

            if (type === 'days') {
                daysGroup.style.display = '';
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: —Å–µ–≥–æ–¥–Ω—è
                const dateFrom = document.getElementById('real-date-from');
                const dateTo = document.getElementById('real-date-to');
                if (!dateFrom.value) {
                    dateFrom.value = getTodayDate();
                    dateTo.value = getTodayDate();
                }
            } else if (type === 'quarter') {
                quarterGroup.style.display = '';
                initRealizationQuarterSelect();
            } else {
                monthGroup.style.display = '';
            }
            // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ç–∏–ø–∞ –ø–µ—Ä–∏–æ–¥–∞ (–µ—Å–ª–∏ –Ω–µ –≤—ã–∑–≤–∞–Ω–æ –∏–∑ restoreRealizationState)
            if (autoLoad !== false) loadRealizationData();
        }

        /**
         * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —á–∏—Å–ª–æ –∫–∞–∫ –¥–µ–Ω—å–≥–∏: 12 346 ‚ÇΩ (–±–µ–∑ –∫–æ–ø–µ–µ–∫)
         */
        function fmtRealMoney(val) {
            if (val == null || isNaN(val)) return '0 ‚ÇΩ';
            return Math.round(Math.abs(val)).toLocaleString('ru-RU') + ' ‚ÇΩ';
        }

        // –û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∫–æ–º–∏—Å—Å–∏–∏ + —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞ (–∏–∑ —Ä–∞–∑–Ω—ã—Ö API)
        let _realCommissionBase = 0;
        let _realGrossSales = 0;
        let _realAcquiring = 0;
        let _realBuyoutCommission = 0;  // –ö–æ–º–∏—Å—Å–∏—è –°–ù–ì (seller_price - amount)
        let _realBonuses = 0;  // –ë–∞–ª–ª—ã –∑–∞ —Å–∫–∏–¥–∫–∏ (–∏–∑ realization API)
        let _realBuyoutAmount = 0;  // –°—É–º–º–∞ –≤—ã–∫—É–ø–æ–≤ –°–ù–ì (–∏–∑ buyout API)
        let _realSalesAfterSpp = 0;  // –ü—Ä–æ–¥–∞–∂–∏ –ø–æ—Å–ª–µ –°–ü–ü (–¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –Ω–∞–ª–æ–≥–∞)
        let _realGrossSalesTotal = 0; // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (–ø—Ä–æ–¥–∞–∂–∏ –¥–æ –°–ü–ü)
        let _realReturns = 0;        // –í–æ–∑–≤—Ä–∞—Ç—ã
        let _realLogistics = 0;      // –õ–æ–≥–∏—Å—Ç–∏–∫–∞
        let _realOtherDeductions = 0; // –ò–Ω—ã–µ —É–¥–µ—Ä–∂–∞–Ω–∏—è
        let _realAdvertising = 0;    // –†–µ–∫–ª–∞–º–∞
        let _realStorage = 0;        // –•—Ä–∞–Ω–µ–Ω–∏–µ
        let _realCompensations = 0;  // –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ (–±–µ–∑ –±–∞–ª–ª–æ–≤)
        let _realCogs = 0;           // –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å
        let _realOpex = 0;           // –†–∞—Å—Ö–æ–¥—ã –∫ –≤—ã—á–µ—Ç—É
        let _realTotalTax = 0;       // –ù–∞–ª–æ–≥–∏ (–ù–î–° + –£–°–ù)
        let _realSalesCount = 0;     // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂ (—à—Ç)
        let _realLoading = false;  // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫
        let _realProductsData = [];  // –•—Ä–∞–Ω–µ–Ω–∏–µ products –¥–ª—è –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞
        let _realNdsPercent = 0;     // –°—Ç–∞–≤–∫–∞ –ù–î–° (–∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª—è –ù–î–°)
        let _realProductCogsMap = {};  // –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å per SKU {sku: cogs}
        let _realAdvBySku = {};      // –†–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ä–µ–∫–ª–∞–º—É –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º {offer_id: spend}
        let _realLogisticsBySku = {}; // –õ–æ–≥–∏—Å—Ç–∏–∫–∞ –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º {offer_id: cost}

        /** –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É ¬´–ö–æ–º–∏—Å—Å–∏—è –ú–ü¬ª = standard_fee + –∫–æ–º–∏—Å—Å–∏—è –°–ù–ì + —ç–∫–≤–∞–π—Ä–∏–Ω–≥ */
        function updateCommissionCard() {
            const total = _realCommissionBase + _realBuyoutCommission + _realAcquiring;
            const el = document.getElementById('real-commission');
            const hint = document.getElementById('real-commission-hint');
            const details = document.getElementById('real-commission-details');
            const badge = document.getElementById('real-commission-badge');
            if (el) el.textContent = fmtRealMoney(total);
            if (hint && _realGrossSales > 0) {
                hint.textContent = (total / _realGrossSales * 100).toFixed(1) + '% –æ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏';
            }
            // –†–∞—Å–∫—Ä—ã—Ç–∏–µ: –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ
            if (details) {
                let rows = [];
                if (_realCommissionBase !== 0) {
                    rows.push('<div class="real-detail-row"><span class="real-detail-label">–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ</span><span class="real-detail-value">' + fmtRealMoney(_realCommissionBase) + '</span></div>');
                }
                if (_realBuyoutCommission !== 0) {
                    rows.push('<div class="real-detail-row"><span class="real-detail-label">–ö–æ–º–∏—Å—Å–∏—è –°–ù–ì</span><span class="real-detail-value">' + fmtRealMoney(_realBuyoutCommission) + '</span></div>');
                }
                if (_realAcquiring !== 0) {
                    rows.push('<div class="real-detail-row"><span class="real-detail-label">–≠–∫–≤–∞–π—Ä–∏–Ω–≥</span><span class="real-detail-value">' + fmtRealMoney(_realAcquiring) + '</span></div>');
                }
                details.innerHTML = rows.join('');
                // –ë–µ–π–¥–∂: –∫–æ–ª-–≤–æ —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∏—Ö
                if (badge) {
                    const cnt = ((_realCommissionBase !== 0) ? 1 : 0) + ((_realBuyoutCommission !== 0) ? 1 : 0) + ((_realAcquiring !== 0) ? 1 : 0);
                    if (cnt > 0) {
                        badge.textContent = cnt;
                        badge.classList.add('visible');
                    } else {
                        badge.classList.remove('visible');
                    }
                }
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–∑ Ozon API –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü.
         * –ß–∏—Ç–∞–µ—Ç –º–µ—Å—è—Ü –∏–∑ select –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ /api/finance/realization?month=YYYY-MM.
         */
        async function loadRealizationData() {
            if (_realLoading) return;  // –ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É
            _realLoading = true;

            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
            _realCommissionBase = 0;
            _realGrossSales = 0;
            _realAcquiring = 0;
            _realBuyoutCommission = 0;
            _realBonuses = 0;
            _realSalesAfterSpp = 0;
            _realGrossSalesTotal = 0;
            _realReturns = 0;
            _realLogistics = 0;
            _realOtherDeductions = 0;
            _realAdvertising = 0;
            _realStorage = 0;
            _realCompensations = 0;
            _realCogs = 0;
            _realOpex = 0;
            _realTotalTax = 0;
            _realSalesCount = 0;
            _realProductsData = [];
            _realNdsPercent = 0;
            _realProductCogsMap = {};
            _realLogisticsBySku = {};

            const periodType = document.getElementById('real-period-type').value;
            let url;

            if (periodType === 'days') {
                const dateFrom = document.getElementById('real-date-from').value;
                const dateTo = document.getElementById('real-date-to').value;
                if (!dateFrom || !dateTo) { _realLoading = false; return; }
                url = '/api/finance/realization?date_from=' + encodeURIComponent(dateFrom) + '&date_to=' + encodeURIComponent(dateTo);
            } else if (periodType === 'quarter') {
                const qsel = document.getElementById('real-quarter-select');
                const quarter = qsel ? qsel.value : '';
                if (!quarter) { _realLoading = false; return; }
                url = '/api/finance/realization?quarter=' + encodeURIComponent(quarter);
            } else {
                const sel = document.getElementById('real-month-select');
                const month = sel ? sel.value : '';
                if (!month) { _realLoading = false; return; }
                url = '/api/finance/realization?month=' + encodeURIComponent(month);
            }

            // –°–∫—Ä—ã—Ç—å –≤—Å—ë, –ø–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
            ['real-empty', 'real-error', 'real-summary',
             'real-products-wrapper',
             'real-logistics-card', 'real-compensations-card', 'real-other-deductions-card',
             'real-advertising-card', 'real-storage-card',
             'real-cogs-card', 'real-opex-card', 'real-tax-card', 'real-profit-card'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            document.getElementById('real-loading').style.display = 'block';

            // –ó–∞–ø—É—Å–∫–∞–µ–º –û–ë–ê –∑–∞–ø—Ä–æ—Å–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (—Å–µ—Ç—å –≥—Ä—É–∑–∏—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)
            // –†–µ–Ω–¥–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (–Ω—É–∂–µ–Ω _realBonuses)
            const txPromise = _fetchTransactionsBreakdown();

            try {
                const resp = await authFetch(url);
                const data = await resp.json();

                document.getElementById('real-loading').style.display = 'none';

                if (!data.success) {
                    document.getElementById('real-error-text').textContent = data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    document.getElementById('real-error').style.display = 'block';
                    return;
                }

                const s = data.summary || {};

                // –°–≤–æ–¥–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ ‚Äî –≤—Å–µ —Å—É–º–º—ã –∑–∞ –≤—ã—á–µ—Ç–æ–º –≤–æ–∑–≤—Ä–∞—Ç–æ–≤
                const netSalesCount = (s.delivery_count || 0) - (s.return_count || 0);
                const netGrossSales = (s.gross_sales || 0) - (s.return_gross || 0);

                // –î–∞–Ω–Ω—ã–µ –ø–æ –≤—ã–∫—É–ø–∞–º –°–ù–ì
                const buyout = data.buyout || {count: 0, amount: 0, seller_price_total: 0};
                const totalSellerWithBuyout = (s.sales_after_spp || 0) + (buyout.seller_price_total || 0);
                _realSalesAfterSpp = totalSellerWithBuyout;
                const totalSalesCount = netSalesCount + (buyout.count || 0);
                _realSalesCount = totalSalesCount;

                document.getElementById('real-realization').textContent = fmtRealMoney(totalSellerWithBuyout);
                const realHint = document.getElementById('real-realization-hint');
                if (realHint) {
                    if (buyout.count > 0) {
                        realHint.innerHTML = totalSalesCount + ' –ø—Ä–æ–¥–∞–∂ <span style="color:#e67e22;font-size:11px;">(–≤ —Ç.—á. –°–ù–ì: ' + buyout.count + ' —à—Ç. / ' + fmtRealMoney(buyout.seller_price_total || 0) + ')</span>';
                    } else {
                        realHint.textContent = totalSalesCount + ' –ø—Ä–æ–¥–∞–∂';
                    }
                }

                // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è = –≥—Ä–æ—Å—Å –º–∏–Ω—É—Å –≥—Ä–æ—Å—Å-–≤–æ–∑–≤—Ä–∞—Ç—ã + –°–ù–ì (seller_price)
                const totalGrossSales = netGrossSales + (buyout.seller_price_total || 0);
                _realGrossSalesTotal = totalGrossSales;
                _realReturns = s.returns || 0;
                document.getElementById('real-gross-sales').textContent = fmtRealMoney(totalGrossSales);
                const grossHint = document.getElementById('real-gross-hint');
                if (grossHint) grossHint.textContent = '';

                document.getElementById('real-returns').textContent = fmtRealMoney(s.returns);
                const retHint = document.getElementById('real-returns-hint');
                if (retHint) retHint.textContent = s.return_count + ' –≤–æ–∑–≤—Ä–∞—Ç–æ–≤';

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–∞–∑–æ–≤—É—é –∫–æ–º–∏—Å—Å–∏—é –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É (—Å —É—á—ë—Ç–æ–º —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞ –∏ –°–ù–ì)
                _realCommissionBase = s.commission;
                _realGrossSales = totalGrossSales;
                _realBuyoutCommission = buyout.commission || 0;
                _realBonuses = Math.abs(s.bonuses || 0);
                _realBuyoutAmount = buyout.amount || 0;
                updateCommissionCard();

                document.getElementById('real-summary').style.display = 'grid';

                // –ñ–¥—ë–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (fetch —É–∂–µ –∏–¥—ë—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ) –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º
                // _realBonuses —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø–æ—ç—Ç–æ–º—É –∫–∞—Ä—Ç–æ—á–∫–∞ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–π –æ—Ç—Ä–∏—Å—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
                txPromise.then(txData => {
                    if (txData) renderTransactionsBreakdown(txData);
                }).catch(err => console.error('[TX] error:', err));

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∫–ª–∞–º—É –ø–æ SKU –∏–∑ API
                _realAdvBySku = data.adv_by_sku || {};

                // –¢–∞–±–ª–∏—Ü–∞ –ø–æ —Ç–æ–≤–∞—Ä–∞–º ‚Äî –º–µ—Ä–∂–∏–º –≤—ã–∫—É–ø—ã –°–ù–ì –≤ –ø—Ä–æ–¥–∞–∂–∏
                const mergedProducts = [...(data.products || [])];
                if (buyout.products && buyout.products.length > 0) {
                    buyout.products.forEach(bp => {
                        const existing = mergedProducts.find(p => (p.offer_id || p.sku) === (bp.offer_id || String(bp.sku)));
                        if (existing) {
                            // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª-–≤–æ –∏ –≤—ã—Ä—É—á–∫—É –°–ù–ì –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É —Ç–æ–≤–∞—Ä—É
                            const bpQty = bp.quantity || 0;
                            const bpGross = (bp.seller_price_per_instance || 0) * bpQty;
                            existing.delivery_qty = (existing.delivery_qty || 0) + bpQty;
                            existing.gross_sales = (existing.gross_sales || 0) + bpGross;
                        } else {
                            // –¢–æ–≤–∞—Ä –ø—Ä–æ–¥–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –°–ù–ì ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
                            mergedProducts.push({
                                offer_id: bp.offer_id,
                                sku: String(bp.sku),
                                seller_price: bp.seller_price_per_instance || 0,
                                commission_ratio: bp.deduction_by_category_percent || 0,
                                delivery_qty: bp.quantity || 0,
                                return_qty: 0,
                                gross_sales: (bp.seller_price_per_instance || 0) * (bp.quantity || 0),
                                return_gross: 0,
                                commission: ((bp.seller_price_per_instance || 0) - (bp.buyout_price || 0)) * (bp.quantity || 0),
                                seller_receives: bp.amount || 0
                            });
                        }
                    });
                }
                renderRealizationProducts(mergedProducts);

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (FIFO) –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã
                _loadRealizationCogs(mergedProducts, periodType);

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã (–î–î–°, is_official=1) –∑–∞ —Ç–æ—Ç –∂–µ –ø–µ—Ä–∏–æ–¥
                _loadRealizationOpex(periodType);

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –≤ localStorage –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
                try {
                    localStorage.setItem('real_period_type', periodType);
                    if (periodType === 'days') {
                        localStorage.setItem('real_date_from', document.getElementById('real-date-from').value);
                        localStorage.setItem('real_date_to', document.getElementById('real-date-to').value);
                    } else if (periodType === 'quarter') {
                        localStorage.setItem('real_quarter', document.getElementById('real-quarter-select').value);
                    } else {
                        localStorage.setItem('real_month', document.getElementById('real-month-select').value);
                    }
                } catch(e) {}

            } catch (e) {
                document.getElementById('real-loading').style.display = 'none';
                document.getElementById('real-error-text').textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message;
                document.getElementById('real-error').style.display = 'block';
            } finally {
                _realLoading = false;
            }
        }

        /**
         * –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ —Ç–æ–≤–∞—Ä–∞–º (SKU).
         * –ö–æ–ª–æ–Ω–∫–∏: –∞—Ä—Ç–∏–∫—É–ª, —Ü–µ–Ω–∞, –∫–æ–º–∏—Å—Å–∏—è %, –ø—Ä–æ–¥–∞–∂–∏ (–¥–æ—Å—Ç–∞–≤–∫–∏‚àí–≤–æ–∑–≤—Ä–∞—Ç—ã), –≤–æ–∑–≤—Ä–∞—Ç—ã, —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è, –∫–æ–º–∏—Å—Å–∏—è, –∫ –ø–æ–ª—É—á–µ–Ω–∏—é.
         */
        function renderRealizationProducts(products) {
            const tbody = document.getElementById('real-products-tbody');
            if (!tbody) return;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º products –¥–ª—è –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞ –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
            if (products && products.length > 0) _realProductsData = products;

            if (products.length === 0) {
                document.getElementById('real-products-wrapper').style.display = 'none';
                return;
            }

            // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º —ç–∫–≤–∞–π—Ä–∏–Ω–≥ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Ä–µ–∫–ª–∞–º—É ‚Äî –ø–æ SKU
            const totalGross = products.reduce((s, p) => s + Math.abs(p.gross_sales || 0), 0);
            const acq = Math.abs(_realAcquiring);
            // –û–±—â–µ–µ –∫–æ–ª-–≤–æ –Ω–µ—Ç—Ç–æ-–ø—Ä–æ–¥–∞–∂ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –∫ –≤—ã—á–µ—Ç—É
            const totalNetQty = products.reduce((s, p) => s + Math.max(0, (p.delivery_qty || 0) - (p.return_qty || 0)), 0);
            const totalSellerRcv = products.reduce((s, p) => s + Math.abs(p.seller_receives || 0), 0);

            // ‚îÄ‚îÄ –®–∞–≥ 1: —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å ¬´—Å—ã—Ä—ã–µ¬ª –Ω–∞–ª–æ–≥–∏ per product –ø–æ —Ñ–æ—Ä–º—É–ª–µ –ù–î–°+–£–°–ù ‚îÄ‚îÄ
            const rawTaxes = products.map(p => {
                const grossShare = (totalGross > 0) ? Math.abs(p.gross_sales || 0) / totalGross : 0;
                const rcvShare = (totalSellerRcv > 0) ? Math.abs(p.seller_receives || 0) / totalSellerRcv : 0;
                const pAcq = acq * grossShare;
                const pAdv = _realAdvBySku[p.offer_id] || _realAdvBySku[p.sku] || 0;
                const pLog = _realLogisticsBySku[p.offer_id] || _realLogisticsBySku[p.sku] || 0;
                const pCom = (p.commission || 0) + pAcq;
                const allComp = _realCompensations + _realBonuses;
                const pComp = allComp * grossShare;
                const pNdsBase = _realSalesAfterSpp * rcvShare + pComp;
                let pNds = (_realNdsPercent > 0) ? pNdsBase / (100 + _realNdsPercent) * _realNdsPercent : 0;
                const pCogs = _realProductCogsMap[p.sku] || 0;
                const pUsnBase = Math.abs(p.gross_sales || 0)
                    - pAdv - pLog - _realStorage * grossShare
                    - pCom - _realOtherDeductions * grossShare - pCogs - _realOpex * grossShare
                    - pNds + pComp - _realBonuses * grossShare;
                const pUsn = pUsnBase > 0 ? pUsnBase * 15 / 100 : 0;
                return pNds + pUsn;
            });
            // ‚îÄ‚îÄ –®–∞–≥ 2: –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º ‚Äî —Å–∫–∞–ª–∏—Ä—É–µ–º —á—Ç–æ–±—ã —Å—É–º–º–∞ = _realTotalTax (–∫–∞—Ä—Ç–æ—á–∫–∞) ‚îÄ‚îÄ
            const rawTaxSum = rawTaxes.reduce((s, t) => s + t, 0);
            const taxScale = (rawTaxSum > 0 && _realTotalTax > 0) ? Math.abs(_realTotalTax) / rawTaxSum : 1;

            // ‚îÄ‚îÄ –®–∞–≥ 3: per-SKU –ª–æ–≥–∏—Å—Ç–∏–∫–∞ + –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —á—Ç–æ–±—ã —Å—É–º–º–∞ = _realLogistics (–∫–∞—Ä—Ç–æ—á–∫–∞) ‚îÄ‚îÄ
            // –°—ã—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ SKU
            const rawLogistics = products.map(p => _realLogisticsBySku[p.offer_id] || _realLogisticsBySku[p.sku] || 0);
            const rawLogSum = rawLogistics.reduce((s, l) => s + l, 0);
            // –ï—Å–ª–∏ –µ—Å—Ç—å SKU –±–µ–∑ –º–∞–ø–ø–∏–Ω–≥–∞ ‚Äî –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —á—Ç–æ–±—ã –∏—Ç–æ–≥–æ = –∫–∞—Ä—Ç–æ—á–∫–µ
            const logScale = (rawLogSum > 0 && _realLogistics > 0) ? _realLogistics / rawLogSum : 1;

            // –ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä—ã –¥–ª—è –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ ‚Äî —Å—É–º–º–∏—Ä—É–µ–º —Ä–æ–≤–Ω–æ —Ç–æ —á—Ç–æ –ø–æ–∫–∞–∑–∞–Ω–æ –≤ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ
            let _s = {netGross:0, adv:0, tax:0, log:0, cogs:0, opex:0, otherDed:0, com:0, sales:0, ret:0, bonus:0, profit:0};

            tbody.innerHTML = products.map((p, i) => {
                const grossShare = (totalGross > 0) ? Math.abs(p.gross_sales || 0) / totalGross : 0;
                const pAcq = acq * grossShare;
                const pAdv = _realAdvBySku[p.offer_id] || _realAdvBySku[p.sku] || 0;
                // Per-SKU –ª–æ–≥–∏—Å—Ç–∏–∫–∞ –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫ –∏—Ç–æ–≥—É –∫–∞—Ä—Ç–æ—á–∫–∏
                const pLog = rawLogistics[i] * logScale;
                const pCom = (p.commission || 0) + pAcq;
                const pComPct = (p.gross_sales && p.gross_sales !== 0) ? (pCom / Math.abs(p.gross_sales) * 100) : 0;
                const pTax = rawTaxes[i] * taxScale;

                // –¶–µ–Ω–∞ –≤ –õ–ö = –Ω–µ—Ç—Ç–æ-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è / –Ω–µ—Ç—Ç–æ-–ø—Ä–æ–¥–∞–∂–∏ (–∫–∞–∫ –∫–∞—Ä—Ç–æ—á–∫–∞ ¬´–†–µ–∞–ª–∏–∑–∞—Ü–∏—è¬ª)
                // (gross_sales ‚àí return_gross) / (delivery_qty ‚àí return_qty)
                const pNetGross = Math.abs(p.gross_sales || 0) - Math.abs(p.return_gross || 0);
                const pNetQty = (p.delivery_qty || 0) - (p.return_qty || 0);
                const pPrice = pNetQty > 0 ? pNetGross / pNetQty : (p.seller_price || 0);

                const comCls = pCom >= 0 ? 'real-amount-positive' : 'real-amount-negative';
                // –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å per SKU (FIFO) ‚Äî –∏–∑ _realProductCogsMap
                const pCogs = _realProductCogsMap[p.sku] || 0;
                const cogsText = pCogs > 0 ? fmtRealMoney(pCogs) : '‚Äî';
                const cogsColor = pCogs > 0 ? '#e07020' : '#999';

                // –†–∞—Å—Ö–æ–¥—ã –∫ –≤—ã—á–µ—Ç—É ‚Äî _realOpex –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –Ω–µ—Ç—Ç–æ-–ø—Ä–æ–¥–∞–∂–∞–º
                const netQty = Math.max(0, (p.delivery_qty || 0) - (p.return_qty || 0));
                const qtyShare = totalNetQty > 0 ? netQty / totalNetQty : 0;
                const pOpex = _realOpex * qtyShare;
                const pOtherDed = _realOtherDeductions * qtyShare;

                // –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å per product
                const pStorage = _realStorage * grossShare;
                const pCompensations = _realCompensations * grossShare;
                const pProfit = Math.abs(p.gross_sales || 0) - pAdv - pTax - pLog - pCom - pCogs - pOtherDed - pStorage + pCompensations;
                const profCls = pProfit >= 0 ? 'color:#27ae60;' : 'color:#e53e3e;';

                // –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ–º —Å—É–º–º—ã –¥–ª—è –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
                _s.netGross += pNetGross;
                _s.adv += pAdv;
                _s.tax += pTax;
                _s.log += pLog;
                _s.cogs += pCogs;
                _s.opex += pOpex;
                _s.otherDed += pOtherDed;
                _s.com += pCom;
                _s.sales += netQty;
                _s.ret += (p.return_qty || 0);
                _s.bonus += (p.bonus || 0);
                _s.profit += pProfit;

                return '<tr data-sku="' + escapeHtml(p.sku || '') + '">' +
                    '<td style="white-space:nowrap; font-size:12px; color:#888;">' + escapeHtml(p.offer_id || p.sku) + '</td>' +
                    '<td class="real-amount-right">' + fmtRealMoney(pPrice) + '</td>' +
                    '<td class="real-amount-right">' + fmtRealMoney(pNetGross) + '</td>' +
                    '<td class="real-amount-right" style="color:#d69e2e;">' + (Math.abs(p.gross_sales) > 0 ? ((p.bonus || 0) / Math.abs(p.gross_sales) * 100).toFixed(10) : '0.0000000000') + '%</td>' +
                    '<td class="real-amount-right" style="color:#c0392b;">' + fmtRealMoney(pAdv) + '</td>' +
                    '<td class="real-amount-right" style="color:#8b5cf6;">' + fmtRealMoney(pTax) + '</td>' +
                    '<td class="real-amount-right" style="color:#c0392b;">' + fmtRealMoney(pLog) + '</td>' +
                    '<td class="real-amount-right" data-field="cogs" style="color:' + cogsColor + ';">' + cogsText + '</td>' +
                    '<td class="real-amount-right" style="color:#e67e22;">' + fmtRealMoney(pOpex) + '</td>' +
                    '<td class="real-amount-right" style="color:#e67e22;">' + fmtRealMoney(pOtherDed) + '</td>' +
                    '<td class="real-amount-right" style="color:#d69e2e;">' + Math.round(pComPct) + '%</td>' +
                    '<td class="real-amount-right" style="color:#38a169;">' + netQty + '</td>' +
                    '<td class="real-amount-right" style="color:#e53e3e;">' + (p.return_qty || 0) + '</td>' +
                    '<td class="real-amount-right ' + comCls + '">' + fmtRealMoney(pCom) + '</td>' +
                    '<td class="real-amount-right" style="color:#d69e2e;">' + fmtRealMoney(p.bonus || 0) + '</td>' +
                    '<td class="real-amount-right" style="' + profCls + 'font-weight:700;">' + fmtRealMoney(pProfit) + '</td>' +
                '</tr>';
            }).join('');

            // –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî —Å—É–º–º—ã —Ä–æ–≤–Ω–æ —Ç–µ—Ö –∑–Ω–∞—á–µ–Ω–∏–π —á—Ç–æ –ø–æ–∫–∞–∑–∞–Ω—ã –≤ —Å—Ç—Ä–æ–∫–∞—Ö —Ç–æ–≤–∞—Ä–æ–≤
            const summaryRow = document.getElementById('real-products-summary');
            if (summaryRow && products.length > 0) {
                const avgPrice = _s.sales > 0 ? _s.netGross / _s.sales : 0;
                const totalComPct = _s.netGross > 0 ? (_s.com / _s.netGross * 100) : 0;
                const cogsFootText = _s.cogs > 0 ? fmtRealMoney(_s.cogs) : '‚Äî';
                const sppPct = _s.netGross > 0 ? (_s.bonus / _s.netGross * 100).toFixed(10) : '0.0000000000';
                const profCls = _s.profit >= 0 ? 'color:#27ae60;' : 'color:#e53e3e;';
                summaryRow.innerHTML =
                    '<td style="font-size:12px;color:#555;">–ò—Ç–æ–≥–æ / –°—Ä–µ–¥–Ω–µ–µ</td>' +
                    '<td class="real-amount-right" style="color:#555;">' + fmtRealMoney(avgPrice) + '</td>' +
                    '<td class="real-amount-right" style="color:#555;">' + fmtRealMoney(_s.netGross) + '</td>' +
                    '<td class="real-amount-right" style="color:#d69e2e;">' + sppPct + '%</td>' +
                    '<td class="real-amount-right" style="color:#c0392b;">' + fmtRealMoney(_s.adv) + '</td>' +
                    '<td class="real-amount-right" style="color:#8b5cf6;">' + fmtRealMoney(_s.tax) + '</td>' +
                    '<td class="real-amount-right" style="color:#c0392b;">' + fmtRealMoney(_s.log) + '</td>' +
                    '<td class="real-amount-right" id="real-cogs-tfoot" style="color:#e07020;">' + cogsFootText + '</td>' +
                    '<td class="real-amount-right" style="color:#e67e22;">' + fmtRealMoney(_s.opex) + '</td>' +
                    '<td class="real-amount-right" style="color:#e67e22;">' + fmtRealMoney(_s.otherDed) + '</td>' +
                    '<td class="real-amount-right" style="color:#555;">' + Math.round(totalComPct) + '%</td>' +
                    '<td class="real-amount-right" style="color:#38a169;">' + _s.sales + '</td>' +
                    '<td class="real-amount-right" style="color:#e53e3e;">' + _s.ret + '</td>' +
                    '<td class="real-amount-right" style="color:#555;">' + fmtRealMoney(_s.com) + '</td>' +
                    '<td class="real-amount-right" style="color:#d69e2e;">' + fmtRealMoney(_s.bonus) + '</td>' +
                    '<td class="real-amount-right" style="' + profCls + 'font-weight:700;">' + fmtRealMoney(_s.profit) + '</td>';
                summaryRow.style.display = '';
            }

            document.getElementById('real-products-wrapper').style.display = 'block';
        }

        // ============================================================================
        // –°–ï–ë–ï–°–¢–û–ò–ú–û–°–¢–¨ (FIFO) ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        // ============================================================================

        /**
         * –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –∫—É–º—É–ª—è—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂.
         * –ù—É–∂–Ω–∞ –¥–ª—è FIFO ‚Äî —á—Ç–æ–±—ã –∑–Ω–∞—Ç—å, —Å–∫–æ–ª—å–∫–æ –µ–¥–∏–Ω–∏—Ü —É–∂–µ ¬´–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–æ¬ª –ø—Ä–æ—à–ª—ã–º–∏ –ø–µ—Ä–∏–æ–¥–∞–º–∏.
         */
        function _getRealPeriodStart(periodType) {
            if (periodType === 'days') {
                return document.getElementById('real-date-from').value; // "YYYY-MM-DD"
            } else if (periodType === 'quarter') {
                const qval = document.getElementById('real-quarter-select').value; // "YYYY-Q1"
                const m = qval.match(/^(\d{4})-Q([1-4])$/);
                if (m) {
                    const qMonths = {1: '01', 2: '04', 3: '07', 4: '10'};
                    return m[1] + '-' + qMonths[parseInt(m[2])] + '-01';
                }
                return '';
            } else {
                const mval = document.getElementById('real-month-select').value; // "YYYY-MM"
                return mval ? mval + '-01' : '';
            }
        }

        /** –°–∫–ª–æ–Ω–µ–Ω–∏–µ —Ä—É—Å—Å–∫–∏—Ö —á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö: _pluralize(5, '–∑–∞–ø–∏—Å—å', '–∑–∞–ø–∏—Å–∏', '–∑–∞–ø–∏—Å–µ–π') ‚Üí '–∑–∞–ø–∏—Å–µ–π' */
        function _pluralize(n, one, few, many) {
            const abs = Math.abs(n) % 100;
            const lastDigit = abs % 10;
            if (abs > 10 && abs < 20) return many;
            if (lastDigit > 1 && lastDigit < 5) return few;
            if (lastDigit === 1) return one;
            return many;
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –∏–∑ –î–î–° (is_official=1) –∑–∞ –ø–µ—Ä–∏–æ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.
         * –í—ã—á–∏—Å–ª—è–µ—Ç date_from / date_to –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç /api/finance/records.
         */
        async function _loadRealizationOpex(periodType) {
            try {
                let dateFrom = '', dateTo = '';
                if (periodType === 'days') {
                    dateFrom = document.getElementById('real-date-from').value;
                    dateTo = document.getElementById('real-date-to').value;
                } else if (periodType === 'quarter') {
                    const qval = document.getElementById('real-quarter-select').value; // "YYYY-Q1"
                    const m = qval.match(/^(\d{4})-Q([1-4])$/);
                    if (m) {
                        const year = parseInt(m[1]);
                        const q = parseInt(m[2]);
                        const startMonth = (q - 1) * 3 + 1;
                        const endMonth = startMonth + 2;
                        dateFrom = year + '-' + String(startMonth).padStart(2, '0') + '-01';
                        // –ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –º–µ—Å—è—Ü–∞ –∫–≤–∞—Ä—Ç–∞–ª–∞
                        const lastDay = new Date(year, endMonth, 0).getDate();
                        dateTo = year + '-' + String(endMonth).padStart(2, '0') + '-' + String(lastDay).padStart(2, '0');
                    }
                } else {
                    // month: "YYYY-MM"
                    const mval = document.getElementById('real-month-select').value;
                    if (mval) {
                        dateFrom = mval + '-01';
                        const parts = mval.split('-');
                        const lastDay = new Date(parseInt(parts[0]), parseInt(parts[1]), 0).getDate();
                        dateTo = mval + '-' + String(lastDay).padStart(2, '0');
                    }
                }

                if (!dateFrom || !dateTo) return;

                const params = new URLSearchParams({
                    type: 'expense',
                    is_official: '1',
                    date_from: dateFrom,
                    date_to: dateTo
                });
                const resp = await authFetch('/api/finance/records?' + params.toString());
                const data = await resp.json();

                const card = document.getElementById('real-opex-card');
                if (!data.success || !card) return;

                const total = data.summary ? data.summary.total_expense : 0;
                _realOpex = total;
                document.getElementById('real-opex-total').textContent = fmtRealMoney(-total);

                const records = data.records || [];
                const count = records.length;

                // –•–∏–Ω—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–∞–ø–∏—Å–µ–π
                const hint = document.getElementById('real-opex-hint');
                if (hint) {
                    hint.textContent = count > 0
                        ? (count + ' ' + _pluralize(count, '–∑–∞–ø–∏—Å—å', '–∑–∞–ø–∏—Å–∏', '–∑–∞–ø–∏—Å–µ–π') + ' –≤ –î–î–°')
                        : '–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –≤ –î–î–°';
                }

                // –ë–µ–π–¥–∂ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                const catMap = {};
                records.forEach(r => {
                    const cat = r.category_name || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
                    if (!catMap[cat]) catMap[cat] = 0;
                    catMap[cat] += parseFloat(r.amount) || 0;
                });
                const categories = Object.entries(catMap).sort((a, b) => b[1] - a[1]);

                const badge = document.getElementById('real-opex-badge');
                if (badge && categories.length > 0) {
                    badge.textContent = categories.length;
                    badge.classList.add('visible');
                }

                // –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                let detailsHtml = '';
                categories.forEach(([cat, sum]) => {
                    detailsHtml += '<div class="real-detail-row">' +
                        '<span class="real-detail-label">' + escapeHtml(cat) + '</span>' +
                        '<span class="real-detail-value">' + fmtRealMoney(-sum) + '</span>' +
                        '</div>';
                });
                document.getElementById('real-opex-details').innerHTML = detailsHtml;

                card.style.display = '';
            } catch (e) {
                console.error('[OPEX] fetch error:', e);
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É ¬´–ù–∞–ª–æ–≥–∏¬ª = –ù–î–° + –£–°–ù.
         * –ù–î–° = (–ü—Ä–æ–¥–∞–∂–∏ –ø–æ—Å–ª–µ –°–ü–ü + –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ ‚àí –ë–∞–ª–ª—ã) / (100 + –ù–î–°%) √ó –ù–î–°%
         * –£–°–ù = –†–µ–∞–ª–∏–∑–∞—Ü–∏—è ‚àí –ù–î–° ‚àí –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å ‚àí –í–æ–∑–≤—Ä–∞—Ç—ã ‚àí –õ–æ–≥–∏—Å—Ç–∏–∫–∞ ‚àí –ö–æ–º–∏—Å—Å–∏—è
         *        ‚àí –ò–Ω—ã–µ —É–¥–µ—Ä–∂–∞–Ω–∏—è ‚àí –•—Ä–∞–Ω–µ–Ω–∏–µ ‚àí –†–µ–∫–ª–∞–º–∞ ‚àí –†–∞—Å—Ö–æ–¥—ã –∫ –≤—ã—á–µ—Ç—É
         * –°—Ç–∞–≤–∫–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∏–∑ —Å—Ç—Ä–æ–∫ ¬´–ö–æ–Ω—Ç—Ä–æ–ª—å –ù–î–°¬ª –ø–æ –≥–æ–¥–æ–≤–æ–º—É –æ–±–æ—Ä–æ—Ç—É.
         */
        async function _loadRealizationTax() {
            try {
                // 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω–µ—Ü –∫–≤–∞—Ä—Ç–∞–ª–∞ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –±–µ–∑ –∑–∞–ø—Ä–æ—Å–æ–≤)
                const today = new Date();
                const todayStr = today.getFullYear() + '-' +
                    String(today.getMonth() + 1).padStart(2, '0') + '-' +
                    String(today.getDate()).padStart(2, '0');

                let periodEndDate = todayStr;
                const periodType = document.getElementById('real-period-type').value;
                if (periodType === 'days') {
                    periodEndDate = document.getElementById('real-date-to').value || todayStr;
                } else if (periodType === 'quarter') {
                    const qval = document.getElementById('real-quarter-select').value || '';
                    const qm = qval.match(/^(\\d{4})-Q([1-4])$/);
                    if (qm) {
                        const qYear = parseInt(qm[1]), q = parseInt(qm[2]);
                        const endMonth = q * 3;
                        const lastDay = new Date(qYear, endMonth, 0).getDate();
                        periodEndDate = qYear + '-' + String(endMonth).padStart(2, '0') + '-' + String(lastDay).padStart(2, '0');
                    }
                } else {
                    const mval = document.getElementById('real-month-select').value || '';
                    if (mval) {
                        const parts = mval.split('-');
                        const mYear = parseInt(parts[0]), mon = parseInt(parts[1]);
                        const lastDay = new Date(mYear, mon, 0).getDate();
                        periodEndDate = mYear + '-' + String(mon).padStart(2, '0') + '-' + String(lastDay).padStart(2, '0');
                    }
                }

                const peDate = new Date(periodEndDate + 'T00:00:00');
                const peYear = peDate.getFullYear();
                const peQuarter = Math.ceil((peDate.getMonth() + 1) / 3);
                const qEndMonth = peQuarter * 3;
                const qEndDay = new Date(peYear, qEndMonth, 0).getDate();
                const quarterEndDate = peYear + '-' + String(qEndMonth).padStart(2, '0') + '-' + String(qEndDay).padStart(2, '0');
                const turnoverDateTo = quarterEndDate <= todayStr ? quarterEndDate : todayStr;
                const turnoverDateFrom = peYear + '-01-01';

                // 2. –ó–∞–ø—É—Å–∫–∞–µ–º –í–°–ï 3 –∑–∞–ø—Ä–æ—Å–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ + –î–î–° + –æ–±–æ—Ä–æ—Ç –∏–∑ –∫—ç—à–∞)
                const [settResp, ddsResp, turnoverResp] = await Promise.all([
                    authFetch('/api/settings?key=nds_rows'),
                    authFetch('/api/finance/records?' + new URLSearchParams({
                        type: 'income', is_official: '1', date_from: turnoverDateFrom, date_to: turnoverDateTo
                    })),
                    authFetch('/api/finance/realization/turnover?' + new URLSearchParams({
                        date_from: turnoverDateFrom, date_to: turnoverDateTo
                    }))
                ]);
                const [settData, ddsData, turnoverData] = await Promise.all([
                    settResp.json(), ddsResp.json(), turnoverResp.json()
                ]);

                // 3. –ü–∞—Ä—Å–∏–º –ù–î–°-—Å—Ç–∞–≤–∫–∏
                let row1Pct = 0, row1Amt = 0, row2Pct = 0;
                if (settData.success && settData.value) {
                    const rows = JSON.parse(settData.value);
                    if (rows[1]) {
                        row1Pct = parseFloat((rows[1].percent || '0').replace(/\s/g, '')) || 0;
                        row1Amt = parseFloat((rows[1].amount || '0').replace(/\s/g, '')) || 0;
                    }
                    if (rows[2]) {
                        row2Pct = parseFloat((rows[2].percent || '0').replace(/\s/g, '')) || 0;
                    }
                }

                // 4. –°—á–∏—Ç–∞–µ–º –æ–±–æ—Ä–æ—Ç (–î–î–° + —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ –∫—ç—à–∞)
                const ddsIncome = ddsData.success && ddsData.summary ? ddsData.summary.total_income : 0;
                const realSales = turnoverData.success ? (turnoverData.sales_after_spp || 0) : 0;
                const yearlyTurnover = ddsIncome + realSales;

                // 5. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞–≤–∫—É –ù–î–° –ø–æ –æ–±–æ—Ä–æ—Ç—É –Ω–∞ –∫–æ–Ω–µ—Ü –∫–≤–∞—Ä—Ç–∞–ª–∞ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
                //    –ï—Å–ª–∏ –æ–±–æ—Ä–æ—Ç < –ø–æ—Ä–æ–≥–∞ 1-–π —Å—Ç—Ä–æ–∫–∏ ‚Üí —Å—Ç–∞–≤–∫–∞ 1-–π —Å—Ç—Ä–æ–∫–∏, –∏–Ω–∞—á–µ ‚Üí 2-–π —Å—Ç—Ä–æ–∫–∏
                //    –ü—Ä–æ—à–ª—ã–µ –∫–≤–∞—Ä—Ç–∞–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç —Å–≤–æ—é —Å—Ç–∞–≤–∫—É (–æ–±–æ—Ä–æ—Ç —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –∫–æ–Ω–µ—Ü –∫–≤–∞—Ä—Ç–∞–ª–∞)
                const ndsPercent = yearlyTurnover < row1Amt ? row1Pct : row2Pct;
                _realNdsPercent = ndsPercent;

                // 4. –ù–î–° = (–ü—Ä–æ–¥–∞–∂–∏ –ø–æ—Å–ª–µ –°–ü–ü + –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ –±–µ–∑ –±–∞–ª–ª–æ–≤) / (100 + –ù–î–°%) √ó –ù–î–°%
                const ndsBase = _realSalesAfterSpp + _realCompensations;
                let nds = 0;
                if (ndsPercent > 0) {
                    nds = ndsBase / (100 + ndsPercent) * ndsPercent;
                }

                // 5. –£–°–ù = –ü—Ä–æ–¥–∞–∂–∏ –¥–æ –°–ü–ü ‚àí –†–µ–∫–ª–∞–º–∞ ‚àí –õ–æ–≥–∏—Å—Ç–∏–∫–∞ ‚àí –•—Ä–∞–Ω–µ–Ω–∏–µ ‚àí –ö–æ–º–∏—Å—Å–∏—è
                //          ‚àí –ò–Ω—ã–µ —É–¥–µ—Ä–∂–∞–Ω–∏—è ‚àí –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å ‚àí –†–∞—Å—Ö–æ–¥—ã –∫ –≤—ã—á–µ—Ç—É ‚àí –ù–î–°
                //          + –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ ‚àí –ë–∞–ª–ª—ã –∑–∞ –æ—Ç–∑—ã–≤—ã
                const commission = Math.abs(_realCommissionBase) + Math.abs(_realAcquiring) + Math.abs(_realBuyoutCommission);
                const allCompensations = _realCompensations + _realBonuses; // –≤—Å–µ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ (–≤–∫–ª—é—á–∞—è –±–∞–ª–ª—ã)
                const usn = _realGrossSalesTotal
                    - _realAdvertising
                    - _realLogistics
                    - _realStorage
                    - commission
                    - _realOtherDeductions
                    - _realCogs
                    - _realOpex
                    - nds
                    + allCompensations
                    - _realBonuses;

                // 6. –ò—Ç–æ–≥–æ = –ù–î–° + –£–°–ù (–µ—Å–ª–∏ –£–°–ù > 0). –£–°–ù –≤—Å–µ–≥–¥–∞ 15%
                const usnPercent = 15;
                const usnTax = usn > 0 ? usn * usnPercent / 100 : 0;
                const totalTax = nds + usnTax;
                _realTotalTax = totalTax;

                // 7. –û—Ç–æ–±—Ä–∞–∂–∞–µ–º
                const card = document.getElementById('real-tax-card');
                if (!card) return;
                document.getElementById('real-tax-total').textContent = fmtRealMoney(totalTax);

                // Hint ‚Äî –æ–±–æ—Ä–æ—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥ –∏ —Å—Ç–∞–≤–∫–∞ –ù–î–°
                const hint = document.getElementById('real-tax-hint');
                if (hint) {
                    hint.innerHTML = '<span style="color:#999;font-size:11px;">–û–±–æ—Ä–æ—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥ (01.01 ‚Äì ' +
                        turnoverDateTo.split('-').reverse().join('.') + '): ' +
                        fmtRealMoney(yearlyTurnover) + ' ¬∑ –ù–î–° ' + ndsPercent + '%</span>';
                }

                // Badge ‚Äî 2 —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∏—Ö
                const badge = document.getElementById('real-tax-badge');
                if (badge) { badge.textContent = '2'; badge.classList.add('visible'); }

                // Details ‚Äî —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–∏–π—Å—è —Å–ø–∏—Å–æ–∫ –ù–î–° –∏ –£–°–ù
                const details = document.getElementById('real-tax-details');
                if (details) {
                    details.innerHTML =
                        '<div class="real-detail-row"><span class="real-detail-label">–ù–î–° ' + ndsPercent + '%</span>' +
                        '<span class="real-detail-value">' + fmtRealMoney(nds) + '</span></div>' +
                        '<div class="real-detail-row"><span class="real-detail-label">–£–°–ù ' + usnPercent + '%' +
                        (usn <= 0 ? ' <span style="color:#e74c3c;font-size:10px;">(–±–∞–∑–∞ ‚â§ 0)</span>' : '') +
                        '</span><span class="real-detail-value">' + fmtRealMoney(usnTax) + '</span></div>';
                }

                // ? ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ä–º—É–ª (–±–µ–∑ —Ü–∏—Ñ—Ä)
                const qBtn = document.getElementById('real-tax-question');
                if (qBtn) {
                    qBtn.onclick = function(e) {
                        e.stopPropagation();
                        alert(
                            '–ù–∞–ª–æ–≥–∏ = –ù–î–° + –£–°–ù\\n\\n' +
                            '‚îÄ‚îÄ –ù–î–° ‚îÄ‚îÄ\\n' +
                            '(–ü—Ä–æ–¥–∞–∂–∏ –ø–æ—Å–ª–µ –°–ü–ü + –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏) / (100 + –ù–î–°%) √ó –ù–î–°%\\n' +
                            '–°—Ç–∞–≤–∫–∞ –ù–î–° –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∏–∑ –≤–∫–ª–∞–¥–∫–∏ ¬´–ö–æ–Ω—Ç—Ä–æ–ª—å –ù–î–°¬ª –ø–æ –æ–±—â–µ–º—É –æ–±–æ—Ä–æ—Ç—É –∑–∞ –≥–æ–¥.\\n\\n' +
                            '‚îÄ‚îÄ –£–°–ù 15% ‚îÄ‚îÄ\\n' +
                            '(–ü—Ä–æ–¥–∞–∂–∏ –¥–æ –°–ü–ü ‚àí –†–µ–∫–ª–∞–º–∞ ‚àí –õ–æ–≥–∏—Å—Ç–∏–∫–∞ ‚àí –•—Ä–∞–Ω–µ–Ω–∏–µ ‚àí –ö–æ–º–∏—Å—Å–∏—è ‚àí –ò–Ω—ã–µ —É–¥–µ—Ä–∂–∞–Ω–∏—è ‚àí –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å ‚àí –†–∞—Å—Ö–æ–¥—ã –∫ –≤—ã—á–µ—Ç—É ‚àí –ù–î–° + –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ ‚àí –ë–∞–ª–ª—ã –∑–∞ –æ—Ç–∑—ã–≤—ã) √ó 15%\\n' +
                            '–°—Ç–∞–≤–∫–∞ –£–°–ù —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è ‚Äî 15%.\\n\\n' +
                            '‚îÄ‚îÄ –û–±–æ—Ä–æ—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥ ‚îÄ‚îÄ\\n' +
                            '–°—á–∏—Ç–∞–µ—Ç—Å—è —Å 1 —è–Ω–≤–∞—Ä—è –ø–æ –∫–æ–Ω–µ—Ü –∫–≤–∞—Ä—Ç–∞–ª–∞ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ (–∏–ª–∏ –ø–æ —Å–µ–≥–æ–¥–Ω—è, –µ—Å–ª–∏ –∫–≤–∞—Ä—Ç–∞–ª –µ—â—ë –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω).\\n' +
                            '–ï—Å–ª–∏ –æ–±–æ—Ä–æ—Ç –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø–æ—Ä–æ–≥ 1-–π —Å—Ç—Ä–æ–∫–∏ ¬´–ö–æ–Ω—Ç—Ä–æ–ª—å –ù–î–°¬ª, —Å—Ç–∞–≤–∫–∞ –ù–î–° –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ 2-—é —Å—Ç—Ä–æ–∫—É –Ω–∞—á–∏–Ω–∞—è —Å –∫–≤–∞—Ä—Ç–∞–ª–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è.\\n' +
                            '–ü—Ä–æ—à–ª—ã–µ –∫–≤–∞—Ä—Ç–∞–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç —Å–≤–æ—é —Å—Ç–∞–≤–∫—É ‚Äî –ø–µ—Ä–µ—Å—á—ë—Ç –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç.'
                        );
                    };
                }

                card.style.display = '';

                // 8. –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É ¬´–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å¬ª
                _updateProfitCard();

                // 9. –ü–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É —Ç–æ–≤–∞—Ä–æ–≤ ‚Äî —Ç–µ–ø–µ—Ä—å —Å —É—á—ë—Ç–æ–º –Ω–∞–ª–æ–≥–æ–≤ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
                if (_realProductsData.length > 0) {
                    renderRealizationProducts(_realProductsData);
                }
            } catch (e) {
                console.error('[TAX] fetch error:', e);
            }
        }

        /**
         * –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É ¬´–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å¬ª (–±–µ–∑ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤).
         * –§–æ—Ä–º—É–ª–∞: –ü—Ä–æ–¥–∞–∂–∏ –¥–æ –°–ü–ü ‚àí –†–µ–∫–ª–∞–º–∞ ‚àí –ù–∞–ª–æ–≥–∏ ‚àí –õ–æ–≥–∏—Å—Ç–∏–∫–∞ ‚àí –ö–æ–º–∏—Å—Å–∏—è
         *          ‚àí –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å ‚àí –ò–Ω—ã–µ —É–¥–µ—Ä–∂–∞–Ω–∏—è ‚àí –•—Ä–∞–Ω–µ–Ω–∏–µ + –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ ‚àí –ë–∞–ª–ª—ã
         */
        function _updateProfitCard() {
            const commission = Math.abs(_realCommissionBase) + Math.abs(_realAcquiring) + Math.abs(_realBuyoutCommission);
            const allCompensations = _realCompensations + _realBonuses;
            const profit = _realGrossSalesTotal
                - _realAdvertising
                - _realTotalTax
                - _realLogistics
                - commission
                - _realCogs
                - _realOtherDeductions
                - _realStorage
                + allCompensations
                - _realBonuses;

            const card = document.getElementById('real-profit-card');
            if (!card) return;

            // –ü—Ä–∏–±—ã–ª—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É –ø—Ä–æ–¥–∞–∂
            const perUnit = _realSalesCount > 0 ? profit / _realSalesCount : 0;
            document.getElementById('real-profit-total').innerHTML =
                fmtRealMoney(profit) + ' <span style="color:#888;font-size:16px;font-weight:400;">/ ' + fmtRealMoney(perUnit) + '</span>';

            const hint = document.getElementById('real-profit-hint');
            if (hint) {
                hint.innerHTML = '<span style="color:#999;font-size:11px;">–±–µ–∑ —É—á—ë—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ ¬∑ ' +
                    _realSalesCount + ' ' + _pluralize(_realSalesCount, '–ø—Ä–æ–¥–∞–∂–∞', '–ø—Ä–æ–¥–∞–∂–∏', '–ø—Ä–æ–¥–∞–∂') + '</span>';
            }
            card.style.display = '';
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (FIFO) –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.
         * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã —Ç–æ–≤–∞—Ä–æ–≤ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ –∏ –∫–∞—Ä—Ç–æ—á–∫–∏.
         *
         * –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
         *   products (array): –ú–∞—Å—Å–∏–≤ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ [{sku, delivery_qty, return_qty, seller_receives}, ...]
         *   periodType (string): –¢–∏–ø –ø–µ—Ä–∏–æ–¥–∞ ('days', 'month', 'quarter')
         */
        async function _loadRealizationCogs(products, periodType) {
            if (!products || products.length === 0) return;

            const periodStart = _getRealPeriodStart(periodType);

            // –§–æ—Ä–º–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ {sku, net_qty} –¥–ª—è backend
            const cogsProducts = products
                .filter(p => p.sku)
                .map(p => ({
                    sku: String(p.sku),
                    net_qty: (p.delivery_qty || 0) - (p.return_qty || 0)
                }))
                .filter(p => p.net_qty > 0);

            if (cogsProducts.length === 0) return;

            try {
                const resp = await authFetch('/api/finance/realization/cogs', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({products: cogsProducts, period_start: periodStart})
                });
                const data = await resp.json();

                if (!data.success) {
                    console.error('[COGS] error:', data.error);
                    return;
                }

                const cogsMap = data.products || {};
                let totalCogs = data.total_cogs || 0;
                _realCogs = totalCogs;

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º COGS per SKU –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –Ω–∞–ª–æ–≥–æ–≤ per product
                _realProductCogsMap = {};
                for (const sku in cogsMap) {
                    if (cogsMap[sku] && cogsMap[sku].cogs > 0) {
                        _realProductCogsMap[sku] = cogsMap[sku].cogs;
                    }
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ —Ç–æ–≤–∞—Ä–æ–≤
                const tbody = document.getElementById('real-products-tbody');
                if (tbody) {
                    const rows = tbody.querySelectorAll('tr[data-sku]');
                    rows.forEach(row => {
                        const sku = row.getAttribute('data-sku');
                        const cogsData = cogsMap[sku];
                        const cogsTd = row.querySelector('td[data-field="cogs"]');

                        if (cogsData && cogsData.cogs > 0) {
                            // –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å
                            if (cogsTd) {
                                cogsTd.textContent = fmtRealMoney(cogsData.cogs);
                                cogsTd.style.color = '#e07020';
                                // –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å –¥–µ—Ç–∞–ª—è–º–∏ FIFO –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
                                if (cogsData.details && cogsData.details.length > 0) {
                                    let tip = 'FIFO-—Ä–∞—Å—á—ë—Ç:\\n';
                                    cogsData.details.forEach(d => {
                                        tip += d.qty + ' —à—Ç √ó ' + d.cost.toFixed(2) + ' ‚ÇΩ';
                                        if (d.date) tip += ' (–ø—Ä–∏—Ö–æ–¥ ' + d.date + ')';
                                        tip += ' = ' + d.subtotal.toFixed(2) + ' ‚ÇΩ\\n';
                                    });
                                    if (cogsData.uncovered_qty > 0) {
                                        tip += '‚ö† ' + cogsData.uncovered_qty + ' —à—Ç –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö –æ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏';
                                    }
                                    cogsTd.title = tip;
                                }
                            }

                        } else {
                            if (cogsTd) { cogsTd.textContent = '‚Äî'; cogsTd.style.color = '#999'; }
                        }
                    });
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–≤–æ–¥–∫–∏
                const cogsCard = document.getElementById('real-cogs-card');

                // –°—á–∏—Ç–∞–µ–º —Ç–æ–≤–∞—Ä—ã –±–µ–∑ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ (uncovered)
                let uncoveredCount = 0;
                let totalProductsWithSales = cogsProducts.length;
                for (const sku in cogsMap) {
                    if (cogsMap[sku].uncovered_qty > 0) uncoveredCount++;
                }
                // –¢–æ–≤–∞—Ä—ã –±–µ–∑ –∑–∞–ø–∏—Å–∏ –≤ cogsMap ‚Äî —Ç–æ–∂–µ –±–µ–∑ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏
                cogsProducts.forEach(p => {
                    if (!cogsMap[p.sku]) uncoveredCount++;
                });

                // –ö–∞—Ä—Ç–æ—á–∫–∞ ¬´–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å¬ª ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ–≥–¥–∞
                document.getElementById('real-cogs-total').textContent = fmtRealMoney(totalCogs);
                // –ò—Ç–æ–≥ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤ tfoot —Ç–∞–±–ª–∏—Ü—ã
                const cogsTfoot = document.getElementById('real-cogs-tfoot');
                if (cogsTfoot) cogsTfoot.textContent = fmtRealMoney(totalCogs);
                const cogsHint = document.getElementById('real-cogs-hint');
                if (cogsHint) {
                    if (uncoveredCount > 0) {
                        cogsHint.innerHTML = '<span style="color:#e74c3c;font-weight:600;">' + uncoveredCount + ' –∏–∑ ' + totalProductsWithSales + ' —Ç–æ–≤–∞—Ä–æ–≤ –±–µ–∑ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏</span>';
                    } else if (totalCogs > 0) {
                        cogsHint.innerHTML = '<span style="color:#27ae60;">–í—Å–µ —Ç–æ–≤–∞—Ä—ã –ø–æ–∫—Ä—ã—Ç—ã</span>';
                    } else {
                        cogsHint.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–∏—Ö–æ–¥–∞—Ö';
                    }
                }
                if (cogsCard) cogsCard.style.display = '';

                // –ü–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É ‚Äî –Ω–∞–ª–æ–≥–∏ per product –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏
                if (_realProductsData.length > 0) {
                    renderRealizationProducts(_realProductsData);
                }

            } catch (e) {
                console.error('[COGS] fetch error:', e);
            }
        }

        // ============================================================================
        // –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø –£–î–ï–†–ñ–ê–ù–ò–ô ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ /v3/finance/transaction/list
        // ============================================================================

        /**
         * –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ —É–¥–µ—Ä–∂–∞–Ω–∏–π ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ (–∫–∞–∫ –≤ Ozon).
         */
        function toggleCardDetails(cardEl) {
            const details = cardEl.querySelector('.real-card-details');
            if (details) details.classList.toggle('open');
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é —É–¥–µ—Ä–∂–∞–Ω–∏–π –∏–∑ Transaction API –∏ –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å.
         * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.
         */
        /**
         * –¢–æ–ª—å–∫–æ fetch —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–±–µ–∑ —Ä–µ–Ω–¥–µ—Ä–∞) ‚Äî –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏.
         * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ null –ø—Ä–∏ –æ—à–∏–±–∫–µ.
         */
        async function _fetchTransactionsBreakdown() {
            const periodType = document.getElementById('real-period-type').value;
            let url;

            if (periodType === 'days') {
                const dateFrom = document.getElementById('real-date-from').value;
                const dateTo = document.getElementById('real-date-to').value;
                url = '/api/finance/transactions-breakdown?date_from=' + encodeURIComponent(dateFrom) + '&date_to=' + encodeURIComponent(dateTo);
            } else if (periodType === 'quarter') {
                const qsel = document.getElementById('real-quarter-select');
                url = '/api/finance/transactions-breakdown?quarter=' + encodeURIComponent(qsel.value);
            } else {
                const sel = document.getElementById('real-month-select');
                url = '/api/finance/transactions-breakdown?month=' + encodeURIComponent(sel.value);
            }

            try {
                const resp = await authFetch(url);
                const data = await resp.json();

                if (!data.success) {
                    console.error('Transactions breakdown error:', data.error);
                    return null;
                }

                console.log('[TX] Data received:', data.success, 'ops:', (data.operations||[]).length, 'svcs:', (data.services||[]).length);
                return data;
            } catch (e) {
                console.error('[TX] Transactions breakdown fetch error:', e);
                return null;
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–¥–ª—è –≤—ã–∑–æ–≤–∞ –∫–æ–≥–¥–∞ _realBonuses —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω).
         */
        async function loadTransactionsBreakdown() {
            const data = await _fetchTransactionsBreakdown();
            if (data) {
                renderTransactionsBreakdown(data);
                console.log('[TX] Render complete');
            }
        }

        /**
         * –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é —É–¥–µ—Ä–∂–∞–Ω–∏–π: –æ–ø–µ—Ä–∞—Ü–∏–∏, —É—Å–ª—É–≥–∏, –æ–ø–æ–≤–µ—â–µ–Ω–∏—è.
         */
        function renderTransactionsBreakdown(data) {
            console.log('[TX] renderTransactionsBreakdown called');
            // ‚îÄ‚îÄ –ö–∞—Ä—Ç–æ—á–∫–∞ ¬´–õ–æ–≥–∏—Å—Ç–∏–∫–∞¬ª ‚îÄ‚îÄ
            // –ò—Å—Ç–æ—á–Ω–∏–∫–∏:
            //   service  MarketplaceServiceItemDirectFlowLogistic          ‚Üí –õ–æ–≥–∏—Å—Ç–∏–∫–∞ (-2.9M)
            //   operation OperationItemReturn                              ‚Üí –î–æ—Å—Ç–∞–≤–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ (-309k)
            //   service  MarketplaceServiceItemRedistributionLastMileCourier ‚Üí –ü–æ—Å–ª–µ–¥–Ω—è—è –º–∏–ª—è (-26k)
            let logTotal = 0;
            const logDetails = [];

            // 1) –õ–æ–≥–∏—Å—Ç–∏–∫–∞ ‚Äî –∏–∑ services
            (data.services || []).forEach(svc => {
                if (svc.name === '_delivery_logistics') {
                    // –õ–æ–≥–∏—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ ‚Äî —Ç–æ–ª—å–∫–æ –∏–∑ –¥–æ—Å—Ç–∞–≤–æ–∫ (–±–µ–∑ –≤–æ–∑–≤—Ä–∞—Ç–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)
                    const val = Math.abs(svc.sum);
                    logTotal += val;
                    logDetails.push({label: '–õ–æ–≥–∏—Å—Ç–∏–∫–∞', value: val});
                }
                if (svc.name === '_delivery_last_mile') {
                    // –ü–æ—Å–ª–µ–¥–Ω—è—è –º–∏–ª—è ‚Äî —Ç–æ–ª—å–∫–æ –∏–∑ –¥–æ—Å—Ç–∞–≤–æ–∫ (–±–µ–∑ –≤–æ–∑–≤—Ä–∞—Ç–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)
                    const val = Math.abs(svc.sum);
                    logTotal += val;
                    logDetails.push({label: '–ü–æ—Å–ª–µ–¥–Ω—è—è –º–∏–ª—è', value: val});
                }
            });

            // 2) –î–æ—Å—Ç–∞–≤–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ ‚Äî –∏–∑ operations (OperationItemReturn)
            (data.operations || []).forEach(op => {
                if (op.type === 'OperationItemReturn') {
                    const val = Math.abs(op.sum);
                    logTotal += val;
                    logDetails.push({label: '–î–æ—Å—Ç–∞–≤–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞', value: val});
                }
            });

            console.log('[TX] logTotal:', logTotal, 'details:', logDetails.length);
            const logCard = document.getElementById('real-logistics-card');
            if (logCard) {
                document.getElementById('real-logistics-total').textContent = fmtRealMoney(-logTotal);
                // –ë–µ–π–¥–∂ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
                const logBadge = document.getElementById('real-logistics-badge');
                if (logBadge && logDetails.length > 0) {
                    logBadge.textContent = logDetails.length;
                    logBadge.classList.add('visible');
                }
                // –î–µ—Ç–∞–ª–∏ –ø–æ –∫–ª–∏–∫—É
                let detailsHtml = '';
                logDetails.forEach(d => {
                    detailsHtml += '<div class="real-detail-row">' +
                        '<span class="real-detail-label">' + escapeHtml(d.label) + '</span>' +
                        '<span class="real-detail-value">' + fmtRealMoney(-d.value) + '</span>' +
                        '</div>';
                });
                document.getElementById('real-logistics-details').innerHTML = detailsHtml;
                logCard.style.display = '';
            }

            // ‚îÄ‚îÄ –ö–∞—Ä—Ç–æ—á–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: –ò–Ω—ã–µ —É–¥–µ—Ä–∂–∞–Ω–∏—è, –†–µ–∫–ª–∞–º–∞, –•—Ä–∞–Ω–µ–Ω–∏–µ ‚îÄ‚îÄ
            // –í–ê–ñ–ù–û: operations –∏ services ‚Äî –¥–≤–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –û–î–ù–ò–• –¥–∞–Ω–Ω—ã—Ö.
            // operation.amount ‚âà sum(operation.services.price), –ø–æ—ç—Ç–æ–º—É –Ω–µ–ª—å–∑—è
            // —Å—É–º–º–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –æ–±–æ–∏—Ö –º–∞—Å—Å–∏–≤–æ–≤ ‚Äî –±—É–¥–µ—Ç –¥–≤–æ–π–Ω–æ–π –ø–æ–¥—Å—á—ë—Ç.
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¢–û–õ–¨–ö–û data.operations (–ø–æ op.type).
            // –ö–∞–∂–¥—ã–π —Ä—É–±–ª—å –≤ API —É—á—Ç—ë–Ω —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ –∫–∞–∫ operation.amount.
            // Services ‚Äî —ç—Ç–æ –≤–ª–æ–∂–µ–Ω–Ω–∞—è —Ä–∞–∑–±–∏–≤–∫–∞ –¢–ï–• –ñ–ï –¥–µ–Ω–µ–≥, —Å—É–º–º–∏—Ä–æ–≤–∞—Ç—å –æ–±–∞ = –¥–≤–æ–π–Ω–æ–π –ø–æ–¥—Å—á—ë—Ç.
            // –ù–∞–∑–≤–∞–Ω–∏—è –±–µ—Ä—ë–º –∏–∑ op.name (operation_type_name –∏–∑ API).
            const operationCatMap = {
                // –ò–Ω—ã–µ —É–¥–µ—Ä–∂–∞–Ω–∏—è
                'MarketplaceServiceBrandCommission': 'other_deductions',
                'PremiumMembership': 'other_deductions',
                'OperationSubscriptionPremiumPro': 'other_deductions',
                'OperationSubscriptionPremiumPlus': 'other_deductions',
                'OperationSubscriptionPremium': 'other_deductions',
                'OperationMarketPlaceItemPinReview': 'other_deductions',
                'OperationMarketplaceItemTemporaryStorageRedistribution': 'other_deductions',
                'OperationMarketplaceServiceProcessingSpoilageSurplus': 'other_deductions',
                'OperationMarketplaceServiceSupplyInboundCargoShortage': 'other_deductions',
                'OperationSellerReturnsCargoAssortmentInvalid': 'other_deductions',
                // –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ (–ü–æ—Ç–µ—Ä—è –ø–æ –≤–∏–Ω–µ Ozon)
                'AccrualConsigWriteOff': 'compensations',
                'AccrualInternalClaim': 'compensations',
                'SellerReturnsDeliveryToPickupPoint': 'other_deductions',
                'MarketplaceSellerCorrectionOperation': 'other_deductions',
                'MarketplaceSellerDecompensationItemByTypeDocOperation': 'other_deductions',
                'MarketplaceServiceItemCrossdocking': 'other_deductions',
                // –†–µ–∫–ª–∞–º–∞
                'OperationMarketplaceCostPerClick': 'advertising',
                'OperationPromotionWithCostPerOrder': 'advertising',
                // –•—Ä–∞–Ω–µ–Ω–∏–µ
                'TemporaryStorage': 'storage'
            };

            const catTotals = { other_deductions: 0, compensations: 0, advertising: 0, storage: 0 };
            const catDetails = { other_deductions: [], compensations: [], advertising: [], storage: [] };

            // –≠–∫–≤–∞–π—Ä–∏–Ω–≥ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –∫ –∫–æ–º–∏—Å—Å–∏–∏ –ú–ü –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ
            let acquiringTotal = 0;

            // –¢–æ–ª—å–∫–æ –∏–∑ operations ‚Äî op.name —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä—É—Å—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ API
            (data.operations || []).forEach(op => {
                // –≠–∫–≤–∞–π—Ä–∏–Ω–≥ —É—á–∏—Ç—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ ‚Äî –ø–æ—Ç–æ–º –¥–æ–±–∞–≤–∏–º –∫ –∫–æ–º–∏—Å—Å–∏–∏
                if (op.type === 'MarketplaceRedistributionOfAcquiringOperation') {
                    acquiringTotal += op.sum;
                    return;
                }
                const cat = operationCatMap[op.type];
                if (cat) {
                    catTotals[cat] += op.sum;
                    catDetails[cat].push({ label: op.name || op.type, value: op.sum });
                }
            });

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —ç–∫–≤–∞–π—Ä–∏–Ω–≥ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∫–æ–º–∏—Å—Å–∏–∏
            _realAcquiring = Math.abs(acquiringTotal);
            updateCommissionCard();

            // –ü–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É —Ç–æ–≤–∞—Ä–æ–≤ ‚Äî —Ç–µ–ø–µ—Ä—å —Å —É—á—ë—Ç–æ–º —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
            if (_realProductsData.length > 0) {
                renderRealizationProducts(_realProductsData);
            }

            // ¬´–ë–∞–ª–ª—ã –∑–∞ —Å–∫–∏–¥–∫–∏¬ª ‚Äî –∏–∑ realization API (bonuses_total), –¥–æ–±–∞–≤–ª—è–µ–º –∫ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è–º
            if (_realBonuses > 0) {
                catTotals.compensations += _realBonuses;
                catDetails.compensations.unshift({ label: '–ë–∞–ª–ª—ã –∑–∞ —Å–∫–∏–¥–∫–∏', value: _realBonuses });
            }

            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
            const catConfig = [
                { key: 'compensations', cardId: 'real-compensations-card', totalId: 'real-compensations-total', detailsId: 'real-compensations-details', badgeId: 'real-compensations-badge' },
                { key: 'other_deductions', cardId: 'real-other-deductions-card', totalId: 'real-other-deductions-total', detailsId: 'real-other-deductions-details', badgeId: 'real-other-deductions-badge' },
                { key: 'advertising', cardId: 'real-advertising-card', totalId: 'real-advertising-total', detailsId: 'real-advertising-details', badgeId: 'real-advertising-badge' },
                { key: 'storage', cardId: 'real-storage-card', totalId: 'real-storage-total', detailsId: 'real-storage-details', badgeId: 'real-storage-badge' }
            ];

            console.log('[TX] catTotals:', JSON.stringify(catTotals));
            catConfig.forEach(cfg => {
                const total = catTotals[cfg.key];
                const card = document.getElementById(cfg.cardId);
                console.log('[TX] card', cfg.key, 'total:', total, 'card:', !!card);
                if (card) {
                    document.getElementById(cfg.totalId).textContent = fmtRealMoney(total);
                    const details = catDetails[cfg.key];
                    // –ë–µ–π–¥–∂ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
                    const badge = document.getElementById(cfg.badgeId);
                    if (badge && details.length > 0) {
                        badge.textContent = details.length;
                        badge.classList.add('visible');
                    }
                    // –î–µ—Ç–∞–ª–∏ –ø–æ –∫–ª–∏–∫—É
                    if (details.length > 0) {
                        let html = '';
                        details.sort((a, b) => a.value - b.value).forEach(d => {
                            html += '<div class="real-detail-row">' +
                                '<span class="real-detail-label">' + escapeHtml(d.label) + '</span>' +
                                '<span class="real-detail-value">' + fmtRealMoney(d.value) + '</span>' +
                                '</div>';
                        });
                        document.getElementById(cfg.detailsId).innerHTML = html;
                    }
                    card.style.display = '';
                }
            });

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –Ω–∞–ª–æ–≥–∞
            _realLogistics = logTotal;
            _realOtherDeductions = catTotals.other_deductions;
            _realAdvertising = catTotals.advertising;
            _realStorage = catTotals.storage;
            _realCompensations = catTotals.compensations - _realBonuses;

            // Per-SKU –ª–æ–≥–∏—Å—Ç–∏–∫–∞ –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (—Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞ —á—Ç–æ –∫–∞—Ä—Ç–æ—á–∫–∞: –¥–æ—Å—Ç–∞–≤–∫–∏ + –≤–æ–∑–≤—Ä–∞—Ç—ã)
            _realLogisticsBySku = data.logistics_by_sku || {};

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É ¬´–ù–∞–ª–æ–≥–∏¬ª (–ù–î–° + –£–°–ù)
            _loadRealizationTax();
        }

        // ============================================================================
        // –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –†–ê–°–•–û–î–û–í –ü–û –ö–û–ù–¢–ï–ô–ù–ï–†–ê–ú
        // ============================================================================
        // –ë–ª–æ–∫ —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º –í–≠–î.
        // –ü–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å —Å—É–º–º—É —Ä–∞—Å—Ö–æ–¥–∞ –ø–æ —Ç–æ–≤–∞—Ä–∞–º –∏ —Ç–∏–ø–∞–º –∑–∞—Ç—Ä–∞—Ç
        // (–ª–æ–≥–∏—Å—Ç–∏–∫–∞ –†–§/–ö–ù–†, —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã, –ø–æ—à–ª–∏–Ω–∞) –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤.
        // ============================================================================

        let financeContainersList = [];        // –ö—ç—à –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
        let financeContainerBlocks = [];       // –¢–µ–∫—É—â–∏–µ –±–ª–æ–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è [{blockId, containerId}]
        let financeContainerBlockCounter = 0;  // –°—á—ë—Ç—á–∏–∫ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö ID –±–ª–æ–∫–æ–≤
        let financeDistAccordionCache = {};    // –ö—ç—à –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞

        /**
         * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–µ–∫—Ü–∏—é –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º.
         * –°–µ–∫—Ü–∏—è –≤–∏–¥–Ω–∞, –∫–æ–≥–¥–∞ –≤—ã–±—Ä–∞–Ω–∞ —Ä–∞—Å—Ö–æ–¥–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å —Ñ–ª–∞–≥–æ–º is_container_linked.
         */
        function checkFinanceContainerSection() {
            const section = document.getElementById('finance-container-section');
            if (!section) return;

            const recordType = document.getElementById('finance-type')?.value;
            if (recordType !== 'expense' || !selectedFinanceCategoryId) {
                section.style.display = 'none';
                return;
            }

            // –ò—â–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥
            const cat = financeCategories.find(c => c.id === selectedFinanceCategoryId);
            if (cat && cat.is_container_linked) {
                section.style.display = 'block';
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –µ—Å–ª–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
                if (financeContainersList.length === 0) {
                    loadFinanceContainersList();
                }
            } else {
                section.style.display = 'none';
            }
        }

        /**
         * –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–ª–µ —Å—É–º–º—ã –≤ —é–∞–Ω—è—Ö –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
         * –ü–æ–ª–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –µ—Å–ª–∏ —É –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ñ–ª–∞–≥ requires_yuan.
         */
        function checkFinanceYuanField() {
            const field = document.getElementById('finance-yuan-field');
            if (!field) return;

            const recordType = document.getElementById('finance-type')?.value;
            if (recordType !== 'expense' || !selectedFinanceCategoryId) {
                field.style.display = 'none';
                return;
            }

            const cat = financeCategories.find(c => c.id === selectedFinanceCategoryId);
            if (cat && cat.requires_yuan) {
                field.style.display = '';
            } else {
                field.style.display = 'none';
                // –û—á–∏—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏
                const input = document.getElementById('finance-yuan-amount');
                if (input) input.value = '';
            }
        }

        /**
         * –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å/—Å–±—Ä–æ—Å–∏—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª—è –æ–ø–∏—Å–∞–Ω–∏—è.
         */
        function checkFinanceDescriptionField() {
            const descInput = document.getElementById('finance-description');
            const descLabel = document.getElementById('finance-description-label');
            if (!descInput) return;

            const cat = financeCategories.find(c => c.id === selectedFinanceCategoryId);
            if (cat && cat.requires_description) {
                const hint = cat.description_hint || '–û–ø–∏—Å–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ';
                descInput.placeholder = hint;
                descInput.style.borderColor = '#ef4444';
                if (descLabel) descLabel.textContent = '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π *';
            } else {
                descInput.placeholder = '–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π';
                descInput.style.borderColor = '';
                if (descLabel) descLabel.textContent = '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π';
            }
        }

        /**
         * –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–ª–µ ¬´–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥?¬ª –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—á—ë—Ç–∞.
         * –ï—Å–ª–∏ —É –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—á—ë—Ç–∞ —Å—Ç–æ–∏—Ç —Ñ–ª–∞–≥ requires_official –∏ —Ç–∏–ø = —Ä–∞—Å—Ö–æ–¥,
         * –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å –î–∞/–ù–µ—Ç.
         */
        function checkFinanceOfficialField() {
            const officialField = document.getElementById('finance-official-field');
            if (!officialField) return;

            const recordType = document.getElementById('finance-type')?.value;
            const acc = financeAccounts.find(a => a.id === selectedFinanceAccountId);
            if (recordType === 'expense' && acc && acc.requires_official) {
                officialField.style.display = '';
            } else {
                officialField.style.display = 'none';
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏
                document.querySelectorAll('input[name="finance-is-official"]').forEach(r => r.checked = false);
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–∞–π–ª—ã –∑–∞–ø–∏—Å–∏ (–ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏).
         */
        async function loadFinanceEditFiles(recordId) {
            const container = document.getElementById('finance-existing-files');
            const list = document.getElementById('finance-existing-files-list');
            if (!container || !list) return;
            try {
                const resp = await authFetch('/api/finance/records/' + recordId + '/files');
                const data = await resp.json();
                if (data.success && data.files && data.files.length > 0) {
                    container.style.display = '';
                    list.innerHTML = '';
                    data.files.forEach(f => {
                        const item = document.createElement('div');
                        item.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 4px 0;';
                        const link = document.createElement('a');
                        link.href = '/api/finance/files/' + f.id + '?view=1&token=' + encodeURIComponent(authToken);
                        link.target = '_blank';
                        link.textContent = f.filename;
                        link.style.cssText = 'color: #3b82f6; font-size: 13px;';
                        item.appendChild(link);
                        const size = document.createElement('span');
                        size.textContent = f.file_size > 1024*1024 ? (f.file_size/1024/1024).toFixed(1) + ' MB' : (f.file_size/1024).toFixed(0) + ' KB';
                        size.style.cssText = 'color: #999; font-size: 12px;';
                        item.appendChild(size);
                        const delBtn = document.createElement('button');
                        delBtn.textContent = 'x';
                        delBtn.style.cssText = 'background: none; border: none; color: #ef4444; cursor: pointer; font-size: 14px; padding: 0 4px;';
                        delBtn.onclick = async () => {
                            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª ' + f.filename + '?')) return;
                            try {
                                await authFetch('/api/finance/files/' + f.id, { method: 'DELETE' });
                                item.remove();
                                if (list.children.length === 0) container.style.display = 'none';
                            } catch(e) { console.error(e); }
                        };
                        item.appendChild(delBtn);
                        list.appendChild(item);
                    });
                } else {
                    container.style.display = 'none';
                }
            } catch(e) { container.style.display = 'none'; }
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –≤ —Ñ–æ—Ä–º–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.
         */
        async function loadFinanceContainersList() {
            try {
                const resp = await authFetch('/api/ved/containers/list-for-finance');
                const data = await resp.json();
                if (data.success) {
                    financeContainersList = data.containers || [];
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:', e);
            }
        }

        /**
         * –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –±–ª–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ —Ñ–æ—Ä–º—É —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.
         * –ö–∞–∂–¥—ã–π –±–ª–æ–∫ = –æ–¥–∏–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä + —Ç–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø–æ–ª—è–º–∏ –¥–ª—è 4 —Ç–∏–ø–æ–≤ –∑–∞—Ç—Ä–∞—Ç.
         */
        function addFinanceContainerBlock() {
            const blocksContainer = document.getElementById('finance-container-blocks');
            if (!blocksContainer) return;

            financeContainerBlockCounter++;
            const blockId = financeContainerBlockCounter;

            // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è select –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            let options = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä --</option>';
            financeContainersList.forEach(c => {
                // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –≤ –¥—Ä—É–≥–∏–µ –±–ª–æ–∫–∏
                const alreadyUsed = financeContainerBlocks.some(b => b.containerId === c.id);
                if (!alreadyUsed) {
                    options += `<option value="${c.id}">${c.label}</option>`;
                }
            });

            const block = document.createElement('div');
            block.className = 'finance-container-block';
            block.id = `finance-container-block-${blockId}`;
            block.innerHTML = `
                <div class="finance-container-block-header">
                    <select class="wh-input" id="finance-container-select-${blockId}"
                            onchange="onFinanceContainerSelect(${blockId})" style="flex: 1; max-width: 400px;">
                        ${options}
                    </select>
                    <button type="button" class="finance-container-block-remove"
                            onclick="removeFinanceContainerBlock(${blockId})" title="–£–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä">‚úï</button>
                </div>
                <div id="finance-container-items-${blockId}"></div>
            `;

            blocksContainer.appendChild(block);
            financeContainerBlocks.push({ blockId: blockId, containerId: null });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—Å—Ç–∞—Ç–∫–∞
            updateFinanceDistributionTotals();
        }

        /**
         * –£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–∑ —Ñ–æ—Ä–º—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.
         */
        function removeFinanceContainerBlock(blockId) {
            const block = document.getElementById(`finance-container-block-${blockId}`);
            if (block) block.remove();
            financeContainerBlocks = financeContainerBlocks.filter(b => b.blockId !== blockId);
            updateFinanceDistributionTotals();
        }

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ –±–ª–æ–∫–µ.
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ç–æ–≤–∞—Ä—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏ —Å—Ç—Ä–æ–∏—Ç —Ç–∞–±–ª–∏—Ü—É —Å –ø–æ–ª—è–º–∏ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.
         */
        function onFinanceContainerSelect(blockId) {
            const select = document.getElementById(`finance-container-select-${blockId}`);
            const containerId = select ? parseInt(select.value) : null;
            const itemsContainer = document.getElementById(`finance-container-items-${blockId}`);
            if (!itemsContainer) return;

            // –û–±–Ω–æ–≤–ª—è–µ–º containerId –≤ –º–∞—Å—Å–∏–≤–µ –±–ª–æ–∫–æ–≤
            const blockData = financeContainerBlocks.find(b => b.blockId === blockId);
            if (blockData) blockData.containerId = containerId;

            if (!containerId) {
                itemsContainer.innerHTML = '';
                updateFinanceDistributionTotals();
                return;
            }

            // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ –∫—ç—à–µ
            const container = financeContainersList.find(c => c.id === containerId);
            if (!container || !container.items || container.items.length === 0) {
                itemsContainer.innerHTML = '<p style="color: #999; font-size: 13px; padding: 8px;">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ</p>';
                return;
            }

            // –°—Ç—Ä–æ–∏–º —Ç–∞–±–ª–∏—Ü—É —Ç–æ–≤–∞—Ä–æ–≤
            let html = `
                <table class="finance-dist-table">
                    <thead>
                        <tr>
                            <th style="text-align: left;">–¢–æ–≤–∞—Ä</th>
                            <th>–õ–æ–≥. –†–§, ‚ÇΩ</th>
                            <th>–õ–æ–≥. –ö–ù–†, ‚ÇΩ</th>
                            <th>–¢–µ—Ä–º–∏–Ω–∞–ª, ‚ÇΩ</th>
                            <th>–ü–æ—à–ª–∏–Ω–∞, ‚ÇΩ</th>
                            <th>–ò—Ç–æ–≥–æ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            container.items.forEach(item => {
                const sku = item.sku;
                const name = item.offer_id || sku;
                const prefix = `fd-${blockId}-${sku}`;
                html += `
                    <tr>
                        <td title="SKU: ${sku}">${name} <span style="color:#999; font-size:11px;">(${item.quantity} —à—Ç.)</span></td>
                        <td><input type="number" id="${prefix}-logrf" min="0" step="0.01" placeholder="0"
                                   oninput="updateFinanceDistributionTotals()" data-block="${blockId}" data-sku="${sku}" data-type="logistics_rf"></td>
                        <td><input type="number" id="${prefix}-logcn" min="0" step="0.01" placeholder="0"
                                   oninput="updateFinanceDistributionTotals()" data-block="${blockId}" data-sku="${sku}" data-type="logistics_cn"></td>
                        <td><input type="number" id="${prefix}-terminal" min="0" step="0.01" placeholder="0"
                                   oninput="updateFinanceDistributionTotals()" data-block="${blockId}" data-sku="${sku}" data-type="terminal"></td>
                        <td><input type="number" id="${prefix}-customs" min="0" step="0.01" placeholder="0"
                                   oninput="updateFinanceDistributionTotals()" data-block="${blockId}" data-sku="${sku}" data-type="customs"></td>
                        <td class="fd-row-total-${blockId}-${sku}" style="font-weight: 500;">0</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <td style="font-weight: 600;">–ò—Ç–æ–≥–æ:</td>
                            <td id="fd-block-total-logrf-${blockId}">0</td>
                            <td id="fd-block-total-logcn-${blockId}">0</td>
                            <td id="fd-block-total-terminal-${blockId}">0</td>
                            <td id="fd-block-total-customs-${blockId}">0</td>
                            <td id="fd-block-total-all-${blockId}" style="font-weight: 700;">0</td>
                        </tr>
                    </tfoot>
                </table>
            `;

            itemsContainer.innerHTML = html;
            updateFinanceDistributionTotals();
        }

        /**
         * –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –≤—Å–µ –∏—Ç–æ–≥–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è: –ø–æ —Å—Ç—Ä–æ–∫–∞–º, –ø–æ –±–ª–æ–∫–∞–º, –æ–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫.
         */
        function updateFinanceDistributionTotals() {
            const amount = parseFloat(document.getElementById('finance-amount')?.value) || 0;
            let grandTotal = 0;

            financeContainerBlocks.forEach(block => {
                const containerId = block.containerId;
                if (!containerId) return;

                const container = financeContainersList.find(c => c.id === containerId);
                if (!container || !container.items) return;

                let blockLogRf = 0, blockLogCn = 0, blockTerminal = 0, blockCustoms = 0;

                container.items.forEach(item => {
                    const prefix = `fd-${block.blockId}-${item.sku}`;
                    const logrf = parseFloat(document.getElementById(`${prefix}-logrf`)?.value) || 0;
                    const logcn = parseFloat(document.getElementById(`${prefix}-logcn`)?.value) || 0;
                    const terminal = parseFloat(document.getElementById(`${prefix}-terminal`)?.value) || 0;
                    const customs = parseFloat(document.getElementById(`${prefix}-customs`)?.value) || 0;
                    const rowTotal = logrf + logcn + terminal + customs;

                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ —Å—Ç—Ä–æ–∫–∏
                    const rowTotalEl = document.querySelector(`.fd-row-total-${block.blockId}-${item.sku}`);
                    if (rowTotalEl) rowTotalEl.textContent = rowTotal ? rowTotal.toLocaleString('ru-RU') : '0';

                    blockLogRf += logrf;
                    blockLogCn += logcn;
                    blockTerminal += terminal;
                    blockCustoms += customs;
                });

                const blockTotal = blockLogRf + blockLogCn + blockTerminal + blockCustoms;
                grandTotal += blockTotal;

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ –±–ª–æ–∫–∞
                const fmt = v => v ? v.toLocaleString('ru-RU') : '0';
                const el = id => document.getElementById(id);
                if (el(`fd-block-total-logrf-${block.blockId}`)) el(`fd-block-total-logrf-${block.blockId}`).textContent = fmt(blockLogRf);
                if (el(`fd-block-total-logcn-${block.blockId}`)) el(`fd-block-total-logcn-${block.blockId}`).textContent = fmt(blockLogCn);
                if (el(`fd-block-total-terminal-${block.blockId}`)) el(`fd-block-total-terminal-${block.blockId}`).textContent = fmt(blockTerminal);
                if (el(`fd-block-total-customs-${block.blockId}`)) el(`fd-block-total-customs-${block.blockId}`).textContent = fmt(blockCustoms);
                if (el(`fd-block-total-all-${block.blockId}`)) el(`fd-block-total-all-${block.blockId}`).textContent = fmt(blockTotal);
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—Å—Ç–∞—Ç–∫–∞
            const remaining = amount - grandTotal;
            const remEl = document.getElementById('finance-dist-remaining');
            const remAmountEl = document.getElementById('finance-dist-remaining-amount');
            if (remEl && remAmountEl) {
                if (amount > 0 && financeContainerBlocks.some(b => b.containerId)) {
                    remEl.style.display = 'block';
                    remAmountEl.textContent = remaining.toLocaleString('ru-RU') + ' ‚ÇΩ';
                    remEl.className = 'finance-dist-remaining ' +
                        (Math.abs(remaining) < 0.01 ? 'ok' : 'error');
                } else {
                    remEl.style.display = 'none';
                }
            }
        }

        /**
         * –°–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑ —Ñ–æ—Ä–º—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.
         * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤: [{container_doc_id, sku, cost_type, amount}, ...]
         */
        function collectFinanceDistributions() {
            const distributions = [];

            financeContainerBlocks.forEach(block => {
                const containerId = block.containerId;
                if (!containerId) return;

                const container = financeContainersList.find(c => c.id === containerId);
                if (!container || !container.items) return;

                container.items.forEach(item => {
                    const prefix = `fd-${block.blockId}-${item.sku}`;
                    const types = ['logistics_rf', 'logistics_cn', 'terminal', 'customs'];
                    const suffixes = ['logrf', 'logcn', 'terminal', 'customs'];

                    types.forEach((costType, idx) => {
                        const val = parseFloat(document.getElementById(`${prefix}-${suffixes[idx]}`)?.value) || 0;
                        if (val > 0) {
                            distributions.push({
                                container_doc_id: containerId,
                                sku: item.sku,
                                cost_type: costType,
                                amount: val
                            });
                        }
                    });
                });
            });

            return distributions;
        }

        /**
         * –°–±—Ä–æ—Å–∏—Ç—å —Å–µ–∫—Ü–∏—é —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º.
         */
        function resetFinanceContainerSection() {
            const blocksContainer = document.getElementById('finance-container-blocks');
            if (blocksContainer) blocksContainer.innerHTML = '';
            financeContainerBlocks = [];
            financeContainerBlockCounter = 0;
            const section = document.getElementById('finance-container-section');
            if (section) section.style.display = 'none';
            const remEl = document.getElementById('finance-dist-remaining');
            if (remEl) remEl.style.display = 'none';
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º—É –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏.
         */
        async function loadFinanceDistributionsForEdit(recordId) {
            try {
                const resp = await authFetch(`/api/finance/records/${recordId}/distributions`);
                const data = await resp.json();
                if (!data.success || !data.distributions || data.distributions.length === 0) return;

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –µ—Å–ª–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
                if (financeContainersList.length === 0) {
                    await loadFinanceContainersList();
                }

                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ container_doc_id
                const grouped = {};
                data.distributions.forEach(d => {
                    if (!grouped[d.container_doc_id]) grouped[d.container_doc_id] = [];
                    grouped[d.container_doc_id].push(d);
                });

                // –°–æ–∑–¥–∞—ë–º –±–ª–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                for (const [docId, dists] of Object.entries(grouped)) {
                    addFinanceContainerBlock();
                    const blockId = financeContainerBlockCounter;
                    const select = document.getElementById(`finance-container-select-${blockId}`);
                    if (select) {
                        select.value = docId;
                        onFinanceContainerSelect(blockId);

                        // –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
                        dists.forEach(d => {
                            const suffixMap = {
                                logistics_rf: 'logrf', logistics_cn: 'logcn',
                                terminal: 'terminal', customs: 'customs'
                            };
                            const suffix = suffixMap[d.cost_type];
                            if (suffix) {
                                const input = document.getElementById(`fd-${blockId}-${d.sku}-${suffix}`);
                                if (input) input.value = d.amount;
                            }
                        });
                    }
                }

                updateFinanceDistributionTotals();
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π:', e);
            }
        }


        // ============================================================================
        // –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–û –ü–õ–ê–ù–£ –ó–ê–ö–£–ü–û–ö
        // ============================================================================
        // –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–∏–≤—è–∑–∞—Ç—å —Å—É–º–º—É –≤ —é–∞–Ω—è—Ö –∏–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ (—Ä–∞—Å—Ö–æ–¥–∞)
        // –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Å—Ç—Ä–æ–∫–∞–º –ø–ª–∞–Ω–∞. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–æ–≤–∞—Ä (–∞—Ä—Ç–∏–∫—É–ª),
        // —Ç–∏–ø (–∏–Ω–≤–æ–π—Å/–¥–µ–ª—å—Ç–∞) –∏ –≤–≤–æ–¥–∏—Ç —Å—É–º–º—ã. –†—É–±–ª–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        // –ø–æ –∫—É—Ä—Å—É –∏–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ (amount / yuan_amount).
        // ============================================================================

        let financePlanItemsList = [];           // –ö—ç—à: [{product_name, items: [...]}]
        let financePlanSelectedProduct = '';      // –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∞—Ä—Ç–∏–∫—É–ª
        let financePlanSelectedTarget = 'invoice'; // invoice –∏–ª–∏ delta

        /**
         * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–µ–∫—Ü–∏—é –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –ø–ª–∞–Ω—É.
         * –°–µ–∫—Ü–∏—è –≤–∏–¥–Ω–∞, –∫–æ–≥–¥–∞ –≤—ã–±—Ä–∞–Ω–∞ —Ä–∞—Å—Ö–æ–¥–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å —Ñ–ª–∞–≥–æ–º is_plan_linked
         * –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ —Å—É–º–º–∞ –≤ —é–∞–Ω—è—Ö.
         */
        function checkFinancePlanSection() {
            const section = document.getElementById('finance-plan-section');
            if (!section) return;

            const recordType = document.getElementById('finance-type')?.value;
            if (recordType !== 'expense' || !selectedFinanceCategoryId) {
                section.style.display = 'none';
                return;
            }

            const cat = financeCategories.find(c => c.id === selectedFinanceCategoryId);
            if (cat && cat.is_plan_linked) {
                section.style.display = 'block';
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –ø–ª–∞–Ω–∞ –µ—Å–ª–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
                if (financePlanItemsList.length === 0) {
                    loadFinancePlanItemsList();
                }
            } else {
                section.style.display = 'none';
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ –ø–ª–∞–Ω–∞ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤.
         */
        async function loadFinancePlanItemsList() {
            try {
                const resp = await authFetch('/api/plan/items-for-finance');
                const data = await resp.json();
                if (data.success) {
                    financePlanItemsList = data.products || [];
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º dropdown —Ç–æ–≤–∞—Ä–æ–≤
                    const select = document.getElementById('finance-plan-product');
                    if (select) {
                        let html = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä --</option>';
                        financePlanItemsList.forEach(p => {
                            html += '<option value="' + escapeHtml(p.product_name) + '">' + escapeHtml(p.product_name) + '</option>';
                        });
                        select.innerHTML = html;
                    }
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞–Ω–∞:', e);
            }
        }

        /**
         * –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∫—É—Ä—Å —é–∞–Ω—è –∏–∑ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã (—Ä—É–±–ª–∏ / —é–∞–Ω–∏).
         */
        function getFinancePlanRate() {
            const amount = parseFloat(document.getElementById('finance-amount')?.value) || 0;
            const yuanAmount = parseFloat(document.getElementById('finance-yuan-amount')?.value) || 0;
            if (yuanAmount > 0 && amount > 0) {
                return amount / yuanAmount;
            }
            return 0;
        }

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–∞ ‚Äî –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å—Ç—Ä–æ–∫ –ø–ª–∞–Ω–∞.
         */
        function onFinancePlanProductSelect() {
            const select = document.getElementById('finance-plan-product');
            financePlanSelectedProduct = select ? select.value : '';
            renderFinancePlanRows();
        }

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã —Ç–∏–ø–∞ (–∏–Ω–≤–æ–π—Å/–¥–µ–ª—å—Ç–∞) ‚Äî –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É.
         */
        function onFinancePlanTargetChange() {
            const select = document.getElementById('finance-plan-target');
            financePlanSelectedTarget = select ? select.value : 'invoice';
            renderFinancePlanRows();
        }

        /**
         * –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å—Ç—Ä–æ–∫ –ø–ª–∞–Ω–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞.
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç: –¥–∞—Ç—É –≤—ã—Ö–æ–¥–∞, –∫–æ–ª-–≤–æ, —Ü–µ–Ω—É, –æ–∂–∏–¥–∞–µ–º—É—é —Å—É–º–º—É, –æ–ø–ª–∞—á–µ–Ω–æ, –æ—Å—Ç–∞—Ç–æ–∫,
         * –ø–æ–ª–µ –≤–≤–æ–¥–∞ —é–∞–Ω–µ–π –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç —Ä—É–±–ª–µ–π.
         */
        function renderFinancePlanRows() {
            const container = document.getElementById('finance-plan-rows');
            if (!container) return;

            if (!financePlanSelectedProduct) {
                container.innerHTML = '';
                updateFinancePlanDistTotals();
                return;
            }

            const product = financePlanItemsList.find(p => p.product_name === financePlanSelectedProduct);
            if (!product || !product.items || product.items.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 13px; padding: 8px;">–ù–µ—Ç —Å—Ç—Ä–æ–∫ –ø–ª–∞–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞</p>';
                updateFinancePlanDistTotals();
                return;
            }

            const target = financePlanSelectedTarget;
            const rate = getFinancePlanRate();

            let html = '<div style="overflow-x: auto;"><table class="finance-dist-table">';
            html += '<thead><tr>';
            html += '<th style="text-align: left;">–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞</th>';
            html += '<th>–ö–æ–ª-–≤–æ</th>';
            html += '<th>–¶–µ–Ω–∞ ¬•/—à—Ç</th>';
            html += '<th>–û–∂–∏–¥–∞–µ—Ç—Å—è ¬•</th>';
            html += '<th>–û–ø–ª–∞—á–µ–Ω–æ ¬•</th>';
            html += '<th>–û—Å—Ç–∞—Ç–æ–∫ ¬•</th>';
            html += '<th>–°—É–º–º–∞ ¬•</th>';
            html += '<th>–°—É–º–º–∞ ‚ÇΩ</th>';
            html += '</tr></thead><tbody>';

            product.items.forEach(item => {
                const pricePerUnit = target === 'invoice' ? (item.price_yuan_invoice || 0) : (item.price_yuan_delta_invoice || 0);
                const expected = pricePerUnit * (item.planned_qty || 0);
                const paid = target === 'invoice' ? (item.paid_invoice_yuan || 0) : (item.paid_delta_yuan || 0);
                const remaining = Math.max(expected - paid, 0);
                const dateStr = item.planned_release_date ? formatPlanDate(item.planned_release_date) : '‚Äî';

                html += '<tr>';
                html += '<td>' + dateStr + '</td>';
                html += '<td style="text-align: center;">' + fmtNum(item.planned_qty) + '</td>';
                html += '<td style="text-align: right;">' + fmtMoney(pricePerUnit) + '</td>';
                html += '<td style="text-align: right;">' + fmtMoney(expected) + '</td>';
                html += '<td style="text-align: right;">' + fmtMoney(paid) + '</td>';
                html += '<td style="text-align: right; font-weight: 600; color: ' + (remaining > 0 ? '#f59e0b' : '#16a34a') + ';">' + fmtMoney(remaining) + '</td>';
                html += '<td><input type="number" id="fpd-yuan-' + item.id + '" min="0" step="0.01" max="' + remaining.toFixed(2) + '" placeholder="0" '
                       + 'oninput="updateFinancePlanDistTotals()" data-plan-id="' + item.id + '" data-remaining="' + remaining + '" '
                       + 'style="width: 100px;"></td>';
                html += '<td id="fpd-rub-' + item.id + '" style="text-align: right; color: #16a34a; font-weight: 500;">0</td>';
                html += '</tr>';
            });

            // –ò—Ç–æ–≥–æ
            html += '</tbody><tfoot><tr>';
            html += '<td style="font-weight: 600;" colspan="6">–ò—Ç–æ–≥–æ:</td>';
            html += '<td id="fpd-total-yuan" style="font-weight: 700;">0</td>';
            html += '<td id="fpd-total-rub" style="font-weight: 700; color: #16a34a;">0</td>';
            html += '</tr></tfoot></table></div>';

            container.innerHTML = html;
            updateFinancePlanDistTotals();
        }

        /**
         * –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∏—Ç–æ–≥–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –ø–ª–∞–Ω—É: –ø–æ —Å—Ç—Ä–æ–∫–∞–º, –æ–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫.
         * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ä—É–±–ª–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ –ø–æ –∫—É—Ä—Å—É.
         */
        function updateFinancePlanDistTotals() {
            const yuanAmount = parseFloat(document.getElementById('finance-yuan-amount')?.value) || 0;
            const rate = getFinancePlanRate();
            let totalYuan = 0;
            let totalRub = 0;

            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º input –ø–æ–ª—è–º —Å data-plan-id
            document.querySelectorAll('input[data-plan-id]').forEach(input => {
                const planId = input.dataset.planId;
                const val = parseFloat(input.value) || 0;
                const rubVal = val * rate;

                totalYuan += val;
                totalRub += rubVal;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä—É–±–ª—ë–≤—É—é —è—á–µ–π–∫—É
                const rubEl = document.getElementById('fpd-rub-' + planId);
                if (rubEl) rubEl.textContent = rubVal ? fmtMoney(rubVal) : '0';
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ
            const totalYuanEl = document.getElementById('fpd-total-yuan');
            const totalRubEl = document.getElementById('fpd-total-rub');
            if (totalYuanEl) totalYuanEl.textContent = totalYuan ? fmtMoney(totalYuan) + ' ¬•' : '0';
            if (totalRubEl) totalRubEl.textContent = totalRub ? fmtMoney(totalRub) + ' ‚ÇΩ' : '0';

            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—Å—Ç–∞—Ç–∫–∞
            const remaining = yuanAmount - totalYuan;
            const remEl = document.getElementById('finance-plan-dist-remaining');
            const remAmountEl = document.getElementById('finance-plan-dist-remaining-amount');
            if (remEl && remAmountEl) {
                if (yuanAmount > 0 && financePlanSelectedProduct) {
                    remEl.style.display = 'block';
                    remAmountEl.textContent = fmtMoney(remaining) + ' ¬•';
                    remEl.className = 'finance-dist-remaining ' +
                        (Math.abs(remaining) < 0.01 ? 'ok' : remaining < 0 ? 'error' : 'error');
                } else {
                    remEl.style.display = 'none';
                }
            }
        }

        /**
         * –ê–≤—Ç–æ-—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —é–∞–Ω–µ–π –ø–æ —Å—Ç—Ä–æ–∫–∞–º –ø–ª–∞–Ω–∞.
         * –ó–∞–ø–æ–ª–Ω—è–µ—Ç —Å—Ç—Ä–æ–∫–∏ –Ω–∞—á–∏–Ω–∞—è —Å —Å–∞–º–æ–π —Ä–∞–Ω–Ω–µ–π –¥–∞—Ç—ã –≤—ã—Ö–æ–¥–∞ –¥–æ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è —Å—É–º–º—ã.
         */
        function autoDistributeFinancePlan() {
            const yuanAmount = parseFloat(document.getElementById('finance-yuan-amount')?.value) || 0;
            if (yuanAmount <= 0) {
                alert('–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –≤ —é–∞–Ω—è—Ö');
                return;
            }

            if (!financePlanSelectedProduct) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä');
                return;
            }

            const product = financePlanItemsList.find(p => p.product_name === financePlanSelectedProduct);
            if (!product || !product.items) return;

            let remaining = yuanAmount;

            // –°—Ç—Ä–æ–∫–∏ —É–∂–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –¥–∞—Ç–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
            product.items.forEach(item => {
                const input = document.getElementById('fpd-yuan-' + item.id);
                if (!input || remaining <= 0) {
                    if (input) input.value = '';
                    return;
                }

                const maxRemaining = parseFloat(input.dataset.remaining) || 0;
                if (maxRemaining <= 0) {
                    input.value = '';
                    return;
                }

                const fill = Math.min(remaining, maxRemaining);
                input.value = fill.toFixed(2);
                remaining -= fill;
            });

            updateFinancePlanDistTotals();
        }

        /**
         * –°–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –ø–ª–∞–Ω—É –∏–∑ —Ñ–æ—Ä–º—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.
         * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: [{plan_item_id, target_type, yuan_amount, rub_amount}, ...]
         */
        function collectFinancePlanDistributions() {
            const distributions = [];
            const rate = getFinancePlanRate();
            const target = financePlanSelectedTarget;

            document.querySelectorAll('input[data-plan-id]').forEach(input => {
                const planId = parseInt(input.dataset.planId);
                const val = parseFloat(input.value) || 0;
                if (val > 0 && planId) {
                    distributions.push({
                        plan_item_id: planId,
                        target_type: target,
                        yuan_amount: Math.round(val * 100) / 100,
                        rub_amount: Math.round(val * rate * 100) / 100
                    });
                }
            });

            return distributions;
        }

        /**
         * –°–±—Ä–æ—Å–∏—Ç—å —Å–µ–∫—Ü–∏—é —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –ø–ª–∞–Ω—É.
         */
        function resetFinancePlanSection() {
            const container = document.getElementById('finance-plan-rows');
            if (container) container.innerHTML = '';
            const section = document.getElementById('finance-plan-section');
            if (section) section.style.display = 'none';
            const remEl = document.getElementById('finance-plan-dist-remaining');
            if (remEl) remEl.style.display = 'none';
            const select = document.getElementById('finance-plan-product');
            if (select) select.value = '';
            const targetSelect = document.getElementById('finance-plan-target');
            if (targetSelect) targetSelect.value = 'invoice';
            financePlanSelectedProduct = '';
            financePlanSelectedTarget = 'invoice';
            financePlanItemsList = [];
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –ø–ª–∞–Ω—É –≤ —Ñ–æ—Ä–º—É –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏.
         */
        async function loadFinancePlanDistributionsForEdit(recordId) {
            try {
                const resp = await authFetch('/api/finance/records/' + recordId + '/plan-distributions');
                const data = await resp.json();
                if (!data.success || !data.distributions || data.distributions.length === 0) return;

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –ø–ª–∞–Ω–∞ –µ—Å–ª–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
                if (financePlanItemsList.length === 0) {
                    await loadFinancePlanItemsList();
                }

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–æ–≤–∞—Ä –∏ —Ç–∏–ø –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
                const first = data.distributions[0];
                const productName = first.product_name;
                const targetType = first.target_type;

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ dropdown-—ã
                const productSelect = document.getElementById('finance-plan-product');
                if (productSelect) {
                    productSelect.value = productName;
                    financePlanSelectedProduct = productName;
                }
                const targetSelect = document.getElementById('finance-plan-target');
                if (targetSelect) {
                    targetSelect.value = targetType;
                    financePlanSelectedTarget = targetType;
                }

                // –†–∏—Å—É–µ–º —Ç–∞–±–ª–∏—Ü—É —Å—Ç—Ä–æ–∫
                renderFinancePlanRows();

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
                data.distributions.forEach(d => {
                    const input = document.getElementById('fpd-yuan-' + d.plan_item_id);
                    if (input) {
                        input.value = d.yuan_amount;
                    }
                });

                updateFinancePlanDistTotals();
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞–Ω-—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π:', e);
            }
        }


        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∞–∫–∫–æ—Ä–¥–µ–æ–Ω —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ –∑–∞–ø–∏—Å–µ–π.
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ä–∞—Å–∫—Ä—ã—Ç–∏–∏, –∫—ç—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
         */
        async function toggleFinanceFilesRow(recordId, parentRow) {
            const existingRow = document.getElementById('finance-files-row-' + recordId);
            if (existingRow) {
                existingRow.remove();
                return;
            }
            try {
                const resp = await authFetch('/api/finance/records/' + recordId + '/files');
                const data = await resp.json();
                if (!data.success || !data.files.length) return;
                const filesRow = document.createElement('tr');
                filesRow.id = 'finance-files-row-' + recordId;
                const td = document.createElement('td');
                td.colSpan = 12;
                td.style.cssText = 'padding: 8px 16px; background: #f8f9fa;';
                data.files.forEach(f => {
                    const link = document.createElement('a');
                    link.href = '/api/finance/files/' + f.id + '?view=1&token=' + encodeURIComponent(authToken);
                    link.target = '_blank';
                    link.textContent = f.filename;
                    link.style.cssText = 'color: #3b82f6; margin-right: 16px; font-size: 13px;';
                    td.appendChild(link);
                });
                filesRow.appendChild(td);
                parentRow.after(filesRow);
            } catch(e) { console.error(e); }
        }

        async function toggleFinanceDistAccordion(recordId) {
            const accordion = document.getElementById(`finance-dist-accordion-${recordId}`);
            if (!accordion) return;

            // –ï—Å–ª–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º
            if (accordion.classList.contains('visible')) {
                accordion.classList.remove('visible');
                return;
            }

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω—ã
            document.querySelectorAll('.finance-dist-accordion.visible').forEach(a => a.classList.remove('visible'));

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç—Ç–æ—Ç
            accordion.classList.add('visible');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –Ω–µ –≤ –∫—ç—à–µ
            const content = document.getElementById(`finance-dist-accordion-content-${recordId}`);
            if (financeDistAccordionCache[recordId]) {
                renderFinanceDistAccordionContent(recordId, financeDistAccordionCache[recordId]);
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            if (content) content.innerHTML = '<div class="finance-dist-accordion-loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–∞ —Ç–∏–ø–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
                const [contResp, planResp] = await Promise.all([
                    authFetch(`/api/finance/records/${recordId}/distributions`),
                    authFetch(`/api/finance/records/${recordId}/plan-distributions`)
                ]);
                const contData = await contResp.json();
                const planData = await planResp.json();
                const combined = {
                    distributions: contData.success ? (contData.distributions || []) : [],
                    plan_distributions: planData.success ? (planData.distributions || []) : []
                };
                financeDistAccordionCache[recordId] = combined;
                renderFinanceDistAccordionContent(recordId, combined);
            } catch (e) {
                if (content) content.innerHTML = '<div class="finance-dist-accordion-loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }

        /**
         * –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.
         */
        function renderFinanceDistAccordionContent(recordId, data) {
            const content = document.getElementById(`finance-dist-accordion-content-${recordId}`);
            if (!content) return;

            const hasCont = data.distributions && data.distributions.length > 0;
            const hasPlan = data.plan_distributions && data.plan_distributions.length > 0;

            if (!hasCont && !hasPlan) {
                content.innerHTML = '<div class="finance-dist-accordion-loading">–ù–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π</div>';
                return;
            }

            let html = '';

            // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º
            if (hasCont) {
                const grouped = {};
                data.distributions.forEach(d => {
                    if (!grouped[d.container_doc_id]) {
                        grouped[d.container_doc_id] = { label: d.container_label, items: [] };
                    }
                    grouped[d.container_doc_id].items.push(d);
                });

                const costTypeNames = {
                    logistics_rf: '–õ–æ–≥. –†–§',
                    logistics_cn: '–õ–æ–≥. –ö–ù–†',
                    terminal: '–¢–µ—Ä–º–∏–Ω–∞–ª',
                    customs: '–ü–æ—à–ª–∏–Ω–∞'
                };

                for (const [docId, group] of Object.entries(grouped)) {
                    html += '<div style="margin-bottom: 10px;">';
                    html += '<div style="font-weight: 600; font-size: 13px; margin-bottom: 6px; color: #333;">üì¶ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä ' + escapeHtml(group.label) + '</div>';
                    html += '<table class="finance-dist-accordion-table"><thead><tr><th>–¢–æ–≤–∞—Ä</th><th>–¢–∏–ø –∑–∞—Ç—Ä–∞—Ç</th><th style="text-align:right;">–°—É–º–º–∞</th></tr></thead><tbody>';

                    let containerTotal = 0;
                    group.items.forEach(d => {
                        containerTotal += d.amount;
                        html += '<tr><td>' + (d.offer_id || d.sku) + '</td>';
                        html += '<td>' + (costTypeNames[d.cost_type] || d.cost_type) + '</td>';
                        html += '<td style="text-align: right; font-weight: 500;">' + d.amount.toLocaleString('ru-RU') + ' ‚ÇΩ</td></tr>';
                    });

                    html += '</tbody><tfoot><tr><td colspan="2" style="font-weight: 600;">–ò—Ç–æ–≥–æ –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É</td>';
                    html += '<td style="text-align: right; font-weight: 700;">' + containerTotal.toLocaleString('ru-RU') + ' ‚ÇΩ</td></tr></tfoot></table></div>';
                }
            }

            // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –ø–ª–∞–Ω—É
            if (hasPlan) {
                const targetNames = { invoice: '–ò–Ω–≤–æ–π—Å', delta: '–î–µ–ª—å—Ç–∞' };
                html += '<div style="margin-bottom: 10px;">';
                html += '<div style="font-weight: 600; font-size: 13px; margin-bottom: 6px; color: #333;">üìã –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø–ª–∞–Ω—É</div>';
                html += '<table class="finance-dist-accordion-table"><thead><tr>';
                html += '<th>–¢–æ–≤–∞—Ä</th><th>–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞</th><th>–¢–∏–ø</th><th style="text-align:right;">–°—É–º–º–∞ ¬•</th><th style="text-align:right;">–°—É–º–º–∞ ‚ÇΩ</th>';
                html += '</tr></thead><tbody>';

                let totalY = 0, totalR = 0;
                data.plan_distributions.forEach(d => {
                    totalY += d.yuan_amount || 0;
                    totalR += d.rub_amount || 0;
                    const dateStr = d.planned_release_date ? formatPlanDate(d.planned_release_date) : '‚Äî';
                    html += '<tr><td>' + escapeHtml(d.product_name) + '</td>';
                    html += '<td>' + dateStr + '</td>';
                    html += '<td>' + (targetNames[d.target_type] || d.target_type) + '</td>';
                    html += '<td style="text-align: right; color: #f59e0b; font-weight: 500;">' + (d.yuan_amount || 0).toLocaleString('ru-RU') + ' ¬•</td>';
                    html += '<td style="text-align: right; color: #16a34a; font-weight: 500;">' + (d.rub_amount || 0).toLocaleString('ru-RU') + ' ‚ÇΩ</td></tr>';
                });

                html += '</tbody><tfoot><tr><td colspan="3" style="font-weight: 600;">–ò—Ç–æ–≥–æ –ø–æ –ø–ª–∞–Ω—É</td>';
                html += '<td style="text-align: right; font-weight: 700; color: #f59e0b;">' + totalY.toLocaleString('ru-RU') + ' ¬•</td>';
                html += '<td style="text-align: right; font-weight: 700; color: #16a34a;">' + totalR.toLocaleString('ru-RU') + ' ‚ÇΩ</td>';
                html += '</tr></tfoot></table></div>';
            }

            content.innerHTML = html;
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–¥–≤–∫–ª–∞–¥–∫–∏ –ü–µ–Ω–¥–µ–ª—å ‚Äî —Ä–∞—Å—Ö–æ–¥—ã, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.
         */
        async function loadPendelData() {
            const dateFrom = document.getElementById('pendel-date-from')?.value || '';
            const dateTo = document.getElementById('pendel-date-to')?.value || '';

            const params = new URLSearchParams();
            if (dateFrom) params.append('date_from', dateFrom);
            if (dateTo) params.append('date_to', dateTo);

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–µ—à –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            pendelCache = {};

            try {
                const resp = await authFetch('/api/finance/pendel?' + params.toString());
                const data = await resp.json();

                if (data.error) {
                    console.error('Pendel error:', data.error);
                    return;
                }

                pendelDataLoaded = true;

                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –∏—Ç–æ–≥–æ–≤
                document.getElementById('pendel-total-expense').textContent =
                    Number(data.summary.total_expense || 0).toLocaleString('ru-RU', {minimumFractionDigits: 2}) + ' ‚ÇΩ';
                document.getElementById('pendel-cat-count').textContent = data.summary.category_count || 0;

                // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                renderPendelTable(data.categories || []);

            } catch (err) {
                console.error('Failed to load pendel data:', err);
            }
        }

        /**
         * –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ü–µ–Ω–¥–µ–ª—å —Å –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞–º–∏.
         */
        function renderPendelTable(categories) {
            const tbody = document.getElementById('pendel-tbody');
            const wrapper = document.getElementById('pendel-table-wrapper');
            const empty = document.getElementById('pendel-empty');

            if (!categories || categories.length === 0) {
                wrapper.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            wrapper.style.display = 'block';
            empty.style.display = 'none';

            let html = '';
            categories.forEach((cat, idx) => {
                const catId = cat.category_id || 0;
                const catName = escapeHtml(cat.category_name || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
                const totalAmount = Number(cat.total_amount || 0).toLocaleString('ru-RU', {minimumFractionDigits: 2});
                const count = cat.count || 0;

                // –°—Ç—Ä–æ–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è)
                html += '<tr class="pendel-category-row" id="pendel-cat-row-' + catId + '" onclick="togglePendelAccordion(' + catId + ')">';
                html += '<td class="cat-name">' + catName + '</td>';
                html += '<td class="cat-amount">' + totalAmount + ' ‚ÇΩ</td>';
                html += '<td class="cat-count">' + count + '</td>';
                html += '<td style="text-align:center;"><span class="pendel-category-arrow">‚ñ∂</span></td>';
                html += '</tr>';

                // –°–∫—Ä—ã—Ç—ã–π –∞–∫–∫–æ—Ä–¥–µ–æ–Ω –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
                html += '<tr class="pendel-accordion" id="pendel-accordion-' + catId + '">';
                html += '<td colspan="4" class="pendel-accordion-cell">';
                html += '<div class="pendel-accordion-content" id="pendel-accordion-content-' + catId + '">';
                html += '<div class="pendel-accordion-loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                html += '</div>';
                html += '</td>';
                html += '</tr>';
            });

            tbody.innerHTML = html;
        }

        /**
         * –†–∞—Å–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ –ü–µ–Ω–¥–µ–ª—å.
         */
        async function togglePendelAccordion(categoryId) {
            const row = document.getElementById('pendel-cat-row-' + categoryId);
            const accordion = document.getElementById('pendel-accordion-' + categoryId);
            const content = document.getElementById('pendel-accordion-content-' + categoryId);

            const isExpanded = row.classList.contains('expanded');

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω—ã
            document.querySelectorAll('.pendel-category-row.expanded').forEach(r => r.classList.remove('expanded'));
            document.querySelectorAll('.pendel-accordion.visible').forEach(a => a.classList.remove('visible'));

            // –ï—Å–ª–∏ —É–∂–µ –±—ã–ª –æ—Ç–∫—Ä—ã—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º
            if (isExpanded) return;

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π
            row.classList.add('expanded');
            accordion.classList.add('visible');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
            if (pendelCache[categoryId]) {
                renderPendelAccordionContent(categoryId, pendelCache[categoryId]);
                return;
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
            content.innerHTML = '<div class="pendel-accordion-loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π...</div>';

            try {
                const dateFrom = document.getElementById('pendel-date-from')?.value || '';
                const dateTo = document.getElementById('pendel-date-to')?.value || '';

                const params = new URLSearchParams();
                params.append('category_id', categoryId);
                if (dateFrom) params.append('date_from', dateFrom);
                if (dateTo) params.append('date_to', dateTo);

                const resp = await authFetch('/api/finance/pendel/details?' + params.toString());
                const data = await resp.json();

                if (data.error) {
                    content.innerHTML = '<div class="pendel-accordion-loading">–û—à–∏–±–∫–∞: ' + escapeHtml(data.error) + '</div>';
                    return;
                }

                pendelCache[categoryId] = data.transactions || [];
                renderPendelAccordionContent(categoryId, data.transactions || []);

            } catch (err) {
                content.innerHTML = '<div class="pendel-accordion-loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }

        /**
         * –†–µ–Ω–¥–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ ‚Äî —Ç–∞–±–ª–∏—Ü–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
         */
        function renderPendelAccordionContent(categoryId, transactions) {
            const content = document.getElementById('pendel-accordion-content-' + categoryId);

            if (!transactions || transactions.length === 0) {
                content.innerHTML = '<div class="pendel-accordion-loading" style="color:#999;font-style:italic;">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>';
                return;
            }

            let html = '<table class="pendel-accordion-table">';
            html += '<thead><tr>';
            html += '<th>–î–∞—Ç–∞</th>';
            html += '<th>–°—É–º–º–∞</th>';
            html += '<th>–°—á—ë—Ç</th>';
            html += '<th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>';
            html += '<th>–°–æ–∑–¥–∞–ª</th>';
            html += '</tr></thead>';
            html += '<tbody>';

            transactions.forEach(tx => {
                const txDate = tx.record_date || '';
                const txAmount = Number(tx.amount || 0).toLocaleString('ru-RU', {minimumFractionDigits: 2});
                const txAccount = escapeHtml(tx.account_name || '‚Äî');
                const txDesc = escapeHtml(tx.description || '‚Äî');
                const txCreatedBy = escapeHtml(tx.created_by || '‚Äî');

                html += '<tr>';
                html += '<td>' + txDate + '</td>';
                html += '<td style="font-weight:600;color:#e53e3e;">' + txAmount + ' ‚ÇΩ</td>';
                html += '<td>' + txAccount + '</td>';
                html += '<td>' + txDesc + '</td>';
                html += '<td>' + txCreatedBy + '</td>';
                html += '</tr>';
            });

            html += '</tbody></table>';
            content.innerHTML = html;
        }

        /**
         * –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ü–µ–Ω–¥–µ–ª—å –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö.
         */
        function resetPendelFilters() {
            document.getElementById('pendel-date-from').value = '';
            document.getElementById('pendel-date-to').value = '';
            pendelDataLoaded = false;
            pendelCache = {};
            loadPendelData();
        }


        // ============================================================================
        // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –í–ö–õ–ê–î–ö–ò "–°–û–û–ë–©–ï–ù–ò–Ø"
        // ============================================================================

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function loadAllMessages() {
            const unreadOnly = document.getElementById('messages-filter-unread')?.checked || false;
            const listDiv = document.getElementById('messages-list');

            listDiv.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>';

            const url = unreadOnly
                ? '/api/document-messages/all?unread_only=true'
                : '/api/document-messages/all';

            authFetch(url)
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.messages.length > 0) {
                        listDiv.innerHTML = data.messages.map(msg => {
                            const date = new Date(msg.created_at);
                            const timeStr = date.toLocaleString('ru-RU', {
                                day: '2-digit', month: '2-digit', year: 'numeric',
                                hour: '2-digit', minute: '2-digit'
                            });
                            // –°–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –æ—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
                            const isOwn = msg.is_own === true;
                            const unreadClass = (msg.is_read || isOwn) ? '' : 'unread';

                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è
                            const isContainer = msg.msg_source === 'container' || msg.doc_type === 'container';
                            const isFinanceDistribution = msg.doc_type === 'finance_distribution';
                            let docInfo, docIcon, openBtnText;

                            if (isFinanceDistribution) {
                                docInfo = `–†–∞—Å—Ö–æ–¥ #${msg.doc_id} ‚Äî —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º`;
                                docIcon = 'üí∞';
                                openBtnText = 'üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å';
                            } else if (isContainer) {
                                docInfo = `–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä #${msg.doc_id}`;
                                docIcon = 'üì¶';
                                openBtnText = 'üì¶ –û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä';
                            } else if (msg.doc_type === 'receipt') {
                                docInfo = `–ü—Ä–∏—Ö–æ–¥ #${msg.doc_id}`;
                                docIcon = 'üìÑ';
                                openBtnText = 'üìÇ –û—Ç–∫—Ä—ã—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç';
                            } else {
                                docInfo = `–î–æ–∫—É–º–µ–Ω—Ç #${msg.doc_id}`;
                                docIcon = 'üìÑ';
                                openBtnText = 'üìÇ –û—Ç–∫—Ä—ã—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç';
                            }

                            // –ò–∫–æ–Ω–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞: system/telegram/web
                            const senderIcon = msg.sender_type === 'system' ? 'ü§ñ' : (msg.sender_type === 'telegram' ? 'üì±' : 'üåê');
                            // –¶–≤–µ—Ç –ø–æ –∏–º–µ–Ω–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
                            const uColor = getUserColor(msg.sender_name);

                            const msgSource = isContainer ? 'container' : 'document';
                            // –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                            const isOwnMsg = currentUser && msg.sender_id === currentUser.user_id;

                            return `
                                <div class="message-card ${unreadClass}" style="border-left: 4px solid ${uColor.border};" data-message-id="${msg.id}" data-doc-type="${msg.doc_type}" data-doc-id="${msg.doc_id}" data-msg-source="${msg.msg_source || 'document'}" data-message-text="${escapeHtml(msg.message).replace(/"/g, '&quot;')}">
                                    <div class="message-card-header">
                                        <div class="message-card-info">
                                            <div class="message-card-doc">${docIcon} ${docInfo}</div>
                                            <div class="message-card-sender" style="color: ${uColor.border}; font-weight: 600;">${senderIcon} ${escapeHtml(msg.sender_name || 'Telegram')}</div>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            ${isOwnMsg ? `
                                                <span class="msg-actions">
                                                    <button class="msg-action-btn" onclick="editMessage('${msgSource}', ${msg.id}, this.closest('.message-card'))" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                                                    <button class="msg-action-btn msg-delete-btn" onclick="deleteMessage('${msgSource}', ${msg.id})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                                                </span>
                                            ` : ''}
                                            <div class="message-card-time">${timeStr}</div>
                                        </div>
                                    </div>
                                    <div class="message-card-text" style="background: ${uColor.bg};">${escapeHtml(msg.message)}</div>
                                    <div class="message-card-actions">
                                        ${!isContainer && !isFinanceDistribution ? `
                                            <button class="message-btn message-btn-reply" onclick="openReplyModal(${msg.id}, '${escapeHtml(msg.message).replace(/'/g, "\\'")}', '${msg.doc_type}', ${msg.doc_id}, ${msg.telegram_chat_id || 0})">
                                                üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å
                                            </button>
                                        ` : ''}
                                        <button class="message-btn message-btn-open" onclick="openDocumentFromMessage('${msg.doc_type}', ${msg.doc_id})">
                                            ${openBtnText}
                                        </button>
                                        ${!msg.is_read && !isOwn && !isFinanceDistribution ? `
                                            <button class="message-btn message-btn-read" onclick="markMessageRead(${msg.id}, false, '${msg.msg_source || 'document'}')">
                                                ‚úì –ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        listDiv.innerHTML = '<div class="messages-empty">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                    }
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', err);
                    listDiv.innerHTML = '<div class="messages-empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                });
        }

        // –û–±–Ω–æ–≤–∏—Ç—å badge —Å–æ–æ–±—â–µ–Ω–∏–π
        function updateMessagesBadge() {
            authFetch('/api/document-messages/unread-count')
                .then(r => r.json())
                .then(data => {
                    const badge = document.getElementById('messages-badge');
                    if (data.success && data.count > 0) {
                        badge.textContent = data.count;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                })
                .catch(err => console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è badge:', err));
        }

        // –û—Ç–º–µ—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
        // skipConfirm=true ‚Äî –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–æ–º–µ—Ç–∫–µ –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞)
        // msgSource='document' –∏–ª–∏ 'container' ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏—è
        function markMessageRead(messageId, skipConfirm = false, msgSource = 'document') {
            if (!skipConfirm && !confirm('–û—Ç–º–µ—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ?')) return;

            const apiUrl = msgSource === 'container'
                ? '/api/container-messages/mark-read'
                : '/api/document-messages/mark-read-single';

            authFetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message_id: messageId })
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    // –£–±—Ä–∞—Ç—å –∫–ª–∞—Å—Å unread —Å –∫–∞—Ä—Ç–æ—á–∫–∏
                    const card = document.querySelector(`.message-card[data-message-id="${messageId}"][data-msg-source="${msgSource}"]`);
                    if (card) {
                        card.classList.remove('unread');
                        // –£–±—Ä–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ"
                        const readBtn = card.querySelector('.message-btn-read');
                        if (readBtn) readBtn.remove();
                    }
                    updateMessagesBadge();
                }
            })
            .catch(err => console.error('–û—à–∏–±–∫–∞:', err));
        }

        // –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
        function markAllMessagesRead() {
            if (!confirm('–û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ?')) return;

            authFetch('/api/document-messages/mark-all-read', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    loadAllMessages();
                    updateMessagesBadge();
                }
            })
            .catch(err => console.error('–û—à–∏–±–∫–∞:', err));
        }

        // –û—Ç–∫—Ä—ã—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
        function openDocumentFromMessage(docType, docId) {
            if (docType === 'finance_distribution' || docType === 'finance_plan_distribution') {
                // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –§–∏–Ω–∞–Ω—Å—ã ‚Üí –î–î–°, –æ—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏
                document.querySelector('[onclick*="finance"]')?.click();
                setTimeout(() => {
                    activateFinanceSubtab('finance-records');
                    setTimeout(() => {
                        editFinanceRecord(docId);
                    }, 300);
                }, 200);
            } else if (docType === 'receipt') {
                // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É –°–∫–ª–∞–¥ ‚Üí –û–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–µ
                document.querySelector('[onclick*="warehouse"]')?.click();
                setTimeout(() => {
                    document.querySelector('[onclick*="wh-receipts"]')?.click();
                    setTimeout(() => {
                        editReceiptDoc(docId);
                    }, 200);
                }, 200);
            } else if (docType === 'container') {
                // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É –í–≠–î ‚Üí –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
                document.querySelector('[onclick*="ved"]')?.click();
                setTimeout(() => {
                    activateVedSubtab('ved-containers');
                    setTimeout(() => {
                        editVedContainer(docId);
                    }, 300);
                }, 200);
            }
        }

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—Ç–≤–µ—Ç–∞
        let replyModalMessageId = null;
        let replyModalDocType = null;
        let replyModalDocId = null;
        let replyModalChatId = null;

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–≤–µ—Ç–∞
        function openReplyModal(messageId, originalText, docType, docId, chatId) {
            replyModalMessageId = messageId;
            replyModalDocType = docType;
            replyModalDocId = docId;
            replyModalChatId = chatId;

            document.getElementById('reply-original-text').textContent = originalText;
            document.getElementById('reply-textarea').value = '';
            document.getElementById('reply-modal').classList.add('active');
            document.getElementById('reply-textarea').focus();
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–≤–µ—Ç–∞
        function closeReplyModal() {
            document.getElementById('reply-modal').classList.remove('active');
            replyModalMessageId = null;
        }

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function sendReplyFromModal() {
            const message = document.getElementById('reply-textarea').value.trim();
            if (!message) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞');
                return;
            }

            const senderName = currentUser ? currentUser.username : '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';

            authFetch('/api/document-messages/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    doc_type: replyModalDocType,
                    doc_id: replyModalDocId,
                    message: message,
                    send_telegram: true,
                    sender_name: senderName
                })
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    closeReplyModal();
                    // –û—Ç–º–µ—Ç–∏—Ç—å –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ (–±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)
                    if (replyModalMessageId) {
                        markMessageRead(replyModalMessageId, true);
                    }
                    alert('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', err);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞');
            });
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏—Ö–æ–¥–æ–≤
        function loadReceiptHistory() {
            authFetch('/api/warehouse/receipt-docs')
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.docs && data.docs.length > 0) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –ø—Ä–∏—Ö–æ–¥—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                        allReceiptDocs = data.docs;
                        renderReceiptHistory(data.docs);
                        document.getElementById('receipt-history-wrapper').style.display = 'block';
                        document.getElementById('wh-receipt-history-empty').style.display = 'none';
                        // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                        populateReceiptProductFilter();
                    } else {
                        allReceiptDocs = [];
                        document.getElementById('receipt-history-wrapper').style.display = 'none';
                        document.getElementById('wh-receipt-history-empty').style.display = 'block';
                    }
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', err);
                    allReceiptDocs = [];
                    document.getElementById('receipt-history-wrapper').style.display = 'none';
                    document.getElementById('wh-receipt-history-empty').style.display = 'block';
                });
        }

        // –ó–∞–ø–æ–ª–Ω–∏—Ç—å –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–∏—Ö–æ–¥–æ–≤
        function populateReceiptProductFilter() {
            const select = document.getElementById('receipt-filter-product');
            if (!select) return;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            const currentValue = select.value;

            // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ SKU –∏–∑ –≤—Å–µ—Ö –ø—Ä–∏—Ö–æ–¥–æ–≤
            const skuSet = new Set();
            allReceiptDocs.forEach(doc => {
                if (doc.item_skus && Array.isArray(doc.item_skus)) {
                    doc.item_skus.forEach(sku => skuSet.add(sku));
                }
            });

            // –û—á–∏—â–∞–µ–º select –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é "–í—Å–µ –∞—Ä—Ç–∏–∫—É–ª—ã"
            select.innerHTML = '<option value="">–í—Å–µ –∞—Ä—Ç–∏–∫—É–ª—ã</option>';

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã –∏–∑ warehouseProducts, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ –ø—Ä–∏—Ö–æ–¥–∞—Ö
            const productsInReceipts = warehouseProducts.filter(p => skuSet.has(p.sku));
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É (–µ—Å–ª–∏ –µ—Å—Ç—å), –∏–Ω–∞—á–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
            productsInReceipts.sort((a, b) => {
                const aVal = a.offer_id || a.name || '';
                const bVal = b.offer_id || b.name || '';
                return aVal.localeCompare(bVal, 'en');
            });

            productsInReceipts.forEach(p => {
                const option = document.createElement('option');
                option.value = p.sku;
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞—Ä—Ç–∏–∫—É–ª, –µ—Å–ª–∏ –Ω–µ—Ç - –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
                option.textContent = p.offer_id || p.name || 'SKU: ' + p.sku;
                select.appendChild(option);
            });

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –≤—Å—ë –µ—â—ë –≤–∞–ª–∏–¥–Ω–æ
            if (currentValue && skuSet.has(parseInt(currentValue))) {
                select.value = currentValue;
            }
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏—Ö–æ–¥–æ–≤ –ø–æ –Ω–æ–º–µ—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–∞, –¥–∞—Ç–∞–º –∏ —Ç–æ–≤–∞—Ä—É
        function filterReceiptHistory() {
            const docNumFilter = document.getElementById('receipt-filter-docnum').value.trim();
            const dateFrom = document.getElementById('receipt-date-from').value;
            const dateTo = document.getElementById('receipt-date-to').value;
            const productFilter = document.getElementById('receipt-filter-product').value;

            if (!allReceiptDocs || allReceiptDocs.length === 0) return;

            const filtered = allReceiptDocs.filter(doc => {
                // –§–∏–ª—å—Ç—Ä –ø–æ –Ω–æ–º–µ—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–∞
                if (docNumFilter && String(doc.id) !== docNumFilter) return false;

                // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º (–∏—Å–ø–æ–ª—å–∑—É–µ–º receipt_date)
                const docDate = doc.receipt_date || '';

                if (dateFrom && docDate < dateFrom) return false;
                if (dateTo && docDate > dateTo) return false;

                // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–æ–≤–∞—Ä—É (–ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π SKU –≤ —Å–ø–∏—Å–∫–µ —Ç–æ–≤–∞—Ä–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞)
                if (productFilter) {
                    const productSku = parseInt(productFilter);
                    if (!doc.item_skus || !doc.item_skus.includes(productSku)) return false;
                }

                return true;
            });

            if (filtered.length > 0) {
                renderReceiptHistory(filtered);
                document.getElementById('receipt-history-wrapper').style.display = 'block';
                document.getElementById('wh-receipt-history-empty').style.display = 'none';
            } else {
                document.getElementById('wh-receipt-history-tbody').innerHTML = '';
                document.getElementById('receipt-history-wrapper').style.display = 'block';
                document.getElementById('wh-receipt-history-empty').style.display = 'block';
                document.getElementById('wh-receipt-history-empty').querySelector('p').textContent = '–ù–µ—Ç –ø—Ä–∏—Ö–æ–¥–æ–≤ –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º';
            }
        }

        // –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã
        function resetReceiptDateFilter() {
            document.getElementById('receipt-filter-docnum').value = '';
            document.getElementById('receipt-date-from').value = '';
            document.getElementById('receipt-date-to').value = '';
            document.getElementById('receipt-filter-product').value = '';

            if (allReceiptDocs && allReceiptDocs.length > 0) {
                renderReceiptHistory(allReceiptDocs);
                document.getElementById('receipt-history-wrapper').style.display = 'block';
                document.getElementById('wh-receipt-history-empty').style.display = 'none';
                document.getElementById('wh-receipt-history-empty').querySelector('p').textContent = '–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–∏—Ö–æ–¥–æ–≤';
            }
        }

        // ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (null = –Ω–æ–≤—ã–π –ø—Ä–∏—Ö–æ–¥)
        let editingDocId = null;

        // –•—Ä–∞–Ω–∏–ª–∏—â–µ –≤—Å–µ—Ö –ø—Ä–∏—Ö–æ–¥–æ–≤ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        let allReceiptDocs = [];

        // –ö—ç—à –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –¥–ª—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏—Ö–æ–¥–æ–≤
        let receiptDistCache = {};

        // –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏—Ö–æ–¥–æ–≤
        function renderReceiptHistory(docs) {
            const tbody = document.getElementById('wh-receipt-history-tbody');
            tbody.innerHTML = '';
            receiptDistCache = {};  // –û—á–∏—â–∞–µ–º –∫—ç—à —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –ø—Ä–∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–µ

            docs.forEach(doc => {
                const row = document.createElement('tr');
                row.className = 'wh-receipt-row';
                row.id = 'wh-receipt-row-' + doc.id;
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞—Ç—É –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (—Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD)
                row.dataset.date = doc.receipt_date || '';
                row.onclick = function() { toggleReceiptAccordion(doc.id); };
                row.ondblclick = function() { editReceiptDoc(doc.id); };

                // –ë–ª–µ–¥–Ω–æ-–∫—Ä–∞—Å–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
                if (doc.has_undistributed) {
                    row.classList.add('has-undistributed');
                }

                // ‚Ññ –ø—Ä–∏—Ö–æ–¥–∞ (—Å–æ —Å—Ç—Ä–µ–ª–∫–æ–π –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞)
                const tdNum = document.createElement('td');
                tdNum.style.textAlign = 'center';
                tdNum.style.fontWeight = '600';
                tdNum.style.color = '#667eea';
                tdNum.innerHTML = '<span class="wh-receipt-arrow">&#9654;</span>' + doc.id;
                row.appendChild(tdNum);

                // –î–∞—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∞ (—Ç–æ–ª—å–∫–æ –¥–∞—Ç–∞, –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏)
                const tdReceiptDate = document.createElement('td');
                if (doc.receipt_date) {
                    const rd = new Date(doc.receipt_date);
                    tdReceiptDate.textContent = rd.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
                } else {
                    tdReceiptDate.textContent = '‚Äî';
                }
                row.appendChild(tdReceiptDate);

                // –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è, —Å –≤—Ä–µ–º–µ–Ω–µ–º)
                const tdCreatedAt = document.createElement('td');
                if (doc.created_at) {
                    const ca = new Date(doc.created_at);
                    tdCreatedAt.textContent = ca.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                } else {
                    tdCreatedAt.textContent = '‚Äî';
                }
                row.appendChild(tdCreatedAt);

                // –ü—Ä–∏—ë–º—â–∏–∫
                const tdReceiver = document.createElement('td');
                tdReceiver.textContent = doc.receiver_name || '‚Äî';
                row.appendChild(tdReceiver);

                // –ö–æ–ª-–≤–æ —Ç–æ–≤–∞—Ä–æ–≤
                const tdItems = document.createElement('td');
                tdItems.style.textAlign = 'center';
                tdItems.textContent = doc.items_count || 0;
                row.appendChild(tdItems);

                // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                const tdQty = document.createElement('td');
                tdQty.style.textAlign = 'center';
                tdQty.textContent = doc.total_qty || 0;
                row.appendChild(tdQty);

                // –°—É–º–º–∞ –ø–æ –ø–æ—Å—Ç–∞–≤–∫–∞–º (—Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å)
                const tdSum = document.createElement('td');
                tdSum.style.textAlign = 'right';
                const calcCost = doc.total_calculated_cost || 0;
                if (calcCost > 0) {
                    tdSum.textContent = formatNumberWithSpaces(Math.round(calcCost)) + ' ‚ÇΩ';
                    tdSum.title = '–†–∞—Å—Å—á–∏—Ç–∞–Ω–æ –∏–∑ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ +6% –ø–æ –ø–æ—Å—Ç–∞–≤–∫–∞–º';
                } else if (doc.total_sum > 0) {
                    tdSum.textContent = formatNumberWithSpaces(Math.round(doc.total_sum)) + ' ‚ÇΩ';
                    tdSum.style.color = '#999';
                    tdSum.title = '–†—É—á–Ω–æ–π –≤–≤–æ–¥ (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–æ—Å—Ç–∞–≤–æ–∫)';
                } else {
                    tdSum.textContent = '‚Äî';
                }
                row.appendChild(tdSum);

                // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                const tdComment = document.createElement('td');
                tdComment.textContent = doc.comment || '';
                row.appendChild(tdComment);

                // –ò–∑–º–µ–Ω–µ–Ω–æ (–¥–∞—Ç–∞/–≤—Ä–µ–º—è –∏ –∫—Ç–æ –∏–∑–º–µ–Ω–∏–ª)
                const tdUpdated = document.createElement('td');
                if (doc.updated_at && doc.updated_by) {
                    const updDt = new Date(doc.updated_at);
                    const updStr = updDt.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                    tdUpdated.innerHTML = `<span style="color:#666;">${updStr}</span><br><span style="font-size:12px;">${doc.updated_by}</span>`;
                } else {
                    tdUpdated.textContent = '‚Äî';
                }
                row.appendChild(tdUpdated);

                // –ò—Å—Ç–æ—á–Ω–∏–∫ (web –∏–ª–∏ telegram)
                const tdSource = document.createElement('td');
                tdSource.style.textAlign = 'center';
                if (doc.source === 'telegram') {
                    tdSource.innerHTML = '<span style="background:#e3f2fd;color:#1976d2;padding:2px 8px;border-radius:12px;font-size:12px;">üì± TG</span>';
                } else {
                    tdSource.innerHTML = '<span style="background:#f5f5f5;color:#666;padding:2px 8px;border-radius:12px;font-size:12px;">üíª Web</span>';
                }
                row.appendChild(tdSource);

                // –î–µ–π—Å—Ç–≤–∏—è (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å + —É–¥–∞–ª–∏—Ç—å)
                const tdActions = document.createElement('td');
                tdActions.style.whiteSpace = 'nowrap';

                // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –¥–≤–æ–π–Ω–æ–º—É –∫–ª–∏–∫—É –Ω–∞ —Å—Ç—Ä–æ–∫–µ (row.ondblclick)

                // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (stopPropagation —á—Ç–æ–±—ã –Ω–µ —Ç–æ–≥–≥–ª–∏—Ç—å –∞–∫–∫–æ—Ä–¥–µ–æ–Ω)
                const delBtn = document.createElement('button');
                delBtn.className = 'wh-delete-btn';
                delBtn.textContent = '‚úï';
                delBtn.title = '–£–¥–∞–ª–∏—Ç—å';
                delBtn.onclick = (e) => { e.stopPropagation(); deleteReceiptDoc(doc.id); };
                tdActions.appendChild(delBtn);

                row.appendChild(tdActions);

                tbody.appendChild(row);

                // –°—Ç—Ä–æ–∫–∞-–∞–∫–∫–æ—Ä–¥–µ–æ–Ω —Å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è–º–∏ –ø–æ –ø–æ—Å—Ç–∞–≤–∫–∞–º (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
                const accordionRow = document.createElement('tr');
                accordionRow.className = 'wh-receipt-accordion';
                accordionRow.id = 'wh-receipt-accordion-' + doc.id;
                accordionRow.innerHTML = '<td colspan="11" class="wh-receipt-accordion-cell">' +
                    '<div class="wh-receipt-accordion-content" id="wh-receipt-dist-content-' + doc.id + '">' +
                    '<div class="wh-accordion-loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π...</div>' +
                    '</div></td>';
                tbody.appendChild(accordionRow);
            });
        }

        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∞–∫–∫–æ—Ä–¥–µ–æ–Ω —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∞.
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏, –∫—ç—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
         */
        async function toggleReceiptAccordion(docId) {
            const row = document.getElementById('wh-receipt-row-' + docId);
            const accordion = document.getElementById('wh-receipt-accordion-' + docId);
            const content = document.getElementById('wh-receipt-dist-content-' + docId);

            if (!row || !accordion) return;

            const isExpanded = row.classList.contains('expanded');

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω—ã –ø—Ä–∏—Ö–æ–¥–æ–≤
            document.querySelectorAll('.wh-receipt-row.expanded').forEach(r => {
                r.classList.remove('expanded');
            });
            document.querySelectorAll('.wh-receipt-accordion.visible').forEach(a => {
                a.classList.remove('visible');
            });

            if (isExpanded) {
                return;
            }

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π
            row.classList.add('expanded');
            accordion.classList.add('visible');

            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à
            if (receiptDistCache[docId]) {
                renderReceiptDistContent(docId, receiptDistCache[docId]);
                return;
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
            content.innerHTML = '<div class="wh-accordion-loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π...</div>';

            try {
                const response = await authFetch('/api/warehouse/receipt-docs/' + docId + '/distributions');
                const data = await response.json();

                if (data.success) {
                    receiptDistCache[docId] = data.items;
                    renderReceiptDistContent(docId, data.items);
                } else {
                    content.innerHTML = '<div class="wh-accordion-empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è') + '</div>';
                }
            } catch (err) {
                content.innerHTML = '<div class="wh-accordion-empty">–û—à–∏–±–∫–∞: ' + err.message + '</div>';
            }
        }

        /**
         * –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ —Å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è–º–∏ –ø–æ –ø–æ—Å—Ç–∞–≤–∫–∞–º.
         * –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ (SKU) –≤ –ø—Ä–∏—Ö–æ–¥–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
         * - –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Ç–æ–≤–∞—Ä–∞ –∏ —Å—Ç–∞—Ç—É—Å–æ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
         * - –¢–∞–±–ª–∏—Ü—É —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π: –ø–æ—Å—Ç–∞–≤–∫–∞, –¥–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∫–æ–ª-–≤–æ, —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å
         */
        function renderReceiptDistContent(docId, items) {
            const content = document.getElementById('wh-receipt-dist-content-' + docId);
            if (!content) return;

            if (!items || items.length === 0) {
                content.innerHTML = '<div class="wh-accordion-empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏</div>';
                return;
            }

            let html = '';

            items.forEach(item => {
                const displayName = item.offer_id ? item.offer_id : (item.product_name || 'SKU ' + item.sku);
                const isFullyDistributed = item.undistributed <= 0;
                const badgeClass = isFullyDistributed ? 'wh-dist-badge-full' : 'wh-dist-badge-partial';
                const badgeText = isFullyDistributed
                    ? '\u2713 –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ: ' + item.total_distributed + '/' + item.receipt_qty
                    : '\u26A0 –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ: ' + item.total_distributed + '/' + item.receipt_qty +
                      ' (–Ω–µ —Ä–∞—Å–ø—Ä: ' + item.undistributed + ')';

                html += '<div class="wh-dist-product-block">';
                html += '<div class="wh-dist-product-header">';
                html += '<span>' + displayName + ' (SKU: ' + item.sku + ')</span>';
                html += '<span class="' + badgeClass + '">' + badgeText + '</span>';
                html += '</div>';

                if (item.distributions && item.distributions.length > 0) {
                    html += '<table class="wh-accordion-table" style="font-size: 12px;">';
                    html += '<thead><tr>';
                    html += '<th style="padding: 6px 8px;">–ü–æ—Å—Ç–∞–≤–∫–∞</th>';
                    html += '<th style="padding: 6px 8px;">–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞</th>';
                    html += '<th style="padding: 6px 8px;">–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä</th>';
                    html += '<th style="padding: 6px 8px;">–ö–æ–ª-–≤–æ</th>';
                    html += '<th style="padding: 6px 8px;">–°–µ–±–µ—Å—Ç. +6%</th>';
                    html += '<th style="padding: 6px 8px;">–°—É–º–º–∞</th>';
                    html += '</tr></thead>';
                    html += '<tbody>';

                    let totalDistQty = 0;
                    let totalDistSum = 0;

                    item.distributions.forEach(d => {
                        let exitDate = '\u2014';
                        if (d.exit_factory_date) {
                            try {
                                const dt = new Date(d.exit_factory_date);
                                exitDate = dt.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
                            } catch(e) { exitDate = d.exit_factory_date; }
                        }

                        const containerInfo = d.container_doc_id
                            ? ('–ö–æ–Ω—Ç. #' + d.container_doc_id + (d.container_supplier ? ' (' + d.container_supplier + ')' : ''))
                            : '\u2014';
                        const lineSum = d.quantity * d.cost_plus_6;
                        totalDistQty += d.quantity;
                        totalDistSum += lineSum;

                        html += '<tr>';
                        html += '<td style="color: #667eea; font-weight: 600; padding: 4px 8px;">ID ' + d.supply_id + '</td>';
                        html += '<td style="padding: 4px 8px;">' + exitDate + '</td>';
                        html += '<td style="padding: 4px 8px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="' + containerInfo + '">' + containerInfo + '</td>';
                        html += '<td style="color: #16a34a; font-weight: 600; padding: 4px 8px;">' + d.quantity + '</td>';
                        html += '<td style="padding: 4px 8px;">' + formatNumberWithSpaces(Math.round(d.cost_plus_6)) + ' \u20BD</td>';
                        html += '<td style="padding: 4px 8px; font-weight: 500;">' + formatNumberWithSpaces(Math.round(lineSum)) + ' \u20BD</td>';
                        html += '</tr>';
                    });

                    html += '</tbody>';
                    html += '<tfoot><tr>';
                    html += '<td colspan="3" style="padding: 6px 8px; text-align: right;"><strong>–ò—Ç–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥.:</strong></td>';
                    html += '<td style="color: #16a34a; font-weight: 700; padding: 6px 8px;">' + totalDistQty + '</td>';
                    html += '<td></td>';
                    html += '<td style="font-weight: 700; padding: 6px 8px;">' + formatNumberWithSpaces(Math.round(totalDistSum)) + ' \u20BD</td>';
                    html += '</tr></tfoot>';
                    html += '</table>';
                } else {
                    html += '<div class="wh-accordion-empty" style="padding: 8px; font-size: 12px; font-style: italic;">–ù–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –ø–æ –ø–æ—Å—Ç–∞–≤–∫–∞–º</div>';
                }

                html += '</div>';
            });

            content.innerHTML = html;
        }

        // –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏—Ö–æ–¥ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function editReceiptDoc(docId) {
            authFetch('/api/warehouse/receipt-docs/' + docId)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                        editingDocId = docId;

                        // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞—Ç—É –ø—Ä–∏—Ö–æ–¥–∞
                        if (data.doc.receipt_date) {
                            // –§–æ—Ä–º–∞—Ç –∏–∑ –ë–î: YYYY-MM-DD
                            document.getElementById('receipt-date').value = data.doc.receipt_date.substring(0, 10);
                        }

                        // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–º—è –ø—Ä–∏—ë–º—â–∏–∫–∞
                        document.getElementById('receipt-receiver').value = data.doc.receiver_name || '';

                        // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                        document.getElementById('receipt-comment').value = data.doc.comment || '';

                        // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Ç–æ–≤–∞—Ä–æ–≤
                        const tbody = document.getElementById('wh-receipt-items-tbody');
                        tbody.innerHTML = '';
                        receiptItemCounter = 0;

                        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
                        data.items.forEach(item => {
                            addReceiptItemRowWithData(item);
                        });

                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏
                        updateReceiptTotals();

                        // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
                        document.querySelector('#receipt-form .wh-save-receipt-btn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';

                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —á–∞—Ç–∞ –µ—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –∏–∑ Telegram
                        if (data.doc.source === 'telegram' && data.doc.telegram_chat_id) {
                            showChatSection(true, docId);
                        } else {
                            showChatSection(false);
                        }

                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∏ —Å–∫—Ä–æ–ª–ª–∏–º –∫ –Ω–µ–π
                        showReceiptForm();
                    } else {
                        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                })
                .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏—Ö–æ–¥–∞:', err));
        }

        // –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É —Ç–æ–≤–∞—Ä–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ (–¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        function addReceiptItemRowWithData(item) {
            const tbody = document.getElementById('wh-receipt-items-tbody');
            receiptItemCounter++;

            const row = document.createElement('tr');
            row.dataset.itemId = 'item_' + receiptItemCounter;

            // ‚Ññ –ø/–ø
            const tdNum = document.createElement('td');
            tdNum.style.textAlign = 'center';
            tdNum.textContent = tbody.children.length + 1;
            row.appendChild(tdNum);

            // –¢–æ–≤–∞—Ä (–≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫)
            const tdProduct = document.createElement('td');
            const selectProduct = document.createElement('select');
            selectProduct.className = 'wh-select';
            selectProduct.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä ‚Äî</option>';
            warehouseProducts.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.sku;
                opt.textContent = p.offer_id || p.sku;
                if (item && item.sku == p.sku) opt.selected = true;
                selectProduct.appendChild(opt);
            });
            tdProduct.appendChild(selectProduct);
            row.appendChild(tdProduct);

            // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
            const tdQty = document.createElement('td');
            const inputQty = document.createElement('input');
            inputQty.type = 'text';
            inputQty.className = 'wh-input';
            inputQty.style.cssText = 'width:100%;text-align:center;';
            inputQty.value = item ? item.quantity : '';
            inputQty.oninput = function() {
                this.value = this.value.replace(/[^0-9]/g, '');
                updateReceiptItemSum(row);
                updateReceiptTotals();
            };
            tdQty.appendChild(inputQty);
            row.appendChild(tdQty);

            // –¶–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏ (—Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑ –ø–æ—Å—Ç–∞–≤–æ–∫)
            const tdPrice = document.createElement('td');
            const inputPrice = document.createElement('input');
            inputPrice.type = 'text';
            inputPrice.className = 'wh-input';
            inputPrice.style.cssText = 'width:100%;text-align:right;background:#f5f5f5;color:#666;';
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º calculated_cost –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ purchase_price
            const displayPrice = item ? (item.calculated_cost || item.purchase_price || 0) : 0;
            inputPrice.value = displayPrice > 0 ? formatNumberWithSpaces(Math.round(displayPrice)) : '';
            inputPrice.disabled = true;  // –ü–æ–ª–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            inputPrice.title = '–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å +6% —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑ –ø–æ—Å—Ç–∞–≤–æ–∫';
            tdPrice.appendChild(inputPrice);
            row.appendChild(tdPrice);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã —Ç–æ–≤–∞—Ä–∞ - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã –∏–∑ –ø–æ—Å—Ç–∞–≤–æ–∫
            selectProduct.onchange = function() {
                const selectedSku = this.value;
                if (selectedSku && suppliesCostBySku[selectedSku]) {
                    inputPrice.value = formatNumberWithSpaces(suppliesCostBySku[selectedSku]);
                } else {
                    inputPrice.value = '(–∞–≤—Ç–æ)';
                    inputPrice.style.color = '#999';
                }
                updateReceiptItemSum(row);
                updateReceiptTotals();
            };

            // –°—É–º–º–∞ (—Ä–∞—Å—á—ë—Ç–Ω–æ–µ –ø–æ–ª–µ)
            const tdSum = document.createElement('td');
            tdSum.className = 'wh-sum-cell';
            tdSum.style.textAlign = 'right';
            const qty = item ? (parseInt(item.quantity) || 0) : 0;
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º calculated_cost –µ—Å–ª–∏ –µ—Å—Ç—å
            const costPrice = item ? (item.calculated_cost || item.purchase_price || 0) : 0;
            tdSum.textContent = qty * costPrice > 0 ? formatNumberWithSpaces(Math.round(qty * costPrice)) + ' ‚ÇΩ' : '‚Äî';
            row.appendChild(tdSum);

            // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
            const tdDel = document.createElement('td');
            const delBtn = document.createElement('button');
            delBtn.className = 'wh-delete-btn';
            delBtn.textContent = '‚úï';
            delBtn.onclick = () => removeReceiptItemRow(row);
            tdDel.appendChild(delBtn);
            row.appendChild(tdDel);

            tbody.appendChild(row);
            updateRowNumbers();
        }

        // –£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–∏—Ö–æ–¥–∞ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–≤–æ–¥ —Å–ª–æ–≤–∞ "—É–¥–∞–ª–∏—Ç—å")
        function deleteReceiptDoc(docId) {
            const confirmation = prompt('–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ "—É–¥–∞–ª–∏—Ç—å":');
            if (confirmation === null) return; // –û—Ç–º–µ–Ω–∞
            if (confirmation.toLowerCase().trim() !== '—É–¥–∞–ª–∏—Ç—å') {
                alert('–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ. –í—ã –≤–≤–µ–ª–∏ –Ω–µ–≤–µ—Ä–Ω–æ–µ —Å–ª–æ–≤–æ.');
                return;
            }

            authFetch('/api/warehouse/receipt-docs/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: docId })
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    loadReceiptHistory();
                    loadWarehouseStock();
                } else {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch(err => console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', err));
        }

        // ============================================================
        // –û–¢–ì–†–£–ó–ö–ò ‚Äî –î–û–ö–£–ú–ï–ù–¢-–§–û–†–ú–ê–¢
        // ============================================================

        let shipmentItemCounter = 0;
        let editingShipmentDocId = null;
        let shipmentDestinations = [];

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ –ë–î
        function loadDestinations() {
            authFetch('/api/warehouse/destinations')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        shipmentDestinations = data.destinations;
                        renderDestinationDropdown();
                    }
                })
                .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π:', err));
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å dropdown —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π
        function renderDestinationDropdown(filter = '') {
            const dropdown = document.getElementById('destination-dropdown');
            if (!dropdown) return;

            const filterLower = filter.toLowerCase();
            const filtered = filter
                ? shipmentDestinations.filter(d => d.name.toLowerCase().includes(filterLower))
                : shipmentDestinations;

            dropdown.innerHTML = '';
            filtered.forEach(d => {
                const item = document.createElement('div');
                item.className = 'destination-dropdown-item';
                item.textContent = d.name;
                item.onclick = () => selectDestination(d.name);
                dropdown.appendChild(item);
            });

            if (filtered.length === 0 && filter) {
                const item = document.createElement('div');
                item.className = 'destination-dropdown-item';
                item.style.color = '#999';
                item.textContent = '–ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å "' + filter + '"';
                dropdown.appendChild(item);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å dropdown
        function toggleDestinationDropdown() {
            const dropdown = document.getElementById('destination-dropdown');
            const input = document.getElementById('shipment-destination');
            if (!dropdown) return;

            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
            } else {
                renderDestinationDropdown(input.value);
                dropdown.classList.add('show');
            }
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ
        function filterDestinations() {
            const dropdown = document.getElementById('destination-dropdown');
            const input = document.getElementById('shipment-destination');
            if (!dropdown) return;

            renderDestinationDropdown(input.value);
            dropdown.classList.add('show');
        }

        // –í—ã–±—Ä–∞—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
        function selectDestination(name) {
            const input = document.getElementById('shipment-destination');
            const dropdown = document.getElementById('destination-dropdown');
            input.value = name;
            dropdown.classList.remove('show');
        }

        // –ó–∞–∫—Ä—ã—Ç—å dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
        document.addEventListener('click', function(e) {
            const wrapper = document.querySelector('.destination-dropdown-wrapper');
            const dropdown = document.getElementById('destination-dropdown');
            if (wrapper && dropdown && !wrapper.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫
        function addNewDestination() {
            const input = document.getElementById('shipment-destination');
            const name = (input.value || '').trim();

            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
            if (shipmentDestinations.some(d => d.name.toLowerCase() === name.toLowerCase())) {
                alert('–¢–∞–∫–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ');
                return;
            }

            authFetch('/api/warehouse/destinations/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    shipmentDestinations.push({ id: data.id, name: name, is_default: false });
                    renderDestinationDropdown();
                    alert('–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ "' + name + '" –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Å–ø–∏—Å–æ–∫');
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', err);
                alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è');
            });
        }

        function initShipmentForm() {
            loadDestinations();
            addShipmentItemRow();
        }

        function loadWarehouseShipments() {
            loadShipmentHistory();
            // initShipmentForm –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –≤ loadWarehouse()
        }

        function addShipmentItemRow() {
            const tbody = document.getElementById('wh-shipment-items-tbody');
            shipmentItemCounter++;

            const row = document.createElement('tr');
            row.dataset.itemId = 'ship_item_' + shipmentItemCounter;

            const tdNum = document.createElement('td');
            tdNum.style.textAlign = 'center';
            tdNum.textContent = tbody.children.length + 1;
            row.appendChild(tdNum);

            const tdProduct = document.createElement('td');
            const selectProduct = document.createElement('select');
            selectProduct.className = 'wh-select';
            selectProduct.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä ‚Äî</option>';
            warehouseProducts.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.sku;
                opt.textContent = p.offer_id || p.sku;
                selectProduct.appendChild(opt);
            });
            tdProduct.appendChild(selectProduct);
            row.appendChild(tdProduct);

            const tdQty = document.createElement('td');
            const inputQty = document.createElement('input');
            inputQty.type = 'text';
            inputQty.className = 'wh-input';
            inputQty.style.cssText = 'width:100%;text-align:center;';
            inputQty.placeholder = '0';
            inputQty.oninput = function() {
                this.value = this.value.replace(/[^0-9]/g, '');
                updateShipmentTotals();
            };
            tdQty.appendChild(inputQty);
            row.appendChild(tdQty);

            const tdDel = document.createElement('td');
            const delBtn = document.createElement('button');
            delBtn.className = 'wh-delete-btn';
            delBtn.textContent = '‚úï';
            delBtn.onclick = () => removeShipmentItemRow(row);
            tdDel.appendChild(delBtn);
            row.appendChild(tdDel);

            tbody.appendChild(row);
            updateShipmentRowNumbers();
        }

        function addShipmentItemRowWithData(item) {
            const tbody = document.getElementById('wh-shipment-items-tbody');
            shipmentItemCounter++;

            const row = document.createElement('tr');
            row.dataset.itemId = 'ship_item_' + shipmentItemCounter;

            const tdNum = document.createElement('td');
            tdNum.style.textAlign = 'center';
            tdNum.textContent = tbody.children.length + 1;
            row.appendChild(tdNum);

            const tdProduct = document.createElement('td');
            const selectProduct = document.createElement('select');
            selectProduct.className = 'wh-select';
            selectProduct.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä ‚Äî</option>';
            warehouseProducts.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.sku;
                opt.textContent = p.offer_id || p.sku;
                if (item && item.sku == p.sku) opt.selected = true;
                selectProduct.appendChild(opt);
            });
            tdProduct.appendChild(selectProduct);
            row.appendChild(tdProduct);

            const tdQty = document.createElement('td');
            const inputQty = document.createElement('input');
            inputQty.type = 'text';
            inputQty.className = 'wh-input';
            inputQty.style.cssText = 'width:100%;text-align:center;';
            inputQty.value = item ? item.quantity : '';
            inputQty.oninput = function() {
                this.value = this.value.replace(/[^0-9]/g, '');
                updateShipmentTotals();
            };
            tdQty.appendChild(inputQty);
            row.appendChild(tdQty);

            const tdDel = document.createElement('td');
            const delBtn = document.createElement('button');
            delBtn.className = 'wh-delete-btn';
            delBtn.textContent = '‚úï';
            delBtn.onclick = () => removeShipmentItemRow(row);
            tdDel.appendChild(delBtn);
            row.appendChild(tdDel);

            tbody.appendChild(row);
            updateShipmentRowNumbers();
        }

        function removeShipmentItemRow(row) {
            const tbody = document.getElementById('wh-shipment-items-tbody');
            if (tbody.children.length <= 1) {
                alert('–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Ç–æ–≤–∞—Ä–∞');
                return;
            }
            row.remove();
            updateShipmentRowNumbers();
            updateShipmentTotals();
        }

        function updateShipmentRowNumbers() {
            const rows = document.querySelectorAll('#wh-shipment-items-tbody tr');
            rows.forEach((row, idx) => { row.cells[0].textContent = idx + 1; });
        }

        function updateShipmentTotals() {
            const rows = document.querySelectorAll('#wh-shipment-items-tbody tr');
            let totalQty = 0;
            rows.forEach(row => {
                const input = row.querySelector('input[type="text"]');
                totalQty += parseInt((input?.value || '').replace(/\s/g, '')) || 0;
            });
            document.getElementById('shipment-total-qty').textContent = totalQty;
        }

        function saveShipment() {
            const destination = document.getElementById('shipment-destination').value;
            const comment = document.getElementById('shipment-comment').value;
            const isCompleted = document.getElementById('shipment-completed').checked;
            const rows = document.querySelectorAll('#wh-shipment-items-tbody tr');
            const items = [];

            rows.forEach(row => {
                const select = row.querySelector('select');
                const input = row.querySelector('input[type="text"]');
                const sku = parseInt(select?.value) || 0;
                const qty = parseInt((input?.value || '').replace(/\s/g, '')) || 0;
                if (sku > 0 && qty > 0) items.push({ sku, quantity: qty });
            });

            if (items.length === 0) {
                alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º');
                return;
            }

            const isEdit = !!editingShipmentDocId;

            authFetch('/api/warehouse/shipments/save-doc', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ doc_id: editingShipmentDocId, destination, comment, items, is_completed: isCompleted })
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    alert(isEdit ? '–û—Ç–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!' : '–û—Ç–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
                    clearShipmentForm();
                    hideShipmentForm();
                    loadShipmentHistory();
                    loadWarehouseStock();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch(err => console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', err));
        }

        function clearShipmentForm() {
            editingShipmentDocId = null;
            document.getElementById('shipment-destination').value = '';
            document.getElementById('shipment-comment').value = '';
            document.getElementById('shipment-completed').checked = true;  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–æ–≤–µ–¥–µ–Ω–æ
            document.getElementById('wh-shipment-items-tbody').innerHTML = '';
            shipmentItemCounter = 0;
            addShipmentItemRow();
            updateShipmentTotals();
            document.querySelector('.wh-save-shipment-btn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≥—Ä—É–∑–∫—É';
        }

        /**
         * –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≥—Ä—É–∑–∫–∏
         */
        function showShipmentForm() {
            document.getElementById('shipment-form').style.display = 'block';
            document.getElementById('shipment-create-btn-wrapper').style.display = 'none';
            document.getElementById('shipment-form').scrollIntoView({ behavior: 'smooth' });
        }

        /**
         * –°–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≥—Ä—É–∑–∫–∏
         */
        function hideShipmentForm() {
            document.getElementById('shipment-form').style.display = 'none';
            document.getElementById('shipment-create-btn-wrapper').style.display = 'block';
        }

        /**
         * –û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≥—Ä—É–∑–∫–∏ (—Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
         */
        function cancelShipment() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å? –í—Å–µ –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
                return;
            }
            clearShipmentForm();
            hideShipmentForm();
        }

        // –•—Ä–∞–Ω–∏–ª–∏—â–µ –≤—Å–µ—Ö –æ—Ç–≥—Ä—É–∑–æ–∫ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        let allShipmentDocs = [];

        function loadShipmentHistory() {
            authFetch('/api/warehouse/shipment-docs')
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.docs && data.docs.length > 0) {
                        allShipmentDocs = data.docs;
                        renderShipmentHistory(data.docs);
                        document.getElementById('shipment-history-wrapper').style.display = 'block';
                        document.getElementById('wh-shipment-history-empty').style.display = 'none';
                    } else {
                        allShipmentDocs = [];
                        document.getElementById('shipment-history-wrapper').style.display = 'none';
                        document.getElementById('wh-shipment-history-empty').style.display = 'block';
                    }
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', err);
                    allShipmentDocs = [];
                    document.getElementById('shipment-history-wrapper').style.display = 'none';
                    document.getElementById('wh-shipment-history-empty').style.display = 'block';
                });
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç–≥—Ä—É–∑–æ–∫ –ø–æ –Ω–æ–º–µ—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –¥–∞—Ç–∞–º
        function filterShipmentHistory() {
            const docNumFilter = document.getElementById('shipment-filter-docnum').value.trim();
            const dateFrom = document.getElementById('shipment-date-from').value;
            const dateTo = document.getElementById('shipment-date-to').value;

            if (!allShipmentDocs || allShipmentDocs.length === 0) return;

            const filtered = allShipmentDocs.filter(doc => {
                // –§–∏–ª—å—Ç—Ä –ø–æ –Ω–æ–º–µ—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–∞
                if (docNumFilter && String(doc.id) !== docNumFilter) return false;

                // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º
                const dt = new Date(doc.shipment_datetime);
                const docDate = dt.toISOString().split('T')[0]; // YYYY-MM-DD

                if (dateFrom && docDate < dateFrom) return false;
                if (dateTo && docDate > dateTo) return false;
                return true;
            });

            if (filtered.length > 0) {
                renderShipmentHistory(filtered);
                document.getElementById('shipment-history-wrapper').style.display = 'block';
                document.getElementById('wh-shipment-history-empty').style.display = 'none';
            } else {
                document.getElementById('wh-shipment-history-tbody').innerHTML = '';
                document.getElementById('shipment-history-wrapper').style.display = 'block';
                document.getElementById('wh-shipment-history-empty').style.display = 'block';
                document.getElementById('wh-shipment-history-empty').querySelector('p').textContent = '–ù–µ—Ç –æ—Ç–≥—Ä—É–∑–æ–∫ –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º';
            }
        }

        // –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –æ—Ç–≥—Ä—É–∑–æ–∫
        function resetShipmentDateFilter() {
            document.getElementById('shipment-filter-docnum').value = '';
            document.getElementById('shipment-date-from').value = '';
            document.getElementById('shipment-date-to').value = '';

            if (allShipmentDocs && allShipmentDocs.length > 0) {
                renderShipmentHistory(allShipmentDocs);
                document.getElementById('shipment-history-wrapper').style.display = 'block';
                document.getElementById('wh-shipment-history-empty').style.display = 'none';
                document.getElementById('wh-shipment-history-empty').querySelector('p').textContent = '–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –æ—Ç–≥—Ä—É–∑–æ–∫';
            }
        }

        function renderShipmentHistory(docs) {
            const tbody = document.getElementById('wh-shipment-history-tbody');
            tbody.innerHTML = '';
            const destLabels = { 'FBO': 'FBO (Ozon)', 'FBS': 'FBS', 'RETURN': '–í–æ–∑–≤—Ä–∞—Ç', 'OTHER': '–î—Ä—É–≥–æ–µ' };

            docs.forEach(doc => {
                const row = document.createElement('tr');
                row.dataset.docId = doc.id; // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                row.style.cursor = 'pointer';
                row.ondblclick = function() { editShipmentDoc(doc.id); };

                // ‚Ññ –æ—Ç–≥—Ä—É–∑–∫–∏
                const tdNum = document.createElement('td');
                tdNum.style.textAlign = 'center';
                tdNum.style.fontWeight = '600';
                tdNum.style.color = '#667eea';
                tdNum.textContent = doc.id;
                row.appendChild(tdNum);

                const tdDate = document.createElement('td');
                const dt = new Date(doc.shipment_datetime);
                row.dataset.date = doc.shipment_datetime.split('T')[0]; // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –¥–∞—Ç–µ
                tdDate.textContent = dt.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                row.appendChild(tdDate);

                const tdDest = document.createElement('td');
                tdDest.textContent = destLabels[doc.destination] || doc.destination || '‚Äî';
                row.appendChild(tdDest);

                // –°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∏–∑–º–µ–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
                const tdCompleted = document.createElement('td');
                tdCompleted.style.textAlign = 'center';
                const isCompleted = doc.is_completed === 1 || doc.is_completed === true;
                const statusBadge = document.createElement('span');
                statusBadge.className = 'shipment-status-badge ' + (isCompleted ? 'completed' : 'pending');
                statusBadge.innerHTML = isCompleted ? '‚úì –ü—Ä–æ–≤–µ–¥–µ–Ω–æ' : '‚ó∑ –û–∂–∏–¥–∞–µ—Ç';
                statusBadge.style.cursor = 'default';
                statusBadge.title = '–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –º–æ–∂–Ω–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è';
                tdCompleted.appendChild(statusBadge);
                row.appendChild(tdCompleted);

                const tdItems = document.createElement('td');
                tdItems.style.textAlign = 'center';
                tdItems.textContent = doc.items_count || 0;
                row.appendChild(tdItems);

                const tdQty = document.createElement('td');
                tdQty.style.textAlign = 'center';
                tdQty.textContent = doc.total_qty || 0;
                row.appendChild(tdQty);

                const tdComment = document.createElement('td');
                tdComment.textContent = doc.comment || '';
                row.appendChild(tdComment);

                const tdCreated = document.createElement('td');
                tdCreated.textContent = doc.created_by || '‚Äî';
                row.appendChild(tdCreated);

                const tdUpdated = document.createElement('td');
                if (doc.updated_at && doc.updated_by) {
                    const updDt = new Date(doc.updated_at);
                    const updStr = updDt.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                    tdUpdated.innerHTML = `<span style="color:#666;">${updStr}</span><br><span style="font-size:12px;">${doc.updated_by}</span>`;
                } else {
                    tdUpdated.textContent = '‚Äî';
                }
                row.appendChild(tdUpdated);

                const tdActions = document.createElement('td');
                tdActions.style.whiteSpace = 'nowrap';

                // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –¥–≤–æ–π–Ω–æ–º—É –∫–ª–∏–∫—É –Ω–∞ —Å—Ç—Ä–æ–∫–µ (row.ondblclick)

                const delBtn = document.createElement('button');
                delBtn.className = 'wh-delete-btn';
                delBtn.textContent = '‚úï';
                delBtn.title = '–£–¥–∞–ª–∏—Ç—å';
                delBtn.onclick = (e) => { e.stopPropagation(); deleteShipmentDoc(doc.id); };
                tdActions.appendChild(delBtn);

                row.appendChild(tdActions);
                tbody.appendChild(row);
            });
        }

        function editShipmentDoc(docId) {
            authFetch('/api/warehouse/shipment-docs/' + docId)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        editingShipmentDocId = docId;
                        document.getElementById('shipment-destination').value = data.doc.destination || '';
                        document.getElementById('shipment-comment').value = data.doc.comment || '';
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è
                        const isCompleted = data.doc.is_completed === 1 || data.doc.is_completed === true;
                        document.getElementById('shipment-completed').checked = isCompleted;
                        document.getElementById('wh-shipment-items-tbody').innerHTML = '';
                        shipmentItemCounter = 0;
                        data.items.forEach(item => addShipmentItemRowWithData(item));
                        updateShipmentTotals();
                        document.querySelector('.wh-save-shipment-btn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
                        showShipmentForm();
                    } else {
                        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                })
                .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', err));
        }

        function deleteShipmentDoc(docId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ—Ç–≥—Ä—É–∑–∫—É?')) return;
            authFetch('/api/warehouse/shipment-docs/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: docId })
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    loadShipmentHistory();
                    loadWarehouseStock();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch(err => console.error('–û—à–∏–±–∫–∞:', err));
        }

        function loadWarehouseStock() {
            authFetch('/api/warehouse/stock')
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.stock.length > 0) {
                        renderStockTable(data.stock);
                        document.getElementById('wh-stock-empty').style.display = 'none';
                        document.querySelector('#wh-stock .wh-table-wrapper').style.display = 'block';
                    } else {
                        document.getElementById('wh-stock-empty').style.display = 'block';
                        document.querySelector('#wh-stock .wh-table-wrapper').style.display = 'none';
                    }
                }).catch(() => document.getElementById('wh-stock-empty').style.display = 'block');
        }

        // –ö—ç—à –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–∞–≤–æ–∫ –¥–ª—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –û—Å—Ç–∞—Ç–∫–∏
        let stockSuppliesCache = {};

        function renderStockTable(stock) {
            const tbody = document.getElementById('wh-stock-tbody');
            const tfoot = document.getElementById('wh-stock-tfoot');
            tbody.innerHTML = '';
            stockSuppliesCache = {}; // –û—á–∏—â–∞–µ–º –∫—ç—à
            let totalReceived = 0, totalShipped = 0, totalReserved = 0, totalStock = 0, totalAvailable = 0, totalValue = 0;

            stock.forEach(item => {
                const sku = item.sku;
                const productName = item.product_name || 'SKU ' + sku;

                // –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Ç–æ–≤–∞—Ä–∞ (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è)
                const row = document.createElement('tr');
                row.className = 'wh-stock-row';
                row.id = 'wh-stock-row-' + sku;
                row.onclick = function() { toggleStockAccordion(sku, productName); };
                const reserved = item.reserved || 0;
                const available = item.stock_balance - reserved; // –û—Å—Ç–∞—Ç–æ–∫ –º–∏–Ω—É—Å –±—Ä–æ–Ω—å
                row.innerHTML = '<td style="text-align:left;"><span class="wh-stock-arrow">‚ñ∂</span> ' + (item.offer_id || '‚Äî') + '</td>' +
                    '<td style="text-align:center;">' + formatNumberWithSpaces(item.total_received) + '</td>' +
                    '<td style="text-align:center;">' + formatNumberWithSpaces(item.total_shipped) + '</td>' +
                    '<td style="text-align:center;' + (reserved > 0 ? 'color:#d97706;font-weight:500;' : '') + '">' + (reserved > 0 ? formatNumberWithSpaces(reserved) : '‚Äî') + '</td>' +
                    '<td style="text-align:center;" class="' + (item.stock_balance > 0 ? 'wh-stock-positive' : (item.stock_balance < 0 ? 'wh-stock-negative' : 'wh-stock-zero')) + '">' + formatNumberWithSpaces(item.stock_balance) + '</td>' +
                    '<td style="text-align:center;font-weight:600;" class="' + (available > 0 ? 'wh-stock-positive' : (available < 0 ? 'wh-stock-negative' : 'wh-stock-zero')) + '">' + formatNumberWithSpaces(available) + '</td>' +
                    '<td style="text-align:right;">' + (item.avg_purchase_price > 0 ? formatNumberWithSpaces(Math.round(item.avg_purchase_price)) + ' ‚ÇΩ' : '‚Äî') + '</td>' +
                    '<td style="text-align:right;font-weight:600;">' + (item.stock_balance > 0 && item.avg_purchase_price > 0 ? formatNumberWithSpaces(Math.round(item.stock_balance * item.avg_purchase_price)) + ' ‚ÇΩ' : '‚Äî') + '</td>';
                tbody.appendChild(row);

                // –°—Ç—Ä–æ–∫–∞-–∞–∫–∫–æ—Ä–¥–µ–æ–Ω —Å –ø–æ—Å—Ç–∞–≤–∫–∞–º–∏ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
                const accordionRow = document.createElement('tr');
                accordionRow.className = 'wh-stock-accordion';
                accordionRow.id = 'wh-stock-accordion-' + sku;
                accordionRow.innerHTML = '<td colspan="8" class="wh-accordion-cell"><div class="wh-accordion-content" id="wh-accordion-content-' + sku + '"><div class="wh-accordion-loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–≤–∏–∂–µ–Ω–∏–π...</div></div></td>';
                tbody.appendChild(accordionRow);

                totalReceived += item.total_received;
                totalShipped += item.total_shipped;
                totalReserved += reserved;
                totalStock += item.stock_balance;
                totalAvailable += available;
                totalValue += item.stock_balance > 0 && item.avg_purchase_price > 0 ? item.stock_balance * item.avg_purchase_price : 0;
            });

            tfoot.innerHTML = '<tr><td style="text-align:right;font-weight:600;">–ò—Ç–æ–≥–æ:</td>' +
                '<td style="text-align:center;font-weight:600;">' + formatNumberWithSpaces(totalReceived) + '</td>' +
                '<td style="text-align:center;font-weight:600;">' + formatNumberWithSpaces(totalShipped) + '</td>' +
                '<td style="text-align:center;font-weight:600;' + (totalReserved > 0 ? 'color:#d97706;' : '') + '">' + (totalReserved > 0 ? formatNumberWithSpaces(totalReserved) : '‚Äî') + '</td>' +
                '<td style="text-align:center;font-weight:600;" class="' + (totalStock > 0 ? 'wh-stock-positive' : 'wh-stock-zero') + '">' + formatNumberWithSpaces(totalStock) + '</td>' +
                '<td style="text-align:center;font-weight:600;" class="' + (totalAvailable > 0 ? 'wh-stock-positive' : (totalAvailable < 0 ? 'wh-stock-negative' : 'wh-stock-zero')) + '">' + formatNumberWithSpaces(totalAvailable) + '</td>' +
                '<td></td>' +
                '<td style="text-align:right;font-weight:600;">' + (totalValue > 0 ? formatNumberWithSpaces(Math.round(totalValue)) + ' ‚ÇΩ' : '‚Äî') + '</td></tr>';
        }

        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∞–∫–∫–æ—Ä–¥–µ–æ–Ω –¥–≤–∏–∂–µ–Ω–∏–π (–æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏—è + –æ—Ç–≥—Ä—É–∑–∫–∏) –¥–ª—è —Ç–æ–≤–∞—Ä–∞ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –û—Å—Ç–∞—Ç–∫–∏
         */
        async function toggleStockAccordion(sku, productName) {
            const row = document.getElementById('wh-stock-row-' + sku);
            const accordion = document.getElementById('wh-stock-accordion-' + sku);
            const content = document.getElementById('wh-accordion-content-' + sku);

            if (!row || !accordion) return;

            const isExpanded = row.classList.contains('expanded');

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω—ã
            document.querySelectorAll('.wh-stock-row.expanded').forEach(r => {
                r.classList.remove('expanded');
            });
            document.querySelectorAll('.wh-stock-accordion.visible').forEach(a => {
                a.classList.remove('visible');
            });

            if (isExpanded) {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π
                return;
            }

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π
            row.classList.add('expanded');
            accordion.classList.add('visible');

            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à
            if (stockSuppliesCache[sku]) {
                renderStockAccordionContent(sku, stockSuppliesCache[sku]);
                return;
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            content.innerHTML = '<div class="wh-accordion-loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–≤–∏–∂–µ–Ω–∏–π...</div>';

            try {
                const response = await authFetch('/api/warehouse/movements/' + sku + '?receipts_limit=10&shipments_limit=10');
                const data = await response.json();

                if (data.success) {
                    stockSuppliesCache[sku] = {
                        receipts: data.receipts,
                        shipments: data.shipments,
                        receiptsTotal: data.receipts_total,
                        shipmentsTotal: data.shipments_total,
                        hasMoreReceipts: data.has_more_receipts,
                        hasMoreShipments: data.has_more_shipments,
                        receiptsOffset: data.receipts.length,
                        shipmentsOffset: data.shipments.length
                    };
                    renderStockAccordionContent(sku, stockSuppliesCache[sku]);
                } else {
                    content.innerHTML = '<div class="wh-accordion-empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è') + '</div>';
                }
            } catch (err) {
                content.innerHTML = '<div class="wh-accordion-empty">–û—à–∏–±–∫–∞: ' + err.message + '</div>';
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–π
         */
        async function loadMoreReceipts(sku) {
            const cache = stockSuppliesCache[sku];
            if (!cache || !cache.hasMoreReceipts) return;

            try {
                const response = await authFetch('/api/warehouse/movements/' + sku + '?receipts_limit=10&receipts_offset=' + cache.receiptsOffset + '&shipments_limit=0');
                const data = await response.json();

                if (data.success) {
                    cache.receipts = cache.receipts.concat(data.receipts);
                    cache.hasMoreReceipts = data.has_more_receipts;
                    cache.receiptsOffset = cache.receiptsOffset + data.receipts.length;
                    renderStockAccordionContent(sku, cache);
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–π:', err);
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë –æ—Ç–≥—Ä—É–∑–æ–∫
         */
        async function loadMoreShipments(sku) {
            const cache = stockSuppliesCache[sku];
            if (!cache || !cache.hasMoreShipments) return;

            try {
                const response = await authFetch('/api/warehouse/movements/' + sku + '?shipments_limit=10&shipments_offset=' + cache.shipmentsOffset + '&receipts_limit=0');
                const data = await response.json();

                if (data.success) {
                    cache.shipments = cache.shipments.concat(data.shipments);
                    cache.hasMoreShipments = data.has_more_shipments;
                    cache.shipmentsOffset = cache.shipmentsOffset + data.shipments.length;
                    renderStockAccordionContent(sku, cache);
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–≥—Ä—É–∑–æ–∫:', err);
            }
        }

        /**
         * –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ —Å –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏—è–º–∏ –∏ –æ—Ç–≥—Ä—É–∑–∫–∞–º–∏
         */
        function renderStockAccordionContent(sku, data) {
            const content = document.getElementById('wh-accordion-content-' + sku);
            if (!content) return;

            const hasReceipts = data.receipts && data.receipts.length > 0;
            const hasShipments = data.shipments && data.shipments.length > 0;

            if (!hasReceipts && !hasShipments) {
                content.innerHTML = '<div class="wh-accordion-empty">–ù–µ—Ç –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–π –∏ –æ—Ç–≥—Ä—É–∑–æ–∫ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞</div>';
                return;
            }

            let html = '<div style="display: flex; gap: 12px; align-items: flex-start;">';

            // ========== –û–ü–†–ò–•–û–î–û–í–ê–ù–ò–Ø ==========
            html += '<div style="flex: 1; min-width: 0;">';
            html += '<div style="padding: 4px 0; font-size: 12px; font-weight: 600; color: #333;">üì• –ü—Ä–∏—Ö–æ–¥ (' + data.receiptsTotal + ')</div>';

            if (hasReceipts) {
                html += '<table class="wh-accordion-table" style="font-size: 11px; width: 100%;">';
                html += '<thead><tr>';
                html += '<th style="padding: 4px 3px; width: 24px;">‚Ññ</th>';
                html += '<th style="padding: 4px 3px;">–î–∞—Ç–∞</th>';
                html += '<th style="padding: 4px 3px;">–ö–æ–ª</th>';
                html += '<th style="padding: 4px 3px;">–¶–µ–Ω–∞</th>';
                html += '</tr></thead>';
                html += '<tbody>';

                let totalReceiptQty = 0;
                data.receipts.forEach(r => {
                    const docNum = r.doc_id || '‚Äî';
                    const date = formatDateShort(r.receipt_date);
                    const qty = r.quantity || 0;
                    const actualPrice = r.calculated_cost || r.purchase_price || 0;
                    const price = actualPrice > 0 ? formatNumberWithSpaces(Math.round(actualPrice)) + '‚ÇΩ' : '‚Äî';
                    totalReceiptQty += qty;

                    html += '<tr>';
                    html += '<td style="color: #667eea; font-weight: 600; text-align: center; padding: 3px 2px;">' + docNum + '</td>';
                    html += '<td style="padding: 3px; white-space: nowrap;">' + (date || '‚Äî') + '</td>';
                    html += '<td style="color: #16a34a; font-weight: 600; padding: 3px;">+' + qty + '</td>';
                    html += '<td style="padding: 3px; white-space: nowrap;">' + price + '</td>';
                    html += '</tr>';
                });

                html += '</tbody>';
                html += '<tfoot><tr>';
                html += '<td style="padding: 3px;"></td>';
                html += '<td style="padding: 3px;"><strong>–ò—Ç–æ–≥–æ</strong></td>';
                html += '<td style="color: #16a34a; padding: 3px;"><strong>+' + totalReceiptQty + '</strong></td>';
                html += '<td></td>';
                html += '</tr></tfoot>';
                html += '</table>';

                if (data.hasMoreReceipts) {
                    html += '<button class="wh-accordion-more-btn" style="font-size:11px; padding:5px 12px; margin-top:8px;" onclick="event.stopPropagation(); loadMoreReceipts(' + sku + ');">–ï—â—ë 10</button>';
                }
            } else {
                html += '<div class="wh-accordion-empty" style="padding:10px; font-size:12px;">–ù–µ—Ç –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–π</div>';
            }
            html += '</div>';

            // ========== –û–¢–ì–†–£–ó–ö–ò ==========
            html += '<div style="flex: 1; min-width: 0;">';
            html += '<div style="padding: 4px 0; font-size: 12px; font-weight: 600; color: #333;">üì§ –û—Ç–≥—Ä—É–∑–∫–∏ (' + data.shipmentsTotal + ')</div>';

            if (hasShipments) {
                html += '<table class="wh-accordion-table" style="font-size: 11px; width: 100%;">';
                html += '<thead><tr>';
                html += '<th style="padding: 4px 3px; width: 24px;">‚Ññ</th>';
                html += '<th style="padding: 4px 3px;">–î–∞—Ç–∞</th>';
                html += '<th style="padding: 4px 3px;">–ö–æ–ª</th>';
                html += '<th style="padding: 4px 3px;">–ö—É–¥–∞</th>';
                html += '<th style="padding: 4px 3px; width: 20px;"></th>';
                html += '</tr></thead>';
                html += '<tbody>';

                let totalShipmentQty = 0;
                data.shipments.forEach(s => {
                    const docNum = s.doc_id || '‚Äî';
                    const date = formatDateShort(s.shipment_date);
                    const qty = s.quantity || 0;
                    const dest = s.destination || s.doc_destination || '‚Äî';
                    const isCompleted = s.is_completed !== 0;
                    const statusBadge = isCompleted
                        ? '<span style="color: #16a34a; font-size: 10px;">‚úì</span>'
                        : '<span style="color: #ca8a04; font-size: 10px;">‚ó∑</span>';
                    totalShipmentQty += qty;

                    html += '<tr>';
                    html += '<td style="color: #667eea; font-weight: 600; text-align: center; padding: 3px 2px;">' + docNum + '</td>';
                    html += '<td style="padding: 3px; white-space: nowrap;">' + (date || '‚Äî') + '</td>';
                    html += '<td style="color: #dc2626; font-weight: 600; padding: 3px;">‚àí' + qty + '</td>';
                    html += '<td style="padding: 3px; max-width: 50px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="' + dest + '">' + dest + '</td>';
                    html += '<td style="padding: 3px; text-align: center;">' + statusBadge + '</td>';
                    html += '</tr>';
                });

                html += '</tbody>';
                html += '<tfoot><tr>';
                html += '<td style="padding: 3px;"></td>';
                html += '<td style="padding: 3px;"><strong>–ò—Ç–æ–≥–æ</strong></td>';
                html += '<td style="color: #dc2626; padding: 3px;"><strong>‚àí' + totalShipmentQty + '</strong></td>';
                html += '<td colspan="2"></td>';
                html += '</tr></tfoot>';
                html += '</table>';

                if (data.hasMoreShipments) {
                    html += '<button class="wh-accordion-more-btn" style="font-size:11px; padding:5px 12px; margin-top:8px;" onclick="event.stopPropagation(); loadMoreShipments(' + sku + ');">–ï—â—ë 10</button>';
                }
            } else {
                html += '<div class="wh-accordion-empty" style="padding:10px; font-size:12px;">–ù–µ—Ç –æ—Ç–≥—Ä—É–∑–æ–∫</div>';
            }
            html += '</div>';

            html += '</div>'; // end flex container

            content.innerHTML = html;
        }

        /**
         * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –î–î.–ú–ú.–ì–ì
         */
        function formatDateShort(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                return parts[2] + '.' + parts[1] + '.' + parts[0].slice(-2);
            }
            return dateStr;
        }

        // ============================================================
        // –ê–ù–ê–õ–ò–¢–ò–ö–ê FBO ‚Äî –ê–ö–ö–û–†–î–ï–û–ù
        // ============================================================

        let fboDataLoaded = false;

        function loadFboAnalytics() {
            const container = document.getElementById('fbo-content');
            if (fboDataLoaded) return; // –ù–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –µ—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ

            container.innerHTML = '<div class="fbo-loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ FBO...</div>';

            fetch('/api/fbo-analytics')
                .then(r => r.json())
                .then(data => {
                    if (!data.success) {
                        container.innerHTML = '<div class="fbo-loading">–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è') + '</div>';
                        return;
                    }
                    if (!data.products || data.products.length === 0) {
                        container.innerHTML = '<div class="fbo-loading">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é.</div>';
                        return;
                    }
                    fboDataLoaded = true;
                    renderFboTable(data.products);
                })
                .catch(err => {
                    container.innerHTML = '<div class="fbo-loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + err.message + '</div>';
                });
        }

        function getLiqBadge(status) {
            // –°—Ç–∞—Ç—É—Å—ã –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç–∏ –∏–∑ API /v1/analytics/stocks
            const labels = {
                'DEFICIT': '–î–µ—Ñ–∏—Ü–∏—Ç',
                'WAS_DEFICIT': '–ë—ã–ª –¥–µ—Ñ–∏—Ü–∏—Ç',
                'NO_SALES': '–ù–µ—Ç –ø—Ä–æ–¥–∞–∂',
                'WAS_NO_SALES': '–ë—ã–ª–∏ –ø—Ä–æ–¥–∞–∂–∏',
                'ACTUAL': '–ê–∫—Ç—É–∞–ª—å–Ω—ã–π',
                'WAS_ACTUAL': '–ë—ã–ª –∞–∫—Ç—É–∞–ª–µ–Ω',
                'POPULAR': '–ü–æ–ø—É–ª—è—Ä–Ω—ã–π',
                'WAS_POPULAR': '–ë—ã–ª –ø–æ–ø—É–ª—è—Ä–µ–Ω',
                'SURPLUS': '–ò–∑–ª–∏—à–µ–∫',
                'WAS_SURPLUS': '–ë—ã–ª –∏–∑–ª–∏—à–µ–∫',
                'WAITING_FOR_SUPPLY': '–û–∂–∏–¥–∞–µ—Ç –ø–æ—Å—Ç–∞–≤–∫—É',
                'RESTRICTED_NO_SALES': '–û–≥—Ä–∞–Ω–∏—á–µ–Ω'
            };
            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ü–≤–µ—Ç–æ–≤: WAS_X –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ü–≤–µ—Ç X
            var colorMap = {
                'DEFICIT': 'DEFICIT', 'WAS_DEFICIT': 'DEFICIT',
                'NO_SALES': 'NO_SALES', 'WAS_NO_SALES': 'NO_SALES', 'RESTRICTED_NO_SALES': 'NO_SALES',
                'ACTUAL': 'ACTUAL', 'WAS_ACTUAL': 'ACTUAL', 'WAITING_FOR_SUPPLY': 'ACTUAL',
                'POPULAR': 'POPULAR', 'WAS_POPULAR': 'POPULAR',
                'SURPLUS': 'SURPLUS', 'WAS_SURPLUS': 'SURPLUS'
            };
            var label = labels[status] || status || '\\u2014';
            var color = colorMap[status] || '';
            var cls = color ? 'liq-' + color : '';
            return '<span class="liq-badge ' + cls + '">' + label + '</span>';
        }

        function renderFboTable(products) {
            const container = document.getElementById('fbo-content');

            let html = '<div style="overflow-x:auto;-webkit-overflow-scrolling:touch;"><table class="fbo-table">';
            html += '<thead class="fbo-header"><tr>';
            html += '<th>–¢–æ–≤–∞—Ä</th>';
            html += '<th>–û—Å—Ç–∞—Ç–æ–∫ FBO</th>';
            html += '<th>–ü—Ä–æ–¥–∞–∂/–¥–µ–Ω—å</th>';
            html += '<th>–í –ø—É—Ç–∏</th>';
            html += '<th>–í –∑–∞—è–≤–∫–∞—Ö</th>';
            html += '<th>–°—Ç–∞—Ç—É—Å</th>';
            html += '</tr></thead>';
            html += '<tbody>';

            products.forEach(function(p) {
                const sku = p.sku;
                const stockClass = p.fbo_stock > 0 ? 'fbo-stock-val' : 'fbo-stock-val fbo-stock-zero';

                // –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Ç–æ–≤–∞—Ä–∞
                html += '<tr class="fbo-row" id="fbo-row-' + sku + '" onclick="toggleFboRow(' + sku + ')">';
                html += '<td style="text-align:left;"><span class="fbo-arrow">&#9654;</span>' + (p.offer_id || p.name || 'SKU ' + sku) + '</td>';
                html += '<td class="' + stockClass + '">' + p.fbo_stock + ' —à—Ç</td>';
                html += '<td>' + p.total_ads + '</td>';
                html += '<td>' + (p.in_transit || 0) + '</td>';
                html += '<td>' + (p.in_draft || 0) + '</td>';
                html += '<td>' + getLiqBadge(p.worst_liquidity) + '</td>';
                html += '</tr>';

                // –ë–ª–æ–∫ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
                html += '<tbody class="fbo-clusters" id="fbo-clusters-' + sku + '">';

                if (p.clusters && p.clusters.length > 0) {
                    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
                    html += '<tr class="cluster-row" style="background:#f0f2f5;">';
                    html += '<td style="font-weight:600;color:#888;">–ö–ª–∞—Å—Ç–µ—Ä</td>';
                    html += '<td style="font-weight:600;color:#888;">–û—Å—Ç–∞—Ç–æ–∫</td>';
                    html += '<td style="font-weight:600;color:#888;">–ü—Ä–æ–¥–∞–∂/–¥–µ–Ω—å</td>';
                    html += '<td style="font-weight:600;color:#888;">–î–Ω–µ–π –¥–æ –∫–æ–Ω—Ü–∞</td>';
                    html += '<td style="font-weight:600;color:#888;">–ë–µ–∑ –ø—Ä–æ–¥–∞–∂</td>';
                    html += '<td style="font-weight:600;color:#888;">–°—Ç–∞—Ç—É—Å</td>';
                    html += '</tr>';

                    p.clusters.forEach(function(c) {
                        const cStockClass = c.stock > 0 ? '' : 'fbo-stock-zero';
                        html += '<tr class="cluster-row">';
                        html += '<td>' + c.cluster_name + '</td>';
                        html += '<td class="' + cStockClass + '">' + c.stock + ' —à—Ç</td>';
                        html += '<td>' + c.ads + '</td>';
                        html += '<td>' + c.idc + '</td>';
                        html += '<td>' + c.days_without_sales + ' –¥–Ω</td>';
                        html += '<td>' + getLiqBadge(c.liquidity_status) + '</td>';
                        html += '</tr>';
                    });
                } else {
                    html += '<tr class="cluster-row"><td colspan="6" style="color:#aaa;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º</td></tr>';
                }

                html += '</tbody>';
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function toggleFboRow(sku) {
            const row = document.getElementById('fbo-row-' + sku);
            const clusters = document.getElementById('fbo-clusters-' + sku);

            if (!row || !clusters) return;

            const isExpanded = row.classList.contains('expanded');

            if (isExpanded) {
                row.classList.remove('expanded');
                clusters.classList.remove('visible');
            } else {
                row.classList.add('expanded');
                clusters.classList.add('visible');
            }
        }

        function loadProductsList() {
            fetch('/api/products/list')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.products.length > 0) {
                        const select = document.getElementById('product-select');
                        select.innerHTML = '';  // –ù–µ –¥–æ–±–∞–≤–ª—è—é "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä"
                        
                        data.products.forEach(p => {
                            const option = document.createElement('option');
                            option.value = p.sku;
                            option.textContent = p.offer_id ? `${p.offer_id}` : `SKU: ${p.sku}`;
                            select.appendChild(option);
                        });
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞—é –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä –∏ –∑–∞–≥—Ä—É–∂–∞—é –∏—Å—Ç–æ—Ä–∏—é
                        select.value = data.products[0].sku;
                        loadHistoryForProduct();
                    }
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞:', error));
        }

        function loadHistoryForProduct() {
            const sku = document.getElementById('product-select').value;
            
            if (!sku) {
                document.getElementById('history-content').innerHTML = 
                    '<div class="empty-state">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –∏–∑ —Å–ø–∏—Å–∫–∞</div>';
                return;
            }
            
            document.getElementById('history-content').innerHTML = 
                '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>';
            
            fetch(`/api/history/${sku}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentHistoryData = data;  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                        renderHistory(data);
                    } else {
                        document.getElementById('history-content').innerHTML =
                            '<div class="error">' + data.error + '</div>';
                    }
                })
                .catch(error => {
                    document.getElementById('history-content').innerHTML = 
                        '<div class="error">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: ' + error + '</div>';
                });
        }

        function renderHistory(data) {
            const historyContent = document.getElementById('history-content');

            if (!data.history || data.history.length === 0) {
                historyContent.innerHTML = '<div class="empty-state">–ò—Å—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</div>';
                return;
            }

            // ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Å–µ–ª —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ (3 245 –≤–º–µ—Å—Ç–æ 3245)
            function formatNumber(num) {
                if (num === null || num === undefined || num === 0) return '0';
                return String(Math.round(num)).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            }

            // ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–µ–ª–æ–∫
            function getTrendArrow(current, previous, reverseDirection = false) {
                // –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –∏–ª–∏ –æ–±–∞ null/undefined - –±–µ–∑ —Å—Ç—Ä–µ–ª–∫–∏
                if (previous === null || previous === undefined ||
                    current === null || current === undefined) {
                    return '';
                }

                const diff = current - previous;

                if (diff === 0) return ''; // –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

                // –î–ª—è —Å—Ä–µ–¥–Ω–µ–π –ø–æ–∑–∏—Ü–∏–∏: –º–µ–Ω—å—à–µ = –ª—É—á—à–µ, –ø–æ—ç—Ç–æ–º—É –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É
                const isGood = reverseDirection ? (diff < 0) : (diff > 0);

                if (isGood) {
                    return ' <span style="color: #22c55e; font-size: 14px;">‚ñ≤</span>';
                } else {
                    return ' <span style="color: #ef4444; font-size: 14px;">‚ñº</span>';
                }
            }
            
            // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ–≥–æ–≤ —Å —Ü–≤–µ—Ç–∞–º–∏
            const TAG_CONFIG = {
                '–°–∞–º–æ–≤—ã–∫—É–ø': { class: 'samovykup', color: '#7c3aed' },
                '–ú–µ–¥–∏–∞–Ω–∞': { class: 'mediana', color: '#ea580c' },
                '–†–µ–∫–ª–∞–º–∞': { class: 'reklama', color: '#dc2626' },
                '–¶–µ–Ω–∞': { class: 'cena', color: '#16a34a' },
                '–ê–∫—Ü–∏–∏': { class: 'akcii', color: '#ca8a04' },
                '–¢–µ—Å—Ç': { class: 'test', color: '#6b7280' }
            };

            let html = '<table><thead><tr>';
            html += '<th style="width: 120px;">–¢–µ–≥</th>';
            html += '<th>–ó–∞–º–µ—Ç–∫–∏</th>';
            html += '<th>–î–∞—Ç–∞</th>';
            html += '<th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>';
            html += '<th>SKU</th>';
            html += '<th>–†–µ–π—Ç–∏–Ω–≥</th>';
            html += '<th>–û—Ç–∑—ã–≤—ã</th>';
            html += '<th>–ò–Ω–¥–µ–∫—Å —Ü–µ–Ω</th>';
            html += '<th>FBO –æ—Å—Ç–∞—Ç–æ–∫</th>';
            html += '<th>–ó–∞–∫–∞–∑—ã</th>';
            html += '<th>–ó–∞–∫–∞–∑—ã –ø–ª–∞–Ω</th>';
            html += '<th>–¶–µ–Ω–∞ –≤ –õ–ö</th>';
            html += '<th>–¶–µ–Ω–∞ –ø–ª–∞–Ω</th>';
            html += '<th>–°–æ–∏–Ω–≤–µ—Å—Ç</th>';
            html += '<th>–¶–µ–Ω–∞ –Ω–∞ —Å–∞–π—Ç–µ</th>';
            html += '<th>–°—Ä. –ø–æ–∑–∏—Ü–∏—è</th>';
            html += '<th>–ü–æ–∫–∞–∑—ã (–ø–æ–∏—Å–∫+–∫–∞—Ç.)</th>';
            html += '<th>–ü–æ—Å–µ—â–µ–Ω–∏—è</th>';
            html += '<th>CTR (%)</th>';
            html += '<th>–ö–æ—Ä–∑–∏–Ω–∞</th>';
            html += '<th>CR1 (%)</th>';
            html += '<th>CR2 (%)</th>';
            html += '<th>–†–∞—Å—Ö–æ–¥—ã</th>';
            html += '<th>CPO –ø–ª–∞–Ω</th>';
            html += '<th>CPO</th>';
            html += '<th>–î–†–† (%)</th>';
            html += '<th>–í –ø—É—Ç–∏</th>';
            html += '<th>–í –∑–∞—è–≤–∫–∞—Ö</th>';
            html += '</tr></thead><tbody>';

            data.history.forEach((item, index) => {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –¥–µ–Ω—å –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                const prevItem = data.history[index + 1] || null;

                const date = new Date(item.snapshot_date);
                // –§–æ—Ä–º–∞—Ç: 01.01.26
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2);
                const dateStr = `${day}.${month}.${year}`;

                const stockClass = item.fbo_stock < 5 ? 'stock low' : 'stock';
                const uniqueId = `note_${data.product_sku}_${item.snapshot_date}`;
                const tagId = `tag_${data.product_sku}_${item.snapshot_date}`;
                const notes = item.notes || '';

                // –ü–∞—Ä—Å–∏–º —Ç–µ–≥–∏ –∏–∑ JSON —Å—Ç—Ä–æ–∫–∏
                let tags = [];
                try {
                    tags = item.tags ? JSON.parse(item.tags) : [];
                } catch(e) { tags = []; }

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å —Å—Ç—Ä–æ–∫–∏ –ø–æ –ø–µ—Ä–≤–æ–º—É —Ç–µ–≥—É (–¥–ª—è –æ–∫—Ä–∞—à–∏–≤–∞–Ω–∏—è)
                const firstTag = tags.length > 0 ? tags[0] : null;
                const rowClass = firstTag && TAG_CONFIG[firstTag] ? 'row-' + TAG_CONFIG[firstTag].class : '';

                html += `<tr class="${rowClass}" data-row-id="${tagId}">`;

                // –Ø—á–µ–π–∫–∞ —Å —Ç–µ–≥–∞–º–∏
                html += `<td class="tag-cell">
                    <select class="tag-select" onchange="addTag('${tagId}', ${data.product_sku}, '${item.snapshot_date}', this.value); this.value='';">
                        <option value="">+ –¢–µ–≥</option>
                        ${Object.keys(TAG_CONFIG).map(t => `<option value="${t}">${t}</option>`).join('')}
                    </select>
                    <div class="tag-badges" id="${tagId}_badges">
                        ${tags.map(t => {
                            const cfg = TAG_CONFIG[t] || { class: 'test', color: '#6b7280' };
                            return `<span class="tag-badge tag-${cfg.class}" onclick="removeTag('${tagId}', ${data.product_sku}, '${item.snapshot_date}', '${t}')">${t}<span class="tag-remove">√ó</span></span>`;
                        }).join('')}
                    </div>
                </td>`;
                html += `<td style="width: 220px; min-width: 220px; max-width: 220px; word-wrap: break-word; overflow-wrap: break-word; text-align: left;">
                    <div class="note-cell">
                        <div id="${uniqueId}_display" class="note-display" onclick="startEditNote('${uniqueId}', '${data.product_sku}', '${item.snapshot_date}')">
                            ${notes || '<span style="color: #bbb;">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å...</span>'}
                        </div>
                    </div>
                    <div id="${uniqueId}_editor" style="display: none;">
                        <textarea 
                            id="${uniqueId}_textarea"
                            class="note-textarea"
                            placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∑–∞–º–µ—Ç–∫—É..."
                        >${notes}</textarea>
                        <div style="margin-top: 6px; display: flex; gap: 4px;">
                            <button class="note-save-btn" onclick="saveNote('${uniqueId}', ${data.product_sku}, '${item.snapshot_date}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button class="note-cancel-btn" onclick="cancelEditNote('${uniqueId}')">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </div>
                </td>`;
                html += `<td><strong>${dateStr}</strong></td>`;
                html += `<td><span onclick="openProductOnOzon('${item.sku}')" style="cursor: pointer; color: #0066cc; text-decoration: underline;" title="–û—Ç–∫—Ä—ã—Ç—å —Ç–æ–≤–∞—Ä –Ω–∞ Ozon">${item.name}</span></td>`;
                html += `<td><span class="sku" onclick="copySKU(this, '${item.sku}')" style="cursor: pointer;" title="–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">${item.sku}</span></td>`;

                // –†–µ–π—Ç–∏–Ω–≥ —Ç–æ–≤–∞—Ä–∞
                const rating = item.rating !== null && item.rating !== undefined ? item.rating.toFixed(1) : '‚Äî';
                html += `<td><strong>${rating}</strong></td>`;

                // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤
                const reviewCount = item.review_count !== null && item.review_count !== undefined ? formatNumber(item.review_count) : '‚Äî';
                html += `<td><strong>${reviewCount}</strong></td>`;

                // –ò–Ω–¥–µ–∫—Å —Ü–µ–Ω—ã (color_index) ‚Äî —Ü–≤–µ—Ç–æ–≤–æ–π –∫–æ–¥ –æ—Ç Ozon
                // –í–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: SUPER, GREEN, YELLOW, RED, WITHOUT_INDEX
                const priceIndexMap = {
                    'SUPER': { text: '–°—É–ø–µ—Ä', color: '#22c55e' },
                    'GREEN': { text: '–í—ã–≥–æ–¥–Ω–∞—è', color: '#22c55e' },
                    'GOOD': { text: '–•–æ—Ä–æ—à–∞—è', color: '#84cc16' },
                    'YELLOW': { text: '–£–º–µ—Ä–µ–Ω–Ω–∞—è', color: '#f59e0b' },
                    'AVG': { text: '–°—Ä–µ–¥–Ω—è—è', color: '#f59e0b' },
                    'RED': { text: '–ù–µ–≤—ã–≥–æ–¥–Ω–∞—è', color: '#ef4444' },
                    'BAD': { text: '–ü–ª–æ—Ö–∞—è', color: '#ef4444' },
                    'WITHOUT_INDEX': { text: '–ë–µ–∑ –∏–Ω–¥–µ–∫—Å–∞', color: '#6b7280' }
                };
                const priceIndexValue = item.price_index || null;
                const priceIndexDisplay = priceIndexValue && priceIndexMap[priceIndexValue]
                    ? `<span style="color: ${priceIndexMap[priceIndexValue].color}; font-weight: 500;">${priceIndexMap[priceIndexValue].text}</span>`
                    : '‚Äî';
                html += `<td>${priceIndexDisplay}</td>`;

                html += `<td><span class="${stockClass}">${formatNumber(item.fbo_stock)}</span></td>`;

                // –ó–∞–∫–∞–∑—ã (—Å —Å—Ç—Ä–µ–ª–∫–æ–π)
                html += `<td><span class="stock">${formatNumber(item.orders_qty || 0)}${getTrendArrow(item.orders_qty, prevItem?.orders_qty)}</span></td>`;

                // –ó–∞–∫–∞–∑—ã –ø–ª–∞–Ω (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ –ø–æ–ª–µ)
                // –ï—Å–ª–∏ —É —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –Ω–µ—Ç –ø–ª–∞–Ω–∞ ‚Äî –∏—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                // –≤ –±–æ–ª–µ–µ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å—è—Ö (–∫–∞—Å–∫–∞–¥–Ω–∞—è –ø—Ä–æ–ø–∞–≥–∞—Ü–∏—è –Ω–∞–∑–∞–¥ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏)
                let ordersPlanValue = '';
                if (item.orders_plan !== null && item.orders_plan !== undefined) {
                    ordersPlanValue = item.orders_plan;
                } else {
                    // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é —Å—Ç–∞—Ä—É—é –∑–∞–ø–∏—Å—å —Å –Ω–µ–ø—É—Å—Ç—ã–º orders_plan
                    for (let k = index + 1; k < data.history.length; k++) {
                        const olderItem = data.history[k];
                        if (olderItem.orders_plan !== null && olderItem.orders_plan !== undefined) {
                            ordersPlanValue = olderItem.orders_plan;
                            break;
                        }
                    }
                }
                // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –¥–∞—Ç—ã –Ω–∞–ø—Ä—è–º—É—é (–±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏)
                const itemDate = new Date(item.snapshot_date);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                itemDate.setHours(0, 0, 0, 0);
                const isPast = itemDate < today;
                const planInputId = `orders_plan_${data.product_sku}_${item.snapshot_date}`;

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç —è—á–µ–π–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–∞ –∏ —Ñ–∞–∫—Ç–∞
                let cellBgColor = '#f5f5f5'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–ª–µ–¥–Ω–æ-—Å–µ—Ä—ã–π
                const actualOrders = item.orders_qty || 0;
                const planOrders = parseInt(ordersPlanValue) || 0;

                if (ordersPlanValue !== '' && planOrders > 0) {
                    if (planOrders > actualOrders) {
                        cellBgColor = '#ffe5e5'; // –ë–ª–µ–¥–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π (–ø–ª–∞–Ω –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω)
                    } else if (planOrders < actualOrders) {
                        cellBgColor = '#e5ffe5'; // –ë–ª–µ–¥–Ω–æ-–∑–µ–ª–µ–Ω—ã–π (–ø–ª–∞–Ω –ø–µ—Ä–µ–≤—ã–ø–æ–ª–Ω–µ–Ω)
                    }
                }

                html += `<td class="plan-cell" style="background-color: ${cellBgColor} !important;">
                    <input
                        type="text"
                        id="${planInputId}"
                        value="${ordersPlanValue}"
                        style="width: 60px; padding: 4px; text-align: center; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; background-color: ${isPast ? '#e5e5e5' : '#fff'};"
                        ${isPast ? 'readonly' : ''}
                        oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                        onblur="saveOrdersPlan('${data.product_sku}', '${item.snapshot_date}', this.value)"
                    />
                </td>`;

                // –¶–µ–Ω–∞ –≤ –õ–ö (—Å —Å—Ç—Ä–µ–ª–∫–æ–π –∏ —Ä–∞–∑–Ω–∏—Ü–µ–π, –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –º–µ–Ω—å—à–µ = –ª—É—á—à–µ)
                const curPrice = item.price || 0;
                const prevPrice = prevItem?.price || 0;
                const priceDiff = (prevItem && prevItem.price !== null && prevItem.price !== undefined && item.price !== null && item.price !== undefined && item.price > 0) ? curPrice - prevPrice : null;
                let priceDiffHtml = '';
                if (priceDiff !== null && priceDiff !== 0) {
                    const diffColor = priceDiff < 0 ? '#22c55e' : '#ef4444'; // –ú–µ–Ω—å—à–µ = –ª—É—á—à–µ
                    const diffSign = priceDiff > 0 ? '+' : '';
                    priceDiffHtml = `<br><span style="font-size: 11px; color: ${diffColor}; font-weight: 400;">${diffSign}${formatNumber(priceDiff)} ‚ÇΩ</span>`;
                }
                html += `<td><strong>${(item.price !== null && item.price !== undefined && item.price > 0) ? formatNumber(Math.round(item.price)) + ' ‚ÇΩ' : '‚Äî'}${(item.price !== null && item.price !== undefined && item.price > 0) ? getTrendArrow(item.price, prevItem?.price, true) : ''}</strong>${priceDiffHtml}</td>`;

                // –¶–µ–Ω–∞ –ø–ª–∞–Ω (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ –ø–æ–ª–µ, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ó–∞–∫–∞–∑—ã –ø–ª–∞–Ω)
                let pricePlanValue = '';
                if (item.price_plan !== null && item.price_plan !== undefined) {
                    pricePlanValue = item.price_plan;
                } else {
                    // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é —Å—Ç–∞—Ä—É—é –∑–∞–ø–∏—Å—å —Å –Ω–µ–ø—É—Å—Ç—ã–º price_plan
                    for (let k = index + 1; k < data.history.length; k++) {
                        const olderItem = data.history[k];
                        if (olderItem.price_plan !== null && olderItem.price_plan !== undefined) {
                            pricePlanValue = olderItem.price_plan;
                            break;
                        }
                    }
                }
                const pricePlanInputId = `price_plan_${data.product_sku}_${item.snapshot_date}`;

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç —è—á–µ–π–∫–∏ –¶–µ–Ω–∞ –ø–ª–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–∞ –∏ —Ñ–∞–∫—Ç–∞ —Ü–µ–Ω—ã
                // –î–ª—è —Ü–µ–Ω—ã: –≤—ã—à–µ = –ª—É—á—à–µ, –µ—Å–ª–∏ —Ñ–∞–∫—Ç > –ø–ª–∞–Ω ‚Äî –∑–µ–ª—ë–Ω—ã–π (—Ö–æ—Ä–æ—à–æ)
                let pricePlanBgColor = '#f5f5f5';
                const planPrice = parseInt(pricePlanValue) || 0;
                const actualPrice = (item.price !== null && item.price !== undefined && item.price > 0) ? Math.round(item.price) : 0;

                if (pricePlanValue !== '' && planPrice > 0 && actualPrice > 0) {
                    if (actualPrice < planPrice) {
                        pricePlanBgColor = '#ffe5e5'; // –ë–ª–µ–¥–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π (—Ü–µ–Ω–∞ –Ω–∏–∂–µ –ø–ª–∞–Ω–∞ ‚Äî –ø–ª–æ—Ö–æ)
                    } else if (actualPrice > planPrice) {
                        pricePlanBgColor = '#e5ffe5'; // –ë–ª–µ–¥–Ω–æ-–∑–µ–ª–µ–Ω—ã–π (—Ü–µ–Ω–∞ –≤—ã—à–µ –ø–ª–∞–Ω–∞ ‚Äî —Ö–æ—Ä–æ—à–æ)
                    }
                }

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –º–µ–∂–¥—É —Ç—ã—Å—è—á–∞–º–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const pricePlanDisplay = pricePlanValue !== '' ? formatNumber(parseInt(pricePlanValue)) : '';

                html += `<td class="plan-cell" style="background-color: ${pricePlanBgColor} !important;">
                    <input
                        type="text"
                        id="${pricePlanInputId}"
                        value="${pricePlanDisplay}"
                        style="width: 80px; padding: 4px; text-align: center; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; background-color: ${isPast ? '#e5e5e5' : '#fff'};"
                        ${isPast ? 'readonly' : ''}
                        oninput="this.value = this.value.replace(/[^0-9\\s]/g, '').replace(/\s/g, ''); this.value = this.value.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ' ');"
                        onblur="savePricePlan('${data.product_sku}', '${item.snapshot_date}', this.value.replace(/\s/g, ''))"
                    />
                </td>`;

                // –°–æ–∏–Ω–≤–µ—Å—Ç (–ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ –æ—Ç –¶–µ–Ω—ã –≤ –õ–ö –¥–æ –¶–µ–Ω—ã –Ω–∞ —Å–∞–π—Ç–µ)
                let coinvest = '‚Äî';
                let coinvestValue = null;
                let prevCoinvestValue = null;

                // –í—ã—á–∏—Å–ª—è–µ–º —Å–æ–∏–Ω–≤–µ—Å—Ç –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
                if (item.price !== null && item.price !== undefined && item.price > 0 &&
                    item.marketing_price !== null && item.marketing_price !== undefined && item.marketing_price > 0) {
                    coinvestValue = ((item.price - item.marketing_price) / item.price) * 100;
                    coinvest = coinvestValue.toFixed(1) + '%';
                }

                // –í—ã—á–∏—Å–ª—è–µ–º —Å–æ–∏–Ω–≤–µ—Å—Ç –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–Ω—è (–¥–ª—è —Å—Ç—Ä–µ–ª–∫–∏)
                if (prevItem && prevItem.price !== null && prevItem.price !== undefined && prevItem.price > 0 &&
                    prevItem.marketing_price !== null && prevItem.marketing_price !== undefined && prevItem.marketing_price > 0) {
                    prevCoinvestValue = ((prevItem.price - prevItem.marketing_price) / prevItem.price) * 100;
                }

                // –î–æ–±–∞–≤–ª—è–µ–º —è—á–µ–π–∫—É —Å–æ —Å—Ç—Ä–µ–ª–∫–æ–π –∏ —Ä–∞–∑–Ω–∏—Ü–µ–π
                const coinvestDiff = (coinvestValue !== null && prevCoinvestValue !== null) ? coinvestValue - prevCoinvestValue : null;
                let coinvestDiffHtml = '';
                if (coinvestDiff !== null && coinvestDiff !== 0) {
                    const diffColor = coinvestDiff > 0 ? '#22c55e' : '#ef4444'; // –ë–æ–ª—å—à–µ = –ª—É—á—à–µ
                    const diffSign = coinvestDiff > 0 ? '+' : '';
                    coinvestDiffHtml = `<br><span style="font-size: 11px; color: ${diffColor}; font-weight: 400;">${diffSign}${coinvestDiff.toFixed(1)}%</span>`;
                }
                html += `<td><strong>${coinvest}${coinvestValue !== null && prevCoinvestValue !== null ? getTrendArrow(coinvestValue, prevCoinvestValue) : ''}</strong>${coinvestDiffHtml}</td>`;

                // –¶–µ–Ω–∞ –Ω–∞ —Å–∞–π—Ç–µ (—Å —Å—Ç—Ä–µ–ª–∫–æ–π –∏ —Ä–∞–∑–Ω–∏—Ü–µ–π, –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –º–µ–Ω—å—à–µ = –ª—É—á—à–µ)
                const curMarketingPrice = item.marketing_price || 0;
                const prevMarketingPrice = prevItem?.marketing_price || 0;
                const marketingPriceDiff = (prevItem && prevItem.marketing_price !== null && prevItem.marketing_price !== undefined && item.marketing_price !== null && item.marketing_price !== undefined && item.marketing_price > 0) ? curMarketingPrice - prevMarketingPrice : null;
                let marketingPriceDiffHtml = '';
                if (marketingPriceDiff !== null && marketingPriceDiff !== 0) {
                    const diffColor = marketingPriceDiff < 0 ? '#22c55e' : '#ef4444'; // –ú–µ–Ω—å—à–µ = –ª—É—á—à–µ
                    const diffSign = marketingPriceDiff > 0 ? '+' : '';
                    marketingPriceDiffHtml = `<br><span style="font-size: 11px; color: ${diffColor}; font-weight: 400;">${diffSign}${formatNumber(marketingPriceDiff)} ‚ÇΩ</span>`;
                }
                html += `<td><strong>${(item.marketing_price !== null && item.marketing_price !== undefined && item.marketing_price > 0) ? formatNumber(Math.round(item.marketing_price)) + ' ‚ÇΩ' : '‚Äî'}${(item.marketing_price !== null && item.marketing_price !== undefined && item.marketing_price > 0) ? getTrendArrow(item.marketing_price, prevItem?.marketing_price, true) : ''}</strong>${marketingPriceDiffHtml}</td>`;

                // –°—Ä. –ø–æ–∑–∏—Ü–∏—è (—Å —Å—Ç—Ä–µ–ª–∫–æ–π –∏ —Ä–∞–∑–Ω–∏—Ü–µ–π, –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –º–µ–Ω—å—à–µ = –ª—É—á—à–µ)
                const curPosition = item.avg_position || 0;
                const prevPosition = prevItem?.avg_position || 0;
                const positionDiff = (prevItem && prevItem.avg_position !== null && prevItem.avg_position !== undefined && item.avg_position !== null && item.avg_position !== undefined) ? curPosition - prevPosition : null;
                let positionDiffHtml = '';
                if (positionDiff !== null && positionDiff !== 0) {
                    const diffColor = positionDiff < 0 ? '#22c55e' : '#ef4444'; // –ú–µ–Ω—å—à–µ = –ª—É—á—à–µ
                    const diffSign = positionDiff > 0 ? '+' : '';
                    positionDiffHtml = `<br><span style="font-size: 11px; color: ${diffColor}; font-weight: 400;">${diffSign}${positionDiff.toFixed(1)}</span>`;
                }
                html += `<td><span class="position">${(item.avg_position !== null && item.avg_position !== undefined) ? item.avg_position.toFixed(1) : '‚Äî'}${(item.avg_position !== null && item.avg_position !== undefined) ? getTrendArrow(item.avg_position, prevItem?.avg_position, true) : ''}</span>${positionDiffHtml}</td>`;

                // –ü–æ–∫–∞–∑—ã (–ø–æ–∏—Å–∫+–∫–∞—Ç.) - —Å —Å—Ç—Ä–µ–ª–∫–æ–π –∏ —Ä–∞–∑–Ω–∏—Ü–µ–π –æ—Ç –ø—Ä–æ—à–ª–æ–≥–æ –¥–Ω—è
                const curViews = item.hits_view_search || 0;
                const prevViews = prevItem?.hits_view_search || 0;
                const viewsDiff = (prevItem && prevItem.hits_view_search !== null && prevItem.hits_view_search !== undefined) ? curViews - prevViews : null;
                let viewsDiffHtml = '';
                if (viewsDiff !== null && viewsDiff !== 0) {
                    const diffColor = viewsDiff > 0 ? '#22c55e' : '#ef4444';
                    const diffSign = viewsDiff > 0 ? '+' : '';
                    viewsDiffHtml = `<br><span style="font-size: 11px; color: ${diffColor}; font-weight: 400;">${diffSign}${formatNumber(viewsDiff)}</span>`;
                }
                html += `<td><strong>${formatNumber(curViews)}${getTrendArrow(item.hits_view_search, prevItem?.hits_view_search)}</strong>${viewsDiffHtml}</td>`;

                // –ü–æ—Å–µ—â–µ–Ω–∏—è - —Å —Å—Ç—Ä–µ–ª–∫–æ–π –∏ —Ä–∞–∑–Ω–∏—Ü–µ–π
                const curPdp = item.hits_view_search_pdp || 0;
                const prevPdp = prevItem?.hits_view_search_pdp || 0;
                const pdpDiff = (prevItem && prevItem.hits_view_search_pdp !== null && prevItem.hits_view_search_pdp !== undefined) ? curPdp - prevPdp : null;
                let pdpDiffHtml = '';
                if (pdpDiff !== null && pdpDiff !== 0) {
                    const diffColor = pdpDiff > 0 ? '#22c55e' : '#ef4444'; // –ë–æ–ª—å—à–µ = –ª—É—á—à–µ
                    const diffSign = pdpDiff > 0 ? '+' : '';
                    pdpDiffHtml = `<br><span style="font-size: 11px; color: ${diffColor}; font-weight: 400;">${diffSign}${formatNumber(pdpDiff)}</span>`;
                }
                html += `<td><strong>${formatNumber(item.hits_view_search_pdp || 0)}${getTrendArrow(item.hits_view_search_pdp, prevItem?.hits_view_search_pdp)}</strong>${pdpDiffHtml}</td>`;

                // CTR (%) - —Å —Å—Ç—Ä–µ–ª–∫–æ–π –∏ —Ä–∞–∑–Ω–∏—Ü–µ–π
                const curCtr = item.search_ctr || 0;
                const prevCtr = prevItem?.search_ctr || 0;
                const ctrDiff = (prevItem && prevItem.search_ctr !== null && prevItem.search_ctr !== undefined && item.search_ctr !== null && item.search_ctr !== undefined) ? curCtr - prevCtr : null;
                let ctrDiffHtml = '';
                if (ctrDiff !== null && ctrDiff !== 0) {
                    const diffColor = ctrDiff > 0 ? '#22c55e' : '#ef4444'; // –ë–æ–ª—å—à–µ = –ª—É—á—à–µ
                    const diffSign = ctrDiff > 0 ? '+' : '';
                    ctrDiffHtml = `<br><span style="font-size: 11px; color: ${diffColor}; font-weight: 400;">${diffSign}${ctrDiff.toFixed(2)}%</span>`;
                }
                html += `<td><strong>${(item.search_ctr !== null && item.search_ctr !== undefined) ? item.search_ctr.toFixed(2) + '%' : '‚Äî'}${(item.search_ctr !== null && item.search_ctr !== undefined) ? getTrendArrow(item.search_ctr, prevItem?.search_ctr) : ''}</strong>${ctrDiffHtml}</td>`;

                // –ö–æ—Ä–∑–∏–Ω–∞ - —Å —Å—Ç—Ä–µ–ª–∫–æ–π –∏ —Ä–∞–∑–Ω–∏—Ü–µ–π
                const curCart = item.hits_add_to_cart || 0;
                const prevCart = prevItem?.hits_add_to_cart || 0;
                const cartDiff = (prevItem && prevItem.hits_add_to_cart !== null && prevItem.hits_add_to_cart !== undefined) ? curCart - prevCart : null;
                let cartDiffHtml = '';
                if (cartDiff !== null && cartDiff !== 0) {
                    const diffColor = cartDiff > 0 ? '#22c55e' : '#ef4444'; // –ë–æ–ª—å—à–µ = –ª—É—á—à–µ
                    const diffSign = cartDiff > 0 ? '+' : '';
                    cartDiffHtml = `<br><span style="font-size: 11px; color: ${diffColor}; font-weight: 400;">${diffSign}${formatNumber(cartDiff)}</span>`;
                }
                html += `<td><strong>${formatNumber(item.hits_add_to_cart || 0)}${getTrendArrow(item.hits_add_to_cart, prevItem?.hits_add_to_cart)}</strong>${cartDiffHtml}</td>`;

                // CR1 (%) - —Å —Å—Ç—Ä–µ–ª–∫–æ–π –∏ —Ä–∞–∑–Ω–∏—Ü–µ–π
                const curCr1 = item.cr1 || 0;
                const prevCr1 = prevItem?.cr1 || 0;
                const cr1Diff = (prevItem && prevItem.cr1 !== null && prevItem.cr1 !== undefined && item.cr1 !== null && item.cr1 !== undefined) ? curCr1 - prevCr1 : null;
                let cr1DiffHtml = '';
                if (cr1Diff !== null && cr1Diff !== 0) {
                    const diffColor = cr1Diff > 0 ? '#22c55e' : '#ef4444'; // –ë–æ–ª—å—à–µ = –ª—É—á—à–µ
                    const diffSign = cr1Diff > 0 ? '+' : '';
                    cr1DiffHtml = `<br><span style="font-size: 11px; color: ${diffColor}; font-weight: 400;">${diffSign}${cr1Diff.toFixed(2)}%</span>`;
                }
                html += `<td><strong>${(item.cr1 !== null && item.cr1 !== undefined) ? item.cr1.toFixed(2) + '%' : '‚Äî'}${(item.cr1 !== null && item.cr1 !== undefined) ? getTrendArrow(item.cr1, prevItem?.cr1) : ''}</strong>${cr1DiffHtml}</td>`;

                // CR2 (%) - —Å —Å—Ç—Ä–µ–ª–∫–æ–π –∏ —Ä–∞–∑–Ω–∏—Ü–µ–π
                const curCr2 = item.cr2 || 0;
                const prevCr2 = prevItem?.cr2 || 0;
                const cr2Diff = (prevItem && prevItem.cr2 !== null && prevItem.cr2 !== undefined && item.cr2 !== null && item.cr2 !== undefined) ? curCr2 - prevCr2 : null;
                let cr2DiffHtml = '';
                if (cr2Diff !== null && cr2Diff !== 0) {
                    const diffColor = cr2Diff > 0 ? '#22c55e' : '#ef4444'; // –ë–æ–ª—å—à–µ = –ª—É—á—à–µ
                    const diffSign = cr2Diff > 0 ? '+' : '';
                    cr2DiffHtml = `<br><span style="font-size: 11px; color: ${diffColor}; font-weight: 400;">${diffSign}${cr2Diff.toFixed(2)}%</span>`;
                }
                html += `<td><strong>${(item.cr2 !== null && item.cr2 !== undefined) ? item.cr2.toFixed(2) + '%' : '‚Äî'}${(item.cr2 !== null && item.cr2 !== undefined) ? getTrendArrow(item.cr2, prevItem?.cr2) : ''}</strong>${cr2DiffHtml}</td>`;

                // –†–∞—Å—Ö–æ–¥—ã - —Å —Å—Ç—Ä–µ–ª–∫–æ–π –∏ —Ä–∞–∑–Ω–∏—Ü–µ–π (–º–µ–Ω—å—à–µ = –ª—É—á—à–µ)
                const curSpend = item.adv_spend || 0;
                const prevSpend = prevItem?.adv_spend || 0;
                const spendDiff = (prevItem && prevItem.adv_spend !== null && prevItem.adv_spend !== undefined && item.adv_spend !== null && item.adv_spend !== undefined) ? curSpend - prevSpend : null;
                let spendDiffHtml = '';
                if (spendDiff !== null && spendDiff !== 0) {
                    const diffColor = spendDiff < 0 ? '#22c55e' : '#ef4444'; // –ú–µ–Ω—å—à–µ = –ª—É—á—à–µ
                    const diffSign = spendDiff > 0 ? '+' : '';
                    spendDiffHtml = `<br><span style="font-size: 11px; color: ${diffColor}; font-weight: 400;">${diffSign}${formatNumber(Math.round(spendDiff))} ‚ÇΩ</span>`;
                }
                html += `<td><strong>${(item.adv_spend !== null && item.adv_spend !== undefined) ? formatNumber(Math.round(item.adv_spend)) + ' ‚ÇΩ' : '‚Äî'}${(item.adv_spend !== null && item.adv_spend !== undefined) ? getTrendArrow(item.adv_spend, prevItem?.adv_spend) : ''}</strong>${spendDiffHtml}</td>`;

                // CPO –ø–ª–∞–Ω (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ –ø–æ–ª–µ, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ó–∞–∫–∞–∑—ã –ø–ª–∞–Ω)
                // –ï—Å–ª–∏ —É —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –Ω–µ—Ç –ø–ª–∞–Ω–∞ ‚Äî –∏—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                let cpoPlanValue = '';
                if (item.cpo_plan !== null && item.cpo_plan !== undefined) {
                    cpoPlanValue = item.cpo_plan;
                } else {
                    // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é —Å—Ç–∞—Ä—É—é –∑–∞–ø–∏—Å—å —Å –Ω–µ–ø—É—Å—Ç—ã–º cpo_plan
                    for (let k = index + 1; k < data.history.length; k++) {
                        const olderItem = data.history[k];
                        if (olderItem.cpo_plan !== null && olderItem.cpo_plan !== undefined) {
                            cpoPlanValue = olderItem.cpo_plan;
                            break;
                        }
                    }
                }
                const cpoPlanInputId = `cpo_plan_${data.product_sku}_${item.snapshot_date}`;

                // CPO (Cost Per Order) - —Ä–∞—Å—Ö–æ–¥—ã/–∑–∞–∫–∞–∑—ã
                const cpo = (item.adv_spend !== null && item.adv_spend !== undefined && item.orders_qty > 0)
                    ? Math.round(item.adv_spend / item.orders_qty)
                    : null;

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç —è—á–µ–π–∫–∏ CPO –ø–ª–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–∞ –∏ —Ñ–∞–∫—Ç–∞ CPO
                // –î–ª—è CPO: –º–µ–Ω—å—à–µ = –ª—É—á—à–µ, –ø–æ—ç—Ç–æ–º—É –µ—Å–ª–∏ —Ñ–∞–∫—Ç < –ø–ª–∞–Ω ‚Äî –∑–µ–ª—ë–Ω—ã–π (—Ö–æ—Ä–æ—à–æ)
                let cpoPlanBgColor = '#f5f5f5'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–ª–µ–¥–Ω–æ-—Å–µ—Ä—ã–π
                const planCpo = parseInt(cpoPlanValue) || 0;
                const actualCpo = cpo || 0;

                if (cpoPlanValue !== '' && planCpo > 0 && cpo !== null) {
                    if (actualCpo > planCpo) {
                        cpoPlanBgColor = '#ffe5e5'; // –ë–ª–µ–¥–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π (CPO –≤—ã—à–µ –ø–ª–∞–Ω–∞ ‚Äî –ø–ª–æ—Ö–æ)
                    } else if (actualCpo < planCpo) {
                        cpoPlanBgColor = '#e5ffe5'; // –ë–ª–µ–¥–Ω–æ-–∑–µ–ª–µ–Ω—ã–π (CPO –Ω–∏–∂–µ –ø–ª–∞–Ω–∞ ‚Äî —Ö–æ—Ä–æ—à–æ)
                    }
                }

                html += `<td class="plan-cell" style="background-color: ${cpoPlanBgColor} !important;">
                    <input
                        type="text"
                        id="${cpoPlanInputId}"
                        value="${cpoPlanValue}"
                        style="width: 60px; padding: 4px; text-align: center; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; background-color: ${isPast ? '#e5e5e5' : '#fff'};"
                        ${isPast ? 'readonly' : ''}
                        oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                        onblur="saveCpoPlan('${data.product_sku}', '${item.snapshot_date}', this.value)"
                    />
                </td>`;

                // CPO (Cost Per Order) - —Å —Å—Ç—Ä–µ–ª–∫–æ–π –∏ —Ä–∞–∑–Ω–∏—Ü–µ–π (–º–µ–Ω—å—à–µ = –ª—É—á—à–µ)
                const prevCpo = (prevItem?.adv_spend !== null && prevItem?.adv_spend !== undefined && prevItem?.orders_qty > 0)
                    ? Math.round(prevItem.adv_spend / prevItem.orders_qty)
                    : null;
                const cpoDiff = (cpo !== null && prevCpo !== null) ? cpo - prevCpo : null;
                let cpoDiffHtml = '';
                if (cpoDiff !== null && cpoDiff !== 0) {
                    const diffColor = cpoDiff < 0 ? '#22c55e' : '#ef4444'; // –ú–µ–Ω—å—à–µ = –ª—É—á—à–µ
                    const diffSign = cpoDiff > 0 ? '+' : '';
                    cpoDiffHtml = `<br><span style="font-size: 11px; color: ${diffColor}; font-weight: 400;">${diffSign}${cpoDiff} ‚ÇΩ</span>`;
                }
                html += `<td><strong>${cpo !== null ? cpo + ' ‚ÇΩ' : '‚Äî'}${cpo !== null ? getTrendArrow(cpo, prevCpo, true) : ''}</strong>${cpoDiffHtml}</td>`;

                // –î–†–† (–î–æ–ª—è –†–µ–∫–ª–∞–º–Ω—ã—Ö –†–∞—Å—Ö–æ–¥–æ–≤) = (–†–∞—Å—Ö–æ–¥—ã / (–ó–∞–∫–∞–∑—ã √ó –¶–µ–Ω–∞)) √ó 100%
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º marketing_price (—Ü–µ–Ω–∞ –Ω–∞ —Å–∞–π—Ç–µ) –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –≤—ã—Ä—É—á–∫–∏
                const revenue = (item.orders_qty || 0) * (item.marketing_price || 0);
                const drr = (item.adv_spend !== null && item.adv_spend !== undefined && revenue > 0)
                    ? ((item.adv_spend / revenue) * 100)
                    : null;
                const prevRevenue = (prevItem?.orders_qty || 0) * (prevItem?.marketing_price || 0);
                const prevDrr = (prevItem?.adv_spend !== null && prevItem?.adv_spend !== undefined && prevRevenue > 0)
                    ? ((prevItem.adv_spend / prevRevenue) * 100)
                    : null;
                const drrDiff = (drr !== null && prevDrr !== null) ? drr - prevDrr : null;
                let drrDiffHtml = '';
                if (drrDiff !== null && drrDiff !== 0) {
                    const diffColor = drrDiff < 0 ? '#22c55e' : '#ef4444'; // –ú–µ–Ω—å—à–µ = –ª—É—á—à–µ
                    const diffSign = drrDiff > 0 ? '+' : '';
                    drrDiffHtml = `<br><span style="font-size: 11px; color: ${diffColor}; font-weight: 400;">${diffSign}${drrDiff.toFixed(1)}%</span>`;
                }
                html += `<td><strong>${drr !== null ? drr.toFixed(1) + '%' : '‚Äî'}${drr !== null ? getTrendArrow(drr, prevDrr, true) : ''}</strong>${drrDiffHtml}</td>`;

                // –í –ü–£–¢–ò - —Ç–æ–≤–∞—Ä—ã –∏–∑ –∑–∞—è–≤–æ–∫ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–≤ –ø—É—Ç–∏"
                html += `<td><span class="stock">${formatNumber(item.in_transit || 0)}</span></td>`;

                // –í –ó–ê–Ø–í–ö–ê–• - —Ç–æ–≤–∞—Ä—ã –∏–∑ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤/–Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫
                html += `<td><span class="stock">${formatNumber(item.in_draft || 0)}</span></td>`;

                html += `</tr>`;
            });
            
            html += '</tbody></table>';
            
            // –û–±–≤–æ—Ä–∞—á–∏–≤–∞—é —Ç–∞–±–ª–∏—Ü—É –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞
            const fullHtml = `
                <div class="table-controls">
                    <span style="font-weight: 600; margin-right: 8px;">–í–∏–¥–∏–º—ã–µ —Å—Ç–æ–ª–±—Ü—ã:</span>
                    <button class="toggle-col-btn" onclick="toggleColumn(0)">–¢–µ–≥</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(1)">–ó–∞–º–µ—Ç–∫–∏</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(2)">–î–∞—Ç–∞</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(3)">–ù–∞–∑–≤–∞–Ω–∏–µ</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(4)">SKU</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(5)">–†–µ–π—Ç–∏–Ω–≥</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(6)">–û—Ç–∑—ã–≤—ã</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(7)">–ò–Ω–¥–µ–∫—Å —Ü–µ–Ω</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(8)">FBO</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(9)">–ó–∞–∫–∞–∑—ã</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(10)">–ó–∞–∫–∞–∑—ã –ø–ª–∞–Ω</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(11)">–¶–µ–Ω–∞ –≤ –õ–ö</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(12)">–¶–µ–Ω–∞ –ø–ª–∞–Ω</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(13)">–°–æ–∏–Ω–≤–µ—Å—Ç</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(14)">–¶–µ–Ω–∞ –Ω–∞ —Å–∞–π—Ç–µ</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(15)">–°—Ä. –ø–æ–∑–∏—Ü–∏—è</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(16)">–ü–æ–∫–∞–∑—ã</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(17)">–ü–æ—Å–µ—â–µ–Ω–∏—è</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(18)">CTR</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(19)">–ö–æ—Ä–∑–∏–Ω–∞</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(20)">CR1</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(21)">CR2</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(22)">–†–∞—Å—Ö–æ–¥—ã</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(23)">CPO –ø–ª–∞–Ω</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(24)">CPO</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(25)">–î–†–†</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(26)">–í –ø—É—Ç–∏</button>
                    <button class="toggle-col-btn" onclick="toggleColumn(27)">–í –∑–∞—è–≤–∫–∞—Ö</button>
                    <div style="margin-top: 8px; display: flex; align-items: center; flex-wrap: wrap; gap: 4px;">
                        <span style="font-weight: 600; margin-right: 4px;">–¢–µ–≥–∏:</span>
                        <span class="tag-badge tag-badge-filter tag-samovykup" id="filter-tag-–°–∞–º–æ–≤—ã–∫—É–ø" onclick="toggleTagFilter('–°–∞–º–æ–≤—ã–∫—É–ø')">–°–∞–º–æ–≤—ã–∫—É–ø</span>
                        <span class="tag-badge tag-badge-filter tag-mediana" id="filter-tag-–ú–µ–¥–∏–∞–Ω–∞" onclick="toggleTagFilter('–ú–µ–¥–∏–∞–Ω–∞')">–ú–µ–¥–∏–∞–Ω–∞</span>
                        <span class="tag-badge tag-badge-filter tag-reklama" id="filter-tag-–†–µ–∫–ª–∞–º–∞" onclick="toggleTagFilter('–†–µ–∫–ª–∞–º–∞')">–†–µ–∫–ª–∞–º–∞</span>
                        <span class="tag-badge tag-badge-filter tag-cena" id="filter-tag-–¶–µ–Ω–∞" onclick="toggleTagFilter('–¶–µ–Ω–∞')">–¶–µ–Ω–∞</span>
                        <span class="tag-badge tag-badge-filter tag-akcii" id="filter-tag-–ê–∫—Ü–∏–∏" onclick="toggleTagFilter('–ê–∫—Ü–∏–∏')">–ê–∫—Ü–∏–∏</span>
                        <span class="tag-badge tag-badge-filter tag-test" id="filter-tag-–¢–µ—Å—Ç" onclick="toggleTagFilter('–¢–µ—Å—Ç')">–¢–µ—Å—Ç</span>
                    </div>
                </div>
                <div class="table-wrapper">
                    ${html}
                </div>
            `;
            
            historyContent.innerHTML = fullHtml;

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é –∏–∑–º–µ–Ω–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤
            initColumnResize();
        }

        // ============================================================================
        // –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ü–û –î–ê–¢–ï
        // ============================================================================

        /**
         * –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä—ã (–¥–∞—Ç–∞ + —Ç–µ–≥) –∫ –¥–∞–Ω–Ω—ã–º –∏—Å—Ç–æ—Ä–∏–∏.
         * –§–∏–ª—å—Ç—Ä—É–µ—Ç –∑–∞–ø–∏—Å–∏ –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç –∏ —Ç–µ–≥—É, –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É.
         */
        function applyDateFilter() {
            if (!currentHistoryData) return;

            const dateFrom = document.getElementById('date-from')?.value;
            const dateTo = document.getElementById('date-to')?.value;
            const resetBtn = document.getElementById('date-filter-reset-btn');

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —Å–±—Ä–æ—Å–∞
            if (resetBtn) {
                if (dateFrom || dateTo || activeTagFilter) {
                    resetBtn.classList.add('active');
                } else {
                    resetBtn.classList.remove('active');
                }
            }

            // –°–æ–∑–¥–∞—ë–º –∫–æ–ø–∏—é –¥–∞–Ω–Ω—ã—Ö —Å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π
            const filteredData = {
                ...currentHistoryData,
                history: currentHistoryData.history.filter(item => {
                    const itemDate = item.snapshot_date;
                    if (dateFrom && itemDate < dateFrom) return false;
                    if (dateTo && itemDate > dateTo) return false;

                    // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥—É (–∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π)
                    if (activeTagFilter) {
                        let itemTags = [];
                        try {
                            itemTags = item.tags ? JSON.parse(item.tags) : [];
                        } catch(e) { itemTags = []; }

                        if (!itemTags.includes(activeTagFilter)) return false;
                    }

                    return true;
                })
            };

            renderHistory(filteredData);
        }

        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥—É (–∫–ª–∏–∫ –ø–æ –±–µ–π–¥–∂—É –≤ –ª–µ–≥–µ–Ω–¥–µ).
         * –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∫–ª–∏–∫–µ –Ω–∞ —Ç–æ—Ç –∂–µ —Ç–µ–≥ - —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä.
         */
        function toggleTagFilter(tagName) {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –±–µ–π–¥–∂–µ–π
            document.querySelectorAll('.tag-badge-filter').forEach(el => {
                el.classList.remove('active-filter');
            });

            if (activeTagFilter === tagName) {
                // –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–ª–∏–∫ - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
                activeTagFilter = null;
            } else {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä
                activeTagFilter = tagName;
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –±–µ–π–¥–∂—É
                const badge = document.getElementById('filter-tag-' + tagName);
                if (badge) badge.classList.add('active-filter');
            }

            applyDateFilter();
        }

        /**
         * –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏.
         */
        function resetDateFilter() {
            if (!currentHistoryData) return;

            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
            const dateFromEl = document.getElementById('date-from');
            const dateToEl = document.getElementById('date-to');
            const resetBtn = document.getElementById('date-filter-reset-btn');

            if (dateFromEl) dateFromEl.value = '';
            if (dateToEl) dateToEl.value = '';
            if (resetBtn) resetBtn.classList.remove('active');

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥—É
            activeTagFilter = null;
            document.querySelectorAll('.tag-badge-filter').forEach(el => {
                el.classList.remove('active-filter');
            });

            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            renderHistory(currentHistoryData);
        }

        function startEditNote(uniqueId, sku, date) {
            document.getElementById(uniqueId + '_display').style.display = 'none';
            document.getElementById(uniqueId + '_editor').style.display = 'block';
            document.getElementById(uniqueId + '_textarea').focus();
        }

        function cancelEditNote(uniqueId) {
            document.getElementById(uniqueId + '_display').style.display = 'flex';
            document.getElementById(uniqueId + '_editor').style.display = 'none';
        }

        function saveNote(uniqueId, sku, date) {
            const textarea = document.getElementById(uniqueId + '_textarea');
            const text = textarea.value;

            const payload = {
                sku: sku,
                date: date,
                notes: text
            };

            authFetch('/api/history/save-note', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    const displayEl = document.getElementById(uniqueId + '_display');
                    displayEl.innerHTML = text || '<span style="color: #bbb;">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å...</span>';

                    // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
                    document.getElementById(uniqueId + '_editor').style.display = 'none';
                    displayEl.style.display = 'flex';

                    console.log('‚úÖ –ó–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + data.error);
                }
            })
            .catch(error => {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error);
                console.error('–û—à–∏–±–∫–∞:', error);
            });
        }

        // ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤
        function saveOrdersPlan(sku, date, value) {
            const payload = {
                sku: parseInt(sku),
                date: date,
                orders_plan: value
            };

            authFetch('/api/history/save-orders-plan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úÖ –ü–ª–∞–Ω –∑–∞–∫–∞–∑–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + data.error);
                }
            })
            .catch(error => {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error);
                console.error('–û—à–∏–±–∫–∞:', error);
            });
        }

        // ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–æ–≤–æ–≥–æ CPO
        function saveCpoPlan(sku, date, value) {
            const payload = {
                sku: parseInt(sku),
                date: date,
                cpo_plan: value
            };

            authFetch('/api/history/save-cpo-plan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úÖ –ü–ª–∞–Ω CPO —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + data.error);
                }
            })
            .catch(error => {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error);
                console.error('–û—à–∏–±–∫–∞:', error);
            });
        }

        // ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–æ–≤–æ–π —Ü–µ–Ω—ã
        function savePricePlan(sku, date, value) {
            const payload = {
                sku: parseInt(sku),
                date: date,
                price_plan: value
            };

            authFetch('/api/history/save-price-plan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úÖ –ü–ª–∞–Ω —Ü–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + data.error);
                }
            })
            .catch(error => {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error);
                console.error('–û—à–∏–±–∫–∞:', error);
            });
        }

        // ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ–≥–æ–≤ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π)
        const TAG_CONFIG_GLOBAL = {
            '–°–∞–º–æ–≤—ã–∫—É–ø': { class: 'samovykup', color: '#7c3aed' },
            '–ú–µ–¥–∏–∞–Ω–∞': { class: 'mediana', color: '#ea580c' },
            '–†–µ–∫–ª–∞–º–∞': { class: 'reklama', color: '#dc2626' },
            '–¶–µ–Ω–∞': { class: 'cena', color: '#16a34a' },
            '–ê–∫—Ü–∏–∏': { class: 'akcii', color: '#ca8a04' },
            '–¢–µ—Å—Ç': { class: 'test', color: '#6b7280' }
        };

        // ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–≥–∞
        function addTag(tagId, sku, date, tagName) {
            if (!tagName) return;

            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Ç–µ–≥–∏ –∏–∑ –±–µ–π–¥–∂–µ–π
            const badgesContainer = document.getElementById(tagId + '_badges');
            const existingBadges = badgesContainer.querySelectorAll('.tag-badge');
            let currentTags = [];
            existingBadges.forEach(badge => {
                const text = badge.textContent.replace('√ó', '').trim();
                currentTags.push(text);
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —Ç–µ–≥
            if (currentTags.includes(tagName)) {
                return;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ç–µ–≥
            currentTags.push(tagName);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            saveTagsToServer(sku, date, currentTags, tagId);

            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updateTagsUI(tagId, currentTags, sku, date);
        }

        // ‚úÖ –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ–≥–∞
        function removeTag(tagId, sku, date, tagName) {
            // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–µ–≥ "${tagName}"?`)) return;

            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Ç–µ–≥–∏ –∏–∑ –±–µ–π–¥–∂–µ–π
            const badgesContainer = document.getElementById(tagId + '_badges');
            const existingBadges = badgesContainer.querySelectorAll('.tag-badge');
            let currentTags = [];
            existingBadges.forEach(badge => {
                const text = badge.textContent.replace('√ó', '').trim();
                if (text !== tagName) {
                    currentTags.push(text);
                }
            });

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            saveTagsToServer(sku, date, currentTags, tagId);

            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updateTagsUI(tagId, currentTags, sku, date);
        }

        // ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–≥–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        function saveTagsToServer(sku, date, tags, tagId) {
            const payload = {
                sku: parseInt(sku),
                date: date,
                tags: tags
            };

            authFetch('/api/history/save-tags', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úÖ –¢–µ–≥–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:', tags);
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç–µ–≥–æ–≤: ' + data.error);
                }
            })
            .catch(error => {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error);
                console.error('–û—à–∏–±–∫–∞:', error);
            });
        }

        // ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI —Ç–µ–≥–æ–≤
        function updateTagsUI(tagId, tags, sku, date) {
            const badgesContainer = document.getElementById(tagId + '_badges');
            const row = document.querySelector(`tr[data-row-id="${tagId}"]`);

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –±–µ–π–¥–∂–µ–π
            let badgesHtml = '';
            tags.forEach(t => {
                const cfg = TAG_CONFIG_GLOBAL[t] || { class: 'test', color: '#6b7280' };
                badgesHtml += `<span class="tag-badge tag-${cfg.class}" onclick="removeTag('${tagId}', ${sku}, '${date}', '${t}')">${t}<span class="tag-remove">√ó</span></span>`;
            });
            badgesContainer.innerHTML = badgesHtml;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –æ–∫—Ä–∞—à–∏–≤–∞–Ω–∏—è
            if (row) {
                // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã row-*
                row.className = row.className.replace(/row-\w+/g, '').trim();

                // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –ø–æ –ø–µ—Ä–≤–æ–º—É —Ç–µ–≥—É
                if (tags.length > 0) {
                    const firstTag = tags[0];
                    const cfg = TAG_CONFIG_GLOBAL[firstTag];
                    if (cfg) {
                        row.classList.add('row-' + cfg.class);
                    }
                }
            }
        }

        // ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è SKU –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        function copySKU(element, sku) {
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
            const showSuccess = () => {
                const originalColor = element.style.color;
                element.style.color = '#10b981'; // –ó–µ–ª–µ–Ω—ã–π
                element.style.fontWeight = 'bold';

                setTimeout(() => {
                    element.style.color = originalColor;
                    element.style.fontWeight = '';
                }, 1000);
            };

            // –ü—Ä–æ–±—É–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π API (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ HTTPS)
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(sku).then(() => {
                    showSuccess();
                    console.log('‚úÖ SKU —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω (clipboard API):', sku);
                }).catch(err => {
                    console.warn('Clipboard API –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º fallback:', err);
                    fallbackCopy(sku);
                });
            } else {
                // Fallback –¥–ª—è HTTP –∏–ª–∏ —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                fallbackCopy(sku);
            }

            // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ HTTP)
            function fallbackCopy(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();

                try {
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textarea);

                    if (successful) {
                        showSuccess();
                        console.log('‚úÖ SKU —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω (fallback):', text);
                    } else {
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å SKU');
                    }
                } catch (err) {
                    document.body.removeChild(textarea);
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏:', err);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ SKU: ' + err);
                }
            }
        }

        // ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Ç–æ–≤–∞—Ä–∞ –Ω–∞ Ozon
        function openProductOnOzon(sku) {
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–∏—Å–∫ –ø–æ SKU –Ω–∞ Ozon –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
            const url = `https://www.ozon.ru/search/?text=${sku}`;
            window.open(url, '_blank');
            console.log('üîó –û—Ç–∫—Ä—ã–≤–∞—é —Ç–æ–≤–∞—Ä –Ω–∞ Ozon, SKU:', sku);
        }

        // ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã–≤–∞–Ω–∏—è/–ø–æ–∫–∞–∑–∞ —Å—Ç–æ–ª–±—Ü–æ–≤
        function toggleColumn(colIndex) {
            const table = document.querySelector('table');
            if (!table) return;
            
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('th, td');
                if (cells[colIndex]) {
                    cells[colIndex].classList.toggle('col-hidden');
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è—é –∫–Ω–æ–ø–∫—É
            const buttons = document.querySelectorAll('.toggle-col-btn');
            if (buttons[colIndex - 1]) {
                buttons[colIndex - 1].classList.toggle('hidden');
            }
        }

        // ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–∞
        function initColumnResize() {
            const table = document.querySelector('table');
            if (!table) return;
            
            const headers = table.querySelectorAll('th');
            
            headers.forEach((header, index) => {
                // –î–æ–±–∞–≤–ª—è—é handle –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —à–∏—Ä–∏–Ω—ã
                const handle = document.createElement('div');
                handle.className = 'resize-handle';
                header.appendChild(handle);
                header.classList.add('resizable');
                
                // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–µ—Ä–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —à–∏—Ä–∏–Ω—É (–Ω–µ —Ñ–∏–∫—Å–∏—Ä—É–µ–º)
                // –ú–∏–Ω–∏–º—É–º 50px (CSS min-width)
                header.style.width = 'auto';
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
                let isResizing = false;
                let startX = 0;
                let startWidth = 0;
                
                handle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    startX = e.clientX;
                    startWidth = header.offsetWidth;
                    e.preventDefault();
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;
                    
                    const delta = e.clientX - startX;
                    const newWidth = Math.max(30, startWidth + delta);  // ‚úÖ –ú–∏–Ω–∏–º—É–º 30px –≤–º–µ—Å—Ç–æ 50px
                    
                    header.style.width = newWidth + 'px';
                    header.style.minWidth = newWidth + 'px';
                    
                    // –û–±–Ω–æ–≤–ª—è—é –≤—Å–µ td –≤ —ç—Ç–æ–º —Å—Ç–æ–ª–±—Ü–µ
                    const cells = table.querySelectorAll(`tbody tr td:nth-child(${index + 1})`);
                    cells.forEach(cell => {
                        cell.style.width = newWidth + 'px';
                        cell.style.minWidth = newWidth + 'px';
                    });
                });
                
                document.addEventListener('mouseup', () => {
                    isResizing = false;
                });
            });
        }
        // ============================================================
        // –ü–û–°–¢–ê–í–ö–ò ‚Äî –õ–û–ì–ò–ö–ê –í–ö–õ–ê–î–ö–ò
        // ============================================================

        let suppliesLoaded = false;
        let suppliesProducts = [];  // –í—Å–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
        let currentCnyRate = 0;     // –¢–µ–∫—É—â–∏–π –∫—É—Ä—Å —é–∞–Ω—è
        let vedProductLogistics = {}; // –î–∞–Ω–Ω—ã–µ –ª–æ–≥–∏—Å—Ç–∏–∫–∏ –∏–∑ –í–≠–î –ø–æ SKU: {sku: {avg_logistics_per_unit, total_quantity}}

        /**
         * –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤–∫–ª–∞–¥–∫–∏ "–ü–æ—Å—Ç–∞–≤–∫–∏":
         * 1. –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –¶–ë –†–§
         * 2. –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
         * 3. –î–∞–Ω–Ω—ã–µ –ª–æ–≥–∏—Å—Ç–∏–∫–∏ –∏–∑ –í–≠–î (—Å—Ä–µ–¥–Ω—è—è –ª–æ–≥–∏—Å—Ç–∏–∫–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É)
         * 4. –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å—Ç–∞–≤–æ–∫ –∏–∑ –±–∞–∑—ã
         */
        function loadSupplies() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç (–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –∑–∞–ø—Ä–æ—Å)
            fetch('/api/currency-rates')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const rates = data.rates;
                        currentCnyRate = rates.CNY || 0;

                        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫—É—Ä—Å–∞
                        recalcAllCosts();
                    }
                });

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã, –ª–æ–≥–∏—Å—Ç–∏–∫—É –í–≠–î –∏ –ø–æ—Å—Ç–∞–≤–∫–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
            const productsPromise = authFetch('/api/products/list')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        suppliesProducts = data.products;
                    }
                });

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ª–æ–≥–∏—Å—Ç–∏–∫–∏ –∏–∑ –í–≠–î
            const vedLogisticsPromise = authFetch('/api/ved/product-logistics')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        vedProductLogistics = data.logistics || {};
                    }
                });

            const suppliesPromise = authFetch('/api/supplies')
                .then(r => r.json());

            // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –í–°–ï –¥–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã
            Promise.all([productsPromise, vedLogisticsPromise, suppliesPromise]).then(([_, __, suppliesData]) => {
                if (suppliesData.success) {
                    renderSuppliesTable(suppliesData.supplies);
                }
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–≤–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                restoreSuppliesStatsState();
            });

            suppliesLoaded = true;
        }

        // ============================================================================
        // –í–≠–î - –í–ù–ï–®–ù–ï–≠–ö–û–ù–û–ú–ò–ß–ï–°–ö–ê–Ø –î–ï–Ø–¢–ï–õ–¨–ù–û–°–¢–¨
        // ============================================================================

        let vedDataLoaded = false;
        let vedContainerItemCounter = 0;
        let vedCnyRate = 0;              // –¢–µ–∫—É—â–∏–π –æ–Ω–ª–∞–π–Ω –∫—É—Ä—Å —é–∞–Ω—è —Å –¶–ë
        let vedEditingCnyRate = null;    // –ö—É—Ä—Å —é–∞–Ω—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (null = –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–Ω–ª–∞–π–Ω)
        let vedEditingIsCompleted = false; // –§–ª–∞–≥: —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–≤–µ—Ä—à—ë–Ω
        let vedProducts = [];  // –¢–æ–≤–∞—Ä—ã –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
        let vedSuppliers = []; // –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞

        /**
         * –û–±–Ω–æ–≤–∏—Ç—å –∫—É—Ä—Å —é–∞–Ω—è —Å —Å–µ—Ä–≤–µ—Ä–∞ (–¶–ë –†–§).
         * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏ –í–≠–î –∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞,
         * —á—Ç–æ–±—ã –∫—É—Ä—Å –≤—Å–µ–≥–¥–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª —Ç–µ–∫—É—â–µ–º—É –¥–Ω—é.
         */
        function refreshVedCnyRate() {
            fetch('/api/currency-rates')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const rates = data.rates;
                        vedCnyRate = rates.CNY || 0;
                        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                        if (vedEditingCnyRate === null) {
                            const rateElement = document.getElementById('ved-rate-cny');
                            if (rateElement) {
                                rateElement.textContent = formatCurrencyRate(rates.CNY);
                                rateElement.title = '–ê–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –¶–ë –†–§';
                            }
                        }
                    }
                })
                .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–∞ —é–∞–Ω—è:', err));
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤–∫–ª–∞–¥–∫–∏ "–í–≠–î"
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç, —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
         */
        function loadVed() {
            // –ö—É—Ä—Å —é–∞–Ω—è –æ–±–Ω–æ–≤–ª—è–µ–º –í–°–ï–ì–î–ê –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –í–≠–î (–Ω–µ –∫—ç—à–∏—Ä—É–µ–º –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ)
            refreshVedCnyRate();

            if (vedDataLoaded) return;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ (–∫–∞–∫ –≤ –û–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–∏)
            authFetch('/api/products/list')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        vedProducts = data.products;
                        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
                        initVedContainerForm();
                        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–æ–≤–∞—Ä—É
                        const filterSelect = document.getElementById('ved-containers-product-filter');
                        if (filterSelect) {
                            vedProducts.forEach(p => {
                                const opt = document.createElement('option');
                                opt.value = p.sku;
                                opt.textContent = p.offer_id || p.sku;
                                filterSelect.appendChild(opt);
                            });
                        }
                    }
                })
                .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –í–≠–î:', err));

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
            authFetch('/api/ved/suppliers')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        vedSuppliers = data.suppliers;
                    }
                })
                .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –í–≠–î:', err));

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            loadVedContainersHistory();

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
            loadContainerMessageRecipients();

            vedDataLoaded = true;
        }

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –í–≠–î
         */
        function initVedContainerForm() {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('ved-container-date');
            if (dateInput) dateInput.value = today;

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É —Ç–æ–≤–∞—Ä–∞
            if (document.getElementById('ved-container-items-tbody').children.length === 0) {
                addVedContainerItemRow();
            }
        }

        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥–≤–∫–ª–∞–¥–æ–∫ –í–≠–î
         */
        function switchVedSubtab(e, subtab) {
            document.querySelectorAll('.ved-subtab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.ved-subtab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(subtab).classList.add('active');
            e.target.classList.add('active');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥–≤–∫–ª–∞–¥–∫–∏
            if (subtab === 'ved-receipts') {
                loadVedReceipts();
            } else if (subtab === 'ved-containers') {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
                loadContainerMessageRecipients();
            } else if (subtab === 'ved-supplies') {
                loadSupplies();
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–¥–≤–∫–ª–∞–¥–∫—É –≤ URL hash (—Ñ–æ—Ä–º–∞—Ç: ved:subtab)
            location.hash = 'ved:' + subtab;
        }

        /**
         * –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–≤–∫–ª–∞–¥–∫—É –í–≠–î –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ (–±–µ–∑ —Å–æ–±—ã—Ç–∏—è –∫–ª–∏–∫–∞)
         */
        function activateVedSubtab(subtab) {
            document.querySelectorAll('.ved-subtab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.ved-subtab-button').forEach(el => el.classList.remove('active'));

            const subtabContent = document.getElementById(subtab);
            if (subtabContent) {
                subtabContent.classList.add('active');
            }

            document.querySelectorAll('.ved-subtab-button').forEach(btn => {
                if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes("'" + subtab + "'")) {
                    btn.classList.add('active');
                }
            });

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥–≤–∫–ª–∞–¥–∫–∏
            if (subtab === 'ved-receipts') {
                loadVedReceipts();
            } else if (subtab === 'ved-containers') {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
                loadContainerMessageRecipients();
            } else if (subtab === 'ved-supplies') {
                loadSupplies();
            }
        }

        /**
         * –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –í–≠–î
         */
        function addVedContainerItemRow() {
            vedContainerItemCounter++;
            const tbody = document.getElementById('ved-container-items-tbody');
            const row = document.createElement('tr');
            row.id = 'ved-container-item-' + vedContainerItemCounter;

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
            let productOptions = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä ‚Äî</option>';
            vedProducts.forEach(p => {
                productOptions += `<option value="${p.sku}">${p.offer_id || p.sku}</option>`;
            });

            row.innerHTML = `
                <td>${vedContainerItemCounter}</td>
                <td>
                    <select class="wh-select ved-container-product" style="width: 100%;"
                        onchange="updateVedContainerTotals(); debouncedFetchFifoPlanCost(this.closest('tr'))">
                        ${productOptions}
                    </select>
                </td>
                <td><input type="number" class="wh-input ved-container-qty" value="" min="1" placeholder="0"
                    oninput="updateVedContainerTotals(); debouncedFetchFifoPlanCost(this.closest('tr'))"></td>
                <td><input type="number" class="wh-input ved-container-price" value="" min="0" step="0.01" placeholder="‚Äî" readonly
                    style="background: #f5f5f5; cursor: default;" title="–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –ø–ª–∞–Ω–∞ (FIFO)"></td>
                <td class="ved-container-supplier-sum" style="font-weight: 500;">0 ¬•</td>
                <td class="ved-container-cost" style="font-weight: 500;">0 ‚ÇΩ</td>
                <td><span class="ved-container-cost-readonly ved-container-logrf" data-value="0">0</span></td>
                <td><span class="ved-container-cost-readonly ved-container-logcn" data-value="0">0</span></td>
                <td><span class="ved-container-cost-readonly ved-container-terminal" data-value="0">0</span></td>
                <td><span class="ved-container-cost-readonly ved-container-customs" data-value="0">0</span></td>
                <td class="ved-container-alllog" style="font-weight: 500;">0 ‚ÇΩ</td>
                <td><button class="wh-remove-btn" onclick="removeVedContainerItemRow(${vedContainerItemCounter})">√ó</button></td>
            `;
            tbody.appendChild(row);
        }

        /**
         * –£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –í–≠–î (—á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É —Å –≤–≤–æ–¥–æ–º "—É–¥–∞–ª–∏—Ç—å")
         */
        function removeVedContainerItemRow(id) {
            showDeleteConfirmModal(
                '–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É —Ç–æ–≤–∞—Ä–∞ ‚Ññ' + id + ' –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.',
                function() {
                    const row = document.getElementById('ved-container-item-' + id);
                    if (row) row.remove();
                    updateVedContainerTotals();
                    renumberVedContainerItems();
                }
            );
        }

        /**
         * –ü–µ—Ä–µ–Ω—É–º–µ—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –í–≠–î
         */
        function renumberVedContainerItems() {
            const rows = document.querySelectorAll('#ved-container-items-tbody tr');
            rows.forEach((row, index) => {
                row.querySelector('td:first-child').textContent = index + 1;
            });
        }

        /**
         * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–∞ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –º–µ–∂–¥—É —Ç—ã—Å—è—á–Ω—ã–º–∏ –∏ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –Ω—É–ª–µ–π –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏
         */
        function formatVedNumber(num, suffix = '') {
            if (num === 0) return '0' + (suffix ? ' ' + suffix : '');
            // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ —Ü–µ–ª–æ–≥–æ –µ—Å–ª–∏ –¥—Ä–æ–±–Ω–∞—è —á–∞—Å—Ç—å .00
            const rounded = Math.round(num * 100) / 100;
            const isWhole = rounded === Math.floor(rounded);
            const formatted = isWhole
                ? Math.floor(rounded).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ')
                : rounded.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            return formatted + (suffix ? ' ' + suffix : '');
        }

        /**
         * –û–±–Ω–æ–≤–∏—Ç—å –∏—Ç–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –í–≠–î
         */
        function updateVedContainerTotals() {
            let totalQty = 0;
            let totalSupplier = 0;
            let totalLogRf = 0;
            let totalLogCn = 0;
            let totalTerminal = 0;
            let totalCost = 0;
            let totalCustoms = 0;
            let totalAllLog = 0;

            document.querySelectorAll('#ved-container-items-tbody tr').forEach(row => {
                const qty = parseFloat(row.querySelector('.ved-container-qty')?.value) || 0;
                const price = parseFloat(row.querySelector('.ved-container-price')?.value) || 0;
                const supplierSum = qty * price;
                // –õ–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è: span (read-only) –∏–ª–∏ input (–¥–ª—è —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤)
                const logRfEl = row.querySelector('.ved-container-logrf');
                const logCnEl = row.querySelector('.ved-container-logcn');
                const terminalEl = row.querySelector('.ved-container-terminal');
                const customsEl = row.querySelector('.ved-container-customs');
                const logRf = parseFloat(logRfEl?.getAttribute('data-value') || logRfEl?.value) || 0;
                const logCn = parseFloat(logCnEl?.getAttribute('data-value') || logCnEl?.value) || 0;
                const terminal = parseFloat(terminalEl?.getAttribute('data-value') || terminalEl?.value) || 0;
                const customs = parseFloat(customsEl?.getAttribute('data-value') || customsEl?.value) || 0;

                // –í—Å—è –ª–æ–≥–∏—Å—Ç–∏–∫–∞ = –õ–æ–≥–∏—Å—Ç–∏–∫–∞ –†–§ + –õ–æ–≥–∏—Å—Ç–∏–∫–∞ –ö–ù–† + –¢–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã + –ü–æ—à–ª–∏–Ω–∞ –∏ –ù–î–°
                const allLog = logRf + logCn + terminal + customs;

                // –ü—Ä–æ—Ü–µ–Ω—Ç –∫ –ø–µ—Ä–µ–≤–æ–¥—É (–Ω–∞–¥–±–∞–≤–∫–∞ –∫ –∫—É—Ä—Å—É –¶–ë)
                const cnyPercent = parseFloat(document.getElementById('ved-cny-percent')?.value) || 0;
                // –î–ª—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫—É—Ä—Å, –¥–ª—è –Ω–æ–≤—ã—Ö ‚Äî –æ–Ω–ª–∞–π–Ω
                const baseCnyRate = vedEditingCnyRate !== null ? vedEditingCnyRate : vedCnyRate;
                const adjustedCnyRate = baseCnyRate * (1 + cnyPercent / 100);

                // –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä—É–± = —Ü–µ–Ω–∞ —à—Ç. * —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫—É—Ä—Å —é–∞–Ω—è * –∫–æ–ª-–≤–æ
                const cost = price * adjustedCnyRate * qty;

                const supplierCell = row.querySelector('.ved-container-supplier-sum');
                if (supplierCell) supplierCell.textContent = formatVedNumber(supplierSum, '¬•');

                const costCell = row.querySelector('.ved-container-cost');
                if (costCell) costCell.textContent = formatVedNumber(cost, '‚ÇΩ');

                const allLogCell = row.querySelector('.ved-container-alllog');
                if (allLogCell) allLogCell.textContent = formatVedNumber(allLog, '‚ÇΩ');

                totalQty += qty;
                totalSupplier += supplierSum;
                totalLogRf += logRf;
                totalLogCn += logCn;
                totalTerminal += terminal;
                totalCost += cost;
                totalCustoms += customs;
                totalAllLog += allLog;
            });

            document.getElementById('ved-container-total-qty').textContent = formatVedNumber(totalQty);
            document.getElementById('ved-container-total-supplier').textContent = formatVedNumber(totalSupplier, '¬•');
            document.getElementById('ved-container-total-cost').textContent = formatVedNumber(totalCost, '‚ÇΩ');
            document.getElementById('ved-container-total-logrf').textContent = formatVedNumber(totalLogRf, '‚ÇΩ');
            document.getElementById('ved-container-total-logcn').textContent = formatVedNumber(totalLogCn, '‚ÇΩ');
            document.getElementById('ved-container-total-terminal').textContent = formatVedNumber(totalTerminal, '‚ÇΩ');
            document.getElementById('ved-container-total-customs').textContent = formatVedNumber(totalCustoms, '‚ÇΩ');
            document.getElementById('ved-container-total-alllog').textContent = formatVedNumber(totalAllLog, '‚ÇΩ');
        }

        // ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ (null = –Ω–æ–≤—ã–π)
        let editingVedContainerId = null;

        // ‚îÄ‚îÄ –ê–≤—Ç–æ-–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏–∑ –ø–ª–∞–Ω–∞ (FIFO) ‚îÄ‚îÄ

        let _fifoCostTimers = {};  // –¢–∞–π–º–µ—Ä—ã debounce –ø–æ id —Å—Ç—Ä–æ–∫–∏

        /**
         * –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ —à—Ç—É–∫—É –∏–∑ –ø–ª–∞–Ω–∞ –ø–æ FIFO.
         * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª-–≤–∞.
         * –ü–æ–ª–µ —Ü–µ–Ω—ã read-only ‚Äî –≤—Å–µ–≥–¥–∞ –±–µ—Ä—ë—Ç—Å—è –∏–∑ –ø–ª–∞–Ω–∞.
         */
        async function fetchFifoPlanCost(row) {
            const select = row.querySelector('.ved-container-product');
            const qtyInput = row.querySelector('.ved-container-qty');
            const priceInput = row.querySelector('.ved-container-price');

            const sku = parseInt(select?.value) || 0;
            const qty = parseInt(qtyInput?.value) || 0;

            if (!sku || qty <= 0) return;

            // –°—á–∏—Ç–∞–µ–º –∫–æ–ª-–≤–æ —Ç–æ–≥–æ –∂–µ SKU –≤ –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–æ–∫–∞—Ö —Ç–µ–∫—É—â–µ–π —Ñ–æ—Ä–º—ã
            let otherRowsQty = 0;
            document.querySelectorAll('#ved-container-items-tbody tr').forEach(r => {
                if (r === row) return;
                const rSku = parseInt(r.querySelector('.ved-container-product')?.value) || 0;
                const rQty = parseInt(r.querySelector('.ved-container-qty')?.value) || 0;
                if (rSku === sku) otherRowsQty += rQty;
            });

            try {
                const resp = await authFetch('/api/ved/containers/fifo-cost', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sku: sku,
                        quantity: qty,
                        skip_extra: otherRowsQty,
                        exclude_doc_id: editingVedContainerId || null
                    })
                });
                const data = await resp.json();
                if (data.success && data.price_cny > 0) {
                    priceInput.value = data.price_cny;
                    // –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å FIFO-—Ä–∞–∑–±–∏–≤–∫–æ–π
                    let hint = '–ê–≤—Ç–æ –∏–∑ –ø–ª–∞–Ω–∞ (FIFO):\\n' +
                        data.details.map(d => d.qty + ' —à—Ç √ó ' + d.cost + ' ¬• (' + d.date + ')').join('\\n');
                    if (data.uncovered_qty > 0) {
                        hint += '\\n‚ö† –ù–µ –ø–æ–∫—Ä—ã—Ç–æ –ø–ª–∞–Ω–æ–º: ' + data.uncovered_qty + ' —à—Ç';
                    }
                    priceInput.title = hint;
                    updateVedContainerTotals();
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ-—Ä–∞—Å—á—ë—Ç–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏:', err);
            }
        }

        /**
         * Debounce-–æ–±—ë—Ä—Ç–∫–∞ –¥–ª—è fetchFifoPlanCost.
         * –û—Ç–¥–µ–ª—å–Ω—ã–π —Ç–∞–π–º–µ—Ä –Ω–∞ –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É, —á—Ç–æ–±—ã –≤–≤–æ–¥ –≤ —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª.
         */
        function debouncedFetchFifoPlanCost(row) {
            const rowId = row.id || 'row';
            if (_fifoCostTimers[rowId]) clearTimeout(_fifoCostTimers[rowId]);
            _fifoCostTimers[rowId] = setTimeout(() => fetchFifoPlanCost(row), 400);
        }

        /**
         * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –í–≠–î
         */
        async function saveVedContainer() {
            const containerDate = document.getElementById('ved-container-date').value;
            const supplier = document.getElementById('ved-container-supplier').value.trim();
            const comment = document.getElementById('ved-container-comment').value.trim();
            const important = (document.getElementById('ved-container-important') || {}).value?.trim() || '';
            // –î–ª—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –∫—É—Ä—Å, –¥–ª—è –Ω–æ–≤—ã—Ö/–Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö ‚Äî –æ–Ω–ª–∞–π–Ω
            const cnyRate = vedEditingCnyRate !== null ? vedEditingCnyRate : (vedCnyRate || 0);
            const cnyPercent = parseFloat(document.getElementById('ved-cny-percent')?.value) || 0;

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π —à–∞–ø–∫–∏
            if (!containerDate) {
                alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –≤—ã—Ö–æ–¥–∞');
                return;
            }

            if (!supplier) {
                alert('–£–∫–∞–∂–∏—Ç–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞');
                return;
            }

            if (!cnyPercent || cnyPercent <= 0 || isNaN(cnyPercent)) {
                alert('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–æ—Ü–µ–Ω—Ç –∫ –ø–µ—Ä–µ–≤–æ–¥—É –ø–æ —é–∞–Ω—è–º (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ 0)');
                document.getElementById('ved-cny-percent')?.focus();
                return;
            }

            // –°–æ–±–∏—Ä–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
            const items = [];
            let rowNum = 0;
            let hasValidationErrors = false;

            document.querySelectorAll('#ved-container-items-tbody tr').forEach(row => {
                rowNum++;
                const select = row.querySelector('.ved-container-product');
                const sku = select ? parseInt(select.value) : 0;
                if (!sku) return;  // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞

                const qty = parseFloat(row.querySelector('.ved-container-qty')?.value) || 0;
                const priceCny = parseFloat(row.querySelector('.ved-container-price')?.value) || 0;
                // –õ–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è: span (read-only) –∏–ª–∏ input (–¥–ª—è —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤)
                const logRfEl = row.querySelector('.ved-container-logrf');
                const logCnEl = row.querySelector('.ved-container-logcn');
                const terminalEl = row.querySelector('.ved-container-terminal');
                const customsEl = row.querySelector('.ved-container-customs');
                const logRf = parseFloat(logRfEl?.getAttribute('data-value') || logRfEl?.value) || 0;
                const logCn = parseFloat(logCnEl?.getAttribute('data-value') || logCnEl?.value) || 0;
                const terminal = parseFloat(terminalEl?.getAttribute('data-value') || terminalEl?.value) || 0;
                const customs = parseFloat(customsEl?.getAttribute('data-value') || customsEl?.value) || 0;

                // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –≤ —Å—Ç—Ä–æ–∫–µ
                if (qty <= 0) {
                    alert('–°—Ç—Ä–æ–∫–∞ ' + rowNum + ': —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞');
                    hasValidationErrors = true;
                    return;
                }

                items.push({
                    sku: sku,
                    quantity: qty,
                    price_cny: priceCny,
                    logistics_rf: logRf,
                    logistics_cn: logCn,
                    terminal: terminal,
                    customs: customs
                });
            });

            if (hasValidationErrors) return;

            if (items.length === 0) {
                alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏ —Ü–µ–Ω—ã');
                return;
            }

            try {
                const response = await authFetch('/api/ved/containers/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        doc_id: editingVedContainerId,
                        container_date: containerDate,
                        supplier: supplier,
                        comment: comment,
                        important: important,
                        cny_rate: cnyRate,
                        cny_percent: cnyPercent,
                        items: items
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –±—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
                    if (vedContainerPendingFiles.length > 0) {
                        await uploadPendingFiles(result.doc_id);
                    }
                    // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ —Å–µ—Å—Å–∏–∏ (—Ñ–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, –Ω–µ —É–¥–∞–ª—è–µ–º –∏—Ö)
                    vedContainerUploadedFilesSession = [];
                    clearVedContainerForm();
                    hideVedContainerForm();
                    loadVedContainersHistory();
                } else {
                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞');
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –í–≠–î
         */
        async function loadVedContainersHistory() {
            try {
                // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–æ–≤–∞—Ä—É (SKU)
                const filterSku = document.getElementById('ved-containers-product-filter')?.value || '';
                const url = filterSku ? '/api/ved/containers?sku=' + encodeURIComponent(filterSku) : '/api/ved/containers';
                const response = await authFetch(url);
                const result = await response.json();

                const tbody = document.getElementById('ved-containers-history-tbody');
                const wrapper = document.getElementById('ved-containers-history-wrapper');
                const empty = document.getElementById('ved-containers-history-empty');

                if (!result.success || !result.containers || result.containers.length === 0) {
                    if (wrapper) wrapper.style.display = 'none';
                    if (empty) {
                        empty.style.display = 'block';
                        empty.querySelector('p').textContent = filterSku
                            ? '–ù–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å —ç—Ç–∏–º —Ç–æ–≤–∞—Ä–æ–º'
                            : '–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤';
                    }
                    return;
                }

                if (wrapper) wrapper.style.display = 'block';
                if (empty) empty.style.display = 'none';

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
                const isAdmin = currentUser && currentUser.role === 'admin';

                tbody.innerHTML = '';
                result.containers.forEach(doc => {
                    const row = document.createElement('tr');
                    const dateFormatted = doc.container_date ? doc.container_date.split('-').reverse().join('.') : '';
                    const isCompleted = doc.is_completed === 1;

                    // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    row.style.cursor = 'pointer';
                    row.ondblclick = () => editVedContainer(doc.id);

                    // –ï—Å–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ ‚Äî –∑–µ–ª—ë–Ω—ã–π —Ñ–æ–Ω —Å—Ç—Ä–æ–∫–∏
                    if (isCompleted) {
                        row.style.backgroundColor = '#d4edda';
                    }

                    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è (–¥–∞—Ç–∞ –≤—Ä–µ–º—è + –ª–æ–≥–∏–Ω)
                    let createdInfo = '-';
                    if (doc.created_at) {
                        const createdDate = new Date(doc.created_at);
                        const createdStr = createdDate.toLocaleDateString('ru-RU') + ' ' + createdDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
                        createdInfo = createdStr + (doc.created_by ? '<br><small>' + doc.created_by + '</small>' : '');
                    }

                    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è (–¥–∞—Ç–∞ –≤—Ä–µ–º—è + –ª–æ–≥–∏–Ω)
                    let updatedInfo = '-';
                    if (doc.updated_at) {
                        const updatedDate = new Date(doc.updated_at);
                        const updatedStr = updatedDate.toLocaleDateString('ru-RU') + ' ' + updatedDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
                        updatedInfo = updatedStr + (doc.updated_by ? '<br><small>' + doc.updated_by + '</small>' : '');
                    }

                    // –†–∞—Å—á—ë—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤ —Ä—É–±–ª—è—Ö —Å —É—á—ë—Ç–æ–º –∫—É—Ä—Å–∞ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ (–±–µ–∑ –ª–æ–≥–∏—Å—Ç–∏–∫–∏)
                    const cnyRate = doc.cny_rate || 0;
                    const cnyPercent = doc.cny_percent || 0;
                    const adjustedRate = cnyRate * (1 + cnyPercent / 100);
                    const costRub = doc.total_sum_cny * adjustedRate;

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ª–æ–≥–∏—Å—Ç–∏–∫–µ
                    const hasZeros = doc.total_logistics_rf === 0 || doc.total_logistics_cn === 0 ||
                                     doc.total_terminal === 0 || doc.total_customs === 0;

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –ª–∏ –ø–æ–ª–µ "–í–∞–∂–Ω–æ" (–±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ)
                    const hasImportant = doc.important && doc.important.trim() !== '';

                    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å –∫—Ä–∞—Å–Ω—ã–º –§–û–ù–û–ú –¥–ª—è –Ω—É–ª–µ–π
                    const formatWithZeroBg = (val, suffix) => {
                        const formatted = formatVedNumber(val, suffix);
                        if (val === 0) {
                            return '<span style="background-color: #f8d7da; padding: 2px 6px; border-radius: 4px;">' + formatted + '</span>';
                        }
                        return formatted;
                    };

                    // –ß–µ–∫–±–æ–∫—Å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)
                    // –ü–µ—Ä–µ–¥–∞—ë–º hasZeros –∏ hasImportant –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ
                    const checkboxHtml = isAdmin
                        ? '<input type="checkbox" ' + (isCompleted ? 'checked' : '') + ' onchange="toggleVedContainerCompleted(' + doc.id + ', this.checked, ' + hasZeros + ', ' + hasImportant + ')" style="cursor: pointer; width: 18px; height: 18px;">'
                        : (isCompleted ? '‚úÖ' : '');

                    row.innerHTML = `
                        <td>${doc.id}</td>
                        <td style="white-space: nowrap;">${createdInfo}</td>
                        <td>${dateFormatted}</td>
                        <td>${doc.supplier || '-'}</td>
                        <td>${formatVedNumber(doc.total_qty)}</td>
                        <td>${formatVedNumber(doc.total_sum_cny, '¬•')}</td>
                        <td>${formatVedNumber(costRub, '‚ÇΩ')}</td>
                        <td>${formatWithZeroBg(doc.total_logistics_rf, '‚ÇΩ')}</td>
                        <td>${formatWithZeroBg(doc.total_logistics_cn, '‚ÇΩ')}</td>
                        <td>${formatWithZeroBg(doc.total_terminal, '‚ÇΩ')}</td>
                        <td>${formatWithZeroBg(doc.total_customs, '‚ÇΩ')}</td>
                        <td>${formatWithZeroBg(doc.total_all_logistics, '‚ÇΩ')}</td>
                        <td style="white-space: pre-wrap; word-break: break-word; max-width: 450px; text-align: left;">${doc.comment || '-'}</td>
                        <td style="white-space: pre-wrap; word-break: break-word; max-width: 350px; text-align: left;${hasImportant ? ' background-color: #fff3cd;' : ''}">${doc.important || '-'}</td>
                        <td style="white-space: nowrap;">${updatedInfo}</td>
                        <td style="text-align: center;">${checkboxHtml}</td>
                        <td>
                            <button class="wh-delete-btn" onclick="deleteVedContainer(${doc.id})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:', error);
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π
        let vedReceiptsData = [];           // –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π
        let vedReceiptsSortAsc = true;      // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ: true = –æ—Ç —Å—Ç–∞—Ä—ã—Ö –∫ –Ω–æ–≤—ã–º

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π (—Ç–æ–≤–∞—Ä—ã –∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤)
         */
        async function loadVedReceipts() {
            try {
                const response = await authFetch('/api/ved/receipts');
                const result = await response.json();

                const wrapper = document.getElementById('ved-receipts-wrapper');
                const empty = document.getElementById('ved-receipts-empty');

                if (!result.success || !result.items || result.items.length === 0) {
                    if (wrapper) wrapper.style.display = 'none';
                    if (empty) empty.style.display = 'block';
                    vedReceiptsData = [];
                    return;
                }

                if (wrapper) wrapper.style.display = 'block';
                if (empty) empty.style.display = 'none';

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≥–ª–æ–±–∞–ª—å–Ω–æ
                vedReceiptsData = result.items;

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –∞—Ä—Ç–∏–∫—É–ª–æ–≤
                populateArticleFilter();

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                renderVedReceipts();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π:', error);
            }
        }

        /**
         * –ó–∞–ø–æ–ª–Ω–∏—Ç—å –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∞—Ä—Ç–∏–∫—É–ª–æ–≤
         */
        function populateArticleFilter() {
            const select = document.getElementById('ved-receipts-article-filter');
            if (!select) return;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            const currentValue = select.value;

            // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∞—Ä—Ç–∏–∫—É–ª—ã
            const articles = [...new Set(vedReceiptsData.map(item => item.article).filter(a => a))].sort();

            // –û—á–∏—â–∞–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º
            select.innerHTML = '<option value="">–í—Å–µ –∞—Ä—Ç–∏–∫—É–ª—ã</option>';
            articles.forEach(article => {
                const option = document.createElement('option');
                option.value = article;
                option.textContent = article;
                select.appendChild(option);
            });

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            select.value = currentValue;
        }

        /**
         * –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É –∏ –¥–∞—Ç–∞–º
         */
        function filterVedReceipts() {
            renderVedReceipts();
        }

        /**
         * –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º
         */
        function resetVedReceiptsDateFilter() {
            document.getElementById('ved-receipts-date-from').value = '';
            document.getElementById('ved-receipts-date-to').value = '';
            filterVedReceipts();
        }

        /**
         * –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –ø–æ –¥–∞—Ç–µ
         */
        function sortVedReceiptsByDate() {
            vedReceiptsSortAsc = !vedReceiptsSortAsc;
            document.getElementById('ved-receipts-sort-icon').textContent = vedReceiptsSortAsc ? '‚Üë' : '‚Üì';
            renderVedReceipts();
        }

        /**
         * –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π —Å —É—á—ë—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
         */
        function renderVedReceipts() {
            const tbody = document.getElementById('ved-receipts-tbody');
            const articleFilter = document.getElementById('ved-receipts-article-filter')?.value || '';
            const dateFrom = document.getElementById('ved-receipts-date-from')?.value || '';
            const dateTo = document.getElementById('ved-receipts-date-to')?.value || '';

            // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            let filteredData = vedReceiptsData;

            // –§–∏–ª—å—Ç—Ä –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É
            if (articleFilter) {
                filteredData = filteredData.filter(item => item.article === articleFilter);
            }

            // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º
            if (dateFrom) {
                filteredData = filteredData.filter(item => item.container_date >= dateFrom);
            }
            if (dateTo) {
                filteredData = filteredData.filter(item => item.container_date <= dateTo);
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
            filteredData = [...filteredData].sort((a, b) => {
                const dateA = a.container_date || '';
                const dateB = b.container_date || '';
                return vedReceiptsSortAsc ? dateA.localeCompare(dateB) : dateB.localeCompare(dateA);
            });

            // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –∏—Ç–æ–≥–æ–≤ –∏ —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
            let totalQty = 0;
            let sumQtyPrice = 0;
            let sumQtyCost = 0;
            let sumQtyLog = 0;

            tbody.innerHTML = '';
            filteredData.forEach(item => {
                const row = document.createElement('tr');
                const dateFormatted = item.container_date ? item.container_date.split('-').reverse().join('.') : '';

                const qty = item.quantity || 0;
                const priceCny = item.price_cny || 0;
                const logisticsPerUnit = qty > 0 ? Math.ceil(item.all_logistics / qty) : 0;
                const costPerUnit = qty > 0 ? Math.ceil(item.cost_rub / qty) : 0;

                // –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –¥–ª—è —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–æ–≥–æ
                totalQty += qty;
                sumQtyPrice += qty * priceCny;
                sumQtyCost += qty * costPerUnit;
                sumQtyLog += qty * logisticsPerUnit;

                row.innerHTML = `
                    <td style="text-align: center; font-weight: 600; color: #555;">${item.container_id || '-'}</td>
                    <td style="text-align: center;">${dateFormatted}</td>
                    <td style="text-align: center;">${item.article || '-'}</td>
                    <td style="text-align: center;">${formatVedNumber(qty)}</td>
                    <td style="text-align: center;">${formatVedNumber(priceCny, '¬•')}</td>
                    <td style="text-align: center;">${costPerUnit.toLocaleString('ru-RU')} ‚ÇΩ</td>
                    <td style="text-align: center;">${logisticsPerUnit.toLocaleString('ru-RU')} ‚ÇΩ</td>
                `;
                tbody.appendChild(row);
            });

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            const avgPrice = totalQty > 0 ? sumQtyPrice / totalQty : 0;
            const avgCost = totalQty > 0 ? Math.ceil(sumQtyCost / totalQty) : 0;
            const avgLog = totalQty > 0 ? Math.ceil(sumQtyLog / totalQty) : 0;

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å—Ç—Ä–æ–∫—É –∏—Ç–æ–≥–æ–≤
            document.getElementById('ved-receipts-total-qty').textContent = totalQty.toLocaleString('ru-RU');
            document.getElementById('ved-receipts-avg-price').textContent = Math.ceil(avgPrice).toLocaleString('ru-RU') + ' ¬•';
            document.getElementById('ved-receipts-avg-cost').textContent = avgCost.toLocaleString('ru-RU') + ' ‚ÇΩ';
            document.getElementById('ved-receipts-avg-log').textContent = avgLog.toLocaleString('ru-RU') + ' ‚ÇΩ';
        }

        /**
         * –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –í–≠–î
         */
        async function editVedContainer(docId) {
            try {
                const response = await authFetch('/api/ved/containers/' + docId);
                const result = await response.json();

                if (!result.success) {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    return;
                }

                const doc = result.doc;
                const items = result.items;

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                editingVedContainerId = docId;

                // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ —Å–µ—Å—Å–∏–∏ (–Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é, —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –Ω–µ —Ç—Ä–æ–≥–∞–µ–º)
                vedContainerUploadedFilesSession = [];

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —à–∞–ø–∫—É —Ñ–æ—Ä–º—ã
                document.getElementById('ved-container-date').value = doc.container_date || '';
                document.getElementById('ved-container-supplier').value = doc.supplier || '';
                document.getElementById('ved-container-comment').value = doc.comment || '';
                document.getElementById('ved-container-important').value = doc.important || '';
                if (doc.cny_percent) {
                    document.getElementById('ved-cny-percent').value = doc.cny_percent;
                }

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º –∫—É—Ä—Å–∞: –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä = –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫—É—Ä—Å
                vedEditingIsCompleted = doc.is_completed === 1;
                const rateElement = document.getElementById('ved-rate-cny');

                if (vedEditingIsCompleted && doc.cny_rate > 0) {
                    // –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –∫—É—Ä—Å —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º üîí
                    vedEditingCnyRate = doc.cny_rate;
                    rateElement.textContent = formatCurrencyRate(doc.cny_rate) + ' üîí';
                    rateElement.title = '–ö—É—Ä—Å –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –Ω–∞ –º–æ–º–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞';
                } else {
                    // –ù–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–Ω–ª–∞–π–Ω –∫—É—Ä—Å
                    vedEditingCnyRate = null;
                    rateElement.textContent = formatCurrencyRate(vedCnyRate);
                    rateElement.title = '–ê–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –¶–ë –†–§';
                }

                // –û—á–∏—â–∞–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏–∏
                document.getElementById('ved-container-items-tbody').innerHTML = '';
                vedContainerItemCounter = 0;

                for (const item of items) {
                    addVedContainerItemRow();
                    const rows = document.querySelectorAll('#ved-container-items-tbody tr');
                    const row = rows[rows.length - 1];

                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
                    const select = row.querySelector('.ved-container-product');
                    if (select) select.value = item.sku;

                    const qtyInput = row.querySelector('.ved-container-qty');
                    if (qtyInput) qtyInput.value = item.quantity;

                    const priceInput = row.querySelector('.ved-container-price');
                    if (priceInput) priceInput.value = item.price_cny;

                    // –õ–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è ‚Äî span (read-only), –∑–∞–ø–æ–ª–Ω—è–µ–º data-value –∏ —Ç–µ–∫—Å—Ç
                    const logRfEl = row.querySelector('.ved-container-logrf');
                    if (logRfEl) {
                        const v = item.logistics_rf || 0;
                        logRfEl.setAttribute('data-value', v);
                        logRfEl.textContent = v ? parseFloat(v).toLocaleString('ru-RU') : '0';
                        if (v > 0) logRfEl.innerHTML += '<span class="ved-container-cost-finance-badge">–∏–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤</span>';
                    }

                    const logCnEl = row.querySelector('.ved-container-logcn');
                    if (logCnEl) {
                        const v = item.logistics_cn || 0;
                        logCnEl.setAttribute('data-value', v);
                        logCnEl.textContent = v ? parseFloat(v).toLocaleString('ru-RU') : '0';
                        if (v > 0) logCnEl.innerHTML += '<span class="ved-container-cost-finance-badge">–∏–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤</span>';
                    }

                    const terminalEl = row.querySelector('.ved-container-terminal');
                    if (terminalEl) {
                        const v = item.terminal || 0;
                        terminalEl.setAttribute('data-value', v);
                        terminalEl.textContent = v ? parseFloat(v).toLocaleString('ru-RU') : '0';
                        if (v > 0) terminalEl.innerHTML += '<span class="ved-container-cost-finance-badge">–∏–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤</span>';
                    }

                    const customsEl = row.querySelector('.ved-container-customs');
                    if (customsEl) {
                        const v = item.customs || 0;
                        customsEl.setAttribute('data-value', v);
                        customsEl.textContent = v ? parseFloat(v).toLocaleString('ru-RU') : '0';
                        if (v > 0) customsEl.innerHTML += '<span class="ved-container-cost-finance-badge">–∏–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤</span>';
                    }
                }

                updateVedContainerTotals();

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                document.getElementById('ved-container-messages-section').style.display = 'block';
                loadContainerMessages(docId);
                loadContainerMessageRecipients();

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                loadVedContainerFiles(docId);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∏ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–µ–π
                showVedContainerForm();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞');
            }
        }

        /* ================================================================
         * –ú–û–î–ê–õ–ö–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø –£–î–ê–õ–ï–ù–ò–Ø (–Ω—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ "—É–¥–∞–ª–∏—Ç—å")
         * ================================================================
         * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –º–æ–¥–∞–ª–∫–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è.
         * –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –≤–≤–µ—Å—Ç–∏ —Å–ª–æ–≤–æ "—É–¥–∞–ª–∏—Ç—å" –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
         * _deleteConfirmCallback ‚Äî –∫–æ–ª–±—ç–∫, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏.
         */
        let _deleteConfirmCallback = null;

        /**
         * –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è.
         * @param {string} message ‚Äî —Ç–µ–∫—Å—Ç, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ
         * @param {Function} onConfirm ‚Äî –∫–æ–ª–±—ç–∫ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –≤–≤–æ–¥–µ "—É–¥–∞–ª–∏—Ç—å"
         */
        function showDeleteConfirmModal(message, onConfirm) {
            _deleteConfirmCallback = onConfirm;
            document.getElementById('confirm-delete-message').textContent = message;
            document.getElementById('confirm-delete-input').value = '';
            document.getElementById('confirm-delete-error').style.display = 'none';
            document.getElementById('confirm-delete-modal').classList.remove('hidden');
            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            setTimeout(() => document.getElementById('confirm-delete-input').focus(), 100);
        }

        /**
         * –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
         */
        function closeDeleteConfirmModal() {
            document.getElementById('confirm-delete-modal').classList.add('hidden');
            _deleteConfirmCallback = null;
        }

        /**
         * –í—ã–ø–æ–ª–Ω–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ —Å–ª–æ–≤–∞ "—É–¥–∞–ª–∏—Ç—å"
         */
        function executeDeleteConfirm() {
            const input = document.getElementById('confirm-delete-input').value.trim().toLowerCase();
            if (input !== '—É–¥–∞–ª–∏—Ç—å') {
                document.getElementById('confirm-delete-error').style.display = 'block';
                document.getElementById('confirm-delete-input').style.borderColor = '#c62828';
                return;
            }
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–ª–±—ç–∫ –î–û –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏, —Ç.–∫. closeDeleteConfirmModal() –æ–±–Ω—É–ª—è–µ—Ç –µ–≥–æ
            const callback = _deleteConfirmCallback;
            closeDeleteConfirmModal();
            if (callback) {
                callback();
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
        document.getElementById('confirm-delete-modal').addEventListener('click', function(e) {
            if (e.target === this) closeDeleteConfirmModal();
        });

        // Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å, Escape ‚Äî –æ—Ç–º–µ–Ω–∞
        document.getElementById('confirm-delete-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') executeDeleteConfirm();
            if (e.key === 'Escape') closeDeleteConfirmModal();
        });

        /**
         * –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –í–≠–î (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É)
         */
        async function deleteVedContainer(docId) {
            showDeleteConfirmModal(
                '–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚Ññ' + docId + ' —Å–æ –≤—Å–µ–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏.',
                async function() {
                    try {
                        const response = await authFetch('/api/ved/containers/delete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ id: docId })
                        });

                        const result = await response.json();

                        if (result.success) {
                            loadVedContainersHistory();
                        } else {
                            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:', error);
                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞');
                    }
                }
            );
        }

        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –í–≠–î (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)
         * @param {number} docId - ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
         * @param {boolean} isCompleted - –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
         * @param {boolean} hasZeros - –µ—Å—Ç—å –ª–∏ –Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ª–æ–≥–∏—Å—Ç–∏–∫–µ
         */
        async function toggleVedContainerCompleted(docId, isCompleted, hasZeros, hasImportant) {
            // –ï—Å–ª–∏ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≤–µ—Ä—à–∏—Ç—å, –Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–ª–µ "–í–∞–∂–Ω–æ" ‚Äî –∑–∞–ø—Ä–µ—â–∞–µ–º
            if (isCompleted && hasImportant) {
                alert('–ù–µ–ª—å–∑—è –∑–∞–≤–µ—Ä—à–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: –æ—á–∏—Å—Ç–∏—Ç–µ –ø–æ–ª–µ "–í–∞–∂–Ω–æ" –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º');
                loadVedContainersHistory();  // –°–±—Ä–æ—Å–∏—Ç—å —á–µ–∫–±–æ–∫—Å
                return;
            }

            // –ï—Å–ª–∏ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≤–µ—Ä—à–∏—Ç—å, –Ω–æ –µ—Å—Ç—å –Ω—É–ª–∏ ‚Äî –∑–∞–ø—Ä–µ—â–∞–µ–º
            if (isCompleted && hasZeros) {
                alert('–ù–µ–ª—å–∑—è –∑–∞–≤–µ—Ä—à–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –ª–æ–≥–∏—Å—Ç–∏–∫–∏ (–∫—Ä–∞—Å–Ω—ã–µ —è—á–µ–π–∫–∏)');
                loadVedContainersHistory();  // –°–±—Ä–æ—Å–∏—Ç—å —á–µ–∫–±–æ–∫—Å
                return;
            }

            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –≥–∞–ª–æ—á–∫–∏
            if (isCompleted) {
                if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚Ññ' + docId + ' –∫–∞–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π?')) {
                    loadVedContainersHistory();  // –°–±—Ä–æ—Å–∏—Ç—å —á–µ–∫–±–æ–∫—Å
                    return;
                }
            } else {
                // –ü—Ä–∏ –°–ù–Ø–¢–ò–ò —á–µ–∫–±–æ–∫—Å–∞ —Ç—Ä–µ–±—É–µ–º –≤–≤–æ–¥ —Å–ª–æ–≤–∞ "–∑–∞–≤–µ—Ä—à–µ–Ω–æ"
                const userInput = prompt('–î–ª—è —Å–Ω—è—Ç–∏—è —Å—Ç–∞—Ç—É—Å–∞ "–ó–∞–≤–µ—Ä—à–µ–Ω–æ" –≤–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ "–∑–∞–≤–µ—Ä—à–µ–Ω–æ":');
                if (userInput === null) {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –û—Ç–º–µ–Ω–∞
                    loadVedContainersHistory();  // –°–±—Ä–æ—Å–∏—Ç—å —á–µ–∫–±–æ–∫—Å
                    return;
                }
                if (userInput.toLowerCase().trim() !== '–∑–∞–≤–µ—Ä—à–µ–Ω–æ') {
                    alert('–ù–µ–≤–µ—Ä–Ω–æ–µ —Å–ª–æ–≤–æ. –°—Ç–∞—Ç—É—Å –Ω–µ –∏–∑–º–µ–Ω—ë–Ω.');
                    loadVedContainersHistory();  // –°–±—Ä–æ—Å–∏—Ç—å —á–µ–∫–±–æ–∫—Å
                    return;
                }
            }

            try {
                const response = await authFetch('/api/ved/containers/toggle-completed', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: docId, is_completed: isCompleted })
                });

                const result = await response.json();

                if (result.success) {
                    loadVedContainersHistory();  // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    loadVedContainersHistory();  // –°–±—Ä–æ—Å–∏—Ç—å —á–µ–∫–±–æ–∫—Å
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
                alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                loadVedContainersHistory();
            }
        }

        /**
         * –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
         * –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ) ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –∫—É—Ä—Å —é–∞–Ω—è
         * —Å —Å–µ—Ä–≤–µ—Ä–∞, —á—Ç–æ–±—ã –æ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª —Ç–µ–∫—É—â–µ–º—É –¥–Ω—é.
         */
        function showVedContainerForm() {
            // –ï—Å–ª–∏ —ç—Ç–æ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –∫—É—Ä—Å —é–∞–Ω—è
            if (!editingVedContainerId) {
                refreshVedCnyRate();
            }
            document.getElementById('ved-container-form').style.display = 'block';
            document.getElementById('ved-container-create-btn-wrapper').style.display = 'none';
            document.getElementById('ved-container-form').scrollIntoView({ behavior: 'smooth' });
        }

        /**
         * –°–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
         */
        function hideVedContainerForm() {
            document.getElementById('ved-container-form').style.display = 'none';
            document.getElementById('ved-container-create-btn-wrapper').style.display = 'block';
        }

        /**
         * –û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –í–≠–î (—Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
         */
        function cancelVedContainer() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å? –í—Å–µ –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
                return;
            }
            clearVedContainerForm();
            hideVedContainerForm();
        }

        /**
         * –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –í–≠–î
         */
        // –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –≤ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–ª—è –æ—Ç–∫–∞—Ç–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ)
        let vedContainerUploadedFilesSession = [];

        // –ë—É—Ñ–µ—Ä —Ñ–∞–π–ª–æ–≤, –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (File –æ–±—ä–µ–∫—Ç—ã + display_name)
        let vedContainerPendingFiles = [];

        function clearVedContainerForm() {
            // –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            deleteSessionUploadedFiles();

            editingVedContainerId = null;  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            vedEditingCnyRate = null;      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫—É—Ä—Å ‚Äî –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω
            vedEditingIsCompleted = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ—Å—Ç–∏

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–Ω–ª–∞–π–Ω –∫—É—Ä—Å–∞
            const rateElement = document.getElementById('ved-rate-cny');
            rateElement.textContent = formatCurrencyRate(vedCnyRate);
            rateElement.title = '–ê–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –¶–ë –†–§';

            document.getElementById('ved-container-supplier').value = '';
            document.getElementById('ved-container-comment').value = '';
            document.getElementById('ved-container-important').value = '';
            document.getElementById('ved-cny-percent').value = '';  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –∫ –ø–µ—Ä–µ–≤–æ–¥—É (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ)
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞—Ç—É –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('ved-container-date').value = today;
            document.getElementById('ved-container-items-tbody').innerHTML = '';
            vedContainerItemCounter = 0;
            addVedContainerItemRow();
            updateVedContainerTotals();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–æ—Å—Ç—É–ø–µ–Ω –∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
            document.getElementById('ved-container-messages-section').style.display = 'block';
            document.getElementById('ved-container-messages-list').style.display = 'none';
            document.getElementById('ved-container-messages-list').innerHTML = '';
            document.getElementById('ved-container-msg-text').value = '';
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å —á–µ–∫–±–æ–∫—Å–æ–≤ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
            document.querySelectorAll('.container-msg-recipient').forEach(cb => cb.checked = false);
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
            loadContainerMessageRecipients();

            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
            clearVedContainerFiles();
        }

        // ============================================================================
        // –§–ê–ô–õ–´ –ö–û–ù–¢–ï–ô–ù–ï–†–ê –í–≠–î
        // ============================================================================

        /**
         * –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª—ã, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏ (–ø—Ä–∏ –æ—Ç–º–µ–Ω–µ)
         */
        async function deleteSessionUploadedFiles() {
            if (vedContainerUploadedFilesSession.length === 0) return;

            for (const fileId of vedContainerUploadedFilesSession) {
                try {
                    await authFetch('/api/ved/containers/files/' + fileId, { method: 'DELETE' });
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ —Å–µ—Å—Å–∏–∏:', e);
                }
            }
            vedContainerUploadedFilesSession = [];
        }

        /**
         * –û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
         */
        function clearVedContainerFiles() {
            const list = document.getElementById('ved-container-files-list');
            if (list) list.innerHTML = '<p id="ved-container-files-empty" style="color: #999; font-size: 13px; margin: 0;">–ù–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</p>';
            vedContainerPendingFiles = [];
        }

        /**
         * –°–æ–∑–¥–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –±—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ (–µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä)
         */
        function createPendingFileElement(pendingFile, index) {
            const div = document.createElement('div');
            div.className = 'ved-file-item ved-file-pending';
            div.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #fffde7; border: 1px dashed #f9a825; border-radius: 6px; font-size: 13px;';
            div.dataset.pendingIndex = index;

            const file = pendingFile.file;
            let icon = 'üìÑ';
            if (file.type.startsWith('image/')) icon = 'üñºÔ∏è';
            else if (file.type === 'application/pdf') icon = 'üìï';
            else if (file.type.includes('word')) icon = 'üìò';
            else if (file.type.includes('excel') || file.type.includes('spreadsheet')) icon = 'üìó';
            else if (file.type.includes('zip') || file.type.includes('rar')) icon = 'üì¶';

            const sizeKb = Math.round(file.size / 1024);
            const sizeStr = sizeKb > 1024 ? (sizeKb / 1024).toFixed(1) + ' –ú–ë' : sizeKb + ' –ö–ë';
            const displayName = pendingFile.displayName || file.name;

            div.innerHTML = `
                <span style="font-size: 18px;">${icon}</span>
                <span class="ved-file-name" style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${file.name}">${displayName}</span>
                <span style="color: #f57f17; font-size: 11px;">‚è≥ –û–∂–∏–¥–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</span>
                <span style="color: #888; font-size: 11px;">${sizeStr}</span>
                <button onclick="renamePendingFile(${index})" style="padding: 4px 8px; border: none; background: #fff3e0; color: #e65100; border-radius: 4px; cursor: pointer; font-size: 12px;" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                <button onclick="removePendingFile(${index})" style="padding: 4px 8px; border: none; background: #ffebee; color: #d32f2f; border-radius: 4px; cursor: pointer; font-size: 12px;" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
            `;

            return div;
        }

        /**
         * –£–¥–∞–ª–∏—Ç—å –±—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –∏–∑ —Å–ø–∏—Å–∫–∞
         */
        function removePendingFile(index) {
            vedContainerPendingFiles.splice(index, 1);
            renderPendingFiles();
        }

        /**
         * –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –±—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
         */
        function renderPendingFiles() {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ pending-—ç–ª–µ–º–µ–Ω—Ç—ã
            document.querySelectorAll('.ved-file-pending').forEach(el => el.remove());

            const list = document.getElementById('ved-container-files-list');
            if (!list) return;

            // –£–±–∏—Ä–∞–µ–º "–ù–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤" –µ—Å–ª–∏ –µ—Å—Ç—å pending —Ñ–∞–π–ª—ã
            const empty = document.getElementById('ved-container-files-empty');
            if (vedContainerPendingFiles.length > 0 && empty) {
                empty.remove();
            }

            // –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏ pending, –Ω–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–Ω–µ—Ç —Ñ–∞–π–ª–æ–≤"
            const uploadedFiles = list.querySelectorAll('.ved-file-item:not(.ved-file-pending)');
            if (vedContainerPendingFiles.length === 0 && uploadedFiles.length === 0 && !empty) {
                list.innerHTML = '<p id="ved-container-files-empty" style="color: #999; font-size: 13px; margin: 0;">–ù–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</p>';
            }

            vedContainerPendingFiles.forEach((pf, i) => {
                list.appendChild(createPendingFileElement(pf, i));
            });
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å –±—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
         */
        async function uploadPendingFiles(docId) {
            if (vedContainerPendingFiles.length === 0) return;

            for (const pendingFile of vedContainerPendingFiles) {
                const formData = new FormData();
                formData.append('file', pendingFile.file);
                formData.append('display_name', pendingFile.displayName || '');

                try {
                    const response = await fetch('/api/ved/containers/' + docId + '/files', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + authToken
                        },
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        vedContainerUploadedFilesSession.push(result.file.id);
                    } else {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:', pendingFile.file.name, result.error);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:', pendingFile.file.name, error);
                }
            }
            vedContainerPendingFiles = [];
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
         */
        async function loadVedContainerFiles(docId) {
            if (!docId) {
                clearVedContainerFiles();
                return;
            }

            try {
                const response = await authFetch('/api/ved/containers/' + docId + '/files');
                const result = await response.json();

                const list = document.getElementById('ved-container-files-list');
                if (!list) return;

                if (!result.success || !result.files || result.files.length === 0) {
                    list.innerHTML = '<p id="ved-container-files-empty" style="color: #999; font-size: 13px; margin: 0;">–ù–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</p>';
                    return;
                }

                list.innerHTML = '';
                result.files.forEach(file => {
                    const fileEl = createFileElement(file);
                    list.appendChild(fileEl);
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤:', error);
            }
        }

        /**
         * –°–æ–∑–¥–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç —Ñ–∞–π–ª–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
         */
        function createFileElement(file) {
            const div = document.createElement('div');
            div.className = 'ved-file-item';
            div.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #fff; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;';
            div.dataset.fileId = file.id;

            // –ò–∫–æ–Ω–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
            let icon = 'üìÑ';
            if (file.file_type && file.file_type.startsWith('image/')) icon = 'üñºÔ∏è';
            else if (file.file_type === 'application/pdf') icon = 'üìï';
            else if (file.file_type && file.file_type.includes('word')) icon = 'üìò';
            else if (file.file_type && file.file_type.includes('excel') || file.file_type && file.file_type.includes('spreadsheet')) icon = 'üìó';
            else if (file.file_type && (file.file_type.includes('zip') || file.file_type.includes('rar'))) icon = 'üì¶';

            // –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
            const sizeKb = Math.round(file.file_size / 1024);
            const sizeStr = sizeKb > 1024 ? (sizeKb / 1024).toFixed(1) + ' –ú–ë' : sizeKb + ' –ö–ë';

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–∞–π–ª
            const canPreview = file.file_type && (file.file_type.startsWith('image/') || file.file_type === 'application/pdf');
            const isAdmin = currentUser && currentUser.role === 'admin';

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º display_name –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ filename
            const displayName = file.display_name || file.filename;
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ tooltip –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ –µ—Å–ª–∏ display_name –∑–∞–¥–∞–Ω
            const tooltip = file.display_name ? file.display_name + ' (' + file.filename + ')' : file.filename;

            div.innerHTML = `
                <span style="font-size: 18px;">${icon}</span>
                <span class="ved-file-name" style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${tooltip}">${displayName}</span>
                <span style="color: #888; font-size: 11px;">${sizeStr}</span>
                ${canPreview ? '<button onclick="previewVedFile(' + file.id + ', \\'' + file.file_type + '\\')" style="padding: 4px 8px; border: none; background: #e3f2fd; color: #1976d2; border-radius: 4px; cursor: pointer; font-size: 12px;" title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å">üëÅÔ∏è</button>' : ''}
                <button onclick="downloadVedFile(${file.id})" style="padding: 4px 8px; border: none; background: #e8f5e9; color: #388e3c; border-radius: 4px; cursor: pointer; font-size: 12px;" title="–°–∫–∞—á–∞—Ç—å">‚¨áÔ∏è</button>
                ${isAdmin ? '<button onclick="renameVedFile(' + file.id + ', \\'' + displayName.replace(/'/g, "\\\\'") + '\\')" style="padding: 4px 8px; border: none; background: #fff3e0; color: #e65100; border-radius: 4px; cursor: pointer; font-size: 12px;" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">‚úèÔ∏è</button>' : ''}
                ${isAdmin ? '<button onclick="deleteVedFile(' + file.id + ')" style="padding: 4px 8px; border: none; background: #ffebee; color: #d32f2f; border-radius: 4px; cursor: pointer; font-size: 12px;" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>' : ''}
            `;

            return div;
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
         * –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—â—ë –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚Äî –±—É—Ñ–µ—Ä–∏–∑—É–µ–º —Ñ–∞–π–ª—ã –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
         */
        async function uploadVedContainerFile() {
            const input = document.getElementById('ved-container-file-input');
            if (!input || !input.files || input.files.length === 0) return;

            const files = input.files;

            // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—â—ë –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚Äî –±—É—Ñ–µ—Ä–∏–∑—É–µ–º —Ñ–∞–π–ª—ã
            if (!editingVedContainerId) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];

                    const displayName = prompt(
                        '–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):\\n\\n' +
                        '–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è: ' + file.name + '\\n\\n' +
                        '–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞:',
                        ''
                    );

                    if (displayName === null) continue;

                    vedContainerPendingFiles.push({
                        file: file,
                        displayName: displayName.trim()
                    });
                }
                renderPendingFiles();
                input.value = '';
                return;
            }

            // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã —Å—Ä–∞–∑—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                // –°–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
                const displayName = prompt(
                    '–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):\\n\\n' +
                    '–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è: ' + file.name + '\\n\\n' +
                    '–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞:',
                    ''
                );

                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–û—Ç–º–µ–Ω–∞" - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç —Ñ–∞–π–ª
                if (displayName === null) continue;

                const formData = new FormData();
                formData.append('file', file);
                formData.append('display_name', displayName.trim());

                try {
                    const response = await fetch('/api/ved/containers/' + editingVedContainerId + '/files', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + authToken
                        },
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –≤ —Å–ø–∏—Å–æ–∫
                        const list = document.getElementById('ved-container-files-list');
                        const empty = document.getElementById('ved-container-files-empty');
                        if (empty) empty.remove();

                        const fileEl = createFileElement(result.file);
                        list.appendChild(fileEl);

                        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –æ—Ç–∫–∞—Ç–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ
                        vedContainerUploadedFilesSession.push(result.file.id);
                    } else {
                        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ ' + file.name + ': ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ ' + file.name);
                }
            }

            // –û—á–∏—â–∞–µ–º input
            input.value = '';
        }

        /**
         * –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
         */
        function downloadVedFile(fileId) {
            window.open('/api/ved/containers/files/' + fileId + '?token=' + authToken, '_blank');
        }

        /**
         * –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–∞–π–ª –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
         */
        function previewVedFile(fileId, fileType) {
            const url = '/api/ved/containers/files/' + fileId + '?view=1&token=' + authToken;

            // –°–æ–∑–¥–∞—ë–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            let modal = document.getElementById('ved-file-preview-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'ved-file-preview-modal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
                document.body.appendChild(modal);
            }

            // –ö–æ–Ω—Ç–µ–Ω—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            if (fileType && fileType.startsWith('image/')) {
                modal.innerHTML = `
                    <div style="position: relative; max-width: 90%; max-height: 90%;">
                        <button onclick="document.getElementById('ved-file-preview-modal').remove()" style="position: absolute; top: -40px; right: 0; background: #fff; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 18px; cursor: pointer;">‚úï</button>
                        <img src="${url}" style="max-width: 100%; max-height: 85vh; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);" onload="this.parentElement.style.display='block'" onerror="alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'); document.getElementById('ved-file-preview-modal').remove();">
                    </div>
                `;
            } else if (fileType === 'application/pdf') {
                modal.innerHTML = `
                    <div style="position: relative; width: 90%; height: 90%; background: #fff; border-radius: 8px; overflow: hidden;">
                        <button onclick="document.getElementById('ved-file-preview-modal').remove()" style="position: absolute; top: 10px; right: 10px; background: #f44336; color: #fff; border: none; border-radius: 4px; padding: 8px 16px; font-size: 14px; cursor: pointer; z-index: 1;">–ó–∞–∫—Ä—ã—Ç—å</button>
                        <iframe src="${url}" style="width: 100%; height: 100%; border: none;"></iframe>
                    </div>
                `;
            }
        }

        /**
         * –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª
         */
        async function deleteVedFile(fileId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª?')) return;

            try {
                const response = await authFetch('/api/ved/containers/files/' + fileId, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM
                    const fileEl = document.querySelector('.ved-file-item[data-file-id="' + fileId + '"]');
                    if (fileEl) fileEl.remove();

                    // –ï—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
                    const list = document.getElementById('ved-container-files-list');
                    if (list && list.children.length === 0) {
                        list.innerHTML = '<p id="ved-container-files-empty" style="color: #999; font-size: 13px; margin: 0;">–ù–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</p>';
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
            }
        }

        /**
         * –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ).
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç prompt —Å —Ç–µ–∫—É—â–∏–º –∏–º–µ–Ω–µ–º, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç PUT-–∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä,
         * –æ–±–Ω–æ–≤–ª—è–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ DOM –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞.
         */
        async function renameVedFile(fileId, currentName) {
            const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è —Ñ–∞–π–ª–∞:', currentName);
            if (!newName || newName.trim() === '' || newName.trim() === currentName) return;

            try {
                const response = await authFetch('/api/ved/containers/files/' + fileId + '/rename', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ display_name: newName.trim() })
                });

                const result = await response.json();

                if (result.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è –≤ DOM –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ–≥–æ —Å–ø–∏—Å–∫–∞
                    const fileEl = document.querySelector('.ved-file-item[data-file-id="' + fileId + '"]');
                    if (fileEl) {
                        const nameSpan = fileEl.querySelector('.ved-file-name');
                        if (nameSpan) {
                            nameSpan.textContent = result.file.display_name || result.file.filename;
                            const tooltip = result.file.display_name
                                ? result.file.display_name + ' (' + result.file.filename + ')'
                                : result.file.filename;
                            nameSpan.title = tooltip;
                        }
                        // –û–±–Ω–æ–≤–ª—è–µ–º onclick –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —Å –Ω–æ–≤—ã–º –∏–º–µ–Ω–µ–º
                        const renameBtn = fileEl.querySelector('button[title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å"]');
                        if (renameBtn) {
                            const updatedName = (result.file.display_name || result.file.filename).replace(/'/g, "\\'");
                            renameBtn.setAttribute('onclick', "renameVedFile(" + fileId + ", '" + updatedName + "')");
                        }
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞');
            }
        }

        /**
         * –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –±—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª (–µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä).
         * –û–±–Ω–æ–≤–ª—è–µ—Ç displayName –≤ –º–∞—Å—Å–∏–≤–µ vedContainerPendingFiles –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫.
         */
        function renamePendingFile(index) {
            if (index < 0 || index >= vedContainerPendingFiles.length) return;

            const pendingFile = vedContainerPendingFiles[index];
            const currentName = pendingFile.displayName || pendingFile.file.name;
            const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è —Ñ–∞–π–ª–∞:', currentName);

            if (!newName || newName.trim() === '' || newName.trim() === currentName) return;

            vedContainerPendingFiles[index].displayName = newName.trim();
            renderPendingFiles();
        }

        // ============================================================================
        // –°–û–û–ë–©–ï–ù–ò–Ø –ö–û–ù–¢–ï–ô–ù–ï–†–û–í –í–≠–î
        // ============================================================================

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º Telegram)
         * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∫–∞–∫ —á–µ–∫–±–æ–∫—Å—ã
         */
        async function loadContainerMessageRecipients() {
            const container = document.getElementById('ved-container-msg-recipients');
            container.innerHTML = '<span style="color: #999; font-size: 12px;">–ó–∞–≥—Ä—É–∑–∫–∞...</span>';

            try {
                const resp = await authFetch('/api/users-with-telegram');
                const data = await resp.json();

                container.innerHTML = '';
                if (data.success && data.users && data.users.length > 0) {
                    data.users.forEach(user => {
                        const label = document.createElement('label');
                        label.style.cssText = 'display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 4px 0;';
                        label.innerHTML = `
                            <input type="checkbox" class="container-msg-recipient" value="${user.id}" style="cursor: pointer;">
                            <span>${escapeHtml(user.username)}</span>
                        `;
                        container.appendChild(label);
                    });
                } else {
                    container.innerHTML = '<span style="color: #999; font-size: 12px;">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å Telegram</span>';
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π:', err);
                container.innerHTML = '<span style="color: #c33; font-size: 12px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</span>';
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
         */
        async function loadContainerMessages(containerId) {
            const listDiv = document.getElementById('ved-container-messages-list');
            listDiv.style.display = 'block';
            listDiv.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                const resp = await authFetch('/api/container-messages/' + containerId);
                const data = await resp.json();

                if (!data.success || !data.messages || data.messages.length === 0) {
                    listDiv.style.display = 'none';
                    listDiv.innerHTML = '';
                    return;
                }

                listDiv.style.display = 'block';
                listDiv.innerHTML = '';
                data.messages.forEach(msg => {
                    const isFromTelegram = msg.sender_type === 'telegram';
                    // –¶–≤–µ—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∏–º–µ–Ω–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è, –∞ –Ω–µ –æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞
                    const uColor = getUserColor(msg.sender_name);
                    const icon = isFromTelegram ? 'üì±' : 'üåê';
                    const time = new Date(msg.created_at).toLocaleString('ru-RU');

                    // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
                    let filesHtml = '';
                    if (msg.files && msg.files.length > 0) {
                        filesHtml = '<div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;">';
                        msg.files.forEach(file => {
                            const isImage = file.file_type && file.file_type.startsWith('image/');
                            if (isImage) {
                                // –ö–∞—Ä—Ç–∏–Ω–∫–∏ ‚Äî –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ –ø—Ä–µ–≤—å—é
                                filesHtml += '<a href="/api/container-messages/files/' + file.id + '?view=1&token=' + authToken + '" target="_blank" style="display: block; max-width: 200px;">'
                                    + '<img src="/api/container-messages/files/' + file.id + '?view=1&token=' + authToken + '"'
                                    + ' style="max-width: 200px; max-height: 150px; border-radius: 4px; cursor: pointer; object-fit: cover;"'
                                    + ' alt="' + escapeHtml(file.filename) + '" loading="lazy">'
                                    + '</a>';
                            } else {
                                // –î–æ–∫—É–º–µ–Ω—Ç—ã ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π chip —Å –∏–∫–æ–Ω–∫–æ–π
                                let fileIcon = 'üìÑ';
                                if (file.file_type === 'application/pdf') fileIcon = 'üìï';
                                else if (file.file_type && file.file_type.includes('word')) fileIcon = 'üìò';
                                else if (file.file_type && (file.file_type.includes('excel') || file.file_type.includes('spreadsheet'))) fileIcon = 'üìó';
                                else if (file.file_type && (file.file_type.includes('zip') || file.file_type.includes('rar'))) fileIcon = 'üì¶';

                                const sizeKb = Math.round(file.file_size / 1024);
                                const sizeStr = sizeKb > 1024 ? (sizeKb / 1024).toFixed(1) + ' –ú–ë' : sizeKb + ' –ö–ë';

                                filesHtml += '<a href="/api/container-messages/files/' + file.id + '?token=' + authToken + '" target="_blank"'
                                    + ' style="display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: rgba(255,255,255,0.7); border-radius: 4px; border: 1px solid #ddd; text-decoration: none; color: #333; font-size: 12px;">'
                                    + '<span style="font-size: 16px;">' + fileIcon + '</span>'
                                    + '<span style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' + escapeHtml(file.filename) + '</span>'
                                    + '<span style="color: #888; font-size: 11px;">' + sizeStr + '</span>'
                                    + '</a>';
                            }
                        });
                        filesHtml += '</div>';
                    }

                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'container-msg-bubble';
                    msgDiv.setAttribute('data-message-id', msg.id);
                    msgDiv.setAttribute('data-message-text', msg.message || '');
                    msgDiv.style.cssText = `padding: 10px; margin-bottom: 8px; background: ${uColor.bg}; border-radius: 6px; border-left: 3px solid ${uColor.border};`;

                    // –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
                    const isOwnMsg = currentUser && msg.sender_id === currentUser.user_id;
                    const actionsHtml = isOwnMsg ? `
                        <span class="msg-actions">
                            ${msg.message ? `<button class="msg-action-btn" onclick="editMessage('container', ${msg.id}, this.closest('.container-msg-bubble'))" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>` : ''}
                            <button class="msg-action-btn msg-delete-btn" onclick="deleteMessage('container', ${msg.id})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                        </span>
                    ` : '';

                    msgDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <strong>${icon} ${escapeHtml(msg.sender_name)}</strong>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                ${actionsHtml}
                                <small style="color: #666;">${time}</small>
                            </div>
                        </div>
                        ${msg.message ? '<div class="msg-text-content" style="white-space: pre-wrap;">' + escapeHtml(msg.message) + '</div>' : ''}
                        ${filesHtml}
                        ${msg.recipient_names ? `<div style="margin-top: 4px; font-size: 11px; color: #666;">–ö–æ–º—É: ${escapeHtml(msg.recipient_names)}</div>` : ''}
                    `;
                    listDiv.appendChild(msgDiv);
                });

                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
                listDiv.scrollTop = listDiv.scrollHeight;
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', err);
                listDiv.innerHTML = '<div style="color: #c33; text-align: center; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è –∫ —Å–æ–æ–±—â–µ–Ω–∏—é —á–∞—Ç–∞
         */
        function initContainerMsgFileInput() {
            const fileInput = document.getElementById('ved-container-msg-file-input');
            if (!fileInput) return;
            fileInput.addEventListener('change', function() {
                const preview = document.getElementById('ved-container-msg-files-preview');
                if (!preview) return;
                preview.innerHTML = '';
                preview.style.display = this.files.length > 0 ? 'flex' : 'none';

                for (let i = 0; i < this.files.length; i++) {
                    const file = this.files[i];
                    const isImage = file.type.startsWith('image/');
                    const icon = isImage ? 'üñºÔ∏è' : 'üìÑ';
                    const sizeKb = Math.round(file.size / 1024);
                    const sizeStr = sizeKb > 1024 ? (sizeKb / 1024).toFixed(1) + ' –ú–ë' : sizeKb + ' –ö–ë';

                    const chip = document.createElement('div');
                    chip.style.cssText = 'display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: #e3f2fd; border-radius: 12px; font-size: 12px;';
                    chip.innerHTML = icon + ' ' + escapeHtml(file.name) + ' <span style="color:#888;">(' + sizeStr + ')</span>';
                    preview.appendChild(chip);
                }
            });
        }

        /**
         * –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É (—Ç–µ–∫—Å—Ç –∏/–∏–ª–∏ —Ñ–∞–π–ª—ã)
         */
        async function sendContainerMessage() {
            if (!editingVedContainerId) {
                alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä');
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –∏–∑ —á–µ–∫–±–æ–∫—Å–æ–≤
            const checkboxes = document.querySelectorAll('.container-msg-recipient:checked');
            const recipientIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (recipientIds.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è');
                return;
            }

            const message = document.getElementById('ved-container-msg-text').value.trim();
            const fileInput = document.getElementById('ved-container-msg-file-input');
            const hasFiles = fileInput && fileInput.files && fileInput.files.length > 0;

            if (!message && !hasFiles) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª');
                return;
            }

            try {
                let resp;
                if (hasFiles) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–æ–≤
                    const formData = new FormData();
                    formData.append('container_id', editingVedContainerId);
                    formData.append('recipient_ids', recipientIds.join(','));
                    formData.append('message', message);
                    for (let i = 0; i < fileInput.files.length; i++) {
                        formData.append('files', fileInput.files[i]);
                    }
                    // –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º authFetch —Å Content-Type, –±—Ä–∞—É–∑–µ—Ä —Å–∞–º –≤—ã—Å—Ç–∞–≤–∏—Ç boundary
                    resp = await fetch('/api/container-messages/send', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + authToken },
                        body: formData
                    });
                } else {
                    // JSON –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
                    resp = await authFetch('/api/container-messages/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            container_id: editingVedContainerId,
                            recipient_ids: recipientIds,
                            message: message
                        })
                    });
                }
                const data = await resp.json();

                if (data.success) {
                    document.getElementById('ved-container-msg-text').value = '';
                    // –û—á–∏—â–∞–µ–º —Ñ–∞–π–ª–æ–≤—ã–π –∏–Ω–ø—É—Ç –∏ –ø—Ä–µ–≤—å—é
                    if (fileInput) fileInput.value = '';
                    const preview = document.getElementById('ved-container-msg-files-preview');
                    if (preview) { preview.innerHTML = ''; preview.style.display = 'none'; }
                    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å —á–µ–∫–±–æ–∫—Å–æ–≤
                    document.querySelectorAll('.container-msg-recipient').forEach(cb => cb.checked = false);
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                    loadContainerMessages(editingVedContainerId);
                } else {
                    alert(data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', err);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
            }
        }

        // ============================================================================
        // –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ò –£–î–ê–õ–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô
        // ============================================================================

        /**
         * –ù–∞—á–∞—Ç—å –∏–Ω–ª–∞–π–Ω-—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è.
         * –ó–∞–º–µ–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫ –Ω–∞ textarea —Å –∫–Ω–æ–ø–∫–∞–º–∏ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å/–û—Ç–º–µ–Ω–∞.
         *
         * @param {string} msgSource - 'container' –∏–ª–∏ 'document'
         * @param {number} messageId - ID —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ë–î
         * @param {HTMLElement} msgElement - DOM-—ç–ª–µ–º–µ–Ω—Ç –ø—É–∑—ã—Ä—è —Å–æ–æ–±—â–µ–Ω–∏—è (—Å data-message-text)
         */
        function editMessage(msgSource, messageId, msgElement) {
            const currentText = msgElement.getAttribute('data-message-text') || '';

            // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            const textDiv = msgElement.querySelector('.msg-text-content')
                || msgElement.querySelector('.chat-message-text')
                || msgElement.querySelector('.message-card-text');
            if (!textDiv) return;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π HTML –¥–ª—è –æ—Ç–º–µ–Ω—ã
            const originalHtml = textDiv.innerHTML;
            textDiv.setAttribute('data-original-html', originalHtml);

            // –ó–∞–º–µ–Ω—è–µ–º –Ω–∞ textarea + –∫–Ω–æ–ø–∫–∏
            textDiv.innerHTML = `
                <textarea class="msg-edit-textarea">${escapeHtml(currentText)}</textarea>
                <div class="msg-edit-actions">
                    <button class="msg-edit-cancel" onclick="cancelEditMessage(this)">–û—Ç–º–µ–Ω–∞</button>
                    <button class="msg-edit-save" onclick="saveEditMessage('${msgSource}', ${messageId}, this)">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            `;

            // –§–æ–∫—É—Å –Ω–∞ textarea –∏ –∫—É—Ä—Å–æ—Ä –≤ –∫–æ–Ω–µ—Ü
            const textarea = textDiv.querySelector('.msg-edit-textarea');
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }

        /**
         * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
         * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST-–∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π API.
         */
        async function saveEditMessage(msgSource, messageId, btnElement) {
            const textDiv = btnElement.closest('.msg-edit-actions').parentElement;
            const textarea = textDiv.querySelector('.msg-edit-textarea');
            const newMessage = textarea.value.trim();

            if (!newMessage) {
                alert('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return;
            }

            const apiUrl = msgSource === 'container'
                ? '/api/container-messages/edit'
                : '/api/document-messages/edit';

            try {
                btnElement.disabled = true;
                btnElement.textContent = '...';

                const resp = await authFetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message_id: messageId, message: newMessage })
                });
                const data = await resp.json();

                if (data.success) {
                    reloadCurrentMessages(msgSource);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    btnElement.disabled = false;
                    btnElement.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', err);
                alert('–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è');
                btnElement.disabled = false;
                btnElement.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            }
        }

        /**
         * –û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –≤–µ—Ä–Ω—É—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç.
         */
        function cancelEditMessage(btnElement) {
            const textDiv = btnElement.closest('.msg-edit-actions').parentElement;
            const originalHtml = textDiv.getAttribute('data-original-html');
            if (originalHtml !== null) {
                textDiv.innerHTML = originalHtml;
                textDiv.removeAttribute('data-original-html');
            }
        }

        /**
         * –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º.
         *
         * @param {string} msgSource - 'container' –∏–ª–∏ 'document'
         * @param {number} messageId - ID —Å–æ–æ–±—â–µ–Ω–∏—è
         */
        async function deleteMessage(msgSource, messageId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

            const apiUrl = msgSource === 'container'
                ? '/api/container-messages/delete'
                : '/api/document-messages/delete';

            try {
                const resp = await authFetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message_id: messageId })
                });
                const data = await resp.json();

                if (data.success) {
                    reloadCurrentMessages(msgSource);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', err);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è');
            }
        }

        /**
         * –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
         * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è.
         */
        function reloadCurrentMessages(msgSource) {
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–º–æ–¥–∞–ª–∫–∞ –í–≠–î)
            if (msgSource === 'container' && typeof editingVedContainerId !== 'undefined' && editingVedContainerId) {
                loadContainerMessages(editingVedContainerId);
            }
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–º–æ–¥–∞–ª–∫–∞ –ø—Ä–∏—Ö–æ–¥–∞)
            if (msgSource === 'document' && typeof editingDocId !== 'undefined' && editingDocId) {
                loadDocumentMessages('receipt', editingDocId);
            }
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –≤–∫–ª–∞–¥–∫–∏ –°–æ–æ–±—â–µ–Ω–∏—è (–µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞)
            const messagesTab = document.getElementById('messages');
            if (messagesTab && messagesTab.style.display !== 'none') {
                loadAllMessages();
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º badge –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
            if (typeof updateMessagesBadge === 'function') {
                updateMessagesBadge();
            }
        }

        // ============================================================================
        // –í–´–ü–ê–î–ê–Æ–©–ò–ô –°–ü–ò–°–û–ö –ü–û–°–¢–ê–í–©–ò–ö–û–í –í–≠–î
        // ============================================================================

        /**
         * –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –≤ dropdown
         */
        function renderVedSupplierDropdown(filter = '') {
            const dropdown = document.getElementById('ved-supplier-dropdown');
            if (!dropdown) return;

            const filterLower = (filter || '').toLowerCase();
            const filtered = vedSuppliers.filter(s =>
                !filterLower || s.name.toLowerCase().includes(filterLower)
            );

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="destination-dropdown-item" style="color: #999;">–ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π</div>';
                return;
            }

            dropdown.innerHTML = filtered.map(s =>
                `<div class="destination-dropdown-item" onclick="selectVedSupplier('${s.name.replace(/'/g, "\\'")}')">${s.name}</div>`
            ).join('');
        }

        /**
         * –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å dropdown –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
         */
        function toggleVedSupplierDropdown() {
            const dropdown = document.getElementById('ved-supplier-dropdown');
            const input = document.getElementById('ved-container-supplier');
            if (!dropdown) return;

            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
            } else {
                renderVedSupplierDropdown(input.value);
                dropdown.classList.add('show');
            }
        }

        /**
         * –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –ø—Ä–∏ –≤–≤–æ–¥–µ
         */
        function filterVedSuppliers() {
            const dropdown = document.getElementById('ved-supplier-dropdown');
            const input = document.getElementById('ved-container-supplier');
            if (!dropdown) return;

            renderVedSupplierDropdown(input.value);
            dropdown.classList.add('show');
        }

        /**
         * –í—ã–±—Ä–∞—Ç—å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
         */
        function selectVedSupplier(name) {
            const input = document.getElementById('ved-container-supplier');
            const dropdown = document.getElementById('ved-supplier-dropdown');
            input.value = name;
            dropdown.classList.remove('show');
        }

        /**
         * –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫
         */
        function addNewVedSupplier() {
            const input = document.getElementById('ved-container-supplier');
            const name = (input.value || '').trim();

            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –ø–æ—Å—Ç–∞–≤—â–∏–∫
            if (vedSuppliers.some(s => s.name.toLowerCase() === name.toLowerCase())) {
                alert('–¢–∞–∫–æ–π –ø–æ—Å—Ç–∞–≤—â–∏–∫ —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ');
                return;
            }

            authFetch('/api/ved/suppliers/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    vedSuppliers.push({ id: data.id, name: name });
                    renderVedSupplierDropdown();
                    alert('–ü–æ—Å—Ç–∞–≤—â–∏–∫ "' + name + '" –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫');
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞:', err);
                alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞');
            });
        }

        // –ó–∞–∫—Ä—ã—Ç—å dropdown –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
        document.addEventListener('click', function(e) {
            const wrapper = document.querySelector('#ved-container-form .destination-dropdown-wrapper');
            const dropdown = document.getElementById('ved-supplier-dropdown');
            if (wrapper && dropdown && !wrapper.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        /**
         * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
         */
        function formatCurrencyRate(rate) {
            if (!rate) return '‚Äî';
            return rate.toFixed(2).replace(/\\B(?=(\\d{3})+(?!\\d))/g, ' ');
        }

        /**
         * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–∞ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –º–µ–∂–¥—É —Ç—ã—Å—è—á–Ω—ã–º–∏
         */
        function formatNumberWithSpaces(num) {
            if (num === null || num === undefined || num === '') return '';
            const n = parseInt(num);
            if (isNaN(n)) return '';
            return n.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ' ');
        }

        /**
         * –ü–∞—Ä—Å–∏–Ω–≥ —á–∏—Å–ª–∞ –∏–∑ —Å—Ç—Ä–æ–∫–∏ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏
         */
        function parseNumberFromSpaces(str) {
            if (!str) return 0;
            return parseInt(str.replace(/\s/g, '')) || 0;
        }

        /**
         * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –±–µ–∑ –≥–æ–¥–∞ (–î–î.–ú–ú)
         */
        function formatDateNoYear(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            if (parts.length === 3) return parts[2] + '.' + parts[1];
            if (parts.length === 2) return parts[1] + '.' + parts[0];
            return dateStr;
        }

        /**
         * –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –ø–æ—Å—Ç–∞–≤–æ–∫ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –±–∞–∑—ã
         */
        function renderSuppliesTable(supplies) {
            const tbody = document.getElementById('supplies-tbody');
            tbody.innerHTML = '';

            supplies.forEach(s => {
                const row = createSupplyRowElement(s);
                tbody.appendChild(row);
            });

            // –ü–æ—Å–ª–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏: –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö, —Ñ–∏–ª—å—Ç—Ä, –∏—Ç–æ–≥–∏
            highlightAllEmptyCells();
            populateSuppliesFilter();
            updateSupplyTotals();
        }

        /**
         * –°–æ–∑–¥–∞–Ω–∏–µ HTML-—ç–ª–µ–º–µ–Ω—Ç–∞ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –ø–æ—Å—Ç–∞–≤–æ–∫
         *
         * –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
         *   data ‚Äî –æ–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ—Å—Ç–∞–≤–∫–∏ (–∏–∑ –±–∞–∑—ã) –∏–ª–∏ null –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
         */
        function createSupplyRowElement(data) {
            const row = document.createElement('tr');
            // –°—Ç—Ä–æ–∫–∏ –ø–æ—Å—Ç–∞–≤–æ–∫ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –í–≠–î
            const isNewRow = !data;
            const rowId = data ? data.id : 'new_' + Date.now();
            row.dataset.supplyId = rowId;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≤—è–∑—å —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º –í–≠–î
            if (data && data.container_doc_id) {
                row.dataset.containerDocId = data.container_doc_id;
            }
            if (data && data.container_item_id) {
                row.dataset.containerItemId = data.container_item_id;
            }

            // 1. –¢–æ–≤–∞—Ä (—Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è - –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –í–≠–î)
            const tdProduct = document.createElement('td');
            tdProduct.className = 'supply-readonly-cell';
            const productSpan = document.createElement('span');
            productSpan.className = 'supply-readonly-value';

            // –ù–∞—Ö–æ–¥–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ SKU
            if (data && data.sku) {
                const product = suppliesProducts.find(p => p.sku == data.sku);
                productSpan.textContent = product ? (product.offer_id || product.sku) : data.sku;
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º SKU –≤ data-–∞—Ç—Ä–∏–±—É—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
                tdProduct.dataset.sku = data.sku;
            } else {
                productSpan.textContent = '‚Äî';
                productSpan.style.color = '#999';
            }

            tdProduct.appendChild(productSpan);
            row.appendChild(tdProduct);

            // 2. –î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞ —Å —Ñ–∞–±—Ä–∏–∫–∏ (–∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ‚Äî –Ω–µ—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–∞—è)
            row.appendChild(createReadOnlyDateCell(data ? data.exit_factory_date : '', data && data.container_doc_id));

            // 3. –ö–æ–ª-–≤–æ –≤—ã—Ö–æ–¥–∞ —Å —Ñ–∞–±—Ä–∏–∫–∏ (–∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ‚Äî –Ω–µ—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ)
            row.appendChild(createReadOnlyNumberCell(data ? data.exit_factory_qty : '', data && data.container_doc_id));

            // 4. –ö–æ–ª-–≤–æ –ø—Ä–∏—Ö–æ–¥–∞ –Ω–∞ —Å–∫–ª–∞–¥ (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ)
            row.appendChild(createNumberCell(data ? data.arrival_warehouse_qty : '', false, row, 'arrival_warehouse_qty'));

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à—ë–Ω –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–¥–∞–Ω–Ω—ã–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö)
            const isContainerCompleted = data && (data.container_is_completed === 1 || data.container_is_completed === true);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ data-–∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å–≤–æ–¥–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
            row.dataset.containerCompleted = isContainerCompleted ? '1' : '0';
            row.dataset.logisticsCost = data ? (data.logistics_cost_per_unit || 0) : 0;
            row.dataset.exitFactoryQty = data ? (data.exit_factory_qty || 0) : 0;

            // –î–∞–Ω–Ω—ã–µ –∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–Ω–µ —É—Å—Ä–µ–¥–Ω—ë–Ω–Ω—ã–µ!)
            // logistics_cost_per_unit - —É–∂–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Å—Ç–∞–≤–∫–∏ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            // price_cny * adjusted_rate - —Ü–µ–Ω–∞ –≤ —Ä—É–±–ª—è—Ö (—Å —É—á—ë—Ç–æ–º –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –Ω–∞—Ü–µ–Ω–∫–∏)
            const containerLogistics = data ? (data.logistics_cost_per_unit || 0) : 0;
            const containerPriceCny = data ? (data.price_cny || 0) : 0;
            const containerCnyRate = data ? (data.container_cny_rate || 0) : 0;
            const containerCnyPercent = data ? (data.container_cny_percent || 0) : 0;
            // –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫—É—Ä—Å —Å —É—á—ë—Ç–æ–º –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –Ω–∞—Ü–µ–Ω–∫–∏ (–∫–∞–∫ –≤ –í–≠–î –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è—Ö)
            const adjustedCnyRate = containerCnyRate * (1 + containerCnyPercent / 100);
            const containerPriceRub = containerPriceCny * adjustedCnyRate;

            // 5. –°—Ç–æ–∏–º–æ—Å—Ç—å –ª–æ–≥–∏—Å—Ç–∏–∫–∏ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (–∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö)
            const tdLogistics = document.createElement('td');
            const logisticsSpan = document.createElement('span');
            logisticsSpan.className = 'supply-logistics-auto';
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–≤–µ—Ä—à—ë–Ω
            if (isContainerCompleted && containerLogistics > 0) {
                logisticsSpan.textContent = formatNumberWithSpaces(Math.round(containerLogistics));
                logisticsSpan.title = '–õ–æ–≥–∏—Å—Ç–∏–∫–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞';
            } else {
                logisticsSpan.textContent = '‚Äî';
                logisticsSpan.style.color = '#999';
                if (!isContainerCompleted && data && data.container_doc_id) {
                    logisticsSpan.title = '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω';
                }
            }
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤ (0 –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω)
            logisticsSpan.dataset.value = isContainerCompleted ? containerLogistics : 0;
            tdLogistics.appendChild(logisticsSpan);
            // –î–ª—è –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –ª–æ–≥–∏—Å—Ç–∏–∫—É —Å–∏–Ω–∏–º –º–µ–ª–∫–∏–º —à—Ä–∏—Ñ—Ç–æ–º
            if (!isContainerCompleted && data && data.container_doc_id && containerLogistics > 0) {
                const logisticsHint = document.createElement('div');
                logisticsHint.style.cssText = 'color: #2196F3; font-size: 11px; margin-top: 2px;';
                logisticsHint.textContent = formatNumberWithSpaces(Math.round(containerLogistics));
                logisticsHint.title = '–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏—Å—Ç–∏–∫–∞ –∑–∞ –µ–¥. (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω)';
                tdLogistics.appendChild(logisticsHint);
            }
            row.appendChild(tdLogistics);

            // 6. –¶–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞ –µ–¥–∏–Ω–∏—Ü–∞ –≤ —Ä—É–±–ª—è—Ö (–∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö)
            const tdPrice = document.createElement('td');
            const priceSpan = document.createElement('span');
            priceSpan.className = 'supply-price-auto';
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–≤–µ—Ä—à—ë–Ω
            if (isContainerCompleted && containerPriceRub > 0) {
                priceSpan.textContent = formatNumberWithSpaces(Math.round(containerPriceRub));
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É–ª—É —Å —É—á—ë—Ç–æ–º –ø—Ä–æ—Ü–µ–Ω—Ç–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                const rateInfo = containerCnyPercent > 0
                    ? containerCnyRate.toFixed(2) + ' √ó ' + (1 + containerCnyPercent/100).toFixed(2) + ' = ' + adjustedCnyRate.toFixed(2)
                    : containerCnyRate.toFixed(2);
                priceSpan.title = '–¶–µ–Ω–∞ ' + containerPriceCny + ' ¬• √ó ' + rateInfo + ' = ' + Math.round(containerPriceRub) + ' ‚ÇΩ';
            } else {
                priceSpan.textContent = '‚Äî';
                priceSpan.style.color = '#999';
                if (!isContainerCompleted && data && data.container_doc_id) {
                    priceSpan.title = '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω';
                }
            }
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤ (0 –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω)
            priceSpan.dataset.value = isContainerCompleted ? containerPriceRub : 0;
            tdPrice.appendChild(priceSpan);
            // –î–ª—è –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É —Å–∏–Ω–∏–º –º–µ–ª–∫–∏–º —à—Ä–∏—Ñ—Ç–æ–º
            if (!isContainerCompleted && data && data.container_doc_id && containerPriceRub > 0) {
                const priceHint = document.createElement('div');
                priceHint.style.cssText = 'color: #2196F3; font-size: 11px; margin-top: 2px;';
                priceHint.textContent = formatNumberWithSpaces(Math.round(containerPriceRub));
                priceHint.title = '–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ –∑–∞ –µ–¥. (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω)';
                tdPrice.appendChild(priceHint);
            }
            row.appendChild(tdPrice);

            // 7. –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞ +6% = (–ª–æ–≥–∏—Å—Ç–∏–∫–∞ + —Ü–µ–Ω–∞) * 1.06 (—Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö)
            const tdCost = document.createElement('td');
            const costSpan = document.createElement('span');
            costSpan.className = 'supply-cost-auto';
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–≤–µ—Ä—à—ë–Ω
            if (isContainerCompleted && (containerLogistics > 0 || containerPriceRub > 0)) {
                const costPlus6 = (containerLogistics + containerPriceRub) * 1.06;
                costSpan.textContent = formatNumberWithSpaces(Math.round(costPlus6));
                costSpan.title = '–§–æ—Ä–º—É–ª–∞: (' + Math.round(containerLogistics) + ' + ' + Math.round(containerPriceRub) + ') √ó 1.06';
            } else {
                costSpan.textContent = '‚Äî';
                costSpan.style.color = '#999';
                if (!isContainerCompleted && data && data.container_doc_id) {
                    costSpan.title = '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω';
                }
            }
            tdCost.appendChild(costSpan);
            row.appendChild(tdCost);

            // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —É–±—Ä–∞–Ω–∞ - —Å—Ç—Ä–æ–∫–∏ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –í–≠–î

            return row;
        }

        /**
         * –°–æ–∑–¥–∞–Ω–∏–µ —è—á–µ–π–∫–∏ —Å –ø–æ–ª–µ–º –¥–∞—Ç—ã (–±–µ–∑ –≥–æ–¥–∞ ‚Äî –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –î–î.–ú–ú)
         * @param {string} value - –∑–Ω–∞—á–µ–Ω–∏–µ –¥–∞—Ç—ã
         * @param {boolean} isLocked - –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
         * @param {HTMLElement} row - —Å—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
         * @param {number} dateIndex - –∏–Ω–¥–µ–∫—Å –¥–∞—Ç—ã (0=–ø–ª–∞–Ω, 1=–≤—ã—Ö–æ–¥ —Å —Ñ–∞–±—Ä–∏–∫–∏, 2=–ø—Ä–∏—Ö–æ–¥ –Ω–∞ —Å–∫–ª–∞–¥)
         * @param {boolean} withEditButton - –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
         */
        function createDateCell(value, isLocked, row, dateIndex, withEditButton = false) {
            const td = document.createElement('td');
            td.style.position = 'relative';
            const input = document.createElement('input');
            input.type = 'date';
            input.className = 'supply-input supply-date-input';
            input.style.minWidth = '110px';
            if (value) input.value = value;

            // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –Ω—É–∂–Ω–∞ –∫–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ
            const hasValue = value && value.trim() !== '';
            if (withEditButton && hasValue) {
                input.disabled = true;
            }

            let dateEditBtn = null;
            let originalDateValue = value || '';
            let isEditMode = false;

            if (withEditButton) {
                dateEditBtn = document.createElement('button');
                dateEditBtn.type = 'button';
                dateEditBtn.className = 'supply-field-edit-btn';
                dateEditBtn.textContent = '–†–µ–¥';
                dateEditBtn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—É –ø–ª–∞–Ω–∞';
                dateEditBtn.style.cssText = 'position:absolute;right:2px;top:50%;transform:translateY(-50%);border:1px solid #f59e0b;background:#fff8e1;border-radius:4px;cursor:pointer;padding:2px 6px;font-size:11px;color:#d97706;font-weight:600;line-height:1.4;z-index:1;display:none;';
                if (hasValue) {
                    dateEditBtn.style.display = 'inline-block';
                }
                dateEditBtn.onclick = function() {
                    originalDateValue = input.value;
                    isEditMode = true;
                    input.disabled = false;
                    dateEditBtn.style.display = 'none';
                    input.focus();
                };
            }

            input.onchange = () => {
                // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Ä—è–¥–∫–∞ –¥–∞—Ç –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏
                const dateInputs = row.querySelectorAll('input[type="date"]');
                const planDate = dateInputs[0] ? dateInputs[0].value : '';
                const factoryDate = dateInputs[1] ? dateInputs[1].value : '';
                const arrivalDate = dateInputs[2] ? dateInputs[2].value : '';

                // dateIndex: 0=–ø–ª–∞–Ω, 1=–≤—ã—Ö–æ–¥ —Å —Ñ–∞–±—Ä–∏–∫–∏, 2=–ø—Ä–∏—Ö–æ–¥ –Ω–∞ —Å–∫–ª–∞–¥
                if (dateIndex === 1 && planDate && factoryDate && factoryDate < planDate) {
                    alert('‚ö†Ô∏è –î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞ —Å —Ñ–∞–±—Ä–∏–∫–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –ø–ª–∞–Ω–∞');
                    input.value = '';
                    return;
                }
                if (dateIndex === 2 && factoryDate && arrivalDate && arrivalDate < factoryDate) {
                    alert('‚ö†Ô∏è –î–∞—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∞ –Ω–∞ —Å–∫–ª–∞–¥ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –≤—ã—Ö–æ–¥–∞ —Å —Ñ–∞–±—Ä–∏–∫–∏');
                    input.value = '';
                    return;
                }

                // –ï—Å–ª–∏ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                if (withEditButton && isEditMode && input.value !== originalDateValue) {
                    showFieldChangeConfirm(
                        '–ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã',
                        '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É?',
                        function() {
                            originalDateValue = input.value;
                            isEditMode = false;
                            input.disabled = true;
                            if (dateEditBtn) dateEditBtn.style.display = 'inline-block';
                            onSupplyFieldChange(row);
                            highlightEmptyCells(row);
                            updateSupplyTotals();
                        },
                        function() {
                            input.value = originalDateValue;
                            isEditMode = false;
                            input.disabled = true;
                            if (dateEditBtn) dateEditBtn.style.display = 'inline-block';
                        }
                    );
                    return;
                }

                onSupplyFieldChange(row);
                highlightEmptyCells(row);
                updateSupplyTotals();
            };

            // –ü—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            if (withEditButton) {
                input.onblur = function() {
                    setTimeout(() => {
                        if (input.value.trim() !== '' && dateEditBtn && !input.disabled) {
                            input.disabled = true;
                            dateEditBtn.style.display = 'inline-block';
                            isEditMode = false;
                        }
                    }, 200);
                };
            }

            td.appendChild(input);
            if (dateEditBtn) td.appendChild(dateEditBtn);
            return td;
        }

        /**
         * –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–π —è—á–µ–π–∫–∏ —Å –¥–∞—Ç–æ–π (–¥–ª—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞).
         * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì.
         */
        function createReadOnlyDateCell(value, isFromContainer) {
            const td = document.createElement('td');
            td.className = 'supply-readonly-cell';
            const span = document.createElement('span');
            span.className = 'supply-readonly-value';

            if (value) {
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –∫–∞–∫ –î–î.–ú–ú.–ì–ì–ì–ì
                const parts = value.split('-');
                if (parts.length === 3) {
                    span.textContent = parts[2] + '.' + parts[1] + '.' + parts[0];
                } else {
                    span.textContent = value;
                }
            } else {
                span.textContent = '‚Äî';
                span.style.color = '#999';
            }

            td.appendChild(span);
            return td;
        }

        /**
         * –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–π —è—á–µ–π–∫–∏ —Å —á–∏—Å–ª–æ–º (–¥–ª—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞).
         */
        function createReadOnlyNumberCell(value, isFromContainer) {
            const td = document.createElement('td');
            td.className = 'supply-readonly-cell';
            const span = document.createElement('span');
            span.className = 'supply-readonly-value';

            if (value !== null && value !== undefined && value !== '' && value !== 0) {
                span.textContent = formatNumberWithSpaces(Math.round(parseFloat(value)));
            } else {
                span.textContent = '‚Äî';
                span.style.color = '#999';
            }

            td.appendChild(span);
            return td;
        }

        /**
         * –ü—Ä–æ–≤–µ—Ä–∫–∞: –º–æ–∂–Ω–æ –ª–∏ –∑–∞–ø–æ–ª–Ω—è—Ç—å arrival_warehouse_qty.
         *
         * –ù–µ–ª—å–∑—è, –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–æ–∫–∞ —Ç–æ–≥–æ –∂–µ —Ç–æ–≤–∞—Ä–∞ (–ø–æ –¥–∞—Ç–µ –≤—ã—Ö–æ–¥–∞ —Å —Ñ–∞–±—Ä–∏–∫–∏)
         * –Ω–µ –∏–º–µ–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ "–ö–æ–ª-–≤–æ –ø—Ä–∏—Ö–æ–¥–∞ –Ω–∞ —Å–∫–ª–∞–¥".
         *
         * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç true –µ—Å–ª–∏ –º–æ–∂–Ω–æ –∑–∞–ø–æ–ª–Ω—è—Ç—å, false –µ—Å–ª–∏ –Ω–µ—Ç.
         */
        function canFillQtyField(row, fieldName) {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–∏—Ö–æ–¥–∞ –Ω–∞ —Å–∫–ª–∞–¥
            if (fieldName !== 'arrival_warehouse_qty') return true;

            const data = getRowData(row);
            if (!data.sku) return true;

            const currentDate = data.exit_factory_date || '';
            const allRows = Array.from(document.querySelectorAll('#supplies-tbody tr'));

            // –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏ —Å —Ç–µ–º –∂–µ SKU –∏ –±–æ–ª–µ–µ —Ä–∞–Ω–Ω–µ–π –¥–∞—Ç–æ–π –≤—ã—Ö–æ–¥–∞ —Å —Ñ–∞–±—Ä–∏–∫–∏
            const prevRows = allRows.filter(r => {
                if (r === row) return false;
                const rCells = r.querySelectorAll('td');
                const sku = rCells[0] ? (parseInt(rCells[0].dataset.sku) || 0) : 0;
                if (sku !== data.sku) return false;

                // –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –≤—ã—Ö–æ–¥–∞ —Å —Ñ–∞–±—Ä–∏–∫–∏ –∏–∑ span
                const exitDateSpan = rCells[1] ? rCells[1].querySelector('.supply-readonly-value') : null;
                const rDate = exitDateSpan ? exitDateSpan.textContent.trim() : '';
                if (rDate === '‚Äî') return false;

                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ñ–æ—Ä–º–∞—Ç –î–î.–ú–ú.–ì–ì–ì–ì –≤ –ì–ì–ì–ì-–ú–ú-–î–î –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                const parts = rDate.split('.');
                const rDateFormatted = parts.length === 3 ? parts[2] + '-' + parts[1] + '-' + parts[0] : '';

                if (currentDate && rDateFormatted) return rDateFormatted < currentDate;
                return allRows.indexOf(r) < allRows.indexOf(row);
            });

            if (prevRows.length === 0) return true;

            for (const prevRow of prevRows) {
                const textInputs = prevRow.querySelectorAll('input[type="text"]');
                // textInputs[0] = arrival_warehouse_qty (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π input)
                const val = textInputs[0] ? textInputs[0].value.trim() : '';
                if (val === '') {
                    alert('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ "–ö–æ–ª-–≤–æ –ø—Ä–∏—Ö–æ–¥–∞ –Ω–∞ —Å–∫–ª–∞–¥" –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –ø–æ—Å—Ç–∞–≤–∫–µ —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞');
                    return false;
                }
            }
            return true;
        }

        /**
         * –°–æ–∑–¥–∞–Ω–∏–µ —è—á–µ–π–∫–∏ –¥–ª—è –∫–æ–ª-–≤–∞ –ø—Ä–∏—Ö–æ–¥–∞ –Ω–∞ —Å–∫–ª–∞–¥.
         * –ü–æ–ª–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è (–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–π).
         * –î–æ–±–∞–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫—É —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π.
         */
        function createNumberCell(value, isLocked, row, fieldName) {
            const td = document.createElement('td');
            td.style.position = 'relative';
            td.className = 'supply-arrival-cell';

            // Span –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è)
            const valueSpan = document.createElement('span');
            valueSpan.className = 'supply-arrival-value';
            if (value !== null && value !== undefined && value !== '' && value !== 0) {
                valueSpan.textContent = formatNumberWithSpaces(Math.round(parseFloat(value)));
            } else {
                valueSpan.textContent = '0';
                valueSpan.style.color = '#999';
            }
            td.appendChild(valueSpan);

            // –ö–Ω–æ–ø–∫–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ)
            if (value && parseFloat(value) > 0) {
                const expandBtn = document.createElement('button');
                expandBtn.type = 'button';
                expandBtn.className = 'supply-expand-btn';
                expandBtn.textContent = '‚ñº';
                expandBtn.title = '–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—Ö–æ–¥';
                expandBtn.style.cssText = 'position:absolute;right:2px;top:50%;transform:translateY(-50%);border:1px solid #ddd;background:#f5f5f5;border-radius:4px;cursor:pointer;padding:2px 6px;font-size:10px;color:#666;line-height:1;';
                expandBtn.onclick = function(e) {
                    e.stopPropagation();
                    toggleSupplyDistributions(row, expandBtn);
                };
                td.appendChild(expandBtn);
            }

            return td;
        }

        /**
         * –†–∞—Å–∫—Ä—ã—Ç—å/—Å–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –¥–ª—è —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å—Ç–∞–≤–∫–∏.
         */
        function toggleSupplyDistributions(row, btn) {
            const supplyId = row.dataset.supplyId;
            if (!supplyId || supplyId.startsWith('new_')) return;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
            const existingDetails = row.nextElementSibling;
            if (existingDetails && existingDetails.classList.contains('supply-distributions-row')) {
                existingDetails.remove();
                if (btn) btn.textContent = '‚ñº';
                return;
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
            authFetch('/api/supplies/' + supplyId + '/distributions')
                .then(r => r.json())
                .then(data => {
                    if (!data.success || !data.distributions || data.distributions.length === 0) {
                        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –ø—Ä–∏—Ö–æ–¥–æ–≤');
                        return;
                    }

                    // –°–æ–∑–¥–∞—ë–º —Å—Ç—Ä–æ–∫—É —Å –¥–µ—Ç–∞–ª—è–º–∏
                    const detailsRow = document.createElement('tr');
                    detailsRow.className = 'supply-distributions-row';
                    detailsRow.style.backgroundColor = '#f9fafb';

                    const detailsTd = document.createElement('td');
                    detailsTd.colSpan = 8;
                    detailsTd.style.padding = '8px 16px';

                    let html = '<div style="font-size:12px;color:#666;"><strong>üì¶ –ü—Ä–∏—Ö–æ–¥—ã (–æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏—è):</strong><ul style="margin:4px 0 0 16px;padding:0;list-style:none;">';
                    data.distributions.forEach(d => {
                        const date = d.receipt_date ? d.receipt_date.split('-').reverse().join('.') : '‚Äî';
                        const cost = d.cost_plus_6 ? formatNumberWithSpaces(Math.round(d.cost_plus_6)) : '‚Äî';
                        html += '<li style="margin:2px 0;">üìã –î–∞—Ç–∞: <strong>' + date + '</strong>, –ö–æ–ª-–≤–æ: <strong>' + formatNumberWithSpaces(d.quantity) + '</strong>, –°–µ–±–µ—Å—Ç.+6%: <strong>' + cost + ' ‚ÇΩ</strong></li>';
                    });
                    html += '</ul></div>';

                    detailsTd.innerHTML = html;
                    detailsRow.appendChild(detailsTd);

                    // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏
                    row.after(detailsRow);
                    if (btn) btn.textContent = '‚ñ≤';
                });
        }

        /**
         * –°–æ–∑–¥–∞–Ω–∏–µ —è—á–µ–π–∫–∏ —Å —á–µ–∫–±–æ–∫—Å–æ–º
         */
        function createCheckboxCell(checked, isLocked, row) {
            const td = document.createElement('td');
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.className = 'supply-checkbox';
            cb.checked = !!checked;
            cb.disabled = isLocked;
            cb.onchange = () => {
                onSupplyFieldChange(row);
                highlightEmptyCells(row);
            };
            td.appendChild(cb);
            return td;
        }

        /**
         * –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É –ø–æ—Å—Ç–∞–≤–æ–∫
         */
        function addSupplyRow() {
            const overlay = document.createElement('div');
            overlay.className = 'supply-edit-confirm';
            overlay.innerHTML = `
                <div class="supply-edit-confirm-box">
                    <h3>–ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞</h3>
                    <p>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –ø–æ—Å—Ç–∞–≤–∫–∏?</p>
                    <button class="supply-confirm-yes">–î–∞, —Å–æ–∑–¥–∞—Ç—å</button>
                    <button class="supply-confirm-no">–û—Ç–º–µ–Ω–∞</button>
                </div>
            `;
            overlay.querySelector('.supply-confirm-yes').onclick = () => {
                overlay.remove();
                const tbody = document.getElementById('supplies-tbody');
                const row = createSupplyRowElement(null, null);
                tbody.appendChild(row);
                highlightEmptyCells(row);
                updateSupplyTotals();
            };
            overlay.querySelector('.supply-confirm-no').onclick = () => {
                overlay.remove();
            };
            document.body.appendChild(overlay);
        }

        /**
         * –ò–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –≤ –æ–±—ä–µ–∫—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.
         *
         * –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç–æ–ª–±—Ü–æ–≤:
         * 0: –¢–æ–≤–∞—Ä (select)
         * 1: –î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞ —Å —Ñ–∞–±—Ä–∏–∫–∏ (span, –Ω–µ—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–∞—è)
         * 2: –ö–æ–ª-–≤–æ –≤—ã—Ö–æ–¥–∞ —Å —Ñ–∞–±—Ä–∏–∫–∏ (span, –Ω–µ—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ)
         * 3: –î–∞—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∞ –Ω–∞ —Å–∫–ª–∞–¥ (input[type=date])
         * 4: –ö–æ–ª-–≤–æ –ø—Ä–∏—Ö–æ–¥–∞ –Ω–∞ —Å–∫–ª–∞–¥ (input[type=text])
         * 5-8: –í–≠–î –¥–∞–Ω–Ω—ã–µ (span)
         * 9: –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
         */
        function getRowData(row) {
            const cells = row.querySelectorAll('td');

            // –¢–æ–≤–∞—Ä - –Ω–µ—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π span —Å data-sku
            const productSku = cells[0] ? (cells[0].dataset.sku || 0) : 0;
            const productNameSpan = cells[0] ? cells[0].querySelector('.supply-readonly-value') : null;
            const productName = productNameSpan ? productNameSpan.textContent : '';

            // –î–∞—Ç–∞ –∏ –∫–æ–ª-–≤–æ –≤—ã—Ö–æ–¥–∞ —Å —Ñ–∞–±—Ä–∏–∫–∏ - –Ω–µ—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ span
            const exitFactoryDateSpan = cells[1] ? cells[1].querySelector('.supply-readonly-value') : null;
            const exitFactoryQtySpan = cells[2] ? cells[2].querySelector('.supply-readonly-value') : null;

            // –ö–æ–ª-–≤–æ –ø—Ä–∏—Ö–æ–¥–∞ –Ω–∞ —Å–∫–ª–∞–¥ - –Ω–µ—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π span
            const arrivalQtySpan = cells[3] ? cells[3].querySelector('.supply-arrival-value') : null;

            // –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç—ã –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ –î–î.–ú–ú.–ì–ì–ì–ì –≤ –ì–ì–ì–ì-–ú–ú-–î–î
            function parseDateFromSpan(span) {
                if (!span) return '';
                const text = span.textContent.trim();
                if (!text || text === '‚Äî') return '';
                const parts = text.split('.');
                if (parts.length === 3) {
                    return parts[2] + '-' + parts[1] + '-' + parts[0];
                }
                return text;
            }

            // –ü–∞—Ä—Å–∏–Ω–≥ —á–∏—Å–ª–∞ –∏–∑ span (—Å –ø—Ä–æ–±–µ–ª–∞–º–∏)
            function parseNumberFromSpan(span) {
                if (!span) return null;
                const text = span.textContent.trim();
                if (!text || text === '‚Äî') return null;
                return parseNumberFromSpaces(text);
            }

            // –õ–æ–≥–∏—Å—Ç–∏–∫–∞ –±–µ—Ä—ë—Ç—Å—è –∏–∑ –í–≠–î (span —Å dataset.value)
            const logisticsSpan = row.querySelector('.supply-logistics-auto');
            const logisticsValue = logisticsSpan ? parseFloat(logisticsSpan.dataset.value) || 0 : 0;

            // –¶–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞ —Ç–æ–∂–µ –±–µ—Ä—ë—Ç—Å—è –∏–∑ –í–≠–î (span —Å dataset.value)
            const priceSpan = row.querySelector('.supply-price-auto');
            const priceRubValue = priceSpan ? parseFloat(priceSpan.dataset.value) || 0 : 0;

            return {
                id: row.dataset.supplyId,
                container_doc_id: row.dataset.containerDocId || null,
                container_item_id: row.dataset.containerItemId || null,
                sku: parseInt(productSku) || 0,
                product_name: productName,
                exit_factory_date: parseDateFromSpan(exitFactoryDateSpan),
                exit_factory_qty: parseNumberFromSpan(exitFactoryQtySpan),
                arrival_warehouse_qty: parseNumberFromSpan(arrivalQtySpan),
                logistics_cost_per_unit: logisticsValue,
                price_rub: priceRubValue
            };
        }

        /**
         * –ü–µ—Ä–µ—Å—á—ë—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–∞ +6%
         * –§–æ—Ä–º—É–ª–∞: (–ª–æ–≥–∏—Å—Ç–∏–∫–∞_–∑–∞_–µ–¥–∏–Ω–∏—Ü—É + —Ü–µ–Ω–∞_—Ä—É–±) * 1.06
         * –ö—É—Ä—Å —é–∞–Ω—è –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –≤ —Ä—É–±–ª—è—Ö –∏–∑ –í–≠–î
         */
        function recalcCost(row) {
            const data = getRowData(row);
            const costSpan = row.querySelector('.supply-cost-auto');
            if (!costSpan) return;

            const logistics = data.logistics_cost_per_unit || 0;
            const priceRub = data.price_rub || 0;

            if (logistics > 0 || priceRub > 0) {
                const cost = (logistics + priceRub) * 1.06;
                costSpan.textContent = formatNumberWithSpaces(Math.round(cost));
            } else {
                costSpan.textContent = '‚Äî';
            }
        }

        /**
         * –ü–µ—Ä–µ—Å—á—ë—Ç –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ (–ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫—É—Ä—Å–∞)
         */
        function recalcAllCosts() {
            const rows = document.querySelectorAll('#supplies-tbody tr');
            rows.forEach(row => recalcCost(row));
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞ –≤ –ø—É—Ç–∏ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏)
            updateGoodsInTransit();
        }

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª—é–±–æ–≥–æ –ø–æ–ª—è –≤ —Å—Ç—Ä–æ–∫–µ –ø–æ—Å—Ç–∞–≤–∫–∏.
         * –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∏ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç—Ä–æ–∫—É.
         */
        function onSupplyFieldChange(row) {
            recalcCost(row);
            highlightEmptyCells(row);
            updateSupplyTotals();
            autoSaveSupplyRow(row);
        }

        /**
         * –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å—Ç–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
         */
        function autoSaveSupplyRow(row) {
            const data = getRowData(row);
            if (!data.sku) return; // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏

            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º
            const isEditing = row.dataset.editing === 'true';

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å
            const logistics = data.logistics_cost_per_unit || 0;
            const priceCny = data.price_cny || 0;
            data.cost_plus_6 = (logistics + priceCny * currentCnyRate) * 1.06;

            authFetch('/api/supplies/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(result => {
                if (result.success && result.id) {
                    row.dataset.supplyId = result.id;
                }
            });
        }

        // ============================================================
        // –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ü–û–õ–Ø (–¥–ª—è –ø–æ–ª–µ–π —Å –∫–Ω–æ–ø–∫–æ–π "–†–µ–¥")
        // ============================================================

        /**
         * –ü–æ–∫–∞–∑–∞—Ç—å –¥–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—è.
         * @param {string} title - –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–∏–∞–ª–æ–≥–∞
         * @param {string} message - —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
         * @param {function} onConfirm - —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏
         * @param {function} onCancel - —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ
         */
        function showFieldChangeConfirm(title, message, onConfirm, onCancel) {
            const overlay = document.createElement('div');
            overlay.className = 'supply-edit-confirm';
            overlay.innerHTML = `
                <div class="supply-edit-confirm-box">
                    <h3>${title}</h3>
                    <p>${message}</p>
                    <button class="supply-confirm-yes">–î–∞</button>
                    <button class="supply-confirm-no">–ù–µ—Ç</button>
                </div>
            `;

            overlay.querySelector('.supply-confirm-yes').onclick = () => {
                overlay.remove();
                if (onConfirm) onConfirm();
            };
            overlay.querySelector('.supply-confirm-no').onclick = () => {
                overlay.remove();
                if (onCancel) onCancel();
            };

            document.body.appendChild(overlay);
        }

        // ============================================================
        // –£–î–ê–õ–ï–ù–ò–ï –°–¢–†–û–ö–ò –° –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï–ú
        // ============================================================

        function deleteSupplyRow(row) {
            const overlay = document.createElement('div');
            overlay.className = 'supply-edit-confirm';
            overlay.innerHTML = `
                <div class="supply-edit-confirm-box">
                    <h3>–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏</h3>
                    <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
                    <button class="supply-confirm-yes" style="background:#ef4444;">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
                    <button class="supply-confirm-no">–û—Ç–º–µ–Ω–∞</button>
                </div>
            `;

            overlay.querySelector('.supply-confirm-yes').onclick = () => {
                overlay.remove();
                const supplyId = row.dataset.supplyId;

                // –£–¥–∞–ª—è–µ–º –∏–∑ DOM
                row.remove();
                updateSupplyTotals();

                // –£–¥–∞–ª—è–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
                if (supplyId && !String(supplyId).startsWith('new_')) {
                    authFetch('/api/supplies/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: supplyId })
                    });
                }
            };
            overlay.querySelector('.supply-confirm-no').onclick = () => {
                overlay.remove();
            };

            document.body.appendChild(overlay);
        }

        // ============================================================
        // –°–û–†–¢–ò–†–û–í–ö–ê –ü–û –°–¢–û–õ–ë–¶–ê–ú –° –î–ê–¢–ê–ú–ò
        // ============================================================

        let suppliesSortCol = -1;
        let suppliesSortAsc = true;

        /**
         * –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –ø–æ—Å—Ç–∞–≤–æ–∫ –ø–æ —Å—Ç–æ–ª–±—Ü—É —Å –¥–∞—Ç–æ–π.
         * colIndex ‚Äî –∏–Ω–¥–µ–∫—Å —Å—Ç–æ–ª–±—Ü–∞ (1 = –î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞ —Å —Ñ–∞–±—Ä–∏–∫–∏, 3 = –î–∞—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∞ –Ω–∞ —Å–∫–ª–∞–¥)
         *
         * –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç–æ–ª–±—Ü–æ–≤:
         * 0: –¢–æ–≤–∞—Ä
         * 1: –î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞ —Å —Ñ–∞–±—Ä–∏–∫–∏ (span, –Ω–µ—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–∞—è)
         * 2: –ö–æ–ª-–≤–æ –≤—ã—Ö–æ–¥–∞ —Å —Ñ–∞–±—Ä–∏–∫–∏
         * 3: –î–∞—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∞ –Ω–∞ —Å–∫–ª–∞–¥ (input[type=date])
         * 4: –ö–æ–ª-–≤–æ –ø—Ä–∏—Ö–æ–¥–∞ –Ω–∞ —Å–∫–ª–∞–¥
         * ...
         */
        function sortSuppliesByDate(colIndex) {
            const tbody = document.getElementById('supplies-tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            if (suppliesSortCol === colIndex) {
                suppliesSortAsc = !suppliesSortAsc;
            } else {
                suppliesSortCol = colIndex;
                suppliesSortAsc = true;
            }

            // –§—É–Ω–∫—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã –∏–∑ span (—Ñ–æ—Ä–º–∞—Ç –î–î.–ú–ú.–ì–ì–ì–ì ‚Üí –ì–ì–ì–ì-–ú–ú-–î–î)
            function parseDateFromSpan(span) {
                if (!span) return '';
                const text = span.textContent.trim();
                if (!text || text === '‚Äî') return '';
                const parts = text.split('.');
                if (parts.length === 3) {
                    return parts[2] + '-' + parts[1] + '-' + parts[0];
                }
                return text;
            }

            rows.sort((a, b) => {
                let valA = '', valB = '';
                const cellsA = a.querySelectorAll('td');
                const cellsB = b.querySelectorAll('td');

                if (colIndex === 1) {
                    // –î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞ —Å —Ñ–∞–±—Ä–∏–∫–∏ (span –≤ —è—á–µ–π–∫–µ 1)
                    const spanA = cellsA[1] ? cellsA[1].querySelector('.supply-readonly-value') : null;
                    const spanB = cellsB[1] ? cellsB[1].querySelector('.supply-readonly-value') : null;
                    valA = parseDateFromSpan(spanA);
                    valB = parseDateFromSpan(spanB);
                } else if (colIndex === 3) {
                    // –î–∞—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∞ –Ω–∞ —Å–∫–ª–∞–¥ (input[type=date])
                    const dateInputA = a.querySelector('input[type="date"]');
                    const dateInputB = b.querySelector('input[type="date"]');
                    valA = dateInputA ? dateInputA.value : '';
                    valB = dateInputB ? dateInputB.value : '';
                }

                // –ü—É—Å—Ç—ã–µ –¥–∞—Ç—ã ‚Äî –≤ –∫–æ–Ω–µ—Ü
                if (!valA && !valB) return 0;
                if (!valA) return 1;
                if (!valB) return -1;

                const cmp = valA.localeCompare(valB);
                return suppliesSortAsc ? cmp : -cmp;
            });

            rows.forEach(r => tbody.appendChild(r));

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–µ–ª–∫–∏
            document.querySelectorAll('.sortable-date .sort-arrow').forEach(el => el.textContent = '');
            const th = document.querySelector('.sortable-date[data-col="' + colIndex + '"] .sort-arrow');
            if (th) th.textContent = suppliesSortAsc ? ' ‚ñ≤' : ' ‚ñº';
        }

        // ============================================================
        // –§–ò–õ–¨–¢–† –ü–û –¢–û–í–ê–†–£
        // ============================================================

        /**
         * –ó–∞–ø–æ–ª–Ω—è–µ—Ç –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Ñ–∏–ª—å—Ç—Ä–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏
         */
        function populateSuppliesFilter() {
            const filter = document.getElementById('supplies-product-filter');
            if (!filter) return;

            const currentVal = filter.value;
            // –û—á–∏—â–∞–µ–º, –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ –ø—É–Ω–∫—Ç–∞ "–í—Å–µ —Ç–æ–≤–∞—Ä—ã"
            while (filter.options.length > 1) filter.remove(1);

            // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ —Å—Ç—Ä–æ–∫
            const seen = new Set();
            document.querySelectorAll('#supplies-tbody tr').forEach(row => {
                const sel = row.querySelector('select');
                if (sel && sel.value) {
                    const sku = sel.value;
                    if (!seen.has(sku)) {
                        seen.add(sku);
                        const opt = document.createElement('option');
                        opt.value = sku;
                        opt.textContent = sel.options[sel.selectedIndex]?.text || sku;
                        filter.appendChild(opt);
                    }
                }
            });

            filter.value = currentVal;
        }

        /**
         * –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–æ–≤–∞—Ä—É
         */
        function filterSuppliesTable() {
            const filter = document.getElementById('supplies-product-filter');
            const selectedSku = filter ? filter.value : '';

            document.querySelectorAll('#supplies-tbody tr').forEach(row => {
                if (!selectedSku) {
                    row.style.display = '';
                } else {
                    const sel = row.querySelector('select');
                    const rowSku = sel ? sel.value : '';
                    row.style.display = (rowSku === selectedSku) ? '' : 'none';
                }
            });

            updateSupplyTotals();
        }

        // ============================================================
        // –°–£–ú–ú–´ –ò –°–†–ï–î–ù–ò–ï –í –ü–û–î–í–ê–õ–ï –¢–ê–ë–õ–ò–¶–´
        // ============================================================

        /**
         * –û–±–Ω–æ–≤–∏—Ç—å –∏—Ç–æ–≥–∏ –≤ tfoot.
         * –ö–æ–ª-–≤–æ ‚Äî —Å—É–º–º–∞.
         * –õ–æ–≥–∏—Å—Ç–∏–∫–∞ –∏ —Ü–µ–Ω–∞ ‚Äî —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—ã–µ –ø–æ –∫–æ–ª-–≤—É –≤—ã—Ö–æ–¥–∞: Œ£(qty √ó value) / Œ£(qty)
         * –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å ‚Äî —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∏–∑ –∏—Ç–æ–≥–æ–≤–æ–π –ª–æ–≥–∏—Å—Ç–∏–∫–∏ –∏ —Ü–µ–Ω—ã: (–ª–æ–≥ + —Ü–µ–Ω–∞) √ó 1.06
         */
        function updateSupplyTotals() {
            const tfoot = document.getElementById('supplies-tfoot-row');
            if (!tfoot) return;

            // –í–∏–¥–∏–º—ã–µ —Å—Ç—Ä–æ–∫–∏
            const rows = Array.from(document.querySelectorAll('#supplies-tbody tr'))
                .filter(r => r.style.display !== 'none');

            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—ã—Ö —Ä–∞—Å—á—ë—Ç–æ–≤
            let sumExitFactory = 0, sumArrival = 0;
            let sumLogisticsWeighted = 0;  // Œ£(qty √ó logistics)
            let sumPriceWeighted = 0;      // Œ£(qty √ó price)
            let sumQtyForLogistics = 0;    // Œ£(qty) –¥–ª—è —Å—Ç—Ä–æ–∫ —Å –ª–æ–≥–∏—Å—Ç–∏–∫–æ–π
            let sumQtyForPrice = 0;        // Œ£(qty) –¥–ª—è —Å—Ç—Ä–æ–∫ —Å —Ü–µ–Ω–æ–π

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');

                // –ö–æ–ª-–≤–æ –≤—ã—Ö–æ–¥–∞ —Å —Ñ–∞–±—Ä–∏–∫–∏ (–Ω–µ—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π span –≤ —è—á–µ–π–∫–µ 2)
                let exitQty = 0;
                const exitFactorySpan = cells[2] ? cells[2].querySelector('.supply-readonly-value') : null;
                if (exitFactorySpan && exitFactorySpan.textContent !== '‚Äî') {
                    exitQty = parseNumberFromSpaces(exitFactorySpan.textContent) || 0;
                    sumExitFactory += exitQty;
                }

                // –ö–æ–ª-–≤–æ –ø—Ä–∏—Ö–æ–¥–∞ –Ω–∞ —Å–∫–ª–∞–¥ (–Ω–µ—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π span)
                const arrivalSpan = cells[3] ? cells[3].querySelector('.supply-arrival-value') : null;
                if (arrivalSpan && arrivalSpan.textContent !== '0') {
                    const val = parseNumberFromSpaces(arrivalSpan.textContent);
                    if (val) sumArrival += val;
                }

                // –õ–æ–≥–∏—Å—Ç–∏–∫–∞ ‚Äî —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è: qty √ó logistics
                const logisticsSpan = row.querySelector('.supply-logistics-auto');
                if (logisticsSpan && logisticsSpan.dataset.value && exitQty > 0) {
                    const logVal = parseFloat(logisticsSpan.dataset.value) || 0;
                    if (logVal > 0) {
                        sumLogisticsWeighted += exitQty * logVal;
                        sumQtyForLogistics += exitQty;
                    }
                }

                // –¶–µ–Ω–∞ ‚ÇΩ ‚Äî —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è: qty √ó price
                const priceSpan = row.querySelector('.supply-price-auto');
                if (priceSpan && priceSpan.dataset.value && exitQty > 0) {
                    const priceVal = parseFloat(priceSpan.dataset.value) || 0;
                    if (priceVal > 0) {
                        sumPriceWeighted += exitQty * priceVal;
                        sumQtyForPrice += exitQty;
                    }
                }
            });

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            const avgLogistics = sumQtyForLogistics > 0 ? sumLogisticsWeighted / sumQtyForLogistics : 0;
            const avgPrice = sumQtyForPrice > 0 ? sumPriceWeighted / sumQtyForPrice : 0;
            // –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å = (–∏—Ç–æ–≥–æ–≤–∞—è –ª–æ–≥–∏—Å—Ç–∏–∫–∞ + –∏—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞) √ó 1.06
            const avgCost = (avgLogistics > 0 || avgPrice > 0) ? (avgLogistics + avgPrice) * 1.06 : 0;

            // –°—Ç—Ä–æ–∏–º —Å—Ç—Ä–æ–∫—É –∏—Ç–æ–≥–æ–≤
            let html = '<td style="font-weight:600; text-align:right;">–ò—Ç–æ–≥–æ:</td>'; // —Ç–æ–≤–∞—Ä
            html += '<td></td>'; // –¥–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞

            // –ö–æ–ª-–≤–æ –≤—ã—Ö–æ–¥–∞ (—Å—É–º–º–∞)
            html += '<td>' + (sumExitFactory ? formatNumberWithSpaces(sumExitFactory) : '') + '</td>';

            // –ö–æ–ª-–≤–æ –ø—Ä–∏—Ö–æ–¥–∞ (—Å—É–º–º–∞)
            html += '<td>' + (sumArrival ? formatNumberWithSpaces(sumArrival) : '') + '</td>';

            // –õ–æ–≥–∏—Å—Ç–∏–∫–∞ (—Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è)
            html += '<td>' + (avgLogistics > 0 ? formatNumberWithSpaces(Math.round(avgLogistics)) : '') + '</td>';

            // –¶–µ–Ω–∞ ‚ÇΩ (—Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è)
            html += '<td>' + (avgPrice > 0 ? formatNumberWithSpaces(Math.round(avgPrice)) : '') + '</td>';

            // –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (–∏–∑ –∏—Ç–æ–≥–æ–≤–æ–π –ª–æ–≥–∏—Å—Ç–∏–∫–∏ –∏ —Ü–µ–Ω—ã)
            html += '<td>' + (avgCost > 0 ? formatNumberWithSpaces(Math.round(avgCost)) : '') + '</td>';

            tfoot.innerHTML = html;

            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞ –≤ –ø—É—Ç–∏
            updateGoodsInTransit();
        }

        // ============================================================
        // –°–í–û–†–ê–ß–ò–í–ê–ù–ò–ï –°–í–û–î–ù–´–• –î–ê–ù–ù–´–• –ü–û–°–¢–ê–í–û–ö
        // ============================================================

        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å —Å–≤–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–∞–≤–æ–∫.
         * –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage.
         */
        function toggleSuppliesStats() {
            const panel = document.getElementById('supplies-stats-panel');
            const arrow = document.getElementById('supplies-stats-arrow');
            const label = document.getElementById('supplies-stats-label');
            if (!panel) return;

            const isHidden = panel.style.display === 'none';
            if (isHidden) {
                panel.style.display = 'block';
                arrow.style.transform = 'rotate(0deg)';
                label.textContent = '–°–∫—Ä—ã—Ç—å —Å–≤–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';
                localStorage.setItem('suppliesStatsVisible', 'true');
            } else {
                panel.style.display = 'none';
                arrow.style.transform = 'rotate(-90deg)';
                label.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';
                localStorage.setItem('suppliesStatsVisible', 'false');
            }
        }

        /**
         * –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–≤–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ.
         */
        function restoreSuppliesStatsState() {
            const saved = localStorage.getItem('suppliesStatsVisible');
            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
            if (saved === 'false') {
                const panel = document.getElementById('supplies-stats-panel');
                const arrow = document.getElementById('supplies-stats-arrow');
                const label = document.getElementById('supplies-stats-label');
                if (panel) {
                    panel.style.display = 'none';
                    if (arrow) arrow.style.transform = 'rotate(-90deg)';
                    if (label) label.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';
                }
            }
        }

        // ============================================================
        // –°–¢–û–ò–ú–û–°–¢–¨ –¢–û–í–ê–†–ê –í –ü–£–¢–ò
        // ============================================================

        /**
         * –†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–∞ –≤ –ø—É—Ç–∏.
         *
         * –õ–æ–≥–∏–∫–∞: –≥—Ä—É–ø–ø–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ –ø–æ —Ç–æ–≤–∞—Ä—É (SKU), –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ —Å—á–∏—Ç–∞–µ–º
         * —Å—Ä–µ–¥–Ω–∏–µ (—Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å, —Ü–µ–Ω–∞ ¬•) –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (–ø–ª–∞–Ω, —Ñ–∞–±—Ä–∏–∫–∞, –ø—Ä–∏—Ö–æ–¥),
         * –ø–æ—Ç–æ–º —É–º–Ω–æ–∂–∞–µ–º –∏ —Å–∫–ª–∞–¥—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏ –ø–æ –≤—Å–µ–º —Ç–æ–≤–∞—Ä–∞–º.
         * –≠—Ç–æ –¥–∞—ë—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ–≥–¥–∞ –ø–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ —Ç–æ–≤–∞—Ä—ã —Å—Ä–∞–∑—É.
         */
        function updateGoodsInTransit() {
            const qtyEl = document.getElementById('goods-in-transit-qty');
            const costEl = document.getElementById('goods-in-transit-cost');
            const costNoLogEl = document.getElementById('goods-in-transit-cost-no-log');
            const logInTransitEl = document.getElementById('logistics-in-transit');
            const planQtyEl = document.getElementById('plan-not-delivered-qty');
            const planCostEl = document.getElementById('plan-not-delivered-cost');
            const planCostNoLogEl = document.getElementById('plan-not-delivered-cost-no-log');
            const logPlanEl = document.getElementById('logistics-plan');

            // –ë–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ —Å—Ç—Ä–æ–∫–∏ (—Å —É—á—ë—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Ç–æ–≤–∞—Ä—É)
            const rows = Array.from(document.querySelectorAll('#supplies-tbody tr'))
                .filter(r => r.style.display !== 'none');

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ –ø–æ SKU —Ç–æ–≤–∞—Ä–∞
            const byProduct = {};
            rows.forEach(row => {
                const sel = row.querySelector('select');
                const sku = sel ? sel.value : 'unknown';
                if (!byProduct[sku]) byProduct[sku] = [];
                byProduct[sku].push(row);
            });

            // –ò—Ç–æ–≥–æ–≤—ã–µ —Å—É–º–º—ã –ø–æ –≤—Å–µ–º —Ç–æ–≤–∞—Ä–∞–º (—Å –Ω–∞—Ü–µ–Ω–∫–æ–π +6%)
            let totalInTransitQty = 0;
            let totalInTransitCostFull = 0;
            let totalInTransitCostNoLog = 0;
            let totalPlanNotDeliveredQty = 0;
            let totalPlanCostFull = 0;
            let totalPlanCostNoLog = 0;

            // –ò—Ç–æ–≥–æ–≤—ã–µ —Å—É–º–º—ã –ë–ï–ó –Ω–∞—Ü–µ–Ω–∫–∏ +6%
            let totalInTransitCostFullNo6 = 0;      // —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å = (–ª–æ–≥–∏—Å—Ç–∏–∫–∞ + —Ü–µ–Ω–∞¬•√ó–∫—É—Ä—Å) –±–µ–∑ √ó1.06
            let totalInTransitCostNoLogNo6 = 0;     // —Ç–æ–ª—å–∫–æ —Ü–µ–Ω–∞¬•√ó–∫—É—Ä—Å
            let totalInTransitLogistics = 0;        // —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Å—Ç–∏–∫–∞
            let totalPlanCostFullNo6 = 0;
            let totalPlanCostNoLogNo6 = 0;
            let totalPlanLogistics = 0;

            // –°—á–∏—Ç–∞–µ–º –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–æ–≤–∞—Ä—É –æ—Ç–¥–µ–ª—å–Ω–æ
            Object.keys(byProduct).forEach(sku => {
                const productRows = byProduct[sku];
                let plan = 0, factory = 0, arrival = 0;
                let costSum = 0, costCount = 0;
                let cnySum = 0, cnyCount = 0;
                let logSum = 0, logCount = 0;

                productRows.forEach(row => {
                    const ti = row.querySelectorAll('input[type="text"]');
                    plan += ti[0] ? (parseNumberFromSpaces(ti[0].value) || 0) : 0;
                    factory += ti[1] ? (parseNumberFromSpaces(ti[1].value) || 0) : 0;
                    arrival += ti[2] ? (parseNumberFromSpaces(ti[2].value) || 0) : 0;
                    const logVal = ti[3] ? (parseNumberFromSpaces(ti[3].value) || 0) : 0;
                    const priceCny = ti[4] ? (parseNumberFromSpaces(ti[4].value) || 0) : 0;
                    if (priceCny) { cnySum += priceCny; cnyCount++; }
                    if (logVal) { logSum += logVal; logCount++; }

                    const costSpan = row.querySelector('.supply-cost-auto');
                    if (costSpan && costSpan.textContent !== '‚Äî') {
                        const cv = parseNumberFromSpaces(costSpan.textContent);
                        if (cv) { costSum += cv; costCount++; }
                    }
                });

                // –°—Ä–µ–¥–Ω–∏–µ –ø–æ —ç—Ç–æ–º—É —Ç–æ–≤–∞—Ä—É
                const avgCost = costCount > 0 ? costSum / costCount : 0;           // —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å +6%
                const avgCny = cnyCount > 0 ? cnySum / cnyCount : 0;               // —Ü–µ–Ω–∞ ¬•
                const avgLog = logCount > 0 ? logSum / logCount : 0;               // –ª–æ–≥–∏—Å—Ç–∏–∫–∞ –∑–∞ –µ–¥.
                const avgCostNoLog = avgCny * currentCnyRate * 1.06;               // —Ü–µ–Ω–∞¬•√ó–∫—É—Ä—Å√ó1.06

                // –ë–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏ +6%
                const avgCostNo6 = avgLog + avgCny * currentCnyRate;               // –ª–æ–≥–∏—Å—Ç–∏–∫–∞ + —Ü–µ–Ω–∞¬•√ó–∫—É—Ä—Å
                const avgCostNoLogNo6 = avgCny * currentCnyRate;                   // —Ç–æ–ª—å–∫–æ —Ü–µ–Ω–∞¬•√ó–∫—É—Ä—Å

                // –í –ø—É—Ç–∏ –ø–æ —ç—Ç–æ–º—É —Ç–æ–≤–∞—Ä—É
                const inTransit = factory - arrival;
                if (inTransit > 0) {
                    totalInTransitQty += inTransit;
                    totalInTransitCostFull += inTransit * avgCost;
                    totalInTransitCostNoLog += inTransit * avgCostNoLog;
                    // –ë–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏
                    totalInTransitCostFullNo6 += inTransit * avgCostNo6;
                    totalInTransitCostNoLogNo6 += inTransit * avgCostNoLogNo6;
                    totalInTransitLogistics += inTransit * avgLog;
                }

                // –ü–ª–∞–Ω –Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω –ø–æ —ç—Ç–æ–º—É —Ç–æ–≤–∞—Ä—É
                const planNotDel = plan - arrival;
                if (planNotDel > 0) {
                    totalPlanNotDeliveredQty += planNotDel;
                    totalPlanCostFull += planNotDel * avgCost;
                    totalPlanCostNoLog += planNotDel * avgCostNoLog;
                    // –ë–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏
                    totalPlanCostFullNo6 += planNotDel * avgCostNo6;
                    totalPlanCostNoLogNo6 += planNotDel * avgCostNoLogNo6;
                    totalPlanLogistics += planNotDel * avgLog;
                }
            });

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
            function fillVal(el, val) {
                if (!el) return;
                if (val > 0) {
                    el.textContent = formatNumberWithSpaces(Math.round(val));
                } else {
                    el.textContent = val === 0 ? '0' : '‚Äî';
                }
            }

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ "–±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏ +6%"
            function fillNo6(el, val) {
                if (!el) return;
                if (val > 0) {
                    el.textContent = '–±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏ +6%: ' + formatNumberWithSpaces(Math.round(val)) + ' ‚ÇΩ';
                } else {
                    el.textContent = '–±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏ +6%: ‚Äî';
                }
            }

            // –¢–æ–≤–∞—Ä –≤ –ø—É—Ç–∏
            fillVal(qtyEl, totalInTransitQty);
            fillVal(costEl, totalInTransitCostFull);
            fillVal(costNoLogEl, totalInTransitCostNoLog);
            fillVal(logInTransitEl, totalInTransitCostFull - totalInTransitCostNoLog);
            // –ë–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏ +6%
            fillNo6(document.getElementById('goods-in-transit-cost-no6'), totalInTransitCostFullNo6);
            fillNo6(document.getElementById('goods-in-transit-cost-no-log-no6'), totalInTransitCostNoLogNo6);
            fillNo6(document.getElementById('logistics-in-transit-no6'), totalInTransitLogistics);

            // –ü–ª–∞–Ω –Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω
            fillVal(planQtyEl, totalPlanNotDeliveredQty);
            fillVal(planCostEl, totalPlanCostFull);
            fillVal(planCostNoLogEl, totalPlanCostNoLog);
            fillVal(logPlanEl, totalPlanCostFull - totalPlanCostNoLog);
            // –ë–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏ +6%
            fillNo6(document.getElementById('plan-cost-no6'), totalPlanCostFullNo6);
            fillNo6(document.getElementById('plan-cost-no-log-no6'), totalPlanCostNoLogNo6);
            fillNo6(document.getElementById('logistics-plan-no6'), totalPlanLogistics);

            // 9-—è –∫–∞—Ä—Ç–æ—á–∫–∞: –£–∂–µ –æ–ø–ª–∞—á–µ–Ω–Ω–∞—è –ª–æ–≥–∏—Å—Ç–∏–∫–∞ (–¥–ª—è –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤)
            // –°—É–º–º–∏—Ä—É–µ–º: logistics_cost_per_unit √ó exit_factory_qty –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–æ–≤–∞—Ä—É –∏–∑ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            let totalPaidLogistics = 0;
            rows.forEach(row => {
                const completed = row.dataset.containerCompleted === '1';
                if (!completed) {
                    const logCost = parseFloat(row.dataset.logisticsCost) || 0;
                    const exitQty = parseFloat(row.dataset.exitFactoryQty) || 0;
                    totalPaidLogistics += logCost * exitQty;
                }
            });
            fillVal(document.getElementById('paid-logistics-total'), totalPaidLogistics);
        }

        // ============================================================
        // –ü–û–î–°–í–ï–¢–ö–ê –ü–£–°–¢–´–• –Ø–ß–ï–ï–ö
        // ============================================================

        /**
         * –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —è—á–µ–π–∫–∏ –≤ —Å—Ç—Ä–æ–∫–µ –±–ª–µ–¥–Ω–æ-–∫—Ä–∞—Å–Ω—ã–º
         */
        function highlightEmptyCells(row) {
            // –í—Å–µ input –∏ select –≤ —Å—Ç—Ä–æ–∫–µ
            const inputs = row.querySelectorAll('.supply-input, .supply-select');
            inputs.forEach(el => {
                const td = el.closest('td');
                if (!td) return;

                let isEmpty = false;
                if (el.tagName === 'SELECT') {
                    isEmpty = !el.value;
                } else if (el.type === 'date') {
                    isEmpty = !el.value;
                } else if (el.type === 'text') {
                    isEmpty = !el.value.trim();
                }

                if (isEmpty) {
                    td.classList.add('supply-cell-empty');
                } else {
                    td.classList.remove('supply-cell-empty');
                }
            });

            // –ß–µ–∫–±–æ–∫—Å—ã ‚Äî –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ (unchecked) –ø–æ–º–µ—á–∞–µ–º –±–ª–µ–¥–Ω–æ-–∫—Ä–∞—Å–Ω—ã–º
            const checkboxes = row.querySelectorAll('.supply-checkbox');
            checkboxes.forEach(cb => {
                const td = cb.closest('td');
                if (!td) return;
                if (!cb.checked) {
                    td.classList.add('supply-cell-empty');
                } else {
                    td.classList.remove('supply-cell-empty');
                }
            });
        }

        /**
         * –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –≤–æ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫–∞—Ö
         */
        function highlightAllEmptyCells() {
            document.querySelectorAll('#supplies-tbody tr').forEach(row => {
                highlightEmptyCells(row);
            });
        }

        // ============================================================================
        // –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò (–ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨)
        // ============================================================================

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
         */
        async function loadUsers() {
            const tbody = document.getElementById('users-tbody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999;padding:40px;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';

            try {
                const resp = await authFetch('/api/users');
                const data = await resp.json();

                if (!data.success) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#c33;">–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è') + '</td></tr>';
                    return;
                }

                if (!data.users || data.users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999;">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                data.users.forEach(user => {
                    const tr = document.createElement('tr');
                    const roleClass = user.role === 'admin' ? 'admin' : 'viewer';
                    const roleIcon = user.role === 'admin' ? 'üëë' : 'üëÅ';
                    const canDelete = user.id !== currentUser.user_id;

                    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–≥–æ Telegram –∞–∫–∫–∞—É–Ω—Ç–∞
                    const tgDisplay = user.telegram_username
                        ? `<span style="color:#0088cc;">üì± ${escapeHtml(user.telegram_username)}</span>`
                        : '<span style="color:#999;">‚Äî</span>';

                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ —Å—Ç–æ–ª–±—Ü–∞—Ö "–ò–∑–º–µ–Ω–µ–Ω–æ", "–°–æ–∑–¥–∞–Ω–æ"
                    const displayName = user.display_name || '';
                    const displayNameHtml = displayName
                        ? `<strong>${escapeHtml(displayName)}</strong>`
                        : '<span style="color:#999;">–Ω–µ –∑–∞–¥–∞–Ω–æ</span>';
                    const safeUsername = escapeHtml(user.username).replace(/'/g, "\\'");
                    const safeDisplayName = escapeHtml(displayName).replace(/'/g, "\\'");

                    tr.innerHTML = `
                        <td data-label="ID">${user.id}</td>
                        <td data-label="–õ–æ–≥–∏–Ω"><strong>${escapeHtml(user.username)}</strong></td>
                        <td data-label="–ò–º—è">${displayNameHtml} <button class="action-btn" onclick="openSetDisplayNameModal(${user.id}, '${safeUsername}', '${safeDisplayName}')" title="–ò–∑–º–µ–Ω–∏—Ç—å" style="padding:2px 6px;font-size:11px;">‚úèÔ∏è</button></td>
                        <td data-label="–†–æ–ª—å"><span class="role-badge ${roleClass}">${roleIcon} ${user.role}</span></td>
                        <td data-label="Telegram">${tgDisplay}</td>
                        <td data-label="–°–æ–∑–¥–∞–Ω">${user.created_at ? new Date(user.created_at).toLocaleDateString('ru-RU') : '‚Äî'}</td>
                        <td class="actions">
                            <button class="action-btn" onclick="openLinkTelegramModal(${user.id}, '${safeUsername}', '${user.telegram_username || ''}')" title="–ü—Ä–∏–≤—è–∑–∞—Ç—å Telegram">üì±</button>
                            <button class="action-btn" onclick="openRenameUserModal(${user.id}, '${safeUsername}')" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ª–æ–≥–∏–Ω">‚úèÔ∏è</button>
                            <button class="action-btn change-pwd-btn" onclick="openChangePwdModal(${user.id}, '${safeUsername}')">üîë</button>
                            ${canDelete ? `<button class="action-btn delete-btn" onclick="deleteUser(${user.id}, '${safeUsername}')">üóë</button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', err);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#c33;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
            }
        }

        /**
         * –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
         */
        function openCreateUserModal() {
            document.getElementById('new-user-username').value = '';
            document.getElementById('new-user-password').value = '';
            document.getElementById('new-user-role').value = 'viewer';
            document.getElementById('create-user-modal').classList.remove('hidden');
            document.getElementById('new-user-username').focus();
        }

        /**
         * –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
         */
        function closeCreateUserModal() {
            document.getElementById('create-user-modal').classList.add('hidden');
        }

        /**
         * –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
         */
        async function createUser() {
            const username = document.getElementById('new-user-username').value.trim();
            const password = document.getElementById('new-user-password').value;
            const role = document.getElementById('new-user-role').value;

            if (!username || !password) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            try {
                const resp = await authFetch('/api/users/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, role })
                });
                const data = await resp.json();

                if (data.success) {
                    closeCreateUserModal();
                    loadUsers();
                } else {
                    alert(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', err);
            }
        }

        /**
         * –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
         */
        async function deleteUser(userId, username) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${username}"?`)) {
                return;
            }

            try {
                const resp = await authFetch('/api/users/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                const data = await resp.json();

                if (data.success) {
                    loadUsers();
                } else {
                    alert(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', err);
            }
        }

        /**
         * –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è.
         */
        function openChangePwdModal(userId, username) {
            document.getElementById('change-pwd-user-id').value = userId;
            document.getElementById('change-pwd-username').textContent = username;
            document.getElementById('change-pwd-input').value = '';
            document.getElementById('change-pwd-modal').classList.remove('hidden');
            document.getElementById('change-pwd-input').focus();
        }

        /**
         * –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è.
         */
        function closeChangePwdModal() {
            document.getElementById('change-pwd-modal').classList.add('hidden');
        }

        /**
         * –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
         */
        async function changePassword() {
            const userId = document.getElementById('change-pwd-user-id').value;
            const newPassword = document.getElementById('change-pwd-input').value;

            if (!newPassword) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å');
                return;
            }

            try {
                const resp = await authFetch('/api/users/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: parseInt(userId), new_password: newPassword })
                });
                const data = await resp.json();

                if (data.success) {
                    closeChangePwdModal();
                    alert('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω');
                } else {
                    alert(data.error || '–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è');
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è:', err);
            }
        }

        // ============================================================================
        // –ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
        // ============================================================================

        /**
         * –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
         */
        function openRenameUserModal(userId, username) {
            document.getElementById('rename-user-id').value = userId;
            document.getElementById('rename-user-old-name').textContent = username;
            document.getElementById('rename-user-input').value = username;
            document.getElementById('rename-user-modal').classList.remove('hidden');
            document.getElementById('rename-user-input').focus();
            document.getElementById('rename-user-input').select();
        }

        /**
         * –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
         */
        function closeRenameUserModal() {
            document.getElementById('rename-user-modal').classList.add('hidden');
        }

        /**
         * –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
         */
        async function renameUser() {
            const userId = document.getElementById('rename-user-id').value;
            const newUsername = document.getElementById('rename-user-input').value.trim();

            if (!newUsername) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }

            try {
                const resp = await authFetch('/api/users/rename', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: parseInt(userId), new_username: newUsername })
                });
                const data = await resp.json();

                if (data.success) {
                    closeRenameUserModal();
                    loadUsers();
                } else {
                    alert(data.error || '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è');
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è:', err);
            }
        }

        // ============================================================================
        // –£–°–¢–ê–ù–û–í–ö–ê –û–¢–û–ë–†–ê–ñ–ê–ï–ú–û–ì–û –ò–ú–ï–ù–ò
        // ============================================================================

        /**
         * –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –∏–º–µ–Ω–∏.
         * @param {number} userId - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
         * @param {string} username - –õ–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
         * @param {string} currentDisplayName - –¢–µ–∫—É—â–µ–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è
         */
        function openSetDisplayNameModal(userId, username, currentDisplayName) {
            document.getElementById('display-name-user-id').value = userId;
            document.getElementById('display-name-username').textContent = username;
            document.getElementById('display-name-input').value = currentDisplayName || '';
            document.getElementById('set-display-name-modal').classList.remove('hidden');
            document.getElementById('display-name-input').focus();
        }

        /**
         * –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –∏–º–µ–Ω–∏.
         */
        function closeSetDisplayNameModal() {
            document.getElementById('set-display-name-modal').classList.add('hidden');
        }

        /**
         * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
         */
        async function setDisplayName() {
            const userId = document.getElementById('display-name-user-id').value;
            const displayName = document.getElementById('display-name-input').value.trim();

            try {
                const resp = await authFetch('/api/users/set-display-name', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: parseInt(userId), display_name: displayName })
                });
                const data = await resp.json();

                if (data.success) {
                    closeSetDisplayNameModal();
                    loadUsers();
                    // –û–±–Ω–æ–≤–ª—è–µ–º currentUser –µ—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                    if (parseInt(userId) === currentUser.user_id) {
                        currentUser.display_name = displayName;
                    }
                } else {
                    alert(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –∏–º–µ–Ω–∏:', err);
            }
        }

        // ============================================================================
        // –ü–†–ò–í–Ø–ó–ö–ê TELEGRAM –ê–ö–ö–ê–£–ù–¢–ê
        // ============================================================================

        /**
         * –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –ø—Ä–∏–≤—è–∑–∫–∏ Telegram.
         * @param {number} userId - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
         * @param {string} username - –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
         * @param {string} currentTelegramUsername - –¢–µ–∫—É—â–∏–π Telegram username
         */
        function openLinkTelegramModal(userId, username, currentTelegramUsername) {
            document.getElementById('link-tg-user-id').value = userId;
            document.getElementById('link-tg-username').textContent = username;
            document.getElementById('link-tg-input').value = currentTelegramUsername || '';
            document.getElementById('link-telegram-modal').classList.remove('hidden');
        }

        /**
         * –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –ø—Ä–∏–≤—è–∑–∫–∏ Telegram.
         */
        function closeLinkTelegramModal() {
            document.getElementById('link-telegram-modal').classList.add('hidden');
        }

        /**
         * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É Telegram –∞–∫–∫–∞—É–Ω—Ç–∞.
         */
        async function linkTelegramAccount() {
            const userId = document.getElementById('link-tg-user-id').value;
            const telegramUsername = document.getElementById('link-tg-input').value.trim();

            try {
                const resp = await authFetch('/api/users/link-telegram', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: parseInt(userId),
                        telegram_username: telegramUsername
                    })
                });
                const data = await resp.json();

                if (data.success) {
                    closeLinkTelegramModal();
                    loadUsers();
                } else {
                    alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏');
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ Telegram:', err);
            }
        }

        // ====================================================================
        // –ü–õ–ê–ù –ó–ê–ö–£–ü–û–ö ‚Äî JavaScript —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è CRUD –æ–ø–µ—Ä–∞—Ü–∏–π
        // ====================================================================

        /** –ö—ç—à —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –ø–ª–∞–Ω–∞ */
        let planProducts = [];
        /** –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞—Å–∫—Ä—ã—Ç—ã—Ö –≥—Ä—É–ø–ø –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ (–∫–ª—é—á ‚Äî –∞—Ä—Ç–∏–∫—É–ª) */
        let planOpenGroups = {};

        /**
         * –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞.
         * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç /api/products/list ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–µ (–Ω–µ–∞—Ä—Ö–∏–≤–Ω—ã–µ) —Ç–æ–≤–∞—Ä—ã.
         */
        async function loadPlanProducts() {
            try {
                const resp = await authFetch('/api/products/list');
                const data = await resp.json();
                if (data.success) {
                    planProducts = data.products || [];
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º select –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                    const select = document.getElementById('plan-product-name');
                    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª...</option>' +
                        planProducts.map(p => '<option value="' + escapeHtml(p.offer_id || p.name) + '">' + escapeHtml(p.offer_id || p.name) + '</option>').join('');
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –ø–ª–∞–Ω–∞:', err);
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π –ø–ª–∞–Ω–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞.
         * –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É –∏ —Ä–µ–Ω–¥–µ—Ä–∏—Ç –∞–∫–∫–æ—Ä–¥–µ–æ–Ω.
         */
        async function loadPlanData() {
            try {
                if (planProducts.length === 0) loadPlanProducts();

                const [resp, transitResp, arrivalsResp] = await Promise.all([
                    authFetch('/api/plan/items'),
                    authFetch('/api/plan/in-transit'),
                    authFetch('/api/plan/arrivals')
                ]);
                const data = await resp.json();
                const transitData = await transitResp.json();
                const arrivalsData = await arrivalsResp.json();
                if (!data.success) return;

                const items = data.items || [];
                const inTransitMap = (transitData.success && transitData.in_transit) ? transitData.in_transit : {};
                const arrivalsMap = (arrivalsData.success && arrivalsData.arrivals) ? arrivalsData.arrivals : {};
                const container = document.getElementById('plan-groups-container');
                const empty = document.getElementById('plan-empty');

                if (items.length === 0) {
                    container.style.display = 'none';
                    empty.style.display = 'block';
                    return;
                }

                container.style.display = 'block';
                empty.style.display = 'none';

                /* –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É (product_name) */
                const groups = {};
                const groupOrder = [];
                items.forEach(item => {
                    const key = item.product_name || '–ë–µ–∑ –∞—Ä—Ç–∏–∫—É–ª–∞';
                    if (!groups[key]) { groups[key] = []; groupOrder.push(key); }
                    groups[key].push(item);
                });

                /* –°–Ω–∞—á–∞–ª–∞ ¬´–ø—Ä–∏—à–ª–æ¬ª, –ø–æ—Ç–æ–º ¬´–≤ –ø—É—Ç–∏¬ª —Å –≤—ã—á–µ—Ç–æ–º –ø—Ä–∏—Ö–æ–¥–∞ –∏–∑ —ë–º–∫–æ—Å—Ç–∏ —Å—Ç—Ä–æ–∫–∏ */
                groupOrder.forEach(artName => {
                    const grpRows = groups[artName];
                    /* –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –≤—ã—Ö–æ–¥–∞ (—Ä–∞–Ω–Ω–∏–µ –ø–µ—Ä–≤—ã–µ) */
                    grpRows.sort((a, b) => (a.planned_release_date || '').localeCompare(b.planned_release_date || ''));

                    /* 1) –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º ¬´–ø—Ä–∏—à–ª–æ –Ω–∞ —Å–∫–ª–∞–¥¬ª */
                    const totalArrived = arrivalsMap[artName] || 0;
                    let remArr = totalArrived;
                    grpRows.forEach(r => {
                        const qty = r.planned_qty || 0;
                        const fill = Math.min(remArr, qty);
                        r._arrived = fill;
                        remArr -= fill;
                    });

                    /* 2) –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º ¬´–≤ –ø—É—Ç–∏¬ª ‚Äî —ë–º–∫–æ—Å—Ç—å —Å—Ç—Ä–æ–∫–∏ = –ø–ª–∞–Ω –º–∏–Ω—É—Å —É–∂–µ –ø—Ä–∏—à–ª–æ */
                    const totalInTransit = inTransitMap[artName] || 0;
                    let remTr = totalInTransit;
                    grpRows.forEach(r => {
                        const capacity = Math.max(0, (r.planned_qty || 0) - (r._arrived || 0));
                        const fill = Math.min(remTr, capacity);
                        r._in_transit = fill;
                        remTr -= fill;
                    });
                });

                /* –†–µ–Ω–¥–µ—Ä–∏–º –∞–∫–∫–æ—Ä–¥–µ–æ–Ω */
                let html = '';
                groupOrder.forEach(artName => {
                    const rows = groups[artName];
                    const isOpen = !!planOpenGroups[artName];

                    /* –ò—Ç–æ–≥–∏ –≥—Ä—É–ø–ø—ã */
                    let gQty = 0, gTotal = 0, gWaiting = 0, gTransit = 0, gArrived = 0;
                    let gPaidInvY = 0, gPaidInvR = 0, gPaidDY = 0, gPaidDR = 0;
                    let gTotalPaidY = 0, gTotalPaidR = 0;
                    let gSumPriceInv = 0, gSumPriceDelta = 0;
                    rows.forEach(r => {
                        gQty += r.planned_qty || 0;
                        gSumPriceInv += r.price_yuan_invoice || 0;
                        gSumPriceDelta += r.price_yuan_delta_invoice || 0;
                        gTotal += (r.price_yuan_invoice || 0) + (r.price_yuan_delta_invoice || 0);
                        gTransit += r._in_transit || 0;
                        gArrived += r._arrived || 0;
                        gWaiting += (r.planned_qty || 0) - (r._in_transit || 0) - (r._arrived || 0);
                        gPaidInvY += r.paid_invoice_yuan || 0;
                        gPaidInvR += r.paid_invoice_rub || 0;
                        gPaidDY += r.paid_delta_yuan || 0;
                        gPaidDR += r.paid_delta_rub || 0;
                        gTotalPaidY += (r.paid_invoice_yuan || 0) + (r.paid_delta_yuan || 0);
                        gTotalPaidR += (r.paid_invoice_rub || 0) + (r.paid_delta_rub || 0);
                    });

                    html += '<div class="plan-group' + (isOpen ? ' open' : '') + '">';

                    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä—É–ø–ø—ã */
                    html += '<div class="plan-group-header" onclick="togglePlanGroup(this)">';
                    html += '<span class="plan-group-arrow">&#9654;</span>';
                    html += '<span class="plan-group-name">' + escapeHtml(artName) + '</span>';
                    html += '</div>';

                    /* –¢–∞–±–ª–∏—Ü–∞ ‚Äî thead –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞, tbody —Å–∫—Ä—ã—Ç –¥–æ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è */
                    html += '<div class="plan-group-body">';
                    html += '<div class="plan-group-table-wrap">';
                    html += '<table class="plan-group-table"><thead>';
                    html += '<tr class="plan-totals-row">';
                    const cnt = rows.length;
                    html += '<td></td><td></td>';
                    html += '<td>' + fmtNum(gQty) + '</td>';
                    html += '<td>' + fmtMoney(gSumPriceInv / cnt) + ' &#165;</td>';
                    html += '<td>' + fmtMoney(gSumPriceDelta / cnt) + ' &#165;</td>';
                    html += '<td>' + fmtMoney(gTotal / cnt) + ' &#165;</td>';
                    html += '<td>' + fmtNum(gWaiting) + '</td>';
                    html += '<td>' + fmtNum(gTransit) + '</td>';
                    html += '<td>' + fmtNum(gArrived) + '</td>';
                    html += '<td>' + fmtMoney(gTotalPaidY) + ' &#165;</td>';
                    html += '<td>' + fmtMoney(gTotalPaidR) + ' &#8381;</td>';
                    html += '<td class="admin-only"></td>';
                    html += '</tr><tr>';
                    html += '<th>–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞<br>–ø–ª–∞–Ω</th><th>–ü—Ä–∏–º–µ—Ä–Ω—ã–π<br>–ø—Ä–∏—Ö–æ–¥ –¥–∞—Ç–∞</th><th>–ö–æ–ª-–≤–æ<br>–ø–ª–∞–Ω</th>';
                    html += '<th>–¶–µ–Ω–∞ —é–∞–Ω—å<br>–∏–Ω–≤–æ–π—Å, —à—Ç &#165;</th><th>–¶–µ–Ω–∞ —é–∞–Ω—å<br>–¥–µ–ª—å—Ç–∞ –∏–Ω–≤–æ–π—Å, —à—Ç &#165;</th><th>–û–±—â–∞—è —Å—É–º–º–∞<br>—é–∞–Ω—å, —à—Ç &#165;</th>';
                    html += '<th>–ö–æ–ª-–≤–æ<br>–≤ –æ–∂–∏–¥–∞–Ω–∏–∏</th><th>–ö–æ–ª-–≤–æ<br>–≤ –ø—É—Ç–∏</th><th>–ö–æ–ª-–≤–æ<br>–ø—Ä–∏—à–ª–æ</th>';
                    html += '<th>–û–ø–ª–∞—á–µ–Ω–æ<br>–∏–Ω–≤–æ–π—Å + –¥–µ–ª—å—Ç–∞ &#165;</th><th>–û–ø–ª–∞—á–µ–Ω–æ<br>–∏–Ω–≤–æ–π—Å + –¥–µ–ª—å—Ç–∞ &#8381;</th>';
                    html += '<th class="admin-only"></th>';
                    html += '</tr></thead><tbody>';

                    rows.forEach((item, idx) => {
                        const totalYuan = (item.price_yuan_invoice || 0) + (item.price_yuan_delta_invoice || 0);
                        const waiting = (item.planned_qty || 0) - (item._in_transit || 0) - (item._arrived || 0);
                        const totalPaidY = (item.paid_invoice_yuan || 0) + (item.paid_delta_yuan || 0);
                        const totalPaidR = (item.paid_invoice_rub || 0) + (item.paid_delta_rub || 0);
                        html += '<tr ondblclick="editPlanItem(' + item.id + ')" style="cursor:pointer" title="–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è">';
                        html += '<td>' + formatPlanDate(item.planned_release_date) + '</td>';
                        html += '<td>' + formatPlanDate(item.estimated_arrival_date) + '</td>';
                        html += '<td class="number-cell">' + fmtNum(item.planned_qty) + '</td>';
                        html += '<td class="yuan-cell">' + fmtMoney(item.price_yuan_invoice) + ' &#165;</td>';
                        html += '<td class="yuan-cell">' + fmtMoney(item.price_yuan_delta_invoice) + ' &#165;</td>';
                        html += '<td class="yuan-cell" style="font-weight:700">' + fmtMoney(totalYuan) + ' &#165;</td>';
                        html += '<td class="number-cell">' + fmtNum(waiting) + '</td>';
                        html += '<td class="number-cell">' + fmtNum(item._in_transit || 0) + '</td>';
                        html += '<td class="number-cell">' + fmtNum(item._arrived || 0) + '</td>';
                        html += '<td class="yuan-cell">' + fmtMoney(totalPaidY) + ' &#165;</td>';
                        html += '<td class="rub-cell">' + fmtMoney(totalPaidR) + ' &#8381;</td>';
                        html += '<td class="actions-cell admin-only">';
                        html += '<button class="plan-delete-btn" onclick="event.stopPropagation();deletePlanItem(' + item.id + ')" title="–£–¥–∞–ª–∏—Ç—å">&#10005;</button>';
                        html += '</td></tr>';
                    });

                    html += '</tbody></table></div>';
                    /* –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ ‚Äî –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–∞—Å–∫—Ä—ã—Ç–∏–∏ */
                    html += '<div class="plan-add-wrap" style="padding:10px 16px;text-align:left;">';
                    html += '<button class="plan-add-btn admin-only" data-art="' + escapeHtml(artName) + '" onclick="openPlanModalForGroup(this.dataset.art)" style="font-size:12px;padding:6px 14px;">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>';
                    html += '</div>';
                    html += '</div>'; /* /plan-group-body */
                    html += '</div>'; /* /plan-group */
                });

                container.innerHTML = html;
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞–Ω–∞:', err);
            }
        }

        /** –†–∞—Å–∫—Ä—ã—Ç—å/—Å–≤–µ—Ä–Ω—É—Ç—å –≥—Ä—É–ø–ø—É –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ */
        function togglePlanGroup(headerEl) {
            const group = headerEl.closest('.plan-group');
            const artName = group.querySelector('.plan-group-name').textContent;
            group.classList.toggle('open');
            planOpenGroups[artName] = group.classList.contains('open');
        }

        /** –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –ø–ª–∞–Ω–∞ (YYYY-MM-DD ‚Üí DD.MM.YYYY) */
        function formatPlanDate(dateStr) {
            if (!dateStr) return '‚Äî';
            const parts = dateStr.split('-');
            if (parts.length === 3) return parts[2] + '.' + parts[1] + '.' + parts[0];
            return dateStr;
        }

        /** –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–∞ (–±–µ–∑ –¥—Ä–æ–±–Ω–æ–π —á–∞—Å—Ç–∏ –¥–ª—è —Ü–µ–ª—ã—Ö) */
        function fmtNum(val) {
            if (!val && val !== 0) return '0';
            return Number(val).toLocaleString('ru-RU');
        }

        /** –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–Ω–µ–≥ (–¥–æ 2 –∑–Ω–∞–∫–æ–≤, –±–µ–∑ –ª–∏—à–Ω–∏—Ö –Ω—É–ª–µ–π) */
        function fmtMoney(val) {
            if (!val && val !== 0) return '0';
            return Number(val).toLocaleString('ru-RU', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        }

        /** –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç XSS */
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        /**
         * –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≥—Ä—É–ø–ø—ã.
         * –ê—Ä—Ç–∏–∫—É–ª —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω ‚Äî select –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.
         */
        async function openPlanModalForGroup(articulName) {
            document.getElementById('plan-modal-title').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É ‚Äî ' + articulName;
            document.getElementById('plan-edit-id').value = '';
            ['plan-release-date', 'plan-arrival-date', 'plan-qty',
             'plan-price-invoice', 'plan-price-delta',
             'plan-paid-inv-yuan', 'plan-paid-inv-rub', 'plan-paid-delta-yuan', 'plan-paid-delta-rub'
            ].forEach(id => document.getElementById(id).value = '');
            await loadPlanProducts();
            const sel = document.getElementById('plan-product-name');
            sel.value = articulName;
            sel.disabled = true;
            document.getElementById('plan-modal-overlay').classList.add('active');
        }

        /** –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏ (–∞—Ä—Ç–∏–∫—É–ª –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è) */
        function openPlanModal() {
            document.getElementById('plan-modal-title').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é';
            document.getElementById('plan-edit-id').value = '';
            document.getElementById('plan-product-name').value = '';
            document.getElementById('plan-product-name').disabled = false;
            ['plan-release-date', 'plan-arrival-date', 'plan-qty',
             'plan-price-invoice', 'plan-price-delta',
             'plan-paid-inv-yuan', 'plan-paid-inv-rub', 'plan-paid-delta-yuan', 'plan-paid-delta-rub'
            ].forEach(id => document.getElementById(id).value = '');
            loadPlanProducts();
            document.getElementById('plan-modal-overlay').classList.add('active');
        }

        /** –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        function closePlanModal() {
            document.getElementById('plan-product-name').disabled = false;
            document.getElementById('plan-modal-overlay').classList.remove('active');
        }

        /** –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ —Ñ–æ—Ä–º—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ø–æ –¥–≤–æ–π–Ω–æ–º—É –∫–ª–∏–∫—É) */
        async function editPlanItem(id) {
            if (currentUser.role !== 'admin') return;
            try {
                const resp = await authFetch('/api/plan/items');
                const data = await resp.json();
                if (!data.success) return;

                const item = data.items.find(i => i.id === id);
                if (!item) return;

                await loadPlanProducts();

                document.getElementById('plan-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é';
                document.getElementById('plan-edit-id').value = id;
                const sel = document.getElementById('plan-product-name');
                sel.value = item.product_name || '';
                sel.disabled = true;
                document.getElementById('plan-release-date').value = item.planned_release_date || '';
                document.getElementById('plan-arrival-date').value = item.estimated_arrival_date || '';
                document.getElementById('plan-qty').value = item.planned_qty || '';
                document.getElementById('plan-price-invoice').value = item.price_yuan_invoice || '';
                document.getElementById('plan-price-delta').value = item.price_yuan_delta_invoice || '';
                document.getElementById('plan-paid-inv-yuan').value = ((item.paid_invoice_yuan || 0) + (item.paid_delta_yuan || 0)) || '';
                document.getElementById('plan-paid-inv-rub').value = ((item.paid_invoice_rub || 0) + (item.paid_delta_rub || 0)) || '';

                document.getElementById('plan-modal-overlay').classList.add('active');
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–∏ –ø–ª–∞–Ω–∞:', err);
            }
        }

        /** –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–ª–∞–Ω–∞ (—Å–æ–∑–¥–∞—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å) */
        async function savePlanItem() {
            const productName = document.getElementById('plan-product-name').value.trim();
            if (!productName) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª');
                return;
            }

            const releaseDate = document.getElementById('plan-release-date').value;
            const arrivalDate = document.getElementById('plan-arrival-date').value;
            const qty = document.getElementById('plan-qty').value;
            const priceInv = document.getElementById('plan-price-invoice').value;
            const priceDelta = document.getElementById('plan-price-delta').value;

            if (!releaseDate) { alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –≤—ã—Ö–æ–¥–∞ –ø–ª–∞–Ω'); return; }
            if (!arrivalDate) { alert('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏–º–µ—Ä–Ω—ã–π –ø—Ä–∏—Ö–æ–¥ –¥–∞—Ç–∞'); return; }
            if (!qty || parseInt(qty) <= 0) { alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª-–≤–æ –ø–ª–∞–Ω (–±–æ–ª—å—à–µ 0)'); return; }
            if (!priceInv || parseFloat(priceInv) <= 0) { alert('–£–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É —é–∞–Ω—å –∏–Ω–≤–æ–π—Å'); return; }
            if (!priceDelta && priceDelta !== '0') { alert('–£–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É —é–∞–Ω—å –¥–µ–ª—å—Ç–∞ –∏–Ω–≤–æ–π—Å'); return; }

            const editId = document.getElementById('plan-edit-id').value;
            const payload = {
                product_name: productName,
                planned_release_date: releaseDate || null,
                estimated_arrival_date: arrivalDate || null,
                planned_qty: parseInt(qty) || 0,
                price_yuan_invoice: parseInt(priceInv) || 0,
                price_yuan_delta_invoice: parseInt(priceDelta) || 0,
                qty_in_transit: 0,
                qty_arrived: 0,
                paid_invoice_yuan: parseInt(document.getElementById('plan-paid-inv-yuan').value) || 0,
                paid_invoice_rub: parseInt(document.getElementById('plan-paid-inv-rub').value) || 0,
                paid_delta_yuan: 0,
                paid_delta_rub: 0
            };

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –æ–±—â–µ–π —Å—É–º–º—ã —é–∞–Ω—å (–∏–Ω–≤–æ–π—Å + –¥–µ–ª—å—Ç–∞ –∑–∞ —à—Ç)
            payload.total_yuan = payload.price_yuan_invoice + payload.price_yuan_delta_invoice;

            const url = editId ? '/api/plan/items/update' : '/api/plan/items/add';
            if (editId) payload.id = parseInt(editId);

            try {
                const resp = await authFetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                if (data.success) {
                    closePlanModal();
                    loadPlanData();
                } else {
                    alert(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –ø–ª–∞–Ω–∞:', err);
            }
        }

        /** –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–ª–∞–Ω–∞ */
        async function deletePlanItem(id) {
            const answer = prompt('–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ "—É–¥–∞–ª–∏—Ç—å":');
            if (!answer || answer.trim().toLowerCase() !== '—É–¥–∞–ª–∏—Ç—å') return;
            try {
                const resp = await authFetch('/api/plan/items/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: id})
                });
                const data = await resp.json();
                if (data.success) {
                    loadPlanData();
                } else {
                    alert(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –ø–ª–∞–Ω–∞:', err);
            }
        }

    </script>
</body>
</html>
'''


@app.route('/')
def index():
    return render_template_string(HTML_TEMPLATE)


@app.route('/api/products')
def get_products():
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        date_filter = request.args.get('date')
        print(f"\nüîç DEBUG /api/products - date_filter: {date_filter}")

        if date_filter:
            # ‚úÖ –ë–µ—Ä—ë–º —Å–Ω–∏–º–æ–∫ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –ò–ó –ò–°–¢–û–†–ò–ò
            cursor.execute('''
                SELECT
                    sku,
                    name,
                    fbo_stock,
                    orders_qty,
                    snapshot_date AS updated_at
                FROM products_history
                WHERE snapshot_date = ?
                ORDER BY fbo_stock DESC, name
            ''', (date_filter,))
            print(f"   üìÖ –ß–∏—Ç–∞—é –∏–∑ products_history –¥–ª—è –¥–∞—Ç—ã {date_filter}")
        else:
            # ‚úÖ –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ ‚Äî –∏–∑ products (—Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π —Å–Ω–∏–º–æ–∫)
            cursor.execute('''
                SELECT sku, name, fbo_stock, orders_qty, updated_at
                FROM products
                ORDER BY fbo_stock DESC, name
            ''')
            print(f"   üìä –ß–∏—Ç–∞—é –∏–∑ products (—Ç–µ–∫—É—â–∏–π —Å–Ω–∏–º–æ–∫)")

        rows = cursor.fetchall()
        products = [dict(row) for row in rows]
        total_stock = sum(int(p.get('fbo_stock') or 0) for p in products)

        print(f"   ‚úÖ –ù–∞–π–¥–µ–Ω–æ {len(products)} —Ç–æ–≤–∞—Ä–æ–≤, –≤—Å–µ–≥–æ –æ—Å—Ç–∞—Ç–∫–æ–≤: {total_stock}")

        conn.close()

        return jsonify({
            'success': True,
            'count': len(products),
            'total_stock': total_stock,
            'products': products
        })
    except Exception as e:
        print(f"   ‚ùå –û—à–∏–±–∫–∞: {e}")
        return jsonify({'success': False, 'error': str(e), 'products': []})


@app.route('/api/dates')
def get_dates():
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã –≤ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT DISTINCT snapshot_date
            FROM products_history
            ORDER BY snapshot_date DESC
        ''')
        
        dates = [row[0] for row in cursor.fetchall()]
        conn.close()
        
        return jsonify({
            'success': True,
            'dates': dates
        })
    except Exception as e:
        print(f"‚ùå ERROR /api/dates: {e}")
        return jsonify({'success': False, 'error': str(e), 'dates': []})


@app.route('/api/products/current')
def get_products_current():
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ —Ç–æ–≤–∞—Ä—ã —Å –ø–æ–∫–∞–∑–∞–º–∏ –∏ CTR"""
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT 
                sku, name, fbo_stock, orders_qty, 
                hits_view_search, hits_view_search_pdp, search_ctr, updated_at
            FROM products
            ORDER BY sku DESC
        ''')
        
        products = [dict(row) for row in cursor.fetchall()]
        conn.close()
        
        return jsonify({
            'success': True,
            'products': products
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'products': []})


@app.route('/api/products/list')
def get_products_list():
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞"""
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
        
        # –ë–µ—Ä—ë–º —Ç–æ–≤–∞—Ä—ã —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º –∏–∑–≤–µ—Å—Ç–Ω—ã–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∏ –∞—Ä—Ç–∏–∫—É–ª–æ–º (–ø–æ –¥–∞—Ç–µ)
        # –ï—Å–ª–∏ offer_id –Ω–µ—Ç –≤ products_history ‚Äî –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∏–∑ products
        # SKU 1235819146 (–ü–ñ–î) –ø–µ—Ä–≤—ã–º, –ø–æ—Ç–æ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ –∏–º–µ–Ω–∏
        cursor.execute('''
            SELECT ph.sku, ph.name,
                   COALESCE(ph.offer_id, p.offer_id) AS offer_id
            FROM products_history ph
            JOIN (
              SELECT sku, MAX(snapshot_date) AS max_date
              FROM products_history
              GROUP BY sku
            ) last
            ON last.sku = ph.sku AND last.max_date = ph.snapshot_date
            LEFT JOIN products p ON p.sku = ph.sku
            ORDER BY
                CASE WHEN ph.sku = 1235819146 THEN 0 ELSE 1 END,
                ph.name
        ''')

        products = [{'sku': row['sku'], 'name': row['name'], 'offer_id': row['offer_id']} for row in cursor.fetchall()]
        conn.close()
        
        return jsonify({
            'success': True,
            'products': products
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'products': []})


@app.route('/api/history/<int:sku>')
def get_product_history(sku):
    """–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–∞ –ø–æ SKU"""
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–∞, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ –¥–∞—Ç–∞–º (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
        cursor.execute('''
            SELECT
                snapshot_date,
                name,
                sku,
                fbo_stock,
                orders_qty,
                orders_plan,
                cpo_plan,
                price_plan,
                rating,
                review_count,
                price_index,
                price,
                marketing_price,
                avg_position,
                hits_view_search,
                hits_view_search_pdp,
                search_ctr,
                hits_add_to_cart,
                cr1,
                cr2,
                adv_spend,
                in_transit,
                in_draft,
                snapshot_time,
                notes,
                tags
            FROM products_history
            WHERE sku = ?
            ORDER BY snapshot_date DESC
        ''', (sku,))
        
        history = [dict(row) for row in cursor.fetchall()]
        conn.close()
        
        if not history:
            return jsonify({
                'success': False,
                'error': '–ò—Å—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞',
                'history': []
            })
        
        return jsonify({
            'success': True,
            'product_name': history[0]['name'] if history else '',
            'product_sku': sku,
            'history': history
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'history': []})


@app.route('/api/summary')
@app.route('/api/summary/<date>')
def get_summary(date=None):
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–≤–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –í–°–ï–ú –∞–∫—Ç–∏–≤–Ω—ã–º —Ç–æ–≤–∞—Ä–∞–º –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.

    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã (query string):
    - date_from: –Ω–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞ (YYYY-MM-DD)
    - date_to: –∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞ (YYYY-MM-DD)

    –ò–ª–∏ —á–µ—Ä–µ–∑ URL:
    - /api/summary/<date> - –¥–∞–Ω–Ω—ã–µ –∑–∞ –æ–¥–∏–Ω –¥–µ–Ω—å

    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –ø–µ—Ä–∏–æ–¥–æ–º —Ç–∞–∫–æ–π –∂–µ –¥–ª–∏–Ω—ã.
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        from datetime import datetime, timedelta

        # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç
        date_from = request.args.get('date_from')
        date_to = request.args.get('date_to')

        # –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω date —á–µ—Ä–µ–∑ URL - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ –æ–¥–∏–Ω –¥–µ–Ω—å
        if date and not date_from:
            date_from = date
            date_to = date

        # –ï—Å–ª–∏ –¥–∞—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ–≥–æ–¥–Ω—è
        if not date_from:
            date_from = get_snapshot_date()
        if not date_to:
            date_to = date_from

        # –í—ã—á–∏—Å–ª—è–µ–º –¥–ª–∏–Ω—É –ø–µ—Ä–∏–æ–¥–∞ –≤ –¥–Ω—è—Ö
        start_date = datetime.strptime(date_from, '%Y-%m-%d').date()
        end_date = datetime.strptime(date_to, '%Y-%m-%d').date()
        period_days = (end_date - start_date).days + 1

        # –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–µ—Ä–∏–æ–¥ —Ç–∞–∫–æ–π –∂–µ –¥–ª–∏–Ω—ã
        prev_end = start_date - timedelta(days=1)
        prev_start = prev_end - timedelta(days=period_days - 1)

        # –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–æ–≤–∞—Ä—É
        # –î–ª—è —Å—á—ë—Ç—á–∏–∫–æ–≤ (–∑–∞–∫–∞–∑—ã, –ø–æ–∫–∞–∑—ã, –∫–æ—Ä–∑–∏–Ω–∞) - SUM
        # –î–ª—è –æ—Å—Ç–∞—Ç–∫–æ–≤ - –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (MAX date)
        # –î–ª—è —Ä–µ–π—Ç–∏–Ω–≥–∞, –ø–æ–∑–∏—Ü–∏–∏, CTR, CR - AVG
        cursor.execute('''
            SELECT
                ph.sku,
                ph.offer_id,
                MAX(ph.name) as name,
                MAX(ph.fbo_stock) as fbo_stock,
                SUM(ph.orders_qty) as orders_qty,
                AVG(ph.rating) as rating,
                MAX(ph.review_count) as review_count,
                MAX(ph.price_index) as price_index,
                AVG(ph.price) as price,
                AVG(ph.marketing_price) as marketing_price,
                AVG(ph.avg_position) as avg_position,
                SUM(ph.hits_view_search) as hits_view_search,
                SUM(ph.hits_view_search_pdp) as hits_view_search_pdp,
                AVG(ph.search_ctr) as search_ctr,
                SUM(ph.hits_add_to_cart) as hits_add_to_cart,
                AVG(ph.cr1) as cr1,
                AVG(ph.cr2) as cr2,
                SUM(ph.adv_spend) as adv_spend
            FROM products_history ph
            WHERE ph.snapshot_date >= ? AND ph.snapshot_date <= ?
            GROUP BY ph.sku, ph.offer_id
            ORDER BY SUM(ph.orders_qty) DESC, MAX(ph.name)
        ''', (date_from, date_to))

        products = [dict(row) for row in cursor.fetchall()]

        # –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–µ—Ä–∏–æ–¥ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        cursor.execute('''
            SELECT
                ph.sku,
                MAX(ph.fbo_stock) as fbo_stock,
                SUM(ph.orders_qty) as orders_qty,
                AVG(ph.rating) as rating,
                MAX(ph.review_count) as review_count,
                AVG(ph.price) as price,
                AVG(ph.marketing_price) as marketing_price,
                AVG(ph.avg_position) as avg_position,
                SUM(ph.hits_view_search) as hits_view_search,
                SUM(ph.hits_view_search_pdp) as hits_view_search_pdp,
                AVG(ph.search_ctr) as search_ctr,
                SUM(ph.hits_add_to_cart) as hits_add_to_cart,
                AVG(ph.cr1) as cr1,
                AVG(ph.cr2) as cr2,
                SUM(ph.adv_spend) as adv_spend
            FROM products_history ph
            WHERE ph.snapshot_date >= ? AND ph.snapshot_date <= ?
            GROUP BY ph.sku
        ''', (prev_start.isoformat(), prev_end.isoformat()))

        prev_products_map = {}
        for row in cursor.fetchall():
            prev_products_map[row['sku']] = dict(row)

        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
        cursor.execute('''
            SELECT DISTINCT snapshot_date
            FROM products_history
            ORDER BY snapshot_date DESC
            LIMIT 90
        ''')
        available_dates = [row[0] for row in cursor.fetchall()]

        conn.close()

        return jsonify({
            'success': True,
            'date_from': date_from,
            'date_to': date_to,
            'period_days': period_days,
            'prev_date_from': prev_start.isoformat(),
            'prev_date_to': prev_end.isoformat(),
            'products': products,
            'prev_products': prev_products_map,
            'available_dates': available_dates,
            'count': len(products)
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'products': []})


@app.route('/api/history/save-note', methods=['POST'])
@require_auth(['admin'])
def save_note():
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ç–∫—É –¥–ª—è —Ç–æ–≤–∞—Ä–∞ –∏ –¥–∞—Ç—ã"""
    try:
        data = request.json
        sku = data.get('sku')
        snapshot_date = data.get('date')
        notes = data.get('notes', '')

        if not sku or not snapshot_date:
            return jsonify({'success': False, 'error': '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç sku –∏–ª–∏ date'})

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        cursor.execute('''
            UPDATE products_history
            SET notes = ?
            WHERE sku = ? AND snapshot_date = ?
        ''', (notes, sku, snapshot_date))

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': '–ó–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/history/save-tags', methods=['POST'])
@require_auth(['admin'])
def save_tags():
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–≥–∏ –¥–ª—è —Ç–æ–≤–∞—Ä–∞ –∏ –¥–∞—Ç—ã"""
    try:
        data = request.json
        sku = data.get('sku')
        snapshot_date = data.get('date')
        tags = data.get('tags', [])

        if not sku or not snapshot_date:
            return jsonify({'success': False, 'error': '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç sku –∏–ª–∏ date'})

        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Ç–µ–≥–æ–≤ –≤ JSON —Å—Ç—Ä–æ–∫—É
        tags_json = json.dumps(tags, ensure_ascii=False) if tags else None

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        cursor.execute('''
            UPDATE products_history
            SET tags = ?
            WHERE sku = ? AND snapshot_date = ?
        ''', (tags_json, sku, snapshot_date))

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': '–¢–µ–≥–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/history/save-orders-plan', methods=['POST'])
@require_auth(['admin'])
def save_orders_plan():
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–∞–Ω–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è —Ç–æ–≤–∞—Ä–∞ –∏ –¥–∞—Ç—ã"""
    try:
        data = request.json
        sku = data.get('sku')
        snapshot_date = data.get('date')
        orders_plan = data.get('orders_plan')

        if not sku or not snapshot_date:
            return jsonify({'success': False, 'error': '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç sku –∏–ª–∏ date'})

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –∏–ª–∏ –±—É–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
        from datetime import datetime
        today = datetime.now().date()
        target_date = datetime.strptime(snapshot_date, '%Y-%m-%d').date()

        if target_date < today:
            return jsonify({'success': False, 'error': '–ù–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—à–ª—ã–µ –¥–∞–Ω–Ω—ã–µ'})

        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –≤ NULL
        if orders_plan == '':
            orders_plan = None
        else:
            orders_plan = int(orders_plan)

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        cursor.execute('''
            UPDATE products_history
            SET orders_plan = ?
            WHERE sku = ? AND snapshot_date = ?
        ''', (orders_plan, sku, snapshot_date))

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': '–ü–ª–∞–Ω –∑–∞–∫–∞–∑–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/history/save-cpo-plan', methods=['POST'])
@require_auth(['admin'])
def save_cpo_plan():
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–∞–Ω–æ–≤—ã–π CPO –¥–ª—è —Ç–æ–≤–∞—Ä–∞ –∏ –¥–∞—Ç—ã"""
    try:
        data = request.json
        sku = data.get('sku')
        snapshot_date = data.get('date')
        cpo_plan = data.get('cpo_plan')

        if not sku or not snapshot_date:
            return jsonify({'success': False, 'error': '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç sku –∏–ª–∏ date'})

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –∏–ª–∏ –±—É–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
        from datetime import datetime
        today = datetime.now().date()
        target_date = datetime.strptime(snapshot_date, '%Y-%m-%d').date()

        if target_date < today:
            return jsonify({'success': False, 'error': '–ù–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—à–ª—ã–µ –¥–∞–Ω–Ω—ã–µ'})

        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –≤ NULL
        if cpo_plan == '':
            cpo_plan = None
        else:
            cpo_plan = int(cpo_plan)

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        cursor.execute('''
            UPDATE products_history
            SET cpo_plan = ?
            WHERE sku = ? AND snapshot_date = ?
        ''', (cpo_plan, sku, snapshot_date))

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': '–ü–ª–∞–Ω CPO —Å–æ—Ö—Ä–∞–Ω–µ–Ω'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/history/save-price-plan', methods=['POST'])
@require_auth(['admin'])
def save_price_plan():
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–∞–Ω–æ–≤—É—é —Ü–µ–Ω—É –¥–ª—è —Ç–æ–≤–∞—Ä–∞ –∏ –¥–∞—Ç—ã"""
    try:
        data = request.json
        sku = data.get('sku')
        snapshot_date = data.get('date')
        price_plan = data.get('price_plan')

        if not sku or not snapshot_date:
            return jsonify({'success': False, 'error': '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç sku –∏–ª–∏ date'})

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –∏–ª–∏ –±—É–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
        from datetime import datetime
        today = datetime.now().date()
        target_date = datetime.strptime(snapshot_date, '%Y-%m-%d').date()

        if target_date < today:
            return jsonify({'success': False, 'error': '–ù–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—à–ª—ã–µ –¥–∞–Ω–Ω—ã–µ'})

        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –≤ NULL
        if price_plan == '':
            price_plan = None
        else:
            price_plan = int(price_plan)

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        cursor.execute('''
            UPDATE products_history
            SET price_plan = ?
            WHERE sku = ? AND snapshot_date = ?
        ''', (price_plan, sku, snapshot_date))

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': '–ü–ª–∞–Ω —Ü–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/update-rating/<int:sku>', methods=['POST'])
def update_rating(sku):
    """–û–±–Ω–æ–≤–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤ –¥–ª—è —Ç–æ–≤–∞—Ä–∞"""
    try:
        data = request.json
        rating = data.get('rating')
        review_count = data.get('review_count')

        if rating is None or review_count is None:
            return jsonify({'success': False, 'error': '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç rating –∏–ª–∏ review_count'})

        snapshot_date = get_snapshot_date()
        snapshot_time = get_snapshot_time()

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
        cursor.execute('''
            UPDATE products_history
            SET rating = ?, review_count = ?
            WHERE sku = ? AND snapshot_date = ?
        ''', (float(rating), int(review_count), sku, snapshot_date))

        if cursor.rowcount == 0:
            # –ó–∞–ø–∏—Å–∏ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            # –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ç–æ–≤–∞—Ä–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã products
            cursor.execute('SELECT name, offer_id FROM products WHERE sku = ?', (sku,))
            row = cursor.fetchone()
            name = row[0] if row else ''
            offer_id = row[1] if row else None

            cursor.execute('''
                INSERT INTO products_history (sku, name, offer_id, rating, review_count, snapshot_date, snapshot_time)
                VALUES (?, ?, ?, ?, ?, ?, ?)
            ''', (sku, name, offer_id, float(rating), int(review_count), snapshot_date, snapshot_time))

            print(f"  ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å –≤ products_history –¥–ª—è SKU {sku}")

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': f'–†–µ–π—Ç–∏–Ω–≥ –æ–±–Ω–æ–≤–ª–µ–Ω: {rating} ({review_count} –æ—Ç–∑—ã–≤–æ–≤)'
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/download/<filename>')
def download_file(filename):
    """–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"""
    try:
        import os
        
        # –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã
        allowed_files = ['ozon_app.py', 'run.py', 'auto_commit.ps1', 'auto_update.py', 'add_history_data.py']
        
        if filename not in allowed_files:
            return jsonify({'error': '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–∏
        file_path = os.path.join(os.path.dirname(__file__), filename)
        
        if not os.path.exists(file_path):
            return jsonify({'error': '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ'}), 404
        
        from flask import send_file
        return send_file(file_path, as_attachment=True, download_name=filename)
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500


# ============================================================================
# –ü–ê–†–°–ò–ù–ì –†–ï–ô–¢–ò–ù–ì–û–í (—Ñ–ª–∞–≥ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ä—Å–µ—Ä–∞)
# ============================================================================
#
# –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:
# 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–ü–∞—Ä—Å–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥–∏" –Ω–∞ —Å–∞–π—Ç–µ
# 2. –°–µ—Ä–≤–µ—Ä —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ —Ñ–∞–π–ª /tmp/ozon-parse-request.json
# 3. –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç (update_ratings_local.py --watch) –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä
# 4. –ö–æ–≥–¥–∞ –≤–∏–¥–∏—Ç –∑–∞–ø—Ä–æ—Å ‚Äî –ø–∞—Ä—Å–∏—Ç —Ä–µ–π—Ç–∏–Ω–≥–∏ —á–µ—Ä–µ–∑ Chrome –Ω–∞ –ü–ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
# 5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
# 6. –°–∞–π—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
# ============================================================================

PARSE_REQUEST_FILE = '/tmp/ozon-parse-request.json'


def _read_parse_state():
    """–ß–∏—Ç–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ø–∞—Ä—Å–∏–Ω–≥ –∏–∑ —Ñ–∞–π–ª–∞"""
    try:
        if os.path.exists(PARSE_REQUEST_FILE):
            with open(PARSE_REQUEST_FILE, 'r') as f:
                return json.load(f)
    except Exception:
        pass
    return {'status': 'idle'}


def _write_parse_state(state):
    """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ø–∞—Ä—Å–∏–Ω–≥ –≤ —Ñ–∞–π–ª"""
    with open(PARSE_REQUEST_FILE, 'w') as f:
        json.dump(state, f)


@app.route('/api/parse-status')
def api_parse_status():
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–∞—Ä—Å–∏–Ω–≥–∞.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–Ω–æ–ø–∫–æ–π –Ω–∞ —Å–∞–π—Ç–µ (–ø–æ–ª–ª–∏–Ω–≥) –∏ –ª–æ–∫–∞–ª—å–Ω—ã–º —Å–∫—Ä–∏–ø—Ç–æ–º.
    """
    return jsonify(_read_parse_state())


@app.route('/api/parse-complete', methods=['POST'])
@require_auth(['admin'])
def api_parse_complete():
    """
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–º –ø–∞—Ä—Å–µ—Ä–æ–º –∫–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å.
    """
    try:
        from datetime import datetime
        data = request.json or {}

        _write_parse_state({
            'status': 'completed',
            'completed_at': datetime.now().isoformat(),
            'results': {
                'success': data.get('success', 0),
                'failed': data.get('failed', 0)
            },
            'message': data.get('message', '–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω')
        })

        print(f"‚≠ê –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω: {data.get('success', 0)} —É—Å–ø–µ—à–Ω–æ, {data.get('failed', 0)} –Ω–µ —É–¥–∞–ª–æ—Å—å")
        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/parse-start', methods=['POST'])
@require_auth(['admin'])
def api_parse_start():
    """
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–º –ø–∞—Ä—Å–µ—Ä–æ–º –∫–æ–≥–¥–∞ –æ–Ω –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞–±–æ—Ç—É.
    –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ 'running'.
    """
    try:
        from datetime import datetime
        _write_parse_state({
            'status': 'running',
            'started_at': datetime.now().isoformat(),
            'message': '–ü–∞—Ä—Å–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ü–ö...'
        })
        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500


# ============================================================================
# –≠–ù–î–ü–û–ò–ù–¢–´ –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò
# ============================================================================

@app.route('/api/login', methods=['POST'])
def api_login():
    """
    –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç JSON: {"username": "admin", "password": "password123"}
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {"success": true, "token": "...", "role": "admin", "username": "admin"}
    """
    try:
        data = request.json or {}
        username = data.get('username', '').strip()
        password = data.get('password', '')

        if not username or not password:
            return jsonify({'success': False, 'error': '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å'}), 400

        # –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('SELECT id, username, password_hash, role, telegram_chat_id FROM users WHERE username = ?', (username,))
        user = cursor.fetchone()

        if not user:
            conn.close()
            return jsonify({'success': False, 'error': '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å'}), 401

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å
        if not check_password_hash(user['password_hash'], password):
            conn.close()
            return jsonify({'success': False, 'error': '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å'}), 401

        # –ü–æ–ª—É—á–∞–µ–º telegram_username –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∏–≤—è–∑–∫–∞
        telegram_username = None
        if user['telegram_chat_id']:
            chat_id = user['telegram_chat_id']
            # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º telegram_users
            cursor.execute('SELECT username FROM telegram_users WHERE chat_id = ?', (chat_id,))
            tg_row = cursor.fetchone()
            if tg_row and tg_row['username']:
                telegram_username = f"@{tg_row['username'].lstrip('@')}"
            else:
                # –ò–Ω–∞—á–µ –±–µ—Ä—ë–º –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π
                cursor.execute('''
                    SELECT sender_name FROM document_messages
                    WHERE sender_type = 'telegram' AND telegram_chat_id = ?
                    LIMIT 1
                ''', (chat_id,))
                msg_row = cursor.fetchone()
                if msg_row and msg_row['sender_name']:
                    telegram_username = f"@{msg_row['sender_name'].lstrip('@')}"

        conn.close()

        # –°–æ–∑–¥–∞—ë–º JWT —Ç–æ–∫–µ–Ω
        token = create_jwt_token(user['id'], user['username'], user['role'])

        return jsonify({
            'success': True,
            'token': token,
            'username': user['username'],
            'role': user['role'],
            'telegram_username': telegram_username
        })

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {e}")
        return jsonify({'success': False, 'error': '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'}), 500


@app.route('/api/me')
def api_me():
    """
    –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ.

    –¢—Ä–µ–±—É–µ—Ç: –∑–∞–≥–æ–ª–æ–≤–æ–∫ Authorization: Bearer <token>
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {"success": true, "username": "admin", "role": "admin", "user_id": 1}
    """
    # –ï—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º admin
    if not AUTH_ENABLED:
        return jsonify({
            'success': True,
            'username': 'admin',
            'role': 'admin',
            'user_id': 0
        })

    # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
    auth_header = request.headers.get('Authorization', '')
    token = auth_header.replace('Bearer ', '') if auth_header.startswith('Bearer ') else ''

    if not token:
        return jsonify({'success': False, 'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'}), 401

    try:
        # –î–µ–∫–æ–¥–∏—Ä—É–µ–º JWT —Ç–æ–∫–µ–Ω
        payload = jwt.decode(token, JWT_SECRET, algorithms=['HS256'])
        user_id = payload.get('user_id')

        # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('SELECT username, role FROM users WHERE id = ?', (user_id,))
        user_row = cursor.fetchone()

        if not user_row:
            conn.close()
            return jsonify({'success': False, 'error': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 401

        # –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ username –∏ role –∏–∑ –ë–î
        actual_username = user_row['username']
        actual_role = user_row['role']

        # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π Telegram –∏–∑ –ë–î
        telegram_username = None
        cursor.execute('''
            SELECT u.telegram_chat_id, t.username as tg_username,
                   m.sender_name as msg_sender
            FROM users u
            LEFT JOIN telegram_users t ON u.telegram_chat_id = t.chat_id
            LEFT JOIN (
                SELECT telegram_chat_id, sender_name
                FROM document_messages
                WHERE sender_type = 'telegram'
                GROUP BY telegram_chat_id
            ) m ON u.telegram_chat_id = m.telegram_chat_id
            WHERE u.id = ?
        ''', (user_id,))
        row = cursor.fetchone()
        if row and row['telegram_chat_id']:
            tg_name = row['tg_username'] or row['msg_sender'] or ''
            if tg_name:
                telegram_username = f"@{tg_name.lstrip('@')}"

        conn.close()

        return jsonify({
            'success': True,
            'user_id': user_id,
            'username': actual_username,
            'role': actual_role,
            'telegram_username': telegram_username
        })

    except jwt.InvalidTokenError:
        return jsonify({'success': False, 'error': '–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω'}), 401


# ============================================================================
# –≠–ù–î–ü–û–ò–ù–¢–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò (—Ç–æ–ª—å–∫–æ admin)
# ============================================================================

@app.route('/api/users')
@require_auth(['admin'])
def api_users_list():
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

    –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {"success": true, "users": [{"id": 1, "username": "admin", "role": "admin", "created_at": "...", "telegram_username": "@user"}]}
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤–∫–ª—é—á–∞—è display_name –∏ telegram_username)
        cursor.execute('SELECT id, username, display_name, role, created_at, telegram_username FROM users ORDER BY id')
        users = [dict(row) for row in cursor.fetchall()]

        conn.close()
        return jsonify({'success': True, 'users': users})

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e}")
        return jsonify({'success': False, 'error': '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'}), 500


@app.route('/api/telegram-accounts')
@require_auth(['admin'])
def api_telegram_accounts():
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö Telegram –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.

    –°–æ–±–∏—Ä–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –∏–∑:
    1. –¢–∞–±–ª–∏—Ü—ã telegram_users (–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞)
    2. –°–æ–æ–±—â–µ–Ω–∏–π document_messages (–≤—Å–µ –∫—Ç–æ –ø–∏—Å–∞–ª –≤ —á–∞—Ç)
    3. –î–æ–∫—É–º–µ–Ω—Ç–æ–≤ warehouse_receipt_docs (–∫—Ç–æ —Å–æ–∑–¥–∞–≤–∞–ª –¥–æ–∫—É–º–µ–Ω—Ç—ã)

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {"success": true, "accounts": [{"chat_id": 123, "username": "@user"}]}
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        accounts_dict = {}

        # 1. –ò–∑ telegram_users (–µ—Å–ª–∏ –µ—Å—Ç—å)
        cursor.execute('''
            SELECT chat_id, username, first_name, last_name
            FROM telegram_users
            WHERE chat_id IS NOT NULL
        ''')
        for row in cursor.fetchall():
            chat_id = row['chat_id']
            username = row['username'] or ''
            first_name = row['first_name'] or ''
            last_name = row['last_name'] or ''
            display = f"@{username}" if username else f"{first_name} {last_name}".strip()
            if chat_id not in accounts_dict or not accounts_dict[chat_id]:
                accounts_dict[chat_id] = display

        # 2. –ò–∑ —Å–æ–æ–±—â–µ–Ω–∏–π document_messages
        cursor.execute('''
            SELECT DISTINCT telegram_chat_id, sender_name
            FROM document_messages
            WHERE sender_type = 'telegram' AND telegram_chat_id IS NOT NULL
        ''')
        for row in cursor.fetchall():
            chat_id = row['telegram_chat_id']
            sender_name = row['sender_name'] or ''
            if chat_id not in accounts_dict or not accounts_dict[chat_id]:
                accounts_dict[chat_id] = sender_name

        # 3. –ò–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ warehouse_receipt_docs (created_by –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å @username)
        cursor.execute('''
            SELECT DISTINCT telegram_chat_id, created_by
            FROM warehouse_receipt_docs
            WHERE telegram_chat_id IS NOT NULL
        ''')
        for row in cursor.fetchall():
            chat_id = row['telegram_chat_id']
            created_by = row['created_by'] or ''
            if chat_id not in accounts_dict or not accounts_dict[chat_id]:
                accounts_dict[chat_id] = created_by

        conn.close()

        # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è username: –≤—Å–µ–≥–¥–∞ —Å @ –≤ –Ω–∞—á–∞–ª–µ
        def normalize_username(name, chat_id):
            if not name:
                return f'ID:{chat_id}'
            # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ @ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω –≤ –Ω–∞—á–∞–ª–æ
            clean_name = name.lstrip('@').strip()
            return f'@{clean_name}' if clean_name else f'ID:{chat_id}'

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
        accounts = [
            {'chat_id': chat_id, 'username': normalize_username(username, chat_id)}
            for chat_id, username in accounts_dict.items()
        ]
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ username
        accounts.sort(key=lambda x: x['username'].lower())

        return jsonify({'success': True, 'accounts': accounts})

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ Telegram –∞–∫–∫–∞—É–Ω—Ç–æ–≤: {e}")
        return jsonify({'success': False, 'error': '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'}), 500


@app.route('/api/users/link-telegram', methods=['POST'])
@require_auth(['admin'])
def api_users_link_telegram():
    """
    –ü—Ä–∏–≤—è–∑–∞—Ç—å Telegram –∞–∫–∫–∞—É–Ω—Ç –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç JSON: {"user_id": 1, "telegram_username": "@username"}
    –ï—Å–ª–∏ telegram_username –ø—É—Å—Ç–æ–π, –æ—Ç–≤—è–∑—ã–≤–∞–µ—Ç –∞–∫–∫–∞—É–Ω—Ç.
    """
    try:
        data = request.json or {}
        user_id = data.get('user_id')
        telegram_username = data.get('telegram_username', '').strip()

        if not user_id:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ user_id'}), 400

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        cursor.execute('SELECT id FROM users WHERE id = ?', (user_id,))
        if not cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'error': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404

        # –û–±–Ω–æ–≤–ª—è–µ–º telegram_username
        cursor.execute('UPDATE users SET telegram_username = ? WHERE id = ?',
                      (telegram_username if telegram_username else None, user_id))
        conn.commit()
        conn.close()

        action = '—Å–æ—Ö—Ä–∞–Ω—ë–Ω' if telegram_username else '–æ—á–∏—â–µ–Ω'
        return jsonify({'success': True, 'message': f'Telegram {action}'})

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ Telegram: {e}")
        return jsonify({'success': False, 'error': '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'}), 500


# ============================================================================
# API –°–û–û–ë–©–ï–ù–ò–ô –ö–û–ù–¢–ï–ô–ù–ï–†–û–í –í–≠–î
# ============================================================================

@app.route('/api/users-with-telegram')
@require_auth(['admin', 'viewer'])
def api_users_with_telegram():
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º Telegram (–¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π).
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ë–µ—Ä—ë–º telegram_username –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —Ç–∞–±–ª–∏—Ü—ã users
        cursor.execute('SELECT id, username, telegram_chat_id, telegram_username FROM users WHERE telegram_chat_id IS NOT NULL')
        users = [dict(row) for row in cursor.fetchall()]

        conn.close()
        return jsonify({'success': True, 'users': users})

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ api_users_with_telegram: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/container-messages/<int:container_id>')
@require_auth(['admin', 'viewer'])
def api_container_messages_get(container_id):
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('''
            SELECT cm.*, u.username as sender_username
            FROM container_messages cm
            LEFT JOIN users u ON cm.sender_id = u.id
            WHERE cm.container_id = ?
            ORDER BY cm.created_at ASC
        ''', (container_id,))

        messages = []
        for row in cursor.fetchall():
            msg = dict(row)
            # –ü–æ–ª—É—á–∞–µ–º –∏–º–µ–Ω–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
            if msg['recipient_ids']:
                recipient_ids = [int(x) for x in msg['recipient_ids'].split(',') if x]
                if recipient_ids:
                    placeholders = ','.join('?' * len(recipient_ids))
                    cursor.execute(f'SELECT username FROM users WHERE id IN ({placeholders})', recipient_ids)
                    names = [r['username'] for r in cursor.fetchall()]
                    msg['recipient_names'] = ', '.join(names)
                else:
                    msg['recipient_names'] = ''
            else:
                msg['recipient_names'] = ''
            messages.append(msg)

        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
        message_ids = [msg['id'] for msg in messages]
        files_by_message = {}
        if message_ids:
            placeholders = ','.join('?' * len(message_ids))
            cursor.execute(f'''
                SELECT id, message_id, filename, file_type, file_size
                FROM container_message_files
                WHERE message_id IN ({placeholders})
                ORDER BY id ASC
            ''', message_ids)
            for file_row in cursor.fetchall():
                mid = file_row['message_id']
                if mid not in files_by_message:
                    files_by_message[mid] = []
                files_by_message[mid].append(dict(file_row))

        # –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤ files –∫ –∫–∞–∂–¥–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
        for msg in messages:
            msg['files'] = files_by_message.get(msg['id'], [])

        conn.close()
        return jsonify({'success': True, 'messages': messages})

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ api_container_messages_get: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/container-messages/send', methods=['POST'])
@require_auth(['admin', 'viewer'])
def api_container_messages_send():
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É.
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram –≤—Å–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º.
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç JSON (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç) –∏ multipart/form-data (—Ç–µ–∫—Å—Ç + —Ñ–∞–π–ª—ã).
    """
    try:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞: multipart (—Å —Ñ–∞–π–ª–∞–º–∏) –∏–ª–∏ JSON (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç)
        files = []
        content_type = request.content_type or ''
        print(f"üì® container-messages/send: content_type={content_type}")
        if 'multipart/form-data' in content_type:
            container_id = request.form.get('container_id', type=int)
            recipient_ids_raw = request.form.get('recipient_ids', '')
            recipient_ids = [int(x) for x in recipient_ids_raw.split(',') if x.strip()]
            message = request.form.get('message', '').strip()
            files = request.files.getlist('files')
            print(f"üì® MULTIPART: container_id={container_id}, files_count={len(files)}, filenames={[f.filename for f in files]}")
        else:
            data = request.json or {}
            container_id = data.get('container_id')
            recipient_ids = data.get('recipient_ids', [])
            message = data.get('message', '').strip()
            print(f"üì® JSON: container_id={container_id}, message='{message[:50]}...'")

        if not container_id:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ container_id'}), 400
        if not recipient_ids:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π'}), 400
        if not message and not files:
            return jsonify({'success': False, 'error': '–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª'}), 400

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ
        user_info = getattr(request, 'current_user', {})
        sender_id = user_info.get('user_id')

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º display_name –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        cursor.execute('SELECT display_name, username FROM users WHERE id = ?', (sender_id,))
        sender_row = cursor.fetchone()
        sender_username = (sender_row['display_name'] or sender_row['username']) if sender_row else 'Unknown'

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
        cursor.execute('SELECT supplier, container_date FROM ved_container_docs WHERE id = ?', (container_id,))
        container = cursor.fetchone()
        if not container:
            conn.close()
            return jsonify({'success': False, 'error': '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        cursor.execute('''
            INSERT INTO container_messages (container_id, message, sender_id, sender_name, recipient_ids, sender_type)
            VALUES (?, ?, ?, ?, ?, 'web')
        ''', (container_id, message, sender_id, sender_username, ','.join(map(str, recipient_ids))))
        message_id = cursor.lastrowid

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
        saved_files = []
        if files:
            saved_files = save_message_files(cursor, message_id, container_id, files)
            print(f"üìé –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {len(saved_files)} –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è #{message_id}")
        else:
            print(f"üìé –§–∞–π–ª–æ–≤ –Ω–µ—Ç, —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è #{message_id}")

        # –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –û–¢ —Ç–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–º –º—ã –æ—Ç–≤–µ—á–∞–µ–º
        # –ù–∞–ø—Ä–∏–º–µ—Ä: –æ—Ç–≤–µ—á–∞–µ–º –ú–∞–ª—ã—à–µ–≤—É ‚Üí —Å–æ–æ–±—â–µ–Ω–∏—è –û–¢ –ú–∞–ª—ã—à–µ–≤–∞ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏
        # –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ù–æ–≤–∏–∫–æ–≤–∞ –æ—Å—Ç–∞—é—Ç—Å—è –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏ (–µ–º—É –º—ã –Ω–µ –æ—Ç–≤–µ—á–∞–ª–∏)
        # –í–∞–∂–Ω–æ: —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Telegram –Ω–µ –∏–º–µ—é—Ç recipient_ids, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–∫–∂–µ NULL/–ø—É—Å—Ç—ã–µ
        if recipient_ids:
            placeholders = ','.join('?' * len(recipient_ids))
            cursor.execute(f'''
                UPDATE container_messages
                SET is_read = 1
                WHERE container_id = ?
                AND sender_id IN ({placeholders})
                AND (recipient_ids LIKE ? OR recipient_ids IS NULL OR recipient_ids = '')
            ''', (container_id, *recipient_ids, f'%{sender_id}%'))
        conn.commit()

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
        telegram_message_ids = []
        site_url = os.environ.get('SITE_URL', 'https://moscowseller.ru')

        for recipient_id in recipient_ids:
            cursor.execute('SELECT telegram_chat_id, username FROM users WHERE id = ?', (recipient_id,))
            recipient = cursor.fetchone()
            if recipient and recipient['telegram_chat_id']:
                chat_id = recipient['telegram_chat_id']

                # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                tg_text = f"üì¶ *–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä #{container_id}*\n"
                tg_text += f"üìÖ {container['container_date']} | {container['supplier']}\n\n"
                tg_text += f"üí¨ *–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {sender_username}:*\n{message}\n\n"
                # URL —Å / –ø–µ—Ä–µ–¥ # –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤ Telegram
                container_url = f"{site_url}/#ved:ved-containers:{container_id}"
                tg_text += f"üîó [–û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä]({container_url})"

                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞
                try:
                    tg_msg_id = send_telegram_container_message(chat_id, tg_text, container_id, message_id)
                    if tg_msg_id:
                        telegram_message_ids.append(str(tg_msg_id))
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ Telegram
                    if saved_files:
                        send_telegram_container_files(chat_id, saved_files)
                except Exception as tg_err:
                    print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram (chat_id={chat_id}): {tg_err}")

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏–π Telegram
        if telegram_message_ids:
            cursor.execute('UPDATE container_messages SET telegram_message_ids = ? WHERE id = ?',
                          (','.join(telegram_message_ids), message_id))
            conn.commit()

        conn.close()
        return jsonify({'success': True, 'message_id': message_id})

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ api_container_messages_send: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/container-messages/receive', methods=['POST'])
def api_container_messages_receive():
    """
    –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –∏–∑ Telegram –±–æ—Ç–∞.
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ telegram_bot.py.
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç JSON (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç) –∏ multipart/form-data (—Ç–µ–∫—Å—Ç + —Ñ–∞–π–ª—ã).
    """
    try:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞
        files = []
        if request.content_type and 'multipart/form-data' in request.content_type:
            token = request.form.get('token', '')
            container_id = request.form.get('container_id', type=int)
            message = request.form.get('message', '').strip()
            chat_id = request.form.get('chat_id')
            sender_name = request.form.get('sender_name', 'Telegram')
            files = request.files.getlist('files')
        else:
            data = request.json or {}
            token = data.get('token', '')
            container_id = data.get('container_id')
            message = data.get('message', '').strip()
            chat_id = data.get('chat_id')
            sender_name = data.get('sender_name', 'Telegram')

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
        expected_token = os.environ.get('TELEGRAM_BOT_SECRET', '')
        if not expected_token or token != expected_token:
            return jsonify({'success': False, 'error': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω'}), 403

        if not container_id or (not message and not files) or not chat_id:
            return jsonify({'success': False, 'error': '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö'}), 400

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ chat_id
        cursor.execute('SELECT id, username FROM users WHERE telegram_chat_id = ?', (str(chat_id),))
        user = cursor.fetchone()
        sender_id = user['id'] if user else 0
        sender_display = user['username'] if user else sender_name

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ (is_read=1, —Ç.–∫. –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å —Å–∞–º –∑–Ω–∞–µ—Ç —á—Ç–æ –Ω–∞–ø–∏—Å–∞–ª)
        cursor.execute('''
            INSERT INTO container_messages (container_id, message, sender_id, sender_name, sender_type, is_read)
            VALUES (?, ?, ?, ?, 'telegram', 1)
        ''', (container_id, message, sender_id, sender_display))
        message_id = cursor.lastrowid

        # –ü–æ–º–µ—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —ç—Ç–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ,
        # —Ç.–∫. –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏–ª ‚Äî –∑–Ω–∞—á–∏—Ç –æ–Ω –∏—Ö –ø—Ä–æ—á–∏—Ç–∞–ª
        if sender_id:
            cursor.execute('''
                UPDATE container_messages
                SET is_read = 1
                WHERE container_id = ?
                AND id != ?
                AND sender_id != ?
                AND is_read = 0
                AND (recipient_ids LIKE ? OR recipient_ids IS NULL OR recipient_ids = '')
            ''', (container_id, message_id, sender_id, f'%{sender_id}%'))

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if files:
            save_message_files(cursor, message_id, container_id, files)

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message_id': message_id})

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ api_container_messages_receive: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/container-messages/mark-read', methods=['POST'])
@require_auth(['admin', 'viewer'])
def api_container_messages_mark_read():
    """
    –û—Ç–º–µ—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ.
    """
    try:
        data = request.json or {}
        message_id = data.get('message_id')

        if not message_id:
            return jsonify({'success': False, 'error': 'message_id –Ω–µ —É–∫–∞–∑–∞–Ω'})

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute('UPDATE container_messages SET is_read = 1 WHERE id = ?', (message_id,))
        conn.commit()
        conn.close()

        return jsonify({'success': True})

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ api_container_messages_mark_read: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/container-messages/edit', methods=['POST'])
@require_auth()
def api_container_messages_edit():
    """
    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
    –ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.
    –¢–∞–∫–∂–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram.
    –§–∞–π–ª—ã –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç—Å—è ‚Äî –º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç.
    """
    try:
        data = request.json or {}
        message_id = data.get('message_id')
        new_message = (data.get('message') or '').strip()

        if not message_id:
            return jsonify({'success': False, 'error': 'message_id –Ω–µ —É–∫–∞–∑–∞–Ω'})
        if not new_message:
            return jsonify({'success': False, 'error': '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'})

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        cursor.execute('SELECT * FROM container_messages WHERE id = ?', (message_id,))
        msg = cursor.fetchone()
        if not msg:
            conn.close()
            return jsonify({'success': False, 'error': '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'}), 404

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä—Å—Ç–≤–æ ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        user_info = getattr(request, 'current_user', {})
        current_user_id = user_info.get('user_id')
        if msg['sender_id'] != current_user_id:
            conn.close()
            return jsonify({'success': False, 'error': '–ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è'}), 403

        # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ –ë–î
        cursor.execute('UPDATE container_messages SET message = ? WHERE id = ?', (new_message, message_id))
        conn.commit()

        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Telegram
        container_id = msg['container_id']
        tg_msg_ids = [x.strip() for x in (msg['telegram_message_ids'] or '').split(',') if x.strip()]
        recipient_ids = [x.strip() for x in (msg['recipient_ids'] or '').split(',') if x.strip()]

        if tg_msg_ids:
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
            cursor.execute('SELECT container_date, supplier FROM ved_container_docs WHERE id = ?', (container_id,))
            container = cursor.fetchone()
            site_url = os.environ.get('SITE_URL', 'https://moscowseller.ru')
            container_url = f"{site_url}/#ved:ved-containers:{container_id}"

            sender_name = msg['sender_name'] or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
            tg_text = f"üì¶ *–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä #{container_id}*\n"
            if container:
                tg_text += f"üìÖ {container['container_date']} | {container['supplier']}\n\n"
            tg_text += f"üí¨ *–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {sender_name}:*\n{new_message}\n\n"
            tg_text += f"‚úèÔ∏è _(–æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ)_\n\n"
            tg_text += f"üîó [–û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä]({container_url})"

            for i, tg_msg_id in enumerate(tg_msg_ids):
                # –ù–∞—Ö–æ–¥–∏–º chat_id –ø–æ–ª—É—á–∞—Ç–µ–ª—è
                r_id = recipient_ids[i] if i < len(recipient_ids) else None
                if r_id:
                    cursor.execute('SELECT telegram_chat_id FROM users WHERE id = ?', (int(r_id),))
                    user = cursor.fetchone()
                    if user and user['telegram_chat_id']:
                        edit_telegram_message(user['telegram_chat_id'], int(tg_msg_id), tg_text, parse_mode='Markdown')

        conn.close()
        return jsonify({'success': True})

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ api_container_messages_edit: {e}", file=sys.stderr)
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/container-messages/delete', methods=['POST'])
@require_auth()
def api_container_messages_delete():
    """
    –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏ –µ–≥–æ —Ñ–∞–π–ª—ã.
    –ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.
    –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram.
    """
    try:
        data = request.json or {}
        message_id = data.get('message_id')

        if not message_id:
            return jsonify({'success': False, 'error': 'message_id –Ω–µ —É–∫–∞–∑–∞–Ω'})

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        cursor.execute('SELECT * FROM container_messages WHERE id = ?', (message_id,))
        msg = cursor.fetchone()
        if not msg:
            conn.close()
            return jsonify({'success': False, 'error': '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'}), 404

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä—Å—Ç–≤–æ ‚Äî —É–¥–∞–ª—è—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        user_info = getattr(request, 'current_user', {})
        current_user_id = user_info.get('user_id')
        if msg['sender_id'] != current_user_id:
            conn.close()
            return jsonify({'success': False, 'error': '–ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è'}), 403

        container_id = msg['container_id']

        # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã —Å –¥–∏—Å–∫–∞ (CASCADE –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ PRAGMA foreign_keys = ON)
        cursor.execute('SELECT * FROM container_message_files WHERE message_id = ?', (message_id,))
        files = cursor.fetchall()
        for f in files:
            try:
                file_path = os.path.join(UPLOAD_FOLDER, str(container_id), 'messages', f['stored_filename'])
                if os.path.exists(file_path):
                    os.remove(file_path)
            except Exception as fe:
                print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ {f['stored_filename']}: {fe}", file=sys.stderr)

        # –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–æ–≤ –∏–∑ –ë–î
        cursor.execute('DELETE FROM container_message_files WHERE message_id = ?', (message_id,))

        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –ë–î
        cursor.execute('DELETE FROM container_messages WHERE id = ?', (message_id,))
        conn.commit()

        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Telegram ‚Äî —É–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
        tg_msg_ids = [x.strip() for x in (msg['telegram_message_ids'] or '').split(',') if x.strip()]
        recipient_ids = [x.strip() for x in (msg['recipient_ids'] or '').split(',') if x.strip()]

        for i, tg_msg_id in enumerate(tg_msg_ids):
            r_id = recipient_ids[i] if i < len(recipient_ids) else None
            if r_id:
                cursor.execute('SELECT telegram_chat_id FROM users WHERE id = ?', (int(r_id),))
                user = cursor.fetchone()
                if user and user['telegram_chat_id']:
                    delete_telegram_message(user['telegram_chat_id'], int(tg_msg_id))

        conn.close()
        return jsonify({'success': True})

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ api_container_messages_delete: {e}", file=sys.stderr)
        return jsonify({'success': False, 'error': str(e)}), 500


def send_telegram_container_message(chat_id, text, container_id, message_id):
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram —Å –∫–Ω–æ–ø–∫–æ–π "–û—Ç–≤–µ—Ç–∏—Ç—å".
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ID –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ None.
    """
    import requests

    bot_token = os.environ.get('TELEGRAM_BOT_TOKEN', '')
    if not bot_token:
        print("‚ö†Ô∏è TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
        return None

    try:
        # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–∞
        reply_markup = {
            "inline_keyboard": [[
                {"text": "üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å", "callback_data": f"reply_container:{container_id}:{message_id}"}
            ]]
        }

        response = requests.post(
            f"https://api.telegram.org/bot{bot_token}/sendMessage",
            json={
                "chat_id": chat_id,
                "text": text,
                "parse_mode": "Markdown",
                "reply_markup": reply_markup
            },
            timeout=10
        )

        result = response.json()
        if result.get('ok'):
            return result['result']['message_id']
        else:
            print(f"‚ö†Ô∏è Telegram API error: {result}")
            return None

    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: {e}")
        return None


def send_telegram_container_files(chat_id, files_info):
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª—ã –≤ Telegram –ø–æ—Å–ª–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
    files_info: —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∫–ª—é—á–∞–º–∏ file_path, file_type, filename
    """
    import requests as req_lib

    bot_token = os.environ.get('TELEGRAM_BOT_TOKEN', '')
    if not bot_token:
        return

    for f in files_info:
        try:
            file_path = f['file_path']
            if not os.path.exists(file_path):
                continue

            with open(file_path, 'rb') as fobj:
                if f['file_type'].startswith('image/'):
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ —Ñ–æ—Ç–æ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–≤—å—é –≤ Telegram)
                    req_lib.post(
                        f"https://api.telegram.org/bot{bot_token}/sendPhoto",
                        data={"chat_id": chat_id},
                        files={"photo": (f['filename'], fobj)},
                        timeout=30
                    )
                else:
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç
                    req_lib.post(
                        f"https://api.telegram.org/bot{bot_token}/sendDocument",
                        data={"chat_id": chat_id},
                        files={"document": (f['filename'], fobj)},
                        timeout=30
                    )
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞ –≤ Telegram: {e}")


def edit_telegram_message(chat_id, message_id, new_text, parse_mode='Markdown'):
    """
    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram —á–µ—Ä–µ–∑ editMessageText API.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True –ø—Ä–∏ —É—Å–ø–µ—Ö–µ, False –ø—Ä–∏ –æ—à–∏–±–∫–µ.
    –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –Ω–æ –ù–ï –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –æ—Å–Ω–æ–≤–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é.
    """
    import requests as req_lib

    bot_token = os.environ.get('TELEGRAM_BOT_TOKEN', '')
    if not bot_token or not chat_id or not message_id:
        return False
    try:
        response = req_lib.post(
            f"https://api.telegram.org/bot{bot_token}/editMessageText",
            json={
                "chat_id": int(chat_id),
                "message_id": int(message_id),
                "text": new_text,
                "parse_mode": parse_mode
            },
            timeout=10
        )
        result = response.json()
        if not result.get('ok'):
            print(f"‚ö†Ô∏è Telegram editMessageText failed: {result}", file=sys.stderr)
        return result.get('ok', False)
    except Exception as e:
        print(f"‚ö†Ô∏è Telegram editMessageText error: {e}", file=sys.stderr)
        return False


def delete_telegram_message(chat_id, message_id):
    """
    –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram —á–µ—Ä–µ–∑ deleteMessage API.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True –ø—Ä–∏ —É—Å–ø–µ—Ö–µ, False –ø—Ä–∏ –æ—à–∏–±–∫–µ.
    –ë–æ—Ç –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞, —á—É–∂–∏–µ ‚Äî —Ç–æ–ª—å–∫–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 48 —á–∞—Å–æ–≤.
    """
    import requests as req_lib

    bot_token = os.environ.get('TELEGRAM_BOT_TOKEN', '')
    if not bot_token or not chat_id or not message_id:
        return False
    try:
        response = req_lib.post(
            f"https://api.telegram.org/bot{bot_token}/deleteMessage",
            json={
                "chat_id": int(chat_id),
                "message_id": int(message_id)
            },
            timeout=10
        )
        result = response.json()
        if not result.get('ok'):
            print(f"‚ö†Ô∏è Telegram deleteMessage failed: {result}", file=sys.stderr)
        return result.get('ok', False)
    except Exception as e:
        print(f"‚ö†Ô∏è Telegram deleteMessage error: {e}", file=sys.stderr)
        return False


@app.route('/api/container-messages/pending-reminders', methods=['POST'])
def api_container_messages_pending_reminders():
    """
    ============================================================================
    –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –≠–ù–î–ü–û–ò–ù–¢ 24-–ß–ê–°–û–í–´–• –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô –û –ù–ï–ü–†–û–ß–ò–¢–ê–ù–ù–´–• –°–û–û–ë–©–ï–ù–ò–Ø–•
    ============================================================================

    –°–æ–±–∏—Ä–∞–µ—Ç –í–°–ï –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å—Ç–∞—Ä—à–µ 24—á –∏–∑ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
    –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Ö —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—é –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram.

    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∏–∑ telegram_bot.py (–∫–∞–∂–¥—ã–π —á–∞—Å, –∫—Ä–æ–º–µ –≤—ã—Ö–æ–¥–Ω—ã—Ö).

    –õ–û–ì–ò–ö–ê –ê–î–†–ï–°–ê–¶–ò–ò (–∫–æ–º—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ):
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    1. container_messages (–í–≠–î-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã):
       ‚Üí –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º –∏–∑ recipient_ids

    2. document_messages —Å sender_type='web' (–ø–µ—Ä–µ–ø–∏—Å–∫–∞ –≤ –ø—Ä–∏—Ö–æ–¥–∞—Ö/–æ—Ç–≥—Ä—É–∑–∫–∞—Ö):
       ‚Üí –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É Telegram-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–ø–æ telegram_chat_id –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏)
       –ü—Ä–∏–º–µ—Ä: –∞–¥–º–∏–Ω –Ω–∞–ø–∏—Å–∞–ª –≤ —á–∞—Ç –ø—Ä–∏—Ö–æ–¥–∞ ‚Üí Telegram-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª

    3. document_messages —Å sender_type='telegram' (–æ—Ç–≤–µ—Ç—ã –∏–∑ Telegram):
       ‚Üí –í—Å–µ–º –∞–¥–º–∏–Ω–∞–º —Å telegram_chat_id
       –ü—Ä–∏–º–µ—Ä: Telegram-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª ‚Üí –∞–¥–º–∏–Ω—ã –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–ª–∏

    4. document_messages —Å sender_type='system' (—Å–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è):
       ‚Üí –í—Å–µ–º –∞–¥–º–∏–Ω–∞–º —Å telegram_chat_id
       –ü—Ä–∏–º–µ—Ä: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–º —Ä–∞—Å—Ö–æ–¥–µ

    –ü–†–ò –î–û–ë–ê–í–õ–ï–ù–ò–ò –ù–û–í–û–ì–û –¢–ò–ü–ê –°–û–û–ë–©–ï–ù–ò–ô:
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    1. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É reminder_sent INTEGER DEFAULT 0 –≤ –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É
    2. –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é –∑–∞–ø—Ä–æ—Å–∞ –≤ —ç—Ç–æ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç (–ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏)
    3. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ª–æ–≥–∏–∫—É –∞–¥—Ä–µ—Å–∞—Ü–∏–∏: –∫–æ–º—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
    4. –û–±–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ telegram_bot.py (check_unanswered_messages_job)

    –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: —á–µ—Ä–µ–∑ TELEGRAM_BOT_SECRET —Ç–æ–∫–µ–Ω.
    """
    try:
        data = request.json or {}
        token = data.get('token', '')
        expected_token = os.environ.get('TELEGRAM_BOT_SECRET', '')
        if not expected_token or token != expected_token:
            return jsonify({'success': False, 'error': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω'}), 403

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # ====================================================================
        # 0. –û–ß–ò–°–¢–ö–ê: –ø–æ–º–µ—á–∞–µ–º reminder_sent=1 –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
        #    –ß—Ç–æ–±—ã orphan-—Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –ø–æ–ø–∞–¥–∞–ª–∏ –≤ –≤—ã–±–æ—Ä–∫—É –∫–∞–∂–¥—ã–π —á–∞—Å
        # ====================================================================

        # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, —á–µ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–¥–∞–ª—ë–Ω
        cursor.execute('''
            UPDATE container_messages SET reminder_sent = 1
            WHERE reminder_sent = 0 AND is_read = 0
              AND id NOT IN (
                  SELECT cm.id FROM container_messages cm
                  INNER JOIN ved_container_docs vcd ON cm.container_id = vcd.id
                  WHERE cm.reminder_sent = 0 AND cm.is_read = 0
              )
        ''')

        # –°–æ–æ–±—â–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, —á–µ–π –ø—Ä–∏—Ö–æ–¥/–æ—Ç–≥—Ä—É–∑–∫–∞ —É–¥–∞–ª—ë–Ω
        cursor.execute('''
            UPDATE document_messages SET reminder_sent = 1
            WHERE reminder_sent = 0 AND is_read = 0
              AND doc_type = 'receipt'
              AND NOT EXISTS (SELECT 1 FROM warehouse_receipt_docs WHERE id = document_messages.doc_id)
        ''')
        cursor.execute('''
            UPDATE document_messages SET reminder_sent = 1
            WHERE reminder_sent = 0 AND is_read = 0
              AND doc_type = 'shipment'
              AND NOT EXISTS (SELECT 1 FROM warehouse_shipment_docs WHERE id = document_messages.doc_id)
        ''')

        orphan_cleaned = cursor.rowcount  # –î–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å)
        if orphan_cleaned > 0:
            conn.commit()

        # –°—Ç—Ä—É–∫—Ç—É—Ä–∞: {–∫–ª—é—á_–ø–æ–ª—É—á–∞—Ç–µ–ª—è: {'container': [...], 'document': [...]}}
        # –ö–ª—é—á: user_id (int) –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–ª–∏ 'chat:CHAT_ID' –¥–ª—è Telegram-—Ç–æ–ª—å–∫–æ
        user_messages = {}
        container_ids_to_mark = []
        document_ids_to_mark = []

        # –ù–∞–∑–≤–∞–Ω–∏—è —Ç–∏–ø–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        doc_type_labels = {
            'receipt': 'üìÑ –ü—Ä–∏—Ö–æ–¥',
            'shipment': 'üöö –û—Ç–≥—Ä—É–∑–∫–∞',
            'finance_distribution': 'üí∞ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞',
            'finance_plan_distribution': 'üí∞ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–∞'
        }

        # –ö—ç—à: telegram_chat_id ‚Üí user_id (—á—Ç–æ–±—ã –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ)
        chat_id_to_user = {}

        def get_user_by_chat_id(tg_chat_id):
            """–ù–∞–π—Ç–∏ user_id –ø–æ telegram_chat_id (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)."""
            if tg_chat_id in chat_id_to_user:
                return chat_id_to_user[tg_chat_id]
            cursor.execute(
                'SELECT id FROM users WHERE telegram_chat_id = ?',
                (str(tg_chat_id),)
            )
            row = cursor.fetchone()
            result = row['id'] if row else None
            chat_id_to_user[tg_chat_id] = result
            return result

        def ensure_user_bucket(uid):
            """–°–æ–∑–¥–∞—Ç—å –ø—É—Å—Ç—É—é –∫–æ—Ä–∑–∏–Ω—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –Ω–µ—Ç."""
            if uid not in user_messages:
                user_messages[uid] = {'container': [], 'document': []}

        # ====================================================================
        # 1. CONTAINER MESSAGES ‚Äî –∞–¥—Ä–µ—Å–æ–≤–∞–Ω—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º
        #    –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±—ã–ª —É–¥–∞–ª—ë–Ω (vcd.id IS NULL)
        # ====================================================================
        cursor.execute('''
            SELECT cm.id, cm.container_id, cm.message, cm.sender_name, cm.recipient_ids,
                   cm.created_at, vcd.supplier, vcd.container_date
            FROM container_messages cm
            LEFT JOIN ved_container_docs vcd ON cm.container_id = vcd.id
            WHERE cm.is_read = 0
              AND cm.reminder_sent = 0
              AND cm.recipient_ids IS NOT NULL
              AND cm.recipient_ids != ''
              AND cm.created_at <= datetime('now', '-24 hours')
              AND vcd.id IS NOT NULL
        ''')
        for msg in cursor.fetchall():
            container_ids_to_mark.append(msg['id'])
            recipient_ids = [int(x) for x in msg['recipient_ids'].split(',') if x.strip()]
            for uid in recipient_ids:
                ensure_user_bucket(uid)
                user_messages[uid]['container'].append({
                    'id': msg['id'],
                    'container_id': msg['container_id'],
                    'message': msg['message'][:100],
                    'sender_name': msg['sender_name'],
                    'created_at': msg['created_at'],
                    'supplier': msg['supplier'] or '',
                    'container_date': msg['container_date'] or ''
                })

        # ====================================================================
        # 2a. DOCUMENT MESSAGES (sender_type='web') ‚Äî –ø–µ—Ä–µ–ø–∏—Å–∫–∞ –≤ –ø—Ä–∏—Ö–æ–¥–∞—Ö/–æ—Ç–≥—Ä—É–∑–∫–∞—Ö
        #     –ê–¥–º–∏–Ω –Ω–∞–ø–∏—Å–∞–ª ‚Üí Telegram-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª ‚Üí –Ω–∞–ø–æ–º–∏–Ω–∞–µ–º –µ–º—É
        #     –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç-—Å—É—â–Ω–æ—Å—Ç—å —É–∂–µ —É–¥–∞–ª—ë–Ω
        # ====================================================================
        cursor.execute('''
            SELECT dm.id, dm.doc_type, dm.doc_id, dm.message, dm.sender_name,
                   dm.sender_type, dm.telegram_chat_id, dm.created_at
            FROM document_messages dm
            WHERE dm.is_read = 0
              AND dm.reminder_sent = 0
              AND dm.sender_type = 'web'
              AND dm.telegram_chat_id IS NOT NULL
              AND dm.created_at <= datetime('now', '-24 hours')
              AND (
                  (dm.doc_type = 'receipt' AND EXISTS (SELECT 1 FROM warehouse_receipt_docs WHERE id = dm.doc_id))
                  OR (dm.doc_type = 'shipment' AND EXISTS (SELECT 1 FROM warehouse_shipment_docs WHERE id = dm.doc_id))
                  OR (dm.doc_type NOT IN ('receipt', 'shipment'))
              )
        ''')
        for msg in cursor.fetchall():
            document_ids_to_mark.append(msg['id'])
            doc_label = doc_type_labels.get(msg['doc_type'], 'üìã –î–æ–∫—É–º–µ–Ω—Ç')
            tg_chat_id = msg['telegram_chat_id']

            # –ù–∞—Ö–æ–¥–∏–º user_id –ø–æ–ª—É—á–∞—Ç–µ–ª—è –ø–æ –µ–≥–æ telegram_chat_id
            recipient_uid = get_user_by_chat_id(tg_chat_id)
            if recipient_uid:
                ensure_user_bucket(recipient_uid)
                user_messages[recipient_uid]['document'].append({
                    'id': msg['id'],
                    'doc_type': msg['doc_type'],
                    'doc_id': msg['doc_id'],
                    'doc_label': doc_label,
                    'message': msg['message'][:100],
                    'sender_name': msg['sender_name'],
                    'sender_type': msg['sender_type'],
                    'created_at': msg['created_at']
                })
            else:
                # Telegram-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ users ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º chat_id –Ω–∞–ø—Ä—è–º—É—é
                key = f'chat:{tg_chat_id}'
                ensure_user_bucket(key)
                user_messages[key]['document'].append({
                    'id': msg['id'],
                    'doc_type': msg['doc_type'],
                    'doc_id': msg['doc_id'],
                    'doc_label': doc_label,
                    'message': msg['message'][:100],
                    'sender_name': msg['sender_name'],
                    'sender_type': msg['sender_type'],
                    'created_at': msg['created_at']
                })

        # ====================================================================
        # 2b. DOCUMENT MESSAGES (sender_type='telegram'/'system') ‚Äî –æ—Ç Telegram/—Å–∏—Å—Ç–µ–º—ã
        #     Telegram-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª ‚Üí –∞–¥–º–∏–Ω—ã –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–ª–∏ ‚Üí –Ω–∞–ø–æ–º–∏–Ω–∞–µ–º –∞–¥–º–∏–Ω–∞–º
        #     –°–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Üí –∞–¥–º–∏–Ω—ã –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ ‚Üí –Ω–∞–ø–æ–º–∏–Ω–∞–µ–º –∞–¥–º–∏–Ω–∞–º
        #     –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç-—Å—É—â–Ω–æ—Å—Ç—å —É–∂–µ —É–¥–∞–ª—ë–Ω
        # ====================================================================
        cursor.execute('''
            SELECT dm.id, dm.doc_type, dm.doc_id, dm.message, dm.sender_name,
                   dm.sender_type, dm.created_at
            FROM document_messages dm
            WHERE dm.is_read = 0
              AND dm.reminder_sent = 0
              AND dm.sender_type IN ('telegram', 'system')
              AND dm.created_at <= datetime('now', '-24 hours')
              AND (
                  (dm.doc_type = 'receipt' AND EXISTS (SELECT 1 FROM warehouse_receipt_docs WHERE id = dm.doc_id))
                  OR (dm.doc_type = 'shipment' AND EXISTS (SELECT 1 FROM warehouse_shipment_docs WHERE id = dm.doc_id))
                  OR (dm.doc_type NOT IN ('receipt', 'shipment'))
              )
        ''')
        doc_messages_for_admins = cursor.fetchall()

        if doc_messages_for_admins:
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –∞–¥–º–∏–Ω–æ–≤ —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º Telegram
            cursor.execute('''
                SELECT id FROM users
                WHERE role = 'admin' AND telegram_chat_id IS NOT NULL AND telegram_chat_id != ''
            ''')
            admin_ids = [row['id'] for row in cursor.fetchall()]

            for msg in doc_messages_for_admins:
                document_ids_to_mark.append(msg['id'])
                doc_label = doc_type_labels.get(msg['doc_type'], 'üìã –î–æ–∫—É–º–µ–Ω—Ç')

                for admin_id in admin_ids:
                    ensure_user_bucket(admin_id)
                    user_messages[admin_id]['document'].append({
                        'id': msg['id'],
                        'doc_type': msg['doc_type'],
                        'doc_id': msg['doc_id'],
                        'doc_label': doc_label,
                        'message': msg['message'][:100],
                        'sender_name': msg['sender_name'],
                        'sender_type': msg['sender_type'],
                        'created_at': msg['created_at']
                    })

        # ====================================================================
        # 3. –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—é
        # ====================================================================
        if not user_messages:
            conn.close()
            return jsonify({'success': True, 'reminders': []})

        reminders = []
        for uid, msgs_by_type in user_messages.items():
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ –∫–æ—Ä–∑–∏–Ω—ã
            if not msgs_by_type['container'] and not msgs_by_type['document']:
                continue

            if isinstance(uid, str) and uid.startswith('chat:'):
                # –ù–µ–ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π Telegram-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º chat_id –Ω–∞–ø—Ä—è–º—É—é
                raw_chat_id = int(uid.split(':')[1])
                # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∏–º—è –∏–∑ telegram_users
                cursor.execute(
                    'SELECT first_name, username FROM telegram_users WHERE chat_id = ?',
                    (raw_chat_id,)
                )
                tg_user = cursor.fetchone()
                display_name = (tg_user['first_name'] or tg_user['username']) if tg_user else '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
                reminders.append({
                    'user_id': 0,
                    'chat_id': raw_chat_id,
                    'display_name': display_name,
                    'container_messages': msgs_by_type['container'],
                    'document_messages': msgs_by_type['document']
                })
            else:
                # –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –±–µ—Ä—ë–º chat_id –∏–∑ users
                cursor.execute(
                    'SELECT telegram_chat_id, display_name, username FROM users WHERE id = ?',
                    (uid,)
                )
                user = cursor.fetchone()
                if user and user['telegram_chat_id']:
                    reminders.append({
                        'user_id': uid,
                        'chat_id': int(user['telegram_chat_id']),
                        'display_name': user['display_name'] or user['username'],
                        'container_messages': msgs_by_type['container'],
                        'document_messages': msgs_by_type['document']
                    })

        # ====================================================================
        # 4. –ü–æ–º–µ—á–∞–µ–º –≤—Å–µ –∫–∞–∫ reminder_sent = 1
        # ====================================================================
        if container_ids_to_mark:
            placeholders = ','.join('?' * len(container_ids_to_mark))
            cursor.execute(f'''
                UPDATE container_messages SET reminder_sent = 1
                WHERE id IN ({placeholders})
            ''', container_ids_to_mark)

        if document_ids_to_mark:
            placeholders = ','.join('?' * len(document_ids_to_mark))
            cursor.execute(f'''
                UPDATE document_messages SET reminder_sent = 1
                WHERE id IN ({placeholders})
            ''', document_ids_to_mark)

        if container_ids_to_mark or document_ids_to_mark:
            conn.commit()

        conn.close()
        return jsonify({'success': True, 'reminders': reminders})

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ api_container_messages_pending_reminders: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/container-messages/files/<int:file_id>')
@require_auth(['admin', 'viewer'])
def download_container_message_file(file_id):
    """
    –°–∫–∞—á–∞—Ç—å –∏–ª–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–∞–π–ª, –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π –∫ —Å–æ–æ–±—â–µ–Ω–∏—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: ?view=1 –¥–ª—è inline –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫/PDF
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('''
            SELECT cmf.*, cm.container_id
            FROM container_message_files cmf
            JOIN container_messages cm ON cmf.message_id = cm.id
            WHERE cmf.id = ?
        ''', (file_id,))
        file_info = cursor.fetchone()
        conn.close()

        if not file_info:
            return jsonify({'success': False, 'error': '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404

        file_path = os.path.join(
            UPLOAD_FOLDER,
            str(file_info['container_id']),
            'messages',
            file_info['stored_filename']
        )

        if not os.path.exists(file_path):
            return jsonify({'success': False, 'error': '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ –¥–∏—Å–∫–µ'}), 404

        view_inline = request.args.get('view', '0') == '1'

        if view_inline and file_info['file_type'].startswith(('image/', 'application/pdf')):
            return send_file(file_path, mimetype=file_info['file_type'])
        else:
            return send_file(file_path, as_attachment=True, download_name=file_info['filename'])
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500


def save_message_files(cursor, message_id, container_id, files):
    """
    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª—ã, –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –∫ —Å–æ–æ–±—â–µ–Ω–∏—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (–¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram).
    """
    saved_files = []
    mime_types = {
        'pdf': 'application/pdf',
        'png': 'image/png',
        'jpg': 'image/jpeg',
        'jpeg': 'image/jpeg',
        'gif': 'image/gif',
        'doc': 'application/msword',
        'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'xls': 'application/vnd.ms-excel',
        'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'txt': 'text/plain',
        'zip': 'application/zip',
        'rar': 'application/x-rar-compressed'
    }

    # –ü–∞–ø–∫–∞ –¥–ª—è —Ñ–∞–π–ª–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    msg_folder = os.path.join(UPLOAD_FOLDER, str(container_id), 'messages')
    os.makedirs(msg_folder, exist_ok=True)

    for f in files:
        if not f or not f.filename:
            continue
        if not allowed_file(f.filename):
            continue

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä
        f.seek(0, 2)
        file_size = f.tell()
        f.seek(0)
        if file_size > MAX_FILE_SIZE:
            continue

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º UUID –∏–º—è —Ñ–∞–π–ª–∞
        original_filename = secure_filename(f.filename)
        ext = original_filename.rsplit('.', 1)[1].lower() if '.' in original_filename else ''
        stored_filename = f"{uuid.uuid4().hex}.{ext}" if ext else uuid.uuid4().hex

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª –Ω–∞ –¥–∏—Å–∫
        file_path = os.path.join(msg_folder, stored_filename)
        f.save(file_path)

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME —Ç–∏–ø
        file_type = mime_types.get(ext, 'application/octet-stream')

        # –ó–∞–ø–∏—Å—å –≤ –ë–î
        cursor.execute('''
            INSERT INTO container_message_files (message_id, filename, stored_filename, file_type, file_size)
            VALUES (?, ?, ?, ?, ?)
        ''', (message_id, f.filename, stored_filename, file_type, file_size))

        saved_files.append({
            'id': cursor.lastrowid,
            'filename': f.filename,
            'stored_filename': stored_filename,
            'file_type': file_type,
            'file_size': file_size,
            'file_path': file_path
        })

    return saved_files


@app.route('/api/users/create', methods=['POST'])
@require_auth(['admin'])
def api_users_create():
    """
    –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç JSON: {"username": "new_user", "password": "password123", "role": "viewer"}
    –†–æ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å: "admin" –∏–ª–∏ "viewer"
    """
    try:
        data = request.json or {}
        username = data.get('username', '').strip()
        password = data.get('password', '')
        role = data.get('role', 'viewer').strip()

        # –í–∞–ª–∏–¥–∞—Ü–∏—è
        if not username:
            return jsonify({'success': False, 'error': '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω'}), 400
        if len(username) < 3:
            return jsonify({'success': False, 'error': '–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞'}), 400
        if not password:
            return jsonify({'success': False, 'error': '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å'}), 400
        if len(password) < 6:
            return jsonify({'success': False, 'error': '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤'}), 400
        if role not in ('admin', 'viewer'):
            return jsonify({'success': False, 'error': '–†–æ–ª—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å admin –∏–ª–∏ viewer'}), 400

        # –•—ç—à–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å
        password_hash = generate_password_hash(password)

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        try:
            # display_name –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–≤–µ–Ω –ª–æ–≥–∏–Ω—É
            cursor.execute(
                'INSERT INTO users (username, password_hash, role, display_name) VALUES (?, ?, ?, ?)',
                (username, password_hash, role, username)
            )
            conn.commit()
            user_id = cursor.lastrowid
        except sqlite3.IntegrityError:
            conn.close()
            return jsonify({'success': False, 'error': f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "{username}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'}), 400

        conn.close()

        print(f"‚úÖ –°–æ–∑–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {username} (—Ä–æ–ª—å: {role})")
        return jsonify({
            'success': True,
            'user': {'id': user_id, 'username': username, 'display_name': username, 'role': role}
        })

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        return jsonify({'success': False, 'error': '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'}), 500


@app.route('/api/users/delete', methods=['POST'])
@require_auth(['admin'])
def api_users_delete():
    """
    –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç JSON: {"user_id": 2}
    –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è.
    """
    try:
        data = request.json or {}
        user_id = data.get('user_id')

        if not user_id:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'}), 400

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—ã—Ç–∞–µ—Ç—Å—è –ª–∏ –∞–¥–º–∏–Ω —É–¥–∞–ª–∏—Ç—å —Å–µ–±—è
        current_user = getattr(request, 'current_user', {})
        if current_user.get('user_id') == user_id:
            return jsonify({'success': False, 'error': '–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è'}), 400

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        cursor.execute('SELECT username FROM users WHERE id = ?', (user_id,))
        user = cursor.fetchone()

        if not user:
            conn.close()
            return jsonify({'success': False, 'error': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404

        username = user[0]
        cursor.execute('DELETE FROM users WHERE id = ?', (user_id,))
        conn.commit()
        conn.close()

        print(f"üóëÔ∏è –£–¥–∞–ª—ë–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {username}")
        return jsonify({'success': True, 'message': f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "{username}" —É–¥–∞–ª—ë–Ω'})

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        return jsonify({'success': False, 'error': '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'}), 500


@app.route('/api/users/change-password', methods=['POST'])
@require_auth(['admin'])
def api_users_change_password():
    """
    –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç JSON: {"user_id": 2, "new_password": "newpass123"}
    """
    try:
        data = request.json or {}
        user_id = data.get('user_id')
        new_password = data.get('new_password', '')

        if not user_id:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'}), 400
        if not new_password:
            return jsonify({'success': False, 'error': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å'}), 400
        if len(new_password) < 6:
            return jsonify({'success': False, 'error': '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤'}), 400

        # –•—ç—à–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å
        password_hash = generate_password_hash(new_password)

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        cursor.execute('SELECT username FROM users WHERE id = ?', (user_id,))
        user = cursor.fetchone()

        if not user:
            conn.close()
            return jsonify({'success': False, 'error': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404

        username = user[0]
        cursor.execute('UPDATE users SET password_hash = ? WHERE id = ?', (password_hash, user_id))
        conn.commit()
        conn.close()

        print(f"üîë –ò–∑–º–µ–Ω—ë–Ω –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {username}")
        return jsonify({'success': True, 'message': f'–ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "{username}" –∏–∑–º–µ–Ω—ë–Ω'})

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è: {e}")
        return jsonify({'success': False, 'error': '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'}), 500


@app.route('/api/users/rename', methods=['POST'])
@require_auth(['admin'])
def api_users_rename():
    """
    –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç JSON: {"user_id": 2, "new_username": "new_name"}
    """
    try:
        data = request.json or {}
        user_id = data.get('user_id')
        new_username = data.get('new_username', '').strip()

        if not user_id:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'}), 400
        if not new_username:
            return jsonify({'success': False, 'error': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'}), 400
        if len(new_username) < 3:
            return jsonify({'success': False, 'error': '–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞'}), 400

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        cursor.execute('SELECT username FROM users WHERE id = ?', (user_id,))
        user = cursor.fetchone()

        if not user:
            conn.close()
            return jsonify({'success': False, 'error': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404

        old_username = user[0]

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–Ω—è—Ç–æ –ª–∏ –Ω–æ–≤–æ–µ –∏–º—è –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        cursor.execute('SELECT id FROM users WHERE username = ? AND id != ?', (new_username, user_id))
        existing = cursor.fetchone()

        if existing:
            conn.close()
            return jsonify({'success': False, 'error': f'–ò–º—è "{new_username}" —É–∂–µ –∑–∞–Ω—è—Ç–æ'}), 400

        cursor.execute('UPDATE users SET username = ? WHERE id = ?', (new_username, user_id))
        conn.commit()
        conn.close()

        print(f"‚úèÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω: {old_username} ‚Üí {new_username}")
        return jsonify({'success': True, 'message': f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω: "{old_username}" ‚Üí "{new_username}"'})

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏: {e}")
        return jsonify({'success': False, 'error': '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'}), 500


@app.route('/api/users/set-display-name', methods=['POST'])
@require_auth(['admin'])
def api_users_set_display_name():
    """
    –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    –≠—Ç–æ –∏–º—è –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è –≤ —Å—Ç–æ–ª–±—Ü–∞—Ö "–ò–∑–º–µ–Ω–µ–Ω–æ", "–°–æ–∑–¥–∞–Ω–æ" –≤–º–µ—Å—Ç–æ –ª–æ–≥–∏–Ω–∞.

    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç JSON: {"user_id": 1, "display_name": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"}
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {"success": true, "message": "..."}
    """
    try:
        data = request.json or {}
        user_id = data.get('user_id')
        display_name = data.get('display_name', '').strip()

        if not user_id:
            return jsonify({'success': False, 'error': '–ù–µ —É–∫–∞–∑–∞–Ω ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'}), 400

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        cursor.execute('SELECT username FROM users WHERE id = ?', (user_id,))
        user = cursor.fetchone()

        if not user:
            conn.close()
            return jsonify({'success': False, 'error': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404

        username = user[0]

        cursor.execute('UPDATE users SET display_name = ? WHERE id = ?', (display_name, user_id))
        conn.commit()
        conn.close()

        if display_name:
            print(f"‚úèÔ∏è –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –¥–ª—è {username}: {display_name}")
            return jsonify({'success': True, 'message': f'–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: "{display_name}"'})
        else:
            print(f"‚úèÔ∏è –û—á–∏—â–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –¥–ª—è {username}")
            return jsonify({'success': True, 'message': '–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –æ—á–∏—â–µ–Ω–æ'})

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –∏–º–µ–Ω–∏: {e}")
        return jsonify({'success': False, 'error': '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'}), 500


@app.route('/api/sync', methods=['POST'])
@require_auth(['admin'])
def api_sync():
    """–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Ozon API"""
    try:
        print("\nüîÑ –ó–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...")
        success = sync_products()

        if success:
            return jsonify({
                'success': True,
                'message': '–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã',
                'date': get_snapshot_date()
            })
        else:
            return jsonify({
                'success': False,
                'message': '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö'
            }), 500

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: {e}")
        return jsonify({
            'success': False,
            'message': f'–û—à–∏–±–∫–∞: {str(e)}'
        }), 500

# ============================================================================
# –≠–ù–î–ü–û–ò–ù–¢: –ê–ù–ê–õ–ò–¢–ò–ö–ê FBO –ü–û –ö–õ–ê–°–¢–ï–†–ê–ú
# ============================================================================

@app.route('/api/fbo-analytics')
def get_fbo_analytics():
    """
    –ü–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É FBO —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ —Å –æ–±—â–∏–º–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º–∏ –∏ –≤–ª–æ–∂–µ–Ω–Ω—ã–º –º–∞—Å—Å–∏–≤–æ–º –∫–ª–∞—Å—Ç–µ—Ä–æ–≤.
    –ö–∞–∂–¥—ã–π –∫–ª–∞—Å—Ç–µ—Ä —Å–æ–¥–µ—Ä–∂–∏—Ç: –æ—Å—Ç–∞—Ç–∫–∏, ADS, IDC, –¥–Ω–∏ –±–µ–∑ –ø—Ä–æ–¥–∞–∂, —Å—Ç–∞—Ç—É—Å –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏.
    –¢–∞–∫–∂–µ –≤–∫–ª—é—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –ø–æ—Å—Ç–∞–≤–∫–∞—Ö (–≤ –ø—É—Ç–∏ –∏ –≤ –∑–∞—è–≤–∫–∞—Ö) –∏–∑ products_history.
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–∞—Ç—É —Å–Ω–∞–ø—à–æ—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        cursor.execute('SELECT MAX(snapshot_date) as max_date FROM fbo_analytics')
        row = cursor.fetchone()
        analytics_date = row['max_date'] if row else None

        if not analytics_date:
            conn.close()
            return jsonify({'success': True, 'products': [], 'message': '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏–∫–∏. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é.'})

        # –ü–æ–ª—É—á–∞–µ–º –∫–ª–∞—Å—Ç–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–∞—Ç—É
        cursor.execute('''
            SELECT sku, cluster_name, ads, idc, days_without_sales, liquidity_status, stock
            FROM fbo_analytics
            WHERE snapshot_date = ?
            ORDER BY sku, cluster_name
        ''', (analytics_date,))
        analytics_rows = cursor.fetchall()

        # –ü–æ–ª—É—á–∞–µ–º per-warehouse stock –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–∞—Ç—É
        cursor.execute('SELECT MAX(snapshot_date) as max_date FROM fbo_warehouse_stock')
        wh_row = cursor.fetchone()
        wh_date = wh_row['max_date'] if wh_row else None

        warehouse_stocks = {}
        if wh_date:
            cursor.execute('''
                SELECT sku, warehouse_name, stock
                FROM fbo_warehouse_stock
                WHERE snapshot_date = ?
                ORDER BY sku, warehouse_name
            ''', (wh_date,))
            for r in cursor.fetchall():
                sku = r['sku']
                if sku not in warehouse_stocks:
                    warehouse_stocks[sku] = []
                warehouse_stocks[sku].append({
                    'warehouse_name': r['warehouse_name'],
                    'stock': r['stock']
                })

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–∞—Ö (–Ω–∞–∑–≤–∞–Ω–∏–µ, –∞—Ä—Ç–∏–∫—É–ª) –∏ –ø–æ—Å—Ç–∞–≤–∫–∏
        cursor.execute('''
            SELECT ph.sku, ph.name, ph.offer_id, ph.fbo_stock, ph.in_transit, ph.in_draft
            FROM products_history ph
            JOIN (
                SELECT sku, MAX(snapshot_date) AS max_date
                FROM products_history
                GROUP BY sku
            ) last ON last.sku = ph.sku AND last.max_date = ph.snapshot_date
        ''')
        product_info = {}
        for r in cursor.fetchall():
            product_info[r['sku']] = {
                'name': r['name'],
                'offer_id': r['offer_id'],
                'fbo_stock': r['fbo_stock'] or 0,
                'in_transit': r['in_transit'] or 0,
                'in_draft': r['in_draft'] or 0
            }

        conn.close()

        # –î–ª—è SKU –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ products_history –∏–ª–∏ —É –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç offer_id ‚Äî –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∏–∑ API
        analytics_skus = set(r['sku'] for r in analytics_rows)
        missing_skus = [s for s in analytics_skus if s not in product_info or not product_info[s].get('offer_id')]
        if missing_skus:
            try:
                for i in range(0, len(missing_skus), 100):
                    batch = missing_skus[i:i + 100]
                    resp = requests.post(
                        f"{OZON_HOST}/v3/product/info/list",
                        json={"sku": batch},
                        headers=get_ozon_headers(),
                        timeout=15
                    )
                    if resp.status_code == 200:
                        for it in resp.json().get("items", []):
                            s = it.get("sku")
                            if s:
                                if s not in product_info:
                                    product_info[s] = {
                                        'name': it.get('name', ''),
                                        'offer_id': it.get('offer_id', ''),
                                        'fbo_stock': 0,
                                        'in_transit': 0,
                                        'in_draft': 0
                                    }
                                else:
                                    # –î–æ–ø–æ–ª–Ω—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–æ–ª—è
                                    if not product_info[s].get('offer_id'):
                                        product_info[s]['offer_id'] = it.get('offer_id', '')
                                    if not product_info[s].get('name'):
                                        product_info[s]['name'] = it.get('name', '')
            except Exception:
                pass  # –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å ‚Äî –ø–æ–∫–∞–∂–µ–º SKU –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è

        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ SKU
        products_map = {}
        for r in analytics_rows:
            sku = r['sku']
            if sku not in products_map:
                info = product_info.get(sku, {})
                products_map[sku] = {
                    'sku': sku,
                    'offer_id': info.get('offer_id', ''),
                    'name': info.get('name', ''),
                    'fbo_stock': info.get('fbo_stock', 0),
                    'in_transit': info.get('in_transit', 0),
                    'in_draft': info.get('in_draft', 0),
                    'total_ads': 0,
                    'total_stock_analytics': 0,
                    'worst_liquidity': '',
                    'clusters': []
                }

            cluster = {
                'cluster_name': r['cluster_name'],
                'stock': r['stock'] or 0,
                'ads': round(r['ads'] or 0, 2),
                'idc': round(r['idc'] or 0, 1),
                'days_without_sales': r['days_without_sales'] or 0,
                'liquidity_status': r['liquidity_status'] or ''
            }
            products_map[sku]['clusters'].append(cluster)
            products_map[sku]['total_ads'] += (r['ads'] or 0)
            products_map[sku]['total_stock_analytics'] += (r['stock'] or 0)

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ö—É–¥—à–∏–π —Å—Ç–∞—Ç—É—Å –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏
            liq = r['liquidity_status'] or ''
            current_worst = products_map[sku]['worst_liquidity']
            liq_priority = {
                'NO_SALES': 10, 'WAS_NO_SALES': 9, 'RESTRICTED_NO_SALES': 9,
                'DEFICIT': 8, 'WAS_DEFICIT': 7,
                'SURPLUS': 6, 'WAS_SURPLUS': 5,
                'ACTUAL': 4, 'WAS_ACTUAL': 3, 'WAITING_FOR_SUPPLY': 3,
                'POPULAR': 2, 'WAS_POPULAR': 1
            }
            if liq_priority.get(liq, 0) > liq_priority.get(current_worst, 0):
                products_map[sku]['worst_liquidity'] = liq

        # –§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        products = []
        for sku, prod in products_map.items():
            prod['total_ads'] = round(prod['total_ads'], 2)
            products.append(prod)

        # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ —Ä–µ–∞–ª—å–Ω–æ–º—É –æ—Å—Ç–∞—Ç–∫—É FBO (fbo_stock) –æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É
        # fbo_stock ‚Äî —Ç–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ /v2/analytics/stock_on_warehouses
        # total_stock_analytics ‚Äî –∏–∑ /v1/analytics/stocks (–º–æ–∂–µ—Ç –±—ã—Ç—å —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
        products.sort(key=lambda p: (-p['fbo_stock'], p.get('offer_id') or ''))

        return jsonify({
            'success': True,
            'products': products,
            'analytics_date': analytics_date
        })

    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e), 'products': []})


# ============================================================================
# API –ü–û–°–¢–ê–í–û–ö
# ============================================================================

@app.route('/api/currency-rates')
def get_currency_rates():
    """
    –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç –¶–ë –†–§ (CNY, USD, EUR).

    –ö—É—Ä—Å—ã –∫—ç—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å. –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ –∑–∞ –¥–µ–Ω—å
    –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å —Å–∞–π—Ç–∞ –¶–ë –†–§.
    """
    try:
        rates = fetch_cbr_rates()
        return jsonify({
            'success': True,
            'rates': rates,
            'date': get_snapshot_date()
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'rates': {}})


@app.route('/api/supplies')
def get_supplies():
    """
    –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å—Ç–∞–≤–æ–∫ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–∞–≤–æ–∫, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è.
    –í–∫–ª—é—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (container_is_completed).
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å—Ç–∞–≤–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –∫—É—Ä—Å–µ —é–∞–Ω—è –∏ –ø—Ä–æ—Ü–µ–Ω—Ç–µ –Ω–∞—Ü–µ–Ω–∫–∏
        cursor.execute('''
            SELECT s.*,
                   COALESCE(d.is_completed, 0) as container_is_completed,
                   COALESCE(d.cny_rate, 0) as container_cny_rate,
                   COALESCE(d.cny_percent, 0) as container_cny_percent
            FROM supplies s
            LEFT JOIN ved_container_docs d ON s.container_doc_id = d.id
            ORDER BY s.exit_factory_date ASC, s.created_at ASC
        ''')

        supplies = [dict(row) for row in cursor.fetchall()]
        conn.close()

        return jsonify({
            'success': True,
            'supplies': supplies
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'supplies': []})


@app.route('/api/warehouse/movements/<int:sku>')
def get_warehouse_movements_by_sku(sku):
    """
    –ü–æ–ª—É—á–∏—Ç—å –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏—è –∏ –æ—Ç–≥—Ä—É–∑–∫–∏ –¥–ª—è —Ç–æ–≤–∞—Ä–∞ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –û—Å—Ç–∞—Ç–∫–∏.

    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:
        receipts_limit: –ª–∏–º–∏—Ç –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10)
        receipts_offset: —Å–º–µ—â–µ–Ω–∏–µ –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0)
        shipments_limit: –ª–∏–º–∏—Ç –æ—Ç–≥—Ä—É–∑–æ–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10)
        shipments_offset: —Å–º–µ—â–µ–Ω–∏–µ –æ—Ç–≥—Ä—É–∑–æ–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0)

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        receipts: —Å–ø–∏—Å–æ–∫ –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–π
        shipments: —Å–ø–∏—Å–æ–∫ –æ—Ç–≥—Ä—É–∑–æ–∫
        receipts_total: –æ–±—â–µ–µ –∫–æ–ª-–≤–æ –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–π
        shipments_total: –æ–±—â–µ–µ –∫–æ–ª-–≤–æ –æ—Ç–≥—Ä—É–∑–æ–∫
        has_more_receipts: –µ—Å—Ç—å –ª–∏ –µ—â—ë –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏—è
        has_more_shipments: –µ—Å—Ç—å –ª–∏ –µ—â—ë –æ—Ç–≥—Ä—É–∑–∫–∏
    """
    try:
        receipts_limit = request.args.get('receipts_limit', 10, type=int)
        receipts_offset = request.args.get('receipts_offset', 0, type=int)
        shipments_limit = request.args.get('shipments_limit', 10, type=int)
        shipments_offset = request.args.get('shipments_offset', 0, type=int)

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # ========== –û–ü–†–ò–•–û–î–û–í–ê–ù–ò–Ø ==========
        cursor.execute('SELECT COUNT(*) as cnt FROM warehouse_receipts WHERE sku = ?', (sku,))
        receipts_total = cursor.fetchone()['cnt']

        cursor.execute('''
            SELECT
                r.id,
                r.doc_id,
                r.receipt_date,
                r.quantity,
                r.purchase_price,
                r.calculated_cost,
                r.comment,
                d.receipt_datetime,
                d.comment as doc_comment,
                d.created_by
            FROM warehouse_receipts r
            LEFT JOIN warehouse_receipt_docs d ON r.doc_id = d.id
            WHERE r.sku = ?
            ORDER BY r.receipt_date DESC, r.id DESC
            LIMIT ? OFFSET ?
        ''', (sku, receipts_limit, receipts_offset))
        receipts = [dict(row) for row in cursor.fetchall()]

        # ========== –û–¢–ì–†–£–ó–ö–ò ==========
        cursor.execute('SELECT COUNT(*) as cnt FROM warehouse_shipments WHERE sku = ?', (sku,))
        shipments_total = cursor.fetchone()['cnt']

        cursor.execute('''
            SELECT
                s.id,
                s.doc_id,
                s.shipment_date,
                s.quantity,
                s.destination,
                s.comment,
                d.shipment_datetime,
                d.destination as doc_destination,
                d.comment as doc_comment,
                d.created_by,
                d.is_completed
            FROM warehouse_shipments s
            LEFT JOIN warehouse_shipment_docs d ON s.doc_id = d.id
            WHERE s.sku = ?
            ORDER BY s.shipment_date DESC, s.id DESC
            LIMIT ? OFFSET ?
        ''', (sku, shipments_limit, shipments_offset))
        shipments = [dict(row) for row in cursor.fetchall()]

        conn.close()

        has_more_receipts = (receipts_offset + len(receipts)) < receipts_total
        has_more_shipments = (shipments_offset + len(shipments)) < shipments_total

        return jsonify({
            'success': True,
            'receipts': receipts,
            'shipments': shipments,
            'receipts_total': receipts_total,
            'shipments_total': shipments_total,
            'has_more_receipts': has_more_receipts,
            'has_more_shipments': has_more_shipments,
            'receipts_offset': receipts_offset,
            'shipments_offset': shipments_offset
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'receipts': [], 'shipments': []})



@app.route('/api/supplies/save', methods=['POST'])
@require_auth(['admin'])
def save_supply():
    """
    –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É –ø–æ—Å—Ç–∞–≤–∫–∏.

    –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ –ø–æ–ª–µ: arrival_warehouse_qty.
    –û—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (sku, exit_factory_date, exit_factory_qty) –ø—Ä–∏—Ö–æ–¥—è—Ç –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –í–≠–î
    –∏ –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
    """
    try:
        data = request.json
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        supply_id = data.get('id', '')
        if not supply_id or str(supply_id).startswith('new_'):
            # –ù–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –í–≠–î
            conn.close()
            return jsonify({'success': False, 'error': '–°—Ç—Ä–æ–∫–∏ –ø–æ—Å—Ç–∞–≤–æ–∫ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –í–≠–î'})

        # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–ª-–≤–æ –ø—Ä–∏—Ö–æ–¥–∞ –Ω–∞ —Å–∫–ª–∞–¥
        cursor.execute('''
            UPDATE supplies SET
                arrival_warehouse_qty = ?,
                updated_at = CURRENT_TIMESTAMP
            WHERE id = ?
        ''', (
            data.get('arrival_warehouse_qty'),
            int(supply_id)
        ))
        new_id = int(supply_id)

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'id': new_id,
            'message': '–ü–æ—Å—Ç–∞–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞'
        })
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/supplies/lock', methods=['POST'])
@require_auth(['admin'])
def lock_supply():
    """
    –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É –ø–æ—Å—Ç–∞–≤–∫–∏ (–∑–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è).
    """
    try:
        data = request.json
        supply_id = data.get('id')

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute('UPDATE supplies SET is_locked = 1 WHERE id = ?', (supply_id,))
        conn.commit()
        conn.close()

        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/supplies/unlock', methods=['POST'])
@require_auth(['admin'])
def unlock_supply():
    """
    –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É –ø–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
    """
    try:
        data = request.json
        supply_id = data.get('id')

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute('UPDATE supplies SET is_locked = 0 WHERE id = ?', (supply_id,))
        conn.commit()
        conn.close()

        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/supplies/delete', methods=['POST'])
@require_auth(['admin'])
def delete_supply():
    """
    –£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É –ø–æ—Å—Ç–∞–≤–∫–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
    """
    try:
        data = request.json
        supply_id = data.get('id')

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º ‚Äî –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥–æ–≤ –¥–ª—è —ç—Ç–æ–π –ø–æ—Å—Ç–∞–≤–∫–∏
        affected_receipt_doc_ids = _rollback_receipt_distributions_for_supplies(cursor, [supply_id])

        cursor.execute('DELETE FROM supplies WHERE id = ?', (supply_id,))

        # –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ø—Ä–∏—Ö–æ–¥—ã –ø–æ –æ—Å—Ç–∞–≤—à–∏–º—Å—è –ø–æ—Å—Ç–∞–≤–∫–∞–º
        if affected_receipt_doc_ids:
            _redistribute_receipt_docs(cursor, affected_receipt_doc_ids)

        conn.commit()
        conn.close()

        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/supplies/<int:supply_id>/distributions')
@require_auth(['admin', 'viewer'])
def get_supply_distributions(supply_id):
    """
    –ü–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥–æ–≤ –¥–ª—è —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å—Ç–∞–≤–∫–∏.
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–∑ –∫–∞–∫–∏—Ö –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–π –±—ã–ª–∏ –∑–∞–ø–∏—Å–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ –≤ arrival_warehouse_qty.
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('''
            SELECT d.receipt_date, d.quantity, d.cost_plus_6, d.receipt_doc_id
            FROM supply_receipt_distributions d
            WHERE d.supply_id = ?
            ORDER BY d.receipt_date ASC
        ''', (supply_id,))

        distributions = [dict(row) for row in cursor.fetchall()]
        conn.close()

        return jsonify({
            'success': True,
            'distributions': distributions
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'distributions': []})


@app.route('/api/supplies/migrate-from-containers', methods=['POST'])
@require_auth(['admin'])
def migrate_supplies_from_containers():
    """
    –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å–∏ –≤ supplies –¥–ª—è –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –í–≠–î,
    —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—â—ë –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –≤ supplies.

    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏.
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å –∏—Ö –ø–æ–∑–∏—Ü–∏—è–º–∏
        cursor.execute('''
            SELECT
                d.id as doc_id,
                d.container_date,
                i.id as item_id,
                i.sku,
                i.quantity,
                i.price_cny,
                i.logistics_rf,
                i.logistics_cn,
                i.terminal,
                i.customs
            FROM ved_container_docs d
            JOIN ved_container_items i ON i.doc_id = d.id
        ''')

        items = cursor.fetchall()
        created_count = 0

        for item in items:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è —ç—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏
            cursor.execute(
                'SELECT id FROM supplies WHERE container_doc_id = ? AND container_item_id = ?',
                (item['doc_id'], item['item_id'])
            )
            existing = cursor.fetchone()

            if not existing:
                # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ª–æ–≥–∏—Å—Ç–∏–∫—É –∑–∞ –µ–¥–∏–Ω–∏—Ü—É
                total_logistics = (item['logistics_rf'] or 0) + (item['logistics_cn'] or 0) + \
                                  (item['terminal'] or 0) + (item['customs'] or 0)
                logistics_per_unit = total_logistics / item['quantity'] if item['quantity'] > 0 else 0

                # –°–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å –≤ supplies
                cursor.execute('''
                    INSERT INTO supplies (sku, exit_factory_date, exit_factory_qty, logistics_cost_per_unit,
                                          price_cny, container_doc_id, container_item_id, created_at, updated_at)
                    VALUES (?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
                ''', (
                    item['sku'],
                    item['container_date'],
                    item['quantity'],
                    logistics_per_unit,
                    item['price_cny'],
                    item['doc_id'],
                    item['item_id']
                ))
                created_count += 1

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': f'–°–æ–∑–¥–∞–Ω–æ {created_count} –∑–∞–ø–∏—Å–µ–π –≤ –ü–æ—Å—Ç–∞–≤–∫–∞—Ö',
            'created_count': created_count
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


# ============================================================================
# API –°–ö–õ–ê–î–ê ‚Äî –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–µ, –æ—Ç–≥—Ä—É–∑–∫–∏, –æ—Å—Ç–∞—Ç–∫–∏
# ============================================================================

@app.route('/api/warehouse/receipts')
@require_auth(['admin', 'viewer'])
def get_warehouse_receipts():
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏—è"""
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('''
            SELECT * FROM warehouse_receipts
            ORDER BY receipt_date DESC, created_at DESC
        ''')

        receipts = [dict(row) for row in cursor.fetchall()]
        conn.close()

        return jsonify({'success': True, 'receipts': receipts})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'receipts': []})


@app.route('/api/warehouse/receipts/save', methods=['POST'])
@require_auth(['admin'])
def save_warehouse_receipt():
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–µ"""
    try:
        data = request.json
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        receipt_id = data.get('id', '')
        is_new = str(receipt_id).startswith('new_') or not receipt_id

        if is_new:
            cursor.execute('''
                INSERT INTO warehouse_receipts (sku, receipt_date, quantity, purchase_price, comment, updated_at)
                VALUES (?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
            ''', (
                data.get('sku', 0),
                data.get('receipt_date', ''),
                data.get('quantity', 0),
                data.get('purchase_price', 0),
                data.get('comment', '')
            ))
            new_id = cursor.lastrowid
        else:
            cursor.execute('''
                UPDATE warehouse_receipts SET
                    sku = ?, receipt_date = ?, quantity = ?, purchase_price = ?, comment = ?, updated_at = CURRENT_TIMESTAMP
                WHERE id = ?
            ''', (
                data.get('sku', 0),
                data.get('receipt_date', ''),
                data.get('quantity', 0),
                data.get('purchase_price', 0),
                data.get('comment', ''),
                int(receipt_id)
            ))
            new_id = int(receipt_id)

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'id': new_id})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/warehouse/receipts/delete', methods=['POST'])
@require_auth(['admin'])
def delete_warehouse_receipt():
    """–£–¥–∞–ª–∏—Ç—å –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–µ"""
    try:
        data = request.json
        receipt_id = data.get('id')

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute('DELETE FROM warehouse_receipts WHERE id = ?', (receipt_id,))
        conn.commit()
        conn.close()

        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


# ============================================================================
# API –î–û–ö–£–ú–ï–ù–¢–û–í –ü–†–ò–•–û–î–û–í (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç —Å —à–∞–ø–∫–æ–π –∏ –ø–æ–∑–∏—Ü–∏—è–º–∏)
# ============================================================================

@app.route('/api/warehouse/receipt-docs')
@require_auth(['admin', 'viewer'])
def get_receipt_docs():
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø—Ä–∏—Ö–æ–¥–æ–≤ —Å –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        - id: ID –¥–æ–∫—É–º–µ–Ω—Ç–∞
        - receipt_datetime: –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø—Ä–∏—Ö–æ–¥–∞
        - comment: –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        - items_count: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∑–∏—Ü–∏–π (—Ç–æ–≤–∞—Ä–æ–≤)
        - total_qty: –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü
        - total_sum: –æ–±—â–∞—è —Å—É–º–º–∞
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('''
            SELECT
                d.id,
                DATE(d.receipt_datetime) as receipt_date,
                d.receiver_name,
                d.comment,
                d.created_by,
                d.updated_by,
                d.created_at,
                d.updated_at,
                COALESCE(d.source, 'web') as source,
                d.telegram_chat_id,
                COUNT(r.id) as items_count,
                COALESCE(SUM(r.quantity), 0) as total_qty,
                COALESCE(SUM(r.quantity * r.purchase_price), 0) as total_sum,
                COALESCE(SUM(r.quantity * r.calculated_cost), 0) as total_calculated_cost,
                GROUP_CONCAT(DISTINCT r.sku) as item_skus,
                CASE WHEN COALESCE(SUM(r.quantity), 0) > COALESCE(
                    (SELECT SUM(srd.quantity) FROM supply_receipt_distributions srd WHERE srd.receipt_doc_id = d.id), 0
                ) THEN 1 ELSE 0 END as has_undistributed
            FROM warehouse_receipt_docs d
            LEFT JOIN warehouse_receipts r ON r.doc_id = d.id
            GROUP BY d.id
            ORDER BY d.receipt_datetime DESC, d.created_at DESC
        ''')

        docs = []
        for row in cursor.fetchall():
            doc = dict(row)
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É SKU –≤ —Å–ø–∏—Å–æ–∫ —á–∏—Å–µ–ª
            if doc.get('item_skus'):
                doc['item_skus'] = [int(sku) for sku in doc['item_skus'].split(',')]
            else:
                doc['item_skus'] = []
            docs.append(doc)
        conn.close()

        return jsonify({'success': True, 'docs': docs})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'docs': []})


@app.route('/api/warehouse/receipt-docs/<int:doc_id>')
@require_auth(['admin', 'viewer'])
def get_receipt_doc(doc_id):
    """
    –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ–∫—É–º–µ–Ω—Ç–µ –ø—Ä–∏—Ö–æ–¥–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —à–∞–ø–∫—É –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏.
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º —à–∞–ø–∫—É –¥–æ–∫—É–º–µ–Ω—Ç–∞
        cursor.execute('''
            SELECT id, DATE(receipt_datetime) as receipt_date, receiver_name, comment,
                   created_by, updated_by, created_at, updated_at,
                   COALESCE(source, 'web') as source,
                   telegram_chat_id
            FROM warehouse_receipt_docs WHERE id = ?
        ''', (doc_id,))
        doc = cursor.fetchone()

        if not doc:
            conn.close()
            return jsonify({'success': False, 'error': '–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'})

        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–æ–π —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å—é
        cursor.execute('''
            SELECT id, sku, quantity, purchase_price, COALESCE(calculated_cost, 0) as calculated_cost
            FROM warehouse_receipts WHERE doc_id = ?
        ''', (doc_id,))
        items = [dict(row) for row in cursor.fetchall()]
        conn.close()

        return jsonify({
            'success': True,
            'doc': dict(doc),
            'items': items
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/warehouse/receipt-docs/<int:doc_id>/distributions')
@require_auth(['admin', 'viewer'])
def get_receipt_doc_distributions(doc_id):
    """
    –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥–∞ –ø–æ –ø–æ—Å—Ç–∞–≤–∫–∞–º.

    –î–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏—Ö–æ–¥–∞ (—Ç–æ–≤–∞—Ä–∞/SKU) –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –ø—Ä–∏—Ö–æ–¥–µ (receipt_qty)
    - –°–∫–æ–ª—å–∫–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –ø–æ –ø–æ—Å—Ç–∞–≤–∫–∞–º (total_distributed)
    - –°–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å –Ω–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º (undistributed)
    - –ú–∞—Å—Å–∏–≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π: –ø–æ –∫–∞–∫–æ–π –ø–æ—Å—Ç–∞–≤–∫–µ, –∫–æ–ª-–≤–æ, —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å, –¥–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏—Ö–æ–¥–∞ —Å –∏—Ö —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è–º–∏ –ø–æ –ø–æ—Å—Ç–∞–≤–∫–∞–º
        cursor.execute('''
            SELECT
                r.id as receipt_item_id,
                r.sku,
                r.quantity as receipt_qty,
                COALESCE(p.name, 'SKU ' || r.sku) as product_name,
                COALESCE(p.offer_id, '') as offer_id,
                d.supply_id,
                d.quantity as dist_qty,
                d.cost_plus_6,
                s.exit_factory_date,
                s.container_doc_id,
                COALESCE(cd.supplier, '') as container_supplier
            FROM warehouse_receipts r
            LEFT JOIN products p ON p.sku = r.sku
            LEFT JOIN supply_receipt_distributions d ON d.receipt_item_id = r.id
            LEFT JOIN supplies s ON s.id = d.supply_id
            LEFT JOIN ved_container_docs cd ON cd.id = s.container_doc_id
            WHERE r.doc_id = ?
            ORDER BY r.sku ASC, s.exit_factory_date ASC
        ''', (doc_id,))

        rows = cursor.fetchall()
        conn.close()

        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏—Ö–æ–¥–∞ (receipt_item_id)
        items_map = {}
        for row in rows:
            item_id = row['receipt_item_id']
            if item_id not in items_map:
                items_map[item_id] = {
                    'receipt_item_id': item_id,
                    'sku': row['sku'],
                    'product_name': row['product_name'],
                    'offer_id': row['offer_id'],
                    'receipt_qty': row['receipt_qty'],
                    'total_distributed': 0,
                    'undistributed': row['receipt_qty'],
                    'distributions': []
                }

            # –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (supply_id –Ω–µ NULL ‚Äî –∑–Ω–∞—á–∏—Ç LEFT JOIN –Ω–∞—à—ë–ª —Å—Ç—Ä–æ–∫—É)
            if row['supply_id'] is not None:
                dist_qty = row['dist_qty'] or 0
                items_map[item_id]['distributions'].append({
                    'supply_id': row['supply_id'],
                    'quantity': dist_qty,
                    'cost_plus_6': round(row['cost_plus_6'] or 0, 2),
                    'exit_factory_date': row['exit_factory_date'] or '',
                    'container_doc_id': row['container_doc_id'],
                    'container_supplier': row['container_supplier'] or ''
                })
                items_map[item_id]['total_distributed'] += dist_qty

        # –í—ã—á–∏—Å–ª—è–µ–º –Ω–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
        items = []
        has_undistributed = False
        for item in items_map.values():
            item['undistributed'] = item['receipt_qty'] - item['total_distributed']
            if item['undistributed'] > 0:
                has_undistributed = True
            items.append(item)

        return jsonify({
            'success': True,
            'items': items,
            'has_undistributed': has_undistributed
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'items': []})


@app.route('/api/warehouse/receipts/save-doc', methods=['POST'])
@require_auth(['admin'])
def save_receipt_doc():
    """
    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–∏—Ö–æ–¥–∞ —Å –ø–æ–∑–∏—Ü–∏—è–º–∏.
    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ–ª-–≤–æ –ø—Ä–∏—Ö–æ–¥–∞ –ø–æ –ø–æ—Å—Ç–∞–≤–∫–∞–º –∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å.

    –õ–æ–≥–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:
    1. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å—Ç–∞–≤–æ–∫ (–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã)
    2. –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –≤—ã—Ö–æ–¥–∞ —Å —Ñ–∞–±—Ä–∏–∫–∏ (—Å–Ω–∞—á–∞–ª–∞ —Ä–∞–Ω–Ω–∏–µ)
    3. –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª-–≤–æ, –Ω–µ –ø—Ä–µ–≤—ã—à–∞—è exit_factory_qty - arrival_warehouse_qty
    4. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—É—é —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å +6%
    5. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤ supply_receipt_distributions
    """
    try:
        data = request.json
        doc_id = data.get('doc_id')
        receipt_date = data.get('receipt_date', '')
        receiver_name = data.get('receiver_name', '')
        comment = data.get('comment', '')
        items = data.get('items', [])

        if not receipt_date:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –ø—Ä–∏—Ö–æ–¥–∞'})

        if not items:
            return jsonify({'success': False, 'error': '–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä'})

        user_id = request.current_user.get('user_id') if hasattr(request, 'current_user') else None
        username = get_user_display_name(user_id)

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        if doc_id:
            # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
            # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª—è –æ—Ç–∫–∞—Ç–∞ arrival_warehouse_qty
            cursor.execute('''
                SELECT supply_id, quantity FROM supply_receipt_distributions
                WHERE receipt_doc_id = ?
            ''', (doc_id,))
            old_distributions = cursor.fetchall()
            for dist in old_distributions:
                cursor.execute('''
                    UPDATE supplies SET arrival_warehouse_qty = COALESCE(arrival_warehouse_qty, 0) - ?
                    WHERE id = ?
                ''', (dist['quantity'], dist['supply_id']))

            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
            cursor.execute('DELETE FROM supply_receipt_distributions WHERE receipt_doc_id = ?', (doc_id,))

            # –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
            cursor.execute('''
                UPDATE warehouse_receipt_docs
                SET receipt_datetime = ?, receiver_name = ?, comment = ?, updated_by = ?, updated_at = CURRENT_TIMESTAMP
                WHERE id = ?
            ''', (receipt_date, receiver_name, comment, username, doc_id))

            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–∑–∏—Ü–∏–∏
            cursor.execute('DELETE FROM warehouse_receipts WHERE doc_id = ?', (doc_id,))
        else:
            # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
            cursor.execute('''
                INSERT INTO warehouse_receipt_docs (receipt_datetime, receiver_name, comment, created_by, updated_by, updated_at)
                VALUES (?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
            ''', (receipt_date, receiver_name, comment, username, username))
            doc_id = cursor.lastrowid

        # –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ—Å—Ç–∞–≤–∫–∞—Ö
        # (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏—Ö–æ–¥—É–µ–º–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ > –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–π –ª–æ–≥–∏—Å—Ç–∏–∫–æ–π/—Ü–µ–Ω–æ–π)
        items_without_supply_data = []

        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –ø–æ–∑–∏—Ü–∏—é –ø—Ä–∏—Ö–æ–¥–∞
        for item in items:
            sku = item.get('sku', 0)
            receipt_qty = item.get('quantity', 0)
            manual_price = item.get('purchase_price', 0)

            if not sku or receipt_qty <= 0:
                continue

            # –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å—Ç–∞–≤–æ–∫ –¥–ª—è —ç—Ç–æ–≥–æ SKU (—Ç–æ–ª—å–∫–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã)
            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –≤—ã—Ö–æ–¥–∞ —Å —Ñ–∞–±—Ä–∏–∫–∏
            cursor.execute('''
                SELECT s.id, s.exit_factory_qty, COALESCE(s.arrival_warehouse_qty, 0) as arrival_qty,
                       s.logistics_cost_per_unit, s.price_cny,
                       COALESCE(d.cny_rate, 0) as cny_rate,
                       COALESCE(d.cny_percent, 0) as cny_percent
                FROM supplies s
                LEFT JOIN ved_container_docs d ON s.container_doc_id = d.id
                WHERE s.sku = ? AND COALESCE(d.is_completed, 0) = 1
                ORDER BY s.exit_factory_date ASC, s.id ASC
            ''', (sku,))
            supply_rows = cursor.fetchall()

            # –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∏—Ö–æ–¥ –ø–æ —Å—Ç—Ä–æ–∫–∞–º –ø–æ—Å—Ç–∞–≤–æ–∫
            remaining_qty = receipt_qty
            distributions = []  # (supply_id, qty, cost_plus_6)

            for supply in supply_rows:
                if remaining_qty <= 0:
                    break

                available = supply['exit_factory_qty'] - supply['arrival_qty']
                if available <= 0:
                    continue

                # –°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ —ç—Ç—É —Å—Ç—Ä–æ–∫—É
                to_distribute = min(remaining_qty, available)

                # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å +6% –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏
                # –£—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –Ω–∞—Ü–µ–Ω–∫–∏ –Ω–∞ –∫—É—Ä—Å (–∫–∞–∫ –≤ –í–≠–î –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è—Ö)
                logistics = supply['logistics_cost_per_unit'] or 0
                price_cny = supply['price_cny'] or 0
                cny_rate = supply['cny_rate'] or 0
                cny_percent = supply['cny_percent'] or 0
                adjusted_rate = cny_rate * (1 + cny_percent / 100)
                price_rub = price_cny * adjusted_rate
                cost_plus_6 = (logistics + price_rub) * 1.06

                distributions.append({
                    'supply_id': supply['id'],
                    'quantity': to_distribute,
                    'cost_plus_6': cost_plus_6
                })

                remaining_qty -= to_distribute

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–æ—Å—å –ª–∏ –Ω–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ—Å—Ç–∞–≤–∫–∞—Ö)
            if remaining_qty > 0:
                # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                cursor.execute('SELECT name FROM products WHERE sku = ?', (sku,))
                product_row = cursor.fetchone()
                product_name = product_row['name'] if product_row else f'SKU {sku}'

                items_without_supply_data.append({
                    'sku': sku,
                    'name': product_name,
                    'receipt_qty': receipt_qty,
                    'distributed_qty': receipt_qty - remaining_qty,
                    'missing_qty': remaining_qty
                })

            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—É—é —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å
            total_qty = sum(d['quantity'] for d in distributions)
            if total_qty > 0:
                weighted_cost = sum(d['quantity'] * d['cost_plus_6'] for d in distributions) / total_qty
            else:
                weighted_cost = manual_price  # –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ—Å—Ç–∞–≤–æ–∫, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—á–Ω—É—é —Ü–µ–Ω—É

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–∏—Ö–æ–¥–∞ —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–æ–π —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å—é
            cursor.execute('''
                INSERT INTO warehouse_receipts (doc_id, sku, receipt_date, quantity, purchase_price, calculated_cost, updated_at)
                VALUES (?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
            ''', (doc_id, sku, receipt_date, receipt_qty, manual_price, weighted_cost))
            receipt_item_id = cursor.lastrowid

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å—Ç–∞–≤–∫–∏
            for dist in distributions:
                # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
                cursor.execute('''
                    INSERT INTO supply_receipt_distributions
                    (supply_id, receipt_item_id, receipt_doc_id, quantity, cost_plus_6, receipt_date)
                    VALUES (?, ?, ?, ?, ?, ?)
                ''', (dist['supply_id'], receipt_item_id, doc_id, dist['quantity'], dist['cost_plus_6'], receipt_date))

                # –û–±–Ω–æ–≤–ª—è–µ–º arrival_warehouse_qty –≤ –ø–æ—Å—Ç–∞–≤–∫–µ
                cursor.execute('''
                    UPDATE supplies SET arrival_warehouse_qty = COALESCE(arrival_warehouse_qty, 0) + ?,
                                        updated_at = CURRENT_TIMESTAMP
                    WHERE id = ?
                ''', (dist['quantity'], dist['supply_id']))

        conn.commit()
        conn.close()

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É, –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–≤–∞—Ä—ã –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ—Å—Ç–∞–≤–∫–∞—Ö
        if items_without_supply_data:
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            notification_lines = [
                "‚ö†Ô∏è <b>–í–ù–ò–ú–ê–ù–ò–ï: –ù–µ—Ö–≤–∞—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ—Å—Ç–∞–≤–∫–∞—Ö</b>",
                "",
                f"üì¶ –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–∏—Ö–æ–¥–∞ #{doc_id}",
                f"üìÖ –î–∞—Ç–∞: {receipt_date}",
                f"üë§ –ü—Ä–∏—ë–º—â–∏–∫: {receiver_name or '–ù–µ —É–∫–∞–∑–∞–Ω'}",
                "",
                "‚ùå <b>–¢–æ–≤–∞—Ä—ã –±–µ–∑ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏:</b>",
                ""
            ]

            for item in items_without_supply_data[:10]:  # –ú–∞–∫—Å–∏–º—É–º 10 —Ç–æ–≤–∞—Ä–æ–≤ –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏
                notification_lines.append(
                    f"‚Ä¢ <b>{item['name']}</b> (SKU: {item['sku']})\n"
                    f"   –ü—Ä–∏—Ö–æ–¥: {item['receipt_qty']} —à—Ç, —Å –¥–∞–Ω–Ω—ã–º–∏: {item['distributed_qty']} —à—Ç, "
                    f"<b>–±–µ–∑ –¥–∞–Ω–Ω—ã—Ö: {item['missing_qty']} —à—Ç</b>"
                )

            if len(items_without_supply_data) > 10:
                notification_lines.append(f"\n... –∏ –µ—â—ë {len(items_without_supply_data) - 10} —Ç–æ–≤–∞—Ä–æ–≤")

            notification_lines.extend([
                "",
                "üí° <b>–ß—Ç–æ –¥–µ–ª–∞—Ç—å:</b>",
                "1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ä–∞–∑–¥–µ–ª –í–≠–î ‚Üí –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã",
                "2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ª–æ–≥–∏—Å—Ç–∏–∫—É –∏ —Ü–µ–Ω—É –¥–ª—è –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤",
                "3. –û—Ç–º–µ—Ç—å—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∫–∞–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ",
                "4. –ü–µ—Ä–µ—Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–∏—Ö–æ–¥–∞"
            ])

            notification_text = "\n".join(notification_lines)
            send_admin_notification(notification_text)

        return jsonify({'success': True, 'doc_id': doc_id})
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/warehouse/receipt-docs/delete', methods=['POST'])
@require_auth(['admin'])
def delete_receipt_doc():
    """
    –£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–∏—Ö–æ–¥–∞ –≤–º–µ—Å—Ç–µ —Å–æ –≤—Å–µ–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏.
    –û—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –ø–æ—Å—Ç–∞–≤–∫–∞–º.
    """
    try:
        data = request.json
        doc_id = data.get('id')

        if not doc_id:
            return jsonify({'success': False, 'error': '–ù–µ —É–∫–∞–∑–∞–Ω ID –¥–æ–∫—É–º–µ–Ω—Ç–∞'})

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è: —É–º–µ–Ω—å—à–∞–µ–º arrival_warehouse_qty –≤ –ø–æ—Å—Ç–∞–≤–∫–∞—Ö
        cursor.execute('''
            SELECT supply_id, quantity FROM supply_receipt_distributions
            WHERE receipt_doc_id = ?
        ''', (doc_id,))
        distributions = cursor.fetchall()
        for dist in distributions:
            cursor.execute('''
                UPDATE supplies SET arrival_warehouse_qty = COALESCE(arrival_warehouse_qty, 0) - ?
                WHERE id = ?
            ''', (dist['quantity'], dist['supply_id']))

        # –£–¥–∞–ª—è–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
        cursor.execute('DELETE FROM supply_receipt_distributions WHERE receipt_doc_id = ?', (doc_id,))

        # –£–¥–∞–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏
        cursor.execute('DELETE FROM warehouse_receipts WHERE doc_id = ?', (doc_id,))

        # –£–¥–∞–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
        cursor.execute('DELETE FROM warehouse_receipt_docs WHERE id = ?', (doc_id,))

        conn.commit()
        conn.close()

        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


# ============================================================================
# API –î–õ–Ø TELEGRAM –ò–ù–¢–ï–ì–†–ê–¶–ò–ò
# ============================================================================


# ============================================================================
# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò: –û–¢–ö–ê–¢ –ò –ü–ï–†–ï–†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–†–ò–•–û–î–û–í
# ============================================================================
# –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏/–ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Ç—Ä–æ–∫ –ø–æ—Å—Ç–∞–≤–æ–∫ (supplies) –Ω—É–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å
# —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ —ç—Ç–∏ –ø–æ—Å—Ç–∞–≤–∫–∏, –∞ –∑–∞—Ç–µ–º
# –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∏—Ö–æ–¥—ã –ø–æ –Ω–æ–≤—ã–º —Å—Ç—Ä–æ–∫–∞–º –ø–æ—Å—Ç–∞–≤–æ–∫.
# –ë–µ–∑ —ç—Ç–æ–≥–æ –¥–∞–Ω–Ω—ã–µ arrival_warehouse_qty —Ç–µ—Ä—è—é—Ç—Å—è (–±–∞–≥: supply —É–¥–∞–ª–µ–Ω–∞,
# –∞ supply_receipt_distributions —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π supply_id).
# ============================================================================


def _rollback_receipt_distributions_for_supplies(cursor, supply_ids):
    """
    –û—Ç–∫–∞—Ç–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥–æ–≤, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏ –ø–æ—Å—Ç–∞–≤–æ–∫.

    –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞—Ç—Ä–æ–Ω—É—Ç–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∞:
    1. –£–º–µ–Ω—å—à–∞–µ–º arrival_warehouse_qty –≤ –ø–æ—Å—Ç–∞–≤–∫–∞—Ö –Ω–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–µ –∫–æ–ª-–≤–æ
    2. –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å–∏ –∏–∑ supply_receipt_distributions

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        cursor: –∫—É—Ä—Å–æ—Ä SQLite (conn.row_factory –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å sqlite3.Row)
        supply_ids (list[int]): ID —Å—Ç—Ä–æ–∫ –ø–æ—Å—Ç–∞–≤–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        list[int]: ID –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø—Ä–∏—Ö–æ–¥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å
    """
    if not supply_ids:
        return []

    placeholders = ','.join('?' * len(supply_ids))

    # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø—Ä–∏—Ö–æ–¥–æ–≤, –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —É–¥–∞–ª–µ–Ω–∏–µ–º —ç—Ç–∏—Ö –ø–æ—Å—Ç–∞–≤–æ–∫
    cursor.execute(f'''
        SELECT DISTINCT receipt_doc_id FROM supply_receipt_distributions
        WHERE supply_id IN ({placeholders})
    ''', supply_ids)
    affected_doc_ids = [row['receipt_doc_id'] for row in cursor.fetchall()]

    if not affected_doc_ids:
        return []

    # –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞—Ç—Ä–æ–Ω—É—Ç–æ–≥–æ –ø—Ä–∏—Ö–æ–¥–∞ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –í–°–ï –µ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
    # (–Ω–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —É–¥–∞–ª—è–µ–º—ã—Ö –ø–æ—Å—Ç–∞–≤–æ–∫), —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ü–µ–ª–∏–∫–æ–º
    for doc_id in affected_doc_ids:
        cursor.execute('''
            SELECT supply_id, quantity FROM supply_receipt_distributions
            WHERE receipt_doc_id = ?
        ''', (doc_id,))
        for dist in cursor.fetchall():
            cursor.execute('''
                UPDATE supplies SET arrival_warehouse_qty = COALESCE(arrival_warehouse_qty, 0) - ?
                WHERE id = ?
            ''', (dist['quantity'], dist['supply_id']))

        cursor.execute('DELETE FROM supply_receipt_distributions WHERE receipt_doc_id = ?', (doc_id,))

    return affected_doc_ids


def _redistribute_receipt_docs(cursor, doc_ids):
    """
    –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∏—Ö–æ–¥—ã –ø–æ —Ç–µ–∫—É—â–∏–º —Å—Ç—Ä–æ–∫–∞–º –ø–æ—Å—Ç–∞–≤–æ–∫.

    –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∞:
    1. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ (SKU + –∫–æ–ª-–≤–æ)
    2. –î–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞—Ö–æ–¥–∏–º –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –ø–æ—Å—Ç–∞–≤–∫–∏ —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º –æ—Å—Ç–∞—Ç–∫–æ–º
    3. –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ FIFO (—Å–Ω–∞—á–∞–ª–∞ —Ä–∞–Ω–Ω–∏–µ –ø–æ—Å—Ç–∞–≤–∫–∏)
    4. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—É—é —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å +6%
    5. –û–±–Ω–æ–≤–ª—è–µ–º warehouse_receipts.calculated_cost
    6. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤ supply_receipt_distributions
    7. –û–±–Ω–æ–≤–ª—è–µ–º arrival_warehouse_qty –≤ –ø–æ—Å—Ç–∞–≤–∫–∞—Ö

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        cursor: –∫—É—Ä—Å–æ—Ä SQLite (conn.row_factory –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å sqlite3.Row)
        doc_ids (list[int]): ID –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø—Ä–∏—Ö–æ–¥–æ–≤ –¥–ª—è –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
    """
    for doc_id in doc_ids:
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏—Ö–æ–¥–∞
        cursor.execute('''
            SELECT id, sku, receipt_date, quantity, purchase_price
            FROM warehouse_receipts WHERE doc_id = ?
        ''', (doc_id,))
        receipt_items = cursor.fetchall()

        for item in receipt_items:
            receipt_item_id = item['id']
            sku = item['sku']
            receipt_qty = item['quantity']
            receipt_date = item['receipt_date'] or ''
            manual_price = item['purchase_price'] or 0

            # –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å—Ç–∞–≤–æ–∫ –¥–ª—è —ç—Ç–æ–≥–æ SKU (—Ç–æ–ª—å–∫–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã)
            cursor.execute('''
                SELECT s.id, s.exit_factory_qty, COALESCE(s.arrival_warehouse_qty, 0) as arrival_qty,
                       s.logistics_cost_per_unit, s.price_cny,
                       COALESCE(d.cny_rate, 0) as cny_rate,
                       COALESCE(d.cny_percent, 0) as cny_percent
                FROM supplies s
                LEFT JOIN ved_container_docs d ON s.container_doc_id = d.id
                WHERE s.sku = ? AND COALESCE(d.is_completed, 0) = 1
                ORDER BY s.exit_factory_date ASC, s.id ASC
            ''', (sku,))
            supply_rows = cursor.fetchall()

            # –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∏—Ö–æ–¥ –ø–æ —Å—Ç—Ä–æ–∫–∞–º –ø–æ—Å—Ç–∞–≤–æ–∫
            remaining_qty = receipt_qty
            distributions = []

            for supply in supply_rows:
                if remaining_qty <= 0:
                    break
                available = supply['exit_factory_qty'] - supply['arrival_qty']
                if available <= 0:
                    continue

                to_distribute = min(remaining_qty, available)

                # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å +6%
                logistics = supply['logistics_cost_per_unit'] or 0
                price_cny = supply['price_cny'] or 0
                cny_rate = supply['cny_rate'] or 0
                cny_percent = supply['cny_percent'] or 0
                adjusted_rate = cny_rate * (1 + cny_percent / 100)
                price_rub = price_cny * adjusted_rate
                cost_plus_6 = (logistics + price_rub) * 1.06

                distributions.append({
                    'supply_id': supply['id'],
                    'quantity': to_distribute,
                    'cost_plus_6': cost_plus_6
                })
                remaining_qty -= to_distribute

            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—É—é —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å
            total_qty = sum(d['quantity'] for d in distributions)
            if total_qty > 0:
                weighted_cost = sum(d['quantity'] * d['cost_plus_6'] for d in distributions) / total_qty
            else:
                weighted_cost = manual_price

            # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—É—é —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏—Ö–æ–¥–∞
            cursor.execute('''
                UPDATE warehouse_receipts SET calculated_cost = ? WHERE id = ?
            ''', (weighted_cost, receipt_item_id))

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å—Ç–∞–≤–∫–∏
            for dist in distributions:
                cursor.execute('''
                    INSERT INTO supply_receipt_distributions
                    (supply_id, receipt_item_id, receipt_doc_id, quantity, cost_plus_6, receipt_date)
                    VALUES (?, ?, ?, ?, ?, ?)
                ''', (dist['supply_id'], receipt_item_id, doc_id, dist['quantity'], dist['cost_plus_6'], receipt_date))

                cursor.execute('''
                    UPDATE supplies SET arrival_warehouse_qty = COALESCE(arrival_warehouse_qty, 0) + ?,
                                        updated_at = CURRENT_TIMESTAMP
                    WHERE id = ?
                ''', (dist['quantity'], dist['supply_id']))


def _auto_distribute_on_container_completed(cursor, container_doc_id):
    """
    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥–æ–≤ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

    –ö–æ–≥–¥–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ "–∑–∞–≤–µ—Ä—à—ë–Ω", –ø–æ—è–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å—Ç–∞–≤–æ–∫
    —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏. –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –Ω–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –ø—Ä–∏—Ö–æ–¥—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å
    –Ω–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã –¥–ª—è SKU –∏–∑ —ç—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –∏ –¥–æ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏—Ö.

    –õ–æ–≥–∏–∫–∞:
    1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ SKU –∏–∑ –∑–∞–≤–µ—Ä—à–∞–µ–º–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ SKU –Ω–∞—Ö–æ–¥–∏–º –ø—Ä–∏—Ö–æ–¥—ã, –≥–¥–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –º–µ–Ω—å—à–µ, —á–µ–º –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–æ
    3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∞–∫–æ–≥–æ –ø—Ä–∏—Ö–æ–¥–∞ ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º
       (—á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—É—é —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å)

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        cursor: –∫—É—Ä—Å–æ—Ä SQLite (conn.row_factory –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å sqlite3.Row)
        container_doc_id (int): ID –∑–∞–≤–µ—Ä—à–∞–µ–º–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –í–≠–î
    """
    # –ü–æ–ª—É—á–∞–µ–º SKU –∏–∑ —ç—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    cursor.execute('''
        SELECT DISTINCT sku FROM supplies WHERE container_doc_id = ?
    ''', (container_doc_id,))
    container_skus = [row['sku'] for row in cursor.fetchall()]

    if not container_skus:
        return

    # –î–ª—è –∫–∞–∂–¥–æ–≥–æ SKU –Ω–∞—Ö–æ–¥–∏–º –ø—Ä–∏—Ö–æ–¥—ã —Å –Ω–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º–∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏
    affected_doc_ids = set()

    for sku in container_skus:
        # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏—Ö–æ–¥–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ SKU
        cursor.execute('''
            SELECT r.id as receipt_item_id, r.doc_id, r.quantity as receipt_qty,
                   COALESCE(
                       (SELECT SUM(d.quantity) FROM supply_receipt_distributions d
                        WHERE d.receipt_item_id = r.id), 0
                   ) as distributed_qty
            FROM warehouse_receipts r
            WHERE r.sku = ?
        ''', (sku,))
        for row in cursor.fetchall():
            # –ï—Å–ª–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –º–µ–Ω—å—à–µ, —á–µ–º –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–æ ‚Äî –µ—Å—Ç—å –Ω–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫
            if row['distributed_qty'] < row['receipt_qty']:
                affected_doc_ids.add(row['doc_id'])

    if not affected_doc_ids:
        return

    affected_doc_ids = list(affected_doc_ids)

    # –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ø—Ä–∏—Ö–æ–¥—ã
    # (–Ω—É–∂–µ–Ω –ø–æ–ª–Ω—ã–π –æ—Ç–∫–∞—Ç, —á—Ç–æ–±—ã –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—É—é —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å)
    for doc_id in affected_doc_ids:
        cursor.execute('''
            SELECT supply_id, quantity FROM supply_receipt_distributions
            WHERE receipt_doc_id = ?
        ''', (doc_id,))
        for dist in cursor.fetchall():
            cursor.execute('''
                UPDATE supplies SET arrival_warehouse_qty = COALESCE(arrival_warehouse_qty, 0) - ?
                WHERE id = ?
            ''', (dist['quantity'], dist['supply_id']))
        cursor.execute('DELETE FROM supply_receipt_distributions WHERE receipt_doc_id = ?', (doc_id,))

    _redistribute_receipt_docs(cursor, affected_doc_ids)


# ============================================================================
# API –í–≠–î (–ö–û–ù–¢–ï–ô–ù–ï–†–´)
# ============================================================================

@app.route('/api/ved/containers')
@require_auth(['admin', 'viewer'])
def get_ved_containers():
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –í–≠–î —Å –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        - id: ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        - container_date: –¥–∞—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        - supplier: –ø–æ—Å—Ç–∞–≤—â–∏–∫
        - comment: –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        - cny_rate: –∫—É—Ä—Å —é–∞–Ω—è
        - cny_percent: –ø—Ä–æ—Ü–µ–Ω—Ç –∫ –ø–µ—Ä–µ–≤–æ–¥—É
        - items_count: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∑–∏—Ü–∏–π (—Ç–æ–≤–∞—Ä–æ–≤)
        - total_qty: –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü
        - total_sum_cny: –æ–±—â–∞—è —Å—É–º–º–∞ –≤ —é–∞–Ω—è—Ö
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –§–∏–ª—å—Ç—Ä –ø–æ —Ç–æ–≤–∞—Ä—É (SKU): –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä
        filter_sku = request.args.get('sku', '', type=str).strip()

        query = '''
            SELECT
                d.id,
                d.container_date,
                d.supplier,
                d.comment,
                COALESCE(d.important, '') as important,
                d.cny_rate,
                d.cny_percent,
                d.created_by,
                d.updated_by,
                d.created_at,
                d.updated_at,
                COALESCE(d.is_completed, 0) as is_completed,
                COUNT(i.id) as items_count,
                COALESCE(SUM(i.quantity), 0) as total_qty,
                COALESCE(SUM(i.quantity * i.price_cny), 0) as total_sum_cny,
                COALESCE(SUM(i.logistics_rf), 0) as total_logistics_rf,
                COALESCE(SUM(i.logistics_cn), 0) as total_logistics_cn,
                COALESCE(SUM(i.terminal), 0) as total_terminal,
                COALESCE(SUM(i.customs), 0) as total_customs,
                COALESCE(SUM(i.logistics_rf + i.logistics_cn + i.terminal + i.customs), 0) as total_all_logistics
            FROM ved_container_docs d
            LEFT JOIN ved_container_items i ON i.doc_id = d.id
        '''
        params = []

        if filter_sku:
            # –ü–æ–¥–∑–∞–ø—Ä–æ—Å: —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å —Ç–æ–≤–∞—Ä —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º SKU
            query += ' WHERE d.id IN (SELECT doc_id FROM ved_container_items WHERE sku = ?)'
            params.append(int(filter_sku))

        query += '''
            GROUP BY d.id
            ORDER BY d.is_completed ASC, d.container_date DESC, d.created_at DESC
        '''

        cursor.execute(query, params)

        docs = [dict(row) for row in cursor.fetchall()]
        conn.close()

        return jsonify({'success': True, 'containers': docs})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'containers': []})


@app.route('/api/ved/containers/<int:doc_id>')
@require_auth(['admin', 'viewer'])
def get_ved_container(doc_id):
    """
    –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –í–≠–î –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —à–∞–ø–∫—É –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏.
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º —à–∞–ø–∫—É –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–≤–∫–ª—é—á–∞—è is_completed –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –∫—É—Ä—Å–∞)
        cursor.execute('''
            SELECT id, container_date, supplier, comment, COALESCE(important, '') as important,
                   cny_rate, cny_percent, created_by, updated_by, created_at, updated_at,
                   COALESCE(is_completed, 0) as is_completed
            FROM ved_container_docs WHERE id = ?
        ''', (doc_id,))
        doc = cursor.fetchone()

        if not doc:
            conn.close()
            return jsonify({'success': False, 'error': '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω'})

        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏
        cursor.execute('''
            SELECT id, sku, quantity, price_cny, logistics_rf, logistics_cn, terminal, customs
            FROM ved_container_items WHERE doc_id = ?
        ''', (doc_id,))
        items = [dict(row) for row in cursor.fetchall()]
        conn.close()

        return jsonify({
            'success': True,
            'doc': dict(doc),
            'items': items
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/ved/containers/save', methods=['POST'])
@require_auth(['admin'])
def save_ved_container():
    """
    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –í–≠–î —Å –ø–æ–∑–∏—Ü–∏—è–º–∏.

    –û–∂–∏–¥–∞–µ—Ç JSON:
    {
        "doc_id": null,  // null –¥–ª—è –Ω–æ–≤–æ–≥–æ, —á–∏—Å–ª–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        "container_date": "2026-02-08",
        "supplier": "–ü–æ—Å—Ç–∞–≤—â–∏–∫",
        "comment": "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",
        "cny_rate": 12.5,
        "cny_percent": 5,
        "items": [
            {"sku": 123, "quantity": 10, "price_cny": 100, "logistics_rf": 500, "logistics_cn": 300, "terminal": 200, "customs": 150},
            ...
        ]
    }
    """
    try:
        data = request.json
        doc_id = data.get('doc_id')  # None –¥–ª—è –Ω–æ–≤–æ–≥–æ, —á–∏—Å–ª–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        container_date = data.get('container_date', '')
        supplier = data.get('supplier', '')
        comment = data.get('comment', '')
        important = data.get('important', '')
        cny_rate = data.get('cny_rate', 0)
        cny_percent = data.get('cny_percent', 0)
        items = data.get('items', [])

        if not container_date:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞'})

        if not cny_percent or float(cny_percent) <= 0:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ –ø—Ä–æ—Ü–µ–Ω—Ç –∫ –ø–µ—Ä–µ–≤–æ–¥—É –ø–æ —é–∞–Ω—è–º (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ 0)'})

        if not items:
            return jsonify({'success': False, 'error': '–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä'})

        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (display_name –∏–ª–∏ username)
        user_id = request.current_user.get('user_id') if hasattr(request, 'current_user') else None
        username = get_user_display_name(user_id)

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # ID –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –ø—Ä–∏—Ö–æ–¥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞–≤–æ–∫
        affected_receipt_doc_ids = []

        if doc_id:
            # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
            cursor.execute('''
                UPDATE ved_container_docs
                SET container_date = ?, supplier = ?, comment = ?, important = ?, cny_rate = ?, cny_percent = ?,
                    updated_by = ?, updated_at = CURRENT_TIMESTAMP
                WHERE id = ?
            ''', (container_date, supplier, comment, important, cny_rate, cny_percent, username, doc_id))

            # –ü–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –ø–æ—Å—Ç–∞–≤–æ–∫ ‚Äî –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥–æ–≤,
            # –∫–æ—Ç–æ—Ä—ã–µ —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ —ç—Ç–∏ –ø–æ—Å—Ç–∞–≤–∫–∏ (–∏–Ω–∞—á–µ arrival_warehouse_qty –ø–æ—Ç–µ—Ä—è–µ—Ç—Å—è)
            cursor.execute('SELECT id FROM supplies WHERE container_doc_id = ?', (doc_id,))
            old_supply_ids = [row['id'] for row in cursor.fetchall()]
            affected_receipt_doc_ids = _rollback_receipt_distributions_for_supplies(cursor, old_supply_ids)

            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ supplies
            cursor.execute('DELETE FROM ved_container_items WHERE doc_id = ?', (doc_id,))
            cursor.execute('DELETE FROM supplies WHERE container_doc_id = ?', (doc_id,))
        else:
            # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç (—à–∞–ø–∫—É)
            cursor.execute('''
                INSERT INTO ved_container_docs (container_date, supplier, comment, important, cny_rate, cny_percent, created_by, updated_by, updated_at)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
            ''', (container_date, supplier, comment, important, cny_rate, cny_percent, username, username))
            doc_id = cursor.lastrowid

        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∏ —Å—á–∏—Ç–∞–µ–º —Å—É–º–º—ã –ª–æ–≥–∏—Å—Ç–∏–∫–∏
        total_logistics_rf = 0
        total_logistics_cn = 0
        total_terminal = 0
        total_customs = 0

        for item in items:
            logistics_rf = item.get('logistics_rf', 0) or 0
            logistics_cn = item.get('logistics_cn', 0) or 0
            terminal = item.get('terminal', 0) or 0
            customs = item.get('customs', 0) or 0

            total_logistics_rf += logistics_rf
            total_logistics_cn += logistics_cn
            total_terminal += terminal
            total_customs += customs

            sku = item.get('sku', 0)
            quantity = item.get('quantity', 0)
            price_cny = item.get('price_cny', 0)

            cursor.execute('''
                INSERT INTO ved_container_items (doc_id, sku, quantity, price_cny, logistics_rf, logistics_cn, terminal, customs, updated_at)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
            ''', (
                doc_id,
                sku,
                quantity,
                price_cny,
                logistics_rf,
                logistics_cn,
                terminal,
                customs
            ))
            item_id = cursor.lastrowid

            # –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º —Å—É–º–º—ã –∏–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π (finance_container_distributions)
            # –ü—Ä–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–π ‚Äî —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω—ã –ø–æ sku, –∞ –Ω–µ –ø–æ item_id
            cursor.execute('''
                SELECT cost_type, SUM(amount) as total
                FROM finance_container_distributions
                WHERE container_doc_id = ? AND sku = ?
                GROUP BY cost_type
            ''', (doc_id, str(sku)))
            for fd_row in cursor.fetchall():
                fd_cost_type = fd_row['cost_type']
                fd_amount = fd_row['total'] or 0
                if fd_cost_type in ('logistics_rf', 'logistics_cn', 'terminal', 'customs') and fd_amount > 0:
                    cursor.execute(f'''
                        UPDATE ved_container_items
                        SET {fd_cost_type} = COALESCE({fd_cost_type}, 0) + ?
                        WHERE id = ?
                    ''', (fd_amount, item_id))
                    # –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–¥—Å—á—ë—Ç–∞ –ª–æ–≥–∏—Å—Ç–∏–∫–∏
                    if fd_cost_type == 'logistics_rf':
                        logistics_rf += fd_amount
                    elif fd_cost_type == 'logistics_cn':
                        logistics_cn += fd_amount
                    elif fd_cost_type == 'terminal':
                        terminal += fd_amount
                    elif fd_cost_type == 'customs':
                        customs += fd_amount

            # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏ —Å —É—á—ë—Ç–æ–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π
            total_logistics_rf += logistics_rf - (item.get('logistics_rf', 0) or 0)
            total_logistics_cn += logistics_cn - (item.get('logistics_cn', 0) or 0)
            total_terminal += terminal - (item.get('terminal', 0) or 0)
            total_customs += customs - (item.get('customs', 0) or 0)

            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ª–æ–≥–∏—Å—Ç–∏–∫—É –∑–∞ –µ–¥–∏–Ω–∏—Ü—É –¥–ª—è –¥–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
            total_item_logistics = logistics_rf + logistics_cn + terminal + customs
            logistics_per_unit = total_item_logistics / quantity if quantity > 0 else 0

            # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å –≤ supplies –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            cursor.execute('''
                INSERT INTO supplies (sku, exit_factory_date, exit_factory_qty, logistics_cost_per_unit, price_cny,
                                      container_doc_id, container_item_id, created_at, updated_at)
                VALUES (?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
            ''', (sku, container_date, quantity, logistics_per_unit, price_cny, doc_id, item_id))

        # –í—Å—è –ª–æ–≥–∏—Å—Ç–∏–∫–∞ = —Å—É–º–º–∞ –≤—Å–µ—Ö –ø–æ–ª–µ–π –ª–æ–≥–∏—Å—Ç–∏–∫–∏
        total_all_logistics = total_logistics_rf + total_logistics_cn + total_terminal + total_customs

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å–ª–∏ –ª—é–±–æ–µ –∏–∑ –ø–æ–ª–µ–π –ª–æ–≥–∏—Å—Ç–∏–∫–∏ —Å—Ç–∞–ª–æ –Ω—É–ª—ë–º ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–º–∞–µ–º —Å—Ç–∞—Ç—É—Å "–ó–∞–≤–µ—Ä—à–µ–Ω–æ"
        has_zeros = (total_logistics_rf == 0 or total_logistics_cn == 0 or
                     total_terminal == 0 or total_customs == 0 or total_all_logistics == 0)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å–ª–∏ –ø–æ–ª–µ "–í–∞–∂–Ω–æ" –∑–∞–ø–æ–ª–Ω–µ–Ω–æ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–º–∞–µ–º —Å—Ç–∞—Ç—É—Å "–ó–∞–≤–µ—Ä—à–µ–Ω–æ"
        has_important = important and important.strip() != ''

        if has_zeros or has_important:
            cursor.execute('''
                UPDATE ved_container_docs SET is_completed = 0 WHERE id = ?
            ''', (doc_id,))

        # –ü–æ—Å–ª–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞–≤–æ–∫ ‚Äî –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ø—Ä–∏—Ö–æ–¥—ã
        if affected_receipt_doc_ids:
            _redistribute_receipt_docs(cursor, affected_receipt_doc_ids)

        # –ü–µ—Ä–µ—Å—á—ë—Ç FIFO-—Ü–µ–Ω –ø–æ –≤—Å–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º —Å —Ç–µ–º–∏ –∂–µ SKU
        affected_skus = list(set(item.get('sku', 0) for item in items if item.get('sku')))
        if affected_skus:
            _recalculate_fifo_prices_for_skus(cursor, affected_skus)

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'doc_id': doc_id})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


def _resolve_sku_to_offer_id(cursor, sku):
    """
    –ú–∞–ø–ø–∏–Ω–≥ SKU ‚Üí offer_id –¥–ª—è —Å–≤—è–∑–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å –ø–ª–∞–Ω–æ–º.

    –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Ö—Ä–∞–Ω—è—Ç sku (—á–∏—Å–ª–æ), –ø–ª–∞–Ω ‚Äî product_name (offer_id —Å—Ç—Ä–æ–∫–∞).
    –ò—â–µ–º offer_id –≤ products_history (–ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–Ω–∏–º–æ–∫), —Ñ–æ–ª–ª–±—ç–∫ ‚Äî products.
    """
    cursor.execute('''
        SELECT COALESCE(ph.offer_id, p.offer_id) AS offer_id
        FROM products_history ph
        JOIN (
            SELECT sku, MAX(snapshot_date) AS max_date
            FROM products_history WHERE sku = ?
        ) last ON last.sku = ph.sku AND last.max_date = ph.snapshot_date
        LEFT JOIN products p ON p.sku = ph.sku
        WHERE ph.sku = ?
    ''', (sku, sku))
    row = cursor.fetchone()
    return row['offer_id'] if row and row['offer_id'] else None


def _get_consumed_qty_for_sku(cursor, sku, exclude_doc_id=None):
    """
    –°—É–º–º–∞—Ä–Ω–æ–µ –∫–æ–ª-–≤–æ —Ç–æ–≤–∞—Ä–∞ (SKU) –≤–æ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö –í–≠–î.

    –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ exclude_doc_id –∏—Å–∫–ª—é—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç
    –∏–∑ –ø–æ–¥—Å—á—ë—Ç–∞, —á—Ç–æ–±—ã –Ω–µ —Å—á–∏—Ç–∞—Ç—å —Å–≤–æ–∏ –∂–µ –ø–æ–∑–∏—Ü–∏–∏ –∫–∞–∫ ¬´—É–∂–µ –ø–æ—Ç—Ä–µ–±–ª—ë–Ω–Ω—ã–µ¬ª.
    """
    if exclude_doc_id:
        cursor.execute('''
            SELECT COALESCE(SUM(quantity), 0) as total
            FROM ved_container_items WHERE sku = ? AND doc_id != ?
        ''', (sku, exclude_doc_id))
    else:
        cursor.execute('''
            SELECT COALESCE(SUM(quantity), 0) as total
            FROM ved_container_items WHERE sku = ?
        ''', (sku,))
    return cursor.fetchone()['total']


def _recalculate_fifo_prices_for_skus(cursor, skus):
    """
    –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å FIFO-—Ü–µ–Ω—ã –ø–æ –≤—Å–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º –¥–ª—è —Å–ø–∏—Å–∫–∞ SKU.

    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —á—Ç–æ–±—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
    –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ –æ–¥–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏
    –≤–æ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö —Å —Ç–µ–º –∂–µ —Ç–æ–≤–∞—Ä–æ–º.

    –ü–æ—Ä—è–¥–æ–∫ FIFO: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ –¥–∞—Ç–µ (container_date ASC),
    –∑–∞—Ç–µ–º –ø–æ id (ASC). –ö–∞–∂–¥—ã–π –ø–æ—Å–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç —Ü–µ–Ω—É –∏–∑
    —Å–ª–µ–¥—É—é—â–∏—Ö —Å–ª–æ—ë–≤ –ø–ª–∞–Ω–∞ –ø–æ—Å–ª–µ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö.
    """
    for sku in skus:
        offer_id = _resolve_sku_to_offer_id(cursor, sku)
        if not offer_id:
            continue

        # –°–ª–æ–∏ –ø–ª–∞–Ω–∞: –∫–æ–ª-–≤–æ –∏ —Ü–µ–Ω–∞ (invoice + delta) –ø–æ –¥–∞—Ç–µ –≤—ã—Ö–æ–¥–∞ ASC
        cursor.execute('''
            SELECT planned_qty as qty, total_yuan as cost, planned_release_date as date
            FROM plan_items
            WHERE product_name = ? AND planned_qty > 0 AND total_yuan > 0
            ORDER BY planned_release_date ASC
        ''', (offer_id,))
        layers = [dict(row) for row in cursor.fetchall()]

        if not layers:
            continue

        # –í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å —ç—Ç–∏–º SKU, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –¥–∞—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        cursor.execute('''
            SELECT ci.id as item_id, ci.quantity
            FROM ved_container_items ci
            JOIN ved_container_docs d ON d.id = ci.doc_id
            WHERE ci.sku = ?
            ORDER BY d.container_date ASC, ci.id ASC
        ''', (sku,))
        items = [dict(row) for row in cursor.fetchall()]

        if not items:
            continue

        # FIFO: –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –Ω–∞–∑–Ω–∞—á–∞–µ–º —Ü–µ–Ω—É –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
        consumed = 0
        for item in items:
            qty = item['quantity']
            total_cost, avg_cost, details = _fifo_cogs(layers, consumed, qty)
            consumed += qty

            # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ FIFO –¥–∞–ª –Ω–µ–Ω—É–ª–µ–≤—É—é —Ü–µ–Ω—É
            if avg_cost > 0:
                new_price = round(avg_cost, 2)
                cursor.execute('''
                    UPDATE ved_container_items SET price_cny = ? WHERE id = ?
                ''', (new_price, item['item_id']))
                # –û–±–Ω–æ–≤–ª—è–µ–º supplies.price_cny —Ç–æ–∂–µ (–∞–≤—Ç–æ-—Å–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
                cursor.execute('''
                    UPDATE supplies SET price_cny = ? WHERE container_item_id = ?
                ''', (new_price, item['item_id']))


@app.route('/api/ved/containers/fifo-cost', methods=['POST'])
@require_auth(['admin', 'viewer'])
def get_ved_fifo_plan_cost():
    """
    –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ —à—Ç—É–∫—É –ø–æ FIFO –∏–∑ –ø–ª–∞–Ω–∞ –∑–∞–∫—É–ø–æ–∫.

    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç JSON:
        sku (int): SKU —Ç–æ–≤–∞—Ä–∞
        quantity (int): –∫–æ–ª-–≤–æ –≤ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        skip_extra (int): –¥–æ–ø. –∫–æ–ª-–≤–æ –∏–∑ –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–æ–∫ —Ñ–æ—Ä–º—ã —Å —Ç–µ–º –∂–µ SKU
        exclude_doc_id (int|null): ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        price_cny (float): —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞ –∑–∞ —à—Ç—É–∫—É (¬•)
        details (list): FIFO-—Ä–∞–∑–±–∏–≤–∫–∞ –ø–æ —Å–ª–æ—è–º –ø–ª–∞–Ω–∞
        uncovered_qty (int): –∫–æ–ª-–≤–æ –µ–¥–∏–Ω–∏—Ü, –Ω–µ –ø–æ–∫—Ä—ã—Ç—ã—Ö –ø–ª–∞–Ω–æ–º
    """
    try:
        data = request.json
        sku = data.get('sku', 0)
        quantity = data.get('quantity', 0)
        skip_extra = data.get('skip_extra', 0)
        exclude_doc_id = data.get('exclude_doc_id')

        if not sku or quantity <= 0:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ SKU –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ'})

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # SKU ‚Üí offer_id –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ —Å plan_items.product_name
        offer_id = _resolve_sku_to_offer_id(cursor, sku)
        if not offer_id:
            conn.close()
            return jsonify({'success': True, 'price_cny': 0, 'details': [], 'uncovered_qty': quantity})

        # –°–ª–æ–∏ –ø–ª–∞–Ω–∞: –∫–æ–ª-–≤–æ –∏ —Ü–µ–Ω–∞ (invoice + delta) –ø–æ –¥–∞—Ç–µ –≤—ã—Ö–æ–¥–∞ ASC
        cursor.execute('''
            SELECT planned_qty as qty, total_yuan as cost, planned_release_date as date
            FROM plan_items
            WHERE product_name = ? AND planned_qty > 0 AND total_yuan > 0
            ORDER BY planned_release_date ASC
        ''', (offer_id,))
        layers = [dict(row) for row in cursor.fetchall()]

        # –£–∂–µ –ø–æ—Ç—Ä–µ–±–ª—ë–Ω–Ω–æ–µ –∫–æ–ª-–≤–æ –∏–∑ –¥—Ä—É–≥–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ + –¥–æ–ø. —Å—Ç—Ä–æ–∫–∏ —Ñ–æ—Ä–º—ã
        skip_qty = _get_consumed_qty_for_sku(cursor, sku, exclude_doc_id) + skip_extra

        conn.close()

        if not layers:
            return jsonify({'success': True, 'price_cny': 0, 'details': [], 'uncovered_qty': quantity})

        # FIFO-—Ä–∞—Å—á—ë—Ç (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω _fifo_cogs)
        total_cost, avg_cost, details = _fifo_cogs(layers, skip_qty, quantity)

        # –ù–µ–ø–æ–∫—Ä—ã—Ç–æ–µ –∫–æ–ª-–≤–æ = –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–µ - —Ä–µ–∞–ª—å–Ω–æ –ø–æ—Ç—Ä–µ–±–ª—ë–Ω–Ω–æ–µ –∏–∑ —Å–ª–æ—ë–≤
        covered_qty = sum(d['qty'] for d in details)
        uncovered_qty = quantity - covered_qty

        return jsonify({
            'success': True,
            'price_cny': round(avg_cost, 2),
            'details': details,
            'uncovered_qty': uncovered_qty
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/ved/containers/delete', methods=['POST'])
@require_auth(['admin'])
def delete_ved_container():
    """
    –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –í–≠–î –≤–º–µ—Å—Ç–µ —Å–æ –≤—Å–µ–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏.
    """
    try:
        data = request.json
        doc_id = data.get('id')

        if not doc_id:
            return jsonify({'success': False, 'error': '–ù–µ —É–∫–∞–∑–∞–Ω ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞'})

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å—Ç—å –ª–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞ —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        cursor.execute('SELECT COUNT(*) as cnt FROM finance_container_distributions WHERE container_doc_id = ?', (doc_id,))
        fcd_count = cursor.fetchone()['cnt']
        if fcd_count > 0:
            conn.close()
            return jsonify({
                'success': False,
                'error': f'–ö —ç—Ç–æ–º—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –ø—Ä–∏–≤—è–∑–∞–Ω—ã {fcd_count} —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π. '
                         '–°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª–∏—Ç–µ –∏–ª–∏ –æ—Ç–≤—è–∂–∏—Ç–µ —Ä–∞—Å—Ö–æ–¥—ã –≤ –§–∏–Ω–∞–Ω—Å–∞—Ö.'
            }), 400

        # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º SKU –¥–æ —É–¥–∞–ª–µ–Ω–∏—è ‚Äî –¥–ª—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞ FIFO –≤ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö
        cursor.execute('SELECT DISTINCT sku FROM ved_container_items WHERE doc_id = ?', (doc_id,))
        affected_skus = [row['sku'] for row in cursor.fetchall()]

        # –ü–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –ø–æ—Å—Ç–∞–≤–æ–∫ ‚Äî –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥–æ–≤
        cursor.execute('SELECT id FROM supplies WHERE container_doc_id = ?', (doc_id,))
        old_supply_ids = [row['id'] for row in cursor.fetchall()]
        affected_receipt_doc_ids = _rollback_receipt_distributions_for_supplies(cursor, old_supply_ids)

        # –£–¥–∞–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ supplies
        cursor.execute('DELETE FROM supplies WHERE container_doc_id = ?', (doc_id,))

        # –£–¥–∞–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏
        cursor.execute('DELETE FROM ved_container_items WHERE doc_id = ?', (doc_id,))

        # –£–¥–∞–ª—è–µ–º —à–∞–ø–∫—É
        cursor.execute('DELETE FROM ved_container_docs WHERE id = ?', (doc_id,))

        # –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ø—Ä–∏—Ö–æ–¥—ã –ø–æ –æ—Å—Ç–∞–≤—à–∏–º—Å—è –ø–æ—Å—Ç–∞–≤–∫–∞–º
        if affected_receipt_doc_ids:
            _redistribute_receipt_docs(cursor, affected_receipt_doc_ids)

        # –ü–µ—Ä–µ—Å—á—ë—Ç FIFO-—Ü–µ–Ω –≤ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö —Å —Ç–µ–º–∏ –∂–µ SKU
        if affected_skus:
            _recalculate_fifo_prices_for_skus(cursor, affected_skus)

        conn.commit()
        conn.close()

        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/ved/containers/toggle-completed', methods=['POST'])
@require_auth(['admin'])
def toggle_ved_container_completed():
    """
    –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –í–≠–î.
    –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–π –∫—É—Ä—Å —é–∞–Ω—è –¶–ë –†–§.
    –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
    """
    try:
        data = request.json
        doc_id = data.get('id')
        is_completed = data.get('is_completed', 0)

        if not doc_id:
            return jsonify({'success': False, 'error': '–ù–µ —É–∫–∞–∑–∞–Ω ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞'})

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        if is_completed:
            # –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–π –∫—É—Ä—Å —é–∞–Ω—è
            current_rates = fetch_cbr_rates()
            current_cny_rate = current_rates.get('CNY', 0)
            cursor.execute('''
                UPDATE ved_container_docs
                SET is_completed = 1, cny_rate = ?, updated_at = CURRENT_TIMESTAMP
                WHERE id = ?
            ''', (current_cny_rate, doc_id))

            # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∏—Ö–æ–¥—ã —Å –Ω–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º–∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏
            # –¥–ª—è SKU –∏–∑ —ç—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            _auto_distribute_on_container_completed(cursor, doc_id)
        else:
            # –ü—Ä–∏ —Å–Ω—è—Ç–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è ‚Äî –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª—è –ø–æ—Å—Ç–∞–≤–æ–∫ —ç—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞,
            # —Ç.–∫. –æ–Ω–∏ –±–æ–ª—å—à–µ –Ω–µ —Å—á–∏—Ç–∞—é—Ç—Å—è "–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–º–∏"
            cursor.execute('SELECT id FROM supplies WHERE container_doc_id = ?', (doc_id,))
            supply_ids = [row['id'] for row in cursor.fetchall()]
            affected_doc_ids = _rollback_receipt_distributions_for_supplies(cursor, supply_ids)

            cursor.execute('''
                UPDATE ved_container_docs
                SET is_completed = 0, updated_at = CURRENT_TIMESTAMP
                WHERE id = ?
            ''', (doc_id,))

            # –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ø—Ä–∏—Ö–æ–¥—ã (—É–∂–µ –±–µ–∑ –ø–æ—Å—Ç–∞–≤–æ–∫ —ç—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
            if affected_doc_ids:
                _redistribute_receipt_docs(cursor, affected_doc_ids)

        conn.commit()
        conn.close()

        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


# ============================================================================
# API: –§–ê–ô–õ–´ –ö–û–ù–¢–ï–ô–ù–ï–†–û–í –í–≠–î
# ============================================================================

def allowed_file(filename):
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –ª–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞."""
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS


@app.route('/api/ved/containers/<int:doc_id>/files', methods=['GET'])
@require_auth(['admin', 'viewer'])
def get_ved_container_files(doc_id):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞."""
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute("""
            SELECT id, filename, file_type, file_size, uploaded_by, uploaded_at, display_name
            FROM ved_container_files
            WHERE doc_id = ?
            ORDER BY uploaded_at DESC
        """, (doc_id,))

        files = [dict(row) for row in cursor.fetchall()]
        conn.close()

        return jsonify({'success': True, 'files': files})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'files': []})


@app.route('/api/ved/containers/<int:doc_id>/files', methods=['POST'])
@require_auth(['admin'])
def upload_ved_container_file(doc_id):
    """–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É."""
    try:
        if 'file' not in request.files:
            return jsonify({'success': False, 'error': '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω'})

        file = request.files['file']

        if file.filename == '':
            return jsonify({'success': False, 'error': '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω'})

        if not allowed_file(file.filename):
            return jsonify({'success': False, 'error': '–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞'})

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
        file.seek(0, 2)  # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞
        file_size = file.tell()
        file.seek(0)  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –Ω–∞—á–∞–ª–æ

        if file_size > MAX_FILE_SIZE:
            return jsonify({'success': False, 'error': f'–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å–∏–º—É–º {MAX_FILE_SIZE // 1024 // 1024} –ú–ë)'})

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
        original_filename = secure_filename(file.filename)
        ext = original_filename.rsplit('.', 1)[1].lower() if '.' in original_filename else ''
        stored_filename = f"{uuid.uuid4().hex}.{ext}" if ext else uuid.uuid4().hex

        # –°–æ–∑–¥–∞—ë–º –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        container_folder = os.path.join(UPLOAD_FOLDER, str(doc_id))
        os.makedirs(container_folder, exist_ok=True)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
        file_path = os.path.join(container_folder, stored_filename)
        file.save(file_path)

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME —Ç–∏–ø
        mime_types = {
            'pdf': 'application/pdf',
            'png': 'image/png',
            'jpg': 'image/jpeg',
            'jpeg': 'image/jpeg',
            'gif': 'image/gif',
            'doc': 'application/msword',
            'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'xls': 'application/vnd.ms-excel',
            'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            'txt': 'text/plain',
            'zip': 'application/zip',
            'rar': 'application/x-rar-compressed'
        }
        file_type = mime_types.get(ext, 'application/octet-stream')

        # –ü–æ–ª—É—á–∞–µ–º username
        username = request.current_user.get('username', '') if hasattr(request, 'current_user') else ''

        # –ü–æ–ª—É—á–∞–µ–º display_name –∏–∑ —Ñ–æ—Ä–º—ã (–æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞)
        display_name = request.form.get('display_name', '')

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        cursor.execute("""
            INSERT INTO ved_container_files (doc_id, filename, stored_filename, file_type, file_size, uploaded_by, display_name)
            VALUES (?, ?, ?, ?, ?, ?, ?)
        """, (doc_id, file.filename, stored_filename, file_type, file_size, username, display_name))

        file_id = cursor.lastrowid
        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'file': {
                'id': file_id,
                'filename': file.filename,
                'file_type': file_type,
                'file_size': file_size,
                'uploaded_by': username,
                'display_name': display_name
            }
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/ved/containers/files/<int:file_id>')
@require_auth(['admin', 'viewer'])
def download_ved_container_file(file_id):
    """–°–∫–∞—á–∞—Ç—å –∏–ª–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–∞–π–ª."""
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute("""
            SELECT doc_id, filename, stored_filename, file_type
            FROM ved_container_files WHERE id = ?
        """, (file_id,))

        file_info = cursor.fetchone()
        conn.close()

        if not file_info:
            return jsonify({'success': False, 'error': '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404

        file_path = os.path.join(UPLOAD_FOLDER, str(file_info['doc_id']), file_info['stored_filename'])

        if not os.path.exists(file_path):
            return jsonify({'success': False, 'error': '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ –¥–∏—Å–∫–µ'}), 404

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å inline –∏–ª–∏ —Å–∫–∞—á–∏–≤–∞—Ç—å
        view_inline = request.args.get('view', '0') == '1'

        if view_inline and file_info['file_type'].startswith(('image/', 'application/pdf')):
            return send_file(file_path, mimetype=file_info['file_type'])
        else:
            return send_file(file_path, as_attachment=True, download_name=file_info['filename'])
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/ved/containers/files/<int:file_id>', methods=['DELETE'])
@require_auth(['admin'])
def delete_ved_container_file(file_id):
    """–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª."""
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
        cursor.execute("""
            SELECT doc_id, stored_filename FROM ved_container_files WHERE id = ?
        """, (file_id,))

        file_info = cursor.fetchone()

        if not file_info:
            conn.close()
            return jsonify({'success': False, 'error': '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω'})

        # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª —Å –¥–∏—Å–∫–∞
        file_path = os.path.join(UPLOAD_FOLDER, str(file_info['doc_id']), file_info['stored_filename'])
        if os.path.exists(file_path):
            os.remove(file_path)

        # –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –∏–∑ –ë–î
        cursor.execute('DELETE FROM ved_container_files WHERE id = ?', (file_id,))
        conn.commit()
        conn.close()

        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/ved/containers/files/<int:file_id>/rename', methods=['PUT'])
@require_auth(['admin'])
def rename_ved_container_file(file_id):
    """
    –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –í–≠–î.

    –ü–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ (display_name) –∏/–∏–ª–∏
    –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ (filename). –§–∏–∑–∏—á–µ—Å–∫–∏–π —Ñ–∞–π–ª –Ω–∞ –¥–∏—Å–∫–µ
    –Ω–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ—Ç—Å—è ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è stored_filename (UUID).

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã (JSON body):
        display_name (str, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): –ù–æ–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è
        filename (str, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): –ù–æ–≤–æ–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        JSON —Å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞
    """
    try:
        data = request.get_json()
        if not data:
            return jsonify({'success': False, 'error': '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'})

        new_display_name = data.get('display_name', '').strip()
        new_filename = data.get('filename', '').strip()

        if not new_display_name and not new_filename:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è'})

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
        cursor.execute('SELECT * FROM ved_container_files WHERE id = ?', (file_id,))
        file_info = cursor.fetchone()

        if not file_info:
            conn.close()
            return jsonify({'success': False, 'error': '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω'})

        # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, —á—Ç–æ –ø–µ—Ä–µ–¥–∞–Ω–æ
        if new_display_name:
            cursor.execute(
                'UPDATE ved_container_files SET display_name = ? WHERE id = ?',
                (new_display_name, file_id)
            )
        if new_filename:
            cursor.execute(
                'UPDATE ved_container_files SET filename = ? WHERE id = ?',
                (new_filename, file_id)
            )

        conn.commit()

        # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        cursor.execute('SELECT * FROM ved_container_files WHERE id = ?', (file_id,))
        updated = cursor.fetchone()
        conn.close()

        return jsonify({
            'success': True,
            'file': {
                'id': updated['id'],
                'filename': updated['filename'],
                'display_name': updated['display_name'],
                'file_type': updated['file_type'],
                'file_size': updated['file_size']
            }
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/ved/receipts')
@require_auth(['admin', 'viewer'])
def get_ved_receipts():
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –í–≠–î.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Å—Ç—Ä–æ—á–Ω–æ —Ç–æ–≤–∞—Ä—ã —Å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å—é –∏ –ª–æ–≥–∏—Å—Ç–∏–∫–æ–π.
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('''
            SELECT
                d.id as container_id,
                d.container_date,
                d.supplier,
                d.cny_rate,
                d.cny_percent,
                i.sku,
                p.name as product_name,
                p.offer_id as article,
                i.quantity,
                i.price_cny,
                i.logistics_rf,
                i.logistics_cn,
                i.terminal,
                i.customs
            FROM ved_container_docs d
            INNER JOIN ved_container_items i ON i.doc_id = d.id
            LEFT JOIN products p ON p.sku = i.sku
            WHERE d.is_completed = 1
            ORDER BY d.container_date DESC, d.id, i.id
        ''')

        items = []
        for row in cursor.fetchall():
            row_dict = dict(row)
            # –†–∞—Å—á—ë—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤ —Ä—É–±–ª—è—Ö
            cny_rate = row_dict['cny_rate'] or 0
            cny_percent = row_dict['cny_percent'] or 0
            adjusted_rate = cny_rate * (1 + cny_percent / 100)
            price_cny = row_dict['price_cny'] or 0
            quantity = row_dict['quantity'] or 0

            # –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å = —Ü–µ–Ω–∞ * –∫—É—Ä—Å * –∫–æ–ª-–≤–æ
            cost_rub = price_cny * adjusted_rate * quantity

            # –í—Å—è –ª–æ–≥–∏—Å—Ç–∏–∫–∞
            logistics_rf = row_dict['logistics_rf'] or 0
            logistics_cn = row_dict['logistics_cn'] or 0
            terminal = row_dict['terminal'] or 0
            customs = row_dict['customs'] or 0
            all_logistics = logistics_rf + logistics_cn + terminal + customs

            row_dict['cost_rub'] = cost_rub
            row_dict['all_logistics'] = all_logistics
            row_dict['total_cost'] = cost_rub + all_logistics

            items.append(row_dict)

        conn.close()

        return jsonify({'success': True, 'items': items})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'items': []})


@app.route('/api/ved/product-logistics')
@require_auth(['admin', 'viewer'])
def get_ved_product_logistics():
    """
    –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ª–æ–≥–∏—Å—Ç–∏–∫–µ –∏ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –í–≠–î.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ SKU —Å–ø–∏—Å–æ–∫ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π (items) –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ
    —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ —Å—Ç—Ä–æ–∫–∞–º –ø–æ—Å—Ç–∞–≤–æ–∫.

    –ö–∞–∂–¥–∞—è –ø–æ–∑–∏—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç:
    - quantity: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞
    - logistics_per_unit: –ª–æ–≥–∏—Å—Ç–∏–∫–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É
    - cost_per_unit_rub: —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É –≤ —Ä—É–±–ª—è—Ö

    –¢–∞–∫–∂–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏):
    - total_quantity: –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
    - avg_logistics_per_unit: —Å—Ä–µ–¥–Ω—è—è –ª–æ–≥–∏—Å—Ç–∏–∫–∞
    - avg_cost_per_unit_rub: —Å—Ä–µ–¥–Ω—è—è —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏ —Å –∫—É—Ä—Å–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        cursor.execute('''
            SELECT
                i.sku,
                i.quantity,
                i.price_cny,
                COALESCE(i.logistics_rf, 0) + COALESCE(i.logistics_cn, 0) +
                COALESCE(i.terminal, 0) + COALESCE(i.customs, 0) as all_logistics,
                d.cny_rate,
                d.cny_percent
            FROM ved_container_items i
            INNER JOIN ved_container_docs d ON d.id = i.doc_id
            WHERE d.is_completed = 1 AND i.quantity > 0
            ORDER BY i.sku, d.created_at
        ''')

        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ SKU, —Å–æ—Ö—Ä–∞–Ω—è—è –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
        sku_data = {}
        for row in cursor.fetchall():
            sku = str(row['sku'])
            qty = row['quantity'] or 0
            price_cny = row['price_cny'] or 0
            all_logistics = row['all_logistics'] or 0
            cny_rate = row['cny_rate'] or 0
            cny_percent = row['cny_percent'] or 0

            # –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫—É—Ä—Å —Å —É—á—ë—Ç–æ–º –ø—Ä–æ—Ü–µ–Ω—Ç–∞
            adjusted_rate = cny_rate * (1 + cny_percent / 100)
            # –õ–æ–≥–∏—Å—Ç–∏–∫–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É
            logistics_per_unit = all_logistics / qty if qty > 0 else 0
            # –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ —Ä—É–±–ª—è—Ö –∑–∞ –µ–¥–∏–Ω–∏—Ü—É
            cost_per_unit_rub = price_cny * adjusted_rate

            if sku not in sku_data:
                sku_data[sku] = {
                    'items': [],
                    'total_qty': 0,
                    'total_logistics': 0,
                    'total_cost_rub': 0
                }

            # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
            sku_data[sku]['items'].append({
                'quantity': qty,
                'logistics_per_unit': round(logistics_per_unit, 2),
                'cost_per_unit_rub': round(cost_per_unit_rub, 2)
            })

            # –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            sku_data[sku]['total_qty'] += qty
            sku_data[sku]['total_logistics'] += all_logistics
            sku_data[sku]['total_cost_rub'] += cost_per_unit_rub * qty

        conn.close()

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        result = {}
        for sku, data in sku_data.items():
            total_qty = data['total_qty']
            if total_qty > 0:
                result[sku] = {
                    # –°–ø–∏—Å–æ–∫ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
                    'items': data['items'],
                    # –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
                    'total_quantity': total_qty,
                    'avg_logistics_per_unit': round(data['total_logistics'] / total_qty, 2),
                    'avg_cost_per_unit_rub': round(data['total_cost_rub'] / total_qty, 2)
                }

        return jsonify({'success': True, 'logistics': result})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'logistics': {}})


@app.route('/api/ved/suppliers')
@require_auth(['admin', 'viewer'])
def get_ved_suppliers():
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –í–≠–î.
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute('SELECT id, name FROM ved_suppliers ORDER BY name')
        rows = cursor.fetchall()
        conn.close()
        suppliers = [{'id': r[0], 'name': r[1]} for r in rows]
        return jsonify({'success': True, 'suppliers': suppliers})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'suppliers': []})


@app.route('/api/ved/suppliers/add', methods=['POST'])
@require_auth(['admin'])
def add_ved_supplier():
    """
    –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –í–≠–î –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫.
    """
    try:
        data = request.get_json()
        name = (data.get('name') or '').strip()

        if not name:
            return jsonify({'success': False, 'error': '–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'})

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –ø–æ—Å—Ç–∞–≤—â–∏–∫
        cursor.execute('SELECT id FROM ved_suppliers WHERE name = ?', (name,))
        existing = cursor.fetchone()
        if existing:
            conn.close()
            return jsonify({'success': True, 'message': '–ü–æ—Å—Ç–∞–≤—â–∏–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'id': existing[0]})

        cursor.execute('INSERT INTO ved_suppliers (name) VALUES (?)', (name,))
        conn.commit()
        new_id = cursor.lastrowid
        conn.close()

        return jsonify({'success': True, 'id': new_id, 'message': '–ü–æ—Å—Ç–∞–≤—â–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/telegram/create-receipt', methods=['POST'])
def create_receipt_from_telegram():
    """
    –°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–∏—Ö–æ–¥–∞ –∏–∑ Telegram –±–æ—Ç–∞.
    –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ.

    –û–∂–∏–¥–∞–µ—Ç JSON:
    {
        "token": "—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_—Ç–æ–∫–µ–Ω",
        "receipt_date": "2026-02-07",
        "receiver_name": "–ò–≤–∞–Ω–æ–≤ –°–µ—Ä–≥–µ–π",
        "comment": "–ü–∞—Ä—Ç–∏—è –æ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞",
        "telegram_chat_id": 123456789,
        "telegram_username": "@username",
        "items": [
            {"sku": 123456, "quantity": 50},
            {"sku": 789012, "quantity": 100}
        ]
    }
    """
    try:
        data = request.json

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
        token = data.get('token', '')
        expected_token = os.environ.get('TELEGRAM_BOT_SECRET', '')

        if not expected_token or token != expected_token:
            return jsonify({'success': False, 'error': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω'}), 403

        receipt_date = data.get('receipt_date', '')
        receiver_name = data.get('receiver_name', '')
        comment = data.get('comment', '')
        telegram_chat_id = data.get('telegram_chat_id')
        telegram_username = data.get('telegram_username', '')
        items = data.get('items', [])

        if not receipt_date:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –ø—Ä–∏—Ö–æ–¥–∞'})

        if not items:
            return jsonify({'success': False, 'error': '–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä'})

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –°–æ–∑–¥–∞—ë–º –¥–æ–∫—É–º–µ–Ω—Ç (—à–∞–ø–∫—É)
        cursor.execute('''
            INSERT INTO warehouse_receipt_docs
            (receipt_datetime, receiver_name, comment, source, telegram_chat_id, created_by, updated_by, updated_at)
            VALUES (?, ?, ?, 'telegram', ?, ?, ?, CURRENT_TIMESTAMP)
        ''', (receipt_date, receiver_name, comment, telegram_chat_id, telegram_username, telegram_username))

        doc_id = cursor.lastrowid

        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏
        for item in items:
            cursor.execute('''
                INSERT INTO warehouse_receipts (doc_id, sku, receipt_date, quantity, purchase_price, updated_at)
                VALUES (?, ?, ?, ?, 0, CURRENT_TIMESTAMP)
            ''', (doc_id, item.get('sku', 0), receipt_date, item.get('quantity', 0)))

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'doc_id': doc_id})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/telegram/products')
def get_products_for_telegram():
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤ Telegram –±–æ—Ç–µ.
    –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö.
    """
    try:
        token = request.args.get('token', '')
        expected_token = os.environ.get('TELEGRAM_BOT_SECRET', '')

        if not expected_token or token != expected_token:
            return jsonify({'success': False, 'error': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω'}), 403

        search = request.args.get('search', '').strip()

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        if search:
            # –ü–æ–∏—Å–∫ –ø–æ SKU –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é
            cursor.execute('''
                SELECT sku, name, offer_id
                FROM products
                WHERE sku = ? OR name LIKE ? OR offer_id LIKE ?
                ORDER BY name
                LIMIT 20
            ''', (search, f'%{search}%', f'%{search}%'))
        else:
            # –¢–æ–ø-100 —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∑–∞–∫–∞–∑–∞–º (–¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –≤ –±–æ—Ç–µ)
            cursor.execute('''
                SELECT sku, name, offer_id
                FROM products
                ORDER BY orders_qty DESC
                LIMIT 100
            ''')

        products = [dict(row) for row in cursor.fetchall()]
        conn.close()

        return jsonify({'success': True, 'products': products})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'products': []})


@app.route('/api/telegram/containers')
def get_containers_for_telegram():
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –í–≠–î –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤ Telegram –±–æ—Ç–µ.
    –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:
    - id, container_date, supplier, items_count, total_qty, total_sum_cny

    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        token: TELEGRAM_BOT_SECRET
        page: –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0)
        page_size: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 6)
    """
    try:
        token = request.args.get('token', '')
        expected_token = os.environ.get('TELEGRAM_BOT_SECRET', '')

        if not expected_token or token != expected_token:
            return jsonify({'success': False, 'error': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω'}), 403

        page = request.args.get('page', 0, type=int)
        page_size = request.args.get('page_size', 6, type=int)

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü–æ–¥—Å—á—ë—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
        cursor.execute('SELECT COUNT(*) FROM ved_container_docs')
        total = cursor.fetchone()[0]

        # –ó–∞–ø—Ä–æ—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π (–ø–∞—Ç—Ç–µ—Ä–Ω –∏–∑ get_ved_containers)
        cursor.execute('''
            SELECT
                d.id,
                d.container_date,
                d.supplier,
                COALESCE(d.is_completed, 0) as is_completed,
                COUNT(i.id) as items_count,
                COALESCE(SUM(i.quantity), 0) as total_qty,
                COALESCE(SUM(i.quantity * i.price_cny), 0) as total_sum_cny
            FROM ved_container_docs d
            LEFT JOIN ved_container_items i ON i.doc_id = d.id
            GROUP BY d.id
            ORDER BY d.is_completed ASC, d.container_date DESC, d.created_at DESC
            LIMIT ? OFFSET ?
        ''', (page_size, page * page_size))

        containers = [dict(row) for row in cursor.fetchall()]
        conn.close()

        return jsonify({
            'success': True,
            'containers': containers,
            'total': total,
            'page': page,
            'page_size': page_size
        })

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ get_containers_for_telegram: {e}")
        return jsonify({'success': False, 'error': str(e), 'containers': []})


@app.route('/api/telegram/users')
def get_users_for_telegram():
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –≤ Telegram –±–æ—Ç–µ.
    –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º Telegram (—É –∫–æ–≥–æ telegram_chat_id != NULL).

    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        token: TELEGRAM_BOT_SECRET
        exclude_chat_id: –∏—Å–∫–ª—é—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —ç—Ç–∏–º chat_id (–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç —Å–µ–±—è)
    """
    try:
        token = request.args.get('token', '')
        expected_token = os.environ.get('TELEGRAM_BOT_SECRET', '')

        if not expected_token or token != expected_token:
            return jsonify({'success': False, 'error': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω'}), 403

        exclude_chat_id = request.args.get('exclude_chat_id', '')

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        if exclude_chat_id:
            cursor.execute('''
                SELECT id, username, display_name, telegram_chat_id
                FROM users
                WHERE telegram_chat_id IS NOT NULL AND telegram_chat_id != ''
                AND telegram_chat_id != ?
                ORDER BY display_name, username
            ''', (str(exclude_chat_id),))
        else:
            cursor.execute('''
                SELECT id, username, display_name, telegram_chat_id
                FROM users
                WHERE telegram_chat_id IS NOT NULL AND telegram_chat_id != ''
                ORDER BY display_name, username
            ''')

        users = [dict(row) for row in cursor.fetchall()]
        conn.close()

        return jsonify({'success': True, 'users': users})

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ get_users_for_telegram: {e}")
        return jsonify({'success': False, 'error': str(e), 'users': []})


@app.route('/api/telegram/send-container-message', methods=['POST'])
def send_container_message_from_telegram():
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –í–≠–î –∏–∑ Telegram –±–æ—Ç–∞.
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç JSON (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç) –∏ multipart/form-data (—Ç–µ–∫—Å—Ç + —Ñ–∞–π–ª—ã).

    –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç /api/container-messages/receive (—Ç–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç –±–µ–∑ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π),
    —ç—Ç–æ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—ã–±–æ—Ä–æ–º –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π.

    JSON payload:
        token: TELEGRAM_BOT_SECRET
        chat_id: Telegram chat_id –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
        container_id: ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        recipient_ids: –º–∞—Å—Å–∏–≤ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π-–ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
        message: —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        sender_name: –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (@username –∏–ª–∏ –∏–º—è)

    –õ–æ–≥–∏–∫–∞:
        1. –ù–∞–π—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –ø–æ chat_id
        2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ container_messages —Å recipient_ids
        3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
        4. –ü–æ–º–µ—Ç–∏—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
        5. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º –≤ Telegram
    """
    try:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞: multipart (—Å —Ñ–∞–π–ª–∞–º–∏) –∏–ª–∏ JSON
        files = []
        if request.content_type and 'multipart/form-data' in request.content_type:
            token = request.form.get('token', '')
            chat_id = request.form.get('chat_id')
            container_id = request.form.get('container_id', type=int)
            recipient_ids_raw = request.form.get('recipient_ids', '')
            recipient_ids = [int(x) for x in recipient_ids_raw.split(',') if x.strip()]
            message = request.form.get('message', '').strip()
            sender_name = request.form.get('sender_name', 'Telegram')
            files = request.files.getlist('files')
        else:
            data = request.json or {}
            token = data.get('token', '')
            chat_id = data.get('chat_id')
            container_id = data.get('container_id')
            recipient_ids = data.get('recipient_ids', [])
            message = data.get('message', '').strip()
            sender_name = data.get('sender_name', 'Telegram')

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
        expected_token = os.environ.get('TELEGRAM_BOT_SECRET', '')
        if not expected_token or token != expected_token:
            return jsonify({'success': False, 'error': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω'}), 403

        if not container_id:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ container_id'}), 400
        if not recipient_ids:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π'}), 400
        if not message and not files:
            return jsonify({'success': False, 'error': '–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª'}), 400
        if not chat_id:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ chat_id'}), 400

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ù–∞—Ö–æ–¥–∏–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –ø–æ telegram chat_id
        cursor.execute('SELECT id, username, display_name FROM users WHERE telegram_chat_id = ?', (str(chat_id),))
        user = cursor.fetchone()
        sender_id = user['id'] if user else 0
        sender_display = (user['display_name'] or user['username']) if user else sender_name

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        cursor.execute('SELECT supplier, container_date FROM ved_container_docs WHERE id = ?', (container_id,))
        container = cursor.fetchone()
        if not container:
            conn.close()
            return jsonify({'success': False, 'error': '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å recipient_ids –∏ sender_type='telegram'
        cursor.execute('''
            INSERT INTO container_messages (container_id, message, sender_id, sender_name, recipient_ids, sender_type)
            VALUES (?, ?, ?, ?, ?, 'telegram')
        ''', (container_id, message, sender_id, sender_display, ','.join(map(str, recipient_ids))))
        message_id = cursor.lastrowid

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
        saved_files = []
        if files:
            saved_files = save_message_files(cursor, message_id, container_id, files)

        # –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –û–¢ —Ç–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–º –º—ã –æ—Ç–≤–µ—á–∞–µ–º
        # (—Ç–æ—Ç –∂–µ –ø–∞—Ç—Ç–µ—Ä–Ω, —á—Ç–æ –∏ –≤ api_container_messages_send)
        if recipient_ids:
            placeholders = ','.join('?' * len(recipient_ids))
            cursor.execute(f'''
                UPDATE container_messages
                SET is_read = 1
                WHERE container_id = ?
                AND sender_id IN ({placeholders})
                AND (recipient_ids LIKE ? OR recipient_ids IS NULL OR recipient_ids = '')
            ''', (container_id, *recipient_ids, f'%{sender_id}%'))
        conn.commit()

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º –≤ Telegram
        telegram_message_ids = []
        site_url = os.environ.get('SITE_URL', 'https://moscowseller.ru')

        for recipient_id in recipient_ids:
            cursor.execute('SELECT telegram_chat_id, username FROM users WHERE id = ?', (recipient_id,))
            recipient = cursor.fetchone()
            if recipient and recipient['telegram_chat_id']:
                recipient_chat_id = recipient['telegram_chat_id']
                # –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–∞–º–æ–º—É —Å–µ–±–µ
                if str(recipient_chat_id) == str(chat_id):
                    continue

                # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                tg_text = f"üì¶ *–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä #{container_id}*\n"
                tg_text += f"üìÖ {container['container_date']} | {container['supplier']}\n\n"
                tg_text += f"üí¨ *–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {sender_display}:*\n{message}\n\n"
                container_url = f"{site_url}/#ved:ved-containers:{container_id}"
                tg_text += f"üîó [–û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä]({container_url})"

                try:
                    tg_msg_id = send_telegram_container_message(recipient_chat_id, tg_text, container_id, message_id)
                    if tg_msg_id:
                        telegram_message_ids.append(str(tg_msg_id))
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã, –µ—Å–ª–∏ –µ—Å—Ç—å
                    if saved_files:
                        send_telegram_container_files(recipient_chat_id, saved_files)
                except Exception as tg_err:
                    print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram (chat_id={recipient_chat_id}): {tg_err}")

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏–π Telegram
        if telegram_message_ids:
            cursor.execute('UPDATE container_messages SET telegram_message_ids = ? WHERE id = ?',
                          (','.join(telegram_message_ids), message_id))
            conn.commit()

        conn.close()
        return jsonify({'success': True, 'message_id': message_id})

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ send_container_message_from_telegram: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)}), 500


# ============================================================================
# –°–û–ó–î–ê–ù–ò–ï –û–¢–ü–†–ê–í–ö–ò (–ö–û–ù–¢–ï–ô–ù–ï–†–ê) –ß–ï–†–ï–ó TELEGRAM
# ============================================================================

@app.route('/api/telegram/create-shipment', methods=['POST'])
def api_telegram_create_shipment():
    """
    –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –æ—Ç–ø—Ä–∞–≤–∫—É (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä) –∏–∑ Telegram –±–æ—Ç–∞.

    –°–æ–∑–¥–∞—ë—Ç –ø—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–±–µ–∑ —Ç–æ–≤–∞—Ä–æ–≤) —Å –¥–∞—Ç–æ–π –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º.
    –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (container_messages).
    –§–∞–π–ª (–µ—Å–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω) —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ container_message_files.
    –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º –≤ Telegram.

    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç JSON (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç) –∏ multipart/form-data (—Ç–µ–∫—Å—Ç + —Ñ–∞–π–ª).
    """
    try:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞
        files = []
        if request.content_type and 'multipart/form-data' in request.content_type:
            token = request.form.get('token', '')
            chat_id = request.form.get('chat_id', '')
            comment = request.form.get('comment', '').strip()
            sender_name = request.form.get('sender_name', 'Telegram')
            files = request.files.getlist('files')
        else:
            data = request.json or {}
            token = data.get('token', '')
            chat_id = data.get('chat_id', '')
            comment = data.get('comment', '').strip()
            sender_name = data.get('sender_name', 'Telegram')

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
        expected_token = os.environ.get('TELEGRAM_BOT_SECRET', '')
        if not expected_token or token != expected_token:
            return jsonify({'success': False, 'error': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω'}), 403

        if not comment:
            return jsonify({'success': False, 'error': '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'}), 400

        if not chat_id:
            return jsonify({'success': False, 'error': 'chat_id –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'}), 400

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ chat_id
        cursor.execute('SELECT id, username FROM users WHERE telegram_chat_id = ?', (str(chat_id),))
        user = cursor.fetchone()
        sender_id = user['id'] if user else 0
        sender_display = user['username'] if user else sender_name

        # –î–∞—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ‚Äî —Å–µ–≥–æ–¥–Ω—è
        from datetime import datetime
        container_date = datetime.now().strftime('%Y-%m-%d')

        # –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–ø—É—Å—Ç–æ–π, –±–µ–∑ —Ç–æ–≤–∞—Ä–æ–≤)
        cursor.execute('''
            INSERT INTO ved_container_docs (container_date, supplier, comment, important, cny_rate, cny_percent, is_completed, created_by, updated_by, updated_at)
            VALUES (?, '', ?, '', 0, 0, 0, ?, ?, CURRENT_TIMESTAMP)
        ''', (container_date, comment, sender_display, sender_display))
        doc_id = cursor.lastrowid

        # –°–æ–∑–¥–∞—ë–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å —Ç–µ–∫—Å—Ç–æ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
        cursor.execute('''
            INSERT INTO container_messages (container_id, message, sender_id, sender_name, sender_type, is_read)
            VALUES (?, ?, ?, ?, 'telegram', 0)
        ''', (doc_id, comment, sender_id, sender_display))
        message_id = cursor.lastrowid

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª, –µ—Å–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω
        saved_files = []
        if files:
            saved_files = save_message_files(cursor, message_id, doc_id, files)

        conn.commit()

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º –≤ Telegram
        site_url = os.environ.get('SITE_URL', 'https://moscowseller.ru')
        container_url = f"{site_url}/#ved:ved-containers:{doc_id}"

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Markdown (send_telegram_container_message –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Markdown)
        tg_text = f"üì¶ *–ù–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ #{doc_id}*\n"
        tg_text += f"üìÖ {container_date}\n\n"
        tg_text += f"üí¨ *–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç {sender_display}:*\n{comment}\n\n"
        if saved_files:
            tg_text += f"üìé –ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω —Ñ–∞–π–ª: {saved_files[0].get('filename', '—Ñ–∞–π–ª')}\n\n"
        tg_text += f"üîó [–û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä]({container_url})"

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º (–∫—Ä–æ–º–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è)
        bot_token = os.environ.get('TELEGRAM_BOT_TOKEN', '')
        if bot_token:
            cursor.execute('''
                SELECT telegram_chat_id FROM users
                WHERE role = 'admin' AND telegram_chat_id IS NOT NULL AND telegram_chat_id != ''
            ''')
            admin_rows = cursor.fetchall()

            for admin in admin_rows:
                admin_chat_id = admin['telegram_chat_id']
                # –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–∞–º–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é
                if str(admin_chat_id) == str(chat_id):
                    continue
                try:
                    tg_msg_id = send_telegram_container_message(admin_chat_id, tg_text, doc_id, message_id)
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã, –µ—Å–ª–∏ –µ—Å—Ç—å
                    if saved_files and tg_msg_id:
                        send_telegram_container_files(admin_chat_id, saved_files)
                except Exception as tg_err:
                    print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É (chat_id={admin_chat_id}): {tg_err}")

        conn.close()

        return jsonify({
            'success': True,
            'doc_id': doc_id,
            'message_id': message_id
        })

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ api_telegram_create_shipment: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)}), 500


# ============================================================================
# API –î–õ–Ø –°–û–û–ë–©–ï–ù–ò–ô –ö –î–û–ö–£–ú–ï–ù–¢–ê–ú (–ß–ê–¢ –°–ê–ô–¢ ‚Üî TELEGRAM)
# ============================================================================

def send_telegram_message(chat_id: int, text: str, reply_to_message_id: int = None,
                         doc_type: str = None, doc_id: int = None) -> dict:
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram —á–µ—Ä–µ–∑ HTTP API.

    –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã doc_type –∏ doc_id, –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "–û—Ç–≤–µ—Ç–∏—Ç—å" –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {'success': True, 'message_id': 123} –∏–ª–∏ {'success': False, 'error': '...'}
    """
    import requests
    import json

    bot_token = os.environ.get('TELEGRAM_BOT_TOKEN', '')
    if not bot_token:
        return {'success': False, 'error': 'TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}

    try:
        url = f'https://api.telegram.org/bot{bot_token}/sendMessage'
        payload = {
            'chat_id': chat_id,
            'text': text,
            'parse_mode': 'HTML'
        }
        if reply_to_message_id:
            payload['reply_to_message_id'] = reply_to_message_id

        # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–û—Ç–≤–µ—Ç–∏—Ç—å" –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç
        if doc_type and doc_id:
            reply_markup = {
                'inline_keyboard': [[
                    {
                        'text': 'üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å',
                        'callback_data': f'reply_msg:{doc_type}:{doc_id}'
                    }
                ]]
            }
            payload['reply_markup'] = json.dumps(reply_markup)

        response = requests.post(url, json=payload, timeout=10)
        data = response.json()

        if data.get('ok'):
            return {'success': True, 'message_id': data['result']['message_id']}
        else:
            return {'success': False, 'error': data.get('description', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')}
    except Exception as e:
        return {'success': False, 'error': str(e)}


@app.route('/api/document-messages/<doc_type>/<int:doc_id>')
@require_auth(['admin', 'viewer'])
def get_document_messages(doc_type, doc_id):
    """
    –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞.

    doc_type: 'receipt' –∏–ª–∏ 'shipment'
    doc_id: ID –¥–æ–∫—É–º–µ–Ω—Ç–∞
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('''
            SELECT * FROM document_messages
            WHERE doc_type = ? AND doc_id = ?
            ORDER BY created_at ASC
        ''', (doc_type, doc_id))

        messages = [dict(row) for row in cursor.fetchall()]
        conn.close()

        return jsonify({'success': True, 'messages': messages})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'messages': []})


def send_admin_notification(text: str) -> dict:
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –≤ Telegram.

    –ë–µ—Ä—ë—Ç chat_id –∏–∑ —Ç–∞–±–ª–∏—Ü—ã users (role = 'admin' –∏ telegram_chat_id –∑–∞–ø–æ–ª–Ω–µ–Ω).

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫, —Ç—Ä–µ–±—É—é—â–∏—Ö –≤–Ω–∏–º–∞–Ω–∏—è:
    - –ù–µ—Ö–≤–∞—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ—Å—Ç–∞–≤–∫–∞—Ö –ø—Ä–∏ –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–∏
    - –î—Ä—É–≥–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        text: –¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç HTML)

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        {'success': True/False, 'sent_count': int, 'errors': list}
    """
    import requests

    bot_token = os.environ.get('TELEGRAM_BOT_TOKEN', '')

    if not bot_token:
        return {'success': False, 'error': 'TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}

    # –ü–æ–ª—É—á–∞–µ–º chat_id –≤—Å–µ—Ö –∞–¥–º–∏–Ω–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('''
            SELECT telegram_chat_id FROM users
            WHERE role = 'admin' AND telegram_chat_id IS NOT NULL AND telegram_chat_id != ''
        ''')
        admin_rows = cursor.fetchall()
        conn.close()

        if not admin_rows:
            print("‚ö†Ô∏è –ù–µ—Ç –∞–¥–º–∏–Ω–æ–≤ —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º Telegram - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")
            return {'success': False, 'error': '–ù–µ—Ç –∞–¥–º–∏–Ω–æ–≤ —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º Telegram'}

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∂–¥–æ–º—É –∞–¥–º–∏–Ω—É
        url = f'https://api.telegram.org/bot{bot_token}/sendMessage'
        sent_count = 0
        errors = []

        for admin in admin_rows:
            chat_id = admin['telegram_chat_id']
            try:
                payload = {
                    'chat_id': chat_id,
                    'text': text,
                    'parse_mode': 'HTML'
                }
                response = requests.post(url, json=payload, timeout=10)
                data = response.json()

                if data.get('ok'):
                    sent_count += 1
                else:
                    errors.append(f"chat_id {chat_id}: {data.get('description')}")
            except Exception as e:
                errors.append(f"chat_id {chat_id}: {str(e)}")

        if errors:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: {errors}")

        return {'success': sent_count > 0, 'sent_count': sent_count, 'errors': errors}

    except Exception as e:
        print(f"‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞–º: {e}")
        return {'success': False, 'error': str(e)}


@app.route('/api/document-messages/send', methods=['POST'])
@require_auth(['admin'])
def send_document_message():
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É.

    –û–∂–∏–¥–∞–µ—Ç JSON:
    {
        "doc_type": "receipt",
        "doc_id": 123,
        "message": "–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è",
        "send_telegram": true,
        "sender_name": "–ò–≤–∞–Ω–æ–≤"
    }
    """
    try:
        data = request.json
        doc_type = data.get('doc_type', 'receipt')
        doc_id = data.get('doc_id')
        message = data.get('message', '').strip()
        send_telegram = data.get('send_telegram', False)
        sender_name = data.get('sender_name', '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä')

        if not doc_id or not message:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ doc_id –∏ message'})

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        telegram_message_id = None
        telegram_chat_id = None

        # –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram ‚Äî –Ω–∞—Ö–æ–¥–∏–º chat_id —Å–æ–∑–¥–∞—Ç–µ–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
        if send_telegram:
            if doc_type == 'receipt':
                cursor.execute('''
                    SELECT telegram_chat_id FROM warehouse_receipt_docs WHERE id = ?
                ''', (doc_id,))
            else:
                # –î–ª—è –æ—Ç–≥—Ä—É–∑–æ–∫ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
                cursor.execute('SELECT NULL as telegram_chat_id')

            row = cursor.fetchone()
            if row and row['telegram_chat_id']:
                telegram_chat_id = row['telegram_chat_id']

                # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è Telegram
                doc_type_name = '–ü—Ä–∏—Ö–æ–¥' if doc_type == 'receipt' else '–û—Ç–≥—Ä—É–∑–∫–∞' if doc_type == 'shipment' else '–î–æ–∫—É–º–µ–Ω—Ç'
                # –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç: #warehouse:wh-receipt:ID
                subtab = 'wh-receipt' if doc_type == 'receipt' else 'wh-shipments'
                doc_url = f'http://moscowseller.ru/#warehouse:{subtab}:{doc_id}'
                tg_text = (
                    f"üí¨ <b>–°–æ–æ–±—â–µ–Ω–∏–µ –∫ {doc_type_name.lower()}—É #{doc_id}</b>\n\n"
                    f"{message}\n\n"
                    f"<i>‚Äî {sender_name}</i>\n\n"
                    f"üîó <a href=\"{doc_url}\">–û—Ç–∫—Ä—ã—Ç—å {doc_type_name.lower()} #{doc_id}</a>"
                )

                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å –∫–Ω–æ–ø–∫–æ–π "–û—Ç–≤–µ—Ç–∏—Ç—å"
                result = send_telegram_message(telegram_chat_id, tg_text, doc_type=doc_type, doc_id=doc_id)
                if result.get('success'):
                    telegram_message_id = result.get('message_id')

        # –ü–æ–ª—É—á–∞–µ–º sender_id —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_info = getattr(request, 'current_user', {})
        sender_id = user_info.get('user_id', 0) or 0

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ë–î
        cursor.execute('''
            INSERT INTO document_messages
            (doc_type, doc_id, message, sender_type, sender_name, sender_id, telegram_chat_id, telegram_message_id)
            VALUES (?, ?, ?, 'web', ?, ?, ?, ?)
        ''', (doc_type, doc_id, message, sender_name, sender_id, telegram_chat_id, telegram_message_id))

        message_id = cursor.lastrowid
        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message_id': message_id,
            'telegram_sent': telegram_message_id is not None,
            'telegram_message_id': telegram_message_id
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/document-messages/edit', methods=['POST'])
@require_auth()
def api_document_messages_edit():
    """
    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
    –ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.
    –¢–∞–∫–∂–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram (parse_mode=HTML).
    """
    try:
        data = request.json or {}
        message_id = data.get('message_id')
        new_message = (data.get('message') or '').strip()

        if not message_id:
            return jsonify({'success': False, 'error': 'message_id –Ω–µ —É–∫–∞–∑–∞–Ω'})
        if not new_message:
            return jsonify({'success': False, 'error': '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'})

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('SELECT * FROM document_messages WHERE id = ?', (message_id,))
        msg = cursor.fetchone()
        if not msg:
            conn.close()
            return jsonify({'success': False, 'error': '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'}), 404

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä—Å—Ç–≤–æ ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        user_info = getattr(request, 'current_user', {})
        current_user_id = user_info.get('user_id')
        if msg['sender_id'] != current_user_id:
            conn.close()
            return jsonify({'success': False, 'error': '–ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è'}), 403

        # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ –ë–î
        cursor.execute('UPDATE document_messages SET message = ? WHERE id = ?', (new_message, message_id))
        conn.commit()

        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Telegram
        if msg['telegram_chat_id'] and msg['telegram_message_id']:
            doc_type = msg['doc_type']
            doc_id = msg['doc_id']
            sender_name = msg['sender_name'] or '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'
            doc_type_name = '–ü—Ä–∏—Ö–æ–¥' if doc_type == 'receipt' else '–û—Ç–≥—Ä—É–∑–∫–∞' if doc_type == 'shipment' else '–î–æ–∫—É–º–µ–Ω—Ç'
            subtab = 'wh-receipt' if doc_type == 'receipt' else 'wh-shipments'
            doc_url = f'http://moscowseller.ru/#warehouse:{subtab}:{doc_id}'

            tg_text = (
                f"üí¨ <b>–°–æ–æ–±—â–µ–Ω–∏–µ –∫ {doc_type_name.lower()}—É #{doc_id}</b>\n\n"
                f"{new_message}\n\n"
                f"<i>‚úèÔ∏è (–æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ)</i>\n\n"
                f"<i>‚Äî {sender_name}</i>\n\n"
                f"üîó <a href=\"{doc_url}\">–û—Ç–∫—Ä—ã—Ç—å {doc_type_name.lower()} #{doc_id}</a>"
            )
            edit_telegram_message(msg['telegram_chat_id'], msg['telegram_message_id'], tg_text, parse_mode='HTML')

        conn.close()
        return jsonify({'success': True})

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ api_document_messages_edit: {e}", file=sys.stderr)
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/document-messages/delete', methods=['POST'])
@require_auth()
def api_document_messages_delete():
    """
    –£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
    –ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.
    –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram.
    """
    try:
        data = request.json or {}
        message_id = data.get('message_id')

        if not message_id:
            return jsonify({'success': False, 'error': 'message_id –Ω–µ —É–∫–∞–∑–∞–Ω'})

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('SELECT * FROM document_messages WHERE id = ?', (message_id,))
        msg = cursor.fetchone()
        if not msg:
            conn.close()
            return jsonify({'success': False, 'error': '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'}), 404

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä—Å—Ç–≤–æ ‚Äî —É–¥–∞–ª—è—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        user_info = getattr(request, 'current_user', {})
        current_user_id = user_info.get('user_id')
        if msg['sender_id'] != current_user_id:
            conn.close()
            return jsonify({'success': False, 'error': '–ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è'}), 403

        # –£–¥–∞–ª—è–µ–º –∏–∑ –ë–î
        cursor.execute('DELETE FROM document_messages WHERE id = ?', (message_id,))
        conn.commit()

        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Telegram
        if msg['telegram_chat_id'] and msg['telegram_message_id']:
            delete_telegram_message(msg['telegram_chat_id'], msg['telegram_message_id'])

        conn.close()
        return jsonify({'success': True})

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ api_document_messages_delete: {e}", file=sys.stderr)
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/document-messages/receive', methods=['POST'])
def receive_telegram_message():
    """
    –ü—Ä–∏–Ω—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ Telegram –±–æ—Ç–∞ (–æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ telegram_bot.py –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ reply –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ.

    –û–∂–∏–¥–∞–µ—Ç JSON:
    {
        "token": "—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_—Ç–æ–∫–µ–Ω",
        "chat_id": 123456789,
        "message": "–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞",
        "reply_to_message_id": 456,
        "sender_name": "@username"
    }
    """
    try:
        data = request.json

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
        token = data.get('token', '')
        expected_token = os.environ.get('TELEGRAM_BOT_SECRET', '')

        if not expected_token or token != expected_token:
            return jsonify({'success': False, 'error': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω'}), 403

        chat_id = data.get('chat_id')
        message = data.get('message', '').strip()
        reply_to_message_id = data.get('reply_to_message_id')
        sender_name = data.get('sender_name', 'Telegram')

        if not message:
            return jsonify({'success': False, 'error': '–ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'})

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ò—â–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ telegram_message_id
        doc_type = None
        doc_id = None

        if reply_to_message_id:
            cursor.execute('''
                SELECT doc_type, doc_id FROM document_messages
                WHERE telegram_message_id = ? AND telegram_chat_id = ?
            ''', (reply_to_message_id, chat_id))
            row = cursor.fetchone()
            if row:
                doc_type = row['doc_type']
                doc_id = row['doc_id']

        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ reply ‚Äî –∏—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —ç—Ç–æ–º—É chat_id
        if not doc_id:
            cursor.execute('''
                SELECT doc_type, doc_id FROM document_messages
                WHERE telegram_chat_id = ?
                ORDER BY created_at DESC
                LIMIT 1
            ''', (chat_id,))
            row = cursor.fetchone()
            if row:
                doc_type = row['doc_type']
                doc_id = row['doc_id']

        if not doc_id:
            conn.close()
            return jsonify({'success': False, 'error': '–ù–µ –Ω–∞–π–¥–µ–Ω —Å–≤—è–∑–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç'})

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º sender_id –ø–æ telegram chat_id
        tg_sender_id = 0
        cursor.execute('SELECT id FROM users WHERE telegram_chat_id = ?', (str(chat_id),))
        tg_user = cursor.fetchone()
        if tg_user:
            tg_sender_id = tg_user['id']

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç (is_read=1, —Ç.–∫. –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å —Å–∞–º –∑–Ω–∞–µ—Ç —á—Ç–æ –Ω–∞–ø–∏—Å–∞–ª)
        cursor.execute('''
            INSERT INTO document_messages
            (doc_type, doc_id, message, sender_type, sender_name, sender_id, telegram_chat_id, is_read)
            VALUES (?, ?, ?, 'telegram', ?, ?, ?, 1)
        ''', (doc_type, doc_id, message, sender_name, tg_sender_id, chat_id))

        message_id = cursor.lastrowid

        # –ü–æ–º–µ—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–æ—Ç –≤–µ–±–∞) –≤ —ç—Ç–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ,
        # —Ç.–∫. –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏–ª ‚Äî –∑–Ω–∞—á–∏—Ç –æ–Ω –∏—Ö –ø—Ä–æ—á–∏—Ç–∞–ª
        cursor.execute('''
            UPDATE document_messages
            SET is_read = 1
            WHERE doc_type = ? AND doc_id = ?
            AND id != ?
            AND sender_type = 'web'
            AND is_read = 0
        ''', (doc_type, doc_id, message_id))

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message_id': message_id, 'doc_type': doc_type, 'doc_id': doc_id})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/document-messages/receive-direct', methods=['POST'])
def receive_telegram_message_direct():
    """
    –ü—Ä–∏–Ω—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ Telegram –±–æ—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é (—á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "–û—Ç–≤–µ—Ç–∏—Ç—å").
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ telegram_bot.py –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É "–û—Ç–≤–µ—Ç–∏—Ç—å" –ø–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ–º.

    –û–∂–∏–¥–∞–µ—Ç JSON:
    {
        "token": "—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_—Ç–æ–∫–µ–Ω",
        "chat_id": 123456789,
        "doc_type": "receipt",
        "doc_id": 123,
        "message": "–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞",
        "sender_name": "@username"
    }
    """
    try:
        data = request.json

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
        token = data.get('token', '')
        expected_token = os.environ.get('TELEGRAM_BOT_SECRET', '')

        if not expected_token or token != expected_token:
            return jsonify({'success': False, 'error': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω'}), 403

        chat_id = data.get('chat_id')
        doc_type = data.get('doc_type')
        doc_id = data.get('doc_id')
        message = data.get('message', '').strip()
        sender_name = data.get('sender_name', 'Telegram')

        if not message:
            return jsonify({'success': False, 'error': '–ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'})

        if not doc_type or not doc_id:
            return jsonify({'success': False, 'error': '–ù–µ —É–∫–∞–∑–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç'})

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º sender_id –ø–æ telegram chat_id
        tg_sender_id = 0
        cursor.execute('SELECT id FROM users WHERE telegram_chat_id = ?', (str(chat_id),))
        tg_user = cursor.fetchone()
        if tg_user:
            tg_sender_id = tg_user['id']

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç (is_read=1, —Ç.–∫. –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å —Å–∞–º –∑–Ω–∞–µ—Ç —á—Ç–æ –Ω–∞–ø–∏—Å–∞–ª)
        cursor.execute('''
            INSERT INTO document_messages
            (doc_type, doc_id, message, sender_type, sender_name, sender_id, telegram_chat_id, is_read)
            VALUES (?, ?, ?, 'telegram', ?, ?, ?, 1)
        ''', (doc_type, doc_id, message, sender_name, tg_sender_id, chat_id))

        message_id = cursor.lastrowid

        # –ü–æ–º–µ—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–æ—Ç –≤–µ–±–∞) –≤ —ç—Ç–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ,
        # —Ç.–∫. –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏–ª ‚Äî –∑–Ω–∞—á–∏—Ç –æ–Ω –∏—Ö –ø—Ä–æ—á–∏—Ç–∞–ª
        cursor.execute('''
            UPDATE document_messages
            SET is_read = 1
            WHERE doc_type = ? AND doc_id = ?
            AND id != ?
            AND sender_type = 'web'
            AND is_read = 0
        ''', (doc_type, doc_id, message_id))

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message_id': message_id, 'doc_type': doc_type, 'doc_id': doc_id})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/document-messages/all')
@require_auth(['admin', 'viewer'])
def get_all_document_messages():
    """
    –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Telegram –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–°–æ–æ–±—â–µ–Ω–∏—è".
    –í–∫–ª—é—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–ø—Ä–∏—Ö–æ–¥–æ–≤) –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –í–≠–î.
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: ?unread_only=true ‚Äî —Ç–æ–ª—å–∫–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ

    –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–º—É Telegram –∞–∫–∫–∞—É–Ω—Ç—É:
    - admin: –≤–∏–¥–∏—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    - viewer: –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–≥–æ Telegram –∞–∫–∫–∞—É–Ω—Ç–∞
    """
    try:
        unread_only = request.args.get('unread_only', 'false').lower() == 'true'

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (—Ä–æ–ª—å –∏ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π Telegram)
        user_info = getattr(request, 'current_user', {})
        user_id = user_info.get('user_id')
        user_role = user_info.get('role', 'viewer')

        user_telegram_chat_id = None
        if user_id:
            cursor.execute('SELECT telegram_chat_id FROM users WHERE id = ?', (user_id,))
            row = cursor.fetchone()
            if row:
                user_telegram_chat_id = row['telegram_chat_id']

        messages = []

        # 1. –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–ø—Ä–∏—Ö–æ–¥–æ–≤)
        doc_query = '''
            SELECT m.id, m.doc_type, m.doc_id, m.sender_name, m.sender_id, m.message, m.is_read,
                   m.created_at, m.telegram_chat_id, m.sender_type, d.receiver_name, d.receipt_datetime,
                   'document' as msg_source
            FROM document_messages m
            LEFT JOIN warehouse_receipt_docs d ON m.doc_type = 'receipt' AND m.doc_id = d.id
            WHERE m.sender_type IN ('telegram', 'system')
        '''
        doc_params = []

        if user_role != 'admin':
            if user_telegram_chat_id:
                # –î–ª—è –Ω–µ-–∞–¥–º–∏–Ω–æ–≤: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ Telegram-—Å–æ–æ–±—â–µ–Ω–∏—è
                # (system-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±–µ–∑ telegram_chat_id –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è)
                doc_query += ' AND m.telegram_chat_id = ?'
                doc_params.append(user_telegram_chat_id)
            else:
                doc_query = None  # –ù–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º

        if doc_query:
            if unread_only:
                doc_query += ' AND m.is_read = 0'
            cursor.execute(doc_query, doc_params)
            for row in cursor.fetchall():
                msg = dict(row)
                msg['msg_source'] = 'document'
                messages.append(msg)

        # 2. –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –í–≠–î
        container_query = '''
            SELECT cm.id, cm.container_id as doc_id, cm.sender_name, cm.message, cm.is_read,
                   cm.created_at, cm.sender_type, cm.sender_id, c.supplier, c.container_date,
                   'container' as msg_source
            FROM container_messages cm
            LEFT JOIN ved_container_docs c ON cm.container_id = c.id
            WHERE 1=1
        '''
        container_params = []

        # –§–∏–ª—å—Ç—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
        if user_role != 'admin':
            if user_id:
                if unread_only:
                    # –¢–æ–ª—å–∫–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ: —Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ –∞–¥—Ä–µ—Å–æ–≤–∞–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –Ω–æ –ù–ï –∏–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã
                    container_query += ' AND cm.recipient_ids LIKE ? AND cm.sender_id != ? AND cm.is_read = 0'
                    container_params.append(f'%{user_id}%')
                    container_params.append(user_id)
                else:
                    # –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è: –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –∏–ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—å
                    container_query += ' AND (cm.sender_id = ? OR cm.recipient_ids LIKE ?)'
                    container_params.append(user_id)
                    container_params.append(f'%{user_id}%')
            else:
                container_query = None
        else:
            # –î–ª—è admin —Ç–æ–∂–µ –∏—Å–∫–ª—é—á–∞–µ–º —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–µ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
            if unread_only:
                if user_id:
                    container_query += ' AND cm.is_read = 0 AND cm.sender_id != ?'
                    container_params.append(user_id)
                else:
                    container_query += ' AND cm.is_read = 0'

        if container_query:
            cursor.execute(container_query, container_params)
            for row in cursor.fetchall():
                msg = dict(row)
                msg['msg_source'] = 'container'
                msg['doc_type'] = 'container'
                # –û—Ç–º–µ—á–∞–µ–º —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –¥–ª—è –Ω–∏—Ö –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–æ"
                if user_id and msg.get('sender_id') == user_id:
                    msg['is_own'] = True
                messages.append(msg)

        conn.close()

        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –¥–∞—Ç–µ
        messages.sort(key=lambda x: x['created_at'], reverse=True)
        messages = messages[:100]  # –õ–∏–º–∏—Ç 100

        return jsonify({'success': True, 'messages': messages})
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ get_all_document_messages: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e), 'messages': []})


@app.route('/api/document-messages/mark-read-single', methods=['POST'])
@require_auth(['admin', 'viewer'])
def mark_single_message_read():
    """
    –û—Ç–º–µ—Ç–∏—Ç—å –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ.

    - admin: –º–æ–∂–µ—Ç –ø–æ–º–µ—Ç–∏—Ç—å –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    - viewer: –º–æ–∂–µ—Ç –ø–æ–º–µ—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–≤–æ–µ–≥–æ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–≥–æ Telegram
    """
    try:
        data = request.json
        message_id = data.get('message_id')

        if not message_id:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ message_id'})

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        user_info = getattr(request, 'current_user', {})
        user_id = user_info.get('user_id')
        user_role = user_info.get('role', 'viewer')

        # –î–ª—è viewer –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏–≤—è–∑–∫—É
        if user_role != 'admin':
            user_telegram_chat_id = None
            if user_id:
                cursor.execute('SELECT telegram_chat_id FROM users WHERE id = ?', (user_id,))
                row = cursor.fetchone()
                if row:
                    user_telegram_chat_id = row['telegram_chat_id']

            if not user_telegram_chat_id:
                conn.close()
                return jsonify({'success': False, 'error': '–ù–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–≥–æ Telegram –∞–∫–∫–∞—É–Ω—Ç–∞'})

            # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ–º—É Telegram
            cursor.execute('''
                UPDATE document_messages SET is_read = 1
                WHERE id = ? AND telegram_chat_id = ?
            ''', (message_id, user_telegram_chat_id))
        else:
            cursor.execute('UPDATE document_messages SET is_read = 1 WHERE id = ?', (message_id,))

        conn.commit()
        conn.close()

        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/document-messages/mark-all-read', methods=['POST'])
@require_auth(['admin', 'viewer'])
def mark_all_messages_read_api():
    """
    –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ.

    - admin: –ø–æ–º–µ—á–∞–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    - viewer: –ø–æ–º–µ—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–≤–æ–µ–≥–æ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–≥–æ Telegram –∞–∫–∫–∞—É–Ω—Ç–∞
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        user_info = getattr(request, 'current_user', {})
        user_id = user_info.get('user_id')
        user_role = user_info.get('role', 'viewer')

        user_telegram_chat_id = None
        if user_id:
            cursor.execute('SELECT telegram_chat_id FROM users WHERE id = ?', (user_id,))
            row = cursor.fetchone()
            if row:
                user_telegram_chat_id = row['telegram_chat_id']

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å —É—á—ë—Ç–æ–º –ø—Ä–∏–≤—è–∑–∫–∏
        if user_role != 'admin':
            if user_telegram_chat_id:
                cursor.execute('''
                    UPDATE document_messages SET is_read = 1
                    WHERE sender_type = 'telegram' AND is_read = 0 AND telegram_chat_id = ?
                ''', (user_telegram_chat_id,))
            else:
                conn.close()
                return jsonify({'success': True, 'updated': 0})
        else:
            cursor.execute('''
                UPDATE document_messages SET is_read = 1
                WHERE sender_type = 'telegram' AND is_read = 0
            ''')

        updated = cursor.rowcount
        conn.commit()
        conn.close()

        return jsonify({'success': True, 'updated': updated})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/document-messages/unread-count')
@require_auth(['admin', 'viewer'])
def get_unread_messages_count():
    """
    –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–æ–∫—É–º–µ–Ω—Ç—ã + –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã).

    –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–º—É Telegram –∞–∫–∫–∞—É–Ω—Ç—É:
    - admin: —Å—á–∏—Ç–∞–µ—Ç –≤—Å–µ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    - viewer: —Å—á–∏—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–≥–æ Telegram –∞–∫–∫–∞—É–Ω—Ç–∞
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        user_info = getattr(request, 'current_user', {})
        user_id = user_info.get('user_id')
        user_role = user_info.get('role', 'viewer')

        user_telegram_chat_id = None
        if user_id:
            cursor.execute('SELECT telegram_chat_id FROM users WHERE id = ?', (user_id,))
            row = cursor.fetchone()
            if row:
                user_telegram_chat_id = row['telegram_chat_id']

        count = 0

        # 1. –°—á–∏—Ç–∞–µ–º –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        if user_role != 'admin':
            if user_telegram_chat_id:
                cursor.execute('''
                    SELECT COUNT(*) FROM document_messages
                    WHERE sender_type = 'telegram' AND is_read = 0 AND telegram_chat_id = ?
                ''', (user_telegram_chat_id,))
                count += cursor.fetchone()[0]
        else:
            cursor.execute('''
                SELECT COUNT(*) FROM document_messages
                WHERE sender_type IN ('telegram', 'system') AND is_read = 0
            ''')
            count += cursor.fetchone()[0]

        # 2. –°—á–∏—Ç–∞–µ–º –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
        # –¢–æ–ª—å–∫–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –∞–¥—Ä–µ—Å–æ–≤–∞–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –Ω–æ –ù–ï –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∏–º —Å–∞–º–∏–º
        if user_role != 'admin':
            if user_id:
                cursor.execute('''
                    SELECT COUNT(*) FROM container_messages
                    WHERE is_read = 0 AND recipient_ids LIKE ? AND sender_id != ?
                ''', (f'%{user_id}%', user_id))
                count += cursor.fetchone()[0]
        else:
            # –î–ª—è admin —Ç–æ–∂–µ –∏—Å–∫–ª—é—á–∞–µ–º —Å–≤–æ–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            if user_id:
                cursor.execute('''
                    SELECT COUNT(*) FROM container_messages
                    WHERE is_read = 0 AND sender_id != ?
                ''', (user_id,))
                count += cursor.fetchone()[0]
            else:
                cursor.execute('SELECT COUNT(*) FROM container_messages WHERE is_read = 0')
                count += cursor.fetchone()[0]

        conn.close()

        return jsonify({'success': True, 'count': count})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'count': 0})


@app.route('/api/document-messages/mark-read', methods=['POST'])
@require_auth(['admin'])
def mark_messages_read():
    """–û—Ç–º–µ—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ."""
    try:
        data = request.json
        doc_type = data.get('doc_type')
        doc_id = data.get('doc_id')

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        if doc_type and doc_id:
            cursor.execute('''
                UPDATE document_messages SET is_read = 1
                WHERE doc_type = ? AND doc_id = ? AND sender_type = 'telegram'
            ''', (doc_type, doc_id))

        conn.commit()
        conn.close()

        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/warehouse/shipments')
@require_auth(['admin', 'viewer'])
def get_warehouse_shipments():
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –æ—Ç–≥—Ä—É–∑–∫–∏"""
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('''
            SELECT * FROM warehouse_shipments
            ORDER BY shipment_date DESC, created_at DESC
        ''')

        shipments = [dict(row) for row in cursor.fetchall()]
        conn.close()

        return jsonify({'success': True, 'shipments': shipments})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'shipments': []})


@app.route('/api/warehouse/shipments/save', methods=['POST'])
@require_auth(['admin'])
def save_warehouse_shipment():
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –æ—Ç–≥—Ä—É–∑–∫—É"""
    try:
        data = request.json
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        shipment_id = data.get('id', '')
        is_new = str(shipment_id).startswith('new_') or not shipment_id

        if is_new:
            cursor.execute('''
                INSERT INTO warehouse_shipments (sku, shipment_date, quantity, destination, comment, updated_at)
                VALUES (?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
            ''', (
                data.get('sku', 0),
                data.get('shipment_date', ''),
                data.get('quantity', 0),
                data.get('destination', ''),
                data.get('comment', '')
            ))
            new_id = cursor.lastrowid
        else:
            cursor.execute('''
                UPDATE warehouse_shipments SET
                    sku = ?, shipment_date = ?, quantity = ?, destination = ?, comment = ?, updated_at = CURRENT_TIMESTAMP
                WHERE id = ?
            ''', (
                data.get('sku', 0),
                data.get('shipment_date', ''),
                data.get('quantity', 0),
                data.get('destination', ''),
                data.get('comment', ''),
                int(shipment_id)
            ))
            new_id = int(shipment_id)

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'id': new_id})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/warehouse/shipments/delete', methods=['POST'])
@require_auth(['admin'])
def delete_warehouse_shipment():
    """–£–¥–∞–ª–∏—Ç—å –æ—Ç–≥—Ä—É–∑–∫—É"""
    try:
        data = request.json
        shipment_id = data.get('id')

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute('DELETE FROM warehouse_shipments WHERE id = ?', (shipment_id,))
        conn.commit()
        conn.close()

        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


# ============================================================================
# API –°–ü–†–ê–í–û–ß–ù–ò–ö–ê –ù–ê–ó–ù–ê–ß–ï–ù–ò–ô –û–¢–ì–†–£–ó–û–ö
# ============================================================================

@app.route('/api/warehouse/destinations')
@require_auth(['admin', 'viewer'])
def get_destinations():
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π –æ—Ç–≥—Ä—É–∑–æ–∫.
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute('SELECT id, name, is_default FROM shipment_destinations ORDER BY is_default DESC, name')
        rows = cursor.fetchall()
        destinations = [{'id': r[0], 'name': r[1], 'is_default': bool(r[2])} for r in rows]
        return jsonify({'success': True, 'destinations': destinations})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/warehouse/destinations/add', methods=['POST'])
@require_auth(['admin'])
def add_destination():
    """
    –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫.
    """
    try:
        data = request.get_json()
        name = (data.get('name') or '').strip()

        if not name:
            return jsonify({'success': False, 'error': '–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'})

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
        cursor.execute('SELECT id FROM shipment_destinations WHERE name = ?', (name,))
        existing = cursor.fetchone()
        if existing:
            return jsonify({'success': True, 'message': '–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'id': existing[0]})

        cursor.execute('INSERT INTO shipment_destinations (name, is_default) VALUES (?, 0)', (name,))
        conn.commit()

        return jsonify({'success': True, 'id': cursor.lastrowid, 'message': '–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/warehouse/destinations/delete', methods=['POST'])
@require_auth(['admin'])
def delete_destination():
    """
    –£–¥–∞–ª–∏—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ (—Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ).
    """
    try:
        data = request.get_json()
        dest_id = data.get('id')

        if not dest_id:
            return jsonify({'success': False, 'error': 'ID –Ω–µ —É–∫–∞–∑–∞–Ω'})

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –ù–µ —É–¥–∞–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
        cursor.execute('DELETE FROM shipment_destinations WHERE id = ? AND is_default = 0', (dest_id,))
        conn.commit()

        if cursor.rowcount == 0:
            return jsonify({'success': False, 'error': '–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ –∑–∞—â–∏—â–µ–Ω–æ –æ—Ç —É–¥–∞–ª–µ–Ω–∏—è'})

        return jsonify({'success': True, 'message': '–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


# ============================================================================
# API –î–û–ö–£–ú–ï–ù–¢–û–í –û–¢–ì–†–£–ó–û–ö (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç —Å —à–∞–ø–∫–æ–π –∏ –ø–æ–∑–∏—Ü–∏—è–º–∏)
# ============================================================================

@app.route('/api/warehouse/shipment-docs')
@require_auth(['admin', 'viewer'])
def get_shipment_docs():
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –æ—Ç–≥—Ä—É–∑–æ–∫ —Å –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('''
            SELECT
                d.id,
                d.shipment_datetime,
                d.destination,
                d.comment,
                d.created_by,
                d.updated_by,
                d.created_at,
                d.updated_at,
                d.is_completed,
                COUNT(s.id) as items_count,
                COALESCE(SUM(s.quantity), 0) as total_qty
            FROM warehouse_shipment_docs d
            LEFT JOIN warehouse_shipments s ON s.doc_id = d.id
            GROUP BY d.id
            ORDER BY d.shipment_datetime DESC, d.created_at DESC
        ''')

        docs = [dict(row) for row in cursor.fetchall()]
        conn.close()

        return jsonify({'success': True, 'docs': docs})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'docs': []})


@app.route('/api/warehouse/shipment-docs/<int:doc_id>')
@require_auth(['admin', 'viewer'])
def get_shipment_doc(doc_id):
    """
    –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ–∫—É–º–µ–Ω—Ç–µ –æ—Ç–≥—Ä—É–∑–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('''
            SELECT id, shipment_datetime, destination, comment, created_by, updated_by, created_at, updated_at, is_completed
            FROM warehouse_shipment_docs WHERE id = ?
        ''', (doc_id,))
        doc = cursor.fetchone()

        if not doc:
            conn.close()
            return jsonify({'success': False, 'error': '–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'})

        cursor.execute('''
            SELECT id, sku, quantity
            FROM warehouse_shipments WHERE doc_id = ?
        ''', (doc_id,))
        items = [dict(row) for row in cursor.fetchall()]
        conn.close()

        return jsonify({
            'success': True,
            'doc': dict(doc),
            'items': items
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/warehouse/shipments/save-doc', methods=['POST'])
@require_auth(['admin'])
def save_shipment_doc():
    """
    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –æ—Ç–≥—Ä—É–∑–∫–∏ —Å –ø–æ–∑–∏—Ü–∏—è–º–∏.
    """
    try:
        data = request.json
        doc_id = data.get('doc_id')
        destination = data.get('destination', '')
        comment = data.get('comment', '')
        items = data.get('items', [])
        # is_completed: 1 = –ø—Ä–æ–≤–µ–¥–µ–Ω–æ (–≤—ã—á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ –æ—Å—Ç–∞—Ç–∫–æ–≤), 0 = –Ω–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–æ (–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ)
        is_completed = 1 if data.get('is_completed', True) else 0

        if not items:
            return jsonify({'success': False, 'error': '–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä'})

        username = request.current_user.get('username', '') if hasattr(request, 'current_user') else ''

        from datetime import datetime
        now = datetime.now()
        shipment_datetime = now.strftime('%Y-%m-%dT%H:%M')
        shipment_date = now.strftime('%Y-%m-%d')

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # ========== –ü–†–û–í–ï–†–ö–ê –û–°–¢–ê–¢–ö–û–í –ü–†–ò –ü–†–û–í–ï–î–ï–ù–ò–ò ==========
        # –ï—Å–ª–∏ –æ—Ç–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è (is_completed=1), –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ
        if is_completed:
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –æ—Å—Ç–∞—Ç–∫–∏: –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–æ - –ø—Ä–æ–≤–µ–¥—ë–Ω–Ω—ã–µ –æ—Ç–≥—Ä—É–∑–∫–∏
            # –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏—Å–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç –∏–∑ —Ä–∞—Å—á—ë—Ç–∞
            exclude_doc_clause = f"AND d.id != {doc_id}" if doc_id else ""

            stock_errors = []
            for item in items:
                sku = item.get('sku')
                qty_needed = item.get('quantity', 0)

                # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–π
                cursor.execute('SELECT COALESCE(SUM(quantity), 0) as total FROM warehouse_receipts WHERE sku = ?', (sku,))
                total_received = cursor.fetchone()['total']

                # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≤–µ–¥—ë–Ω–Ω—ã—Ö –æ—Ç–≥—Ä—É–∑–æ–∫ (–∏—Å–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏)
                # –í–∫–ª—é—á–∞–µ–º: –±–µ–∑ doc_id, —Å is_completed = NULL, —Å is_completed = 1
                cursor.execute(f'''
                    SELECT COALESCE(SUM(s.quantity), 0) as total
                    FROM warehouse_shipments s
                    LEFT JOIN warehouse_shipment_docs d ON s.doc_id = d.id
                    WHERE s.sku = ?
                      AND (s.doc_id IS NULL OR d.is_completed IS NULL OR d.is_completed = 1)
                      {exclude_doc_clause}
                ''', (sku,))
                total_shipped = cursor.fetchone()['total']

                available = total_received - total_shipped

                if qty_needed > available:
                    # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
                    cursor.execute('SELECT name FROM products WHERE sku = ?', (sku,))
                    product = cursor.fetchone()
                    product_name = product['name'] if product else f'SKU {sku}'
                    stock_errors.append(f'{product_name}: –Ω—É–∂–Ω–æ {qty_needed}, –¥–æ—Å—Ç—É–ø–Ω–æ {available}')

            if stock_errors:
                conn.close()
                return jsonify({
                    'success': False,
                    'error': '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ:\n' + '\n'.join(stock_errors)
                })

        if doc_id:
            cursor.execute('''
                UPDATE warehouse_shipment_docs
                SET destination = ?, comment = ?, is_completed = ?, updated_by = ?, updated_at = CURRENT_TIMESTAMP
                WHERE id = ?
            ''', (destination, comment, is_completed, username, doc_id))

            cursor.execute('DELETE FROM warehouse_shipments WHERE doc_id = ?', (doc_id,))
        else:
            cursor.execute('''
                INSERT INTO warehouse_shipment_docs (shipment_datetime, destination, comment, is_completed, created_by, updated_by, updated_at)
                VALUES (?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
            ''', (shipment_datetime, destination, comment, is_completed, username, username))
            doc_id = cursor.lastrowid

        for item in items:
            cursor.execute('''
                INSERT INTO warehouse_shipments (doc_id, sku, shipment_date, quantity, destination, updated_at)
                VALUES (?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
            ''', (
                doc_id,
                item.get('sku', 0),
                shipment_date,
                item.get('quantity', 0),
                destination
            ))

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'doc_id': doc_id})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/warehouse/shipment-docs/delete', methods=['POST'])
@require_auth(['admin'])
def delete_shipment_doc():
    """
    –£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –æ—Ç–≥—Ä—É–∑–∫–∏ –≤–º–µ—Å—Ç–µ —Å–æ –≤—Å–µ–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏.
    """
    try:
        data = request.json
        doc_id = data.get('id')

        if not doc_id:
            return jsonify({'success': False, 'error': '–ù–µ —É–∫–∞–∑–∞–Ω ID –¥–æ–∫—É–º–µ–Ω—Ç–∞'})

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        cursor.execute('DELETE FROM warehouse_shipments WHERE doc_id = ?', (doc_id,))
        cursor.execute('DELETE FROM warehouse_shipment_docs WHERE id = ?', (doc_id,))

        conn.commit()
        conn.close()

        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/warehouse/stock')
@require_auth(['admin', 'viewer'])
def get_warehouse_stock():
    """
    –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –æ—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ.

    –†–∞—Å—á—ë—Ç: –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–æ - –æ—Ç–≥—Ä—É–∂–µ–Ω–æ = –æ—Å—Ç–∞—Ç–æ–∫
    –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É.
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º —Å—É–º–º—É –æ–ø—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–π –∏ —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—É—é —Ü–µ–Ω—É –ø–æ –∫–∞–∂–¥–æ–º—É SKU
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º calculated_cost (—Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å +6% –∏–∑ –ø–æ—Å—Ç–∞–≤–æ–∫) –µ—Å–ª–∏ –µ—Å—Ç—å,
        # –∏–Ω–∞—á–µ purchase_price (—Ä—É—á–Ω–∞—è —Ü–µ–Ω–∞)
        cursor.execute('''
            SELECT
                sku,
                SUM(quantity) as total_received,
                CASE WHEN SUM(quantity) > 0
                    THEN SUM(quantity * COALESCE(NULLIF(calculated_cost, 0), purchase_price)) / SUM(quantity)
                    ELSE 0
                END as avg_purchase_price
            FROM warehouse_receipts
            GROUP BY sku
        ''')
        receipts_data = {row['sku']: dict(row) for row in cursor.fetchall()}

        # –ü–æ–ª—É—á–∞–µ–º —Å—É–º–º—É –ø—Ä–æ–≤–µ–¥—ë–Ω–Ω—ã—Ö –æ—Ç–≥—Ä—É–∑–æ–∫ –ø–æ –∫–∞–∂–¥–æ–º—É SKU
        # –í–∫–ª—é—á–∞–µ–º:
        # - –û—Ç–≥—Ä—É–∑–∫–∏ —Å is_completed = 1 (—è–≤–Ω–æ –ø—Ä–æ–≤–µ–¥—ë–Ω–Ω—ã–µ)
        # - –û—Ç–≥—Ä—É–∑–∫–∏ –±–µ–∑ doc_id (—Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏, –¥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)
        # - –û—Ç–≥—Ä—É–∑–∫–∏ —Å is_completed = NULL (—Å–æ–∑–¥–∞–Ω—ã –¥–æ –º–∏–≥—Ä–∞—Ü–∏–∏)
        cursor.execute('''
            SELECT s.sku, SUM(s.quantity) as total_shipped
            FROM warehouse_shipments s
            LEFT JOIN warehouse_shipment_docs d ON s.doc_id = d.id
            WHERE s.doc_id IS NULL
               OR d.is_completed IS NULL
               OR d.is_completed = 1
            GROUP BY s.sku
        ''')
        shipments_data = {row['sku']: row['total_shipped'] for row in cursor.fetchall()}

        # –ü–æ–ª—É—á–∞–µ–º —Å—É–º–º—É –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ (—Ç–æ–ª—å–∫–æ —è–≤–Ω–æ –Ω–µ –ø—Ä–æ–≤–µ–¥—ë–Ω–Ω—ã–µ –æ—Ç–≥—Ä—É–∑–∫–∏)
        # is_completed = 0 –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ —Ç–æ–≤–∞—Ä –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω, –Ω–æ –µ—â—ë –Ω–µ —Å–ø–∏—Å–∞–Ω
        cursor.execute('''
            SELECT s.sku, SUM(s.quantity) as total_reserved
            FROM warehouse_shipments s
            JOIN warehouse_shipment_docs d ON s.doc_id = d.id
            WHERE d.is_completed = 0
            GROUP BY s.sku
        ''')
        reserved_data = {row['sku']: row['total_reserved'] for row in cursor.fetchall()}

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–∞—Ö
        cursor.execute('''
            SELECT sku, name, offer_id FROM products
        ''')
        products_data = {row['sku']: {'name': row['name'], 'offer_id': row['offer_id']} for row in cursor.fetchall()}

        conn.close()

        # –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        stock = []
        all_skus = set(receipts_data.keys()) | set(shipments_data.keys()) | set(reserved_data.keys())

        for sku in all_skus:
            receipt_info = receipts_data.get(sku, {'total_received': 0, 'avg_purchase_price': 0})
            shipped = shipments_data.get(sku, 0)
            reserved = reserved_data.get(sku, 0)
            product_info = products_data.get(sku, {'name': '', 'offer_id': ''})

            total_received = receipt_info['total_received'] or 0
            avg_price = receipt_info['avg_purchase_price'] or 0
            stock_balance = total_received - shipped

            stock.append({
                'sku': sku,
                'product_name': product_info['name'],
                'offer_id': product_info['offer_id'],
                'total_received': total_received,
                'total_shipped': shipped,
                'reserved': reserved,
                'stock_balance': stock_balance,
                'avg_purchase_price': avg_price
            })

        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –æ—Å—Ç–∞—Ç–∫—É (–æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É)
        stock.sort(key=lambda x: -x['stock_balance'])

        return jsonify({'success': True, 'stock': stock})
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e), 'stock': []})


# ============================================================================
# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ‚Äî –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –†–ê–°–•–û–î–û–í –ü–û –ö–û–ù–¢–ï–ô–ù–ï–†–ê–ú
# ============================================================================
# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –æ—Ç–∫–∞—Ç–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤
# –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º –í–≠–î. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ API –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π.
# ============================================================================


def _create_finance_distribution_notification(cursor, finance_record_id, amount, category_name, description, created_by, record_date):
    """
    –°–æ–∑–¥–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º.

    –í—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ document_messages (doc_type='finance_distribution')
    –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º.

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        cursor: –∫—É—Ä—Å–æ—Ä SQLite (INSERT –±–µ–∑ COMMIT ‚Äî –∫–æ–º–º–∏—Ç –¥–µ–ª–∞–µ—Ç –≤—ã–∑—ã–≤–∞—é—â–∏–π –∫–æ–¥)
        finance_record_id (int): ID —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
        amount (float): —Å—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–∞
        category_name (str): –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        description (str): –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞
        created_by (str): –∫—Ç–æ —Å–æ–∑–¥–∞–ª –∑–∞–ø–∏—Å—å
        record_date (str): –¥–∞—Ç–∞ –∑–∞–ø–∏—Å–∏ (—Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD)
    """
    # –¢–µ–∫—Å—Ç –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –°–æ–æ–±—â–µ–Ω–∏—è—Ö (–∫–æ—Ä–æ—Ç–∫–∏–π)
    message = f'–†–∞—Å—Ö–æ–¥ {amount:,.0f} ‚ÇΩ ‚Äî –∫–∞—Ç–µ–≥–æ—Ä–∏—è \"{category_name}\"'
    if description:
        message += f' ({description})'
    message += ' ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º'

    cursor.execute('''
        INSERT INTO document_messages (doc_type, doc_id, message, sender_type, sender_name, is_read)
        VALUES ('finance_distribution', ?, ?, 'system', '–°–∏—Å—Ç–µ–º–∞', 0)
    ''', (finance_record_id, message))

    # Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫)
    try:
        amount_fmt = f'{amount:,.0f}'.replace(',', ' ')
        tg_text = (
            f'üì¶ <b>–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º</b>\n\n'
            f'üí∞ –†–∞—Å—Ö–æ–¥: {amount_fmt} ‚ÇΩ\n'
            f'üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category_name}\n'
        )
        if description:
            tg_text += f'üìù –û–ø–∏—Å–∞–Ω–∏–µ: {description}\n'
        tg_text += f'üë§ –°–æ–∑–¥–∞–ª: {created_by}\n'
        tg_text += f'üìÖ –î–∞—Ç–∞: {record_date}\n\n'
        tg_text += '–û—Ç–∫—Ä–æ–π—Ç–µ –§–∏–Ω–∞–Ω—Å—ã ‚Üí –î–î–° –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.'
        send_admin_notification(tg_text)
    except Exception as e:
        print(f'‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏: {e}')


def _delete_finance_distribution_notification(cursor, finance_record_id):
    """
    –£–¥–∞–ª–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –¥–ª—è –¥–∞–Ω–Ω–æ–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏.
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –∏–ª–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞ –Ω–µ-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—É—é.

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        cursor: –∫—É—Ä—Å–æ—Ä SQLite
        finance_record_id (int): ID —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
    """
    cursor.execute('''
        DELETE FROM document_messages
        WHERE doc_type = 'finance_distribution' AND doc_id = ?
    ''', (finance_record_id,))


def _mark_finance_distribution_notification_read(cursor, finance_record_id):
    """
    –ü–æ–º–µ—Ç–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ (—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ).
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ _save_finance_distributions() –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        cursor: –∫—É—Ä—Å–æ—Ä SQLite
        finance_record_id (int): ID —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
    """
    cursor.execute('''
        UPDATE document_messages SET is_read = 1
        WHERE doc_type = 'finance_distribution' AND doc_id = ? AND is_read = 0
    ''', (finance_record_id,))


# ============================================================================
# –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –û –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ò –ü–û –ü–õ–ê–ù–£ –ó–ê–ö–£–ü–û–ö
# ============================================================================
# –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–≤—ã—à–µ), –Ω–æ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
# —Å is_plan_linked=1 –∏ —Å—É–º–º–æ–π –≤ —é–∞–Ω—è—Ö, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ —Ä–∞—Å–∫–∏–¥–∞—Ç—å –ø–æ —Å—Ç—Ä–æ–∫–∞–º –ø–ª–∞–Ω–∞.
# ============================================================================


def _create_finance_plan_distribution_notification(cursor, finance_record_id, yuan_amount, rub_amount, category_name, description, created_by, record_date):
    """
    –°–æ–∑–¥–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ –ø–æ –ø–ª–∞–Ω—É –∑–∞–∫—É–ø–æ–∫.

    –í—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ document_messages (doc_type='finance_plan_distribution')
    –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º.

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        cursor: –∫—É—Ä—Å–æ—Ä SQLite (INSERT –±–µ–∑ COMMIT ‚Äî –∫–æ–º–º–∏—Ç –¥–µ–ª–∞–µ—Ç –≤—ã–∑—ã–≤–∞—é—â–∏–π –∫–æ–¥)
        finance_record_id (int): ID —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
        yuan_amount (float): —Å—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–∞ –≤ —é–∞–Ω—è—Ö
        rub_amount (float): —Å—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–∞ –≤ —Ä—É–±–ª—è—Ö
        category_name (str): –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        description (str): –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞
        created_by (str): –∫—Ç–æ —Å–æ–∑–¥–∞–ª –∑–∞–ø–∏—Å—å
        record_date (str): –¥–∞—Ç–∞ –∑–∞–ø–∏—Å–∏ (—Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD)
    """
    # –¢–µ–∫—Å—Ç –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –°–æ–æ–±—â–µ–Ω–∏—è—Ö (–∫–æ—Ä–æ—Ç–∫–∏–π)
    yuan_fmt_msg = f'{yuan_amount:,.2f}'.replace(',', ' ')
    rub_fmt_msg = f'{rub_amount:,.0f}'.replace(',', ' ')
    message = f'–†–∞—Å—Ö–æ–¥ {yuan_fmt_msg} ¬• ({rub_fmt_msg} ‚ÇΩ) ‚Äî –∫–∞—Ç–µ–≥–æ—Ä–∏—è "{category_name}"'
    if description:
        message += f' ({description})'
    message += ' ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø–ª–∞–Ω—É –∑–∞–∫—É–ø–æ–∫'

    cursor.execute('''
        INSERT INTO document_messages (doc_type, doc_id, message, sender_type, sender_name, is_read)
        VALUES ('finance_plan_distribution', ?, ?, 'system', '–°–∏—Å—Ç–µ–º–∞', 0)
    ''', (finance_record_id, message))

    # Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫)
    try:
        yuan_fmt = f'{yuan_amount:,.2f}'.replace(',', ' ')
        rub_fmt = f'{rub_amount:,.0f}'.replace(',', ' ')
        tg_text = (
            f'üìã <b>–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø–ª–∞–Ω—É –∑–∞–∫—É–ø–æ–∫</b>\n\n'
            f'üí∞ –†–∞—Å—Ö–æ–¥: {yuan_fmt} ¬• ({rub_fmt} ‚ÇΩ)\n'
            f'üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category_name}\n'
        )
        if description:
            tg_text += f'üìù –û–ø–∏—Å–∞–Ω–∏–µ: {description}\n'
        tg_text += f'üë§ –°–æ–∑–¥–∞–ª: {created_by}\n'
        tg_text += f'üìÖ –î–∞—Ç–∞: {record_date}\n\n'
        tg_text += '–û—Ç–∫—Ä–æ–π—Ç–µ –§–∏–Ω–∞–Ω—Å—ã ‚Üí –î–î–° –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –ø–ª–∞–Ω—É.'
        send_admin_notification(tg_text)
    except Exception as e:
        print(f'‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –ø–æ –ø–ª–∞–Ω—É: {e}')


def _delete_finance_plan_distribution_notification(cursor, finance_record_id):
    """
    –£–¥–∞–ª–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –ø–æ –ø–ª–∞–Ω—É –¥–ª—è –¥–∞–Ω–Ω–æ–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏.
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –∏–ª–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞ –Ω–µ-plan-linked.

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        cursor: –∫—É—Ä—Å–æ—Ä SQLite
        finance_record_id (int): ID —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
    """
    cursor.execute('''
        DELETE FROM document_messages
        WHERE doc_type = 'finance_plan_distribution' AND doc_id = ?
    ''', (finance_record_id,))


def _mark_finance_plan_distribution_notification_read(cursor, finance_record_id):
    """
    –ü–æ–º–µ—Ç–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ (—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø–ª–∞–Ω—É –≤—ã–ø–æ–ª–Ω–µ–Ω–æ).
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ _save_finance_plan_distributions() –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        cursor: –∫—É—Ä—Å–æ—Ä SQLite
        finance_record_id (int): ID —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
    """
    cursor.execute('''
        UPDATE document_messages SET is_read = 1
        WHERE doc_type = 'finance_plan_distribution' AND doc_id = ? AND is_read = 0
    ''', (finance_record_id,))


def _save_finance_distributions(cursor, finance_record_id, distributions, expected_amount):
    """
    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º.
    –í—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ finance_container_distributions –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç
    —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è (logistics_rf/cn, terminal, customs) –≤ ved_container_items.

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        cursor: –∫—É—Ä—Å–æ—Ä SQLite
        finance_record_id (int): ID —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
        distributions (list): —Å–ø–∏—Å–æ–∫ dict {container_doc_id, sku, cost_type, amount}
        expected_amount (float): –æ–∂–∏–¥–∞–µ–º–∞—è –æ–±—â–∞—è —Å—É–º–º–∞ (–¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏)
    """
    if not distributions:
        return

    # –í–∞–ª–∏–¥–∞—Ü–∏—è: —Å—É–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –¥–æ–ª–∂–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Å—É–º–º–æ–π –∑–∞–ø–∏—Å–∏
    total_dist = sum(float(d.get('amount', 0)) for d in distributions)
    if abs(total_dist - expected_amount) > 0.01:
        raise ValueError(
            f'–°—É–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π ({total_dist:.2f}) –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Å—É–º–º–æ–π –∑–∞–ø–∏—Å–∏ ({expected_amount:.2f})'
        )

    valid_cost_types = ('logistics_rf', 'logistics_cn', 'terminal', 'customs')

    for dist in distributions:
        container_doc_id = dist.get('container_doc_id')
        sku = str(dist.get('sku', ''))
        cost_type = dist.get('cost_type', '')
        amount = float(dist.get('amount', 0))

        if amount <= 0:
            continue

        if cost_type not in valid_cost_types:
            raise ValueError(f'–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –∑–∞—Ç—Ä–∞—Ç: {cost_type}')

        # –í—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
        cursor.execute('''
            INSERT INTO finance_container_distributions
            (finance_record_id, container_doc_id, sku, cost_type, amount)
            VALUES (?, ?, ?, ?, ?)
        ''', (finance_record_id, container_doc_id, sku, cost_type, amount))

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ –≤ –ø–æ–∑–∏—Ü–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        # cost_type —É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ SQL
        cursor.execute(f'''
            UPDATE ved_container_items
            SET {cost_type} = COALESCE({cost_type}, 0) + ?,
                updated_at = CURRENT_TIMESTAMP
            WHERE doc_id = ? AND sku = ?
        ''', (amount, container_doc_id, sku))

    # –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ‚Äî –ø–æ–º–µ—á–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
    _mark_finance_distribution_notification_read(cursor, finance_record_id)


def _rollback_finance_distributions(cursor, finance_record_id):
    """
    –û—Ç–∫–∞—Ç–∏—Ç—å (–≤—ã—á–µ—Å—Ç—å) –≤—Å–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª—è –¥–∞–Ω–Ω–æ–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
    –∏–∑ –ø–æ–ª–µ–π ved_container_items, –∑–∞—Ç–µ–º —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π.

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        cursor: –∫—É—Ä—Å–æ—Ä SQLite
        finance_record_id (int): ID —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
    """
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏
    cursor.execute('''
        SELECT container_doc_id, sku, cost_type, amount
        FROM finance_container_distributions
        WHERE finance_record_id = ?
    ''', (finance_record_id,))
    old_dists = cursor.fetchall()

    # –í—ã—á–∏—Ç–∞–µ–º —Å—É–º–º—ã –∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª–µ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
    for dist in old_dists:
        cost_type = dist['cost_type'] if hasattr(dist, '__getitem__') and isinstance(dist, sqlite3.Row) else dist[2]
        container_doc_id = dist['container_doc_id'] if hasattr(dist, '__getitem__') and isinstance(dist, sqlite3.Row) else dist[0]
        sku = dist['sku'] if hasattr(dist, '__getitem__') and isinstance(dist, sqlite3.Row) else dist[1]
        amount = dist['amount'] if hasattr(dist, '__getitem__') and isinstance(dist, sqlite3.Row) else dist[3]

        if cost_type in ('logistics_rf', 'logistics_cn', 'terminal', 'customs'):
            cursor.execute(f'''
                UPDATE ved_container_items
                SET {cost_type} = MAX(COALESCE({cost_type}, 0) - ?, 0),
                    updated_at = CURRENT_TIMESTAMP
                WHERE doc_id = ? AND sku = ?
            ''', (amount, container_doc_id, sku))

    # –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π
    cursor.execute('DELETE FROM finance_container_distributions WHERE finance_record_id = ?',
                   (finance_record_id,))


def _save_finance_plan_distributions(cursor, finance_record_id, plan_distributions, expected_yuan):
    """
    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ –ø–æ —Å—Ç—Ä–æ–∫–∞–º –ø–ª–∞–Ω–∞ –∑–∞–∫—É–ø–æ–∫.
    –í—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ finance_plan_distributions –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç
    —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è (paid_invoice_yuan/rub –∏–ª–∏ paid_delta_yuan/rub) –≤ plan_items.

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        cursor: –∫—É—Ä—Å–æ—Ä SQLite
        finance_record_id (int): ID —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
        plan_distributions (list): —Å–ø–∏—Å–æ–∫ dict {plan_item_id, target_type, yuan_amount, rub_amount}
        expected_yuan (float): –æ–∂–∏–¥–∞–µ–º–∞—è –æ–±—â–∞—è —Å—É–º–º–∞ —é–∞–Ω–µ–π (–¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏)
    """
    if not plan_distributions:
        return

    # –í–∞–ª–∏–¥–∞—Ü–∏—è: —Å—É–º–º–∞ —é–∞–Ω–µ–π —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –¥–æ–ª–∂–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å yuan_amount –∑–∞–ø–∏—Å–∏
    total_yuan = sum(float(d.get('yuan_amount', 0)) for d in plan_distributions)
    if abs(total_yuan - expected_yuan) > 0.01:
        raise ValueError(
            f'–°—É–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –ø–æ –ø–ª–∞–Ω—É ({total_yuan:.2f} ¬•) –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç '
            f'—Å —Å—É–º–º–æ–π –≤ —é–∞–Ω—è—Ö –∑–∞–ø–∏—Å–∏ ({expected_yuan:.2f} ¬•)'
        )

    valid_target_types = ('invoice', 'delta')

    for dist in plan_distributions:
        plan_item_id = dist.get('plan_item_id')
        target_type = dist.get('target_type', '')
        yuan_amt = float(dist.get('yuan_amount', 0))
        rub_amt = float(dist.get('rub_amount', 0))

        if yuan_amt <= 0:
            continue

        if target_type not in valid_target_types:
            raise ValueError(f'–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è: {target_type}')

        # –í—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
        cursor.execute('''
            INSERT INTO finance_plan_distributions
            (finance_record_id, plan_item_id, target_type, yuan_amount, rub_amount)
            VALUES (?, ?, ?, ?, ?)
        ''', (finance_record_id, plan_item_id, target_type, yuan_amt, rub_amt))

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è –≤ —Å—Ç—Ä–æ–∫–µ –ø–ª–∞–Ω–∞
        if target_type == 'invoice':
            cursor.execute('''
                UPDATE plan_items
                SET paid_invoice_yuan = COALESCE(paid_invoice_yuan, 0) + ?,
                    paid_invoice_rub = COALESCE(paid_invoice_rub, 0) + ?,
                    updated_at = CURRENT_TIMESTAMP
                WHERE id = ?
            ''', (yuan_amt, rub_amt, plan_item_id))
        elif target_type == 'delta':
            cursor.execute('''
                UPDATE plan_items
                SET paid_delta_yuan = COALESCE(paid_delta_yuan, 0) + ?,
                    paid_delta_rub = COALESCE(paid_delta_rub, 0) + ?,
                    updated_at = CURRENT_TIMESTAMP
                WHERE id = ?
            ''', (yuan_amt, rub_amt, plan_item_id))

    # –ü–æ–º–µ—á–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ (—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø–ª–∞–Ω—É –≤—ã–ø–æ–ª–Ω–µ–Ω–æ)
    _mark_finance_plan_distribution_notification_read(cursor, finance_record_id)


def _rollback_finance_plan_distributions(cursor, finance_record_id):
    """
    –û—Ç–∫–∞—Ç–∏—Ç—å (–≤—ã—á–µ—Å—Ç—å) –≤—Å–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –ø–ª–∞–Ω—É –¥–ª—è –¥–∞–Ω–Ω–æ–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
    –∏–∑ –ø–æ–ª–µ–π plan_items, –∑–∞—Ç–µ–º —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π.

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        cursor: –∫—É—Ä—Å–æ—Ä SQLite
        finance_record_id (int): ID —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
    """
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –ø–ª–∞–Ω—É –¥–ª—è —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏
    cursor.execute('''
        SELECT plan_item_id, target_type, yuan_amount, rub_amount
        FROM finance_plan_distributions
        WHERE finance_record_id = ?
    ''', (finance_record_id,))
    old_dists = cursor.fetchall()

    # –í—ã—á–∏—Ç–∞–µ–º —Å—É–º–º—ã –∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª–µ–π —Å—Ç—Ä–æ–∫ –ø–ª–∞–Ω–∞
    for dist in old_dists:
        # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ sqlite3.Row –∏ –æ–±—ã—á–Ω—ã—Ö –∫–æ—Ä—Ç–µ–∂–µ–π
        if hasattr(dist, 'keys'):
            plan_item_id = dist['plan_item_id']
            target_type = dist['target_type']
            yuan_amt = dist['yuan_amount']
            rub_amt = dist['rub_amount']
        else:
            plan_item_id = dist[0]
            target_type = dist[1]
            yuan_amt = dist[2]
            rub_amt = dist[3]

        if target_type == 'invoice':
            cursor.execute('''
                UPDATE plan_items
                SET paid_invoice_yuan = MAX(COALESCE(paid_invoice_yuan, 0) - ?, 0),
                    paid_invoice_rub = MAX(COALESCE(paid_invoice_rub, 0) - ?, 0),
                    updated_at = CURRENT_TIMESTAMP
                WHERE id = ?
            ''', (yuan_amt, rub_amt, plan_item_id))
        elif target_type == 'delta':
            cursor.execute('''
                UPDATE plan_items
                SET paid_delta_yuan = MAX(COALESCE(paid_delta_yuan, 0) - ?, 0),
                    paid_delta_rub = MAX(COALESCE(paid_delta_rub, 0) - ?, 0),
                    updated_at = CURRENT_TIMESTAMP
                WHERE id = ?
            ''', (yuan_amt, rub_amt, plan_item_id))

    # –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π
    cursor.execute('DELETE FROM finance_plan_distributions WHERE finance_record_id = ?',
                   (finance_record_id,))


# ============================================================================
# API –§–ò–ù–ê–ù–°–´ ‚Äî –°–ü–†–ê–í–û–ß–ù–ò–ö –°–ß–ï–¢–û–í
# ============================================================================
# –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ —Å—á–µ—Ç–∞–º–∏/–∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ —Å—Ä–µ–¥—Å—Ç–≤.
# –°—á–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–∞–∫ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ, —Ç–∞–∫ –∏ –≤ Telegram-–±–æ—Ç–µ
# –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–ª–∏ / –∫—É–¥–∞ —É—à–ª–∏ –¥–µ–Ω—å–≥–∏.
# ============================================================================

@app.route('/api/finance/accounts')
@require_auth(['admin', 'viewer'])
def api_finance_accounts():
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Å—á–µ—Ç–æ–≤.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {'success': True, 'accounts': [{'id': 1, 'name': '–û–û–û', 'is_default': True}, ...]}
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
        cursor.execute('SELECT id, name, is_default, COALESCE(requires_official, 0) as requires_official, created_at FROM finance_accounts ORDER BY is_default DESC, name ASC')
        rows = cursor.fetchall()
        accounts = [{'id': r['id'], 'name': r['name'], 'is_default': bool(r['is_default']), 'requires_official': r['requires_official'] or 0, 'created_at': r['created_at']} for r in rows]
        conn.close()
        return jsonify({'success': True, 'accounts': accounts})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/finance/accounts/add', methods=['POST'])
@require_auth(['admin'])
def api_finance_accounts_add():
    """
    –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å—á—ë—Ç.
    Payload: {'name': '–ù–æ–≤—ã–π —Å—á—ë—Ç'}
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∏–º–µ–Ω–∏ (–±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞).
    """
    try:
        data = request.json
        name = (data.get('name') or '').strip()

        if not name:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—á—ë—Ç–∞'}), 400

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å (–±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞)
        cursor.execute('SELECT id FROM finance_accounts WHERE LOWER(name) = LOWER(?)', (name,))
        if cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'error': f'–°—á—ë—Ç "{name}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'}), 400

        # –§–ª–∞–≥ ¬´–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥¬ª ‚Äî –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–∞—Å—Ö–æ–¥–∞ —Å —ç—Ç–æ–≥–æ —Å—á—ë—Ç–∞ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –î–∞/–ù–µ—Ç
        requires_official = 1 if data.get('requires_official') else 0

        cursor.execute('INSERT INTO finance_accounts (name, is_default, requires_official) VALUES (?, 0, ?)', (name, requires_official))
        conn.commit()
        new_id = cursor.lastrowid
        conn.close()

        return jsonify({'success': True, 'id': new_id, 'message': f'–°—á—ë—Ç "{name}" –¥–æ–±–∞–≤–ª–µ–Ω'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/finance/accounts/delete', methods=['POST'])
@require_auth(['admin'])
def api_finance_accounts_delete():
    """
    –£–¥–∞–ª–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å—á—ë—Ç.
    Payload: {'id': 5}
    –ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –ª—é–±–æ–π —Å—á—ë—Ç, –µ—Å–ª–∏ –∫ –Ω–µ–º—É –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏.
    """
    try:
        data = request.json
        account_id = data.get('id')

        if not account_id:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ ID —Å—á—ë—Ç–∞'}), 400

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å—á—ë—Ç–∞
        cursor.execute('SELECT is_default, name FROM finance_accounts WHERE id = ?', (account_id,))
        row = cursor.fetchone()
        if not row:
            conn.close()
            return jsonify({'success': False, 'error': '–°—á—ë—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
        cursor.execute('SELECT COUNT(*) FROM finance_records WHERE account_id = ?', (account_id,))
        count = cursor.fetchone()[0]
        if count > 0:
            conn.close()
            return jsonify({'success': False, 'error': f'–°—á—ë—Ç "{row[1]}" –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ {count} –∑–∞–ø–∏—Å—è—Ö. –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.'}), 400

        cursor.execute('DELETE FROM finance_accounts WHERE id = ?', (account_id,))
        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': '–°—á—ë—Ç —É–¥–∞–ª—ë–Ω'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/finance/accounts/rename', methods=['POST'])
@require_auth(['admin'])
def api_finance_accounts_rename():
    """
    –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å—á—ë—Ç.
    Payload: {'id': 5, 'new_name': '–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'}
    –û–±–Ω–æ–≤–ª—è–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ finance_accounts –∏ –≤–æ –≤—Å–µ—Ö –∑–∞–ø–∏—Å—è—Ö finance_records
    (–ø–æ–ª–µ account_name), —á—Ç–æ–±—ã –∏—Å—Ç–æ—Ä–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ.
    """
    try:
        data = request.json
        account_id = data.get('id')
        new_name = (data.get('new_name') or '').strip()

        if not account_id:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ ID —Å—á—ë—Ç–∞'}), 400
        if not new_name:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'}), 400

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å—á—ë—Ç–∞
        cursor.execute('SELECT name FROM finance_accounts WHERE id = ?', (account_id,))
        row = cursor.fetchone()
        if not row:
            conn.close()
            return jsonify({'success': False, 'error': '–°—á—ë—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404

        old_name = row[0]

        # –ï—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        if old_name == new_name:
            conn.close()
            return jsonify({'success': True, 'message': '–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å'})

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –Ω–æ–≤–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è (–±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞)
        cursor.execute(
            'SELECT id FROM finance_accounts WHERE LOWER(name) = LOWER(?) AND id != ?',
            (new_name, account_id)
        )
        if cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'error': f'–°—á—ë—Ç —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º "{new_name}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'}), 400

        # –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ —Å—á–µ—Ç–æ–≤
        cursor.execute('UPDATE finance_accounts SET name = ? WHERE id = ?', (new_name, account_id))

        # –û–±–Ω–æ–≤–ª—è–µ–º account_name –≤–æ –≤—Å–µ—Ö –∑–∞–ø–∏—Å—è—Ö –∏—Å—Ç–æ—Ä–∏–∏ —Å —ç—Ç–∏–º account_id
        cursor.execute(
            'UPDATE finance_records SET account_name = ? WHERE account_id = ?',
            (new_name, account_id)
        )
        updated_records = cursor.rowcount

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': f'–°—á—ë—Ç –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω: ¬´{old_name}¬ª ‚Üí ¬´{new_name}¬ª. –û–±–Ω–æ–≤–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: {updated_records}'
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/finance/accounts/update', methods=['POST'])
@require_auth(['admin'])
def api_finance_accounts_update():
    """
    –û–±–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Å—á—ë—Ç–∞ (requires_official –∏ –¥—Ä.).
    Payload: {'id': 5, 'requires_official': true}
    """
    try:
        data = request.json
        account_id = data.get('id')

        if not account_id:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ ID —Å—á—ë—Ç–∞'}), 400

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        cursor.execute('SELECT id FROM finance_accounts WHERE id = ?', (account_id,))
        if not cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'error': '–°—á—ë—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404

        updates = []
        params = []

        # requires_official ‚Äî —Ç—Ä–µ–±—É–µ—Ç –ø–æ–º–µ—Ç–∫–∏ ¬´–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥¬ª
        if 'requires_official' in data:
            requires_official = 1 if data.get('requires_official') else 0
            updates.append('requires_official = ?')
            params.append(requires_official)

        if not updates:
            conn.close()
            return jsonify({'success': True, 'message': '–ù–µ—á–µ–≥–æ –æ–±–Ω–æ–≤–ª—è—Ç—å'})

        params.append(account_id)
        cursor.execute(f'UPDATE finance_accounts SET {", ".join(updates)} WHERE id = ?', params)
        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': '–°—á—ë—Ç –æ–±–Ω–æ–≤–ª—ë–Ω'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


# ============================================================================
# API –§–ò–ù–ê–ù–°–´ ‚Äî –°–ü–†–ê–í–û–ß–ù–ò–ö –ö–ê–¢–ï–ì–û–†–ò–ô
# ============================================================================
# –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –¥–æ—Ö–æ–¥–æ–≤/—Ä–∞—Å—Ö–æ–¥–æ–≤.
# –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏ —è–≤–ª—è—é—Ç—Å—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏.
# ============================================================================

@app.route('/api/finance/categories')
@require_auth(['admin', 'viewer'])
def api_finance_categories():
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π.
    Query-–ø–∞—Ä–∞–º–µ—Ç—Ä type (income/expense) ‚Äî —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {'success': True, 'categories': [{'id': 1, 'name': '–õ–æ–≥–∏—Å—Ç–∏–∫–∞', 'record_type': 'expense'}, ...]}
    """
    try:
        record_type = request.args.get('type', '').strip()

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        if record_type in ('income', 'expense'):
            cursor.execute('SELECT id, name, record_type, is_container_linked, requires_yuan, requires_description, description_hint, COALESCE(is_plan_linked, 0) as is_plan_linked, created_at FROM finance_categories WHERE record_type = ? ORDER BY name ASC', (record_type,))
        else:
            cursor.execute('SELECT id, name, record_type, is_container_linked, requires_yuan, requires_description, description_hint, COALESCE(is_plan_linked, 0) as is_plan_linked, created_at FROM finance_categories ORDER BY name ASC')

        rows = cursor.fetchall()
        categories = [{
            'id': r['id'], 'name': r['name'], 'record_type': r['record_type'],
            'is_container_linked': r['is_container_linked'] or 0,
            'requires_yuan': r['requires_yuan'] or 0,
            'requires_description': r['requires_description'] or 0,
            'description_hint': r['description_hint'] or '',
            'is_plan_linked': r['is_plan_linked'] or 0,
            'created_at': r['created_at']
        } for r in rows]
        conn.close()
        return jsonify({'success': True, 'categories': categories})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/finance/categories/add', methods=['POST'])
@require_auth(['admin'])
def api_finance_categories_add():
    """
    –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é.
    Payload: {'name': '–õ–æ–≥–∏—Å—Ç–∏–∫–∞', 'record_type': 'expense'}
    """
    try:
        data = request.json
        name = (data.get('name') or '').strip()
        record_type = (data.get('record_type') or '').strip()

        if not name:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}), 400

        if record_type not in ('income', 'expense'):
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ —Ç–∏–ø: income –∏–ª–∏ expense'}), 400

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–∞ –ø–æ –ø–∞—Ä–µ (name, record_type)
        cursor.execute('SELECT id FROM finance_categories WHERE LOWER(name) = LOWER(?) AND record_type = ?', (name, record_type))
        if cursor.fetchone():
            type_label = '—Ä–∞—Å—Ö–æ–¥–æ–≤' if record_type == 'expense' else '–¥–æ—Ö–æ–¥–æ–≤'
            conn.close()
            return jsonify({'success': False, 'error': f'–ö–∞—Ç–µ–≥–æ—Ä–∏—è "{name}" –¥–ª—è {type_label} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'}), 400

        # –§–ª–∞–≥ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π)
        is_container_linked = 1 if (data.get('is_container_linked') and record_type == 'expense') else 0
        # –§–ª–∞–≥ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —é–∞–Ω–µ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π)
        requires_yuan = 1 if (data.get('requires_yuan') and record_type == 'expense') else 0
        # –§–ª–∞–≥ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ–ø–∏—Å–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π)
        requires_description = 1 if (data.get('requires_description') and record_type == 'expense') else 0
        # –¢–µ–∫—Å—Ç-–ø–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è (—á—Ç–æ —É–≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
        description_hint = (data.get('description_hint') or '').strip()
        # –§–ª–∞–≥ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –ø–ª–∞–Ω—É –∑–∞–∫—É–ø–æ–∫ (—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —é–∞–Ω–µ–π –ø–æ —Å—Ç—Ä–æ–∫–∞–º –ø–ª–∞–Ω–∞)
        is_plan_linked = 1 if (data.get('is_plan_linked') and record_type == 'expense') else 0
        cursor.execute('INSERT INTO finance_categories (name, record_type, is_container_linked, requires_yuan, requires_description, description_hint, is_plan_linked) VALUES (?, ?, ?, ?, ?, ?, ?)',
                       (name, record_type, is_container_linked, requires_yuan, requires_description, description_hint, is_plan_linked))
        conn.commit()
        new_id = cursor.lastrowid
        conn.close()

        return jsonify({'success': True, 'id': new_id, 'message': f'–ö–∞—Ç–µ–≥–æ—Ä–∏—è "{name}" –¥–æ–±–∞–≤–ª–µ–Ω–∞'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/finance/categories/delete', methods=['POST'])
@require_auth(['admin'])
def api_finance_categories_delete():
    """
    –£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é.
    Payload: {'id': 5}
    –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏.
    """
    try:
        data = request.json
        cat_id = data.get('id')

        if not cat_id:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}), 400

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        cursor.execute('SELECT name FROM finance_categories WHERE id = ?', (cat_id,))
        row = cursor.fetchone()
        if not row:
            conn.close()
            return jsonify({'success': False, 'error': '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}), 404

        cursor.execute('SELECT COUNT(*) FROM finance_records WHERE category_id = ?', (cat_id,))
        count = cursor.fetchone()[0]
        if count > 0:
            conn.close()
            return jsonify({'success': False, 'error': f'–ö–∞—Ç–µ–≥–æ—Ä–∏—è "{row[0]}" –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ {count} –∑–∞–ø–∏—Å—è—Ö. –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.'}), 400

        cursor.execute('DELETE FROM finance_categories WHERE id = ?', (cat_id,))
        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': '–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


# ============================================================================
# API –§–ò–ù–ê–ù–°–´ ‚Äî –ó–ê–ü–ò–°–ò –î–û–•–û–î–û–í –ò –†–ê–°–•–û–î–û–í
# ============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ò –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (app_settings) ‚Äî GET / POST
# ============================================================================

@app.route('/api/settings', methods=['GET'])
@require_auth(['admin', 'viewer'])
def api_settings_get():
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á (?key=...)."""
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        key = request.args.get('key', '').strip()
        if key:
            row = conn.execute('SELECT value FROM app_settings WHERE key = ?', (key,)).fetchone()
            conn.close()
            return jsonify({'success': True, 'value': row['value'] if row else None})
        else:
            rows = conn.execute('SELECT key, value FROM app_settings').fetchall()
            conn.close()
            return jsonify({'success': True, 'settings': {r['key']: r['value'] for r in rows}})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

@app.route('/api/settings', methods=['POST'])
@require_auth(['admin'])
def api_settings_save():
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É: {key, value}."""
    try:
        data = request.get_json()
        key = data.get('key', '').strip()
        value = data.get('value', '')
        if not key:
            return jsonify({'success': False, 'error': 'key –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'})
        conn = sqlite3.connect(DB_PATH)
        conn.execute('INSERT OR REPLACE INTO app_settings (key, value) VALUES (?, ?)', (key, str(value)))
        conn.commit()
        conn.close()
        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

# ============================================================================
# CRUD-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π.
# –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —Ç–∏–ø—É, —Å—á—ë—Ç—É, –¥–∞—Ç–µ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É.
# –í–æ–∑–≤—Ä–∞—â–∞—é—Ç —Ç–∞–∫–∂–µ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–≤–æ–¥–∫—É (–¥–æ—Ö–æ–¥, —Ä–∞—Å—Ö–æ–¥, –±–∞–ª–∞–Ω—Å).
# ============================================================================

@app.route('/api/finance/records')
@require_auth(['admin', 'viewer'])
def api_finance_records():
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏ —Å–≤–æ–¥–∫–æ–π.

    Query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
        type: 'income' | 'expense' | '' (–≤—Å–µ)
        account_id: ID —Å—á—ë—Ç–∞ –∏–ª–∏ '' (–≤—Å–µ)
        is_official: '1' | '0' | '' (—Ñ–∏–ª—å—Ç—Ä –ø–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º—É —Ä–∞—Å—Ö–æ–¥—É)
        date_from: 'YYYY-MM-DD' (–Ω–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞)
        date_to: 'YYYY-MM-DD' (–∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞)
        sort_by: 'date' | 'amount' (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'date')
        sort_dir: 'asc' | 'desc' (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'desc')

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {'success': True, 'records': [...], 'summary': {total_income, total_expense, balance}}
    """
    try:
        record_type = request.args.get('type', '').strip()
        account_id = request.args.get('account_id', '').strip()
        category_id = request.args.get('category_id', '').strip()
        is_official_filter = request.args.get('is_official', '').strip()
        date_from = request.args.get('date_from', '').strip()
        date_to = request.args.get('date_to', '').strip()
        sort_by = request.args.get('sort_by', 'date').strip()
        sort_dir = request.args.get('sort_dir', 'desc').strip()

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –§–æ—Ä–º–∏—Ä—É–µ–º WHERE-—É—Å–ª–æ–≤–∏—è
        conditions = []
        params = []

        if record_type in ('income', 'expense'):
            conditions.append('record_type = ?')
            params.append(record_type)

        if account_id:
            conditions.append('account_id = ?')
            params.append(int(account_id))

        if category_id:
            conditions.append('category_id = ?')
            params.append(int(category_id))

        # –§–∏–ª—å—Ç—Ä –ø–æ ¬´–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥¬ª
        if is_official_filter in ('0', '1'):
            conditions.append('is_official = ?')
            params.append(int(is_official_filter))

        if date_from:
            conditions.append('record_date >= ?')
            params.append(date_from)

        if date_to:
            conditions.append('record_date <= ?')
            params.append(date_to)

        where_clause = ''
        if conditions:
            where_clause = 'WHERE ' + ' AND '.join(conditions)

        # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        sort_column = 'record_date' if sort_by == 'date' else 'amount'
        sort_direction = 'ASC' if sort_dir == 'asc' else 'DESC'
        # –î–ª—è –¥–∞—Ç—ã –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ç–æ—Ä–∏—á–Ω—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø–æ id –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
        order_clause = f'ORDER BY {sort_column} {sort_direction}, id DESC'

        # –ü–æ–ª—É—á–∞–µ–º –∑–∞–ø–∏—Å–∏
        query = f'SELECT * FROM finance_records {where_clause} {order_clause}'
        cursor.execute(query, params)
        rows = cursor.fetchall()
        records = [dict(r) for r in rows]

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏
        record_ids = [r['id'] for r in records]
        dist_counts = {}
        if record_ids:
            placeholders = ','.join('?' * len(record_ids))
            cursor.execute(f'''
                SELECT finance_record_id, COUNT(*) as cnt
                FROM finance_container_distributions
                WHERE finance_record_id IN ({placeholders})
                GROUP BY finance_record_id
            ''', record_ids)
            for row in cursor.fetchall():
                dist_counts[row['finance_record_id']] = row['cnt']

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –ø–æ –ø–ª–∞–Ω—É –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏
        plan_dist_counts = {}
        if record_ids:
            cursor.execute(f'''
                SELECT finance_record_id, COUNT(*) as cnt
                FROM finance_plan_distributions
                WHERE finance_record_id IN ({placeholders})
                GROUP BY finance_record_id
            ''', record_ids)
            for row in cursor.fetchall():
                plan_dist_counts[row['finance_record_id']] = row['cnt']

        # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏
        file_counts = {}
        if record_ids:
            cursor.execute(f'''
                SELECT finance_record_id, COUNT(*) as cnt
                FROM finance_record_files
                WHERE finance_record_id IN ({placeholders})
                GROUP BY finance_record_id
            ''', record_ids)
            for row in cursor.fetchall():
                file_counts[row['finance_record_id']] = row['cnt']

        # –ü–æ–ª—É—á–∞–µ–º —Ñ–ª–∞–≥–∏ is_container_linked / is_plan_linked –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        category_flags = {}
        cat_ids = list(set(r['category_id'] for r in records if r.get('category_id')))
        if cat_ids:
            cat_placeholders = ','.join('?' * len(cat_ids))
            cursor.execute(f'''
                SELECT id, COALESCE(is_container_linked, 0) as is_container_linked,
                       COALESCE(is_plan_linked, 0) as is_plan_linked
                FROM finance_categories WHERE id IN ({cat_placeholders})
            ''', cat_ids)
            for row in cursor.fetchall():
                category_flags[row['id']] = {
                    'is_container_linked': row['is_container_linked'],
                    'is_plan_linked': row['is_plan_linked']
                }

        for rec in records:
            rec['has_distributions'] = dist_counts.get(rec['id'], 0) > 0
            rec['has_plan_distributions'] = plan_dist_counts.get(rec['id'], 0) > 0
            rec['file_count'] = file_counts.get(rec['id'], 0)
            cat_f = category_flags.get(rec.get('category_id'), {})
            rec['is_container_linked'] = cat_f.get('is_container_linked', 0)
            rec['is_plan_linked'] = cat_f.get('is_plan_linked', 0)

        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–≤–æ–¥–∫—É —Å —Ç–µ–º–∏ –∂–µ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
        summary_query = f'''
            SELECT
                COALESCE(SUM(CASE WHEN record_type = 'income' THEN amount ELSE 0 END), 0) as total_income,
                COALESCE(SUM(CASE WHEN record_type = 'expense' THEN amount ELSE 0 END), 0) as total_expense,
                COALESCE(SUM(CASE WHEN yuan_amount IS NOT NULL AND yuan_amount > 0 THEN yuan_amount ELSE 0 END), 0) as total_yuan,
                COALESCE(SUM(CASE WHEN yuan_amount IS NOT NULL AND yuan_amount > 0 THEN amount ELSE 0 END), 0) as total_yuan_rubles
            FROM finance_records {where_clause}
        '''
        cursor.execute(summary_query, params)
        summary_row = cursor.fetchone()
        total_income = summary_row['total_income']
        total_expense = summary_row['total_expense']
        total_yuan = summary_row['total_yuan']
        total_yuan_rubles = summary_row['total_yuan_rubles']

        conn.close()

        return jsonify({
            'success': True,
            'records': records,
            'summary': {
                'total_income': round(total_income, 2),
                'total_expense': round(total_expense, 2),
                'balance': round(total_income - total_expense, 2),
                'total_yuan': round(total_yuan, 2),
                'total_yuan_rubles': round(total_yuan_rubles, 2)
            }
        })
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/finance/records/add', methods=['POST'])
@require_auth(['admin'])
def api_finance_records_add():
    """
    –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –∑–∞–ø–∏—Å—å –∏–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.

    Payload: {
        'record_type': 'income'|'expense',
        'amount': 15000,
        'account_id': 1,
        'description': '–ó–∞–∫—É–ø–∫–∞ —É–ø–∞–∫–æ–≤–∫–∏',
        'record_date': '2026-02-10'
    }
    """
    try:
        # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ multipart/form-data (–∫–æ–≥–¥–∞ –µ—Å—Ç—å —Ñ–∞–π–ª—ã) –∏ JSON
        uploaded_files = []
        if request.content_type and 'multipart' in request.content_type:
            data = request.form.to_dict()
            uploaded_files = request.files.getlist('files')
            if 'distributions' in data and data['distributions']:
                data['distributions'] = json.loads(data['distributions'])
            if 'plan_distributions' in data and data['plan_distributions']:
                data['plan_distributions'] = json.loads(data['plan_distributions'])
        else:
            data = request.json
        user_info = getattr(request, 'current_user', {})

        record_type = data.get('record_type', '')
        amount = data.get('amount', 0)
        account_id = data.get('account_id')
        category_id = data.get('category_id')
        description = (data.get('description') or '').strip()
        record_date = data.get('record_date', '')

        # –í–∞–ª–∏–¥–∞—Ü–∏—è
        if record_type not in ('income', 'expense'):
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ —Ç–∏–ø: income –∏–ª–∏ expense'}), 400

        try:
            amount = float(amount)
            if amount <= 0:
                raise ValueError()
        except (ValueError, TypeError):
            return jsonify({'success': False, 'error': '–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º –±–æ–ª—å—à–µ 0'}), 400

        if not account_id:
            return jsonify({'success': False, 'error': '–í—ã–±–µ—Ä–∏—Ç–µ —Å—á—ë—Ç/–∏—Å—Ç–æ—á–Ω–∏–∫'}), 400

        if not category_id:
            return jsonify({'success': False, 'error': '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é'}), 400

        account_id = int(account_id)
        category_id = int(category_id)

        if not record_date:
            record_date = get_snapshot_date()

        # –î–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π
        today = get_snapshot_date()
        if record_date > today:
            return jsonify({'success': False, 'error': '–î–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π'}), 400

        # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—á—ë—Ç–∞ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute('SELECT name, COALESCE(requires_official, 0) as requires_official FROM finance_accounts WHERE id = ?', (account_id,))
        acc_row = cursor.fetchone()
        if not acc_row:
            conn.close()
            return jsonify({'success': False, 'error': '–°—á—ë—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404

        account_name = acc_row[0]
        requires_official = acc_row[1] or 0

        cursor.execute('SELECT name, is_container_linked, requires_yuan, requires_description, description_hint, COALESCE(is_plan_linked, 0) as is_plan_linked FROM finance_categories WHERE id = ?', (category_id,))
        cat_row = cursor.fetchone()
        if not cat_row:
            conn.close()
            return jsonify({'success': False, 'error': '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}), 404

        category_name = cat_row[0]
        is_container_linked = cat_row[1] or 0
        requires_yuan = cat_row[2] or 0
        requires_description = cat_row[3] or 0
        description_hint = cat_row[4] or ''
        is_plan_linked = cat_row[5] or 0

        # –ü—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–î—Ä—É–≥–æ–µ" –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
        if category_name.lower() == '–¥—Ä—É–≥–æ–µ' and not description:
            conn.close()
            return jsonify({'success': False, 'error': '–ü—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–î—Ä—É–≥–æ–µ" –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'}), 400
        if requires_description and not description:
            error_msg = description_hint if description_hint else '–î–ª—è –¥–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ'
            conn.close()
            return jsonify({'success': False, 'error': error_msg}), 400

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—É–º–º—ã –≤ —é–∞–Ω—è—Ö
        yuan_amount = data.get('yuan_amount')
        if yuan_amount is not None:
            try:
                yuan_amount = float(yuan_amount)
                if yuan_amount <= 0:
                    yuan_amount = None
            except (ValueError, TypeError):
                yuan_amount = None

        # –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Ç—Ä–µ–±—É–µ—Ç —é–∞–Ω–∏ ‚Äî –≤–∞–ª–∏–¥–∏—Ä—É–µ–º
        if requires_yuan and not yuan_amount:
            conn.close()
            return jsonify({'success': False, 'error': '–î–ª—è –¥–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Å—É–º–º—É –≤ —é–∞–Ω—è—Ö'}), 400

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–º–µ—Ç–∫–∏ ¬´–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥¬ª
        is_official = None
        if requires_official and record_type == 'expense':
            is_official_raw = data.get('is_official')
            if is_official_raw is not None:
                is_official = 1 if str(is_official_raw) == '1' or is_official_raw is True else 0
            else:
                is_official = 0  # –ù–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî —Å—á–∏—Ç–∞–µ–º ¬´–Ω–µ—Ç¬ª

        cursor.execute('''
            INSERT INTO finance_records
            (record_type, amount, account_id, account_name, category_id, category_name, description, created_by, source, record_date, yuan_amount, is_official)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'web', ?, ?, ?)
        ''', (record_type, amount, account_id, account_name, category_id, category_name, description, user_info.get('username', ''), record_date, yuan_amount, is_official))

        new_id = cursor.lastrowid

        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É, –µ—Å–ª–∏ —Ä–∞—Å—Ö–æ–¥ –ù–ï –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π (is_official == 0)
        if record_type == 'expense' and requires_official and is_official == 0:
            amount_fmt = f"{amount:,.0f}".replace(',', ' ')
            notif_text = (
                f"‚ö†Ô∏è <b>–†–∞—Å—Ö–æ–¥ –±–µ–∑ –ø–æ–º–µ—Ç–∫–∏ ¬´–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π¬ª</b>\n\n"
                f"üí∞ –°—É–º–º–∞: {amount_fmt} ‚ÇΩ\n"
                f"üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category_name}\n"
            )
            if description:
                notif_text += f"üìù –û–ø–∏—Å–∞–Ω–∏–µ: {description}\n"
            notif_text += (
                f"üë§ –°–æ–∑–¥–∞–ª: {user_info.get('username', '')}\n"
                f"üìÖ –î–∞—Ç–∞: {record_date}\n\n"
                f"–†–∞—Å—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω <b>–ë–ï–ó</b> –ø–æ–º–µ—Ç–∫–∏ ¬´–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥¬ª."
            )
            send_admin_notification(notif_text)

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã)
        distributions = data.get('distributions', [])
        if distributions and record_type == 'expense':
            _save_finance_distributions(cursor, new_id, distributions, amount)

        # –†–∞—Å—Ö–æ–¥–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º, –Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –Ω–µ—Ç ‚Äî —É–≤–µ–¥–æ–º–ª—è–µ–º
        if record_type == 'expense' and is_container_linked and not distributions:
            _create_finance_distribution_notification(
                cursor, new_id, amount, category_name, description,
                user_info.get('username', ''), record_date
            )

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –ø–æ –ø–ª–∞–Ω—É –∑–∞–∫—É–ø–æ–∫ (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã)
        plan_distributions = data.get('plan_distributions', [])
        if isinstance(plan_distributions, str):
            plan_distributions = json.loads(plan_distributions) if plan_distributions else []
        if plan_distributions and record_type == 'expense' and yuan_amount:
            _save_finance_plan_distributions(cursor, new_id, plan_distributions, yuan_amount)

        # –†–∞—Å—Ö–æ–¥–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –ø–ª–∞–Ω—É, –Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –Ω–µ—Ç ‚Äî —É–≤–µ–¥–æ–º–ª—è–µ–º
        if record_type == 'expense' and is_plan_linked and yuan_amount and not plan_distributions:
            _create_finance_plan_distribution_notification(
                cursor, new_id, yuan_amount, amount, category_name, description,
                user_info.get('username', ''), record_date
            )

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        if uploaded_files:
            save_finance_files(cursor, new_id, uploaded_files)

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'id': new_id, 'message': '–ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/finance/records/update', methods=['POST'])
@require_auth(['admin'])
def api_finance_records_update():
    """
    –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –∑–∞–ø–∏—Å—å.

    Payload: —Ç–æ –∂–µ, —á—Ç–æ –∏ add, –ø–ª—é—Å 'id'.
    """
    try:
        # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ multipart/form-data (–∫–æ–≥–¥–∞ –µ—Å—Ç—å —Ñ–∞–π–ª—ã) –∏ JSON
        uploaded_files = []
        if request.content_type and 'multipart' in request.content_type:
            data = request.form.to_dict()
            uploaded_files = request.files.getlist('files')
            if 'distributions' in data and data['distributions']:
                data['distributions'] = json.loads(data['distributions'])
            if 'plan_distributions' in data and data['plan_distributions']:
                data['plan_distributions'] = json.loads(data['plan_distributions'])
        else:
            data = request.json

        record_id = data.get('id')

        if not record_id:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ ID –∑–∞–ø–∏—Å–∏'}), 400

        record_id = int(record_id)
        record_type = data.get('record_type', '')
        amount = data.get('amount', 0)
        account_id = data.get('account_id')
        category_id = data.get('category_id')
        description = (data.get('description') or '').strip()
        record_date = data.get('record_date', '')

        if record_type not in ('income', 'expense'):
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ —Ç–∏–ø: income –∏–ª–∏ expense'}), 400

        try:
            amount = float(amount)
            if amount <= 0:
                raise ValueError()
        except (ValueError, TypeError):
            return jsonify({'success': False, 'error': '–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º –±–æ–ª—å—à–µ 0'}), 400

        if not account_id:
            return jsonify({'success': False, 'error': '–í—ã–±–µ—Ä–∏—Ç–µ —Å—á—ë—Ç/–∏—Å—Ç–æ—á–Ω–∏–∫'}), 400

        if not category_id:
            return jsonify({'success': False, 'error': '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é'}), 400

        account_id = int(account_id)
        category_id = int(category_id)

        if not record_date:
            record_date = get_snapshot_date()

        # –î–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π
        today = get_snapshot_date()
        if record_date > today:
            return jsonify({'success': False, 'error': '–î–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π'}), 400

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—á—ë—Ç–∞ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        cursor.execute('SELECT name, COALESCE(requires_official, 0) as requires_official FROM finance_accounts WHERE id = ?', (account_id,))
        acc_row = cursor.fetchone()
        if not acc_row:
            conn.close()
            return jsonify({'success': False, 'error': '–°—á—ë—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404

        account_name = acc_row[0]
        requires_official = acc_row[1] or 0

        cursor.execute('SELECT name, is_container_linked, requires_yuan, requires_description, description_hint, COALESCE(is_plan_linked, 0) as is_plan_linked FROM finance_categories WHERE id = ?', (category_id,))
        cat_row = cursor.fetchone()
        if not cat_row:
            conn.close()
            return jsonify({'success': False, 'error': '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}), 404

        category_name = cat_row[0]
        is_container_linked = cat_row[1] or 0
        requires_yuan = cat_row[2] or 0
        requires_description = cat_row[3] or 0
        description_hint = cat_row[4] or ''
        is_plan_linked = cat_row[5] or 0

        # –ü—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–î—Ä—É–≥–æ–µ" –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
        if category_name.lower() == '–¥—Ä—É–≥–æ–µ' and not description:
            conn.close()
            return jsonify({'success': False, 'error': '–ü—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–î—Ä—É–≥–æ–µ" –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'}), 400
        if requires_description and not description:
            error_msg = description_hint if description_hint else '–î–ª—è –¥–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ'
            conn.close()
            return jsonify({'success': False, 'error': error_msg}), 400

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—É–º–º—ã –≤ —é–∞–Ω—è—Ö
        yuan_amount = data.get('yuan_amount')
        if yuan_amount is not None:
            try:
                yuan_amount = float(yuan_amount)
                if yuan_amount <= 0:
                    yuan_amount = None
            except (ValueError, TypeError):
                yuan_amount = None

        # –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Ç—Ä–µ–±—É–µ—Ç —é–∞–Ω–∏ ‚Äî –≤–∞–ª–∏–¥–∏—Ä—É–µ–º
        if requires_yuan and not yuan_amount:
            conn.close()
            return jsonify({'success': False, 'error': '–î–ª—è –¥–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Å—É–º–º—É –≤ —é–∞–Ω—è—Ö'}), 400

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–º–µ—Ç–∫–∏ ¬´–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥¬ª
        is_official = None
        if requires_official and record_type == 'expense':
            is_official_raw = data.get('is_official')
            if is_official_raw is not None:
                is_official = 1 if str(is_official_raw) == '1' or is_official_raw is True else 0
            else:
                is_official = 0

        cursor.execute('''
            UPDATE finance_records
            SET record_type = ?, amount = ?, account_id = ?, account_name = ?,
                category_id = ?, category_name = ?,
                description = ?, record_date = ?, yuan_amount = ?, is_official = ?, updated_at = CURRENT_TIMESTAMP
            WHERE id = ?
        ''', (record_type, amount, account_id, account_name, category_id, category_name, description, record_date, yuan_amount, is_official, record_id))

        if cursor.rowcount == 0:
            conn.close()
            return jsonify({'success': False, 'error': '–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}), 404

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π: –æ—Ç–∫–∞—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ, –ø—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–æ–≤—ã–µ
        _rollback_finance_plan_distributions(cursor, record_id)
        _rollback_finance_distributions(cursor, record_id)
        distributions = data.get('distributions', [])
        if distributions and record_type == 'expense':
            # _save_finance_distributions —É–∂–µ –ø–æ–º–µ—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
            _save_finance_distributions(cursor, record_id, distributions, amount)
        else:
            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ –±—ã–ª–æ) ‚Äî –¥–∞–Ω–Ω—ã–µ –º–æ–≥–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è
            _delete_finance_distribution_notification(cursor, record_id)

            # –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º –∏ –Ω–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π ‚Äî –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            if record_type == 'expense' and is_container_linked:
                user_info = getattr(request, 'current_user', {})
                _create_finance_distribution_notification(
                    cursor, record_id, amount, category_name, description,
                    user_info.get('username', ''), record_date
                )

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –ø–æ –ø–ª–∞–Ω—É –∑–∞–∫—É–ø–æ–∫
        plan_distributions = data.get('plan_distributions', [])
        if isinstance(plan_distributions, str):
            plan_distributions = json.loads(plan_distributions) if plan_distributions else []
        if plan_distributions and record_type == 'expense' and yuan_amount:
            # _save_finance_plan_distributions —É–∂–µ –ø–æ–º–µ—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
            _save_finance_plan_distributions(cursor, record_id, plan_distributions, yuan_amount)
        else:
            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ –±—ã–ª–æ) ‚Äî –¥–∞–Ω–Ω—ã–µ –º–æ–≥–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è
            _delete_finance_plan_distribution_notification(cursor, record_id)

            # –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –ø–ª–∞–Ω—É –∏ –µ—Å—Ç—å —Å—É–º–º–∞ —é–∞–Ω–µ–π ‚Äî –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            if record_type == 'expense' and is_plan_linked and yuan_amount:
                user_info = getattr(request, 'current_user', {})
                _create_finance_plan_distribution_notification(
                    cursor, record_id, yuan_amount, amount, category_name, description,
                    user_info.get('username', ''), record_date
                )

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        if uploaded_files:
            save_finance_files(cursor, record_id, uploaded_files)

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': '–ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/finance/records/delete', methods=['POST'])
@require_auth(['admin'])
def api_finance_records_delete():
    """
    –£–¥–∞–ª–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –∑–∞–ø–∏—Å—å.
    Payload: {'id': 1}
    """
    try:
        data = request.json
        record_id = data.get('id')

        if not record_id:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ ID –∑–∞–ø–∏—Å–∏'}), 400

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –ø–ª–∞–Ω—É –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –∑–∞–ø–∏—Å–∏
        _rollback_finance_plan_distributions(cursor, record_id)
        _rollback_finance_distributions(cursor, record_id)

        # –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        _delete_finance_distribution_notification(cursor, record_id)
        _delete_finance_plan_distribution_notification(cursor, record_id)

        # –£–¥–∞–ª—è–µ–º –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        cursor.execute('SELECT stored_filename FROM finance_record_files WHERE finance_record_id = ?', (record_id,))
        for f_row in cursor.fetchall():
            f_path = os.path.join(FINANCE_UPLOAD_FOLDER, str(record_id), f_row['stored_filename'])
            if os.path.exists(f_path):
                os.remove(f_path)
        cursor.execute('DELETE FROM finance_record_files WHERE finance_record_id = ?', (record_id,))

        cursor.execute('DELETE FROM finance_records WHERE id = ?', (record_id,))

        if cursor.rowcount == 0:
            conn.close()
            return jsonify({'success': False, 'error': '–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}), 404

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': '–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


# ============================================================================
# API –§–ò–ù–ê–ù–°–´ ‚Äî –ü–ï–ù–î–ï–õ–¨ (—Ä–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º)
# ============================================================================

@app.route('/api/finance/pendel')
@require_auth(['admin', 'viewer'])
def api_finance_pendel():
    """
    –ü–æ–ª—É—á–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: date_from, date_to (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ).
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: { categories: [...], summary: {...} }
    """
    try:
        date_from = request.args.get('date_from', '').strip()
        date_to = request.args.get('date_to', '').strip()

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ë–∞–∑–æ–≤–æ–µ —É—Å–ª–æ–≤–∏–µ ‚Äî —Ç–æ–ª—å–∫–æ —Ä–∞—Å—Ö–æ–¥—ã
        conditions = ["record_type = 'expense'"]
        params = []

        if date_from:
            conditions.append('record_date >= ?')
            params.append(date_from)
        if date_to:
            conditions.append('record_date <= ?')
            params.append(date_to)

        where_clause = ' AND '.join(conditions)

        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        query = f"""
            SELECT
                COALESCE(category_id, 0) as category_id,
                COALESCE(category_name, '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏') as category_name,
                SUM(amount) as total_amount,
                COUNT(*) as count
            FROM finance_records
            WHERE {where_clause}
            GROUP BY COALESCE(category_id, 0), COALESCE(category_name, '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏')
            ORDER BY total_amount DESC
        """
        cursor.execute(query, params)
        rows = cursor.fetchall()

        categories = []
        total_expense = 0

        for row in rows:
            cat = {
                'category_id': row['category_id'],
                'category_name': row['category_name'],
                'total_amount': round(row['total_amount'], 2),
                'count': row['count']
            }
            categories.append(cat)
            total_expense += row['total_amount']

        conn.close()

        return jsonify({
            'categories': categories,
            'summary': {
                'total_expense': round(total_expense, 2),
                'category_count': len(categories)
            }
        })
    except Exception as e:
        return jsonify({'error': str(e)}), 500


@app.route('/api/finance/pendel/details')
@require_auth(['admin', 'viewer'])
def api_finance_pendel_details():
    """
    –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤.
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: category_id, date_from, date_to.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: { transactions: [...] }
    """
    try:
        category_id = request.args.get('category_id', '0').strip()
        date_from = request.args.get('date_from', '').strip()
        date_to = request.args.get('date_to', '').strip()

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        conditions = ["record_type = 'expense'"]
        params = []

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: 0 = –±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (NULL)
        if category_id == '0':
            conditions.append('(category_id IS NULL OR category_id = 0)')
        else:
            conditions.append('category_id = ?')
            params.append(int(category_id))

        if date_from:
            conditions.append('record_date >= ?')
            params.append(date_from)
        if date_to:
            conditions.append('record_date <= ?')
            params.append(date_to)

        where_clause = ' AND '.join(conditions)

        query = f"""
            SELECT id, record_date, amount, account_name, description, created_by, source
            FROM finance_records
            WHERE {where_clause}
            ORDER BY record_date DESC
        """
        cursor.execute(query, params)
        rows = cursor.fetchall()

        transactions = []
        for row in rows:
            transactions.append({
                'id': row['id'],
                'record_date': row['record_date'],
                'amount': round(row['amount'], 2),
                'account_name': row['account_name'],
                'description': row['description'] or '',
                'created_by': row['created_by'] or '',
                'source': row['source'] or 'web'
            })

        conn.close()

        return jsonify({'transactions': transactions})
    except Exception as e:
        return jsonify({'error': str(e)}), 500


# ============================================================================
# API –§–ò–ù–ê–ù–°–´ ‚Äî –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–û –ö–û–ù–¢–ï–ô–ù–ï–†–ê–ú
# ============================================================================
# –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º –í–≠–î.
# –ü–æ–∑–≤–æ–ª—è—é—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å —Å—É–º–º—É —Ä–∞—Å—Ö–æ–¥–∞ –ø–æ —Ç–æ–≤–∞—Ä–∞–º –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
# –ø–æ 4 —Ç–∏–ø–∞–º –∑–∞—Ç—Ä–∞—Ç: –ª–æ–≥–∏—Å—Ç–∏–∫–∞ –†–§, –ª–æ–≥–∏—Å—Ç–∏–∫–∞ –ö–ù–†, —Ç–µ—Ä–º–∏–Ω–∞–ª, –ø–æ—à–ª–∏–Ω–∞.
# ============================================================================

@app.route('/api/ved/containers/list-for-finance')
@require_auth(['admin', 'viewer'])
def api_ved_containers_list_for_finance():
    """
    –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å –ø–æ–∑–∏—Ü–∏—è–º–∏ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
    –≤ —Ñ–æ—Ä–º–µ —Ä–∞—Å—Ö–æ–¥–æ–≤. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å —Ç–æ–≤–∞—Ä–∞–º–∏ (SKU –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ).
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–≤–µ—Ä—Ö—É)
        cursor.execute('''
            SELECT id, container_date, supplier
            FROM ved_container_docs
            ORDER BY container_date DESC, id DESC
        ''')
        docs = cursor.fetchall()

        containers = []
        for doc in docs:
            doc_id = doc['id']
            # –§–æ—Ä–º–∏—Ä—É–µ–º —á–∏—Ç–∞–µ–º—É—é –º–µ—Ç–∫—É
            date_str = doc['container_date'] or ''
            if date_str:
                parts = date_str.split('-')
                if len(parts) == 3:
                    date_str = f"{parts[2]}.{parts[1]}.{parts[0]}"
            supplier = doc['supplier'] or ''
            label = f"#{doc_id} ‚Äî {date_str}"
            if supplier:
                label += f", {supplier}"

            # –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            cursor.execute('''
                SELECT i.sku, i.quantity, p.offer_id
                FROM ved_container_items i
                LEFT JOIN products p ON p.sku = i.sku
                WHERE i.doc_id = ?
                ORDER BY i.id
            ''', (doc_id,))
            items = []
            for item in cursor.fetchall():
                items.append({
                    'sku': str(item['sku']),
                    'offer_id': item['offer_id'] or str(item['sku']),
                    'quantity': item['quantity'] or 0
                })

            containers.append({
                'id': doc_id,
                'label': label,
                'container_date': doc['container_date'],
                'supplier': supplier,
                'items': items
            })

        conn.close()
        return jsonify({'success': True, 'containers': containers})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/plan/items-for-finance')
@require_auth(['admin', 'viewer'])
def api_plan_items_for_finance():
    """
    –°—Ç—Ä–æ–∫–∏ –ø–ª–∞–Ω–∞ –∑–∞–∫—É–ø–æ–∫, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É, –¥–ª—è —Ñ–æ—Ä–º—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
    —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤. –ö–∞–∂–¥–∞—è –≥—Ä—É–ø–ø–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä–æ–∫–∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –¥–∞—Ç–µ
    –≤—ã—Ö–æ–¥–∞ (—Ä–∞–Ω–Ω–∏–µ –ø–µ—Ä–≤—ã–µ). –î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —ë–º–∫–æ—Å—Ç—å ‚Äî —Å–∫–æ–ª—å–∫–æ
    —é–∞–Ω–µ–π –µ—â—ë –º–æ–∂–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞ –∏–Ω–≤–æ–π—Å –∏ –¥–µ–ª—å—Ç—É.
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('''
            SELECT id, product_name, planned_release_date, estimated_arrival_date,
                   planned_qty, price_yuan_invoice, price_yuan_delta_invoice,
                   paid_invoice_yuan, paid_invoice_rub, paid_delta_yuan, paid_delta_rub
            FROM plan_items
            ORDER BY product_name, planned_release_date ASC, id ASC
        ''')
        rows = cursor.fetchall()
        conn.close()

        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É
        groups = {}
        group_order = []
        for row in rows:
            pname = row['product_name'] or ''
            if pname not in groups:
                groups[pname] = []
                group_order.append(pname)
            qty = row['planned_qty'] or 0
            price_inv = row['price_yuan_invoice'] or 0
            price_delta = row['price_yuan_delta_invoice'] or 0
            paid_inv_y = row['paid_invoice_yuan'] or 0
            paid_inv_r = row['paid_invoice_rub'] or 0
            paid_d_y = row['paid_delta_yuan'] or 0
            paid_d_r = row['paid_delta_rub'] or 0
            # –Å–º–∫–æ—Å—Ç—å = –æ–∂–∏–¥–∞–µ–º–∞—è —Å—É–º–º–∞ - —É–∂–µ –æ–ø–ª–∞—á–µ–Ω–æ
            capacity_invoice = max(price_inv * qty - paid_inv_y, 0)
            capacity_delta = max(price_delta * qty - paid_d_y, 0)
            groups[pname].append({
                'id': row['id'],
                'product_name': pname,
                'planned_release_date': row['planned_release_date'] or '',
                'estimated_arrival_date': row['estimated_arrival_date'] or '',
                'planned_qty': qty,
                'price_yuan_invoice': price_inv,
                'price_yuan_delta_invoice': price_delta,
                'paid_invoice_yuan': paid_inv_y,
                'paid_invoice_rub': paid_inv_r,
                'paid_delta_yuan': paid_d_y,
                'paid_delta_rub': paid_d_r,
                'capacity_invoice': round(capacity_invoice, 2),
                'capacity_delta': round(capacity_delta, 2)
            })

        products = []
        for pname in group_order:
            products.append({
                'product_name': pname,
                'items': groups[pname]
            })

        return jsonify({'success': True, 'products': products})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/finance/records/<int:record_id>/plan-distributions')
@require_auth(['admin', 'viewer'])
def api_finance_record_plan_distributions(record_id):
    """
    –ü–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ –ø–æ —Å—Ç—Ä–æ–∫–∞–º –ø–ª–∞–Ω–∞.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ –∏ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏.
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('''
            SELECT fpd.id, fpd.plan_item_id, fpd.target_type,
                   fpd.yuan_amount, fpd.rub_amount,
                   pi.product_name, pi.planned_release_date, pi.planned_qty,
                   pi.price_yuan_invoice, pi.price_yuan_delta_invoice
            FROM finance_plan_distributions fpd
            LEFT JOIN plan_items pi ON pi.id = fpd.plan_item_id
            WHERE fpd.finance_record_id = ?
            ORDER BY pi.product_name, pi.planned_release_date ASC
        ''', (record_id,))
        rows = cursor.fetchall()
        conn.close()

        distributions = []
        for row in rows:
            distributions.append({
                'id': row['id'],
                'plan_item_id': row['plan_item_id'],
                'target_type': row['target_type'],
                'yuan_amount': row['yuan_amount'] or 0,
                'rub_amount': row['rub_amount'] or 0,
                'product_name': row['product_name'] or '',
                'planned_release_date': row['planned_release_date'] or '',
                'planned_qty': row['planned_qty'] or 0,
                'price_yuan_invoice': row['price_yuan_invoice'] or 0,
                'price_yuan_delta_invoice': row['price_yuan_delta_invoice'] or 0
            })

        return jsonify({'success': True, 'distributions': distributions})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/finance/records/<int:record_id>/distributions')
@require_auth(['admin', 'viewer'])
def api_finance_record_distributions(record_id):
    """
    –ü–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞ –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∏ —Ç–æ–≤–∞—Ä–µ.
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('''
            SELECT
                fcd.id,
                fcd.container_doc_id,
                fcd.sku,
                fcd.cost_type,
                fcd.amount,
                d.container_date,
                d.supplier,
                p.offer_id
            FROM finance_container_distributions fcd
            LEFT JOIN ved_container_docs d ON d.id = fcd.container_doc_id
            LEFT JOIN products p ON p.sku = fcd.sku
            WHERE fcd.finance_record_id = ?
            ORDER BY fcd.container_doc_id, fcd.sku, fcd.cost_type
        ''', (record_id,))

        rows = cursor.fetchall()
        distributions = []
        total_distributed = 0

        for row in rows:
            date_str = row['container_date'] or ''
            if date_str:
                parts = date_str.split('-')
                if len(parts) == 3:
                    date_str = f"{parts[2]}.{parts[1]}.{parts[0]}"
            supplier = row['supplier'] or ''
            container_label = f"#{row['container_doc_id']} ‚Äî {date_str}"
            if supplier:
                container_label += f", {supplier}"

            amount = row['amount'] or 0
            total_distributed += amount

            distributions.append({
                'id': row['id'],
                'container_doc_id': row['container_doc_id'],
                'container_label': container_label,
                'sku': row['sku'],
                'offer_id': row['offer_id'] or row['sku'],
                'cost_type': row['cost_type'],
                'amount': amount
            })

        conn.close()
        return jsonify({
            'success': True,
            'distributions': distributions,
            'total_distributed': round(total_distributed, 2)
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/finance/categories/update', methods=['POST'])
@require_auth(['admin'])
def api_finance_categories_update():
    """
    –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é (–Ω–∞–∑–≤–∞–Ω–∏–µ, —Ñ–ª–∞–≥–∏ is_container_linked –∏ requires_yuan).
    Payload: {'id': 5, 'name': '–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'is_container_linked': true, 'requires_yuan': true}
    """
    try:
        data = request.json
        cat_id = data.get('id')

        if not cat_id:
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}), 400

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('SELECT id, name, record_type FROM finance_categories WHERE id = ?', (cat_id,))
        row = cursor.fetchone()
        if not row:
            conn.close()
            return jsonify({'success': False, 'error': '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}), 404

        # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—è
        updates = []
        params_upd = []
        new_name = None

        # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        if 'name' in data:
            new_name = (data.get('name') or '').strip()
            if not new_name:
                conn.close()
                return jsonify({'success': False, 'error': '–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'}), 400
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏
            cursor.execute('SELECT id FROM finance_categories WHERE name = ? AND id != ?', (new_name, cat_id))
            if cursor.fetchone():
                conn.close()
                return jsonify({'success': False, 'error': '–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'}), 400
            updates.append('name = ?')
            params_upd.append(new_name)

        # is_container_linked –∏–º–µ–µ—Ç —Å–º—ã—Å–ª —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        if 'is_container_linked' in data:
            is_container_linked = 1 if (data.get('is_container_linked') and row['record_type'] == 'expense') else 0
            updates.append('is_container_linked = ?')
            params_upd.append(is_container_linked)

        # requires_yuan –∏–º–µ–µ—Ç —Å–º—ã—Å–ª —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        if 'requires_yuan' in data:
            requires_yuan = 1 if (data.get('requires_yuan') and row['record_type'] == 'expense') else 0
            updates.append('requires_yuan = ?')
            params_upd.append(requires_yuan)

        # requires_description ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö)
        if 'requires_description' in data:
            requires_description = 1 if (data.get('requires_description') and row['record_type'] == 'expense') else 0
            updates.append('requires_description = ?')
            params_upd.append(requires_description)

        # description_hint ‚Äî —Ç–µ–∫—Å—Ç-–ø–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è
        if 'description_hint' in data:
            description_hint = (data.get('description_hint') or '').strip()
            updates.append('description_hint = ?')
            params_upd.append(description_hint)

        # is_plan_linked ‚Äî –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –ø–ª–∞–Ω—É –∑–∞–∫—É–ø–æ–∫ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö)
        if 'is_plan_linked' in data:
            is_plan_linked = 1 if (data.get('is_plan_linked') and row['record_type'] == 'expense') else 0
            updates.append('is_plan_linked = ?')
            params_upd.append(is_plan_linked)

        if not updates:
            conn.close()
            return jsonify({'success': True, 'message': '–ù–µ—á–µ–≥–æ –æ–±–Ω–æ–≤–ª—è—Ç—å'})

        params_upd.append(cat_id)
        cursor.execute(f'UPDATE finance_categories SET {", ".join(updates)} WHERE id = ?', params_upd)

        # –ü—Ä–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º category_name –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å—è—Ö
        if new_name:
            cursor.execute('UPDATE finance_records SET category_name = ? WHERE category_id = ?', (new_name, cat_id))

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


# ============================================================================
# API –§–ò–ù–ê–ù–°–´ ‚Äî –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø (–¥–∞–Ω–Ω—ã–µ –∏–∑ Ozon Finance API)
# ============================================================================
# –ü–æ–¥–≤–∫–ª–∞–¥–∫–∞ ¬´–†–µ–∞–ª–∏–∑–∞—Ü–∏—è¬ª —Ç—è–Ω–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ Ozon Seller API
# /v3/finance/transaction/list –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ö–ê–°–°–û–í–£–Æ –≤—ã—Ä—É—á–∫—É ‚Äî
# —Ç.–µ. –¥–µ–Ω—å–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ –ø–æ—Å—Ç—É–ø–∏–ª–∏/–±—ã–ª–∏ —É–¥–µ—Ä–∂–∞–Ω—ã –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –º–µ—Å—è—Ü–µ.
#
# –í–ê–ñ–ù–û: Ozon API —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ operation_date (–¥–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏), –∞ –ù–ï –ø–æ
# –¥–∞—Ç–µ –≤—ã–ø–ª–∞—Ç—ã –Ω–∞ —Ä/—Å. –í—ã–ø–ª–∞—Ç—ã –∏–¥—É—Ç —Å –ª–∞–≥–æ–º ~3-4 –Ω–µ–¥–µ–ª–∏:
#   - –í—ã–ø–ª–∞—Ç–∞ –≤ —è–Ω–≤–∞—Ä–µ = –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ—Ä–Ω–æ —Å 1 –¥–µ–∫–∞–±—Ä—è –ø–æ 7 —è–Ω–≤–∞—Ä—è.
# –ü–æ—ç—Ç–æ–º—É –¥–ª—è ¬´–∫–∞—Å—Å–æ–≤–æ–≥–æ¬ª –º–µ—Å—è—Ü–∞ M –º—ã —Å–¥–≤–∏–≥–∞–µ–º date range –Ω–∞–∑–∞–¥:
#   date_from = 1-–µ —á–∏—Å–ª–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ (M-1)
#   date_to   = 10-–µ —á–∏—Å–ª–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞ (M)
# –≠—Ç–æ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –≤—ã–ø–ª–∞—á–µ–Ω—ã –≤ –º–µ—Å—è—Ü–µ M.
#
# –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã Ozon:
#   - /v3/finance/transaction/list ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π, –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥
# ============================================================================

def _get_adv_spend_by_sku(date_from_str, date_to_str):
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å—É–º–º–∞—Ä–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ä–µ–∫–ª–∞–º—É –ø–æ offer_id –∑–∞ –ø–µ—Ä–∏–æ–¥.

    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ Ozon Performance API —á–µ—Ä–µ–∑ load_adv_spend_by_sku(),
    –∑–∞—Ç–µ–º –º–∞–ø–ø–∏—Ç —á–∏—Å–ª–æ–≤—ã–µ SKU –Ω–∞ —Å—Ç—Ä–æ–∫–æ–≤—ã–µ offer_id —á–µ—Ä–µ–∑ —Ç–∞–±–ª–∏—Ü—É products –≤ –ë–î.

    –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∞—Ç—å —Ä–µ–∫–ª–∞–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ –õ–Æ–ë–û–ô –ø–µ—Ä–∏–æ–¥, –≤–∫–ª—é—á–∞—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ
    –º–µ—Å—è—Ü—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–µ–∫–∞–±—Ä—å 2025), –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –≤ products_history.

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        date_from_str (str): –ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞ YYYY-MM-DD
        date_to_str (str): –ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞ YYYY-MM-DD

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        dict: {offer_id: total_adv_spend} ‚Äî —Ä–µ–∫–ª–∞–º–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º
    """
    try:
        # –®–∞–≥ 1: –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Performance API
        # load_adv_spend_by_sku –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç {date: {numeric_sku: spend}}
        raw_data = load_adv_spend_by_sku(date_from_str, date_to_str)

        if not raw_data:
            print(f"  üìä –†–µ–∫–ª–∞–º–∞ –ø–æ SKU –∑–∞ {date_from_str}‚Äî{date_to_str}: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ Performance API")
            return {}

        # –®–∞–≥ 2: –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º —Ä–∞—Å—Ö–æ–¥—ã –ø–æ SKU –∑–∞ –≤—Å–µ –¥–∞—Ç—ã
        # {numeric_sku: total_spend}
        spend_by_numeric_sku = {}
        for date_str, sku_spends in raw_data.items():
            for sku, spend in sku_spends.items():
                spend_by_numeric_sku[sku] = spend_by_numeric_sku.get(sku, 0) + spend

        if not spend_by_numeric_sku:
            print(f"  üìä –†–µ–∫–ª–∞–º–∞ –ø–æ SKU –∑–∞ {date_from_str}‚Äî{date_to_str}: 0 —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ—Å–ª–µ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏")
            return {}

        # –®–∞–≥ 3: –ú–∞–ø–ø–∏–º —á–∏—Å–ª–æ–≤—ã–µ SKU ‚Üí —Å—Ç—Ä–æ–∫–æ–≤—ã–µ offer_id —á–µ—Ä–µ–∑ —Ç–∞–±–ª–∏—Ü—É products
        conn = sqlite3.connect(DB_PATH, timeout=10)
        cursor = conn.cursor()
        cursor.execute('SELECT sku, offer_id FROM products WHERE offer_id IS NOT NULL')
        sku_to_offer = {row[0]: row[1] for row in cursor.fetchall()}
        conn.close()

        # –®–∞–≥ 4: –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ {offer_id: total_spend}
        result = {}
        unmapped_skus = []
        for sku, spend in spend_by_numeric_sku.items():
            # SKU –º–æ–∂–µ—Ç –±—ã—Ç—å int –∏–ª–∏ str ‚Äî –ø—Ä–∏–≤–æ–¥–∏–º –∫ int –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞
            sku_int = int(sku) if not isinstance(sku, int) else sku
            offer_id = sku_to_offer.get(sku_int)
            if offer_id:
                result[offer_id] = round(result.get(offer_id, 0) + spend, 2)
            else:
                unmapped_skus.append(sku_int)
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ —á–∏—Å–ª–æ–≤–æ–º—É SKU –∫–∞–∫ fallback ‚Äî —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–±–∞ –∫–ª—é—á–∞
                result[str(sku_int)] = round(result.get(str(sku_int), 0) + spend, 2)

        total = sum(result.values())
        print(f"  üìä –†–µ–∫–ª–∞–º–∞ –ø–æ SKU –∑–∞ {date_from_str}‚Äî{date_to_str}: {len(result)} —Ç–æ–≤–∞—Ä–æ–≤, –∏—Ç–æ–≥–æ {total:.2f} ‚ÇΩ")
        if unmapped_skus:
            print(f"  ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–º–∞–ø–∏—Ç—å SKU ‚Üí offer_id –¥–ª—è: {unmapped_skus}")

        return result
    except Exception as e:
        print(f"  ‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–ª–∞–º—ã –ø–æ SKU: {e}")
        import traceback
        traceback.print_exc()
        return {}


def _fetch_buyout_data(date_from_str, date_to_str):
    """
    –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—ã–∫—É–ø–∞–º –°–ù–ì –∏–∑ Ozon API /v1/finance/products/buyout.

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        date_from_str (str): –ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
        date_to_str (str): –ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        dict: {count, amount, products} ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —Å—É–º–º–∞ –∏ —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –°–ù–ì
    """
    ozon_headers = get_ozon_headers()
    payload = {"date_from": date_from_str, "date_to": date_to_str}
    print(f"  üåç –ó–∞–ø—Ä–æ—Å –≤—ã–∫—É–ø–æ–≤ –°–ù–ì: {date_from_str} ‚Äî {date_to_str}")
    try:
        resp = requests.post(
            f"{OZON_HOST}/v1/finance/products/buyout",
            json=payload, headers=ozon_headers, timeout=60
        )
        if resp.status_code != 200:
            print(f"  ‚ö†Ô∏è Buyout API: HTTP {resp.status_code} ‚Äî {resp.text[:200]}")
            return {'count': 0, 'amount': 0.0, 'products': []}

        data = resp.json()
        products = data.get('products', [])
        total_count = sum(p.get('quantity', 0) for p in products)
        total_amount = sum(p.get('amount', 0) for p in products)
        seller_price_total = sum(p.get('seller_price_per_instance', 0) * p.get('quantity', 0) for p in products)
        commission = seller_price_total - total_amount  # –ö–æ–º–∏—Å—Å–∏—è –°–ù–ì = seller_price - buyout_price
        print(f"  üåç –í—ã–∫—É–ø—ã –°–ù–ì: {total_count} —à—Ç. –Ω–∞ {total_amount:.2f} ‚ÇΩ (–∏—Å—Ö–æ–¥–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: {seller_price_total:.2f} ‚ÇΩ, –∫–æ–º–∏—Å—Å–∏—è: {commission:.2f} ‚ÇΩ)")
        return {
            'count': total_count,
            'amount': round(total_amount, 2),
            'seller_price_total': round(seller_price_total, 2),
            'commission': round(commission, 2),
            'products': products
        }
    except Exception as e:
        print(f"  ‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤—ã–∫—É–ø–æ–≤ –°–ù–ì: {e}")
        return {'count': 0, 'amount': 0.0, 'products': []}


def _build_realization_from_transactions(year, month):
    """
    –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–∑ /v1/finance/realization/by-day –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ (–Ω–µ–∑–∞–∫—Ä—ã—Ç–æ–≥–æ) –º–µ—Å—è—Ü–∞.

    Ozon API /v2/finance/realization –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–∫—Ä—ã—Ç—ã—Ö –º–µ—Å—è—Ü–µ–≤.
    –î–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º /v1/finance/realization/by-day ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
    –≤ —Ç–æ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–µ (delivery_commission, return_commission —Å —Ä–∞–∑–±–∏–≤–∫–æ–π amount/bonus/bank),
    —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Ç–æ—á–Ω—ã–µ —Å—É–º–º—ã ¬´–í–æ–∑–≤—Ä–∞—Ç –≤—ã—Ä—É—á–∫–∏¬ª, ¬´–ë–∞–ª–ª—ã –∑–∞ —Å–∫–∏–¥–∫–∏¬ª –∏ —Ç.–¥.

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        year (int): –ì–æ–¥
        month (int): –ú–µ—Å—è—Ü (1-12)

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        dict: –î–∞–Ω–Ω—ã–µ –≤ —Ç–æ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–µ, —á—Ç–æ –∏ /v2/finance/realization (summary + products)
    """
    import calendar
    from concurrent.futures import ThreadPoolExecutor, as_completed
    from datetime import datetime as _dt

    ozon_headers = get_ozon_headers()

    # –ü–µ—Ä–∏–æ–¥: 1-–µ —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞ ‚Äî –≤—á–µ—Ä–∞—à–Ω–∏–π –¥–µ–Ω—å (–µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü)
    now = _dt.now()
    if year == now.year and month == now.month:
        last_day = max(now.day - 1, 1)  # –í—á–µ—Ä–∞ (–º–∏–Ω–∏–º—É–º 1-–µ —á–∏—Å–ª–æ)
    else:
        last_day = calendar.monthrange(year, month)[1]

    period_label = f"{year}-{month:02d}"
    print(f"  üìä –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (by-day) –∑–∞ {period_label}: –¥–Ω–∏ 1-{last_day}")

    # ‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ –¥–Ω—è–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ ‚îÄ‚îÄ
    def _fetch_day(day):
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–∞ –æ–¥–∏–Ω –¥–µ–Ω—å."""
        payload = {"year": year, "month": month, "day": day}
        resp = requests.post(
            f"{OZON_HOST}/v1/finance/realization/by-day",
            json=payload, headers=ozon_headers, timeout=60
        )
        return day, resp

    all_rows = []
    errors = []

    with ThreadPoolExecutor(max_workers=5) as executor:
        futures = {executor.submit(_fetch_day, d): d for d in range(1, last_day + 1)}
        for future in as_completed(futures):
            day, resp = future.result()
            if resp.status_code == 200:
                rows = resp.json().get('rows', [])
                all_rows.extend(rows)
            else:
                err = resp.text[:200]
                print(f"  ‚ö†Ô∏è by-day {period_label}-{day:02d}: HTTP {resp.status_code} ‚Äî {err}")
                errors.append(f"–¥–µ–Ω—å {day}: HTTP {resp.status_code}")

    if not all_rows and errors:
        return {'success': False, 'error': f'–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {"; ".join(errors)}'}

    print(f"  ‚úÖ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (by-day) {period_label}: {len(all_rows)} —Å—Ç—Ä–æ–∫ –∑–∞ {last_day} –¥–Ω–µ–π")

    # ‚îÄ‚îÄ –ê–≥—Ä–µ–≥–∞—Ü–∏—è —Å—Ç—Ä–æ–∫ ‚Äî –∏–¥–µ–Ω—Ç–∏—á–Ω–æ /v2/finance/realization ‚îÄ‚îÄ
    # –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç delivery_commission –∏/–∏–ª–∏ return_commission
    # —Å –ø–æ–ª–Ω–æ–π —Ä–∞–∑–±–∏–≤–∫–æ–π: amount (–≤—ã—Ä—É—á–∫–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞), bonus (–±–∞–ª–ª—ã), bank_coinvestment (–ø–∞—Ä—Ç–Ω—ë—Ä—ã)
    gross_sales = 0.0           # –ì—Ä–æ—Å—Å-–ø—Ä–æ–¥–∞–∂–∏ (seller_price * delivery_qty)
    returns_total = 0.0         # –í–æ–∑–≤—Ä–∞—Ç –≤—ã—Ä—É—á–∫–∏ (return_commission.amount)
    commission_total = 0.0      # –ü–æ–ª–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è Ozon (delivery + return .total)
    seller_receives = 0.0       # –ö –ø–æ–ª—É—á–µ–Ω–∏—é –ø—Ä–æ–¥–∞–≤—Ü–æ–º
    bonuses_total = 0.0         # –ë–æ–Ω—É—Å—ã Ozon (–±–∞–ª–ª—ã –∑–∞ —Å–∫–∏–¥–∫–∏)
    standard_fee_total = 0.0    # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è
    stars_total = 0.0           # –ó–≤—ë–∑–¥—ã
    bank_coinvest_total = 0.0   # –°–æ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–Ω–∫–æ–º (–ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤)
    pup_coinvest_total = 0.0    # –°–æ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –ü–í–ó (pick_up_point_coinvestment)
    delivery_count = 0          # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç–∞–≤–æ–∫
    return_count = 0            # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤
    acquiring_total = 0.0       # –≠–∫–≤–∞–π—Ä–∏–Ω–≥
    return_gross_total = 0.0    # –ì—Ä–æ—Å—Å-–≤–æ–∑–≤—Ä–∞—Ç—ã (seller_price * return_qty)

    products_map = {}

    for row in all_rows:
        seller_price = row.get('seller_price_per_instance', 0)
        ratio = row.get('commission_ratio', 0)
        item_info = row.get('item', {})
        offer_id = item_info.get('offer_id', '')
        sku = str(item_info.get('sku', ''))
        name = item_info.get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä')
        barcode = item_info.get('barcode', '')

        dc = row.get('delivery_commission') or {}
        rc = row.get('return_commission') or {}

        # –î–æ—Å—Ç–∞–≤–∫–∏ (–ø—Ä–æ–¥–∞–∂–∏)
        d_qty = dc.get('quantity', 0)
        d_amount = dc.get('amount', 0)          # –í—ã—Ä—É—á–∫–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞ (–±–µ–∑ –±–æ–Ω—É—Å–æ–≤)
        d_total_comm = dc.get('total', 0)        # –ü–æ–ª–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è Ozon
        d_bonus = dc.get('bonus', 0)
        d_std_fee = dc.get('standard_fee', 0)
        d_stars = dc.get('stars', 0)
        d_bank = dc.get('bank_coinvestment', 0)
        d_pup = dc.get('pick_up_point_coinvestment', 0)
        d_acquiring = dc.get('commission', 0)

        # –í–æ–∑–≤—Ä–∞—Ç—ã (–≤—Å–µ –ø–æ–ª—è ‚Äî –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ, —É–º–µ–Ω—å—à–∞—é—Ç –∏—Ç–æ–≥–∏)
        r_qty = rc.get('quantity', 0)
        r_amount = rc.get('amount', 0)           # –í–æ–∑–≤—Ä–∞—Ç –≤—ã—Ä—É—á–∫–∏ (–¥–æ–ª—è –ø—Ä–æ–¥–∞–≤—Ü–∞)
        r_total_comm = rc.get('total', 0)
        r_bonus = rc.get('bonus', 0)             # –ë–∞–ª–ª—ã –∑–∞ —Å–∫–∏–¥–∫–∏ (–≤–æ–∑–≤—Ä–∞—Ç)
        r_std_fee = rc.get('standard_fee', 0)    # –í–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏
        r_stars = rc.get('stars', 0)             # –í–æ–∑–≤—Ä–∞—Ç –∑–≤—ë–∑–¥
        r_bank = rc.get('bank_coinvestment', 0)  # –í–æ–∑–≤—Ä–∞—Ç —Å–æ–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        r_pup = rc.get('pick_up_point_coinvestment', 0)  # –í–æ–∑–≤—Ä–∞—Ç —Å–æ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è –ü–í–ó
        r_acquiring = rc.get('commission', 0) if rc else 0

        # –ì—Ä–æ—Å—Å-–ø—Ä–æ–¥–∞–∂–∏ = —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞ * –∫–æ–ª-–≤–æ –¥–æ—Å—Ç–∞–≤–æ–∫
        row_gross_sales = seller_price * d_qty
        # –ì—Ä–æ—Å—Å-–≤–æ–∑–≤—Ä–∞—Ç—ã = —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞ * –∫–æ–ª-–≤–æ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤
        row_return_gross = seller_price * r_qty
        # –í–æ–∑–≤—Ä–∞—Ç—ã = return_commission.amount (–í–æ–∑–≤—Ä–∞—Ç –≤—ã—Ä—É—á–∫–∏ ‚Äî –¥–æ–ª—è –ø—Ä–æ–¥–∞–≤—Ü–∞)
        row_returns = abs(r_amount) if r_amount else 0

        gross_sales += row_gross_sales
        return_gross_total += row_return_gross
        returns_total += row_returns
        commission_total += d_total_comm + r_total_comm
        seller_receives += d_amount - r_amount          # –î–æ—Å—Ç–∞–≤–∫–∏ –º–∏–Ω—É—Å –≤–æ–∑–≤—Ä–∞—Ç—ã (r_amount –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –≤ API)
        bonuses_total += d_bonus - r_bonus              # –ß–∏—Å—Ç—ã–µ –±–∞–ª–ª—ã –∑–∞ —Å–∫–∏–¥–∫–∏
        standard_fee_total += d_std_fee - r_std_fee    # –ß–∏—Å—Ç–∞—è –∫–æ–º–∏—Å—Å–∏—è (–¥–æ—Å—Ç–∞–≤–∫–∏ –º–∏–Ω—É—Å –≤–æ–∑–≤—Ä–∞—Ç)
        stars_total += d_stars - r_stars                # –ß–∏—Å—Ç—ã–µ –∑–≤—ë–∑–¥—ã
        bank_coinvest_total += d_bank - r_bank          # –ß–∏—Å—Ç–æ–µ —Å–æ–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        pup_coinvest_total += d_pup - r_pup            # –ß–∏—Å—Ç–æ–µ —Å–æ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –ü–í–ó
        acquiring_total += d_acquiring + r_acquiring
        delivery_count += d_qty
        return_count += r_qty

        # –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ —Ç–æ–≤–∞—Ä–∞–º (SKU) ‚Äî –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ products_map
        product_key = sku or offer_id or barcode or '_unknown'
        if product_key not in products_map:
            products_map[product_key] = {
                'name': name[:80] if name else '–ü—Ä–æ—á–µ–µ',
                'sku': sku,
                'offer_id': offer_id,
                'seller_price_sum': 0.0,
                'standard_fee': 0.0,
                'acquiring': 0.0,
                'bank_coinvestment': 0.0,
                'delivery_qty': 0,
                'return_qty': 0,
                'gross_sales': 0.0,
                'return_gross': 0.0,
                'returns': 0.0,
                'total_deductions': 0.0,
                'seller_receives': 0.0,
                'bonus': 0.0
            }
        p = products_map[product_key]
        p['delivery_qty'] += d_qty
        p['return_qty'] += r_qty
        p['gross_sales'] += row_gross_sales
        p['return_gross'] += row_return_gross
        p['returns'] += row_returns
        p['total_deductions'] += d_total_comm + r_total_comm
        p['seller_receives'] += d_amount - r_amount
        p['bonus'] += d_bonus + r_bonus
        p['standard_fee'] += d_std_fee - r_std_fee  # –ß–∏—Å—Ç–∞—è –∫–æ–º–∏—Å—Å–∏—è: –¥–æ—Å—Ç–∞–≤–∫–∏ –º–∏–Ω—É—Å –≤–æ–∑–≤—Ä–∞—Ç—ã
        p['acquiring'] += d_acquiring + r_acquiring
        p['bank_coinvestment'] += d_bank
        if d_qty > 0:
            p['seller_price_sum'] += seller_price * d_qty

    # ‚îÄ‚îÄ –ò—Ç–æ–≥–∏ ‚îÄ‚îÄ
    net_total = seller_receives
    marketplace_commission = standard_fee_total + acquiring_total
    avg_commission_pct = (marketplace_commission / gross_sales * 100) if gross_sales > 0 else 0

    # ‚îÄ‚îÄ –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ (–ø–æ SKU) ‚îÄ‚îÄ
    products_list = []
    for key, pdata in sorted(products_map.items(),
                              key=lambda x: abs(x[1]['gross_sales']), reverse=True):
        dq = pdata['delivery_qty']
        avg_price = pdata['seller_price_sum'] / dq if dq > 0 else 0

        p_commission = pdata['standard_fee'] + pdata['acquiring']
        p_commission_pct = (p_commission / pdata['gross_sales'] * 100) if pdata['gross_sales'] > 0 else 0

        products_list.append({
            'sku': pdata['sku'],
            'offer_id': pdata['offer_id'],
            'name': pdata['name'],
            'seller_price': round(avg_price, 2),
            'commission_ratio': round(p_commission_pct, 2),
            'delivery_qty': pdata['delivery_qty'],
            'return_qty': pdata['return_qty'],
            'gross_sales': round(pdata['gross_sales'], 2),
            'return_gross': round(pdata['return_gross'], 2),
            'returns': round(pdata['returns'], 2),
            'commission': round(p_commission, 2),
            'seller_receives': round(pdata['seller_receives'], 2),
            'bonus': round(pdata['bonus'], 2)
        })

    return {
        'success': True,
        'period': period_label,
        'is_quarter': False,
        'header': {
            'number': f'–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π ({period_label})',
            'doc_date': '', 'start_date': f'{year}-{month:02d}-01',
            'stop_date': f'{year}-{month:02d}-{last_day}',
            'contract_date': '', 'contract_number': '',
            'payer_name': '', 'payer_inn': '', 'payer_kpp': '',
            'rcv_name': '', 'rcv_inn': '', 'rcv_kpp': '',
        },
        'summary': {
            'gross_sales': round(gross_sales, 2),
            'returns': round(returns_total, 2),
            'commission': round(marketplace_commission, 2),
            'total_deductions': round(commission_total, 2),
            'seller_receives': round(seller_receives, 2),
            'bonuses': round(bonuses_total, 2),
            'standard_fee': round(standard_fee_total, 2),
            'stars': round(stars_total, 2),
            'bank_coinvestment': round(bank_coinvest_total, 2),
            'net_total': round(net_total, 2),
            'avg_commission_pct': round(avg_commission_pct, 2),
            'delivery_count': delivery_count,
            'return_count': return_count,
            'return_gross': round(return_gross_total, 2),
            'sales_after_spp': round(seller_receives + bank_coinvest_total + pup_coinvest_total, 2),
        },
        'products': products_list,
        'total_rows': len(all_rows),
        'total_products': len(products_list),
        'warnings': '–î–∞–Ω–Ω—ã–µ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü ‚Äî –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ (–µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)'
    }


def _build_realization_from_date_range(date_from_str, date_to_str):
    """
    –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç.

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç /v1/finance/realization/by-day –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ.
    –ê–≥—Ä–µ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ _build_realization_from_transactions.

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        date_from_str (str): –ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
        date_to_str (str): –ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        dict: –î–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ summary + products
    """
    from concurrent.futures import ThreadPoolExecutor, as_completed
    from datetime import datetime as _dt, timedelta

    ozon_headers = get_ozon_headers()

    start_date = _dt.strptime(date_from_str, '%Y-%m-%d').date()
    end_date = _dt.strptime(date_to_str, '%Y-%m-%d').date()
    now = _dt.now().date()

    # –ù–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è –∏ –∑–∞ –±—É–¥—É—â–µ–µ
    if end_date >= now:
        end_date = now - timedelta(days=1)
    if start_date > end_date:
        return {'success': True, 'summary': {
            'gross_sales': 0, 'returns': 0, 'commission': 0, 'total_deductions': 0,
            'seller_receives': 0, 'bonuses': 0, 'standard_fee': 0, 'stars': 0,
            'bank_coinvestment': 0, 'net_total': 0, 'avg_commission_pct': 0,
            'delivery_count': 0, 'return_count': 0, 'return_gross': 0
        }, 'products': [], 'total_rows': 0, 'total_products': 0}

    # –°–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ (year, month, day) –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
    days_to_fetch = []
    current = start_date
    while current <= end_date:
        days_to_fetch.append((current.year, current.month, current.day))
        current += timedelta(days=1)

    period_label = f"{date_from_str} ‚Äî {date_to_str}"
    print(f"  üìä –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (by-day) –∑–∞ {period_label}: {len(days_to_fetch)} –¥–Ω–µ–π")

    def _fetch_day(year, month, day):
        payload = {"year": year, "month": month, "day": day}
        resp = requests.post(
            f"{OZON_HOST}/v1/finance/realization/by-day",
            json=payload, headers=ozon_headers, timeout=60
        )
        return (year, month, day), resp

    all_rows = []
    errors = []

    with ThreadPoolExecutor(max_workers=5) as executor:
        futures = {executor.submit(_fetch_day, y, m, d): (y, m, d) for y, m, d in days_to_fetch}
        for future in as_completed(futures):
            (y, m, d), resp = future.result()
            if resp.status_code == 200:
                rows = resp.json().get('rows', [])
                all_rows.extend(rows)
            else:
                err = resp.text[:200]
                print(f"  ‚ö†Ô∏è by-day {y}-{m:02d}-{d:02d}: HTTP {resp.status_code} ‚Äî {err}")
                errors.append(f"{y}-{m:02d}-{d:02d}: HTTP {resp.status_code}")

    if not all_rows and errors:
        return {'success': False, 'error': f'–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {"; ".join(errors)}'}

    print(f"  ‚úÖ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (by-day) {period_label}: {len(all_rows)} —Å—Ç—Ä–æ–∫ –∑–∞ {len(days_to_fetch)} –¥–Ω–µ–π")

    # ‚îÄ‚îÄ –ê–≥—Ä–µ–≥–∞—Ü–∏—è —Å—Ç—Ä–æ–∫ ‚îÄ‚îÄ
    gross_sales = 0.0
    returns_total = 0.0
    commission_total = 0.0
    seller_receives = 0.0
    bonuses_total = 0.0
    standard_fee_total = 0.0
    stars_total = 0.0
    bank_coinvest_total = 0.0
    pup_coinvest_total = 0.0
    delivery_count = 0
    return_count = 0
    acquiring_total = 0.0
    return_gross_total = 0.0
    products_map = {}

    for row in all_rows:
        seller_price = row.get('seller_price_per_instance', 0)
        item_info = row.get('item', {})
        offer_id = item_info.get('offer_id', '')
        sku = str(item_info.get('sku', ''))
        name = item_info.get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä')
        barcode = item_info.get('barcode', '')

        dc = row.get('delivery_commission') or {}
        rc = row.get('return_commission') or {}

        d_qty = dc.get('quantity', 0)
        d_amount = dc.get('amount', 0)
        d_total_comm = dc.get('total', 0)
        d_bonus = dc.get('bonus', 0)
        d_std_fee = dc.get('standard_fee', 0)
        d_stars = dc.get('stars', 0)
        d_bank = dc.get('bank_coinvestment', 0)
        d_pup = dc.get('pick_up_point_coinvestment', 0)
        d_acquiring = dc.get('commission', 0)

        r_qty = rc.get('quantity', 0)
        r_amount = rc.get('amount', 0)
        r_total_comm = rc.get('total', 0)
        r_bonus = rc.get('bonus', 0)
        r_std_fee = rc.get('standard_fee', 0)
        r_stars = rc.get('stars', 0)
        r_bank = rc.get('bank_coinvestment', 0)
        r_pup = rc.get('pick_up_point_coinvestment', 0)
        r_acquiring = rc.get('commission', 0) if rc else 0

        row_gross_sales = seller_price * d_qty
        row_return_gross = seller_price * r_qty
        row_returns = abs(r_amount) if r_amount else 0

        gross_sales += row_gross_sales
        return_gross_total += row_return_gross
        returns_total += row_returns
        commission_total += d_total_comm + r_total_comm
        seller_receives += d_amount - r_amount          # –î–æ—Å—Ç–∞–≤–∫–∏ –º–∏–Ω—É—Å –≤–æ–∑–≤—Ä–∞—Ç—ã (r_amount –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –≤ API)
        bonuses_total += d_bonus - r_bonus              # –ß–∏—Å—Ç—ã–µ –±–∞–ª–ª—ã –∑–∞ —Å–∫–∏–¥–∫–∏
        standard_fee_total += d_std_fee - r_std_fee    # –ß–∏—Å—Ç–∞—è –∫–æ–º–∏—Å—Å–∏—è (–¥–æ—Å—Ç–∞–≤–∫–∏ –º–∏–Ω—É—Å –≤–æ–∑–≤—Ä–∞—Ç)
        stars_total += d_stars - r_stars                # –ß–∏—Å—Ç—ã–µ –∑–≤—ë–∑–¥—ã
        bank_coinvest_total += d_bank - r_bank          # –ß–∏—Å—Ç–æ–µ —Å–æ–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        pup_coinvest_total += d_pup - r_pup            # –ß–∏—Å—Ç–æ–µ —Å–æ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –ü–í–ó
        acquiring_total += d_acquiring + r_acquiring
        delivery_count += d_qty
        return_count += r_qty

        product_key = sku or offer_id or barcode or '_unknown'
        if product_key not in products_map:
            products_map[product_key] = {
                'name': name[:80] if name else '–ü—Ä–æ—á–µ–µ', 'sku': sku, 'offer_id': offer_id,
                'seller_price_sum': 0.0, 'standard_fee': 0.0, 'acquiring': 0.0,
                'bank_coinvestment': 0.0, 'delivery_qty': 0, 'return_qty': 0,
                'gross_sales': 0.0, 'return_gross': 0.0, 'returns': 0.0,
                'total_deductions': 0.0, 'seller_receives': 0.0, 'bonus': 0.0
            }
        p = products_map[product_key]
        p['delivery_qty'] += d_qty
        p['return_qty'] += r_qty
        p['gross_sales'] += row_gross_sales
        p['return_gross'] += row_return_gross
        p['returns'] += row_returns
        p['total_deductions'] += d_total_comm + r_total_comm
        p['seller_receives'] += d_amount - r_amount
        p['bonus'] += d_bonus - r_bonus
        p['standard_fee'] += d_std_fee - r_std_fee  # –ß–∏—Å—Ç–∞—è –∫–æ–º–∏—Å—Å–∏—è: –¥–æ—Å—Ç–∞–≤–∫–∏ –º–∏–Ω—É—Å –≤–æ–∑–≤—Ä–∞—Ç—ã
        p['acquiring'] += d_acquiring + r_acquiring
        p['bank_coinvestment'] += d_bank
        if d_qty > 0:
            p['seller_price_sum'] += seller_price * d_qty

    net_total = seller_receives
    marketplace_commission = standard_fee_total + acquiring_total
    net_gross = gross_sales - return_gross_total
    avg_commission_pct = (marketplace_commission / net_gross * 100) if net_gross > 0 else 0

    products_list = []
    for key, pdata in sorted(products_map.items(),
                              key=lambda x: abs(x[1]['gross_sales']), reverse=True):
        dq = pdata['delivery_qty']
        avg_price = pdata['seller_price_sum'] / dq if dq > 0 else 0

        # –ö–æ–º–∏—Å—Å–∏—è –ú–ü = standard_fee + —ç–∫–≤–∞–π—Ä–∏–Ω–≥
        p_commission = pdata['standard_fee'] + pdata['acquiring']
        p_commission_pct = (p_commission / pdata['gross_sales'] * 100) if pdata['gross_sales'] > 0 else 0

        # –§–æ—Ä–º–∞—Ç –∞–Ω–∞–ª–æ–≥–∏—á–µ–Ω _build_realization_from_transactions –∏ closed-month:
        # delivery_qty = –ì–†–û–°–° –¥–æ—Å—Ç–∞–≤–∫–∏, gross_sales = –ì–†–û–°–° –ø—Ä–æ–¥–∞–∂–∏ (seller_price * delivery_qty)
        products_list.append({
            'sku': pdata['sku'], 'offer_id': pdata['offer_id'], 'name': pdata['name'],
            'seller_price': round(avg_price, 2), 'commission_ratio': round(p_commission_pct, 2),
            'delivery_qty': pdata['delivery_qty'],
            'return_qty': pdata['return_qty'],
            'gross_sales': round(pdata['gross_sales'], 2), 'return_gross': round(pdata['return_gross'], 2),
            'returns': round(pdata['returns'], 2),
            'commission': round(p_commission, 2), 'seller_receives': round(pdata['seller_receives'], 2),
            'bonus': round(pdata['bonus'], 2)
        })

    return {
        'success': True,
        'period': period_label,
        'is_quarter': False,
        'header': {
            'number': f'–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π ({period_label})',
            'doc_date': '', 'start_date': date_from_str, 'stop_date': date_to_str,
        },
        'summary': {
            'gross_sales': round(gross_sales, 2),
            'returns': round(returns_total, 2),
            'commission': round(marketplace_commission, 2),
            'total_deductions': round(commission_total, 2),
            'seller_receives': round(seller_receives, 2),
            'bonuses': round(bonuses_total, 2),
            'standard_fee': round(standard_fee_total, 2),
            'stars': round(stars_total, 2),
            'bank_coinvestment': round(bank_coinvest_total, 2),
            'net_total': round(net_total, 2),
            'avg_commission_pct': round(avg_commission_pct, 2),
            'delivery_count': delivery_count,
            'return_count': return_count,
            'return_gross': round(return_gross_total, 2),
            'sales_after_spp': round(seller_receives + bank_coinvest_total + pup_coinvest_total, 2),
        },
        'products': products_list,
        'total_rows': len(all_rows),
        'total_products': len(products_list),
        'warnings': '–î–∞–Ω–Ω—ã–µ –ø–æ –¥–Ω—è–º ‚Äî –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ (–µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)'
    }


@app.route('/api/finance/realization')
@require_auth()
def api_finance_realization():
    """
    –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–∑ Ozon API (/v2/finance/realization).

    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–∏ —Ä–µ–∂–∏–º–∞:
    1. –ü–æ –¥–Ω—è–º: ?date_from=YYYY-MM-DD&date_to=YYYY-MM-DD ‚Äî –¥–∞–Ω–Ω—ã–µ –∑–∞ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç
    2. –ü–æ –º–µ—Å—è—Ü—É: ?month=YYYY-MM ‚Äî –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∫ Ozon API
    3. –ü–æ –∫–≤–∞—Ä—Ç–∞–ª—É: ?quarter=YYYY-Q1..Q4 ‚Äî —Ç—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞ (–ø–æ –º–µ—Å—è—Ü—É –Ω–∞ –∫–∞–∂–¥—ã–π), –∞–≥—Ä–µ–≥–∞—Ü–∏—è

    Ozon API –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–æ–ª—å–∫–æ {year, month} ‚Äî –¥–∞–Ω–Ω—ã–µ –∑–∞ —Ü–µ–ª—ã–π –º–µ—Å—è—Ü.
    –î–ª—è –∫–≤–∞—Ä—Ç–∞–ª–∞ –¥–µ–ª–∞–µ–º 3 –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞ –∏ –æ–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        JSON: header –∞–∫—Ç–∞, —Å–≤–æ–¥–∫–∞ (–ø—Ä–æ–¥–∞–∂–∏, –≤–æ–∑–≤—Ä–∞—Ç—ã, –∫–æ–º–∏—Å—Å–∏–∏), —Ç–∞–±–ª–∏—Ü–∞ –ø–æ —Ç–æ–≤–∞—Ä–∞–º.
    """
    import calendar
    from datetime import datetime as _dt

    # ‚îÄ‚îÄ –†–µ–∂–∏–º –ø–æ –¥–Ω—è–º (date_from + date_to) ‚îÄ‚îÄ
    date_from_str = request.args.get('date_from', '')
    date_to_str = request.args.get('date_to', '')
    if date_from_str and date_to_str:
        try:
            result = _build_realization_from_date_range(date_from_str, date_to_str)
            # –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—ã–∫—É–ø–∞–º –°–ù–ì
            buyout = _fetch_buyout_data(date_from_str, date_to_str)
            result['buyout'] = buyout
            # –†–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ä–µ–∫–ª–∞–º—É –ø–æ SKU –∑–∞ –ø–µ—Ä–∏–æ–¥
            result['adv_by_sku'] = _get_adv_spend_by_sku(date_from_str, date_to_str)
            return jsonify(result)
        except Exception as e:
            print(f"  ‚ùå –û—à–∏–±–∫–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ –¥–Ω—è–º: {e}")
            return jsonify({'success': False, 'error': str(e)}), 500

    # ‚îÄ‚îÄ –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º: –º–µ—Å—è—Ü –∏–ª–∏ –∫–≤–∞—Ä—Ç–∞–ª ‚îÄ‚îÄ
    quarter_str = request.args.get('quarter', '')
    month_str = request.args.get('month', '')

    # –ú–∞–ø–ø–∏–Ω–≥ –∫–≤–∞—Ä—Ç–∞–ª ‚Üí –º–µ—Å—è—Ü—ã (–Ω–æ–º–µ—Ä–∞)
    quarter_months = {
        1: [1, 2, 3],    # Q1: –Ø–Ω–≤‚Äì–ú–∞—Ä
        2: [4, 5, 6],    # Q2: –ê–ø—Ä‚Äì–ò—é–Ω
        3: [7, 8, 9],    # Q3: –ò—é–ª‚Äì–°–µ–Ω
        4: [10, 11, 12],  # Q4: –û–∫—Ç‚Äì–î–µ–∫
    }

    # –°–ø–∏—Å–æ–∫ (year, month) –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
    months_to_fetch = []
    is_quarter = False
    period_label = ''

    if quarter_str:
        # –§–æ—Ä–º–∞—Ç: YYYY-Q1 ... YYYY-Q4
        import re
        m = re.match(r'^(\d{4})-Q([1-4])$', quarter_str)
        if not m:
            return jsonify({'success': False, 'error': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–≤–∞—Ä—Ç–∞–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ YYYY-Q1..Q4'}), 400
        q_year = int(m.group(1))
        q_num = int(m.group(2))
        months_to_fetch = [(q_year, mo) for mo in quarter_months[q_num]]
        is_quarter = True
        period_label = f"Q{q_num} {q_year}"
    else:
        # –†–µ–∂–∏–º –æ–¥–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞ (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
        if not month_str:
            now = _dt.now()
            month_str = now.strftime('%Y-%m')
        try:
            dt = _dt.strptime(month_str, '%Y-%m')
            months_to_fetch = [(dt.year, dt.month)]
        except (ValueError, TypeError):
            return jsonify({'success': False, 'error': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –º–µ—Å—è—Ü–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ YYYY-MM'}), 400
        period_label = month_str

    # ‚îÄ‚îÄ –¢–µ–∫—É—â–∏–π (–Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–π) –º–µ—Å—è—Ü ‚Üí –¥–∞–Ω–Ω—ã–µ –∏–∑ /v3/finance/transaction/list ‚îÄ‚îÄ
    now = _dt.now()
    current_ym = (now.year, now.month)

    if not is_quarter:
        # –û–¥–∏–Ω –º–µ—Å—è—Ü: –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        yr, mo = months_to_fetch[0]
        if (yr, mo) == current_ym:
            print(f"  üìä –ú–µ—Å—è—Ü {yr}-{mo:02d} –µ—â—ë –Ω–µ –∑–∞–∫—Ä—ã—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏")
            try:
                result = _build_realization_from_transactions(yr, mo)
                # –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—ã–∫—É–ø–∞–º –°–ù–ì
                import calendar as _cal
                last_day = _cal.monthrange(yr, mo)[1]
                d_from = f"{yr}-{mo:02d}-01"
                d_to = f"{yr}-{mo:02d}-{last_day}"
                buyout = _fetch_buyout_data(d_from, d_to)
                result['buyout'] = buyout
                # –†–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ä–µ–∫–ª–∞–º—É –ø–æ SKU –∑–∞ –ø–µ—Ä–∏–æ–¥
                result['adv_by_sku'] = _get_adv_spend_by_sku(d_from, d_to)
                return jsonify(result)
            except Exception as e:
                print(f"  ‚ùå –û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: {e}")
                return jsonify({'success': False, 'error': str(e)}), 500

    # –î–ª—è –∫–≤–∞—Ä—Ç–∞–ª–∞: –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ –º–µ—Å—è—Ü—ã —Ç–µ–∫—É—â–∏–µ (–Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ)
    current_month_in_quarter = None
    if is_quarter:
        for yr, mo in months_to_fetch:
            if (yr, mo) == current_ym:
                current_month_in_quarter = (yr, mo)
                break
        # –£–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü –∏–∑ realization-–∑–∞–ø—Ä–æ—Å–æ–≤ (–±—É–¥–µ—Ç —á–µ—Ä–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
        if current_month_in_quarter:
            months_to_fetch = [(yr, mo) for yr, mo in months_to_fetch if (yr, mo) != current_ym]
            print(f"  üìä –ö–≤–∞—Ä—Ç–∞–ª {period_label}: –º–µ—Å—è—Ü {current_ym[0]}-{current_ym[1]:02d} —á–µ—Ä–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏")
        # –ë—É–¥—É—â–∏–µ –º–µ—Å—è—Ü—ã —Ç–æ–∂–µ —É–±–∏—Ä–∞–µ–º (–µ—â—ë –Ω–µ –Ω–∞—á–∞–ª–∏—Å—å)
        months_to_fetch = [(yr, mo) for yr, mo in months_to_fetch
                           if (yr, mo) < current_ym]

    # ‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à (—Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–∫—Ä—ã—Ç—ã—Ö –º–µ—Å—è—Ü–µ–≤) ‚îÄ‚îÄ
    cache_key = quarter_str if quarter_str else month_str
    if not current_month_in_quarter:
        try:
            db_cache = sqlite3.connect(DB_PATH, timeout=10)
            row = db_cache.execute(
                'SELECT response_json FROM realization_cache WHERE period_key = ?',
                (cache_key,)
            ).fetchone()
            db_cache.close()
            if row:
                import json as _json_cache
                cached_data = _json_cache.loads(row[0])
                if 'adv_by_sku' not in cached_data:
                    # –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∫–ª–∞–º—É –∏ –°–û–•–†–ê–ù–Ø–ï–ú –≤ –∫—ç—à
                    print(f"  ‚ö° –†–µ–∞–ª–∏–∑–∞—Ü–∏—è {cache_key}: –∫—ç—à –±–µ–∑ —Ä–µ–∫–ª–∞–º—ã ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ Performance API –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º")
                    try:
                        if quarter_str:
                            import re as _re_q
                            _mq = _re_q.match(r'^(\d{4})-Q([1-4])$', quarter_str)
                            if _mq:
                                _qy, _qn = int(_mq.group(1)), int(_mq.group(2))
                                _qfm = {1:1,2:4,3:7,4:10}[_qn]
                                _qlm = _qfm + 2
                                _qld = calendar.monthrange(_qy, _qlm)[1]
                                cached_data['adv_by_sku'] = _get_adv_spend_by_sku(f"{_qy}-{_qfm:02d}-01", f"{_qy}-{_qlm:02d}-{_qld}")
                        else:
                            from datetime import datetime as _dtc
                            _dtm = _dtc.strptime(month_str, '%Y-%m')
                            _mld = calendar.monthrange(_dtm.year, _dtm.month)[1]
                            cached_data['adv_by_sku'] = _get_adv_spend_by_sku(f"{_dtm.year}-{_dtm.month:02d}-01", f"{_dtm.year}-{_dtm.month:02d}-{_mld}")
                    except Exception as _adv_e:
                        print(f"  ‚ö†Ô∏è –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è adv_by_sku –∫ –∫—ç—à—É: {_adv_e}")
                        cached_data['adv_by_sku'] = {}
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –∫—ç—à —Å adv_by_sku –æ–±—Ä–∞—Ç–Ω–æ –≤ –ë–î
                    try:
                        db_upd = sqlite3.connect(DB_PATH, timeout=10)
                        db_upd.execute(
                            'UPDATE realization_cache SET response_json = ? WHERE period_key = ?',
                            (_json_cache.dumps(cached_data, ensure_ascii=False), cache_key)
                        )
                        db_upd.commit()
                        db_upd.close()
                        print(f"  ‚úÖ –ö—ç—à {cache_key} –æ–±–Ω–æ–≤–ª—ë–Ω —Å adv_by_sku")
                    except Exception as _save_e:
                        print(f"  ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å adv_by_sku –≤ –∫—ç—à: {_save_e}")
                else:
                    print(f"  ‚ö° –†–µ–∞–ª–∏–∑–∞—Ü–∏—è {cache_key}: –æ—Ç–¥–∞—ë–º –∏–∑ –∫—ç—à–∞ (—Å —Ä–µ–∫–ª–∞–º–æ–π)")
                return jsonify(cached_data)
            else:
                print(f"  üì≠ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è {cache_key}: –∫—ç—à –ø—É—Å—Ç, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ API")
        except Exception as e:
            print(f"  ‚ö†Ô∏è –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫—ç—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: {e}")

    # ‚îÄ‚îÄ –ó–∞–ø—Ä–æ—Å—ã –∫ Ozon API /v2/finance/realization ‚îÄ‚îÄ
    ozon_headers = get_ozon_headers()
    all_rows = []
    first_header = {}
    errors = []

    def _fetch_realization_month(yr, mo):
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–∞ –æ–¥–∏–Ω –º–µ—Å—è—Ü."""
        payload = {"year": yr, "month": mo}
        print(f"  üìä –ó–∞–ø—Ä–æ—Å –∞–∫—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: {yr}-{mo:02d}")
        return yr, mo, requests.post(
            f"{OZON_HOST}/v2/finance/realization",
            json=payload, headers=ozon_headers, timeout=60
        )

    try:
        if len(months_to_fetch) > 1:
            # –ö–≤–∞—Ä—Ç–∞–ª: –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (–¥–æ 3 –ø–æ—Ç–æ–∫–æ–≤)
            from concurrent.futures import ThreadPoolExecutor, as_completed
            print(f"  üìä –†–µ–∞–ª–∏–∑–∞—Ü–∏—è {period_label}: {len(months_to_fetch)} –º–µ—Å—è—Ü–µ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ...")
            month_results = {}
            with ThreadPoolExecutor(max_workers=3) as executor:
                futures = {
                    executor.submit(_fetch_realization_month, yr, mo): (yr, mo)
                    for yr, mo in months_to_fetch
                }
                for future in as_completed(futures):
                    yr, mo, resp = future.result()
                    if resp.status_code != 200:
                        err_text = resp.text[:300]
                        print(f"  ‚ùå Ozon API /v2/finance/realization: HTTP {resp.status_code} ‚Äî {err_text}")
                        errors.append(f"{yr}-{mo:02d}: HTTP {resp.status_code}")
                    else:
                        data = resp.json()
                        result = data.get('result', {})
                        header = result.get('header', {})
                        rows = result.get('rows', [])
                        month_results[(yr, mo)] = (header, rows)
                        print(f"  ‚úÖ –ü–æ–ª—É—á–µ–Ω–æ {len(rows)} —Å—Ç—Ä–æ–∫ –∑–∞ {yr}-{mo:02d}")

            # –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –ø–æ—Ä—è–¥–∫–µ –º–µ—Å—è—Ü–µ–≤
            for yr, mo in months_to_fetch:
                if (yr, mo) in month_results:
                    header, rows = month_results[(yr, mo)]
                    if not first_header and header:
                        first_header = header
                    all_rows.extend(rows)
        elif len(months_to_fetch) == 1:
            # –û–¥–∏–Ω –º–µ—Å—è—Ü: –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å
            yr, mo = months_to_fetch[0]
            yr, mo, resp = _fetch_realization_month(yr, mo)
            if resp.status_code != 200:
                err_text = resp.text[:300]
                print(f"  ‚ùå Ozon API /v2/finance/realization: HTTP {resp.status_code} ‚Äî {err_text}")
                errors.append(f"{yr}-{mo:02d}: HTTP {resp.status_code}")
            else:
                data = resp.json()
                result = data.get('result', {})
                first_header = result.get('header', {})
                all_rows = result.get('rows', [])
                print(f"  ‚úÖ –ü–æ–ª—É—á–µ–Ω–æ {len(all_rows)} —Å—Ç—Ä–æ–∫ –∑–∞ {yr}-{mo:02d}")

        if errors and not all_rows and not current_month_in_quarter:
            return jsonify({
                'success': False,
                'error': '–û—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏: ' + '; '.join(errors)
            }), 502

        rows = all_rows
        header = first_header

        # –î–ª—è –∫–≤–∞—Ä—Ç–∞–ª–∞ –ø–æ–¥–º–µ–Ω—è–µ–º –¥–∞—Ç—ã –ø–µ—Ä–∏–æ–¥–∞ –≤ header
        if is_quarter and header and months_to_fetch:
            first_mo = months_to_fetch[0]
            last_mo = months_to_fetch[-1]
            last_day = calendar.monthrange(last_mo[0], last_mo[1])[1]
            header['start_date'] = f"{first_mo[0]}-{first_mo[1]:02d}-01"
            header['stop_date'] = f"{last_mo[0]}-{last_mo[1]:02d}-{last_day}"
            header['number'] = f"{period_label} (—Å–≤–æ–¥–Ω—ã–π)"

        total_rows_count = len(rows)
        print(f"  üìä –ò—Ç–æ–≥–æ —Å—Ç—Ä–æ–∫ –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏: {total_rows_count} ({period_label})")

        # ‚îÄ‚îÄ –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å—Ç—Ä–æ–∫–∞–º ‚îÄ‚îÄ
        # –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî —Ç–æ–≤–∞—Ä–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è (–º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∞ –∏/–∏–ª–∏ –≤–æ–∑–≤—Ä–∞—Ç).
        # seller_price_per_instance ‚Äî –≥—Ä–æ—Å—Å-—Ü–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è.
        # delivery_commission ‚Äî –¥–∞–Ω–Ω—ã–µ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–∞–º (–ø—Ä–æ–¥–∞–∂–∞–º).
        # return_commission ‚Äî –¥–∞–Ω–Ω—ã–µ –ø–æ –≤–æ–∑–≤—Ä–∞—Ç–∞–º (–∏–ª–∏ null).

        gross_sales = 0.0           # –ì—Ä–æ—Å—Å-–ø—Ä–æ–¥–∞–∂–∏ (seller_price * delivery_qty)
        returns_total = 0.0         # –í–æ–∑–≤—Ä–∞—Ç—ã (seller_price * return_qty, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ)
        commission_total = 0.0      # –ü–æ–ª–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è Ozon (delivery + return .total)
        seller_receives = 0.0       # –ö –ø–æ–ª—É—á–µ–Ω–∏—é –ø—Ä–æ–¥–∞–≤—Ü–æ–º (delivery .amount)
        bonuses_total = 0.0         # –ë–æ–Ω—É—Å—ã Ozon
        standard_fee_total = 0.0    # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è
        stars_total = 0.0           # –ó–≤—ë–∑–¥—ã
        bank_coinvest_total = 0.0   # –°–æ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–Ω–∫–æ–º
        pup_coinvest_total = 0.0    # –°–æ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –ü–í–ó (pick_up_point_coinvestment)
        delivery_count = 0          # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç–∞–≤–æ–∫
        return_count = 0            # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤
        acquiring_total = 0.0       # –≠–∫–≤–∞–π—Ä–∏–Ω–≥ (delivery_commission.commission)
        return_gross_total = 0.0    # –ì—Ä–æ—Å—Å-–≤–æ–∑–≤—Ä–∞—Ç—ã (seller_price * return_qty)

        # –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ —Ç–æ–≤–∞—Ä–∞–º (SKU)
        products_map = {}

        for row in rows:
            seller_price = row.get('seller_price_per_instance', 0)
            ratio = row.get('commission_ratio', 0)
            item_info = row.get('item', {})
            offer_id = item_info.get('offer_id', '')
            sku = str(item_info.get('sku', ''))
            name = item_info.get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä')
            barcode = item_info.get('barcode', '')

            dc = row.get('delivery_commission') or {}
            rc = row.get('return_commission') or {}

            # –î–æ—Å—Ç–∞–≤–∫–∏ (–ø—Ä–æ–¥–∞–∂–∏)
            d_qty = dc.get('quantity', 0)
            d_amount = dc.get('amount', 0)          # –ö –ø–æ–ª—É—á–µ–Ω–∏—é –ø—Ä–æ–¥–∞–≤—Ü–æ–º
            d_total_comm = dc.get('total', 0)        # –ü–æ–ª–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è Ozon
            d_bonus = dc.get('bonus', 0)
            d_std_fee = dc.get('standard_fee', 0)
            d_stars = dc.get('stars', 0)
            d_bank = dc.get('bank_coinvestment', 0)
            d_pup = dc.get('pick_up_point_coinvestment', 0)

            # –í–æ–∑–≤—Ä–∞—Ç—ã (–≤—Å–µ –ø–æ–ª—è ‚Äî –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ, —É–º–µ–Ω—å—à–∞—é—Ç –∏—Ç–æ–≥–∏)
            r_qty = rc.get('quantity', 0)
            r_amount = rc.get('amount', 0)
            r_total_comm = rc.get('total', 0)
            r_bonus = rc.get('bonus', 0)
            r_std_fee = rc.get('standard_fee', 0)    # –í–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏
            r_stars = rc.get('stars', 0)             # –í–æ–∑–≤—Ä–∞—Ç –∑–≤—ë–∑–¥
            r_bank = rc.get('bank_coinvestment', 0)  # –í–æ–∑–≤—Ä–∞—Ç —Å–æ–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            r_pup = rc.get('pick_up_point_coinvestment', 0)  # –í–æ–∑–≤—Ä–∞—Ç —Å–æ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è –ü–í–ó

            # –ì—Ä–æ—Å—Å-–ø—Ä–æ–¥–∞–∂–∏ = —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞ * –∫–æ–ª-–≤–æ –¥–æ—Å—Ç–∞–≤–æ–∫
            row_gross_sales = seller_price * d_qty
            # –ì—Ä–æ—Å—Å-–≤–æ–∑–≤—Ä–∞—Ç—ã = —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞ * –∫–æ–ª-–≤–æ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤
            row_return_gross = seller_price * r_qty
            # –í–æ–∑–≤—Ä–∞—Ç—ã = return_commission.amount (–í–æ–∑–≤—Ä–∞—â–µ–Ω–æ –Ω–∞ —Å—É–º–º—É)
            row_returns = abs(r_amount) if r_amount else 0

            # –≠–∫–≤–∞–π—Ä–∏–Ω–≥ (–ø–æ–ª–µ commission –≤ API)
            d_acquiring = dc.get('commission', 0)
            r_acquiring = rc.get('commission', 0) if rc else 0

            gross_sales += row_gross_sales
            return_gross_total += row_return_gross
            returns_total += row_returns
            commission_total += d_total_comm + r_total_comm
            seller_receives += d_amount - r_amount          # –î–æ—Å—Ç–∞–≤–∫–∏ –º–∏–Ω—É—Å –≤–æ–∑–≤—Ä–∞—Ç—ã (r_amount –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –≤ API)
            bonuses_total += d_bonus - r_bonus              # –ß–∏—Å—Ç—ã–µ –±–∞–ª–ª—ã –∑–∞ —Å–∫–∏–¥–∫–∏
            standard_fee_total += d_std_fee - r_std_fee    # –ß–∏—Å—Ç–∞—è –∫–æ–º–∏—Å—Å–∏—è (–¥–æ—Å—Ç–∞–≤–∫–∏ –º–∏–Ω—É—Å –≤–æ–∑–≤—Ä–∞—Ç)
            stars_total += d_stars - r_stars                # –ß–∏—Å—Ç—ã–µ –∑–≤—ë–∑–¥—ã
            bank_coinvest_total += d_bank - r_bank          # –ß–∏—Å—Ç–æ–µ —Å–æ–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            pup_coinvest_total += d_pup - r_pup            # –ß–∏—Å—Ç–æ–µ —Å–æ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –ü–í–ó
            acquiring_total += d_acquiring + r_acquiring
            delivery_count += d_qty
            return_count += r_qty

            # –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ —Ç–æ–≤–∞—Ä–∞–º ‚Äî –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ products_map
            product_key = sku or offer_id or barcode or '_unknown'
            if product_key not in products_map:
                products_map[product_key] = {
                    'name': name[:80] if name else '–ü—Ä–æ—á–µ–µ',
                    'sku': sku,
                    'offer_id': offer_id,
                    'seller_price_sum': 0.0,       # –°—É–º–º–∞ (seller_price * d_qty) –¥–ª—è —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–æ–π —Ü–µ–Ω—ã
                    'standard_fee': 0.0,           # –ö–æ–º–∏—Å—Å–∏—è –ú–ü –ø–æ —Ç–æ–≤–∞—Ä—É
                    'acquiring': 0.0,              # –≠–∫–≤–∞–π—Ä–∏–Ω–≥ –ø–æ —Ç–æ–≤–∞—Ä—É
                    'bank_coinvestment': 0.0,      # –°–æ–∏–Ω–≤–µ—Å—Ç –ø–æ —Ç–æ–≤–∞—Ä—É
                    'delivery_qty': 0,
                    'return_qty': 0,
                    'gross_sales': 0.0,
                    'return_gross': 0.0,
                    'returns': 0.0,
                    'total_deductions': 0.0,       # –í—Å–µ —É–¥–µ—Ä–∂–∞–Ω–∏—è (total)
                    'seller_receives': 0.0,
                    'bonus': 0.0
                }
            p = products_map[product_key]
            p['delivery_qty'] += d_qty
            p['return_qty'] += r_qty
            p['gross_sales'] += row_gross_sales
            p['return_gross'] += row_return_gross
            p['returns'] += row_returns
            p['total_deductions'] += d_total_comm + r_total_comm
            p['seller_receives'] += d_amount - r_amount
            p['bonus'] += d_bonus + r_bonus
            p['standard_fee'] += d_std_fee - r_std_fee  # –ß–∏—Å—Ç–∞—è –∫–æ–º–∏—Å—Å–∏—è: –¥–æ—Å—Ç–∞–≤–∫–∏ –º–∏–Ω—É—Å –≤–æ–∑–≤—Ä–∞—Ç—ã
            p['acquiring'] += d_acquiring + r_acquiring
            p['bank_coinvestment'] += d_bank
            if d_qty > 0:
                p['seller_price_sum'] += seller_price * d_qty

        # ‚îÄ‚îÄ –ò—Ç–æ–≥–∏ ‚îÄ‚îÄ
        net_total = seller_receives

        # –ö–æ–º–∏—Å—Å–∏—è –ú–ü = delivery standard_fee + —ç–∫–≤–∞–π—Ä–∏–Ω–≥ (commission)
        marketplace_commission = standard_fee_total + acquiring_total

        # –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π % –∫–æ–º–∏—Å—Å–∏–∏ = –∫–æ–º–∏—Å—Å–∏—è –ú–ü / –≤–∞–ª–æ–≤—ã–µ –≥—Ä–æ—Å—Å-–ø—Ä–æ–¥–∞–∂–∏
        avg_commission_pct = (marketplace_commission / gross_sales * 100) if gross_sales > 0 else 0

        # ‚îÄ‚îÄ –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ (–ø–æ SKU) ‚îÄ‚îÄ
        products_list = []
        for key, pdata in sorted(products_map.items(),
                                  key=lambda x: abs(x[1]['gross_sales']), reverse=True):
            dq = pdata['delivery_qty']
            avg_price = pdata['seller_price_sum'] / dq if dq > 0 else 0

            # –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π % –∫–æ–º–∏—Å—Å–∏–∏ –ú–ü –ø–æ —Ç–æ–≤–∞—Ä—É = (standard_fee + —ç–∫–≤–∞–π—Ä–∏–Ω–≥) / –≥—Ä–æ—Å—Å
            p_commission = pdata['standard_fee'] + pdata['acquiring']
            p_commission_pct = (p_commission / pdata['gross_sales'] * 100) if pdata['gross_sales'] > 0 else 0

            products_list.append({
                'sku': pdata['sku'],
                'offer_id': pdata['offer_id'],
                'name': pdata['name'],
                'seller_price': round(avg_price, 2),
                'commission_ratio': round(p_commission_pct, 2),
                'delivery_qty': pdata['delivery_qty'],
                'return_qty': pdata['return_qty'],
                'gross_sales': round(pdata['gross_sales'], 2),
                'return_gross': round(pdata['return_gross'], 2),
                'returns': round(pdata['returns'], 2),
                'commission': round(p_commission, 2),
                'seller_receives': round(pdata['seller_receives'], 2),
                'bonus': round(pdata['bonus'], 2)
            })

        # ‚îÄ‚îÄ –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç ‚îÄ‚îÄ
        response_data = {
            'success': True,
            'period': period_label,
            'is_quarter': is_quarter,
            'header': {
                'number': header.get('number', ''),
                'doc_date': header.get('doc_date', ''),
                'start_date': header.get('start_date', ''),
                'stop_date': header.get('stop_date', ''),
                'contract_date': header.get('contract_date', ''),
                'contract_number': header.get('contract_number', ''),
                'payer_name': header.get('payer_name', ''),
                'payer_inn': header.get('payer_inn', ''),
                'payer_kpp': header.get('payer_kpp', ''),
                'rcv_name': header.get('rcv_name', ''),
                'rcv_inn': header.get('rcv_inn', ''),
                'rcv_kpp': header.get('rcv_kpp', ''),
            },
            'summary': {
                'gross_sales': round(gross_sales, 2),
                'returns': round(returns_total, 2),
                'commission': round(marketplace_commission, 2),     # –ö–æ–º–∏—Å—Å–∏—è –ú–ü (standard_fee + —ç–∫–≤–∞–π—Ä–∏–Ω–≥)
                'total_deductions': round(commission_total, 2),     # –í—Å–µ —É–¥–µ—Ä–∂–∞–Ω–∏—è (total)
                'seller_receives': round(seller_receives, 2),
                'bonuses': round(bonuses_total, 2),
                'standard_fee': round(standard_fee_total, 2),
                'stars': round(stars_total, 2),
                'bank_coinvestment': round(bank_coinvest_total, 2),
                'net_total': round(net_total, 2),
                'avg_commission_pct': round(avg_commission_pct, 2),  # % = (standard_fee + —ç–∫–≤–∞–π—Ä–∏–Ω–≥) / gross
                'delivery_count': delivery_count,
                'return_count': return_count,
                'return_gross': round(return_gross_total, 2),
                'sales_after_spp': round(seller_receives + bank_coinvest_total + pup_coinvest_total, 2),
            },
            'products': products_list,
            'total_rows': total_rows_count,
            'total_products': len(products_list),
            'warnings': errors if errors else None
        }

        # ‚îÄ‚îÄ –ï—Å–ª–∏ –∫–≤–∞—Ä—Ç–∞–ª —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π ‚îÄ‚îÄ
        if current_month_in_quarter:
            try:
                tx_yr, tx_mo = current_month_in_quarter
                tx_data = _build_realization_from_transactions(tx_yr, tx_mo)
                if tx_data.get('success'):
                    tx_s = tx_data.get('summary', {})
                    s = response_data['summary']
                    # –°—É–º–º–∏—Ä—É–µ–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
                    s['gross_sales'] = round(s['gross_sales'] + tx_s.get('gross_sales', 0), 2)
                    s['returns'] = round(s['returns'] + tx_s.get('returns', 0), 2)
                    s['commission'] = round(s['commission'] + tx_s.get('commission', 0), 2)
                    s['total_deductions'] = round(s['total_deductions'] + tx_s.get('total_deductions', 0), 2)
                    s['seller_receives'] = round(s['seller_receives'] + tx_s.get('seller_receives', 0), 2)
                    s['net_total'] = round(s['net_total'] + tx_s.get('net_total', 0), 2)
                    s['delivery_count'] += tx_s.get('delivery_count', 0)
                    s['return_count'] += tx_s.get('return_count', 0)
                    s['return_gross'] = round(s.get('return_gross', 0) + tx_s.get('return_gross', 0), 2)
                    s['sales_after_spp'] = round(s.get('sales_after_spp', 0) + tx_s.get('sales_after_spp', 0), 2)
                    # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–∏–π % –∫–æ–º–∏—Å—Å–∏–∏ –æ—Ç –≤–∞–ª–æ–≤–æ–≥–æ –≥—Ä–æ—Å—Å–∞
                    if s['gross_sales'] > 0:
                        s['avg_commission_pct'] = round(s['commission'] / s['gross_sales'] * 100, 2)
                    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (merge –ø–æ sku)
                    existing_skus = {p['sku']: p for p in response_data['products']}
                    for tp in tx_data.get('products', []):
                        sku = tp['sku']
                        if sku in existing_skus:
                            ep = existing_skus[sku]
                            ep['delivery_qty'] += tp['delivery_qty']
                            ep['return_qty'] += tp['return_qty']
                            ep['gross_sales'] = round(ep['gross_sales'] + tp['gross_sales'], 2)
                            ep['returns'] = round(ep['returns'] + tp['returns'], 2)
                            ep['commission'] = round(ep['commission'] + tp['commission'], 2)
                            ep['seller_receives'] = round(ep['seller_receives'] + tp['seller_receives'], 2)
                        else:
                            response_data['products'].append(tp)
                    # –ü–µ—Ä–µ—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≥—Ä–æ—Å—Å-–ø—Ä–æ–¥–∞–∂–∞–º
                    response_data['products'].sort(key=lambda x: abs(x['gross_sales']), reverse=True)
                    response_data['total_products'] = len(response_data['products'])
                    response_data['warnings'] = '–í–∫–ª—é—á–∞–µ—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü'
                    print(f"  ‚úÖ –ö–≤–∞—Ä—Ç–∞–ª {period_label}: –¥–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∑–∞ {tx_yr}-{tx_mo:02d} –¥–æ–±–∞–≤–ª–µ–Ω—ã")
            except Exception as e:
                print(f"  ‚ö†Ô∏è –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –∫–≤–∞—Ä—Ç–∞–ª: {e}")

        # ‚îÄ‚îÄ –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—ã–∫—É–ø–∞–º –°–ù–ì ‚îÄ‚îÄ
        try:
            if is_quarter:
                # –ö–≤–∞—Ä—Ç–∞–ª: –ø–æ–ª–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω Q1=01-01..03-31 –∏ —Ç.–¥.
                q_first_mo = quarter_months[q_num][0]
                q_last_mo = quarter_months[q_num][-1]
                q_last_day = calendar.monthrange(q_year, q_last_mo)[1]
                buyout_from = f"{q_year}-{q_first_mo:02d}-01"
                buyout_to = f"{q_year}-{q_last_mo:02d}-{q_last_day}"
            else:
                # –û–¥–∏–Ω –º–µ—Å—è—Ü
                m_yr, m_mo = months_to_fetch[0] if months_to_fetch else (now.year, now.month)
                m_last_day = calendar.monthrange(m_yr, m_mo)[1]
                buyout_from = f"{m_yr}-{m_mo:02d}-01"
                buyout_to = f"{m_yr}-{m_mo:02d}-{m_last_day}"
            buyout = _fetch_buyout_data(buyout_from, buyout_to)
            response_data['buyout'] = buyout
            # –†–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ä–µ–∫–ª–∞–º—É –ø–æ SKU –∑–∞ –ø–µ—Ä–∏–æ–¥
            response_data['adv_by_sku'] = _get_adv_spend_by_sku(buyout_from, buyout_to)
        except Exception as e:
            print(f"  ‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—ã–∫—É–ø–æ–≤ –°–ù–ì: {e}")
            response_data['buyout'] = {'count': 0, 'amount': 0.0, 'products': []}

        # ‚îÄ‚îÄ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à (—Ç–æ–ª—å–∫–æ –∑–∞–∫—Ä—ã—Ç—ã–µ –ø–µ—Ä–∏–æ–¥—ã ‚Äî —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü –Ω–µ –∫—ç—à–∏—Ä—É–µ–º) ‚îÄ‚îÄ
        if not current_month_in_quarter:
            try:
                import json as _json
                response_json = _json.dumps(response_data, ensure_ascii=False)
                db_cache = sqlite3.connect(DB_PATH, timeout=10)
                db_cache.execute(
                    'INSERT OR REPLACE INTO realization_cache (period_key, response_json, cached_at) VALUES (?, ?, ?)',
                    (cache_key, response_json, _dt.now().isoformat())
                )
                db_cache.commit()
                db_cache.close()
                print(f"  üíæ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è {cache_key}: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∫—ç—à")
            except Exception as e:
                print(f"  ‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –∫—ç—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: {e}")

        return jsonify(response_data)

    except requests.exceptions.Timeout:
        return jsonify({'success': False, 'error': '–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ Ozon API'}), 504
    except requests.exceptions.ConnectionError:
        return jsonify({'success': False, 'error': '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Ozon API'}), 502
    except Exception as e:
        print(f"  ‚ùå –û—à–∏–±–∫–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500


# ============================================================================
# API –§–ò–ù–ê–ù–°–´ ‚Äî –°–ï–ë–ï–°–¢–û–ò–ú–û–°–¢–¨ (FIFO)
# ============================================================================
# –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –º–µ—Ç–æ–¥—É FIFO.
# –ë–µ—Ä—ë—Ç —Å–ª–æ–∏ –ø—Ä–∏—Ö–æ–¥–æ–≤ –∏–∑ warehouse_receipts (–æ—Ç —Å–∞–º—ã—Ö —Å—Ç–∞—Ä—ã—Ö –∫ –Ω–æ–≤—ã–º),
# —É—á–∏—Ç—ã–≤–∞–µ—Ç –∫—É–º—É–ª—è—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏ –∏–∑ realization_cache –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ
# ¬´–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è¬ª —Å–ª–æ—ë–≤.
# ============================================================================


def _fifo_cogs(layers, skip_qty, consume_qty):
    """
    –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ –º–µ—Ç–æ–¥—É FIFO.

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        layers (list): –°–ø–∏—Å–æ–∫ —Å–ª–æ—ë–≤ –ø—Ä–∏—Ö–æ–¥–æ–≤ [{qty, cost, date}, ...],
                       –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –¥–∞—Ç–µ (–æ—Ç —Å—Ç–∞—Ä—ã—Ö –∫ –Ω–æ–≤—ã–º).
        skip_qty (int): –°–∫–æ–ª—å–∫–æ –µ–¥–∏–Ω–∏—Ü —É–∂–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–æ –ø—Ä–æ—à–ª—ã–º–∏ –ø–µ—Ä–∏–æ–¥–∞–º–∏.
        consume_qty (int): –°–∫–æ–ª—å–∫–æ –µ–¥–∏–Ω–∏—Ü –ø—Ä–æ–¥–∞–Ω–æ –≤ —Ç–µ–∫—É—â–µ–º –ø–µ—Ä–∏–æ–¥–µ.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        tuple: (total_cogs, avg_cost_per_unit, details)
    """
    if not layers or consume_qty <= 0:
        return 0.0, 0.0, []

    total_cogs = 0.0
    details = []
    remaining_skip = skip_qty
    remaining_consume = consume_qty

    for layer in layers:
        if remaining_consume <= 0:
            break

        layer_qty = layer['qty']
        layer_cost = layer['cost']

        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ–¥–∏–Ω–∏—Ü—ã, —É–∂–µ –ø–æ—Ç—Ä–µ–±–ª—ë–Ω–Ω—ã–µ –ø—Ä–æ—à–ª—ã–º–∏ –ø–µ—Ä–∏–æ–¥–∞–º–∏
        if remaining_skip > 0:
            skip_from_layer = min(remaining_skip, layer_qty)
            layer_qty -= skip_from_layer
            remaining_skip -= skip_from_layer

        if layer_qty <= 0:
            continue

        # –ü–æ—Ç—Ä–µ–±–ª—è–µ–º –µ–¥–∏–Ω–∏—Ü—ã –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–ª–æ—è
        take = min(remaining_consume, layer_qty)
        cost_for_take = round(take * layer_cost, 2)
        total_cogs += cost_for_take
        remaining_consume -= take

        details.append({
            'qty': take,
            'cost': round(layer_cost, 2),
            'date': layer['date'],
            'subtotal': cost_for_take
        })

    avg_cost = round(total_cogs / consume_qty, 2) if consume_qty > 0 and total_cogs > 0 else 0.0
    return round(total_cogs, 2), avg_cost, details


def _get_cumulative_prior_sales(period_start_str):
    """
    –ü–æ–ª—É—á–∏—Ç—å –∫—É–º—É–ª—è—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏ –ø–æ SKU –∏–∑ –∫—ç—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
    –∑–∞ –≤—Å–µ –º–µ—Å—è—Ü—ã –î–û —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞.

    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–∫—Ä—ã—Ç—ã–µ –º–µ—Å—è—Ü—ã –∏–∑ Ozon API,
    —á—Ç–æ–±—ã –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫—ç—à–∞ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Ç–µ—Ä—è–ª–∏—Å—å.

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        period_start_str (str): –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞ "YYYY-MM-DD"

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        dict: {sku_str: net_sales_qty, ...}
    """
    import json as _json
    from datetime import datetime as _dt

    period_month = period_start_str[:7]  # "2025-12"
    cumulative = {}

    try:
        conn = sqlite3.connect(DB_PATH, timeout=10)

        # ‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –º–µ—Å—è—Ü—ã –∏ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –∏—Ö ‚îÄ‚îÄ
        cached_keys = set()
        for row in conn.execute('SELECT period_key FROM realization_cache').fetchall():
            cached_keys.add(row[0])

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—Å–µ –º–µ—Å—è—Ü—ã –æ—Ç 2025-01 –¥–æ period_month (–Ω–µ –≤–∫–ª—é—á–∞—è)
        now = _dt.now()
        current_ym = f"{now.year}-{now.month:02d}"
        start_year, start_month = 2025, 1
        end_year, end_month = int(period_month[:4]), int(period_month[5:7])

        missing_months = []
        y, m = start_year, start_month
        while f"{y}-{m:02d}" < period_month:
            key = f"{y}-{m:02d}"
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–µ–∫—É—â–∏–π (–Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–π) –º–µ—Å—è—Ü ‚Äî –µ–≥–æ –Ω–µ—Ç –≤ /v2/finance/realization
            if key != current_ym and key not in cached_keys:
                missing_months.append(key)
            m += 1
            if m > 12:
                m = 1
                y += 1

        conn.close()

        # –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–∫—Ä—ã—Ç—ã–µ –º–µ—Å—è—Ü—ã –Ω–∞–ø—Ä—è–º—É—é –∏–∑ Ozon API
        if missing_months:
            print(f"  üì• COGS: –ø–æ–¥–≥—Ä—É–∂–∞–µ–º {len(missing_months)} –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –º–µ—Å—è—Ü–µ–≤: {missing_months}")
            ozon_headers = get_ozon_headers()
            for mk in missing_months:
                try:
                    yr = int(mk[:4])
                    mo = int(mk[5:7])
                    resp = requests.post(
                        f"{OZON_HOST}/v2/finance/realization",
                        json={"year": yr, "month": mo},
                        headers=ozon_headers, timeout=60
                    )
                    if resp.status_code != 200:
                        print(f"  ‚ö†Ô∏è Ozon API {mk}: HTTP {resp.status_code}")
                        continue
                    api_rows = resp.json().get('result', {}).get('rows', [])
                    # –ü–∞—Ä—Å–∏–º products –¥–ª—è –∫—É–º—É–ª—è—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂ (–±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è)
                    month_products = {}
                    for row in api_rows:
                        sp = row.get('seller_price_per_instance', 0)
                        item = row.get('item', {})
                        sku = str(item.get('sku', ''))
                        if not sku:
                            continue
                        dc = row.get('delivery_commission') or {}
                        rc = row.get('return_commission') or {}
                        d_qty = dc.get('quantity', 0)
                        r_qty = rc.get('quantity', 0)
                        if sku not in month_products:
                            month_products[sku] = {'delivery_qty': 0, 'return_qty': 0}
                        month_products[sku]['delivery_qty'] += d_qty
                        month_products[sku]['return_qty'] += r_qty
                    # –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫—É–º—É–ª—è—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏
                    for sku, pdata in month_products.items():
                        net = pdata['delivery_qty'] - pdata['return_qty']
                        if net > 0:
                            cumulative[sku] = cumulative.get(sku, 0) + net
                    print(f"  ‚úÖ COGS: {mk} ‚Äî {len(api_rows)} —Å—Ç—Ä–æ–∫, {len(month_products)} —Ç–æ–≤–∞—Ä–æ–≤")
                except Exception as e:
                    print(f"  ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å {mk}: {e}")

        # ‚îÄ‚îÄ –°—á–∏—Ç–∞–µ–º –∫—É–º—É–ª—è—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏ –∏–∑ –∫—ç—à–∞ (—Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ–≥–æ) ‚îÄ‚îÄ
        conn = sqlite3.connect(DB_PATH, timeout=10)
        rows = conn.execute('SELECT period_key, response_json FROM realization_cache').fetchall()
        conn.close()

        for period_key, response_json in rows:
            if len(period_key) != 7 or 'Q' in period_key:
                continue
            if period_key >= period_month:
                continue

            try:
                data = _json.loads(response_json)
                for p in data.get('products', []):
                    sku = str(p.get('sku', ''))
                    if not sku:
                        continue
                    net_qty = (p.get('delivery_qty', 0) or 0) - (p.get('return_qty', 0) or 0)
                    if net_qty > 0:
                        cumulative[sku] = cumulative.get(sku, 0) + net_qty
            except (ValueError, KeyError):
                continue

    except Exception as e:
        print(f"  ‚ö†Ô∏è –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫—É–º—É–ª—è—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂: {e}")

    return cumulative


@app.route('/api/finance/realization/turnover')
@require_auth()
def api_finance_realization_turnover():
    """
    –ë—ã—Å—Ç—Ä—ã–π —Ä–∞—Å—á—ë—Ç –æ–±–æ—Ä–æ—Ç–∞ (sales_after_spp) –∏–∑ –∫—ç—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.
    –°—É–º–º–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –º–µ—Å—è—Ü–∞–º –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.

    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        date_from (str): –ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞ YYYY-MM-DD
        date_to (str): –ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞ YYYY-MM-DD

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        JSON: { success, sales_after_spp }
    """
    import json as _json
    from datetime import datetime as _dt

    date_from_str = request.args.get('date_from', '')
    date_to_str = request.args.get('date_to', '')
    if not date_from_str or not date_to_str:
        return jsonify({'success': False, 'error': 'date_from –∏ date_to –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã'}), 400

    try:
        start = _dt.strptime(date_from_str, '%Y-%m-%d').date()
        end = _dt.strptime(date_to_str, '%Y-%m-%d').date()
    except ValueError:
        return jsonify({'success': False, 'error': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç'}), 400

    # –°–æ–±–∏—Ä–∞–µ–º –∫–ª—é—á–∏ –º–µ—Å—è—Ü–µ–≤ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ
    month_keys = []
    current = start.replace(day=1)
    while current <= end:
        month_keys.append(f"{current.year}-{current.month:02d}")
        if current.month == 12:
            current = current.replace(year=current.year + 1, month=1)
        else:
            current = current.replace(month=current.month + 1)

    total_sales = 0
    try:
        conn = sqlite3.connect(DB_PATH, timeout=10)
        placeholders = ','.join('?' * len(month_keys))
        rows = conn.execute(
            f'SELECT period_key, response_json FROM realization_cache WHERE period_key IN ({placeholders})',
            month_keys
        ).fetchall()
        conn.close()

        for _key, resp_json in rows:
            data = _json.loads(resp_json)
            if data.get('success') and data.get('summary'):
                total_sales += data['summary'].get('sales_after_spp', 0)
                # –î–æ–±–∞–≤–ª—è–µ–º –°–ù–ì –µ—Å–ª–∏ –µ—Å—Ç—å
                buyout = data.get('buyout')
                if buyout:
                    total_sales += buyout.get('seller_price_total', 0)
    except Exception as e:
        print(f"  ‚ö†Ô∏è –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫—ç—à–∞ –æ–±–æ—Ä–æ—Ç–∞: {e}")

    return jsonify({'success': True, 'sales_after_spp': total_sales})


@app.route('/api/finance/realization/cogs', methods=['POST'])
@require_auth(['admin', 'viewer'])
def api_finance_realization_cogs():
    """
    –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (COGS) –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ –º–µ—Ç–æ–¥—É FIFO.

    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç JSON:
        products: [{sku: "123", net_qty: 50}, ...]
        period_start: "YYYY-MM-DD"

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON:
        success, total_cogs, products: {sku: {cogs, avg_cost, details, uncovered_qty}}
    """
    try:
        data = request.get_json(force=True)
        products = data.get('products', [])
        period_start = data.get('period_start', '')

        if not products:
            return jsonify({'success': True, 'total_cogs': 0, 'products': {}})

        skus_info = {}
        for p in products:
            sku = str(p.get('sku', ''))
            if sku:
                skus_info[sku] = p.get('net_qty', 0)

        if not skus_info:
            return jsonify({'success': True, 'total_cogs': 0, 'products': {}})

        cumulative_prior = _get_cumulative_prior_sales(period_start) if period_start else {}

        conn = sqlite3.connect(DB_PATH, timeout=10)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        sku_list = list(skus_info.keys())
        placeholders = ','.join('?' * len(sku_list))

        cursor.execute(f'''
            SELECT sku, receipt_date, quantity,
                   COALESCE(NULLIF(calculated_cost, 0), purchase_price, 0) as cost_per_unit
            FROM warehouse_receipts
            WHERE sku IN ({placeholders})
            ORDER BY receipt_date ASC, id ASC
        ''', sku_list)

        layers_by_sku = {}
        for row in cursor.fetchall():
            sku = str(row['sku'])
            if sku not in layers_by_sku:
                layers_by_sku[sku] = []
            layers_by_sku[sku].append({
                'qty': row['quantity'],
                'cost': row['cost_per_unit'] or 0,
                'date': row['receipt_date'] or ''
            })

        conn.close()

        result_products = {}
        total_cogs = 0.0

        for sku, net_qty in skus_info.items():
            if net_qty <= 0:
                result_products[sku] = {'cogs': 0, 'avg_cost': 0, 'details': [], 'uncovered_qty': 0}
                continue

            layers = layers_by_sku.get(sku, [])
            if not layers:
                result_products[sku] = {'cogs': 0, 'avg_cost': 0, 'details': [], 'uncovered_qty': net_qty}
                continue

            prior_sales = cumulative_prior.get(sku, 0)
            cogs, avg_cost, details = _fifo_cogs(layers, prior_sales, net_qty)

            covered = sum(d['qty'] for d in details)
            uncovered = net_qty - covered

            result_products[sku] = {
                'cogs': cogs,
                'avg_cost': avg_cost,
                'details': details,
                'uncovered_qty': max(uncovered, 0)
            }
            total_cogs += cogs

        return jsonify({
            'success': True,
            'total_cogs': round(total_cogs, 2),
            'products': result_products
        })

    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e), 'total_cogs': 0, 'products': {}})


# ============================================================================
# API –§–ò–ù–ê–ù–°–´ ‚Äî –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø –£–î–ï–†–ñ–ê–ù–ò–ô (–∏–∑ /v3/finance/transaction/list)
# ============================================================================
# –°–æ–±–∏—Ä–∞–µ—Ç –í–°–ï —É–¥–µ—Ä–∂–∞–Ω–∏—è –∏–∑ Ozon Transaction API –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.
# –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –ø–æ —Ç–∏–ø—É –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ —Ç–∏–ø—É —É—Å–ª—É–≥–∏. –°–≤–µ—Ä—è–µ—Ç —Å —Ä–µ–µ—Å—Ç—Ä–æ–º –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö
# —Ç–∏–ø–æ–≤ –≤ –ë–î –∏ –æ–ø–æ–≤–µ—â–∞–µ—Ç –æ –Ω–æ–≤—ã—Ö/–∏—Å—á–µ–∑–Ω—É–≤—à–∏—Ö —Ç–∏–ø–∞—Ö.
# ============================================================================


def _notify_transaction_type_changes(period_label, new_types, missing_types):
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:
    1) Telegram-—Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º
    2) –°–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–±–º–µ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ (container_messages)
    """
    import requests as _req

    # ‚îÄ‚îÄ –¢–µ–∫—Å—Ç –¥–ª—è Telegram (Markdown) ‚îÄ‚îÄ
    lines = [f"üìä *–ò–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π* (–ø–µ—Ä–∏–æ–¥: {period_label})\n"]
    if new_types:
        lines.append(f"üÜï *–ù–æ–≤—ã–µ —Ç–∏–ø—ã ({len(new_types)} —à—Ç):*")
        for t in new_types:
            cat = "–æ–ø–µ—Ä–∞—Ü–∏—è" if t['category'] == 'operation' else "—É—Å–ª—É–≥–∞"
            lines.append(f"  ‚Ä¢ `{t['key']}` ({cat})")
        lines.append("")
    if missing_types:
        lines.append(f"‚ùå *–ò—Å—á–µ–∑–Ω—É–≤—à–∏–µ —Ç–∏–ø—ã ({len(missing_types)} —à—Ç):*")
        for t in missing_types:
            cat = "–æ–ø–µ—Ä–∞—Ü–∏—è" if t['category'] == 'operation' else "—É—Å–ª—É–≥–∞"
            name = t.get('name', t['key'])
            lines.append(f"  ‚Ä¢ `{t['key']}` ‚Äî {name} ({cat})")
    tg_text = "\n".join(lines)

    # ‚îÄ‚îÄ 1) Telegram: –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º ‚îÄ‚îÄ
    try:
        bot_token = os.environ.get('TELEGRAM_BOT_TOKEN', '')
        if bot_token:
            conn = sqlite3.connect(DB_PATH)
            conn.row_factory = sqlite3.Row
            cur = conn.cursor()
            cur.execute('''
                SELECT telegram_chat_id FROM users
                WHERE role = 'admin' AND telegram_chat_id IS NOT NULL AND telegram_chat_id != ''
            ''')
            admins = cur.fetchall()
            conn.close()
            for admin in admins:
                cid = admin['telegram_chat_id']
                try:
                    _req.post(
                        f"https://api.telegram.org/bot{bot_token}/sendMessage",
                        json={"chat_id": cid, "text": tg_text, "parse_mode": "Markdown"},
                        timeout=10
                    )
                    print(f"  üì® TG —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: chat_id={cid}")
                except Exception as e:
                    print(f"  ‚ö†Ô∏è TG –æ—à–∏–±–∫–∞ (chat_id={cid}): {e}")
    except Exception as e:
        print(f"  ‚ö†Ô∏è TG —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}")

    # ‚îÄ‚îÄ 2) –û–±–º–µ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏: —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚îÄ‚îÄ
    try:
        plain_lines = [f"–ò–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–ø–µ—Ä–∏–æ–¥: {period_label})\n"]
        if new_types:
            plain_lines.append(f"–ù–û–í–´–ï –¢–ò–ü–´ ({len(new_types)} —à—Ç):")
            for t in new_types:
                cat = "–æ–ø–µ—Ä–∞—Ü–∏—è" if t['category'] == 'operation' else "—É—Å–ª—É–≥–∞"
                plain_lines.append(f"  - {t['key']} ({cat})")
            plain_lines.append("")
        if missing_types:
            plain_lines.append(f"–ò–°–ß–ï–ó–ù–£–í–®–ò–ï –¢–ò–ü–´ ({len(missing_types)} —à—Ç):")
            for t in missing_types:
                cat = "–æ–ø–µ—Ä–∞—Ü–∏—è" if t['category'] == 'operation' else "—É—Å–ª—É–≥–∞"
                name = t.get('name', t['key'])
                plain_lines.append(f"  - {t['key']} ‚Äî {name} ({cat})")
        plain_text = "\n".join(plain_lines)

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cur = conn.cursor()
        cur.execute("SELECT id FROM users WHERE role = 'admin'")
        admin_ids = [str(r['id']) for r in cur.fetchall()]
        if admin_ids:
            cur.execute('''
                INSERT INTO container_messages
                (container_id, message, sender_id, sender_name, recipient_ids, sender_type, is_read)
                VALUES (NULL, ?, 0, '–°–∏—Å—Ç–µ–º–∞', ?, 'system', 0)
            ''', (plain_text, ','.join(admin_ids)))
            conn.commit()
            print(f"  üì® –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è {len(admin_ids)} –∞–¥–º–∏–Ω–æ–≤")
        conn.close()
    except Exception as e:
        print(f"  ‚ö†Ô∏è –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")


# ============================================================================
# –ï–ñ–ï–ù–ï–î–ï–õ–¨–ù–ê–Ø –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê –¢–ò–ü–û–í –¢–†–ê–ù–ó–ê–ö–¶–ò–ô
# ============================================================================
# –ö–∞–∂–¥—É—é —Å—Ä–µ–¥—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—á–µ—Ä–µ–∑ cron) –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π
# –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π –º–µ—Å—è—Ü –∏–∑ /v3/finance/transaction/list, —Å–≤–µ—Ä—è–µ—Ç –≤—Å–µ operation_type
# –∏ service_name —Å —Ä–µ–µ—Å—Ç—Ä–æ–º transaction_type_registry –≤ –ë–î.
# –ï—Å–ª–∏ –ø–æ—è–≤–∏–ª–∏—Å—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –∏–ª–∏ –∏—Å—á–µ–∑–ª–∏ —Å—Ç–∞—Ä—ã–µ ‚Äî —É–≤–µ–¥–æ–º–ª—è–µ—Ç –∞–¥–º–∏–Ω–æ–≤ –≤ Telegram.
# ============================================================================


def check_transaction_types_weekly():
    """
    –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π Ozon.

    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –í–°–ï —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π –º–µ—Å—è—Ü,
    –∏–∑–≤–ª–µ–∫–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ operation_type –∏ service_name,
    —Å–≤–µ—Ä—è–µ—Ç —Å —Ä–µ–µ—Å—Ç—Ä–æ–º –≤ –ë–î –∏ —É–≤–µ–¥–æ–º–ª—è–µ—Ç –æ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        dict: –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å –ø–æ–ª—è–º–∏ success, period, operations_count,
              services_count, new_types, missing_types
    """
    import calendar
    from datetime import datetime as _dt
    from concurrent.futures import ThreadPoolExecutor, as_completed

    print("=" * 60)
    print("üîç –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π")
    print("=" * 60)

    # ‚îÄ‚îÄ –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π –º–µ—Å—è—Ü ‚îÄ‚îÄ
    now = _dt.now()
    if now.month == 1:
        check_year = now.year - 1
        check_month = 12
    else:
        check_year = now.year
        check_month = now.month - 1

    period_label = f"{check_year}-{check_month:02d}"
    last_day = calendar.monthrange(check_year, check_month)[1]
    d_from = f"{check_year}-{check_month:02d}-01T00:00:00.000Z"
    d_to = f"{check_year}-{check_month:02d}-{last_day}T23:59:59.999Z"

    print(f"  üìÖ –ü–µ—Ä–∏–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏: {period_label} ({d_from} ‚Üí {d_to})")

    # ‚îÄ‚îÄ –ó–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞ –º–µ—Å—è—Ü —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π ‚îÄ‚îÄ
    ozon_headers = get_ozon_headers()
    all_ops = []

    def _fetch_page(pg):
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–¥–Ω—É —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π."""
        payload = {
            "filter": {
                "date": {"from": d_from, "to": d_to},
                "posting_number": "",
                "transaction_type": "all"
            },
            "page": pg,
            "page_size": 1000
        }
        return pg, requests.post(
            f"{OZON_HOST}/v3/finance/transaction/list",
            json=payload, headers=ozon_headers, timeout=120
        )

    try:
        # –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Äî —É–∑–Ω–∞—ë–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        _, resp = _fetch_page(1)
        if resp.status_code != 200:
            err = f"Ozon API –æ—à–∏–±–∫–∞: {resp.status_code} ‚Äî {resp.text[:300]}"
            print(f"  ‚ùå {err}")
            return {'success': False, 'error': err}

        data = resp.json()
        page_ops = data.get('result', {}).get('operations', [])
        all_ops.extend(page_ops)
        page_count = data.get('result', {}).get('page_count', 1)
        print(f"  üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ 1/{page_count}: {len(page_ops)} –æ–ø–µ—Ä–∞—Ü–∏–π")

        # –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äî –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
        if page_count > 1:
            with ThreadPoolExecutor(max_workers=5) as pool:
                futures = {pool.submit(_fetch_page, p): p for p in range(2, page_count + 1)}
                for fut in as_completed(futures):
                    pg, r = fut.result()
                    if r.status_code == 200:
                        ops = r.json().get('result', {}).get('operations', [])
                        all_ops.extend(ops)
                        print(f"  üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ {pg}/{page_count}: {len(ops)} –æ–ø–µ—Ä–∞—Ü–∏–π")
                    else:
                        print(f"  ‚ö†Ô∏è –°—Ç—Ä–∞–Ω–∏—Ü–∞ {pg}: –æ—à–∏–±–∫–∞ {r.status_code}")

    except Exception as e:
        err = f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: {e}"
        print(f"  ‚ùå {err}")
        return {'success': False, 'error': err}

    print(f"  ‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(all_ops)} –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ {period_label}")

    # ‚îÄ‚îÄ –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ operation_type –∏ service_name ‚îÄ‚îÄ
    op_type_totals = {}   # {operation_type: {name, count}}
    svc_totals = {}       # {service_name: count}

    for op in all_ops:
        ot = op.get('operation_type', '')
        otn = op.get('operation_type_name', '')
        if ot:
            if ot not in op_type_totals:
                op_type_totals[ot] = {'name': otn, 'count': 0}
            op_type_totals[ot]['count'] += 1

        for svc in op.get('services', []):
            sn = svc.get('name', '')
            if sn:
                if sn not in svc_totals:
                    svc_totals[sn] = 0
                svc_totals[sn] += 1

    print(f"  üìä –¢–∏–ø–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π: {len(op_type_totals)} | –¢–∏–ø–æ–≤ —É—Å–ª—É–≥: {len(svc_totals)}")

    # ‚îÄ‚îÄ –°–≤–µ—Ä–∫–∞ —Å —Ä–µ–µ—Å—Ç—Ä–æ–º —Ç–∏–ø–æ–≤ –≤ –ë–î ‚îÄ‚îÄ
    today = _dt.now().strftime('%Y-%m-%d')
    db = sqlite3.connect(DB_PATH)
    db.row_factory = sqlite3.Row
    cursor = db.cursor()

    cursor.execute('SELECT type_key, type_category, display_name FROM transaction_type_registry')
    known = {}
    for row in cursor.fetchall():
        known[(row['type_key'], row['type_category'])] = row['display_name']

    new_types = []
    current_keys = set()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º operation_type
    for ot, info in op_type_totals.items():
        key = (ot, 'operation')
        current_keys.add(key)
        if key not in known:
            new_types.append({'key': ot, 'category': 'operation', 'name': info['name']})
            cursor.execute('''
                INSERT OR IGNORE INTO transaction_type_registry
                (type_key, type_category, display_name, first_seen_date, last_seen_date)
                VALUES (?, ?, ?, ?, ?)
            ''', (ot, 'operation', info['name'], today, today))
        else:
            cursor.execute('''
                UPDATE transaction_type_registry SET last_seen_date = ?
                WHERE type_key = ? AND type_category = ?
            ''', (today, ot, 'operation'))

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º service_name
    for sn in svc_totals:
        key = (sn, 'service')
        current_keys.add(key)
        if key not in known:
            new_types.append({'key': sn, 'category': 'service', 'name': sn})
            cursor.execute('''
                INSERT OR IGNORE INTO transaction_type_registry
                (type_key, type_category, display_name, first_seen_date, last_seen_date)
                VALUES (?, ?, ?, ?, ?)
            ''', (sn, 'service', sn, today, today))
        else:
            cursor.execute('''
                UPDATE transaction_type_registry SET last_seen_date = ?
                WHERE type_key = ? AND type_category = ?
            ''', (today, sn, 'service'))

    # –ò—Å—á–µ–∑–Ω—É–≤—à–∏–µ —Ç–∏–ø—ã (–±—ã–ª–∏ –≤ —Ä–µ–µ—Å—Ç—Ä–µ, –Ω–æ –Ω–µ—Ç –≤ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö)
    missing_types = []
    for (tk, tc), dn in known.items():
        if (tk, tc) not in current_keys:
            missing_types.append({'key': tk, 'category': tc, 'name': dn})

    db.commit()
    db.close()

    print(f"  üÜï –ù–æ–≤—ã—Ö —Ç–∏–ø–æ–≤: {len(new_types)}")
    print(f"  ‚ùå –ò—Å—á–µ–∑–Ω—É–≤—à–∏—Ö —Ç–∏–ø–æ–≤: {len(missing_types)}")

    # ‚îÄ‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚îÄ‚îÄ
    if new_types or missing_types:
        _notify_transaction_type_changes(period_label, new_types, missing_types)
        print("  üì® –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã (–µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è)")
    else:
        # –ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á—ë—Ç ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç
        _send_types_check_summary(period_label, len(op_type_totals), len(svc_totals))
        print("  ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫—Ä–∞—Ç–∫–∏–π –æ—Ç—á—ë—Ç")

    result = {
        'success': True,
        'period': period_label,
        'total_operations_fetched': len(all_ops),
        'operations_count': len(op_type_totals),
        'services_count': len(svc_totals),
        'new_types': new_types,
        'missing_types': missing_types
    }

    print("=" * 60)
    return result


def _send_types_check_summary(period_label, ops_count, svcs_count):
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∞—Ç–∫–∏–π –æ—Ç—á—ë—Ç –æ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–∏–ø–æ–≤ (–∫–æ–≥–¥–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç).

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        period_label (str): –ü–µ—Ä–∏–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–Ω–∞–ø—Ä. '2025-01')
        ops_count (int): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π
        svcs_count (int): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤ —É—Å–ª—É–≥
    """
    import requests as _req

    tg_text = (
        f"‚úÖ *–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤* ({period_label})\n"
        f"–û–ø–µ—Ä–∞—Ü–∏–π: {ops_count} | –£—Å–ª—É–≥: {svcs_count} | –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç"
    )

    try:
        bot_token = os.environ.get('TELEGRAM_BOT_TOKEN', '')
        if bot_token:
            conn = sqlite3.connect(DB_PATH)
            conn.row_factory = sqlite3.Row
            cur = conn.cursor()
            cur.execute('''
                SELECT telegram_chat_id FROM users
                WHERE role = 'admin' AND telegram_chat_id IS NOT NULL AND telegram_chat_id != ''
            ''')
            admins = cur.fetchall()
            conn.close()
            for admin in admins:
                cid = admin['telegram_chat_id']
                try:
                    _req.post(
                        f"https://api.telegram.org/bot{bot_token}/sendMessage",
                        json={"chat_id": cid, "text": tg_text, "parse_mode": "Markdown"},
                        timeout=10
                    )
                except Exception as e:
                    print(f"  ‚ö†Ô∏è TG –æ—à–∏–±–∫–∞ (chat_id={cid}): {e}")
    except Exception as e:
        print(f"  ‚ö†Ô∏è TG –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–∞–º–º–∞—Ä–∏: {e}")


@app.route('/api/finance/check-types')
@require_auth()
def api_finance_check_types():
    """
    –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏).

    –í—ã–∑—ã–≤–∞–µ—Ç check_transaction_types_weekly() –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
    –î–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∞–º.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        JSON: —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ç–∏–ø–æ–≤ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏.
    """
    result = check_transaction_types_weekly()
    return jsonify(result)


@app.route('/api/finance/transactions-breakdown')
@require_auth()
def api_finance_transactions_breakdown():
    """
    –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –≤—Å–µ—Ö —É–¥–µ—Ä–∂–∞–Ω–∏–π –∏–∑ Ozon Transaction API.

    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        month (str): YYYY-MM ‚Äî –æ–¥–∏–Ω –º–µ—Å—è—Ü
        quarter (str): YYYY-Q1..Q4 ‚Äî –∫–≤–∞—Ä—Ç–∞–ª (3 –º–µ—Å—è—Ü–∞)

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        JSON: —Ä–∞–∑–±–∏–≤–∫–∞ –ø–æ —Ç–∏–ø–∞–º –æ–ø–µ—Ä–∞—Ü–∏–π –∏ —É—Å–ª—É–≥, –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Ç–∏–ø–∞—Ö.
    """
    import calendar
    import re
    from datetime import datetime as _dt

    # ‚îÄ‚îÄ –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–∏–æ–¥ ‚îÄ‚îÄ
    date_from_param = request.args.get('date_from', '')
    date_to_param = request.args.get('date_to', '')
    quarter_str = request.args.get('quarter', '')
    month_str = request.args.get('month', '')

    quarter_months_map = {1: [1, 2, 3], 2: [4, 5, 6], 3: [7, 8, 9], 4: [10, 11, 12]}

    if date_from_param and date_to_param:
        date_from = f"{date_from_param}T00:00:00.000Z"
        date_to = f"{date_to_param}T23:59:59.999Z"
        period_label = f"{date_from_param} ‚Äî {date_to_param}"
    elif quarter_str:
        m = re.match(r'^(\d{4})-Q([1-4])$', quarter_str)
        if not m:
            return jsonify({'success': False, 'error': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–≤–∞—Ä—Ç–∞–ª–∞'}), 400
        q_year = int(m.group(1))
        q_num = int(m.group(2))
        months = quarter_months_map[q_num]
        date_from = f"{q_year}-{months[0]:02d}-01T00:00:00.000Z"
        last_day = calendar.monthrange(q_year, months[-1])[1]
        date_to = f"{q_year}-{months[-1]:02d}-{last_day}T23:59:59.999Z"
        period_label = f"Q{q_num} {q_year}"
    else:
        if not month_str:
            now = _dt.now()
            month_str = now.strftime('%Y-%m')
        try:
            dt = _dt.strptime(month_str, '%Y-%m')
        except (ValueError, TypeError):
            return jsonify({'success': False, 'error': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –º–µ—Å—è—Ü–∞'}), 400
        last_day = calendar.monthrange(dt.year, dt.month)[1]
        date_from = f"{dt.year}-{dt.month:02d}-01T00:00:00.000Z"
        date_to = f"{dt.year}-{dt.month:02d}-{last_day}T23:59:59.999Z"
        period_label = month_str

    # ‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à ‚îÄ‚îÄ
    cache_key = (date_from_param + '_' + date_to_param) if date_from_param else (quarter_str if quarter_str else month_str)
    try:
        db_cache = sqlite3.connect(DB_PATH, timeout=10)
        row = db_cache.execute(
            'SELECT response_json FROM transaction_breakdown_cache WHERE period_key = ?',
            (cache_key,)
        ).fetchone()
        db_cache.close()
        if row:
            print(f"  ‚ö° –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ {cache_key}: –æ—Ç–¥–∞—ë–º –∏–∑ –∫—ç—à–∞")
            return Response(row[0], mimetype='application/json')
        else:
            print(f"  üì≠ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ {cache_key}: –∫—ç—à –ø—É—Å—Ç, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ API")
    except Exception as e:
        print(f"  ‚ö†Ô∏è –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫—ç—à–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: {e}")
        import traceback
        traceback.print_exc()

    # ‚îÄ‚îÄ –ó–∞–ø—Ä–æ—Å—ã –∫ Ozon Transaction API ‚îÄ‚îÄ
    ozon_headers = get_ozon_headers()
    op_type_totals = {}   # {operation_type: {name, sum, count}}
    svc_totals = {}       # {service_name: {sum, count}}
    logistics_by_sku = {} # {offer_id: —Å—É–º–º–∞ –ª–æ–≥–∏—Å—Ç–∏–∫–∏} ‚Äî per-SKU –ª–æ–≥–∏—Å—Ç–∏–∫–∞ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Ç–æ–≤–∞—Ä–æ–≤
    total_ops = 0

    def _fetch_all_ops_for_range(d_from, d_to, label):
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å –í–°–ï —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥."""
        from concurrent.futures import ThreadPoolExecutor, as_completed

        def _fetch_page(pg):
            payload = {
                "filter": {
                    "date": {"from": d_from, "to": d_to},
                    "posting_number": "",
                    "transaction_type": "all"
                },
                "page": pg,
                "page_size": 1000
            }
            return requests.post(
                f"{OZON_HOST}/v3/finance/transaction/list",
                json=payload, headers=ozon_headers, timeout=120
            )

        print(f"  üìä –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ {label}: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ 1...")
        resp1 = _fetch_page(1)
        if resp1.status_code != 200:
            print(f"  ‚ùå –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ {label}: HTTP {resp1.status_code}")
            return []

        result1 = resp1.json().get('result', {})
        ops = list(result1.get('operations', []))
        page_count = result1.get('page_count', 0)

        if page_count > 1:
            print(f"  üìä –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ {label}: —Å—Ç—Ä. 2-{page_count} –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ...")
            with ThreadPoolExecutor(max_workers=4) as executor:
                futures = {executor.submit(_fetch_page, pg): pg for pg in range(2, page_count + 1)}
                for future in as_completed(futures):
                    r = future.result()
                    if r.status_code == 200:
                        page_ops = r.json().get('result', {}).get('operations', [])
                        ops.extend(page_ops)

        print(f"  ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ {label}: {len(ops)} –æ–ø–µ—Ä–∞—Ü–∏–π, {page_count} —Å—Ç—Ä.")
        return ops

    try:
        from concurrent.futures import ThreadPoolExecutor, as_completed

        all_ops = []

        if quarter_str:
            # –ö–≤–∞—Ä—Ç–∞–ª: 3 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –º–µ—Å—è—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
            # (–æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∑–∞ 3 –º–µ—Å—è—Ü–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –∏ —Ç–∞–π–º–∞—É—Ç–∏—Ç—Å—è)
            month_ranges = []
            for mo in months:
                last_d = calendar.monthrange(q_year, mo)[1]
                d_from = f"{q_year}-{mo:02d}-01T00:00:00.000Z"
                d_to = f"{q_year}-{mo:02d}-{last_d}T23:59:59.999Z"
                label = f"{q_year}-{mo:02d}"
                month_ranges.append((d_from, d_to, label))

            print(f"  üìä –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ {period_label}: 3 –º–µ—Å—è—Ü–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ...")
            with ThreadPoolExecutor(max_workers=3) as executor:
                futures = {
                    executor.submit(_fetch_all_ops_for_range, d_from, d_to, label): label
                    for d_from, d_to, label in month_ranges
                }
                for future in as_completed(futures):
                    month_ops = future.result()
                    all_ops.extend(month_ops)
        else:
            # –û–¥–∏–Ω –º–µ—Å—è—Ü: –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å
            all_ops = _fetch_all_ops_for_range(date_from, date_to, period_label)

        # –ê–≥—Ä–µ–≥–∞—Ü–∏—è
        for op in all_ops:
            total_ops += 1
            ot = op.get('operation_type', '')
            otn = op.get('operation_type_name', '')
            amt = op.get('amount', 0)

            if ot not in op_type_totals:
                op_type_totals[ot] = {'name': otn, 'sum': 0.0, 'count': 0}
            op_type_totals[ot]['sum'] += amt
            op_type_totals[ot]['count'] += 1

            for svc in op.get('services', []):
                sn = svc.get('name', '')
                sp = svc.get('price', 0)
                if sn:
                    if sn not in svc_totals:
                        svc_totals[sn] = {'sum': 0.0, 'count': 0}
                    svc_totals[sn]['sum'] += sp
                    svc_totals[sn]['count'] += 1

            # –õ–æ–≥–∏—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏: —Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–∑ –¥–æ—Å—Ç–∞–≤–æ–∫ (–±–µ–∑ –≤–æ–∑–≤—Ä–∞—Ç–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)
            # –¢–∞–∫–∂–µ –∞–≥—Ä–µ–≥–∏—Ä—É–µ–º per-SKU –ª–æ–≥–∏—Å—Ç–∏–∫—É –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Ç–æ–≤–∞—Ä–æ–≤
            if ot == 'OperationAgentDeliveredToCustomer':
                # SKU —Ç–æ–≤–∞—Ä–∞ –∏–∑ items ‚Äî –¥–ª—è per-SKU —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
                op_items = op.get('items', [])
                op_offer_id = op_items[0].get('offer_id', '') if op_items else ''
                op_sku = str(op_items[0].get('sku', '')) if op_items else ''
                sku_key = op_offer_id or op_sku  # –ö–ª—é—á –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ (offer_id –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ)

                for svc in op.get('services', []):
                    sn = svc.get('name', '')
                    sp = svc.get('price', 0)
                    if sn == 'MarketplaceServiceItemDirectFlowLogistic':
                        if '_delivery_logistics' not in svc_totals:
                            svc_totals['_delivery_logistics'] = {'sum': 0.0, 'count': 0}
                        svc_totals['_delivery_logistics']['sum'] += sp
                        svc_totals['_delivery_logistics']['count'] += 1
                        # Per-SKU –ª–æ–≥–∏—Å—Ç–∏–∫–∞
                        if sku_key:
                            logistics_by_sku[sku_key] = logistics_by_sku.get(sku_key, 0.0) + abs(sp)
                    elif sn == 'MarketplaceServiceItemRedistributionLastMileCourier':
                        if '_delivery_last_mile' not in svc_totals:
                            svc_totals['_delivery_last_mile'] = {'sum': 0.0, 'count': 0}
                        svc_totals['_delivery_last_mile']['sum'] += sp
                        svc_totals['_delivery_last_mile']['count'] += 1
                        # Per-SKU –ø–æ—Å–ª–µ–¥–Ω—è—è –º–∏–ª—è
                        if sku_key:
                            logistics_by_sku[sku_key] = logistics_by_sku.get(sku_key, 0.0) + abs(sp)

            # –õ–æ–≥–∏—Å—Ç–∏–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ ‚Äî per-SKU (OperationItemReturn)
            if ot == 'OperationItemReturn':
                op_items = op.get('items', [])
                op_offer_id = op_items[0].get('offer_id', '') if op_items else ''
                op_sku = str(op_items[0].get('sku', '')) if op_items else ''
                sku_key = op_offer_id or op_sku
                if sku_key:
                    # amount –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π (—Ä–∞—Å—Ö–æ–¥) ‚Äî –±–µ—Ä—ë–º abs
                    logistics_by_sku[sku_key] = logistics_by_sku.get(sku_key, 0.0) + abs(amt)

        print(f"  ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ {period_label}: –∏—Ç–æ–≥–æ {total_ops} –æ–ø–µ—Ä–∞—Ü–∏–π")

        # ‚îÄ‚îÄ –°–≤–µ—Ä–∫–∞ —Å —Ä–µ–µ—Å—Ç—Ä–æ–º —Ç–∏–ø–æ–≤ –≤ –ë–î ‚îÄ‚îÄ
        today = _dt.now().strftime('%Y-%m-%d')
        db = sqlite3.connect(DB_PATH)
        db.row_factory = sqlite3.Row
        cursor = db.cursor()

        # –¢–µ–∫—É—â–∏–µ —Ç–∏–ø—ã –∏–∑ –ë–î
        cursor.execute('SELECT type_key, type_category, display_name FROM transaction_type_registry')
        known = {}
        for row in cursor.fetchall():
            known[(row['type_key'], row['type_category'])] = row['display_name']

        new_types = []
        current_keys = set()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º operation_type
        for ot, info in op_type_totals.items():
            key = (ot, 'operation')
            current_keys.add(key)
            if key not in known:
                new_types.append({'key': ot, 'category': 'operation', 'name': info['name']})
                cursor.execute('''
                    INSERT OR IGNORE INTO transaction_type_registry
                    (type_key, type_category, display_name, first_seen_date, last_seen_date)
                    VALUES (?, ?, ?, ?, ?)
                ''', (ot, 'operation', info['name'], today, today))
            else:
                cursor.execute('''
                    UPDATE transaction_type_registry SET last_seen_date = ?
                    WHERE type_key = ? AND type_category = ?
                ''', (today, ot, 'operation'))

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º service names
        for sn in svc_totals:
            key = (sn, 'service')
            current_keys.add(key)
            if key not in known:
                new_types.append({'key': sn, 'category': 'service', 'name': sn})
                cursor.execute('''
                    INSERT OR IGNORE INTO transaction_type_registry
                    (type_key, type_category, display_name, first_seen_date, last_seen_date)
                    VALUES (?, ?, ?, ?, ?)
                ''', (sn, 'service', sn, today, today))
            else:
                cursor.execute('''
                    UPDATE transaction_type_registry SET last_seen_date = ?
                    WHERE type_key = ? AND type_category = ?
                ''', (today, sn, 'service'))

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—á–µ–∑–Ω—É–≤—à–∏–µ —Ç–∏–ø—ã (–±—ã–ª–∏ –≤ —Ä–µ–µ—Å—Ç—Ä–µ, –Ω–æ –Ω–µ—Ç –≤ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö)
        missing_types = []
        for (tk, tc), dn in known.items():
            if (tk, tc) not in current_keys:
                missing_types.append({'key': tk, 'category': tc, 'name': dn})

        db.commit()
        db.close()

        # ‚îÄ‚îÄ –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç ‚îÄ‚îÄ
        operations_list = []
        for ot, info in sorted(op_type_totals.items(), key=lambda x: x[1]['sum']):
            operations_list.append({
                'type': ot,
                'name': info['name'],
                'sum': round(info['sum'], 2),
                'count': info['count']
            })

        services_list = []
        for sn, info in sorted(svc_totals.items(), key=lambda x: x[1]['sum']):
            services_list.append({
                'name': sn,
                'sum': round(info['sum'], 2),
                'count': info['count']
            })

        alerts = []
        if new_types:
            alerts.append({
                'level': 'warning',
                'message': f"–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –æ–ø–µ—Ä–∞—Ü–∏–π/—É—Å–ª—É–≥ ({len(new_types)} —à—Ç)",
                'details': new_types
            })
        if missing_types:
            alerts.append({
                'level': 'info',
                'message': f"–¢–∏–ø—ã, –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –≤ —Ç–µ–∫—É—â–µ–º –ø–µ—Ä–∏–æ–¥–µ ({len(missing_types)} —à—Ç)",
                'details': missing_types
            })

        # ‚îÄ‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: Telegram + –æ–±–º–µ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ ‚îÄ‚îÄ
        if new_types or missing_types:
            _notify_transaction_type_changes(period_label, new_types, missing_types)

        # Per-SKU –ª–æ–≥–∏—Å—Ç–∏–∫–∞: –æ–∫—Ä—É–≥–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
        logistics_by_sku_rounded = {k: round(v, 2) for k, v in logistics_by_sku.items()}
        log_total_by_sku = sum(logistics_by_sku_rounded.values())
        print(f"  üìä –õ–æ–≥–∏—Å—Ç–∏–∫–∞ –ø–æ SKU: {len(logistics_by_sku_rounded)} —Ç–æ–≤–∞—Ä–æ–≤, –∏—Ç–æ–≥–æ {log_total_by_sku:.2f} ‚ÇΩ")

        response_data = {
            'success': True,
            'period': period_label,
            'total_operations': total_ops,
            'operations': operations_list,
            'services': services_list,
            'alerts': alerts,
            'logistics_by_sku': logistics_by_sku_rounded
        }

        # ‚îÄ‚îÄ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à ‚îÄ‚îÄ
        try:
            import json as _json
            response_json = _json.dumps(response_data, ensure_ascii=False)
            db_cache = sqlite3.connect(DB_PATH, timeout=10)
            db_cache.execute(
                'INSERT OR REPLACE INTO transaction_breakdown_cache (period_key, response_json, cached_at) VALUES (?, ?, ?)',
                (cache_key, response_json, _dt.now().isoformat())
            )
            db_cache.commit()
            db_cache.close()
            print(f"  üíæ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ {cache_key}: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∫—ç—à")
        except Exception as e:
            print(f"  ‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –∫—ç—à–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: {e}")

        return jsonify(response_data)

    except requests.exceptions.Timeout:
        return jsonify({'success': False, 'error': '–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ Ozon API'}), 504
    except requests.exceptions.ConnectionError:
        return jsonify({'success': False, 'error': '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Ozon API'}), 502
    except Exception as e:
        print(f"  ‚ùå –û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)}), 500


# ============================================================================
# API –§–ò–ù–ê–ù–°–´ ‚Äî –§–ê–ô–õ–´
# ============================================================================

def save_finance_files(cursor, finance_record_id, files):
    """
    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª—ã, –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏.
    –§–∞–π–ª—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ FINANCE_UPLOAD_FOLDER/{finance_record_id}/.
    """
    mime_types = {
        'pdf': 'application/pdf',
        'png': 'image/png',
        'jpg': 'image/jpeg',
        'jpeg': 'image/jpeg',
        'gif': 'image/gif',
        'doc': 'application/msword',
        'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'xls': 'application/vnd.ms-excel',
        'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'txt': 'text/plain',
        'zip': 'application/zip',
        'rar': 'application/x-rar-compressed'
    }

    folder = os.path.join(FINANCE_UPLOAD_FOLDER, str(finance_record_id))
    os.makedirs(folder, exist_ok=True)

    for f in files:
        if not f or not f.filename:
            continue
        if not allowed_file(f.filename):
            continue

        ext = f.filename.rsplit('.', 1)[-1].lower() if '.' in f.filename else ''
        stored_filename = f"{uuid.uuid4().hex}.{ext}" if ext else f"{uuid.uuid4().hex}"
        file_type = mime_types.get(ext, 'application/octet-stream')

        file_path = os.path.join(folder, stored_filename)
        f.save(file_path)

        file_size = os.path.getsize(file_path)

        cursor.execute('''
            INSERT INTO finance_record_files
            (finance_record_id, filename, stored_filename, file_type, file_size)
            VALUES (?, ?, ?, ?, ?)
        ''', (finance_record_id, f.filename, stored_filename, file_type, file_size))


@app.route('/api/finance/records/<int:record_id>/files')
@require_auth(['admin', 'viewer'])
def api_finance_record_files(record_id):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏."""
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('''
            SELECT id, filename, file_type, file_size, uploaded_at
            FROM finance_record_files
            WHERE finance_record_id = ?
            ORDER BY uploaded_at
        ''', (record_id,))
        files = [dict(row) for row in cursor.fetchall()]
        conn.close()

        return jsonify({'success': True, 'files': files})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/finance/files/<int:file_id>')
@require_auth(['admin', 'viewer'])
def download_finance_file(file_id):
    """–°–∫–∞—á–∞—Ç—å –∏–ª–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–∞–π–ª —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏. ?view=1 –¥–ª—è inline."""
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('''
            SELECT id, finance_record_id, filename, stored_filename, file_type
            FROM finance_record_files WHERE id = ?
        ''', (file_id,))
        file_info = cursor.fetchone()
        conn.close()

        if not file_info:
            return jsonify({'success': False, 'error': '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404

        file_path = os.path.join(
            FINANCE_UPLOAD_FOLDER,
            str(file_info['finance_record_id']),
            file_info['stored_filename']
        )

        if not os.path.exists(file_path):
            return jsonify({'success': False, 'error': '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ –¥–∏—Å–∫–µ'}), 404

        view_inline = request.args.get('view', '0') == '1'

        if view_inline and file_info['file_type'].startswith(('image/', 'application/pdf')):
            return send_file(file_path, mimetype=file_info['file_type'])
        else:
            return send_file(file_path, as_attachment=True, download_name=file_info['filename'])
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/finance/files/<int:file_id>', methods=['DELETE'])
@require_auth(['admin'])
def delete_finance_file(file_id):
    """–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏."""
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('SELECT id, finance_record_id, stored_filename FROM finance_record_files WHERE id = ?', (file_id,))
        file_info = cursor.fetchone()
        if not file_info:
            conn.close()
            return jsonify({'success': False, 'error': '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404

        # –£–¥–∞–ª—è–µ–º —Å –¥–∏—Å–∫–∞
        file_path = os.path.join(FINANCE_UPLOAD_FOLDER, str(file_info['finance_record_id']), file_info['stored_filename'])
        if os.path.exists(file_path):
            os.remove(file_path)

        # –£–¥–∞–ª—è–µ–º –∏–∑ –ë–î
        cursor.execute('DELETE FROM finance_record_files WHERE id = ?', (file_id,))
        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': '–§–∞–π–ª —É–¥–∞–ª–µ–Ω'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


# ============================================================================
# API –§–ò–ù–ê–ù–°–´ ‚Äî –≠–ù–î–ü–û–ò–ù–¢–´ –î–õ–Ø TELEGRAM-–ë–û–¢–ê
# ============================================================================
# –û—Ç–¥–µ–ª—å–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è Telegram-–±–æ—Ç–∞ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ TELEGRAM_BOT_SECRET.
# –ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Ö –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å—á–µ—Ç–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–µ–π.
# ============================================================================

@app.route('/api/telegram/finance/accounts')
def api_telegram_finance_accounts():
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Å—á–µ—Ç–æ–≤ –¥–ª—è Telegram-–±–æ—Ç–∞.
    –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö –∑–∞–ø—Ä–æ—Å–∞.
    """
    try:
        token = request.args.get('token', '')
        expected_token = os.environ.get('TELEGRAM_BOT_SECRET', '')

        if not expected_token or token != expected_token:
            return jsonify({'success': False, 'error': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω'}), 403

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
        cursor.execute('SELECT id, name, COALESCE(requires_official, 0) as requires_official FROM finance_accounts ORDER BY is_default DESC, name ASC')
        rows = cursor.fetchall()
        accounts = [{'id': r['id'], 'name': r['name'], 'requires_official': r['requires_official'] or 0} for r in rows]
        conn.close()

        return jsonify({'success': True, 'accounts': accounts})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/telegram/finance/categories')
def api_telegram_finance_categories():
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è Telegram-–±–æ—Ç–∞.
    –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö –∑–∞–ø—Ä–æ—Å–∞.
    """
    try:
        token = request.args.get('token', '')
        expected_token = os.environ.get('TELEGRAM_BOT_SECRET', '')

        if not expected_token or token != expected_token:
            return jsonify({'success': False, 'error': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω'}), 403

        record_type = request.args.get('type', '').strip()

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        if record_type in ('income', 'expense'):
            cursor.execute('SELECT id, name, is_container_linked, requires_yuan, requires_description, description_hint FROM finance_categories WHERE record_type = ? ORDER BY name ASC', (record_type,))
        else:
            cursor.execute('SELECT id, name, is_container_linked, requires_yuan, requires_description, description_hint FROM finance_categories ORDER BY name ASC')

        rows = cursor.fetchall()
        categories = [{'id': r['id'], 'name': r['name'], 'is_container_linked': r['is_container_linked'] or 0, 'requires_yuan': r['requires_yuan'] or 0, 'requires_description': r['requires_description'] or 0, 'description_hint': r['description_hint'] or ''} for r in rows]
        conn.close()

        return jsonify({'success': True, 'categories': categories})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/telegram/finance/add', methods=['POST'])
def api_telegram_finance_add():
    """
    –°–æ–∑–¥–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –∑–∞–ø–∏—Å—å –∏–∑ Telegram-–±–æ—Ç–∞.
    –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ TELEGRAM_BOT_SECRET –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞.
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç multipart/form-data –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤.
    """
    try:
        # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ multipart/form-data (–∫–æ–≥–¥–∞ –µ—Å—Ç—å —Ñ–∞–π–ª—ã) –∏ JSON
        uploaded_files = []
        if request.content_type and 'multipart' in request.content_type:
            data = request.form.to_dict()
            uploaded_files = request.files.getlist('files')
        else:
            data = request.json

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
        token = data.get('token', '')
        expected_token = os.environ.get('TELEGRAM_BOT_SECRET', '')

        if not expected_token or token != expected_token:
            return jsonify({'success': False, 'error': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω'}), 403

        record_type = data.get('record_type', '')
        amount = data.get('amount', 0)
        account_id = data.get('account_id')
        category_id = data.get('category_id')
        description = (data.get('description') or '').strip()
        telegram_chat_id = data.get('telegram_chat_id')
        telegram_username = data.get('telegram_username', '')

        # –í–∞–ª–∏–¥–∞—Ü–∏—è
        if record_type not in ('income', 'expense'):
            return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ —Ç–∏–ø: income –∏–ª–∏ expense'}), 400

        try:
            amount = float(amount)
            if amount <= 0:
                raise ValueError()
        except (ValueError, TypeError):
            return jsonify({'success': False, 'error': '–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º –±–æ–ª—å—à–µ 0'}), 400

        if not account_id:
            return jsonify({'success': False, 'error': '–í—ã–±–µ—Ä–∏—Ç–µ —Å—á—ë—Ç/–∏—Å—Ç–æ—á–Ω–∏–∫'}), 400

        if not category_id:
            return jsonify({'success': False, 'error': '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é'}), 400

        # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Å—á—ë—Ç–∞ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute('SELECT name, COALESCE(requires_official, 0) as requires_official FROM finance_accounts WHERE id = ?', (account_id,))
        acc_row = cursor.fetchone()
        if not acc_row:
            conn.close()
            return jsonify({'success': False, 'error': '–°—á—ë—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404

        account_name = acc_row[0]
        requires_official = acc_row[1] or 0

        cursor.execute('SELECT name, is_container_linked, requires_yuan, requires_description, description_hint, COALESCE(is_plan_linked, 0) as is_plan_linked FROM finance_categories WHERE id = ?', (category_id,))
        cat_row = cursor.fetchone()
        if not cat_row:
            conn.close()
            return jsonify({'success': False, 'error': '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}), 404

        category_name = cat_row[0]
        is_container_linked = cat_row[1] or 0
        requires_yuan = cat_row[2] or 0
        requires_description = cat_row[3] or 0
        description_hint = cat_row[4] or ''
        is_plan_linked = cat_row[5] or 0

        # –ü—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–î—Ä—É–≥–æ–µ" –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
        if category_name.lower() == '–¥—Ä—É–≥–æ–µ' and not description:
            conn.close()
            return jsonify({'success': False, 'error': '–ü—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–î—Ä—É–≥–æ–µ" –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'}), 400
        if requires_description and not description:
            error_msg = description_hint if description_hint else '–î–ª—è –¥–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ'
            conn.close()
            return jsonify({'success': False, 'error': error_msg}), 400

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—É–º–º—ã –≤ —é–∞–Ω—è—Ö
        yuan_amount = data.get('yuan_amount')
        if yuan_amount is not None:
            try:
                yuan_amount = float(yuan_amount)
                if yuan_amount <= 0:
                    yuan_amount = None
            except (ValueError, TypeError):
                yuan_amount = None

        # –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Ç—Ä–µ–±—É–µ—Ç —é–∞–Ω–∏ ‚Äî –≤–∞–ª–∏–¥–∏—Ä—É–µ–º
        if requires_yuan and not yuan_amount:
            conn.close()
            return jsonify({'success': False, 'error': '–î–ª—è –¥–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Å—É–º–º—É –≤ —é–∞–Ω—è—Ö'}), 400

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–º–µ—Ç–∫–∏ ¬´–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥¬ª
        is_official = None
        if requires_official and record_type == 'expense':
            is_official_raw = data.get('is_official')
            if is_official_raw is not None:
                is_official = 1 if str(is_official_raw) == '1' or is_official_raw is True else 0
            else:
                is_official = 0

        record_date = get_snapshot_date()

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º created_by: –∏—â–µ–º –ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ telegram_chat_id
        created_by = telegram_username  # fallback –Ω–∞ TG-–∏–º—è
        if telegram_chat_id:
            cursor.execute('SELECT username FROM users WHERE telegram_chat_id = ?', (telegram_chat_id,))
            user_row = cursor.fetchone()
            if user_row:
                created_by = user_row[0]

        cursor.execute('''
            INSERT INTO finance_records
            (record_type, amount, account_id, account_name, category_id, category_name,
             description, created_by, source, telegram_chat_id, telegram_username, record_date, yuan_amount, is_official)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'telegram', ?, ?, ?, ?, ?)
        ''', (record_type, amount, account_id, account_name, category_id, category_name,
              description, created_by, telegram_chat_id, telegram_username, record_date, yuan_amount, is_official))

        new_id = cursor.lastrowid

        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É, –µ—Å–ª–∏ —Ä–∞—Å—Ö–æ–¥ –ù–ï –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π (is_official == 0)
        if record_type == 'expense' and requires_official and is_official == 0:
            amount_fmt = f"{amount:,.0f}".replace(',', ' ')
            notif_text = (
                f"‚ö†Ô∏è <b>–†–∞—Å—Ö–æ–¥ –±–µ–∑ –ø–æ–º–µ—Ç–∫–∏ ¬´–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π¬ª</b>\n\n"
                f"üí∞ –°—É–º–º–∞: {amount_fmt} ‚ÇΩ\n"
                f"üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category_name}\n"
            )
            if description:
                notif_text += f"üìù –û–ø–∏—Å–∞–Ω–∏–µ: {description}\n"
            notif_text += (
                f"üë§ –°–æ–∑–¥–∞–ª: {created_by}\n"
                f"üìÖ –î–∞—Ç–∞: {record_date}\n\n"
                f"–†–∞—Å—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω <b>–ë–ï–ó</b> –ø–æ–º–µ—Ç–∫–∏ ¬´–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥¬ª."
            )
            send_admin_notification(notif_text)

        # Telegram –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è ‚Äî –≤—Å–µ–≥–¥–∞ —É–≤–µ–¥–æ–º–ª—è–µ–º
        # –¥–ª—è —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º
        if record_type == 'expense' and is_container_linked:
            _create_finance_distribution_notification(
                cursor, new_id, amount, category_name, description,
                created_by, record_date
            )

        # Telegram –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø–ª–∞–Ω—É ‚Äî —É–≤–µ–¥–æ–º–ª—è–µ–º
        # –¥–ª—è —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∫ –ø–ª–∞–Ω—É –∑–∞–∫—É–ø–æ–∫
        if record_type == 'expense' and is_plan_linked and yuan_amount:
            _create_finance_plan_distribution_notification(
                cursor, new_id, yuan_amount, amount, category_name, description,
                created_by, record_date
            )

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        if uploaded_files:
            save_finance_files(cursor, new_id, uploaded_files)

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'id': new_id})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


# ============================================================================
# –ü–õ–ê–ù –ó–ê–ö–£–ü–û–ö ‚Äî API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
# ============================================================================

@app.route('/api/plan/items')
@require_auth(['admin', 'viewer'])
def get_plan_items():
    """
    –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ –ø–ª–∞–Ω–∞ –∑–∞–∫—É–ø–æ–∫.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–µ).
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute('''
            SELECT * FROM plan_items
            ORDER BY created_at DESC
        ''')
        items = [dict(row) for row in cursor.fetchall()]
        conn.close()

        return jsonify({'success': True, 'items': items})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e), 'items': []})


@app.route('/api/plan/items/add', methods=['POST'])
@require_auth(['admin'])
def add_plan_item():
    """
    –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é –≤ –ø–ª–∞–Ω –∑–∞–∫—É–ø–æ–∫.
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç JSON —Å –ø–æ–ª—è–º–∏: product_name, planned_release_date, estimated_arrival_date,
    planned_qty, price_yuan_invoice, price_yuan_delta_invoice, total_yuan,
    qty_in_transit, qty_arrived, paid_invoice_yuan, paid_invoice_rub,
    paid_delta_yuan, paid_delta_rub.
    """
    try:
        data = request.get_json()
        product_name = data.get('product_name', '').strip()
        if not product_name:
            return jsonify({'success': False, 'error': '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ'})

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        cursor.execute('''
            INSERT INTO plan_items (
                product_name, planned_release_date, estimated_arrival_date,
                planned_qty, price_yuan_invoice, price_yuan_delta_invoice, total_yuan,
                qty_in_transit, qty_arrived,
                paid_invoice_yuan, paid_invoice_rub,
                paid_delta_yuan, paid_delta_rub
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            product_name,
            data.get('planned_release_date'),
            data.get('estimated_arrival_date'),
            data.get('planned_qty', 0),
            data.get('price_yuan_invoice', 0),
            data.get('price_yuan_delta_invoice', 0),
            data.get('total_yuan', 0),
            data.get('qty_in_transit', 0),
            data.get('qty_arrived', 0),
            data.get('paid_invoice_yuan', 0),
            data.get('paid_invoice_rub', 0),
            data.get('paid_delta_yuan', 0),
            data.get('paid_delta_rub', 0)
        ))

        new_id = cursor.lastrowid
        conn.commit()
        conn.close()

        return jsonify({'success': True, 'id': new_id})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/plan/items/update', methods=['POST'])
@require_auth(['admin'])
def update_plan_item():
    """
    –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–∑–∏—Ü–∏—é –ø–ª–∞–Ω–∞ –∑–∞–∫—É–ø–æ–∫.
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç JSON —Å –ø–æ–ª–µ–º id –∏ –æ–±–Ω–æ–≤–ª—è–µ–º—ã–º–∏ –ø–æ–ª—è–º–∏.
    """
    try:
        data = request.get_json()
        item_id = data.get('id')
        if not item_id:
            return jsonify({'success': False, 'error': 'ID –ø–æ–∑–∏—Ü–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'})

        product_name = data.get('product_name', '').strip()
        if not product_name:
            return jsonify({'success': False, 'error': '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ'})

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        cursor.execute('''
            UPDATE plan_items SET
                product_name = ?,
                planned_release_date = ?,
                estimated_arrival_date = ?,
                planned_qty = ?,
                price_yuan_invoice = ?,
                price_yuan_delta_invoice = ?,
                total_yuan = ?,
                qty_in_transit = ?,
                qty_arrived = ?,
                paid_invoice_yuan = ?,
                paid_invoice_rub = ?,
                paid_delta_yuan = ?,
                paid_delta_rub = ?,
                updated_at = CURRENT_TIMESTAMP
            WHERE id = ?
        ''', (
            product_name,
            data.get('planned_release_date'),
            data.get('estimated_arrival_date'),
            data.get('planned_qty', 0),
            data.get('price_yuan_invoice', 0),
            data.get('price_yuan_delta_invoice', 0),
            data.get('total_yuan', 0),
            data.get('qty_in_transit', 0),
            data.get('qty_arrived', 0),
            data.get('paid_invoice_yuan', 0),
            data.get('paid_invoice_rub', 0),
            data.get('paid_delta_yuan', 0),
            data.get('paid_delta_rub', 0),
            item_id
        ))

        conn.commit()
        conn.close()

        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/plan/items/delete', methods=['POST'])
@require_auth(['admin'])
def delete_plan_item():
    """
    –£–¥–∞–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –∏–∑ –ø–ª–∞–Ω–∞ –∑–∞–∫—É–ø–æ–∫ –ø–æ ID.
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç JSON —Å –ø–æ–ª–µ–º id.
    """
    try:
        data = request.get_json()
        item_id = data.get('id')
        if not item_id:
            return jsonify({'success': False, 'error': 'ID –ø–æ–∑–∏—Ü–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'})

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute('DELETE FROM plan_items WHERE id = ?', (item_id,))
        conn.commit()
        conn.close()

        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/plan/in-transit')
@require_auth(['admin', 'viewer'])
def get_plan_in_transit():
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª-–≤–æ ¬´–≤ –ø—É—Ç–∏¬ª –ø–æ –∫–∞–∂–¥–æ–º—É –∞—Ä—Ç–∏–∫—É–ª—É (offer_id).
    –°—á–∏—Ç–∞–µ—Ç –∏–∑ —Ç–∞–±–ª–∏—Ü—ã supplies: SUM(exit_factory_qty) - SUM(arrival_warehouse_qty).
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –°—É–º–º–∏—Ä—É–µ–º –ø–æ SKU: –≤—ã—Ö–æ–¥ —Å —Ñ–∞–±—Ä–∏–∫–∏ –º–∏–Ω—É—Å –ø—Ä–∏—Ö–æ–¥ –Ω–∞ —Å–∫–ª–∞–¥
        cursor.execute('''
            SELECT s.sku,
                   SUM(COALESCE(s.exit_factory_qty, 0)) AS total_exit,
                   SUM(COALESCE(s.arrival_warehouse_qty, 0)) AS total_arrival
            FROM supplies s
            GROUP BY s.sku
        ''')
        supply_rows = cursor.fetchall()

        # –ú–∞–ø–ø–∏–Ω–≥ SKU ‚Üí offer_id
        cursor.execute('SELECT sku, offer_id FROM products WHERE offer_id IS NOT NULL')
        sku_to_offer = {row['sku']: row['offer_id'] for row in cursor.fetchall()}

        conn.close()

        # –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç: offer_id ‚Üí –∫–æ–ª-–≤–æ –≤ –ø—É—Ç–∏
        result = {}
        for row in supply_rows:
            sku = row['sku']
            in_transit = (row['total_exit'] or 0) - (row['total_arrival'] or 0)
            if in_transit > 0 and sku in sku_to_offer:
                oid = sku_to_offer[sku]
                result[oid] = result.get(oid, 0) + in_transit

        return jsonify({'success': True, 'in_transit': result})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/plan/arrivals')
@require_auth(['admin', 'viewer'])
def get_plan_arrivals():
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª-–≤–æ ¬´–ø—Ä–∏—à–ª–æ –Ω–∞ —Å–∫–ª–∞–¥¬ª –ø–æ –∫–∞–∂–¥–æ–º—É –∞—Ä—Ç–∏–∫—É–ª—É (offer_id).
    –°—á–∏—Ç–∞–µ—Ç –∏–∑ —Ç–∞–±–ª–∏—Ü—ã supplies: SUM(arrival_warehouse_qty), –≥—Ä—É–ø–ø–∏—Ä—É—è –ø–æ SKU.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥–∞ –ø–æ —Å—Ç—Ä–æ–∫–∞–º –ø–ª–∞–Ω–∞.
    """
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –°—É–º–º–∏—Ä—É–µ–º –ø—Ä–∏—Ö–æ–¥ –Ω–∞ —Å–∫–ª–∞–¥ –ø–æ SKU
        cursor.execute('''
            SELECT s.sku,
                   SUM(COALESCE(s.arrival_warehouse_qty, 0)) AS total_arrived
            FROM supplies s
            GROUP BY s.sku
        ''')
        supply_rows = cursor.fetchall()

        # –ú–∞–ø–ø–∏–Ω–≥ SKU ‚Üí offer_id
        cursor.execute('SELECT sku, offer_id FROM products WHERE offer_id IS NOT NULL')
        sku_to_offer = {row['sku']: row['offer_id'] for row in cursor.fetchall()}

        conn.close()

        # –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç: offer_id ‚Üí –∫–æ–ª-–≤–æ –ø—Ä–∏—à–ª–æ
        result = {}
        for row in supply_rows:
            sku = row['sku']
            arrived = row['total_arrived'] or 0
            if arrived > 0 and sku in sku_to_offer:
                oid = sku_to_offer[sku]
                result[oid] = result.get(oid, 0) + arrived

        return jsonify({'success': True, 'arrivals': result})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


# ============================================================================
# –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø
# ============================================================================

def main():
    print("\n" + "="*60)
    print("üåê OZON –¢–û–í–ê–†–´ - –û–°–¢–ê–¢–ö–ò FBO")
    print("="*60)
    
    init_database()
    
    if sync_products():
        # ‚úÖ –ü–æ–ª—É—á–∞–µ–º —Ö–æ—Å—Ç –∏ –ø–æ—Ä—Ç –∏–∑ .env –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
        host = os.getenv('FLASK_HOST', '0.0.0.0')  # 0.0.0.0 = –¥–æ—Å—Ç—É–ø–Ω–æ –∏–∑ —Å–µ—Ç–∏
        port = int(os.getenv('FLASK_PORT', '5000'))

        print("\n" + "="*60)
        print("‚úÖ –ì–û–¢–û–í–û!")
        print("="*60)
        print(f"\nüåê –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞: http://{host}:{port}")
        print(f"üì± –î–æ—Å—Ç—É–ø –∏–∑ —Å–µ—Ç–∏: http://–í–ê–®-IP:{port}")
        print("\n‚èπÔ∏è  –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: Ctrl+C\n")

        app.run(host=host, port=port, debug=True, use_reloader=False)
    else:
        print("\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏!")
        sys.exit(1)


if __name__ == '__main__':
    main()