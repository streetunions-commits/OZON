#!/bin/bash
# ============================================================================
# –°–ö–†–ò–ü–¢ –ë–≠–ö–ê–ü–ê OZON TRACKER
# ============================================================================
#
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –°–æ–∑–¥–∞—ë—Ç –±—ç–∫–∞–ø—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö SQLite –∏ .env —Ñ–∞–π–ª–∞.
#             –•—Ä–∞–Ω–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –∫–æ–ø–∏–π, —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ.
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   ./backup.sh              # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
#   crontab: 0 */6 * * *    # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ (–ø–µ—Ä–µ–¥ sync)
#
# –ß—Ç–æ –±—ç–∫–∞–ø–∏—Ç—Å—è:
#   - ozon_data.db  (—á–µ—Ä–µ–∑ sqlite3 .backup ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–∞–∂–µ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏)
#   - .env          (API –∫–ª—é—á–∏)
#
# –•—Ä–∞–Ω–µ–Ω–∏–µ: /root/backups/ozon/ ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –∫–æ–ø–∏–π (~30 –¥–Ω–µ–π –ø—Ä–∏ 1/–¥–µ–Ω—å)
# ============================================================================

set -euo pipefail

# ============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ò
# ============================================================================

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞
APP_DIR="/root/OZON"

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –±—ç–∫–∞–ø–æ–≤
BACKUP_DIR="/root/backups/ozon"

# –°–∫–æ–ª—å–∫–æ –±—ç–∫–∞–ø–æ–≤ —Ö—Ä–∞–Ω–∏—Ç—å (—Å—Ç–∞—Ä—ã–µ —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
MAX_BACKUPS=30

# –õ–æ–≥ —Ñ–∞–π–ª
LOG_FILE="/var/log/ozon-tracker/backup.log"

# –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –¥–ª—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")

# ============================================================================
# –ü–û–î–ì–û–¢–û–í–ö–ê
# ============================================================================

# –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±—ç–∫–∞–ø–æ–≤ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
mkdir -p "$BACKUP_DIR"
mkdir -p "$(dirname "$LOG_FILE")"

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "=== –ù–∞—á–∞–ª–æ –±—ç–∫–∞–ø–∞ ==="

# ============================================================================
# –ë–≠–ö–ê–ü –ë–ê–ó–´ –î–ê–ù–ù–´–•
# ============================================================================

DB_FILE="$APP_DIR/ozon_data.db"
DB_BACKUP="$BACKUP_DIR/ozon_data_${TIMESTAMP}.db"

if [ -f "$DB_FILE" ]; then
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º sqlite3 .backup ‚Äî —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–± –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è,
    # –¥–∞–∂–µ –µ—Å–ª–∏ –±–∞–∑–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –∏ –≤ –Ω–µ—ë –∏–¥—ë—Ç –∑–∞–ø–∏—Å—å
    sqlite3 "$DB_FILE" ".backup '$DB_BACKUP'"

    # –°–∂–∏–º–∞–µ–º –±—ç–∫–∞–ø –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
    gzip "$DB_BACKUP"

    DB_SIZE=$(du -h "${DB_BACKUP}.gz" | cut -f1)
    log "‚úÖ –ë–î: ${DB_BACKUP}.gz ($DB_SIZE)"
else
    log "‚ö†Ô∏è –ë–î –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $DB_FILE"
fi

# ============================================================================
# –ë–≠–ö–ê–ü .env
# ============================================================================

ENV_FILE="$APP_DIR/.env"
ENV_BACKUP="$BACKUP_DIR/env_${TIMESTAMP}.bak"

if [ -f "$ENV_FILE" ]; then
    cp "$ENV_FILE" "$ENV_BACKUP"
    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø ‚Äî –≤ —Ñ–∞–π–ª–µ API –∫–ª—é—á–∏
    chmod 600 "$ENV_BACKUP"
    gzip "$ENV_BACKUP"
    log "‚úÖ .env: ${ENV_BACKUP}.gz"
else
    log "‚ö†Ô∏è .env –Ω–µ –Ω–∞–π–¥–µ–Ω: $ENV_FILE"
fi

# ============================================================================
# –†–û–¢–ê–¶–ò–Ø ‚Äî –£–î–ê–õ–ï–ù–ò–ï –°–¢–ê–†–´–• –ë–≠–ö–ê–ü–û–í
# ============================================================================

# –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—ç–∫–∞–ø–æ–≤ –ë–î
DB_COUNT=$(ls -1 "$BACKUP_DIR"/ozon_data_*.db.gz 2>/dev/null | wc -l)

if [ "$DB_COUNT" -gt "$MAX_BACKUPS" ]; then
    # –£–¥–∞–ª—è–µ–º —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ, –æ—Å—Ç–∞–≤–ª—è–µ–º MAX_BACKUPS
    DELETE_COUNT=$((DB_COUNT - MAX_BACKUPS))
    ls -1t "$BACKUP_DIR"/ozon_data_*.db.gz | tail -n "$DELETE_COUNT" | xargs rm -f
    ls -1t "$BACKUP_DIR"/env_*.bak.gz | tail -n "$DELETE_COUNT" 2>/dev/null | xargs rm -f
    log "üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤: $DELETE_COUNT"
fi

# ============================================================================
# –ò–¢–û–ì
# ============================================================================

TOTAL_SIZE=$(du -sh "$BACKUP_DIR" | cut -f1)
TOTAL_FILES=$(ls -1 "$BACKUP_DIR"/*.gz 2>/dev/null | wc -l)

log "üìä –í—Å–µ–≥–æ –±—ç–∫–∞–ø–æ–≤: $TOTAL_FILES —Ñ–∞–π–ª–æ–≤, $TOTAL_SIZE"
log "=== –ë—ç–∫–∞–ø –∑–∞–≤–µ—Ä—à—ë–Ω ==="
