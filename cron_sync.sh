#!/bin/bash
# ============================================================================
# АВТОМАТИЧЕСКАЯ СИНХРОНИЗАЦИЯ OZON TRACKER
# ============================================================================
#
# Назначение: Автоматический запуск синхронизации данных каждые 6 часов
#
# Использование: Запускается через cron
#   0 */6 * * * /root/OZON/cron_sync.sh >> /var/log/ozon-tracker/cron.log 2>&1
#
# ============================================================================

set -e

# Логирование с временной меткой
log_info() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ℹ️  $1"
}

log_error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ❌ $1"
}

log_info "Запуск автоматической синхронизации..."

# Вызываем эндпоинт синхронизации
response=$(curl -s -w "\n%{http_code}" http://127.0.0.1:8000/sync 2>&1)

# Разделяем тело ответа и HTTP код
http_code=$(echo "$response" | tail -n1)
body=$(echo "$response" | sed '$d')

if [ "$http_code" = "200" ]; then
    log_info "✅ Синхронизация завершена успешно (HTTP $http_code)"
    echo "$body" | head -20  # Первые 20 строк ответа
else
    log_error "Ошибка синхронизации (HTTP $http_code)"
    echo "$body"
    exit 1
fi

log_info "Готово!"
