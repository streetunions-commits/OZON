#!/bin/bash
# ============================================================================
# –°–ö–†–ò–ü–¢ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ì–û –î–ï–ü–õ–û–Ø OZON TRACKER
# ============================================================================
#
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ VPS
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   ./deploy.sh                  # –ü–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π
#   ./deploy.sh --update         # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ (pull —Å GitHub)
#   ./deploy.sh --restart        # –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
#
# ============================================================================

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –Ω–µ –æ—Ç root
# if [ "$EUID" -eq 0 ]; then
#    log_error "–ù–µ –∑–∞–ø—É—Å–∫–∞–π —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –æ—Ç root! –ò—Å–ø–æ–ª—å–∑—É–π –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
#    exit 1
# fi

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–∏–∑–º–µ–Ω–∏ –ø–æ–¥ —Å–µ–±—è)
APP_DIR="$HOME/OZON"
VENV_DIR="$APP_DIR/venv"
SERVICE_NAME="ozon-tracker"

log_info "üöÄ –ù–∞—á–∏–Ω–∞—é –¥–µ–ø–ª–æ–π Ozon Tracker..."

# ============================================================================
# –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô
# ============================================================================

install_dependencies() {
    log_info "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."

    sudo apt-get update
    sudo apt-get install -y python3 python3-pip python3-venv nginx git

    log_info "‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
}

# ============================================================================
# –°–û–ó–î–ê–ù–ò–ï –í–ò–†–¢–£–ê–õ–¨–ù–û–ì–û –û–ö–†–£–ñ–ï–ù–ò–Ø
# ============================================================================

setup_venv() {
    log_info "üêç –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è Python..."

    if [ ! -d "$VENV_DIR" ]; then
        python3 -m venv "$VENV_DIR"
        log_info "‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ"
    else
        log_warn "–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    fi

    source "$VENV_DIR/bin/activate"
    pip install --upgrade pip
    pip install -r "$APP_DIR/requirements.txt"

    log_info "‚úÖ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
}

# ============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–û–í
# ============================================================================

setup_logs() {
    log_info "üìù –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è –ª–æ–≥–æ–≤..."

    sudo mkdir -p /var/log/ozon-tracker
    sudo chown -R $USER:$USER /var/log/ozon-tracker

    log_info "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ª–æ–≥–æ–≤ —Å–æ–∑–¥–∞–Ω—ã"
}

# ============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ê SYSTEMD –°–ï–†–í–ò–°–ê
# ============================================================================

setup_service() {
    log_info "‚öôÔ∏è  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ systemd —Å–µ—Ä–≤–∏—Å–∞..."

    # –ó–∞–º–µ–Ω–∞ YOUR_USERNAME –Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ OZON_APP_DIR –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –ø—É—Ç—å
    sed -e "s/YOUR_USERNAME/$USER/g" \
        -e "s|OZON_APP_DIR|$APP_DIR|g" \
        "$APP_DIR/ozon-tracker.service" | sudo tee /etc/systemd/system/$SERVICE_NAME.service > /dev/null

    sudo systemctl daemon-reload
    sudo systemctl enable $SERVICE_NAME
    sudo systemctl restart $SERVICE_NAME

    log_info "‚úÖ Systemd —Å–µ—Ä–≤–∏—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω"
}

# ============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ê NGINX
# ============================================================================

setup_nginx() {
    log_info "üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx..."

    log_warn "‚ö†Ô∏è  –ù–µ –∑–∞–±—É–¥—å –∑–∞–º–µ–Ω–∏—Ç—å YOUR_DOMAIN.com –Ω–∞ —Å–≤–æ–π –¥–æ–º–µ–Ω –≤ nginx.conf!"
    log_warn "‚ö†Ô∏è  –ò –∑–∞–º–µ–Ω–∏—Ç—å YOUR_USERNAME –Ω–∞ $USER"

    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É Nginx? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        sudo cp "$APP_DIR/nginx.conf" /etc/nginx/sites-available/$SERVICE_NAME
        sudo ln -sf /etc/nginx/sites-available/$SERVICE_NAME /etc/nginx/sites-enabled/

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        if sudo nginx -t; then
            sudo systemctl restart nginx
            log_info "‚úÖ Nginx –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
        else
            log_error "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx! –ò—Å–ø—Ä–∞–≤—å nginx.conf"
            return 1
        fi
    else
        log_warn "Nginx –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ù–∞—Å—Ç—Ä–æ–π –≤—Ä—É—á–Ω—É—é –ø–æ–∑–∂–µ."
    fi
}

# ============================================================================
# –£–°–¢–ê–ù–û–í–ö–ê SSL (LET'S ENCRYPT)
# ============================================================================

setup_ssl() {
    log_info "üîí –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (Let's Encrypt)..."

    read -p "–í–≤–µ–¥–∏ —Å–≤–æ–π –¥–æ–º–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, example.com): " DOMAIN

    if [ -z "$DOMAIN" ]; then
        log_warn "–î–æ–º–µ–Ω –Ω–µ –≤–≤–µ–¥–µ–Ω. SSL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
        return 0
    fi

    sudo apt-get install -y certbot python3-certbot-nginx
    sudo certbot --nginx -d $DOMAIN -d www.$DOMAIN

    log_info "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
}

# ============================================================================
# –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
# ============================================================================

update_app() {
    log_info "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å GitHub..."

    cd "$APP_DIR"
    git pull origin main

    source "$VENV_DIR/bin/activate"
    pip install -r requirements.txt

    sudo systemctl restart $SERVICE_NAME

    log_info "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ"
}

# ============================================================================
# –ü–û–ö–ê–ó–ê–¢–¨ –°–¢–ê–¢–£–°
# ============================================================================

show_status() {
    log_info "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞:"
    sudo systemctl status $SERVICE_NAME --no-pager

    log_info "\nüìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
    sudo journalctl -u $SERVICE_NAME -n 20 --no-pager
}

# ============================================================================
# –ì–õ–ê–í–ù–ê–Ø –õ–û–ì–ò–ö–ê
# ============================================================================

case "${1:-}" in
    --update)
        update_app
        show_status
        ;;
    --restart)
        log_info "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞..."
        sudo systemctl restart $SERVICE_NAME
        show_status
        ;;
    --status)
        show_status
        ;;
    --logs)
        log_info "üìù –õ–æ–≥–∏ (Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞):"
        sudo journalctl -u $SERVICE_NAME -f
        ;;
    *)
        # –ü–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π
        log_info "üéØ –ü–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π"

        install_dependencies
        setup_venv
        setup_logs
        setup_service
        setup_nginx
        setup_ssl

        log_info "\n\n"
        log_info "=========================================="
        log_info "‚úÖ –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–ï–ù!"
        log_info "=========================================="
        log_info ""
        log_info "üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É:"
        log_info "   http://–í–ê–®-IP –∏–ª–∏ http://–í–ê–®-–î–û–ú–ï–ù"
        log_info ""
        log_info "üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
        log_info "   ./deploy.sh --update    # –û–±–Ω–æ–≤–∏—Ç—å —Å GitHub"
        log_info "   ./deploy.sh --restart   # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å"
        log_info "   ./deploy.sh --status    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å"
        log_info "   ./deploy.sh --logs      # –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏"
        log_info ""
        ;;
esac
